<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  
  <title>ã€notesã€‘æ”»å‡»Java JMX-RMI | 0kami&#39;s Blog</title>
  <meta name="description" content="A Web ğŸ¶ &amp;&amp; Code Reviewer">
  <meta name="keywords" content>
  <meta name="HandheldFriendly" content="True">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="shortcut icon" href="/images/avatar.jpg">
  <link rel="alternate" href="/atom.xml" title="0kami's Blog">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="0x00 å‰è¨€RMIçš„ä¸€ä¸ªé‡è¦åº”ç”¨æ˜¯JMX(Java Management Extentions)ï¼Œæœ¬æ–‡ä»‹ç»JMXçš„ä¸¤ä¸ªæ”»å‡»é¢ï¼šï¼‰">
<meta name="keywords" content="vul">
<meta property="og:type" content="article">
<meta property="og:title" content="ã€notesã€‘æ”»å‡»Java JMX-RMI">
<meta property="og:url" content="http://blog.0kami.cn/2020/03/10/java/java-jmx-rmi/index.html">
<meta property="og:site_name" content="0kami&#39;s Blog">
<meta property="og:description" content="0x00 å‰è¨€RMIçš„ä¸€ä¸ªé‡è¦åº”ç”¨æ˜¯JMX(Java Management Extentions)ï¼Œæœ¬æ–‡ä»‹ç»JMXçš„ä¸¤ä¸ªæ”»å‡»é¢ï¼šï¼‰">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://blog.0kami.cn/assets/java-jmx-rmi-20200310/image-20200306152727840-4519092.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/java-jmx-rmi-20200310/image-20200306155425100-4519092.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/java-jmx-rmi-20200310/image-20200306170312638-4519092.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/java-jmx-rmi-20200310/image-20200306212145063-4519092.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/java-jmx-rmi-20200310/image-20200306212242480-4519092.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/java-jmx-rmi-20200310/image-20200306212452672-4519092.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/java-jmx-rmi-20200310/image-20200318153641087.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/java-jmx-rmi-20200310/image-20200318155835634.png">
<meta property="og:updated_time" content="2020-04-17T02:49:41.350Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ã€notesã€‘æ”»å‡»Java JMX-RMI">
<meta name="twitter:description" content="0x00 å‰è¨€RMIçš„ä¸€ä¸ªé‡è¦åº”ç”¨æ˜¯JMX(Java Management Extentions)ï¼Œæœ¬æ–‡ä»‹ç»JMXçš„ä¸¤ä¸ªæ”»å‡»é¢ï¼šï¼‰">
<meta name="twitter:image" content="http://blog.0kami.cn/assets/java-jmx-rmi-20200310/image-20200306152727840-4519092.png">

  <link href="https://fonts.googleapis.com/css?family=Inconsolata|Titillium+Web" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">
  <link href="//cdn.bootcss.com/node-waves/0.7.5/waves.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>
</head>
</html>
<body>
  <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>


  <script>setLoadingBarProgress(20)</script> 
  <header class="l_header">
	<div class='wrapper'>
		<div class="nav-main container container--flex">
			<a class="logo flat-box" href='/' >
				0kami's Blog
			</a>
			<div class='menu'>
				<ul class='h-list'>
					
						<li>
							<a class='flat-box nav-home' href='/'>
								Home
							</a>
						</li>
					
						<li>
							<a class='flat-box nav-archives' href='/archives'>
								Archives
							</a>
						</li>
					
						<li>
							<a class='flat-box nav-about' href='/about'>
								About
							</a>
						</li>
					
				</ul>
				<div class='underline'></div>
			</div>
			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="Search" />
						<span class="icon icon-search"></span>
					</form>
				</div>
			
			<ul class='switcher h-list'>
				
					<li class='s-search'><a href='javascript:void(0)'><span class="icon icon-search flat-box"></span></a></li>
				
				<li class='s-menu'><a href='javascript:void(0)'><span class="icon icon-menu flat-box"></span></a></li>
			</ul>
		</div>
		
		<div class='nav-sub container container--flex'>
			<a class="logo" class="flat-box" href='javascript:void(0)'>
				Word of Forks
			</a>

			<ul class='switcher h-list'>
				<li class='s-comment'><a href='javascript:void(0)'><span class="icon icon-chat_bubble_outline flat-box"></span></a></li>
				<li class='s-top'><a href='javascript:void(0)'><span class="icon icon-arrow_upward flat-box"></span></a></li>
				<li class='s-toc'><a href='javascript:void(0)'><span class="icon icon-format_list_numbered flat-box"></span></a></li>
			</ul>
		</div>
	</div>
</header>
<aside class="menu-phone">
	<nav>
		
			<a href="/" class="nav-home nav">
				Home
			</a>
		
			<a href="/archives" class="nav-archives nav">
				Archives
			</a>
		
			<a href="/about" class="nav-about nav">
				About
			</a>
		
	</nav>
</aside>

    <script>setLoadingBarProgress(40);</script>
  <div class="l_body">
    <div class='container clearfix'>
      <div class='l_main'>
        <article id="post-java/java-jmx-rmi"
  class="post white-box article-type-post"
  itemscope itemprop="blogPost">
	<section class='meta'>
	<h2 class="title">
  	<a href="/2020/03/10/java/java-jmx-rmi/">
    	ã€notesã€‘æ”»å‡»Java JMX-RMI
    </a>
  </h2>
	<time>
	  Mar 10, 2020
	</time>
	
    
    <div class='cats'>
        <a href="/categories/notes/">notes</a>
    </div>

	</section>
	
		<section class="toc-wrapper"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00-å‰è¨€"><span class="toc-number">1.</span> <span class="toc-text">0x00 å‰è¨€</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-åŸºç¡€"><span class="toc-number">2.</span> <span class="toc-text">0x01 åŸºç¡€</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-æ”»å‡»JMX"><span class="toc-number">3.</span> <span class="toc-text">0x02 æ”»å‡»JMX</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-æ”»å‡»JMX-RMI"><span class="toc-number">3.1.</span> <span class="toc-text">1. æ”»å‡»JMX-RMI</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-æ”»å‡»å­˜åœ¨å‡½æ•°å‚æ•°çš„å¯¹è±¡"><span class="toc-number">3.2.</span> <span class="toc-text">2. æ”»å‡»å­˜åœ¨å‡½æ•°å‚æ•°çš„å¯¹è±¡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-åˆ©ç”¨MLETæ–¹å¼åŠ¨æ€åŠ è½½MBean"><span class="toc-number">3.3.</span> <span class="toc-text">3. åˆ©ç”¨MLETæ–¹å¼åŠ¨æ€åŠ è½½MBean</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-æ€»ç»“"><span class="toc-number">4.</span> <span class="toc-text">0x03 æ€»ç»“</span></a></li></ol></section>
	
	<section class="article typo">
  	<div class="article-entry" itemprop="articleBody">
    	<h2 id="0x00-å‰è¨€"><a href="#0x00-å‰è¨€" class="headerlink" title="0x00 å‰è¨€"></a>0x00 å‰è¨€</h2><p>RMIçš„ä¸€ä¸ªé‡è¦åº”ç”¨æ˜¯JMX(Java Management Extentions)ï¼Œæœ¬æ–‡ä»‹ç»JMXçš„ä¸¤ä¸ªæ”»å‡»é¢ï¼šï¼‰<br><a id="more"></a></p>
<h2 id="0x01-åŸºç¡€"><a href="#0x01-åŸºç¡€" class="headerlink" title="0x01 åŸºç¡€"></a>0x01 åŸºç¡€</h2><p>åœ¨å†™ä¸€åŠçš„æ—¶å€™ï¼Œå‘ç°äº†è¿™ç¯‡æ–‡ç« ï¼Œæ„Ÿè§‰å†™çš„å¾ˆå¥½ï¼Œå¯ä»¥çœ‹çœ‹ï¼š<a href="https://mogwailabs.de/blog/2019/04/attacking-rmi-based-jmx-services/" target="_blank" rel="noopener">https://mogwailabs.de/blog/2019/04/attacking-rmi-based-jmx-services/</a></p>
<p>JMX</p>
<blockquote>
<p>Java Management Extensions (JMX) is a Java technology that supplies tools for managing and monitoring applications, system objects, devices (such as printers) and service-oriented networks.</p>
</blockquote>
<p>MBean</p>
<blockquote>
<p>JMX allows you to manage resources as managed beans. A managed bean (MBean) is a Java Bean class that follows certain design rules of the JMX standard. An MBean can represent a device, an application, or any resource that needs to be managed over JMX. You can access these MBeans via JMX, query attributes and invoke Bean methods.</p>
<p>The JMX standard differs between various MBean types however, we will only deal with the standard MBeans here. To be a valid MBean, a Java class must:</p>
<ul>
<li>Implement an interface</li>
<li>Provide a default constructor (without any arguments)</li>
<li>Follow certain naming conventions, for example implement getter/setter methods to read/write attributes</li>
</ul>
</blockquote>
<p>è¿™é‡Œæä¸€ä¸‹ï¼Œå½“MBeançš„åå­—ä¸º<code>Hello</code>æ—¶ï¼Œå…¶ç›¸åº”çš„interfaceåå¿…é¡»ä¸º<code>HelloMBean</code>ï¼Œä¸ç„¶ç®—ä¸åˆæ³•çš„MBean</p>
<p>MBean Server</p>
<blockquote>
<p>A MBean server is a service that manages the MBeans of a system. Developers can register their MBeans in the server following a specific naming pattern. The MBean server will forward incoming messages to the registered MBeans. The service is also responsible to forward messages from MBeans to external components.</p>
</blockquote>
<p>DEMOç”¨å‚è€ƒé‡Œçš„ï¼Œç”¨<code>jconsole</code>çœ‹çœ‹ç»“æœ</p>
<p><img src="/assets/java-jmx-rmi-20200310/image-20200306152727840-4519092.png" alt="image-20200306152727840"></p>
<p>åœ¨JConsoleé‡Œå¯ä»¥å¯¹å½“å‰æ³¨å†Œçš„MBeanè¿›è¡Œæ“ä½œï¼Œå¦‚ä¸Šå›¾è°ƒç”¨<code>sayHello</code>å‡½æ•°</p>
<p>å½“å‰æˆ‘ä»¬è¿çš„æ˜¯æœ¬åœ°çš„MBean Server(æ¯ä¸ªjavaè¿›ç¨‹åœ¨æœ¬åœ°éƒ½ä¼šæœ‰ä¸€ä¸ªMBean Server)ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å°†MBean ServeræŒ‚è½½åˆ°æŸä¸€ç«¯å£ä¸Šï¼Œæä¾›è¿œç¨‹çš„MBeanç®¡ç†ã€‚</p>
<p>è¿è¡Œjaræ—¶å¸¦ä¸Š<code>-Dcom.sun.management.jmxremote.port=2222 -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false</code></p>
<p>ç›´æ¥é€šè¿‡JConsoleæ¥è¿æ¥ï¼Œä¼šæç¤ºä½ æœ‰ä¸¤ç§æ–¹æ³•1:<code>host:port</code>;2:<code>service:jmx:&lt;protocol&gt;:&lt;sap&gt;</code></p>
<p>è¿™é‡Œæˆ‘ä»¬é‡ç‚¹è¦è®²çš„å°±æ˜¯ç¬¬äºŒç§æ–¹æ³•ï¼Œé¦–å…ˆæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹jmxå»ºç«‹èµ·2222ç«¯å£åï¼Œç”¨nmapæ¥è·å–å…¶å†…å®¹æ˜¯æ€ä¹ˆæ ·çš„</p>
<p><img src="/assets/java-jmx-rmi-20200310/image-20200306155425100-4519092.png" alt="image-20200306155425100"></p>
<p>ä»ç»“æœæ¥çœ‹ï¼ŒJMXçš„MBean Serveræ˜¯å»ºç«‹åœ¨RMIçš„åŸºç¡€ä¸Šçš„ï¼Œå¹¶ä¸”å…¶RMI Registyæ³¨å†Œçš„åå­—å«<code>jmxrmi</code>ã€‚</p>
<p>ç¬¬äºŒç§æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æŒ‡å®šå…·ä½“çš„åè®®æ¥è·ŸServerç«¯è¿›è¡Œè¿æ¥ï¼Œå‚è€ƒ<a href="https://docs.oracle.com/javase/8/docs/api/index.html?javax/management/remote/rmi/package-summary.html" target="_blank" rel="noopener">JMX RMI connector API</a></p>
<blockquote>
<p>There are two forms for RMI connector addresses:</p>
<ul>
<li>In the <em>JNDI form</em>, the URL indicates <em>where to find an RMI stub for the connector</em>. This RMI stub is a Java object of type <a href="https://docs.oracle.com/javase/8/docs/api/javax/management/remote/rmi/RMIServer.html" target="_blank" rel="noopener"><code>RMIServer</code></a> that gives remote access to the connector server. With this address form, the RMI stub is obtained from an external directory entry included in the URL. An external directory is any directory recognized by <a href="https://docs.oracle.com/javase/8/docs/api/javax/naming/package-summary.html" target="_blank" rel="noopener"><code>JNDI</code></a>, typically the RMI registry, LDAP, or COS Naming.</li>
<li>In the <em>encoded form</em>, the URL directly includes the information needed to connect to the connector server. When using RMI/JRMP, the encoded form is the serialized RMI stub for the server object, encoded using BASE64 without embedded newlines. When using RMI/IIOP, the encoded form is the CORBA IOR for the server object.</li>
</ul>
</blockquote>
<p>è¿™é‡Œçš„encoded formçš„ååºåˆ—åŒ–è¿‡ç¨‹å®åœ¨å‘èµ·ç«¯è¿›è¡Œçš„ï¼Œæ‰€ä»¥è¿™é‡Œä¸è€ƒè™‘ç¬¬äºŒç§å½¢å¼ã€‚</p>
<p>å¯¹äºJNDIçš„å½¢å¼ï¼Œæœ‰ä»¥ä¸‹å‡ ç§æ–¹æ³•è·ŸJMX Serverå»è¿æ¥ï¼š</p>
<p>Connectoræ”¯æŒJRMPå’Œiiopä½œä¸ºè¿æ¥å±‚çš„åè®®ï¼Œæ‰€ä»¥å¯¹åº”çš„æœ‰ä¸¤ç§æ–¹å¼</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. service:jmx:rmi://host:port/</span><br><span class="line">2. service:jmx:iiop://host:port/</span><br></pre></td></tr></table></figure>
<p>æ­¤å¤–ï¼Œè¿˜æœ‰åŸºäºç›®å½•æ¡ç›®çš„connectors</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. service:jmx:rmi://host:port/jndi/jndi-name</span><br><span class="line">2. service:jmx:iiop://host:port/jndi/jndi-name</span><br><span class="line">æ¯”å¦‚</span><br><span class="line">serivce:jmx:rmi://&lt;å¯å¿½ç•¥çš„host&gt;/jndi/rmi://host:port/jmxrmi</span><br></pre></td></tr></table></figure>
<p>è¿™ç§æ–¹å¼å°±å¯ä»¥ä½¿ç”¨jndiä¸‹çš„æ‰€æœ‰spiæ¥è¿›è¡Œè¿æ¥</p>
<h2 id="0x02-æ”»å‡»JMX"><a href="#0x02-æ”»å‡»JMX" class="headerlink" title="0x02 æ”»å‡»JMX"></a>0x02 æ”»å‡»JMX</h2><h3 id="1-æ”»å‡»JMX-RMI"><a href="#1-æ”»å‡»JMX-RMI" class="headerlink" title="1. æ”»å‡»JMX-RMI"></a>1. æ”»å‡»JMX-RMI</h3><p><strong>CVE-2016-3427</strong> ç”±äºJMXè®¤è¯æ—¶ä¼ é€’çš„æ˜¯HashMapæ•°æ®ç»“æ„ï¼Œè€Œä»¥HashMapå¯ä»¥ç›´æ¥æ„é€ ä¸€ä¸ªååºåˆ—åŒ–åˆ©ç”¨é“¾æ¥æ”»å‡»æœ¬åœ°ClassPathï¼Œè¿™é‡Œå·²ç»ä¿®å¤äº†ä¸ç»†è®²äº†XD</p>
<p><strong>ä¸»åŠ¨æ”»å‡»1</strong>ï¼šåˆ©ç”¨RMI Registyæ”¶åˆ°è¿œç¨‹bindæ—¶äº§ç”Ÿçš„ååºåˆ—åŒ–æ¼æ´ jdk&lt;8u141_b10(å¹¶ä¸”check hostçš„é¡ºåºå˜äº†ï¼Œè¯¦ç»†å¯ä»¥çœ‹<a href="http://blog.0kami.cn/2020/02/06/rmi-registry-security-problem/">è¿™é‡Œ</a>)ï¼Œ<a href="http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/rev/c92d704420d7#l2.32" target="_blank" rel="noopener">8u141_b10ä¿®æ”¹å</a>SingleEntryRegistryå¢åŠ äº†filter</p>
<p><img src="/assets/java-jmx-rmi-20200310/image-20200306170312638-4519092.png" alt="image-20200306170312638"></p>
<p>é™åˆ¶äº†æ¥å—åˆ°çš„ä¸èƒ½æ˜¯åºåˆ—åŒ–åçš„å¯¹è±¡ï¼Œä¹Ÿå°±æ„å‘³ç€ä¸èƒ½åˆ©ç”¨registryè¿™ç§æ–¹å¼æ¥è¾¾æˆåˆ©ç”¨äº†ã€‚</p>
<p><strong>ä¸»åŠ¨æ”»å‡»2</strong>:åˆ©ç”¨RMI DGCå®ç°å­˜åœ¨ååºåˆ—åŒ–æ¼æ´ï¼Œå¯åœ¨JEP 290ä¹‹å‰çš„ç‰ˆæœ¬æ”»å‡»æˆåŠŸ(ä½¿ç”¨ysoserialçš„JRMPClientï¼Œåˆ†æä¹Ÿè§<a href="http://blog.0kami.cn/2020/02/06/rmi-registry-security-problem/">è¿™é‡Œ</a>0x08éƒ¨åˆ†)</p>
<p>å‰é¢ä¸¤ç§æ–¹å¼ï¼Œåœ¨æœ€æ–°ç‰ˆçš„JDK8ä¸­å‡æ—©å·²å¤±æ•ˆã€‚é™¤äº†ç›´æ¥æ”»å‡»RMIå±‚ï¼Œæˆ‘ä»¬ä¹Ÿè¿˜å¯ä»¥åˆ©ç”¨MBean ServeræŒ‚è½½çš„å¯¹è±¡å‡½æ•°ï¼Œæ¥ä¼ é€’æ„é€ å¥½çš„åºåˆ—åŒ–æ•°æ®ã€‚è¿™é‡Œæœ‰ç‚¹åƒRMIä¸­åˆ©ç”¨RMI ServeræŒ‚è½½çš„å¯¹è±¡å‡½æ•°å‚æ•°ä¸­å­˜åœ¨ç›¸å…³å¯åˆ©ç”¨çš„å¯¹è±¡ï¼Œå¦‚Objectç±»å‹å°±å¯ä»¥è£…è½½æ‰€æœ‰çš„åºåˆ—åŒ–æ•°æ®ã€‚</p>
<h3 id="2-æ”»å‡»å­˜åœ¨å‡½æ•°å‚æ•°çš„å¯¹è±¡"><a href="#2-æ”»å‡»å­˜åœ¨å‡½æ•°å‚æ•°çš„å¯¹è±¡" class="headerlink" title="2. æ”»å‡»å­˜åœ¨å‡½æ•°å‚æ•°çš„å¯¹è±¡"></a>2. æ”»å‡»å­˜åœ¨å‡½æ•°å‚æ•°çš„å¯¹è±¡</h3><p>åˆ©ç”¨MBean ServeræŒ‚è½½çš„å¯¹è±¡å‡½æ•°å‚æ•°ï¼Œæ¥ä¼ é€’æ„é€ å¥½çš„åºåˆ—åŒ–æ•°æ®ã€‚MBean Serveræ¥æ”¶åˆ°æ•°æ®åï¼Œä¼šå¯¹è·å–åˆ°çš„å‚æ•°æ•°æ®è¿›è¡Œ<code>object[]</code>è½¬æ¢ï¼Œåœ¨è½¬æ¢å‰ï¼Œéœ€è¦å°†RMIäº¤äº’è¿‡ç¨‹ä¸­çš„åºåˆ—åŒ–æ•°æ®è¿›è¡Œååºåˆ—åŒ–</p>
<p><code>javax/management/remote/rmi/RMIConnectionImpl.java#unwrap</code></p>
<p><img src="/assets/java-jmx-rmi-20200310/image-20200306212145063-4519092.png" alt="image-20200306212145063"></p>
<p>1583è¡Œè¿›è¡Œç±»å‹è½¬åŒ–ï¼Œä½†é¦–å…ˆéœ€è¦å…ˆè¿›è¡Œååºåˆ—åŒ–<code>mo.get()</code></p>
<p><code>java/rmi/MarshalledObject.java#get</code></p>
<p><img src="/assets/java-jmx-rmi-20200310/image-20200306212242480-4519092.png" alt="image-20200306212242480"></p>
<p>è¿™é‡Œå°±åˆ°äº†å¸¸è§„çš„ååºåˆ—åŒ–æ“ä½œ</p>
<p>æ‰€ä»¥åªè¦MBean Serveré‡Œå­˜åœ¨MBeançš„å‡½æ•°å­˜åœ¨å‚æ•°ï¼Œæˆ‘ä»¬é€šè¿‡æ„é€ ç›¸å…³çš„invokeä¼ é€’è¿‡å»å°±å¯ä»¥è§¦å‘ååºåˆ—åŒ–</p>
<p><img src="/assets/java-jmx-rmi-20200310/image-20200306212452672-4519092.png" alt="image-20200306212452672"></p>
<p>å¦‚<code>java.util.logging.Logging#getLoggerLevel(String)</code>æœ‰ä¸€ä¸ªStringç±»å‹çš„å‡½æ•°å‚æ•°ï¼Œè¿™é‡Œæˆ‘ä»¬ç›´æ¥å°†payloadå¡è¿›invokeçš„ç¬¬äºŒä¸ªå‚æ•°å³å¯ã€‚</p>
<p>å…¶ä»–çš„MBeanä¹ŸåŒæ ·å¯ä»¥è¿™æ ·æ“ä½œï¼Œè¿™é‡Œå¦‚æœéœ€è¦è®¤è¯çš„è¯ï¼Œå°±éœ€è¦åœ¨è¿æ¥æ—¶å°†è®¤è¯ä¿¡æ¯å¸¦ä¸Šï¼Œåç»­çš„è¿˜æ˜¯å¯ä»¥åˆ©ç”¨æˆåŠŸçš„ã€‚</p>
<h3 id="3-åˆ©ç”¨MLETæ–¹å¼åŠ¨æ€åŠ è½½MBean"><a href="#3-åˆ©ç”¨MLETæ–¹å¼åŠ¨æ€åŠ è½½MBean" class="headerlink" title="3. åˆ©ç”¨MLETæ–¹å¼åŠ¨æ€åŠ è½½MBean"></a>3. åˆ©ç”¨MLETæ–¹å¼åŠ¨æ€åŠ è½½MBean</h3><p>è¿™é‡Œå…ˆè¯´åˆ©ç”¨æ–¹å¼ï¼š</p>
<p><strong>åˆ©ç”¨æ¡ä»¶</strong>ï¼š</p>
<ol>
<li>æ— security manager</li>
<li>æ— è®¤è¯</li>
</ol>
<p><strong>åˆ©ç”¨åŸç†</strong>ï¼š</p>
<ol>
<li>åœ¨ä¸€HTTP ServeræŒ‚è½½mletæ–‡ä»¶å’ŒåŒ…å«MBeançš„jaræ–‡ä»¶</li>
<li>ç”¨<code>createMBean(&quot;javax.management.loading.MLet&quot;, null);</code>çš„æ–¹å¼åœ¨è¿œç¨‹JMXåˆ›å»ºMLetå¯¹è±¡</li>
<li>ä½¿ç”¨<code>getMBeansFromURL</code>ä»è¿œç¨‹HTTP ServeråŠ è½½mletæ–‡ä»¶</li>
<li>è§£æmletæ–‡ä»¶ï¼Œç”±äºå­˜åœ¨codebaseï¼Œä»è¿œç¨‹åŠ è½½jaræ–‡ä»¶ï¼Œå¹¶è½½å…¥è¯¥MBean</li>
<li>è°ƒç”¨è¯¥MBeançš„æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å¯ä»¥æ˜¯è‡ªå®šä¹‰çš„æ‰§è¡Œå‘½ä»¤ç­‰æ“ä½œ</li>
</ol>
<p><strong>ç®€å•åˆ†æ</strong>ï¼š</p>
<p>æ¥ç®€å•è¯´ä¸€ä¸‹MLetçš„åŸç†ï¼ŒJMXé™¤äº†åŠ è½½æœ¬åœ°çš„MBeanï¼Œä¹Ÿå¯ä»¥åŠ è½½è¿œç¨‹çš„MLetæ–‡ä»¶(åŒ…å«äº†MLetæ ‡ç­¾)æ¥åŠ¨æ€åŠ è½½codebaseé‡Œçš„Jaræ–‡ä»¶ã€‚åè€…å°±æ˜¯é€šè¿‡MLetå¯¹è±¡çš„getMBeansFromURLå‡½æ•°æ¥å®Œæˆçš„ã€‚</p>
<p>æœ‰å…´è¶£çš„å¯ä»¥ç¿»ä¸€ç¿»<code>javax/management/loading/MLet.java#getMBeansFromURL</code>ï¼Œè¿™é‡Œç›´æ¥è¯´ä¸€ä¸‹æµç¨‹</p>
<ol>
<li><p>ä»è¿œç¨‹æœåŠ¡å™¨åŠ è½½MLetæ–‡ä»¶å¹¶è§£æè¯¥æ–‡ä»¶</p>
</li>
<li><p>æ ¹æ®MLetæ–‡ä»¶ä¸­æŒ‡å®šçš„codebaseå’Œarchiveå­—æ®µï¼Œæ‹¼æ¥æˆæœ€åè¦è¯·æ±‚çš„jaræ–‡ä»¶URLåœ°å€</p>
</li>
<li>æœ€åç”±URLClassLoaderæ¥å®Œæˆè¯·æ±‚è½½å…¥æ“ä½œ</li>
</ol>
<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç¬¬2æ­¥ä¸­ï¼Œå¦‚æœå½“å‰çš„URLåœ°å€å·²ç»å­˜åœ¨å°†ä¸å†é‡æ–°å‘èµ·è½½å…¥è¯·æ±‚ï¼Œæ„å‘³ç€ä¸€æ¬¡è½½å…¥æˆåŠŸä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥è°ƒç”¨è¯¥MBeanï¼ˆServerä¸é‡å¯çš„çŠ¶æ€ä¸‹ï¼‰ã€‚</p>
<p>è€Œå¯¹äºå‰é¢æåˆ°çš„ä¸¤ä¸ªåˆ©ç”¨æ¡ä»¶ï¼š</p>
<p>åœ¨æ–‡æ¡£é‡Œ<a href="https://docs.oracle.com/javase/7/docs/technotes/guides/management/agent.htmlæåˆ°" target="_blank" rel="noopener">https://docs.oracle.com/javase/7/docs/technotes/guides/management/agent.htmlæåˆ°</a></p>
<blockquote>
<p><strong>Caution -</strong> This configuration is insecure: any remote user who knows (or guesses) your port number and host name will be able to monitor and control your Java applications and platform. Furthermore, possible harm is not limited to the operations you define in your MBeans. A remote client could create a <code>javax.management.loading.MLet</code> MBean and use it to create new MBeans from arbitrary URLs, at least if there is <strong>no security manager</strong>. In other words, a rogue remote client could make your Java application execute arbitrary code.</p>
<p>Consequently, while disabling security might be acceptable for development, it is strongly recommended that you <strong>do not disable security for production systems</strong>.</p>
</blockquote>
<p>é¦–å…ˆå¯¹äºæœ‰è®¤è¯çš„æƒ…å†µä¸‹ï¼Œè°ƒç”¨MLetå°†ä¼šè¿›è¡Œæƒå½“å‰ç”¨æˆ·çš„æƒé™éªŒè¯ï¼Œé»˜è®¤æƒ…å†µä¸‹éƒ½æ˜¯ä¸å…è®¸çš„ã€‚</p>
<p><code>com/sun/jmx/remote/security/MBeanServerFileAccessController.java#checkAccess</code>ä¼šæ£€æŸ¥å½“å‰ç™»é™†çš„ç”¨æˆ·æ˜¯å¦æœ‰Createçš„æƒé™(è¿™é‡Œçš„æƒé™æ˜¯ä¸‹é¢çš„createPatternsï¼Œå®ƒå…è®¸åˆ›å»ºæŒ‡å®šæ­£åˆ™çš„ç±»å‹ï¼Œè€Œæˆ‘ä»¬é»˜è®¤æ˜¯ä¸ºç©ºçš„)ï¼Œè¿™é‡Œé»˜è®¤ä¼šè¿”å›falseï¼Œä¹Ÿå°±æ„å‘³ç€å®ƒä¸å…è®¸ä»¥MLetå¯¹è±¡åˆ›å»ºæ–°çš„MBean</p>
<p><img src="/assets/java-jmx-rmi-20200310/image-20200318153641087.png" alt="image-20200318153641087"></p>
<p>å…¶æ¬¡å¯¹äºsecurity managerçš„é™åˆ¶ï¼Œåœ¨è¿œç¨‹è½½å…¥å‰ä¼šåˆ¤æ–­æ˜¯å¦å­˜åœ¨è½½å…¥çš„æƒé™ï¼ˆè¿™é‡Œæˆ‘æ²¡çœ‹åˆ°å…¶ä»–çš„åœ°æ–¹åšäº†åˆ¤æ–­ï¼Œå¯èƒ½ä¸æ­¢å½“å‰è¿™ä¸ªä½ç½®çš„éªŒè¯ï¼‰</p>
<p><img src="/assets/java-jmx-rmi-20200310/image-20200318155835634.png" alt="image-20200318155835634"></p>
<p>å½“å‰æ–¹æ³•æ¯”è¾ƒæ–¹ä¾¿çš„æ˜¯å¯ä»¥è½½å…¥ä»»æ„çš„ä»£ç æ¥æ‰§è¡Œï¼Œä½†æ˜¯åˆ©ç”¨æ¡ä»¶æ¯”è¾ƒè‹›åˆ»ã€‚</p>
<h2 id="0x03-æ€»ç»“"><a href="#0x03-æ€»ç»“" class="headerlink" title="0x03 æ€»ç»“"></a>0x03 æ€»ç»“</h2><p>å¯¹äºJMXçš„åˆ©ç”¨ä¸»è¦åˆ©ç”¨çš„æ˜¯æœ¬åœ°å­˜åœ¨çš„Gadgetï¼Œå¦‚æœæœ¬åœ°ä¸å­˜åœ¨Gadgetçš„è¯å°±æ— æ³•åˆ©ç”¨æˆåŠŸã€‚é™¤éæ»¡è¶³JMX MLetçš„åˆ©ç”¨æ¡ä»¶ï¼Œé€šè¿‡åŠ è½½codebaseä¸Šçš„Jaræ–‡ä»¶æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚</p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œç”±äºæœ¬èº«JMXç”¨çš„RMIé‚£ä¸€å¥—ä¸œè¥¿ï¼Œæ‰€ä»¥å¦‚æœåœ¨åˆé€‚çš„JDKç‰ˆæœ¬ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æ”»å‡»RMIï¼Œä¸è¿‡å‰æä»ç„¶æ˜¯æœ¬åœ°å­˜åœ¨ç›¸å…³çš„åˆ©ç”¨é“¾ã€‚</p>
<p>æœ€åï¼Œå‰æ–‡æåˆ°çš„æ”»å‡»æ–¹æ³•æˆ‘å·²ç»åŒæ­¥åˆ°<a href="https://github.com/wh1t3p1g/ysomap" target="_blank" rel="noopener">github</a>ä¸Šäº†</p>

  	</div>
	  
	  <div class="article-tags tags">
      
        <a href="/tags/vul/">vul</a>
      
	  </div>
    

	
		<div class="art-item-footer">
				
					<span class="art-item-left"><i class="icon icon-chevron-thin-left"></i>prevï¼š<a href="/2020/04/13/java/talk-about-fastjson-deserialization/" rel="prev"  title="ã€notesã€‘æµ…è°ˆfastjsonååºåˆ—åŒ–æ¼æ´">
						ã€notesã€‘æµ…è°ˆfastjsonååºåˆ—åŒ–æ¼æ´
					</a></span>
				
				
					<span class="art-item-right">nextï¼š<a href="/2020/03/01/java/jndi-with-ldap/" rel="next"  title="ã€notesã€‘JNDI with LDAP">
						ã€notesã€‘JNDI with LDAP
					</a><i class="icon icon-chevron-thin-right"></i></span>
				
		</div>
	
	</section>
	
		<section id="comments">
			<div id="disqus_thread"></div>
		</section>
	
</article>
<script>
	window.subData = {
		title: 'ã€notesã€‘æ”»å‡»Java JMX-RMI',
		tools: true
	}
</script>

      </div>
      <aside class='l_side'>
        
  <section class='m_widget about'>

<div class='header'>wh1t3p1g</div>
<div class='content'>
<div class='desc'>A Web ğŸ¶ &amp;&amp; Code Reviewer</div>
</div>
</section>

  <section class='m_widget links'>
<div class='header'>Links</div>
<div class='content'>
    <ul class="entry">
    
        <li><a class="flat-box" target="_blank" href="http://blog.orleven.com">
            <div class='name'>orleven</div>
        </a></li>
    
        <li><a class="flat-box" target="_blank" href="http://www.warmeng.com">
            <div class='name'>warmeng</div>
        </a></li>
    
    </ul>
</div>
</section>

  <section class='m_widget categories'>
<div class='header'>Categories</div>
<div class='content'>
    
    <ul class="entry">
    
        <li><a class="flat-box" href="/categories/codereview/"><div class='name'>codereview</div><div class='badget'>10</div></a></li>
    
        <li><a class="flat-box" href="/categories/ctf/"><div class='name'>ctf</div><div class='badget'>6</div></a></li>
    
        <li><a class="flat-box" href="/categories/notes/"><div class='name'>notes</div><div class='badget'>23</div></a></li>
    
    </ul>
    
</div>
</section>

  
<div class="m_widget tagcloud">
    <div class="header">Tags</div>
    <div class='content'>
        <a href="/tags/bctf/" style="font-size: 14px; color: #808080">bctf</a> <a href="/tags/cms/" style="font-size: 18px; color: #2b2b2b">cms</a> <a href="/tags/ctf/" style="font-size: 14px; color: #808080">ctf</a> <a href="/tags/cve/" style="font-size: 16px; color: #555">cve</a> <a href="/tags/ddctf/" style="font-size: 14px; color: #808080">ddctf</a> <a href="/tags/hitbxctf/" style="font-size: 14px; color: #808080">hitbxctf</a> <a href="/tags/mobile/" style="font-size: 14px; color: #808080">mobile</a> <a href="/tags/njctf/" style="font-size: 14px; color: #808080">njctf</a> <a href="/tags/others/" style="font-size: 16px; color: #555">others</a> <a href="/tags/suctf/" style="font-size: 14px; color: #808080">suctf</a> <a href="/tags/vul/" style="font-size: 20px; color: #000">vul</a>
    </div>
</div>



      </aside>
      <script>setLoadingBarProgress(60);</script>
    </div>
  </div>
  <footer id="footer" class="clearfix">

	<div class="social-wrapper">
  	
      
        <a href="https://github.com/wh1t3p1g" class="social github"
          target="_blank" rel="external">
          <span class="icon icon-github"></span>
        </a>
      
        <a href="/atom.xml" class="social rss"
          target="_blank" rel="external">
          <span class="icon icon-rss"></span>
        </a>
      
    
  </div>
  
  <div>Theme <a href='https://github.com/stkevintan/hexo-theme-material-flow' class="codename">MaterialFlow</a> designed by <a href="http://keyin.me/" target="_blank">Kevin Tan</a>.</div>
  
</footer>


  <script>setLoadingBarProgress(80);</script>
  
<script>
  var disqus_shortname = '0kami';
  
  var disqus_url = 'http://blog.0kami.cn/2020/03/10/java/java-jmx-rmi/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src='//cdn.bootcss.com/node-waves/0.7.5/waves.min.js'></script>
<script src="//cdn.bootcss.com/scrollReveal.js/3.3.2/scrollreveal.min.js"></script>
<script src="/js/jquery.fitvids.js"></script>
<script>
	var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
	var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
	var ALGOLIA_API_KEY = "";
	var ALGOLIA_APP_ID = "";
	var ALGOLIA_INDEX_NAME = "";
  var AZURE_SERVICE_NAME = "";
  var AZURE_INDEX_NAME = "";
  var AZURE_QUERY_KEY = "";
  var BAIDU_API_ID = "";
  var SEARCH_SERVICE = "hexo";
  var ROOT = "/"||"/";
  if(!ROOT.endsWith('/'))ROOT += '/';
</script>
<script src="/js/search.js"></script>
<script src="/js/app.js"></script>


  <script>setLoadingBarProgress(100);</script>
</body>
</html>
