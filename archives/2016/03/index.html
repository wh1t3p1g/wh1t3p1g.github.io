<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<title>
  
    Archive: 2016/3
  
</title>

<meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="0kami's Blog">
<meta property="og:url" content="http://yoursite.com/archives/2016/03/index.html">
<meta property="og:site_name" content="0kami's Blog">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="0kami's Blog">
<meta name="twitter:description">


  <link rel="alternative" href="/atom.xml" title="0kami&#39;s Blog" type="application/atom+xml">



  <link rel="icon" href="/favicon.png">


<link rel="stylesheet" href="/styles/main.css">




  <script>
  var _hmt = _hmt || [];
  (function() {
    var hm = document.createElement("script");
    hm.src = "//hm.baidu.com/hm.js?76bc831ee102b44bd4b6c44ff85fc28c";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
  </script>



</head>
<body
  
    class="monochrome"
  
  >
  <div class="mobile-header">
  <button class="sidebar-toggle" type="button">
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
  </button>
  <a class="title" href="/">0kami&#39;s Blog</a>
</div>

  <div class="main-container">
    <div class="sidebar">
  <div class="header">
    <h1 class="title"><a href="/">0kami&#39;s Blog</a></h1>
    
    <div class="info">
      <div class="content">
        
        
          <div class="author">0kami-zj9s</div>
        
      </div>
      
        <div class="avatar">
          
            <a href="/about"><img src="https://avatars0.githubusercontent.com/u/16203770?v=3&amp;s=460"></a>
          
        </div>
      
    </div>
  </div>
  <div class="body">
    
      
        <ul class="nav">
          
            
              <li class="category-list-container">
                <a href="javascript:;">Category</a>
                <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Web安全/">Web安全</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/writeup/">writeup</a><span class="category-list-count">1</span></li></ul>
              </li>
            
          
            
              <li class="tag-list-container">
                <a href="javascript:;">Tag</a>
                <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/XSS/">XSS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bctf/">bctf</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flask/">flask</a><span class="tag-list-count">1</span></li></ul>
              </li>
            
          
            
              <li class="archive-list-container">
                <a href="javascript:;">Archive</a>
                <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/">2016</a><span class="archive-list-count">4</span></li></ul>
              </li>
            
          
        </ul>
      
        <ul class="nav">
          
            
              <li>
                <a href="/" title="Homepage">Homepage</a>
              </li>
            
          
            
              <li>
                <a href="/archives" title="By Year">By Year</a>
              </li>
            
          
        </ul>
      
        <ul class="nav">
          
            
              <li>
                <a href="http://weibo.com/u/1015713383" title="Weibo" target="_blank" rel="external">Weibo</a>
              </li>
            
          
            
              <li>
                <a href="https://github.com/0kami" title="Github" target="_blank" rel="external">Github</a>
              </li>
            
          
            
              <li>
                <a href="/atom.xml" title="RSS">RSS</a>
              </li>
            
          
        </ul>
      
    
  </div>
</div>

    <div class="main-content">
      
        <div style="max-width: 1000px">
      
          

  
  
    
      
      
      <section class="archives-wrap">
        <div class="archive-year-wrap">
          <h1><a href="/archives/2016" class="archive-year">2016</a></h1>
        </div>
        <div class="post-list">
    
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2016/03/20/Bctf-Crypto-SpecialRSA-writeup/" >
  Bctf Crypto SpecialRSA writeup
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2016/03/20/Bctf-Crypto-SpecialRSA-writeup/"><span class="article-date">
  2016-03-20
</span>
</a>
        
	<span class="article-category tagcloud">
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/writeup/">writeup</a></li></ul>
	</span>


        
	<span class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/bctf/">bctf</a></li></ul>
	</span>


      </div>
      <div class="article-entry">
        
          <h3 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h3><p><img src="http://blog.0kami.cn/images/bctf/specialRSA.jpg" alt="题目描述"><br>　　将附带的<a href="http://blog.0kami.cn/static/special_rsa.zip" title="zip" target="_blank" rel="external">zip</a>文件下载并解压。可以看到以下几个文件：<br>　　　　　　1. 加密算法<br>　　　　　　2. 示例密文<br>　　　　　　3. 示例明文<br>　　　　　　4. 加密的flag文件<br>　　大致我们可以看出来，题目的意图为通过示例密明文，算出加密秘钥k，然后通过k解密flag文件。阅读加解密算法，我们可以得出以下的数学公式：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gcd(k,N)=1,kd+Ny=1,c=&gt;criphertext,m=&gt;plaintext</span><br><span class="line">   encode c=[(k^r%N)*m]%N</span><br><span class="line">   decode m=[(d^r%N)*c]%N</span><br><span class="line">   已知2组(m,r,c) N 的值</span><br><span class="line">   求解k</span><br></pre></td></tr></table></figure></p>
<p>　　到这里卡了很久，一直没个正确的方式来获取k，不用数学就会忘记啊啊啊啊啊啊啊。后来求组了老师，得到了一个思路。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">下面所有^-1表示对应的乘法逆元</span><br><span class="line">   假设gcd(r1,r2)=1,那么存在a,b使得公式r1*a+r2*b=1</span><br><span class="line">   那么   k^1</span><br><span class="line">         =k^(r1*a+r2*b)</span><br><span class="line">         =k^(r1*a) * k^(r2*b)</span><br><span class="line">         =(k^r1)^a * (k^r2)^b</span><br><span class="line">而k^rn 可以通过(m,r,c)对来获得</span><br><span class="line">这里直接使用encode公式c=[(k^r%N)*m]%N</span><br><span class="line">通过推导可以得出k^r=c*(m^-1)</span><br><span class="line">m的逆元可以通过扩展欧几里德算法来求得</span><br></pre></td></tr></table></figure></p>
<p>　　有了上面的思路，就可以写程序来加解密了，这里我用了python来写，其中(m,r,c)对我事先拿出来了，清楚一点,下面的程序是来算k的<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">import msgpack</span><br><span class="line">from Crypto.PublicKey import RSA</span><br><span class="line">N = 23927411014020695772934916764953661641310148480977056645255098192491740356525240675906285700516357578929940114553700976167969964364149615226568689224228028461686617293534115788779955597877965044570493457567420874741357186596425753667455266870402154552439899664446413632716747644854897551940777512522044907132864905644212655387223302410896871080751768224091760934209917984213585513510597619708797688705876805464880105797829380326559399723048092175492203894468752718008631464599810632513162129223356467602508095356584405555329096159917957389834381018137378015593755767450675441331998683799788355179363368220408879117131L</span><br><span class="line"></span><br><span class="line">def Ext_Euclid (a , b ):</span><br><span class="line">        <span class="string">''</span><span class="string">'</span><br><span class="line">        扩展欧几里得算法  a*x + b*y = gcd(a,b)  返回 x,y以及a，b的最大公约数gcd</span><br><span class="line">        :param a:</span><br><span class="line">        :param b:</span><br><span class="line">        :return:x,y以及a，b的最大公约数gcd</span><br><span class="line"></span><br><span class="line">        '</span><span class="string">''</span></span><br><span class="line">        <span class="keyword">if</span> (b == 0):</span><br><span class="line">            <span class="built_in">return</span> 1 , 0 , a</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            x , y , q=Ext_Euclid( b , a % b )</span><br><span class="line">            x , y = y,( x - (a // b) * y )</span><br><span class="line">            <span class="built_in">return</span> x , y , q</span><br><span class="line">m1=8246074182642091125578311828374843698994233243811347691229334829218700728624047916518503687366611595562099039411430662968666847086659721231623198995017758424796091810259884653332576136128144958751327844746991264667007359518181363522934430676655236880489550093852524801304612322373542296281962196795304499711006801211783005857297362930338978872451934860435597545642219213551685973208209873623909629278321181485010964460652298690058747090298312365230671723790850998541956664376820820570709272500330966205578898690396706695024001970727864091436518202414166919020415892764617055978488996164642229582717493375419993187360L</span><br><span class="line"></span><br><span class="line">c1=14548997380897265239778884825381301109965518989661808090688952232381091726761464959572943383024428028270717629953894592890859128818839328499002950828491521254480795364789013196240119403187073307558598496713832435709741997056117831860370227155633169019665564392649528306986826960829410120348913586592199732730933259880469229724149887380005627321752843489564984358708013300524640545437703771424168108213045567568595093421366224818609501318783680497763353618110184078118456368631056649526433730408976988014678391205055298782061128568056163894010397245301425676232126267874656710256838457728944370612289985071385621160886L</span><br><span class="line"></span><br><span class="line">m11=RSA.inverse(m1,N)<span class="comment"># 求逆元</span></span><br><span class="line">kr1=m11*c1</span><br><span class="line"></span><br><span class="line">m2=15575051453858521753108462063723750986386093067763948316612157946190835527332641201837062951012227815568418309166473080588354562426066694924364886916408150576082667797274000661726279871971377438362829402529682825471299861814829463510659258586020732228351258291527965822977048954720558973840956731377322516168809373640494227129998871167089589689796024458501705704779109152762373660542684880052489213039920383757930855300338529058000330103359636123251274293258L</span><br><span class="line"></span><br><span class="line">c2=12793942795110038319724531875568693507469327176085954164034728727511164833335101755153514030256152878364664079056565385331901196541015393609751624971554016671160730478932343949538202167508319292084519621768851878526657022981883304260886841513342396524869530063372782511380879783246034751883691295368172069170967975561364277514063320691930900258017293871754252209727301719207692321798229276732198521711602080244950295889575423383308099786298184477668302842952215665734671829249323604032320696267130330613134368640401070775927197554082071807605399448960911234829590548855031180158567578928333030631307816223152118126597L</span><br><span class="line"></span><br><span class="line">m21=RSA.inverse(m2,N)</span><br><span class="line">kr2=m21*c2</span><br><span class="line"><span class="comment"># print kr2</span></span><br><span class="line"></span><br><span class="line">r1=12900676191620430360427117641859547516838813596331616166760756921115466932766990479475373384324634210232168544745677888398849094363202992662466063289599443L</span><br><span class="line"></span><br><span class="line">r2=7718975159402389617924543100113967512280131630286624078102368166185443466262861344357647019797762407935675150925250503475336639811981984126529557679881059L</span><br><span class="line"></span><br><span class="line">a,b,_=Ext_Euclid(r1,r2)</span><br><span class="line"><span class="built_in">print</span> a</span><br><span class="line"><span class="built_in">print</span> b</span><br><span class="line"><span class="comment"># print a*r1+b*r2</span></span><br><span class="line"></span><br><span class="line">x1=RSA.inverse(kr2,N)</span><br><span class="line">k=(pow(kr1, a,N)*pow(x1,-b,N))%N</span><br><span class="line"><span class="built_in">print</span> k</span><br></pre></td></tr></table></figure></p>
<p>　　通过上面的程序可以算出<code>k=175971776542095822590595405274258668271271366360140578776612582276966567082080372980811310146217399585938214712928761559525614866113821551467842221588432676885027725038849513527080849158072296957428701767142294778752742980766436072183367444762212399986777124093501619273513421803177347181063254421492621011961L</code><br>　　接下来就简单了将k带入官方的算法就可以得到flag.<br>　　 <code>BCTF{q0000000000b3333333333-ju57-w0n-pwn20wn!!!!!!!!!!!!}</code><br>　　上面程序中需要注意的是pow函数不支持指数为负数的情况，所以还要再转一下弯。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a&gt;0,b&lt;0</span><br><span class="line">(k^r)^b</span><br><span class="line">=(k^-r)^-b</span><br><span class="line">所以可以先求出k^r mod N的逆元</span><br></pre></td></tr></table></figure></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>　　数学方面的知识还是短板啊，以后得加强一下:)</p>

        
      </div>
    </div>

  

  
  
    
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2016/03/17/DOM-XSS/" >
  DOM XSS
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2016/03/17/DOM-XSS/"><span class="article-date">
  2016-03-17
</span>
</a>
        
	<span class="article-category tagcloud">
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Web安全/">Web安全</a></li></ul>
	</span>


        
	<span class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/XSS/">XSS</a></li></ul>
	</span>


      </div>
      <div class="article-entry">
        
          <h2 id="0x00-引言"><a href="#0x00-引言" class="headerlink" title="0x00 引言"></a>0x00 引言</h2><p>　　这几天阅读了<em>《Web前端黑客技术揭秘》</em>，对DOM型的XSS进行一个总结，内容主要为书中提到的知识点，整理整理作以后复习所用。<br>　　DOM类型的XSS与反射型、存储型XSS都不同，DOM型XSS不用服务器端解析响应的参与，触发DOM型XSS可以说主要依靠浏览器客户端的解析。常见的输出点见<strong>0x04附录</strong>。</p>
<h2 id="0x01-DOM渲染"><a href="#0x01-DOM渲染" class="headerlink" title="0x01 DOM渲染"></a>0x01 DOM渲染</h2><p>　　首先我们来理解一下HTML与Javascript自解码机制，查看以下三个例子<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">1. &lt;input type=&quot;button&quot; id=exec_btn&quot; value=&quot;exec&quot; onclick=&quot;document.write(&apos;&lt;img src=@ onerror=alert(123) /&gt;&apos;)&quot; /&gt;</span><br><span class="line">2. &lt;input type=&quot;button&quot; id=exec_btn&quot; value=&quot;exec&quot; onclick=&quot;document.write(HtmlEncode(&apos;&lt;img src=@ onerror=alert(123) /&gt;&apos;))&quot; /&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">	function HtmlEncode(str) &#123;</span><br><span class="line">		var s=&quot;&quot;;</span><br><span class="line">		if(str.length==0) return &quot;&quot;;</span><br><span class="line">		s=str.replace(/&amp;/g, &quot;&amp;amp;&quot;);</span><br><span class="line">		s=str.replace(/&lt;/g, &quot;&amp;lt;&quot;);</span><br><span class="line">		s=str.replace(/&gt;/g, &quot;&amp;gt;&quot;);</span><br><span class="line">		s=str.replace(/\&quot;/g, &quot;&amp;quot;&quot;);</span><br><span class="line">		return s;</span><br><span class="line">	&#125;</span><br><span class="line">3. &lt;input type=&quot;button&quot; id=exec_btn&quot; value=&quot;exec&quot; onclick=&quot;document.write(&apos;&amp;lt;img src=@ onerror=alert(123) /&amp;gt;&apos;)&quot; /&gt;</span><br></pre></td></tr></table></figure></p>
<p>　　对于第一种情况，很清楚，点击这个按钮后，会将<code>&lt;img src=@ onerror=alert(123) /&gt;</code>写入DOM中，并触发<code>alert(123)</code>。而第二种与第三种，<code>document.write</code>的内容都变成了<code>&amp;lt;img src=@ onerror=alert(123) /&amp;gt;</code>，区别在于一个是在HTML标签中,一个是通过Javascript处理后才变成这个样子的，那么这2种情况都会触发弹窗吗？答案是第二种不会，而第三种会触发。<br>　　形成这样的原因就是因为HTML与Javascript自解码机制，在HTML标签中的javascript可以进行HTML形式的编码。在HTML标签中的javascript代码会先被HTML形式的编码进行解码，即第三种情况中<code>&amp;lt;img src=@ onerror=alert(123) /&amp;gt;</code>在javascript运行前已经解码为<code>&lt;img src=@ onerror=alert(123) /&gt;</code>，而第二种情况为javascript运行中进行的HTML形式的编码，所以写到DOM中时直接显示在页面上。<br>HTML中的编码：</p>
<ul>
<li>进制编码：&#xH;(十六进制格式)、&#D;(十进制格式),最后的分号可以不要</li>
<li>HTML实体编码：即上面的那个HtmlEncode</li>
</ul>
<p>　　那么同样的，在javascript上下文环境中，将内容改为javascript的编码，同样会自解码，我们来看下一个例子<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;input type=&quot;button&quot; id=&quot;exec_btn&quot; value=&quot;exec&quot; /&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">	function $(id)&#123;return document.getElementById(id);&#125;;</span><br><span class="line">	$(&apos;exec_btn&apos;).onclick=function()&#123;</span><br><span class="line">		document.write(&apos;&lt;img src=@ onerror=alert(123) /&gt;&apos;);</span><br><span class="line">		document.write(&apos;\u003c\u0069\u006d\u0067\u0020\u0073\u0072\u0063\u003d\u0040\u0020\u006f\u006e\u0065\u0072\u0072\u006f\u0072\u003d\u0061\u006c\u0065\u0072\u0074\u0028\u0031\u0032\u0033\u0029\u0020\u002f\u003e&apos;);</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>　　上面2中write出现的结果是相同的，同样的道理，由于上述编码为javascript的编码形式，并且在javascript的上下文环境中，会先进行解码，再运行javascript。<br>JavaScript中的编码：</p>
<ul>
<li>Unicode形式：\uH</li>
<li>普通十六进制：\xH</li>
<li>纯转义：\’、\”、\&lt;、>这样在特殊字符前加\进行转义</li>
</ul>
<p>　　通过上面几个例子，我们可以知道在HTML中与在Javascript中自动解码的差异，如果防御没有区分这样的场景，就会出现问题。<br>　　理解了上述的自解码机制，在不同的标签下会有不同的结果，比如一下几个标签会自带HtmlEncode功能<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;title&gt;&lt;/title&gt;</span><br><span class="line">&lt;iframe&gt;&lt;/iframe&gt;</span><br><span class="line">&lt;noscript&gt;&lt;/noscript&gt;</span><br><span class="line">&lt;noframes&gt;&lt;/noframes&gt;</span><br><span class="line">&lt;textarea&gt;&lt;/textarea&gt;</span><br><span class="line"></span><br><span class="line">&lt;xmp&gt;&lt;/xmp&gt;</span><br><span class="line">&lt;plaintext&gt;&lt;/plaintext&gt;</span><br></pre></td></tr></table></figure></p>
<p>　　<code>&lt;xmp&gt;</code>没有HtmlEncode功能，<code>&lt;plaintext&gt;</code>在Firefox下会进行HtmlEncode编码，在chrome下不会。</p>
<h2 id="0x02-DOM-fuzzing"><a href="#0x02-DOM-fuzzing" class="headerlink" title="0x02 DOM fuzzing"></a>0x02 DOM fuzzing</h2><p>　　直接看代码把  下面的程序用python编写<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">def get_template(template_file):</span><br><span class="line">    &quot;&quot;&quot;获取fuzzing的模板文件内容&quot;&quot;&quot;</span><br><span class="line">    content=&apos;&apos;</span><br><span class="line">    with open(template_file) as f:</span><br><span class="line">        content=f.read()</span><br><span class="line">    return content</span><br><span class="line"></span><br><span class="line">def set_result(result_file,result):</span><br><span class="line">    &quot;&quot;&quot;生成fuzzing结果文件&quot;&quot;&quot;</span><br><span class="line">    with open(result_file,&apos;w&apos;) as f:</span><br><span class="line">        f.write(result)</span><br><span class="line">def fuzzing(fuzz_file,result_file):</span><br><span class="line">    template=get_template(fuzz_file)</span><br><span class="line">    fuzz_area_0=template.find(&apos;&lt;fuzz&gt;&apos;)</span><br><span class="line">    fuzz_area_1=template.find(&apos;&lt;/fuzz&gt;&apos;)</span><br><span class="line">    fuzz_area=template[fuzz_area_0+6:fuzz_area_1].strip()</span><br><span class="line">    # chars=[]</span><br><span class="line">    chars=[]</span><br><span class="line">    for i in xrange(255): # ASCII玛转换为字符</span><br><span class="line">        if i!=62:</span><br><span class="line">            chars.append(chr(i))</span><br><span class="line"></span><br><span class="line">    fuzz_area_result=&apos;&apos;</span><br><span class="line">    for c in chars: #遍历这些字符 逐一生成fuzzing内容</span><br><span class="line">        fuzz_area_r=fuzz_area.replace(&apos;&#123;&#123;char&#125;&#125;&apos;,c)</span><br><span class="line">        fuzz_area_r=fuzz_area_r.replace(&apos;&#123;&#123;id&#125;&#125;&apos;,str(ord(c)))</span><br><span class="line">        fuzz_area_result+=fuzz_area_r+&apos;\n&apos;</span><br><span class="line">        print fuzz_area_r</span><br><span class="line">    result=template.replace(fuzz_area,fuzz_area_result)</span><br><span class="line">    set_result(result_file,result)</span><br><span class="line"></span><br><span class="line">if __name__==&apos;__main__&apos;:</span><br><span class="line">    fuzzing(&quot;fuzz_xss_0.html&quot;,&quot;res.html&quot;)</span><br></pre></td></tr></table></figure></p>
<p>　　下面为fuzz_xss_0.html的内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;Fuzz xss 0&lt;/title&gt;</span><br><span class="line">    &lt;script&gt;</span><br><span class="line">        function $(x)&#123;return document.getElementById(x);&#125;</span><br><span class="line">        function f(id)&#123;</span><br><span class="line">            $(&apos;result&apos;).innerHTML+=id+&apos;&lt;br/&gt;&apos;;</span><br><span class="line">        &#125;</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h3&gt;Fuzzing Result:&lt;/h3&gt;</span><br><span class="line">&lt;code&gt;</span><br><span class="line">    &#123;&#123;id&#125;&#125;: &lt;&#123;&#123;char&#125;&#125;script&gt;f(&quot;&#123;&#123;id&#125;&#125;&quot;)&lt;/script&gt;</span><br><span class="line">&lt;/code&gt;</span><br><span class="line">&lt;div id=&quot;result&quot;&gt;&lt;/div&gt;</span><br><span class="line">&lt;br/&gt;</span><br><span class="line">&lt;h3&gt;Fuzzing...&lt;/h3&gt;</span><br><span class="line">&lt;fuzz&gt;</span><br><span class="line">    &#123;&#123;id&#125;&#125;: &lt;&#123;&#123;char&#125;&#125;script&gt;f(&quot;&#123;&#123;id&#125;&#125;&quot;)&lt;/script&gt;&lt;br/&gt;</span><br><span class="line">&lt;/fuzz&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<p>　　通过上面的fuzzing技巧，可以自行扩展</p>
<h2 id="0x03-DOM-XSS-挖掘"><a href="#0x03-DOM-XSS-挖掘" class="headerlink" title="0x03 DOM XSS 挖掘"></a>0x03 DOM XSS 挖掘</h2><ol>
<li>静态方法<br>　　静态方法查找危险关键字，可以使用下列正则表达式来匹配。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Finding Sources</span><br><span class="line"></span><br><span class="line">The following regular expression attempts to match most common DOMXSS sources (BETA):</span><br><span class="line"></span><br><span class="line">/(location\s*[\[.])|([.\[]\s*[&quot;&apos;]?\s*(arguments|dialogArguments|innerHTML|write(ln)?|open(Dialog)?|showModalDialog|cookie|URL|documentURI|baseURI|referrer|name|opener|parent|top|content|self|frames)\W)|(localStorage|sessionStorage|Database)/</span><br><span class="line"></span><br><span class="line">Finding Sinks</span><br><span class="line"></span><br><span class="line">The following regular expression attempts to match most common DOMXSS sinks (BETA):</span><br><span class="line"></span><br><span class="line">/((src|href|data|location|code|value|action)\s*[&quot;&apos;\]]*\s*\+?\s*=)|((replace|assign|navigate|getResponseHeader|open(Dialog)?|showModalDialog|eval|evaluate|execCommand|execScript|setTimeout|setInterval)\s*[&quot;&apos;\]]*\s*\()/</span><br><span class="line"></span><br><span class="line">This regular expression finds sinks based on jQuery, it also finds the $ function, which is not always insecure:</span><br><span class="line"></span><br><span class="line">/after\(|\.append\(|\.before\(|\.html\(|\.prepend\(|\.replaceWith\(|\.wrap\(|\.wrapAll\(|\$\(|\.globalEval\(|\.add\(|jQUery\(|\$\(|\.parseHTML\(/</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>详情可以看<a href="https://code.google.com/archive/p/domxsswiki/wikis/FindingDOMXSS.wiki" target="_blank" rel="external">https://code.google.com/archive/p/domxsswiki/wikis/FindingDOMXSS.wiki</a><br>一旦发现页面存在可疑特征，就进行人工分析，这是静态方法的代价，对人工参与要求很高</p>
<ol>
<li>动态方法<br>　动态方法相当于一次Javascript源码动态审计的过程。书中提到了两种思路<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">eval(location.hash.substr(1));</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>　就拿上面的例子来说，如何检测上面的DOM XSS<br>　1. 思路一<br>　　借用浏览器自身的动态性，可以写Firefox插件，批量对目标地址发起请求（一个模糊测试的过程），请求的形式为：在目标地址后加上#fuzzing内容，就当前这个例子来说。比如当前fuzzing内容为：<code>var x=&#39;d0mx55&#39;</code><br>　　并且对常见的输出点函数进行劫持，如<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var _eval=eval;</span><br><span class="line">eval=function(x)&#123;</span><br><span class="line">	if(typeof(x)==&apos;undefined&apos;)&#123;return;&#125;</span><br><span class="line">	if(x.indexOf(&apos;d0mx55&apos;)!=-1)&#123;alert(&apos;found dom xss&apos;);</span><br><span class="line">	_eval(x);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>　　在javascript层面劫持innerHTML这样的属性已经没那么容易了，常用的属性劫持可以针对具体的对象设置<code>__defineSetter__</code>，比如下面的代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">window.__defineSetter__(&apos;x&apos;,function()&#123;alert(&apos;hijack x&apos;)&#125;);</span><br><span class="line">window.x=&apos;xxxxxYYYYYYYY&apos;;</span><br></pre></td></tr></table></figure></p>
<p>当x赋值的时候，就会触发事先定义好的Setter方法。innerHTML属性属于那些节点对象，想劫持具体节点对象的innerHTML，需要事先知道这个具体节点的对象，然后设置<code>__defineSetter__</code>,这样如果要检测DOM XSS，就要劫持所有的输出点，比较麻烦，那么思路二可能会比较简单一点<br>　2. 思路二<br>　　仍然借用浏览器动态执行的优势，写一个Firefox插件，我们完全以黑盒的方式进行模糊测试输入点，然后判断渲染后的DOM树中是否有我们期待的值，比如，模糊测试的内容都有如下一段代码<code>document.write(&#39;d0m&#39;+&#39;x55&#39;)</code>如果这段代码顺利执行了就会存在d0mx55文本节点，后续的检测工作只要判断是否存在这个文本节点就可以了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if(document.documentElement.innerHTML.indexOf(&apos;d0mx55&apos;)!=-1)&#123;</span><br><span class="line">	alert(&apos;found dom xss&apos;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个思路以DOM树的改变为判断依据，简单准确，但是同样无法避免那些逻辑判断上导致的漏报。</p>
<h2 id="0x04-附录"><a href="#0x04-附录" class="headerlink" title="0x04 附录"></a>0x04 附录</h2><table>
<thead>
<tr>
<th>输出点</th>
<th>javascript code</th>
</tr>
</thead>
<tbody>
<tr>
<td>直接输出HTML内容</td>
<td>document.write(…)<br>document.writeln(…)<br> document.body.innerHtml=…</td>
</tr>
<tr>
<td>直接修改DOM树（包括DHTML事件）</td>
<td>document.forms[0].action=…<br>document.attachEvent(…)<br>document.create…(…)<br>document.execCommand(…)<br>document.body. …<br>widow.attachEvent(…)</td>
</tr>
<tr>
<td>替换document url</td>
<td>document.location=…(以及直接赋值给location的href,host,hostname属性)<br>document.location.hostname=…<br>document.location.replace(…)<br>document.location.assign(…)<br>documnent.URL=…<br>window.navigate(…)</td>
</tr>
<tr>
<td>打开或修改新窗口</td>
<td>document.open(…)<br>window.open(…)<br>window.location.href=…(以及直接赋值给location的href,host,hostname属性)</td>
</tr>
<tr>
<td>直接执行脚本</td>
<td>eval(…)<br>window.execScript(…)<br>window.setInterval(…)<br>window.setTimeout(…)</td>
</tr>
</tbody>
</table>

        
      </div>
    </div>

  

  
  
    
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2016/03/16/flask-virtualenv/" >
  flask virtualenv环境搭建
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2016/03/16/flask-virtualenv/"><span class="article-date">
  2016-03-16
</span>
</a>
        
	<span class="article-category tagcloud">
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/python/">python</a></li></ul>
	</span>


        
	<span class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/flask/">flask</a></li></ul>
	</span>


      </div>
      <div class="article-entry">
        
          <h2 id="0x00-引言"><a href="#0x00-引言" class="headerlink" title="0x00　引言"></a>0x00　引言</h2><p>　　python virtualenv为flask等web框架提供虚拟python环境（其他应用也可以），这样可以防止开发过程中安装的依赖影响原主机上的python环境，而且在迁移到上线环境中时，省去了配置上线环境中的python运行环境。</p>
<h2 id="0x01-安装virtualenv"><a href="#0x01-安装virtualenv" class="headerlink" title="0x01　安装virtualenv"></a>0x01　安装virtualenv</h2><p>　　这里我推荐使用pip或者easy_install安装，同样也可以通过下载<a href="https://pypi.python.org/pypi/virtualenv" target="_blank" rel="external">virtualenv.py</a>来构建虚拟环境。<br>　　使用pip命令 <code>pip install virtualenv</code></p>
<h2 id="0x02-建立环境"><a href="#0x02-建立环境" class="headerlink" title="0x02　建立环境"></a>0x02　建立环境</h2><p>　　首先进入网站的根目录（或者是任何需要建立虚拟环境的文件夹下）<br>　　使用dos命令 <code>virtualenv venv</code> 其中venv为python的虚拟环境，其中包括了python.exe、pip、easy_install等python环境。</p>
<h2 id="0x03-激活环境"><a href="#0x03-激活环境" class="headerlink" title="0x03　激活环境"></a>0x03　激活环境</h2><p>　　完成上一步后，接下来需要在dos界面激活虚拟环境，这样可以使得接下来下载的python模块都位于venv下的pip环境中<br><code>Scripts\activate   激活虚拟环境</code><br><code>deactivate  退出虚拟环境</code><br>　　激活后命令行开头多了（venv），如下<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">E:\code\python-workplace\flasker\venv&gt;Scripts\activate</span><br><span class="line">(venv) E:\code\python-workplace\flasker\venv&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="0x04-安装模块"><a href="#0x04-安装模块" class="headerlink" title="0x04　安装模块"></a>0x04　安装模块</h2><p>　　在上面的基础下，通过<code>pip install xxxx</code>安装的模块都是安装在venv环境下的，对主机上的环境没有影响。</p>
<h2 id="0x05-引入路径"><a href="#0x05-引入路径" class="headerlink" title="0x05　引入路径"></a>0x05　引入路径</h2><p>　　在具体使用过程中，需要把venv的路径导入sys.path，这样才可以使用虚拟环境中的python模块。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">importos,sys</span><br><span class="line">sys.path.append(os.getcwd()+<span class="string">'\\venv\\Lib\\site-packages'</span>)</span><br></pre></td></tr></table></figure></p>
<p>　　到这里就完成了python虚拟环境的搭建，总体对经常变动编程环境的城旭猿来说这是个非常有用功能。<br>　　<strong>==The End==</strong></p>

        
      </div>
    </div>

  

  
  
    
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2016/03/16/hello-world/" >
  Hello World
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2016/03/16/hello-world/"><span class="article-date">
  2016-03-16
</span>
</a>
        

        

      </div>
      <div class="article-entry">
        
          <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>

        
      </div>
    </div>

  






          <div class="main-footer">
  
    © 2016 0kami&#39;s Blog - Powered by <a href="http://hexo.io" target="_blank">Hexo</a> - Theme <a href="https://github.com/denjones/hexo-theme-chan" target="_blank">Chan</a>
  
</div>

      
        </div>
      
    </div>
  </div>
  <script src="http://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>

  <link rel="stylesheet" href="/PhotoSwipe/photoswipe.css">
  <link rel="stylesheet" href="/PhotoSwipe/default-skin/default-skin.css">

  <!-- Root element of PhotoSwipe. Must have class pswp. -->
  <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
             It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

      <!-- Container that holds slides.
                PhotoSwipe keeps only 3 of them in the DOM to save memory.
                Don't modify these 3 pswp__item elements, data is added later on. -->
      <div class="pswp__container">
        <div class="pswp__item"></div>
        <div class="pswp__item"></div>
        <div class="pswp__item"></div>
      </div>

      <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
      <div class="pswp__ui pswp__ui--hidden">

        <div class="pswp__top-bar">

          <!--  Controls are self-explanatory. Order can be changed. -->

          <div class="pswp__counter"></div>

          <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

          <button class="pswp__button pswp__button--share" title="Share"></button>

          <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

          <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

          <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
          <!-- element will get class pswp__preloader--active when preloader is running -->
          <div class="pswp__preloader">
            <div class="pswp__preloader__icn">
              <div class="pswp__preloader__cut">
                <div class="pswp__preloader__donut"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
          <div class="pswp__share-tooltip"></div>
        </div>

        <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>

        <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button>

        <div class="pswp__caption">
          <div class="pswp__caption__center"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="/PhotoSwipe/photoswipe.js"></script>
  <script src="/PhotoSwipe/photoswipe-ui-default.js"></script>


<script src="/scripts/main.js"></script>

</body>
</html>
