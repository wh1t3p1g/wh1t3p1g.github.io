<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  
  <title>Javaååºåˆ—åŒ–åˆ©ç”¨é“¾æŒ–æ˜ä¹‹CommonsCollections3 | 0kami&#39;s Blog</title>
  <meta name="description" content="A Web ğŸ¶ &amp;&amp; Code Reviewer">
  <meta name="keywords" content>
  <meta name="HandheldFriendly" content="True">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="shortcut icon" href="/images/avatar.jpg">
  <link rel="alternate" href="/atom.xml" title="0kami's Blog">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="0x00 å‰è¨€å‰é¢åˆ†æäº†ysoserialçš„CommonsCollections1ï¼Œç†Ÿæ‚‰äº†ä¸€ç‚¹Javaååºåˆ—åŒ–ã€‚æœ¬æ–‡å°†ç»§ç»­åˆ†æysoserialçš„åˆ©ç”¨ï¼Œä»Šå¤©çš„ä¸»è§’æ˜¯CommonsCollections3.">
<meta name="keywords" content="vul">
<meta property="og:type" content="article">
<meta property="og:title" content="Javaååºåˆ—åŒ–åˆ©ç”¨é“¾æŒ–æ˜ä¹‹CommonsCollections3">
<meta property="og:url" content="http://blog.0kami.cn/2019/10/28/java/study-java-deserialized-commonscollections3-3/index.html">
<meta property="og:site_name" content="0kami&#39;s Blog">
<meta property="og:description" content="0x00 å‰è¨€å‰é¢åˆ†æäº†ysoserialçš„CommonsCollections1ï¼Œç†Ÿæ‚‰äº†ä¸€ç‚¹Javaååºåˆ—åŒ–ã€‚æœ¬æ–‡å°†ç»§ç»­åˆ†æysoserialçš„åˆ©ç”¨ï¼Œä»Šå¤©çš„ä¸»è§’æ˜¯CommonsCollections3.">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://blog.0kami.cn/images/java-deserialized-commonscollections3-20191028/image-20191025190617899.png">
<meta property="og:image" content="http://blog.0kami.cn/images/java-deserialized-commonscollections3-20191028/image-20191025215544053.png">
<meta property="og:image" content="http://blog.0kami.cn/images/java-deserialized-commonscollections3-20191028/image-20191025215631300.png">
<meta property="og:image" content="http://blog.0kami.cn/images/java-deserialized-commonscollections3-20191028/image-20191025215358907.png">
<meta property="og:image" content="http://blog.0kami.cn/images/java-deserialized-commonscollections3-20191028/image-20191025215202858.png">
<meta property="og:image" content="http://blog.0kami.cn/images/java-deserialized-commonscollections3-20191028/image-20191025215052940.png">
<meta property="og:image" content="http://blog.0kami.cn/images/java-deserialized-commonscollections3-20191028/image-20191028155646352.png">
<meta property="og:image" content="http://blog.0kami.cn/images/study-java-deserialized-commonscollections3-3-20191028/image-20191104193635375.png">
<meta property="og:image" content="http://blog.0kami.cn/images/study-java-deserialized-commonscollections3-3-20191028/image-20191104194440916.png">
<meta property="og:updated_time" content="2021-04-19T12:46:25.748Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Javaååºåˆ—åŒ–åˆ©ç”¨é“¾æŒ–æ˜ä¹‹CommonsCollections3">
<meta name="twitter:description" content="0x00 å‰è¨€å‰é¢åˆ†æäº†ysoserialçš„CommonsCollections1ï¼Œç†Ÿæ‚‰äº†ä¸€ç‚¹Javaååºåˆ—åŒ–ã€‚æœ¬æ–‡å°†ç»§ç»­åˆ†æysoserialçš„åˆ©ç”¨ï¼Œä»Šå¤©çš„ä¸»è§’æ˜¯CommonsCollections3.">
<meta name="twitter:image" content="http://blog.0kami.cn/images/java-deserialized-commonscollections3-20191028/image-20191025190617899.png">

  <link href="https://fonts.googleapis.com/css?family=Inconsolata|Titillium+Web" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">
  <link href="//cdn.bootcss.com/node-waves/0.7.5/waves.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>
</head>
</html>
<body>
  <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>


  <script>setLoadingBarProgress(20)</script> 
  <header class="l_header">
	<div class='wrapper'>
		<div class="nav-main container container--flex">
			<a class="logo flat-box" href='/' >
				0kami's Blog
			</a>
			<div class='menu'>
				<ul class='h-list'>
					
						<li>
							<a class='flat-box nav-home' href='/'>
								Home
							</a>
						</li>
					
						<li>
							<a class='flat-box nav-archives' href='/archives'>
								Archives
							</a>
						</li>
					
						<li>
							<a class='flat-box nav-about' href='/about'>
								About
							</a>
						</li>
					
				</ul>
				<div class='underline'></div>
			</div>
			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="Search" />
						<span class="icon icon-search"></span>
					</form>
				</div>
			
			<ul class='switcher h-list'>
				
					<li class='s-search'><a href='javascript:void(0)'><span class="icon icon-search flat-box"></span></a></li>
				
				<li class='s-menu'><a href='javascript:void(0)'><span class="icon icon-menu flat-box"></span></a></li>
			</ul>
		</div>
		
		<div class='nav-sub container container--flex'>
			<a class="logo" class="flat-box" href='javascript:void(0)'>
				Word of Forks
			</a>

			<ul class='switcher h-list'>
				<li class='s-comment'><a href='javascript:void(0)'><span class="icon icon-chat_bubble_outline flat-box"></span></a></li>
				<li class='s-top'><a href='javascript:void(0)'><span class="icon icon-arrow_upward flat-box"></span></a></li>
				<li class='s-toc'><a href='javascript:void(0)'><span class="icon icon-format_list_numbered flat-box"></span></a></li>
			</ul>
		</div>
	</div>
</header>
<aside class="menu-phone">
	<nav>
		
			<a href="/" class="nav-home nav">
				Home
			</a>
		
			<a href="/archives" class="nav-archives nav">
				Archives
			</a>
		
			<a href="/about" class="nav-about nav">
				About
			</a>
		
	</nav>
</aside>

    <script>setLoadingBarProgress(40);</script>
  <div class="l_body">
    <div class='container clearfix'>
      <div class='l_main'>
        <article id="post-java/study-java-deserialized-commonscollections3-3"
  class="post white-box article-type-post"
  itemscope itemprop="blogPost">
	<section class='meta'>
	<h2 class="title">
  	<a href="/2019/10/28/java/study-java-deserialized-commonscollections3-3/">
    	Javaååºåˆ—åŒ–åˆ©ç”¨é“¾æŒ–æ˜ä¹‹CommonsCollections3
    </a>
  </h2>
	<time>
	  Oct 28, 2019
	</time>
	
    
    <div class='cats'>
        <a href="/categories/notes/">notes</a>
    </div>

	</section>
	
		<section class="toc-wrapper"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x00-å‰è¨€"><span class="toc-number">1.</span> <span class="toc-text">0x00 å‰è¨€</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-ç¯å¢ƒå‡†å¤‡"><span class="toc-number">2.</span> <span class="toc-text">0x01 ç¯å¢ƒå‡†å¤‡</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-åŸºç¡€çŸ¥è¯†"><span class="toc-number">3.</span> <span class="toc-text">0x02 åŸºç¡€çŸ¥è¯†</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-åˆ©ç”¨é“¾åˆ†æ"><span class="toc-number">4.</span> <span class="toc-text">0x03 åˆ©ç”¨é“¾åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-å‰æ™¯å›é¡¾"><span class="toc-number">4.1.</span> <span class="toc-text">1. å‰æ™¯å›é¡¾</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-æ–°çš„å‘½ä»¤æ‰§è¡Œåˆ©ç”¨é“¾"><span class="toc-number">4.2.</span> <span class="toc-text">2. æ–°çš„å‘½ä»¤æ‰§è¡Œåˆ©ç”¨é“¾</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-æ€»ç»“"><span class="toc-number">5.</span> <span class="toc-text">0x04 æ€»ç»“</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#20191104-è¡¥å……"><span class="toc-number">5.0.1.</span> <span class="toc-text">20191104 è¡¥å……</span></a></li></ol></li></ol></li></ol></section>
	
	<section class="article typo">
  	<div class="article-entry" itemprop="articleBody">
    	<h1 id="0x00-å‰è¨€"><a href="#0x00-å‰è¨€" class="headerlink" title="0x00 å‰è¨€"></a>0x00 å‰è¨€</h1><p>å‰é¢åˆ†æäº†ysoserialçš„CommonsCollections1ï¼Œç†Ÿæ‚‰äº†ä¸€ç‚¹Javaååºåˆ—åŒ–ã€‚æœ¬æ–‡å°†ç»§ç»­åˆ†æysoserialçš„åˆ©ç”¨ï¼Œä»Šå¤©çš„ä¸»è§’æ˜¯CommonsCollections3.</p>
<a id="more"></a>
<h1 id="0x01-ç¯å¢ƒå‡†å¤‡"><a href="#0x01-ç¯å¢ƒå‡†å¤‡" class="headerlink" title="0x01 ç¯å¢ƒå‡†å¤‡"></a>0x01 ç¯å¢ƒå‡†å¤‡</h1><p>é¦–å…ˆç”±äºoverrideçš„åŸå› ï¼Œç¯å¢ƒä½¿ç”¨çš„æ˜¯jdk7u80ã€‚åˆ©ç”¨ysoserialç”Ÿæˆpayloadï¼Œå¹¶è½½å…¥è°ƒè¯•ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar ysoserial-master-30099844c6-1.jar CommonsCollections3 <span class="string">"open /System/Applications/Calculator.app"</span> &gt; commonscollections3.ser</span><br></pre></td></tr></table></figure>
<h1 id="0x02-åŸºç¡€çŸ¥è¯†"><a href="#0x02-åŸºç¡€çŸ¥è¯†" class="headerlink" title="0x02 åŸºç¡€çŸ¥è¯†"></a>0x02 åŸºç¡€çŸ¥è¯†</h1><p>åœ¨åˆ†æå¼€å§‹å‰ï¼Œå…ˆè¡¥å……ä¸€ä¸‹åŸºç¡€çŸ¥è¯†</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StaticBlockTest</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Cracker</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] generate()&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String code = <span class="string">"&#123;java.lang.Runtime.getRuntime().exec(\"open /System/Applications/Calculator.app\");&#125;"</span>;</span><br><span class="line">            ClassPool pool = ClassPool.getDefault();</span><br><span class="line">            CtClass clazz = pool.get(StaticBlockTest<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">            clazz.setName(<span class="string">"demo"</span>);</span><br><span class="line">            clazz.makeClassInitializer().insertAfter(code);</span><br><span class="line">            <span class="keyword">return</span> clazz.toBytecode();</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] clazz = generate();</span><br><span class="line">        DefiningClassLoader loader = <span class="keyword">new</span> DefiningClassLoader();</span><br><span class="line">        Class cls = loader.defineClass(<span class="string">"demo"</span>,clazz);<span class="comment">// ä»å­—èŠ‚æ•°ç»„ä¸­æ¢å¤ç±»</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            cls.newInstance(); <span class="comment">// å®ä¾‹åŒ–è¯¥ç±»æ—¶ä¼šè‡ªåŠ¨è°ƒç”¨é™æ€å—å†…çš„ä»£ç </span></span><br><span class="line">        &#125; </span><br><span class="line">      	<span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡ä¸Šé¢è¿™ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—çš„çŸ¥è¯†ç‚¹ä¸»è¦ä¸ºä¸¤ç‚¹ï¼š</p>
<p>â€‹        a. defineClasså¯ä»¥ä»byteæ•°ç»„ä¸­æ¢å¤ä¸€ä¸ªClass</p>
<p>â€‹       b. static initializeråœ¨ç±»è½½å…¥æ—¶å°†è‡ªåŠ¨æ‰§è¡Œï¼ˆé™æ€å—å†…çš„ä»£ç ï¼‰</p>
<p>Javaä¸­åŠ¨æ€è°ƒç”¨çš„å¦ä¸€ç§æ–¹å¼æ˜¯<code>defineClass</code></p>
<p><img src="/images/java-deserialized-commonscollections3-20191028/image-20191025190617899.png" alt="image-20191025190617899"></p>
<p>Javaæä¾›äº†ClassLoaderä»bytesæ•°ç»„ä¸­è¿˜åŸClassçš„æ–¹æ³•ï¼ŒdefineClasså‡½æ•°å°±æ˜¯å®Œæˆè¿™ä¸€è¿‡ç¨‹çš„å‡½æ•°ã€‚</p>
<p>ç†è®ºä¸Šï¼Œå¦‚æœä»£ç ä¸­ä½¿ç”¨äº†è¿™ç§æ–¹å¼ï¼Œä¸”byteæ•°æ®çš„å†…å®¹å¯æ§ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œä»»æ„Javaä»£ç ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p>
<p>è¿™é‡Œå°±ç”¨åˆ°äº†Javaç±»çš„å¦ä¸€ä¸ªç‰¹æ€§ï¼Œstatic blockåœ¨ç±»è½½å…¥æ—¶è‡ªåŠ¨æ‰§è¡Œå—å†…çš„ä»£ç ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡javassistå¯¹é™æ€å—æ³¨å…¥ä»»æ„ä»£ç ï¼Œè¯¥ç±»è¢«æ¢å¤å¹¶è½½å…¥æ—¶ä¼šè°ƒç”¨æ³¨å…¥çš„ä»£ç ï¼Œåæ–‡çš„åˆ©ç”¨é“¾ä¸»è¦å°±æ˜¯ç”¨åˆ°äº†è¿™ä¸¤ä¸ªçŸ¥è¯†ç‚¹ã€‚</p>
<h1 id="0x03-åˆ©ç”¨é“¾åˆ†æ"><a href="#0x03-åˆ©ç”¨é“¾åˆ†æ" class="headerlink" title="0x03 åˆ©ç”¨é“¾åˆ†æ"></a>0x03 åˆ©ç”¨é“¾åˆ†æ</h1><h2 id="1-å‰æ™¯å›é¡¾"><a href="#1-å‰æ™¯å›é¡¾" class="headerlink" title="1. å‰æ™¯å›é¡¾"></a>1. å‰æ™¯å›é¡¾</h2><p>è¿™é‡Œé€‰æ‹©CommonsCollections3æ˜¯å› ä¸ºä»–çš„å‰åŠæ®µè§¦å‘çš„åˆ©ç”¨é“¾è·ŸCommonsCollections1æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥è¿™é‡Œåªéœ€è¦åˆ†æååŠæ®µå‘½ä»¤æ‰§è¡Œçš„æ„é€ å³å¯ã€‚å›é¡¾ä¸€ä¸‹å‰åŠæ®µåˆ©ç”¨é“¾</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sun.reflect.annotation.AnnotationInvocationHandler.readObject()</span><br><span class="line">	-&gt; memberValues.entrySet()</span><br><span class="line">	-&gt; AnnotationInvocationHandler.invoke()</span><br><span class="line">	-&gt; memberValues.get() =&gt; LazyMap.get()</span><br><span class="line">	-&gt; factory.transform() =&gt; ChainedTransformer.transform()</span><br><span class="line">	-&gt; iTransformers[].transform()</span><br></pre></td></tr></table></figure>
<p>CommonsCollections1ä¸­ChainedTransformer.transform()ä¼šå¾ªç¯è°ƒç”¨iTransformersæ•°ç»„é‡Œçš„å¯¹è±¡çš„transformå‡½æ•°ã€‚CommonsCollections1ç”¨çš„æ˜¯InvokerTransformerçš„transformï¼Œå› ä¸ºè¯¥å‡½æ•°å®ç°äº†åå°„è°ƒç”¨ä»»æ„ç±»çš„åŠŸèƒ½ã€‚é‚£ä¹ˆé™¤äº†ä½¿ç”¨InvokerTransformerè¿˜æœ‰æ²¡æœ‰å…¶ä»–çš„æ–¹æ³•ï¼Ÿç­”æ¡ˆå½“ç„¶æ˜¯è‚¯å®šçš„ï¼</p>
<h2 id="2-æ–°çš„å‘½ä»¤æ‰§è¡Œåˆ©ç”¨é“¾"><a href="#2-æ–°çš„å‘½ä»¤æ‰§è¡Œåˆ©ç”¨é“¾" class="headerlink" title="2. æ–°çš„å‘½ä»¤æ‰§è¡Œåˆ©ç”¨é“¾"></a>2. æ–°çš„å‘½ä»¤æ‰§è¡Œåˆ©ç”¨é“¾</h2><p>æ¥çœ‹ä¸€ä¸‹CommonsCollections3çš„payloadsæ„é€ </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Object templatesImpl = Gadgets.createTemplatesImpl(command);</span><br><span class="line"></span><br><span class="line"><span class="comment">// real chain for after setup</span></span><br><span class="line"><span class="keyword">final</span> Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">      <span class="keyword">new</span> ConstantTransformer(TrAXFilter<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line"><span class="class">      <span class="title">new</span> <span class="title">InstantiateTransformer</span>(</span></span><br><span class="line">            new Class[] &#123; Templates.class &#125;,</span><br><span class="line">            <span class="keyword">new</span> Object[] &#123; templatesImpl &#125; )&#125;;</span><br><span class="line"><span class="comment">// åç»­ç±»ä¼¼ çœç•¥</span></span><br></pre></td></tr></table></figure>
<p><code>ConstantTransformer</code>ä¸Šä¸€ç¯‡å·²ç»è¯´è¿‡äº†ï¼Œå…¶<code>transform</code>ä¼šè¿”å›æ„é€ æ—¶çš„å¯¹è±¡ï¼Œè¿™é‡Œå°±æ˜¯<code>TrAXFilter.class</code>å¯¹è±¡ã€‚</p>
<p>æˆ‘ä»¬é‡ç‚¹æ¥çœ‹<code>InstaniateTransformer</code>çš„<code>transform</code>å‡½æ•°</p>
<p><img src="/images/java-deserialized-commonscollections3-20191028/image-20191025215544053.png" alt="image-20191025215544053"></p>
<p>ç®€å•æ¥çœ‹ï¼Œè¯¥å‡½æ•°å¯¹è¾“å…¥çš„inputï¼ˆè¿™é‡Œå°±æ˜¯TrAXFilter.classï¼‰åšå®ä¾‹åŒ–çš„æ“ä½œã€‚è¿™é‡Œçœ‹èµ·æ¥ï¼Œå…¶å®æœ‰ç‚¹åƒphpä¸­æ‰¾å¯¹åº”çš„__constructsï¼Œåœ¨Javaé‡Œæˆ‘ä»¬å°±å»æ‰¾æ„é€ å‡½æ•°é‡Œåšäº†å±é™©æ“ä½œçš„classã€‚</p>
<p>æ¥çœ‹ä¸€ä¸‹<code>TrAXFilter</code>ç±»çš„æ„é€ å‡½æ•°</p>
<p><img src="/images/java-deserialized-commonscollections3-20191028/image-20191025215631300.png" alt="image-20191025215631300"></p>
<p>è¿™é‡Œçš„<code>templates</code>å°±æ˜¯ä¸Šé¢expä¸­æ„é€ çš„<code>templatesImpl</code>.</p>
<p>ç»§ç»­çœ‹TransformerImplçš„newTransformerå‡½æ•°</p>
<p><code>org.apache.xalan.internal.xsltc.trax.TemplatesImpl.java:newTransformer:481</code></p>
<p><img src="/images/java-deserialized-commonscollections3-20191028/image-20191025215358907.png" alt="image-20191025215358907"></p>
<p>ç»§ç»­çœ‹<code>getTransletInstance</code></p>
<p><img src="/images/java-deserialized-commonscollections3-20191028/image-20191025215202858.png" alt="image-20191025215202858"></p>
<p>å†ç»§ç»­<code>defineTransletClasses</code></p>
<p><img src="/images/java-deserialized-commonscollections3-20191028/image-20191025215052940.png" alt="image-20191025215052940"></p>
<p>çœ‹åˆ°è¿™é‡Œæ˜¯ä¸æ˜¯æœ‰ç‚¹ç†Ÿæ‚‰ï¼Œæ²¡é”™ï¼Œè¿™é‡Œç”¨åˆ°äº†0x02ä¸­çš„ä¸¤ä¸ªåŸºç¡€çŸ¥è¯†ã€‚<code>defineTransletClasses</code>è¿˜åŸå‡ºç±»ï¼Œ<code>getTransletInstance</code>è¿›è¡Œå®ä¾‹åŒ–ã€‚é‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦æ„é€ ä¸€ä¸ªåˆé€‚çš„<code>_bytecodes</code>å³å¯æ‰§è¡Œä»»æ„Javaä»£ç ã€‚</p>
<p>ä¸‹é¢è¡¥å……ä¸€ä¸‹ï¼Œåœ¨æ„é€ expæ—¶éœ€è¦æ»¡è¶³çš„æ¡ä»¶ï¼š</p>
<ol>
<li>æ¤å…¥çš„<code>templates</code>ä¸º<code>TransformerImpl</code>ç±»ï¼Œä»è€Œè°ƒç”¨åç»­çš„<code>newTransformer</code>å‡½æ•°</li>
<li>æ¤å…¥çš„<code>templates</code>å®ä¾‹ï¼Œ<code>_name</code>ä¸ä¸º<code>null</code>,<code>_class</code>ä¸º<code>null</code></li>
<li>æ¤å…¥çš„<code>templates</code>å®ä¾‹ï¼Œ<code>_bytecodes</code>ä¸ä¸º<code>null</code>,<code>_tfactory</code>ä¸º<code>TransformerFactoryImpl</code>å¯¹è±¡</li>
<li>æ¤å…¥çš„<code>templates._bytecodes</code>æ•°ç»„ï¼Œå…¶æœ€ç»ˆè¿˜åŸçš„å¯¹è±¡çˆ¶ç±»ä¸º<code>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</code></li>
</ol>
<p>é‚£ä¹ˆæ€ä¹ˆæ‰èƒ½æ»¡è¶³è¿™äº›æ¡ä»¶å‘¢ï¼Ÿè¿™é‡Œç¥å¥‡çš„javassiståˆè¦ä¸Šåœºå•¦ï¼</p>
<p>æ¥çœ‹ä¸€ä¸‹ysoserialçš„æ“ä½œ</p>
<p><img src="/images/java-deserialized-commonscollections3-20191028/image-20191028155646352.png" alt="image-20191028155646352"></p>
<p>ä¸Šé¢çš„ä»£ç ä¸åšçœç•¥ï¼Œæˆ‘ä»¬åº”è¯¥å¥½å¥½å­¦ä¹ ä¸€ä¸‹javassistçš„åŸºæœ¬æ“ä½œï¼Œä»£ç å¯ä»¥åœ¨<code>Gadgets.createTemplatesImpl</code>æ‰¾åˆ°ï¼</p>
<p>è¿™é‡Œæ¡†äº†ä¸¤ä¸ªæ¡†ï¼Œç¬¬ä¸€ä¸ªæ¡†æ˜¯é€šè¿‡javassistæ³¨å…¥é™æ€å—ï¼Œé™æ€å—çš„å†…å®¹å°±æ˜¯æˆ‘ä»¬éœ€è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚ç¬¬äºŒä¸ªæ¡†æ˜¯ysoserailæ¡†æ¶è‡ªå·±å°è£…çš„ä¸€ä¸ªåå°„å·¥å…·ç±»ï¼Œé€šè¿‡è¿™ä¸ªç±»æˆ‘ä»¬å¯ä»¥åŠ¨æ€çš„æ“ä½œ<code>templates</code>å®ä¾‹çš„ç±»å±æ€§å†…å®¹ã€‚è¿™é‡Œä¸»è¦å°±æ˜¯åœ¨æ»¡è¶³ä¸Šè¿°çš„å‡ ä¸ªæ¡ä»¶ã€‚</p>
<p>è¿™é‡Œæœ‰ä¸€ç‚¹å¯ä»¥æä¸€ä¸‹ï¼Œè¯¥åˆ©ç”¨é“¾çš„ä½œè€…åœ¨å¡«å……<code>_bytecodes</code>æ—¶ï¼Œé¢å¤–å¡«å……äº†ä¸€ä¸ªæ— å…³çš„ç±»(ä¸Šå›¾ç¬¬130è¡Œ)ã€‚è¿™ä¸ªç±»ä¸»è¦ç”¨äºæ»¡è¶³<code>_auxClasses</code>,è®©è¿™ä¸ª<code>getTransletInstance</code>å‡½æ•°èƒ½æ­£å¸¸èµ°å®Œã€‚</p>
<p>ç»è¿‡ä¸Šé¢çš„åˆ†æï¼Œå…¶å®æˆ‘ä»¬å¯ä»¥çŸ¥é“<code>getTransletInstance</code>çš„ç¬¬408è¡Œï¼Œå¯¹<code>_class</code>åšå®ä¾‹åŒ–æ—¶æˆ‘ä»¬æƒ³è¦æ‰§è¡Œçš„ä»£ç å°±å·²ç»æ‰§è¡Œäº†ã€‚æ‰€ä»¥è¿™é‡Œé¢å¤–å¡«å……çš„ç±»å…¶å®æ˜¯å¯æœ‰å¯æ— çš„ã€‚</p>
<h1 id="0x04-æ€»ç»“"><a href="#0x04-æ€»ç»“" class="headerlink" title="0x04 æ€»ç»“"></a>0x04 æ€»ç»“</h1><p>åˆ°è¿™é‡Œï¼Œæ•´ä¸€ä¸ªCommonsCollections3å°±åˆ†æç»“æŸäº†ã€‚</p>
<p>CommonsCollections3ä¸»è¦åˆ©ç”¨äº†å¯æ§çš„byteæ•°ç»„ä»defineClasså‡½æ•°ä¸­è¿˜åŸå‡ºæ¶æ„æ„é€ çš„Classã€‚å¹¶ä¸”åœ¨åç»­çš„è°ƒç”¨ä¸­ï¼Œè¿™ä¸ªClassè¢«æ³¨å…¥åˆ°å†…å­˜ä¸­ï¼Œä»è€Œæ‰§è¡Œäº†æ³¨å…¥çš„é™æ€å—çš„ä»£ç ï¼Œå®ç°äº†ä»»æ„Javaä»£ç æ‰§è¡Œã€‚</p>
<p>åˆ°è¿™ç¯‡ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“äº†ä¸¤ç§Javaçš„ä»»æ„ä»£ç æ‰§è¡Œçš„æ„é€ æ–¹å¼</p>
<ol>
<li>åˆ©ç”¨å¯æ§çš„åå°„æœºåˆ¶ã€‚å…·ä½“çš„Classã€Methodç­‰å‡å¯æ§æ—¶ï¼Œåˆ©ç”¨åå°„æœºåˆ¶ï¼Œå¯ä»¥æ„é€ å‡ºä»»æ„çš„ç±»è°ƒç”¨ã€ç±»å‡½æ•°è°ƒç”¨</li>
<li>åˆ©ç”¨å¯æ§çš„defineClasså‡½æ•°çš„byteæ•°ç»„ã€‚æ„é€ æ¶æ„çš„Classå­—èŠ‚ç æ•°ç»„ï¼Œå¸¸äºé™æ€å—æ³¨å…¥æ¶æ„ä»£ç </li>
</ol>
<h3 id="20191104-è¡¥å……"><a href="#20191104-è¡¥å……" class="headerlink" title="20191104 è¡¥å……"></a>20191104 è¡¥å……</h3><p>å‰é¢çš„åˆ†æå¹¶æ²¡æœ‰æåˆ°3.2.2ç‰ˆæœ¬å‘ç”Ÿäº†å•¥äº‹ï¼Œå¯¼è‡´äº†åˆ©ç”¨é“¾çš„å¤±æ•ˆï¼Œè¿™é‡Œç®€å•æä¸€ä¸‹</p>
<p><img src="/images/study-java-deserialized-commonscollections3-3-20191028/image-20191104193635375.png" alt="image-20191104193635375"></p>
<p>3.2.2ç‰ˆæœ¬å¯¹InvokerTransformerå¢åŠ äº†readObjectå‡½æ•°ï¼Œå¹¶ä¸”åšäº†æ˜¯å¦å…è®¸ååºåˆ—åŒ–çš„æ£€æŸ¥ï¼Œåœ¨<code>FunctorUtils.checkUnsafeSerialization</code>å‡½æ•°å†…ã€‚</p>
<p><img src="/images/study-java-deserialized-commonscollections3-3-20191028/image-20191104194440916.png" alt="image-20191104194440916"></p>
<p>è¿™é‡ŒUNSAFE_SERIALIZABLE_PROPERTYçš„å€¼é»˜è®¤ä¸ºfalseï¼Œå¦‚æœéœ€è¦ä¸ºtrueï¼Œéœ€è¦åœ¨è¿è¡Œæ—¶æŒ‡å®šã€‚</p>
<p>æ‰€ä»¥åœ¨ä½¿ç”¨InvokerTransformerä½œä¸ºååºåˆ—åŒ–åˆ©ç”¨é“¾çš„ä¸€éƒ¨åˆ†æ—¶ï¼Œä¼šthrowä¸€ä¸ªexceptionã€‚é™¤äº†InvokerTransformerç±»å¤–ï¼Œè¿˜æœ‰CloneTransformer, ForClosure, InstantiateFactory, InstantiateTransformer, InvokerTransformer,<br>PrototypeCloneFactory, PrototypeSerializationFactory, WhileClosureã€‚æ‰€ä»¥åœ¨3.2.2ç‰ˆæœ¬ä»¥ä¸Šï¼ŒåŸºæœ¬ä¸Šåˆ©ç”¨é“¾éƒ½å·²ç»åºŸäº†ã€‚</p>
<p>å½“ç„¶ï¼Œè¿™ç§æ–¹æ³•æ²»æ ‡ä¸æ²»æœ¬ï¼Œå¦‚æœå¯ä»¥åœ¨è¿™äº›ç±»ä»¥å¤–ï¼Œæ„é€ ä¸€ä¸ªåˆ©ç”¨é“¾åŒæ ·å¯ä»¥è¾¾åˆ°å‰é¢çš„æ•ˆæœã€‚</p>

  	</div>
	  
	  <div class="article-tags tags">
      
        <a href="/tags/vul/">vul</a>
      
	  </div>
    

	
		<div class="art-item-footer">
				
					<span class="art-item-left"><i class="icon icon-chevron-thin-left"></i>prevï¼š<a href="/2019/10/31/java/study-java-deserialized-commonscollections3-others/" rel="prev"  title="Javaååºåˆ—åŒ–åˆ©ç”¨é“¾æŒ–æ˜ä¹‹CommonsCollections5,6,7,9,10">
						Javaååºåˆ—åŒ–åˆ©ç”¨é“¾æŒ–æ˜ä¹‹CommonsCollections5,6,7,9,10
					</a></span>
				
				
					<span class="art-item-right">nextï¼š<a href="/2019/10/24/java/study-java-deserialized-commonscollections3-1/" rel="next"  title="Javaååºåˆ—åŒ–åˆ©ç”¨é“¾æŒ–æ˜ä¹‹CommonsCollections1">
						Javaååºåˆ—åŒ–åˆ©ç”¨é“¾æŒ–æ˜ä¹‹CommonsCollections1
					</a><i class="icon icon-chevron-thin-right"></i></span>
				
		</div>
	
	</section>
	
		<section id="comments">
			<div id="disqus_thread"></div>
		</section>
	
</article>
<script>
	window.subData = {
		title: 'Javaååºåˆ—åŒ–åˆ©ç”¨é“¾æŒ–æ˜ä¹‹CommonsCollections3',
		tools: true
	}
</script>

      </div>
      <aside class='l_side'>
        
  <section class='m_widget about'>

<div class='header'>wh1t3p1g</div>
<div class='content'>
<div class='desc'>A Web ğŸ¶ &amp;&amp; Code Reviewer</div>
</div>
</section>

  <section class='m_widget links'>
<div class='header'>Links</div>
<div class='content'>
    <ul class="entry">
    
        <li><a class="flat-box" target="_blank" href="http://blog.orleven.com">
            <div class='name'>orleven</div>
        </a></li>
    
        <li><a class="flat-box" target="_blank" href="http://www.warmeng.com">
            <div class='name'>warmeng</div>
        </a></li>
    
    </ul>
</div>
</section>

  <section class='m_widget categories'>
<div class='header'>Categories</div>
<div class='content'>
    
    <ul class="entry">
    
        <li><a class="flat-box" href="/categories/codereview/"><div class='name'>codereview</div><div class='badget'>10</div></a></li>
    
        <li><a class="flat-box" href="/categories/ctf/"><div class='name'>ctf</div><div class='badget'>6</div></a></li>
    
        <li><a class="flat-box" href="/categories/notes/"><div class='name'>notes</div><div class='badget'>24</div></a></li>
    
    </ul>
    
</div>
</section>

  
<div class="m_widget tagcloud">
    <div class="header">Tags</div>
    <div class='content'>
        <a href="/tags/bctf/" style="font-size: 14px; color: #808080">bctf</a> <a href="/tags/cms/" style="font-size: 18.5px; color: #202020">cms</a> <a href="/tags/ctf/" style="font-size: 14px; color: #808080">ctf</a> <a href="/tags/cve/" style="font-size: 17px; color: #404040">cve</a> <a href="/tags/ddctf/" style="font-size: 14px; color: #808080">ddctf</a> <a href="/tags/hitbxctf/" style="font-size: 14px; color: #808080">hitbxctf</a> <a href="/tags/mobile/" style="font-size: 14px; color: #808080">mobile</a> <a href="/tags/njctf/" style="font-size: 14px; color: #808080">njctf</a> <a href="/tags/others/" style="font-size: 15.5px; color: #606060">others</a> <a href="/tags/suctf/" style="font-size: 14px; color: #808080">suctf</a> <a href="/tags/vul/" style="font-size: 20px; color: #000">vul</a>
    </div>
</div>



      </aside>
      <script>setLoadingBarProgress(60);</script>
    </div>
  </div>
  <footer id="footer" class="clearfix">

	<div class="social-wrapper">
  	
      
        <a href="https://github.com/wh1t3p1g" class="social github"
          target="_blank" rel="external">
          <span class="icon icon-github"></span>
        </a>
      
        <a href="/atom.xml" class="social rss"
          target="_blank" rel="external">
          <span class="icon icon-rss"></span>
        </a>
      
    
  </div>
  
  <div>Theme <a href='https://github.com/stkevintan/hexo-theme-material-flow' class="codename">MaterialFlow</a> designed by <a href="http://keyin.me/" target="_blank">Kevin Tan</a>.</div>
  
</footer>


  <script>setLoadingBarProgress(80);</script>
  
<script>
  var disqus_shortname = '0kami';
  
  var disqus_url = 'http://blog.0kami.cn/2019/10/28/java/study-java-deserialized-commonscollections3-3/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src='//cdn.bootcss.com/node-waves/0.7.5/waves.min.js'></script>
<script src="//cdn.bootcss.com/scrollReveal.js/3.3.2/scrollreveal.min.js"></script>
<script src="/js/jquery.fitvids.js"></script>
<script>
	var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
	var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
	var ALGOLIA_API_KEY = "";
	var ALGOLIA_APP_ID = "";
	var ALGOLIA_INDEX_NAME = "";
  var AZURE_SERVICE_NAME = "";
  var AZURE_INDEX_NAME = "";
  var AZURE_QUERY_KEY = "";
  var BAIDU_API_ID = "";
  var SEARCH_SERVICE = "hexo";
  var ROOT = "/"||"/";
  if(!ROOT.endsWith('/'))ROOT += '/';
</script>
<script src="/js/search.js"></script>
<script src="/js/app.js"></script>


  <script>setLoadingBarProgress(100);</script>
</body>
</html>
